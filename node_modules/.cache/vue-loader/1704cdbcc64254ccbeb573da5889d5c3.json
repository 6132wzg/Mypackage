{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/card/renewal-member.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/card/renewal-member.vue","mtime":1594718340025},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { RenewalMemberService } from './renewal-member.service'\nimport moment from 'moment'\nimport { cloneDeep } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { ruleOptions } from './renewal-member.config'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nexport default {\n  name: 'ModalSoldRenewalMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  serviceProviders() {\n    return [RenewalMemberService]\n  },\n  serviceInject() {\n    return {\n      renewalMemberService: RenewalMemberService\n    }\n  },\n  components: {\n    EditableContractNumber\n  },\n  rxState() {\n    return {\n      loading: this.renewalMemberService.loading$,\n      couponList: this.renewalMemberService.couponList$,\n      advanceList: this.renewalMemberService.advanceList$,\n      priceInfo: this.renewalMemberService.priceInfo$,\n      saleList: this.renewalMemberService.saleList$,\n      info: this.renewalMemberService.info$\n    }\n  },\n  props: ['id'],\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      // 规格\n      selectSpecs: 1,\n      // 时间\n      startTime: null,\n      endTime: '',\n      // 赠送\n      giftAmount: null,\n      // 优惠\n      couponDropdownVisible: false,\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      selectCoupon: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      // 减免金额\n      reduceAmount: null,\n      // 描述\n      description: ''\n    }\n  },\n  created() {\n    this.renewalMemberService.serviceInit(this.id).subscribe(res => {\n      // 获取优惠券\n      this.renewalMemberService\n        .getCouponList({\n          member_id: res[0].info.member_id,\n          card_id: res[0].info.card_id,\n          specs_id: res[0].info.specs[0].id\n        })\n        .subscribe()\n      // 获取定金\n      this.renewalMemberService\n        .getAdvanceList(res[0].info.member_id)\n        .subscribe()\n      // 规格\n      this.selectSpecs = res[0].info.specs[0].id\n      this.form.setFieldsValue({\n        startTime: moment(res[0].info.default_start_time * 1000)\n      })\n      // 实付金额\n      this.getPrice('', 0, '', res[0].info.specs[0].id)\n      this.startTime = cloneDeep(moment(res[0].info.default_start_time * 1000))\n      this.endTime = moment(res[0].info.default_start_time * 1000)\n        .add(res[0].info.specs[0].valid_time, 'd')\n        .format('YYYY-MM-DD HH:mm')\n    })\n  },\n  watch: {\n    selectSpecs(newVal, oldVal) {\n      this.getPrice(\n        this.selectAdvance,\n        +this.reduceAmount,\n        this.selectCoupon,\n        newVal\n      )\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(\n          newVal,\n          +this.reduceAmount,\n          this.selectCoupon,\n          this.selectSpecs\n        )\n      }\n    },\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(\n          this.selectAdvance,\n          +this.reduceAmount,\n          newVal,\n          this.selectSpecs\n        )\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(\n        this.selectAdvance,\n        +newVal,\n        this.selectCoupon,\n        this.selectSpecs\n      )\n    }\n  },\n  computed: {\n    // 商品价格\n    cardPrice() {\n      if (this.info.specs) {\n        const arr = this.info.specs.filter(i => i.id === this.selectSpecs)\n        if (arr.length > 0) {\n          return arr[0].price\n        }\n        return '0'\n      }\n      return '0'\n    },\n    orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : ''\n    },\n    isFamilyCard() {\n      return this.info.card_number_type === 2\n    }\n  },\n  methods: {\n    moment,\n    // 规格\n    onSpecsChange(data) {\n      let item = this.info.specs.filter(i => i.id === data.target.value)[0]\n      let s = cloneDeep(this.startTime)\n      let dayScope = item.valid_time\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm')\n      // 获取优惠券\n      this.renewalMemberService\n        .getCouponList({\n          member_id: this.info.member_id,\n          card_id: this.info.card_id,\n          specs_id: item.id\n        })\n        .subscribe(res => {\n          this.resetCoupon()\n        })\n    },\n    // 时间\n    disabledStartDate(startTime) {\n      return startTime.valueOf() < this.info.default_start_time * 1000\n    },\n    onStartTimeChange(data) {\n      this.startTime = cloneDeep(data)\n      let s = cloneDeep(data)\n      let dayScope = this.info.specs.filter(i => i.id === this.selectSpecs)[0]\n        .valid_time\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm')\n    },\n    // 优惠\n    onSelectCouponChange(data) {\n      if (data.target.value === -1) {\n        this.couponAmount = ''\n        this.couponText = '未选择优惠券'\n        return\n      }\n      let price = this.couponList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.couponAmount = price\n      this.couponText = `${price}元`\n    },\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    resetCoupon() {\n      this.renewalMemberService.resetCouponList()\n      this.couponText = '未选择优惠券'\n      this.couponAmount = ''\n      this.selectcoupon = ''\n    },\n    // 定金\n    onSelectAdvanceChange(data) {\n      if (data.target.value === -1) {\n        this.advanceAmount = ''\n        this.advanceText = '未选择定金'\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    resetAdvance() {\n      this.renewalMemberService.resetAdvanceList()\n      this.advanceText = '未选择定金'\n      this.advanceAmount = ''\n      this.selectAdvance = ''\n    },\n    // 计算实付金额\n    getPrice(advance, reduce, coupon, specs_id) {\n      let advanceId = advance === -1 ? '' : advance\n      let couponId = coupon === -1 ? '' : coupon\n      this.renewalMemberService.priceAction$.dispatch({\n        id: this.id,\n        product_id: this.info.card_id,\n        product_type: this.info.contract_type,\n        specs_id,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        coupon_id: couponId,\n        member_id: this.info.member_id\n      })\n    },\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : undefined\n        this.renewalMemberService\n          .renewal(\n            {\n              contract_number: this.info.contract_number,\n              rule_id: this.selectSpecs,\n              valid_start_time: moment(values.startTime).format(\n                'YYYY-MM-DD HH:mm'\n              ),\n              gift_amount: +this.giftAmount,\n              user_coupon_id:\n                this.selectCoupon === -1 ? undefined : +this.selectCoupon,\n              advance_id:\n                this.selectAdvance === -1 ? undefined : this.selectAdvance,\n              reduce_price: reduce_amount,\n              description: this.description,\n              staff_sale_id: +values.saleName,\n              contract_type: this.info.contract_type,\n              discounts_price: +this.info.specs.filter(\n                i => i.id === this.selectSpecs\n              )[0].price\n            },\n            this.id\n          )\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'create',\n              orderId: res.info.order_id,\n              soldId: res.info.sold_id,\n              isFamilyCard: this.isFamilyCard\n            })\n          })\n      })\n    },\n    onPay() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : undefined\n        this.renewalMemberService\n          .renewalPay(\n            {\n              contract_number: this.info.contract_number,\n              rule_id: this.selectSpecs,\n              valid_start_time: moment(values.startTime).format(\n                'YYYY-MM-DD HH:mm'\n              ),\n              gift_amount: +this.giftAmount,\n              user_coupon_id:\n                this.selectCoupon === -1 ? undefined : +this.selectCoupon,\n              advance_id:\n                this.selectAdvance === -1 ? undefined : this.selectAdvance,\n              reduce_price: reduce_amount,\n              description: this.description,\n              staff_sale_id: +values.saleName,\n              contract_type: this.info.contract_type,\n              discounts_price: +this.info.specs.filter(\n                i => i.id === this.selectSpecs\n              )[0].price\n            },\n            this.id\n          )\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: res.info.order_id,\n              soldId: res.info.sold_id,\n              isFamilyCard: this.isFamilyCard\n            })\n          })\n      })\n    }\n  }\n}\n",null]}