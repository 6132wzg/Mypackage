{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/sold/transaction/store.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/sold/transaction/store.vue","mtime":1597396800005},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport tableMixin from '@/mixins/table.mixin'\nimport { columns, ruleOptions } from './store.config'\nimport StoreChooseSku from '@/views/biz-modals/store/choose-sku'\nimport StoreOrderTip from '@/views/biz-modals/store/order-tip'\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering'\nimport SoldDealAddMember from '@/views/biz-modals/sold/deal/add-member'\nimport { ListService } from './list.service'\nimport { PatternService } from '@/services/pattern.service'\nimport { PRODUCT_TYPE } from '@/constants/sold/transaction'\nimport { MessageService } from '@/services/message.service'\nimport defaultImg from '@/assets/img/placeholder_good.png'\nexport default {\n  name: 'shopSoldTransactionCloud',\n  mixins: [tableMixin],\n  bem: {\n    basic: 'shop-sold-transaction-cloud'\n  },\n  modals: {\n    StoreChooseSku,\n    StoreOrderTip,\n    SoldDealGathering,\n    SoldDealAddMember\n  },\n  serviceInject() {\n    return {\n      listService: ListService,\n      pattern: PatternService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.listService.loading$,\n      memberList: this.listService.memberList$,\n      saleList: this.listService.saleList$,\n      storeProductList: this.listService.storeProductList$,\n      currentPrice: this.listService.currentPrice$,\n      actualAmount: this.listService.actualAmount$,\n      couponList: this.listService.couponList$,\n      productPage: this.listService.productPage$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      PRODUCT_TYPE,\n      defaultImg,\n      memberSearchText: '', // 搜索会员value\n      couponText: '未选择优惠券', // 选择的优惠券名\n      couponDropdownVisible: false,\n      selectCoupon: '', // 优惠券选择的信息\n      reducePrice: null,\n      description: '',\n      buyCar: [],\n      productUrl: ''\n    }\n  },\n  watch: {\n    $searchQuery() {\n      this.productPage = {}\n      this.getList()\n    }\n  },\n  mounted() {\n    this.getList()\n    this.$searchQuery.product_type = PRODUCT_TYPE.STORE\n    this.listService.couponList$.commit(() => [])\n    this.getUseCouponList(0)\n    this.listService.getSaleList().subscribe()\n  },\n  methods: {\n    productImg(index) {\n      this.storeProductList[index].isError = true\n    },\n    // 获取商品列表\n    getList() {\n      this.listService.getStoreProductList(this.$searchQuery).subscribe()\n    },\n    // 新增购物车\n    onSku(record) {\n      this.listService.getGoodsDetail(record).subscribe(res => {\n        if (res.all_spec) {\n          // 多规格新增至购物车\n          this.$modalRouter.push({\n            name: 'store-choose-sku',\n            props: {\n              productData: res\n            },\n            on: {\n              success: result => {\n                let state = this.buyCarJudge(result.sku_id, result.stock_amount)\n                if (state === 'error') {\n                  return\n                }\n                result.product_id = record\n                if (!state) {\n                  this.buyCar.push(result)\n                }\n                this.onSelectProductChange()\n              }\n            }\n          })\n        } else {\n          // 单规格新增至购物车\n          let state = this.buyCarJudge(\n            res.product_sku[0].sku_id,\n            res.product_sku[0].stock_amount\n          )\n          if (state === 'error') {\n            return\n          }\n          if (!state) {\n            this.buyCar.push({\n              sku_id: res.product_sku[0].sku_id,\n              product_id: record,\n              nums: 1,\n              rule_name: '',\n              product_name: res.product_name,\n              unit_price: res.product_sku[0].selling_price,\n              stock_amount: res.product_sku[0].stock_amount\n            })\n          }\n          this.onSelectProductChange()\n        }\n      })\n    },\n    // 购物车新增商品库存验证\n    buyCarJudge(id, number) {\n      if (!number) {\n        this.messageService.warn({ content: '商品库存不足' })\n        return 'error'\n      }\n      for (let i = 0; i < this.buyCar.length; i++) {\n        let val = this.buyCar[i]\n        if (val.sku_id === id) {\n          if (val.nums >= number) {\n            this.messageService.warn({ content: '商品库存不足' })\n            return 'error'\n          } else {\n            val.nums = val.nums + 1\n            return 'noAdd'\n          }\n        }\n      }\n      if (this.buyCar.length >= 20) {\n        this.messageService.warn({ content: '购物车已满' })\n        return 'error'\n      }\n    },\n    // 删除购物车商品\n    onDelBuyCar(i) {\n      this.buyCar.splice(i, 1)\n      if (!this.buyCar.length) {\n        this.resetCoupon()\n      }\n      this.onSelectProductChange()\n    },\n    // 生成订单号\n    createOrderNum(type) {\n      return new Promise((resolve, reject) => {\n        this.form.validate().then(values => {\n          let params = {\n            member_id: values.memberId,\n            coupon_id: this.selectCoupon.id,\n            sale_id: values.saleName,\n            reduce_price: this.reducePrice || 0,\n            description: this.description,\n            sale_range: 1,\n            shipping_mode: 1,\n            order_amount: this.currentPrice,\n            sku_info: this.buyCar\n          }\n          if (type === 'order') {\n            this.listService.createOrder(params).subscribe(result => {\n              this.clearData()\n              resolve(result.info.order_id.order_id)\n            })\n          } else {\n            this.listService.createOrderPay(params).subscribe(result => {\n              this.clearData()\n              resolve(result.info.order_id.order_id)\n            })\n          }\n        })\n      })\n    },\n    clearData() {\n      this.buyCar = []\n      this.selectCoupon = ''\n      this.reducePrice = ''\n      this.description = ''\n      this.listService.couponList$.commit(() => [])\n      this.listService.currentPrice$.commit(() => 0)\n      this.couponText = '未选择优惠券'\n      this.form.setFieldsValue({\n        memberId: '',\n        saleName: ''\n      })\n    },\n    // 创建订单\n    async onCreateOrder() {\n      let orderId = await this.createOrderNum('order')\n      this.payCallBack(\n        {\n          type: 'create',\n          message: '订单创建成功'\n        },\n        orderId\n      )\n    },\n    // 立即支付\n    async onPayOrder(orderId) {\n      if (!orderId) {\n        orderId = await this.createOrderNum('orderPay')\n      }\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering',\n        props: {\n          order_id: orderId,\n          type: 'cloud_store'\n        },\n        on: {\n          success: res => {\n            this.payCallBack(\n              {\n                type: 'pay',\n                message: '收款成功'\n              },\n              orderId\n            )\n          }\n        }\n      })\n    },\n    // 收款完提示\n    payCallBack(props, orderId) {\n      this.$modalRouter.push({\n        name: 'store-order-tip',\n        props,\n        on: {\n          success: res => {\n            switch (res.type) {\n              case 'PrintOrder':\n                this.printOrder(orderId)\n                break\n              case 'ViewOrder':\n                this.createdOrderViewOrder(orderId)\n                break\n              case 'Pay':\n                this.onPayOrder(orderId)\n                break\n            }\n          }\n        }\n      })\n    },\n    // 小票打印\n    printOrder(order_id) {\n      window.open(\n        '/ticket/gathering-print?id=' + order_id,\n        '_blank',\n        'width=800,height=600'\n      )\n    },\n    // 查看订单\n    createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      })\n    },\n    // 新增会员\n    addMember() {\n      this.$modalRouter.push({\n        name: 'sold-deal-add-member',\n        on: {\n          success: res => {\n            this.onMemberSearch(res.name, res.id)\n          }\n        }\n      })\n    },\n    // 清空优惠券\n    resetCoupon() {\n      this.selectCoupon = ''\n      this.listService.couponList$.commit(() => [])\n      this.couponText = '未选择优惠券'\n    },\n    // 购买商品的变化\n    onSelectProductChange() {\n      this.getPrice()\n      this.getUseCouponList()\n    },\n    // 会员搜索\n    onMemberSearch(data, memberId) {\n      this.memberSearchText = data\n      if (!data) {\n        this.listService.memberList$.commit(() => [])\n        this.form.resetFields(['memberId'])\n      } else {\n        this.listService.getMember(data, 1).subscribe(res => {\n          if (!res.list.length) {\n            this.form.resetFields(['memberId'])\n          }\n          if (memberId) {\n            this.form.setFieldsValue({\n              memberId\n            })\n          }\n        })\n      }\n    },\n    onMemberBlur() {\n      let memberId = this.form.getFieldValue('memberId')\n      if (!memberId) {\n        this.resetCoupon()\n        this.getPrice()\n      }\n    },\n    // 会员Id变化 获取价格和优惠券列表\n    onMemberChange(data) {\n      console.log('onMemberChange', data)\n      this.resetCoupon()\n      this.getPrice(data)\n      if (data) this.getUseCouponList(data)\n    },\n    // 优惠券处理\n    onSelectCouponChange(event) {\n      let price = this.couponList.filter(o => o.id === event.target.value.id)[0]\n        .price\n      this.couponText = `${price}元`\n      this.getPrice(0)\n    },\n    // 优惠券处理\n    onSelectCoupon() {\n      this.couponDropdownVisible = false\n    },\n    // 价格计算\n    getPrice(selectMemberId = '') {\n      let productInfo = []\n      const memberId = selectMemberId || this.form.getFieldValue('memberId')\n      this.buyCar.forEach(val => {\n        productInfo.push({\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        })\n      })\n      this.listService\n        .getStorePrice({\n          product_type: 8,\n          reduce_amount: this.reducePrice || undefined,\n          coupon_id: this.selectCoupon.id || undefined,\n          member_id: memberId || undefined,\n          product_info: productInfo.length ? productInfo : undefined\n        })\n        .subscribe()\n    },\n    // 获取可用优惠券\n    getUseCouponList(cardId) {\n      let productInfo = []\n      const memberId = cardId ? cardId : this.form.getFieldValue('memberId')\n      this.buyCar.forEach(val => {\n        productInfo.push({\n          product_id: val.product_id,\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        })\n      })\n      this.listService\n        .getUseCoupon({\n          product_info: JSON.stringify(productInfo),\n          member_id: memberId\n        })\n        .subscribe()\n    },\n    // 分页切换\n    onChange(pagination) {\n      this.$searchQuery.current_page = pagination.current\n      this.$searchQuery.size = pagination.pageSize\n      this.getList()\n    }\n  },\n  computed: {\n    columns\n  }\n}\n",{"version":3,"sources":["store.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"store.vue","sourceRoot":"src/views/pages/shop/sold/transaction","sourcesContent":["<template>\n  <st-panel :class=\"basic()\" :loading=\"loading.getStoreProductList\">\n    <st-mina-panel app>\n      <div slot=\"actions\" :class=\"basic('footer')\">\n        <div :class=\"basic('footer-page')\">\n          <st-pagination :page=\"productPage\" @change=\"onChange\" class=\"mg-t8\" />\n        </div>\n        <div :class=\"basic('footer-action')\">\n          <div class=\"price\">\n            <span>共{{ buyCar.length }}件商品 合计：</span>\n            <span class=\"money font-number\">&yen; {{ currentPrice }}</span>\n          </div>\n          <div class=\"button\">\n            <st-button @click=\"onCreateOrder\" :loading=\"loading.createOrder\">\n              创建订单\n            </st-button>\n            <st-button\n              type=\"primary\"\n              class=\"mg-l16\"\n              @click=\"onPayOrder(null)\"\n              :loading=\"loading.createOrderPay\"\n            >\n              立即支付\n            </st-button>\n          </div>\n        </div>\n      </div>\n      <div :class=\"basic('list')\">\n        <div :class=\"basic('head')\">\n          <p :class=\"basic('title')\">查看商品</p>\n          <st-input-search\n            style=\"width: 291px\"\n            v-model=\"$searchQuery.product_name\"\n            @search=\"onKeywordsSearch('product_name', $event)\"\n            placeholder=\"请输入商品名查找\"\n            :class=\"basic('search')\"\n          />\n        </div>\n        <ul :class=\"basic('product')\" v-if=\"storeProductList.length\">\n          <li v-for=\"(item, index) in storeProductList\" :key=\"index\">\n            <img\n              :class=\"basic('product-img')\"\n              v-if=\"item.isError\"\n              :src=\"defaultImg\"\n              alt=\"\"\n            />\n            <img\n              v-else\n              :class=\"basic('product-img')\"\n              :src=\"item.img | imgFilter({ w: 194, h: 172 })\"\n              @error=\"productImg(index)\"\n              alt=\"\"\n            />\n            <div :class=\"basic('product-name')\">\n              <span>{{ item.product_name }}</span>\n            </div>\n            <div :class=\"basic('product-price')\">\n              <span class=\"font-number\">\n                {{ item.price }}\n              </span>\n              <span>库存:{{ item.count }}件</span>\n            </div>\n            <div class=\"product-mask\" @click=\"onSku(item.id)\">\n              <img src=\"@/assets/img/icon-buy-car.png\" alt=\"\" />\n              <p>新增至购物车</p>\n            </div>\n          </li>\n        </ul>\n        <st-no-data v-else></st-no-data>\n      </div>\n      <div :class=\"basic('buycar')\">\n        <p class=\"title\">购物车</p>\n        <div>\n          <st-form :form=\"form\" labelWidth=\"66px\">\n            <st-form-item :class=\"basic('padding')\">\n              <st-table\n                :class=\"basic('table')\"\n                rowKey=\"sku_id\"\n                :pagination=\"false\"\n                :columns=\"columns\"\n                :scroll=\"{ y: 320 }\"\n                :dataSource=\"buyCar\"\n              >\n                <template slot=\"product_name\" slot-scope=\"customRender, record\">\n                  <div>\n                    {{ record.product_name }}\n                    <span v-if=\"record.rule_name\">\n                      ({{ record.rule_name }})\n                    </span>\n                  </div>\n                </template>\n                <template slot=\"stock_amount\" slot-scope=\"customRender, record\">\n                  <a-input-number\n                    :min=\"1\"\n                    :max=\"record.stock_amount\"\n                    @change=\"onSelectProductChange\"\n                    v-model=\"record.nums\"\n                  />\n                </template>\n                <template slot=\"priceSum\" slot-scope=\"customRender, record\">\n                  {{ (record.nums * record.unit_price).toFixed(1) }}\n                </template>\n                <template\n                  slot=\"action\"\n                  slot-scope=\"customRender, record, index\"\n                >\n                  <st-table-actions sytle=\"width: 120px\">\n                    <a @click=\"onDelBuyCar(index)\">\n                      删除\n                    </a>\n                  </st-table-actions>\n                </template>\n              </st-table>\n              <div\n                :class=\"basic('all-price')\"\n                class=\"font-number\"\n                v-if=\"buyCar.length\"\n              >\n                总额：&yen; {{ actualAmount }}\n              </div>\n            </st-form-item>\n            <st-form-item :class=\"basic('padding')\">\n              <div class=\"divider-line\"></div>\n            </st-form-item>\n            <st-form-item label=\"购买会员\" required>\n              <a-select\n                showSearch\n                allowClear\n                placeholder=\"输入手机号或会员名搜索\"\n                :defaultActiveFirstOption=\"false\"\n                :showArrow=\"false\"\n                :filterOption=\"false\"\n                v-decorator=\"decorators.memberId\"\n                @search=\"onMemberSearch\"\n                @change=\"onMemberChange\"\n                @blur=\"onMemberBlur\"\n              >\n                <template\n                  slot=\"notFoundContent\"\n                  v-if=\"!memberList.length && memberSearchText !== ''\"\n                >\n                  <div>\n                    暂无此会员，\n                    <span :class=\"basic('add-member')\" @click=\"addMember\">\n                      新增新会员？\n                    </span>\n                  </div>\n                </template>\n                <a-select-option\n                  v-for=\"(item, index) in memberList\"\n                  :value=\"item.id\"\n                  :key=\"index\"\n                >\n                  <span\n                    v-html=\"\n                      `${item.member_name} ${item.mobile}`.replace(\n                        new RegExp(memberSearchText, 'g'),\n                        `\\<span class='global-highlight-color'\\>${memberSearchText}\\<\\/span\\>`\n                      )\n                    \"\n                  >\n                    {{ item.member_name }} {{ item.mobile }}\n                  </span>\n                </a-select-option>\n              </a-select>\n            </st-form-item>\n            <st-form-item :class=\"basic('discounts')\" label=\"优惠券\">\n              <div>\n                <div :class=\"basic('discounts-total')\">\n                  <span>{{ couponText }}</span>\n                  <a-dropdown\n                    v-model=\"couponDropdownVisible\"\n                    :disabled=\"couponList.length === 0\"\n                    :class=\"basic({ disabled: couponList.length === 0 })\"\n                    placement=\"bottomRight\"\n                    :getPopupContainer=\"trigger => trigger.parentNode\"\n                    :trigger=\"['click']\"\n                  >\n                    <div :class=\"basic('discounts-promotion')\">\n                      <span>{{ couponList.length }}张可用优惠券</span>\n                      <a-icon type=\"right\" />\n                    </div>\n                    <a-radio-group\n                      v-model=\"selectCoupon\"\n                      @change=\"onSelectCouponChange\"\n                      :class=\"basic('dropdown')\"\n                      slot=\"overlay\"\n                    >\n                      <a-menu>\n                        <a-menu-item\n                          @click=\"onSelectCoupon\"\n                          :key=\"index\"\n                          v-for=\"(item, index) in couponList\"\n                        >\n                          <a-radio :value=\"item\">\n                            {{ item.name }}{{ item.price }}\n                          </a-radio>\n                        </a-menu-item>\n                      </a-menu>\n                    </a-radio-group>\n                  </a-dropdown>\n                </div>\n              </div>\n            </st-form-item>\n            <st-form-item label=\"减免\">\n              <st-input-number\n                :float=\"true\"\n                @input=\"getPrice(0)\"\n                v-model=\"reducePrice\"\n                maxlength=\"12\"\n                placeholder=\"请输入减免金额\"\n              >\n                <span slot=\"addonAfter\">元</span>\n              </st-input-number>\n            </st-form-item>\n            <st-form-item label=\"销售\">\n              <a-select\n                v-decorator=\"decorators.saleName\"\n                placeholder=\"请选择销售名字\"\n              >\n                <a-select-option\n                  v-for=\"(item, index) in saleList\"\n                  :key=\"index\"\n                  :value=\"item.id\"\n                >\n                  {{ item.staff_name }}\n                </a-select-option>\n              </a-select>\n            </st-form-item>\n            <st-form-item label=\"备注\">\n              <a-textarea\n                v-model=\"description\"\n                maxlength=\"200\"\n                placeholder=\"请填写备注\"\n                class=\"st-textarea\"\n              ></a-textarea>\n            </st-form-item>\n          </st-form>\n        </div>\n      </div>\n    </st-mina-panel>\n  </st-panel>\n</template>\n\n<script>\nimport tableMixin from '@/mixins/table.mixin'\nimport { columns, ruleOptions } from './store.config'\nimport StoreChooseSku from '@/views/biz-modals/store/choose-sku'\nimport StoreOrderTip from '@/views/biz-modals/store/order-tip'\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering'\nimport SoldDealAddMember from '@/views/biz-modals/sold/deal/add-member'\nimport { ListService } from './list.service'\nimport { PatternService } from '@/services/pattern.service'\nimport { PRODUCT_TYPE } from '@/constants/sold/transaction'\nimport { MessageService } from '@/services/message.service'\nimport defaultImg from '@/assets/img/placeholder_good.png'\nexport default {\n  name: 'shopSoldTransactionCloud',\n  mixins: [tableMixin],\n  bem: {\n    basic: 'shop-sold-transaction-cloud'\n  },\n  modals: {\n    StoreChooseSku,\n    StoreOrderTip,\n    SoldDealGathering,\n    SoldDealAddMember\n  },\n  serviceInject() {\n    return {\n      listService: ListService,\n      pattern: PatternService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.listService.loading$,\n      memberList: this.listService.memberList$,\n      saleList: this.listService.saleList$,\n      storeProductList: this.listService.storeProductList$,\n      currentPrice: this.listService.currentPrice$,\n      actualAmount: this.listService.actualAmount$,\n      couponList: this.listService.couponList$,\n      productPage: this.listService.productPage$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      PRODUCT_TYPE,\n      defaultImg,\n      memberSearchText: '', // 搜索会员value\n      couponText: '未选择优惠券', // 选择的优惠券名\n      couponDropdownVisible: false,\n      selectCoupon: '', // 优惠券选择的信息\n      reducePrice: null,\n      description: '',\n      buyCar: [],\n      productUrl: ''\n    }\n  },\n  watch: {\n    $searchQuery() {\n      this.productPage = {}\n      this.getList()\n    }\n  },\n  mounted() {\n    this.getList()\n    this.$searchQuery.product_type = PRODUCT_TYPE.STORE\n    this.listService.couponList$.commit(() => [])\n    this.getUseCouponList(0)\n    this.listService.getSaleList().subscribe()\n  },\n  methods: {\n    productImg(index) {\n      this.storeProductList[index].isError = true\n    },\n    // 获取商品列表\n    getList() {\n      this.listService.getStoreProductList(this.$searchQuery).subscribe()\n    },\n    // 新增购物车\n    onSku(record) {\n      this.listService.getGoodsDetail(record).subscribe(res => {\n        if (res.all_spec) {\n          // 多规格新增至购物车\n          this.$modalRouter.push({\n            name: 'store-choose-sku',\n            props: {\n              productData: res\n            },\n            on: {\n              success: result => {\n                let state = this.buyCarJudge(result.sku_id, result.stock_amount)\n                if (state === 'error') {\n                  return\n                }\n                result.product_id = record\n                if (!state) {\n                  this.buyCar.push(result)\n                }\n                this.onSelectProductChange()\n              }\n            }\n          })\n        } else {\n          // 单规格新增至购物车\n          let state = this.buyCarJudge(\n            res.product_sku[0].sku_id,\n            res.product_sku[0].stock_amount\n          )\n          if (state === 'error') {\n            return\n          }\n          if (!state) {\n            this.buyCar.push({\n              sku_id: res.product_sku[0].sku_id,\n              product_id: record,\n              nums: 1,\n              rule_name: '',\n              product_name: res.product_name,\n              unit_price: res.product_sku[0].selling_price,\n              stock_amount: res.product_sku[0].stock_amount\n            })\n          }\n          this.onSelectProductChange()\n        }\n      })\n    },\n    // 购物车新增商品库存验证\n    buyCarJudge(id, number) {\n      if (!number) {\n        this.messageService.warn({ content: '商品库存不足' })\n        return 'error'\n      }\n      for (let i = 0; i < this.buyCar.length; i++) {\n        let val = this.buyCar[i]\n        if (val.sku_id === id) {\n          if (val.nums >= number) {\n            this.messageService.warn({ content: '商品库存不足' })\n            return 'error'\n          } else {\n            val.nums = val.nums + 1\n            return 'noAdd'\n          }\n        }\n      }\n      if (this.buyCar.length >= 20) {\n        this.messageService.warn({ content: '购物车已满' })\n        return 'error'\n      }\n    },\n    // 删除购物车商品\n    onDelBuyCar(i) {\n      this.buyCar.splice(i, 1)\n      if (!this.buyCar.length) {\n        this.resetCoupon()\n      }\n      this.onSelectProductChange()\n    },\n    // 生成订单号\n    createOrderNum(type) {\n      return new Promise((resolve, reject) => {\n        this.form.validate().then(values => {\n          let params = {\n            member_id: values.memberId,\n            coupon_id: this.selectCoupon.id,\n            sale_id: values.saleName,\n            reduce_price: this.reducePrice || 0,\n            description: this.description,\n            sale_range: 1,\n            shipping_mode: 1,\n            order_amount: this.currentPrice,\n            sku_info: this.buyCar\n          }\n          if (type === 'order') {\n            this.listService.createOrder(params).subscribe(result => {\n              this.clearData()\n              resolve(result.info.order_id.order_id)\n            })\n          } else {\n            this.listService.createOrderPay(params).subscribe(result => {\n              this.clearData()\n              resolve(result.info.order_id.order_id)\n            })\n          }\n        })\n      })\n    },\n    clearData() {\n      this.buyCar = []\n      this.selectCoupon = ''\n      this.reducePrice = ''\n      this.description = ''\n      this.listService.couponList$.commit(() => [])\n      this.listService.currentPrice$.commit(() => 0)\n      this.couponText = '未选择优惠券'\n      this.form.setFieldsValue({\n        memberId: '',\n        saleName: ''\n      })\n    },\n    // 创建订单\n    async onCreateOrder() {\n      let orderId = await this.createOrderNum('order')\n      this.payCallBack(\n        {\n          type: 'create',\n          message: '订单创建成功'\n        },\n        orderId\n      )\n    },\n    // 立即支付\n    async onPayOrder(orderId) {\n      if (!orderId) {\n        orderId = await this.createOrderNum('orderPay')\n      }\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering',\n        props: {\n          order_id: orderId,\n          type: 'cloud_store'\n        },\n        on: {\n          success: res => {\n            this.payCallBack(\n              {\n                type: 'pay',\n                message: '收款成功'\n              },\n              orderId\n            )\n          }\n        }\n      })\n    },\n    // 收款完提示\n    payCallBack(props, orderId) {\n      this.$modalRouter.push({\n        name: 'store-order-tip',\n        props,\n        on: {\n          success: res => {\n            switch (res.type) {\n              case 'PrintOrder':\n                this.printOrder(orderId)\n                break\n              case 'ViewOrder':\n                this.createdOrderViewOrder(orderId)\n                break\n              case 'Pay':\n                this.onPayOrder(orderId)\n                break\n            }\n          }\n        }\n      })\n    },\n    // 小票打印\n    printOrder(order_id) {\n      window.open(\n        '/ticket/gathering-print?id=' + order_id,\n        '_blank',\n        'width=800,height=600'\n      )\n    },\n    // 查看订单\n    createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      })\n    },\n    // 新增会员\n    addMember() {\n      this.$modalRouter.push({\n        name: 'sold-deal-add-member',\n        on: {\n          success: res => {\n            this.onMemberSearch(res.name, res.id)\n          }\n        }\n      })\n    },\n    // 清空优惠券\n    resetCoupon() {\n      this.selectCoupon = ''\n      this.listService.couponList$.commit(() => [])\n      this.couponText = '未选择优惠券'\n    },\n    // 购买商品的变化\n    onSelectProductChange() {\n      this.getPrice()\n      this.getUseCouponList()\n    },\n    // 会员搜索\n    onMemberSearch(data, memberId) {\n      this.memberSearchText = data\n      if (!data) {\n        this.listService.memberList$.commit(() => [])\n        this.form.resetFields(['memberId'])\n      } else {\n        this.listService.getMember(data, 1).subscribe(res => {\n          if (!res.list.length) {\n            this.form.resetFields(['memberId'])\n          }\n          if (memberId) {\n            this.form.setFieldsValue({\n              memberId\n            })\n          }\n        })\n      }\n    },\n    onMemberBlur() {\n      let memberId = this.form.getFieldValue('memberId')\n      if (!memberId) {\n        this.resetCoupon()\n        this.getPrice()\n      }\n    },\n    // 会员Id变化 获取价格和优惠券列表\n    onMemberChange(data) {\n      console.log('onMemberChange', data)\n      this.resetCoupon()\n      this.getPrice(data)\n      if (data) this.getUseCouponList(data)\n    },\n    // 优惠券处理\n    onSelectCouponChange(event) {\n      let price = this.couponList.filter(o => o.id === event.target.value.id)[0]\n        .price\n      this.couponText = `${price}元`\n      this.getPrice(0)\n    },\n    // 优惠券处理\n    onSelectCoupon() {\n      this.couponDropdownVisible = false\n    },\n    // 价格计算\n    getPrice(selectMemberId = '') {\n      let productInfo = []\n      const memberId = selectMemberId || this.form.getFieldValue('memberId')\n      this.buyCar.forEach(val => {\n        productInfo.push({\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        })\n      })\n      this.listService\n        .getStorePrice({\n          product_type: 8,\n          reduce_amount: this.reducePrice || undefined,\n          coupon_id: this.selectCoupon.id || undefined,\n          member_id: memberId || undefined,\n          product_info: productInfo.length ? productInfo : undefined\n        })\n        .subscribe()\n    },\n    // 获取可用优惠券\n    getUseCouponList(cardId) {\n      let productInfo = []\n      const memberId = cardId ? cardId : this.form.getFieldValue('memberId')\n      this.buyCar.forEach(val => {\n        productInfo.push({\n          product_id: val.product_id,\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        })\n      })\n      this.listService\n        .getUseCoupon({\n          product_info: JSON.stringify(productInfo),\n          member_id: memberId\n        })\n        .subscribe()\n    },\n    // 分页切换\n    onChange(pagination) {\n      this.$searchQuery.current_page = pagination.current\n      this.$searchQuery.size = pagination.pageSize\n      this.getList()\n    }\n  },\n  computed: {\n    columns\n  }\n}\n</script>\n"]}]}