{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/personal-team/reserve-info.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/personal-team/reserve-info.vue","mtime":1597396799937},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { switchMap } from 'rxjs/operators'\nimport { MessageService } from '@/services/message.service'\nimport { PersonalTeamScheduleCommonService as CommonService } from '@/views/pages/shop/product/course/schedule/personal-team/service#/common.service'\nimport { PersonalTeamScheduleReserveService as ReserveService } from '@/views/pages/shop/product/course/schedule/personal-team/service#/reserve.service'\nimport { PersonalTeamScheduleScheduleService as ScheduleService } from '@/views/pages/shop/product/course/schedule/personal-team/service#/schedule.service'\nimport SchedulePersonalTeamEdit from '@/views/biz-modals/schedule/personal-team/edit'\nimport { columns } from './reserve-info.config'\nexport default {\n  name: 'ReserveInfo',\n  modals: {\n    SchedulePersonalTeamEdit\n  },\n  serviceInject() {\n    return {\n      commonService: CommonService,\n      reserveService: ReserveService,\n      scheduleService: ScheduleService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    const commonService = this.commonService\n    return {\n      loading: this.reserveService.loading$,\n      memberOptions: commonService.memberOptions$,\n      consumeOptions: commonService.consumeOptions$,\n      reserveList: this.reserveService.reserveList$,\n      reserveInfo: this.reserveService.reserveInfo$,\n      auth: this.reserveService.auth$,\n      infoAuth: this.reserveService.infoAuth$\n    }\n  },\n  props: {\n    id: Number\n  },\n  data() {\n    return {\n      memberId: '',\n      consumeType: '',\n      consumeId: '',\n      consumeTypeId: '',\n      consumeName: '',\n      effectiveState: 1,\n      siteNumIds: [],\n      dataSource: [],\n      keyword: '',\n      memberName: '',\n      show: false,\n      info: {}\n    }\n  },\n  computed: {\n    columns,\n    courseId() {\n      return this.reserveInfo.course_id\n    },\n    scheduleId() {\n      return this.reserveInfo.id\n    }\n  },\n  created() {\n    this.getReserveInfo()\n  },\n  methods: {\n    keywordFilter(item) {\n      let str\n      if (item.is_minors === 1) {\n        str = `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`.replace(\n          new RegExp(this.keyword),\n          `<span class=\"color-primary\">${this.keyword}</span>`\n        )\n      } else {\n        str = `${item.member_name} ${item.mobile}`.replace(\n          new RegExp(this.keyword),\n          `<span class=\"color-primary\">${this.keyword}</span>`\n        )\n      }\n      return str\n    },\n    onSearch(value) {\n      this.keyword = value\n      this.commonService\n        .getMemberList({\n          member_name: value\n        })\n        .subscribe()\n    },\n    getMemberName(id) {\n      let memberName = ''\n      this.memberOptions.forEach(item => {\n        if (item.member_id === id) {\n          memberName = item.member_name\n        }\n      })\n      return memberName\n    },\n    onChange(value) {\n      this.memberId = value\n      this.memberName = this.getMemberName(value)\n      this.commonService\n        .getConsumeList({\n          course_id: this.courseId,\n          member_id: value\n        })\n        .subscribe()\n    },\n    onChangeConsumeType(val) {\n      const obj = JSON.parse(val)\n      this.consumeType = obj.consume_type\n      this.consumeName = obj.name\n      //  因为会员卡，私教课，储值卡，课程包只有课程包有这个字段 没这个字段也是生效 undefined也为1\n      this.effectiveState = obj.effective_state === 0 ? 0 : 1\n      this.consumeId = obj.id\n    },\n    add() {\n      const form = {\n        schedule_id: this.id,\n        member_id: this.memberId,\n        consume_type: this.consumeType,\n        consume_id: this.consumeId\n      }\n      this.reserveService.add(form).subscribe(this.onAddReserveSuccess)\n    },\n    addReserve() {\n      // 生效的课程不二次判断\n      if (this.effectiveState) {\n        this.add()\n        return\n      }\n      this.$confirm({\n        title: '',\n        content: `新增预约后, ${this.memberName}的课程包${\n          this.consumeName.split('(')[0]\n        }会立即生效，确认新增?`,\n        onOk: () => {\n          this.add()\n          this.effectiveState = 1\n        }\n      })\n    },\n    cancelReserve(id) {\n      this.reserveService.cancel(id).subscribe(this.onCancelReserveSuccess)\n    },\n    check(id) {\n      const params = {\n        id,\n        checkin_method: 4\n      }\n      this.reserveService.check(params).subscribe(this.onCheckSuccess)\n    },\n    edit(key) {\n      const newData = [...this.data]\n      const target = newData.filter(item => key === item.key)[0]\n      if (target) {\n        target.editable = true\n        this.data = newData\n      }\n      target.editable = true\n      this.data = newData\n    },\n    save(key) {\n      const newData = [...this.data]\n      const target = newData.filter(item => key === item.key)[0]\n      if (target) {\n        delete target.editable\n        this.data = newData\n        this.cacheData = newData.map(item => ({ ...item }))\n      }\n    },\n    cancelSchedule() {\n      this.scheduleService.del(this.id).subscribe(this.onDelScheduleScuccess)\n    },\n    updateSchedule() {\n      this.show = false\n      this.$modalRouter.push({\n        name: 'schedule-personal-team-edit',\n        props: {\n          info: this.reserveInfo\n        },\n        on: {\n          ok: () => {\n            this.$router.push({ query: this.$searchQuery })\n          }\n        }\n      })\n    },\n    getReserveInfo() {\n      this.reserveService.getInfo(this.id).subscribe()\n    },\n    onAddReserveSuccess() {\n      this.memberId = undefined\n      this.consumeType = undefined\n      this.getReserveInfo()\n    },\n    onCancelReserveSuccess() {\n      this.getReserveInfo()\n    },\n    onCheckSuccess() {\n      this.getReserveInfo()\n    },\n    onDelScheduleScuccess() {\n      this.$router.push({ query: this.$searchQuery })\n      this.show = false\n    }\n  }\n}\n",{"version":3,"sources":["reserve-info.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"reserve-info.vue","sourceRoot":"src/views/biz-modals/schedule/personal-team","sourcesContent":["<template>\n  <st-modal\n    class=\"modal-reserved\"\n    title=\"预约详情\"\n    @ok=\"save\"\n    width=\"755px\"\n    :footer=\"null\"\n    v-model=\"show\"\n  >\n    <a-row :gutter=\"24\" class=\"modal-reserved-info\">\n      <a-col :lg=\"8\">\n        <st-info>\n          <st-info-item :label=\"`上课${$c('coach')}`\">\n            {{ reserveInfo.coach_name }}\n          </st-info-item>\n\n          <st-info-item label=\"上课时间\">\n            {{ reserveInfo.start_time }}\n          </st-info-item>\n          <st-info-item label=\"课时费\">\n            {{ reserveInfo.course_fee }}\n          </st-info-item>\n        </st-info>\n      </a-col>\n      <a-col :lg=\"8\">\n        <st-info>\n          <st-info-item label=\"课程名称\">\n            {{ reserveInfo.course_name }}\n          </st-info-item>\n          <st-info-item label=\"最大人数\">\n            {{ reserveInfo.limit_num }}\n          </st-info-item>\n        </st-info>\n      </a-col>\n      <a-col :lg=\"8\">\n        <st-info>\n          <st-info-item label=\"上课日期\">\n            {{ reserveInfo.start_date }}\n          </st-info-item>\n          <st-info-item label=\"预约人数\" v-if=\"reserveInfo.reserve\">\n            {{ reserveInfo.reserve.length }}\n          </st-info-item>\n        </st-info>\n      </a-col>\n    </a-row>\n    <st-container>\n      <st-form-table hoverable>\n        <thead>\n          <tr>\n            <th v-for=\"col in columns\" :key=\"col.dataIndex\">{{ col.title }}</th>\n          </tr>\n        </thead>\n        <tbody v-if=\"!loading.add\">\n          <tr>\n            <td class=\"st-form-table__add\">\n              <a-select\n                slot=\"member\"\n                showSearch\n                placeholder=\"搜索会员名\"\n                style=\"width: 149px\"\n                :defaultActiveFirstOption=\"false\"\n                :dropdownMatchSelectWidth=\"false\"\n                :showArrow=\"false\"\n                :filterOption=\"false\"\n                @search=\"onSearch\"\n                @change=\"onChange\"\n                notFoundContent=\"无搜索结果\"\n              >\n                <a-select-option\n                  v-for=\"member in memberOptions\"\n                  :key=\"member.member_id\"\n                >\n                  <div class=\"st-form-table__add-option\">\n                    <span\n                      class=\"item-name\"\n                      v-html=\"keywordFilter(member)\"\n                    ></span>\n                  </div>\n                </a-select-option>\n              </a-select>\n            </td>\n            <td>\n              <a-select\n                slot=\"consume_type\"\n                placeholder=\"选择消费方式\"\n                style=\"width: 260px\"\n                :dropdownMatchSelectWidth=\"false\"\n                @change=\"onChangeConsumeType\"\n              >\n                <a-select-opt-group\n                  v-for=\"consumeType in consumeOptions\"\n                  :key=\"consumeType.id\"\n                >\n                  <span slot=\"label\">\n                    <a-icon type=\"snippets\" />\n                    {{ consumeType.name }}\n                  </span>\n                  <a-select-option\n                    v-for=\"consume in consumeType.children\"\n                    :value=\"JSON.stringify(consume)\"\n                    :key=\"consume.id\"\n                  >\n                    {{ consume.name }}\n                  </a-select-option>\n                </a-select-opt-group>\n              </a-select>\n            </td>\n            <td>未签到</td>\n            <td>\n              <a v-if=\"auth.add\" @click=\"addReserve\">\n                新增预约\n              </a>\n            </td>\n          </tr>\n          <tr v-for=\"(item, index) in reserveList\" :key=\"index\">\n            <td>{{ item.member }}</td>\n            <td>{{ item.consume_name }}</td>\n            <td>{{ item.is_checkin_name }}</td>\n            <td>\n              <div>\n                <st-popconfirm\n                  v-if=\"\n                    item.auth['shop:reserve:personal_team_course_reserve|del']\n                  \"\n                  title=\"确认取消预约？\"\n                  class=\"mg-r8\"\n                  @confirm=\"cancelReserve(item.id)\"\n                >\n                  <a>取消预约</a>\n                </st-popconfirm>\n                <st-popconfirm\n                  v-if=\"\n                    item.auth[\n                      'shop:reserve:personal_team_course_reserve|checkin'\n                    ]\n                  \"\n                  title=\"确认签到消费？\"\n                  @confirm=\"check(item.id)\"\n                >\n                  <a>签到消费</a>\n                </st-popconfirm>\n              </div>\n            </td>\n          </tr>\n        </tbody>\n      </st-form-table>\n    </st-container>\n\n    <div class=\"mg-t24 ta-r\">\n      <a-popconfirm\n        v-if=\"\n          infoAuth &&\n            infoAuth['shop:schedule:personal_team_course_schedule|del']\n        \"\n        @confirm=\"cancelSchedule\"\n        okText=\"确认\"\n        cancelText=\"取消\"\n      >\n        <div slot=\"title\">\n          是否取消课程？\n          <div class=\"color-danger\">将发送消息通知已报名用户并发起自动退款</div>\n        </div>\n        <st-button>取消课程</st-button>\n      </a-popconfirm>\n      <st-button\n        v-if=\"\n          infoAuth &&\n            infoAuth['shop:schedule:personal_team_course_schedule|edit']\n        \"\n        class=\"mg-l8\"\n        type=\"primary\"\n        @click=\"updateSchedule\"\n      >\n        修改课程\n      </st-button>\n    </div>\n  </st-modal>\n</template>\n\n<script>\nimport { switchMap } from 'rxjs/operators'\nimport { MessageService } from '@/services/message.service'\nimport { PersonalTeamScheduleCommonService as CommonService } from '@/views/pages/shop/product/course/schedule/personal-team/service#/common.service'\nimport { PersonalTeamScheduleReserveService as ReserveService } from '@/views/pages/shop/product/course/schedule/personal-team/service#/reserve.service'\nimport { PersonalTeamScheduleScheduleService as ScheduleService } from '@/views/pages/shop/product/course/schedule/personal-team/service#/schedule.service'\nimport SchedulePersonalTeamEdit from '@/views/biz-modals/schedule/personal-team/edit'\nimport { columns } from './reserve-info.config'\nexport default {\n  name: 'ReserveInfo',\n  modals: {\n    SchedulePersonalTeamEdit\n  },\n  serviceInject() {\n    return {\n      commonService: CommonService,\n      reserveService: ReserveService,\n      scheduleService: ScheduleService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    const commonService = this.commonService\n    return {\n      loading: this.reserveService.loading$,\n      memberOptions: commonService.memberOptions$,\n      consumeOptions: commonService.consumeOptions$,\n      reserveList: this.reserveService.reserveList$,\n      reserveInfo: this.reserveService.reserveInfo$,\n      auth: this.reserveService.auth$,\n      infoAuth: this.reserveService.infoAuth$\n    }\n  },\n  props: {\n    id: Number\n  },\n  data() {\n    return {\n      memberId: '',\n      consumeType: '',\n      consumeId: '',\n      consumeTypeId: '',\n      consumeName: '',\n      effectiveState: 1,\n      siteNumIds: [],\n      dataSource: [],\n      keyword: '',\n      memberName: '',\n      show: false,\n      info: {}\n    }\n  },\n  computed: {\n    columns,\n    courseId() {\n      return this.reserveInfo.course_id\n    },\n    scheduleId() {\n      return this.reserveInfo.id\n    }\n  },\n  created() {\n    this.getReserveInfo()\n  },\n  methods: {\n    keywordFilter(item) {\n      let str\n      if (item.is_minors === 1) {\n        str = `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`.replace(\n          new RegExp(this.keyword),\n          `<span class=\"color-primary\">${this.keyword}</span>`\n        )\n      } else {\n        str = `${item.member_name} ${item.mobile}`.replace(\n          new RegExp(this.keyword),\n          `<span class=\"color-primary\">${this.keyword}</span>`\n        )\n      }\n      return str\n    },\n    onSearch(value) {\n      this.keyword = value\n      this.commonService\n        .getMemberList({\n          member_name: value\n        })\n        .subscribe()\n    },\n    getMemberName(id) {\n      let memberName = ''\n      this.memberOptions.forEach(item => {\n        if (item.member_id === id) {\n          memberName = item.member_name\n        }\n      })\n      return memberName\n    },\n    onChange(value) {\n      this.memberId = value\n      this.memberName = this.getMemberName(value)\n      this.commonService\n        .getConsumeList({\n          course_id: this.courseId,\n          member_id: value\n        })\n        .subscribe()\n    },\n    onChangeConsumeType(val) {\n      const obj = JSON.parse(val)\n      this.consumeType = obj.consume_type\n      this.consumeName = obj.name\n      //  因为会员卡，私教课，储值卡，课程包只有课程包有这个字段 没这个字段也是生效 undefined也为1\n      this.effectiveState = obj.effective_state === 0 ? 0 : 1\n      this.consumeId = obj.id\n    },\n    add() {\n      const form = {\n        schedule_id: this.id,\n        member_id: this.memberId,\n        consume_type: this.consumeType,\n        consume_id: this.consumeId\n      }\n      this.reserveService.add(form).subscribe(this.onAddReserveSuccess)\n    },\n    addReserve() {\n      // 生效的课程不二次判断\n      if (this.effectiveState) {\n        this.add()\n        return\n      }\n      this.$confirm({\n        title: '',\n        content: `新增预约后, ${this.memberName}的课程包${\n          this.consumeName.split('(')[0]\n        }会立即生效，确认新增?`,\n        onOk: () => {\n          this.add()\n          this.effectiveState = 1\n        }\n      })\n    },\n    cancelReserve(id) {\n      this.reserveService.cancel(id).subscribe(this.onCancelReserveSuccess)\n    },\n    check(id) {\n      const params = {\n        id,\n        checkin_method: 4\n      }\n      this.reserveService.check(params).subscribe(this.onCheckSuccess)\n    },\n    edit(key) {\n      const newData = [...this.data]\n      const target = newData.filter(item => key === item.key)[0]\n      if (target) {\n        target.editable = true\n        this.data = newData\n      }\n      target.editable = true\n      this.data = newData\n    },\n    save(key) {\n      const newData = [...this.data]\n      const target = newData.filter(item => key === item.key)[0]\n      if (target) {\n        delete target.editable\n        this.data = newData\n        this.cacheData = newData.map(item => ({ ...item }))\n      }\n    },\n    cancelSchedule() {\n      this.scheduleService.del(this.id).subscribe(this.onDelScheduleScuccess)\n    },\n    updateSchedule() {\n      this.show = false\n      this.$modalRouter.push({\n        name: 'schedule-personal-team-edit',\n        props: {\n          info: this.reserveInfo\n        },\n        on: {\n          ok: () => {\n            this.$router.push({ query: this.$searchQuery })\n          }\n        }\n      })\n    },\n    getReserveInfo() {\n      this.reserveService.getInfo(this.id).subscribe()\n    },\n    onAddReserveSuccess() {\n      this.memberId = undefined\n      this.consumeType = undefined\n      this.getReserveInfo()\n    },\n    onCancelReserveSuccess() {\n      this.getReserveInfo()\n    },\n    onCheckSuccess() {\n      this.getReserveInfo()\n    },\n    onDelScheduleScuccess() {\n      this.$router.push({ query: this.$searchQuery })\n      this.show = false\n    }\n  }\n}\n</script>\n"]}]}