(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["tier-3~shop-finance-gathering~shop-reception~shop-sold-transaction"],{"0262":function(e,t,n){"use strict";var i,a;n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return a})),function(e){e[e["MEMBER_CARD"]=1]="MEMBER_CARD",e[e["COURSE"]=2]="COURSE",e[e["PACKAGE"]=3]="PACKAGE",e[e["CARD"]=4]="CARD",e[e["RELET"]=5]="RELET",e[e["EARNEST"]=6]="EARNEST"}(i||(i={})),function(e){e[e["MEMBER_CARD"]=1]="MEMBER_CARD",e[e["DEPOSIT_CARD"]=2]="DEPOSIT_CARD",e[e["PERSONAL_COURSE"]=3]="PERSONAL_COURSE",e[e["STORE"]=4]="STORE",e[e["PACKAGE"]=5]="PACKAGE",e[e["CABINET"]=6]="CABINET",e[e["SMALL_COURSE"]=7]="SMALL_COURSE"}(a||(a={}))},"0f2b":function(e,t,n){"use strict";var i,a,o,s,r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("st-modal",{attrs:{title:"小班课签单",wrapClassName:"modal-sold-deal-sale"},on:{cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[n("div",{class:e.sale("content")},[n("st-form",{attrs:{form:e.form,labelWidth:"88px"}},[n("member-search",{class:e.sale("member"),attrs:{form:e.form,memberInfo:e.memberInfo,saleRangeType:e.saleRangeType,isSoldDeal:""},on:{select:e.onMemberChange,change:e.onMemberChange}}),n("div",{class:e.sale("sale")},[n("st-form-item",{attrs:{label:"选择课",required:""}},[n("select-scroll",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.productId,expression:"decorators.productId"}],attrs:{placeholder:"请选择课",notFoundContent:"无搜索结果",list:e.courseList,loading:e.loading.getSmallCourseList,disabled:!!e.id},on:{load:e.handleGetList,select:e.handleSelect,search:e.handleSearch}}),e.hasProductInfo?n("a-row",{class:e.sale("info"),attrs:{type:"flex",justify:"space-between"}},[n("a-col",{attrs:{span:12}},[n("st-info",[n("st-info-item",{attrs:{label:"允许转让"}},[e._v("\n                  "+e._s(e.info.is_transfer)+"\n                ")]),n("st-info-item",{attrs:{label:"转让手续费"}},[e._v("\n                  "+e._s(e.info.transfer_fee)+"\n                ")]),n("st-info-item",{attrs:{label:"开班条件"}},[e._v("\n                  "+e._s(e.info.num_min)+"~"+e._s(e.info.num_max)+"人\n                ")]),n("st-info-item",{attrs:{label:"开班时间"}},[e._v("\n                  "+e._s(e.courseBeginTime)+"\n                ")]),n("st-info-item",{attrs:{label:"上课方式"}},[e._v("\n                  "+e._s(e.info.course_type_name)+"\n                ")])],1)],1),n("a-col",{attrs:{span:11}},[n("st-info",[e.info.sale_range?n("st-info-item",{attrs:{label:"售卖群体"}},[e._v("\n                  "+e._s(e.info.sale_range.name)+"\n                ")]):e._e(),n("st-info-item",{attrs:{label:"总课时"}},[e._v("\n                  "+e._s(e.info.course_times)+"节\n                ")]),e.info.has_schedule?n("st-info-item",{attrs:{label:"排课状态"}},[e._v("\n                  "+e._s(e.info.has_schedule.name)+"\n                  "),e.info.has_schedule.status?n("a",{attrs:{href:e.onViewCourseHref,target:"_blank"}},[e._v("\n                    查看排期\n                  ")]):e._e()]):e._e(),n("st-info-item",{attrs:{label:"报名人数"}},[e._v("\n                  "+e._s(e.info.buy_member_counts)+"人\n                ")])],1)],1)],1):e._e()],1),n("st-form-item",{attrs:{required:"",label:"购买课时"}},[n("st-input-number",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.course_num,expression:"decorators.course_num"}],attrs:{placeholder:"请输入购买课时",disabled:e.isDisabledBuyNum,max:e.amountMax,min:e.amountMin}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("节")])])],1),n("editable-contract-number",{attrs:{form:e.form},model:{value:e.info.contract_number,callback:function(t){e.$set(e.info,"contract_number",t)},expression:"info.contract_number"}}),n("st-form-item",{staticClass:"mg-b12",attrs:{label:"商品价格"}},[e._v("\n          "+e._s(e.orderAmountPrice)+"元\n        ")]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"优惠券"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.couponText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseAdvance}),attrs:{disabled:!e.canChoseAdvance,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.couponDropdownVisible,callback:function(t){e.couponDropdownVisible=t},expression:"couponDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v(e._s(e.couponList.length)+"张可用优惠券")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectCouponChange},slot:"overlay",model:{value:e.selectCoupon,callback:function(t){e.selectCoupon=t},expression:"selectCoupon"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.couponList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:t}},[e._v("\n                        "+e._s(t.name)+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"定金抵扣"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.advanceText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseAdvance}),attrs:{disabled:!e.canChoseAdvance,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.advanceDropdownVisible,callback:function(t){e.advanceDropdownVisible=t},expression:"advanceDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v("定金选择")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectAdvanceChange},slot:"overlay",model:{value:e.selectAdvance,callback:function(t){e.selectAdvance=t},expression:"selectAdvance"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.advanceList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:t.id}},[e._v("\n                        定金 "+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{attrs:{label:"减免金额"}},[n("st-input-number",{attrs:{float:!0,placeholder:"请输入减免金额"},model:{value:e.reduceAmount,callback:function(t){e.reduceAmount=t},expression:"reduceAmount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1),n("st-form-item",{staticClass:"mg-b0",attrs:{validateStatus:"error",help:e.orderAmountText,label:"小计"}},[n("span",{staticClass:"total"},[e._v(e._s(e.priceInfo)+"元")])])],1),n("div",{class:e.sale("remarks")},[n("st-form-item",{attrs:{label:"销售人员",required:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.saleName,expression:"decorators.saleName"}],attrs:{placeholder:"选择签单的工作人员"}},e._l(e.saleList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1),n("div",[n("st-checkbox",{model:{value:e.isFollowSalesman,callback:function(t){e.isFollowSalesman=t},expression:"isFollowSalesman"}},[e._v("\n              作为用户跟进销售\n            ")])],1)],1),n("st-form-item",{staticClass:"mg-b0",attrs:{label:"备注"}},[n("st-textarea",{attrs:{autosize:{minRows:4,maxRows:6},maxlength:200},model:{value:e.description,callback:function(t){e.description=t},expression:"description"}})],1)],1)],1)],1),n("template",{slot:"footer"},[n("div",{class:e.sale("footer")},[n("div",{staticClass:"price"},[n("span",[e._v(e._s(e.priceInfo)+"元")]),n("span",[e._v("订单总额："+e._s(e.orderAmountPrice)+"元")])]),n("div",{staticClass:"button"},[n("st-button",{attrs:{loading:e.loading.setTransactionOrder},on:{click:e.onCreateOrder}},[e._v("\n          创建订单\n        ")]),n("st-button",{attrs:{loading:e.loading.setTransactionPay,type:"primary"},on:{click:e.onPay}},[e._v("\n          立即支付\n        ")])],1)])])],2)},c=[],d=n("d225"),l=n("b0b4"),u=n("9ab4"),p=n("0cd5"),m=n("df29"),f=n("75ca"),_=n("af6c"),h=n("1b92"),b=n("54da"),v=n("c4cc"),g=n("1a2d"),y=n("d792"),C=n("f59d"),O=function(){function e(t,n){var i=this;Object(d["a"])(this,e),this.contractApi=t,this.transactionApi=n,this.finished$=new m["d"]({}),this.loading$=new m["d"]({}),this.page$=new m["d"]({}),this.info$=new m["d"]({}),this.priceInfo$=new m["d"]("0"),this.orderAmountPrice$=new m["d"]("0"),this.memberList$=new m["d"]({}),this.courseList$=new m["d"]([]),this.saleList$=new m["d"]({}),this.couponList$=new m["d"]([]),this.coachList$=new m["d"]({}),this.personalPrice$=new m["d"]({}),this.priceAction$=new m["a"]((function(e){return e.pipe(i.debounceMap(),Object(v["a"])((function(e){i.priceInfo$.commit((function(){return e.info.price}))})))})),this.orderAmountPriceAction$=new m["a"]((function(e){return e.pipe(i.debounceMap(),Object(v["a"])((function(e){i.orderAmountPrice$.commit((function(){return e.info.price}))})))}))}return Object(l["a"])(e,[{key:"REST_COUPONLIST",value:function(){this.couponList$.commit((function(){return[]}))}},{key:"SET_LIST",value:function(e){this.courseList$.commit((function(){return e}))}},{key:"debounceMap",value:function(){var e=this;return function(t){return t.pipe(Object(g["a"])(200),Object(y["a"])((function(t){return e.getPrice(t).pipe(Object(C["a"])((function(){return h["a"]})))})))}}},{key:"getSmallCourseList",value:function(e){var t=this;return this.transactionApi.getTransactionList(e).pipe(Object(v["a"])((function(e){t.page$.commit((function(){return e.page})),t.finished$.commit((function(){return e.page.current_page>=e.page.total_pages})),t.courseList$.commit((function(t){return 1!==e.page.current_page&&e.page.current_page||(t=[]),t.concat(e.list)}))})))}},{key:"getInfo",value:function(e){var t=this;return this.transactionApi.getTransactionInfo(e,"small_course/detail").pipe(Object(v["a"])((function(e){t.info$.commit((function(){return e.info}))})))}},{key:"getAdvanceList",value:function(e){return this.transactionApi.getTransactionAdvanceList(e)}},{key:"getSaleList",value:function(){var e=this;return this.transactionApi.getTransactionSaleList().pipe(Object(v["a"])((function(t){e.saleList$.commit((function(){return t.list}))})))}},{key:"getCouponList",value:function(e){var t=this;return this.transactionApi.getTransactionCouponList(e,"small_course").pipe(Object(v["a"])((function(e){t.couponList$.commit((function(){return e.list}))})))}},{key:"serviceInit",value:function(){return Object(b["a"])(this.getSaleList())}},{key:"setTransactionOrder",value:function(e){return this.transactionApi.setTransaction(e,"small_course")}},{key:"setTransactionPay",value:function(e){return this.transactionApi.setTransaction(e,"small_course")}},{key:"getPrice",value:function(e){return this.transactionApi.getTransactionPrice(e)}}]),e}();Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(i="undefined"!==typeof f["TransactionListInput"]&&f["TransactionListInput"])?i:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getSmallCourseList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getAdvanceList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[]),Object(u["d"])("design:returntype",void 0)],O.prototype,"serviceInit",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionOrder",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionPay",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(a="undefined"!==typeof f["TransactionPriceInput"]&&f["TransactionPriceInput"])?a:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getPrice",null),O=Object(u["b"])([Object(p["b"])(),Object(u["d"])("design:paramtypes",["function"===typeof(o="undefined"!==typeof _["a"]&&_["a"])?o:Object,"function"===typeof(s="undefined"!==typeof f["c"]&&f["c"])?s:Object])],O);var A=n("c32d"),S=n.n(A),j=n("ec41"),T=n("5c8a"),P=n("808d"),L=n("2527"),w=function(e){e.pattern;return{course_num:{rules:[{required:!0,message:"请输入购买课时"}]},gift_course_num:{},coursePrice:{rules:[{required:!0,message:"请输入课程的单价"}]},saleName:{rules:[{required:!0,message:"请选择销售人员"}]},productId:{initialValue:void 0,rules:[{required:!0,message:"请选择课"}]}}},$=n("2138"),x=n("464d"),I=n("2d9d"),k=n("5ff9"),D=n("b283"),F={name:"ModalSoldDealSaleMemberCard",bem:{sale:"modal-sold-deal-sale"},components:{EditableContractNumber:x["a"],MemberSearch:I["a"],SelectScroll:k["a"]},serviceProviders:function(){return[O]},serviceInject:function(){return{saleSmallCourseService:O,userService:$["a"],pattern:L["a"]}},rxState:function(){return{page:this.saleSmallCourseService.page$,loading:this.saleSmallCourseService.loading$,info:this.saleSmallCourseService.info$,courseList:this.saleSmallCourseService.courseList$,saleList:this.saleSmallCourseService.saleList$,couponList:this.saleSmallCourseService.couponList$,personalPrice:this.saleSmallCourseService.personalPrice$,priceInfo:this.saleSmallCourseService.priceInfo$,orderAmountPrice:this.saleSmallCourseService.orderAmountPrice$}},props:{id:{type:String},memberInfo:{type:Object}},data:function(){var e=this.$stForm.create(),t=e.decorators(w);return{COURSE_TYPE:D["b"],form:e,decorators:t,show:!1,validEndTime:0,advanceDropdownVisible:!1,advanceList:[],advanceText:"未选择定金",advanceAmount:"",selectAdvance:"",reduceAmount:null,description:"",selectCoupon:"",couponText:"未选择优惠券",couponAmount:"",couponDropdownVisible:!1,product_id:"",isFollowSalesman:0,product_name:""}},computed:{modelTitle:function(){return this.$c("small_course")+"签单"},canChoseCoupon:function(){var e=this.couponList.length;return(this.id||this.product_id)&&e},canChoseAdvance:function(){var e=this.advanceList.length;return(this.id||this.product_id)&&e},onViewCourseHref:function(){var e=this.form.getFieldValue("productId")||void 0;return"/shop/product/course/schedule/small-course?app_brand_id=".concat(this.$searchQuery.app_brand_id,"&app_shop_id=").concat(this.$searchQuery.app_shop_id,"&course_id=").concat(e)},courseBeginTime:function(){return S()(1e3*this.info.course_begin_time).format("YYYY-MM-DD HH:MM")+"~"+S()(1e3*this.info.course_end_time).format("YYYY-MM-DD HH:MM")},orderAmountText:function(){return this.priceInfo<0?"小计不能为负":""},amountMax:function(){return this.info.buy_num||1},amountMin:function(){return 1},isDisabledBuyNum:function(){return this.info.course_type===this.COURSE_TYPE.FIXED_COURSE},saleRangeType:function(){return Object(j["a"])(this.info.sale_range,"type",1)},hasProductInfo:function(){return"{}"!==JSON.stringify(this.info)}},watch:{selectCoupon:{deep:!0,handler:function(e,t){this.getPrice(e,this.selectAdvance,+this.reduceAmount)}},selectAdvance:{deep:!0,handler:function(e,t){this.getPrice(this.selectCoupon,e,+this.reduceAmount)}},reduceAmount:function(e,t){this.getPrice(this.selectCoupon,this.selectAdvance,+e)}},mounted:function(){var e=this;this.saleSmallCourseService.serviceInit().subscribe((function(t){e.id?e.handleGetCourseInfo(e.id):e.saleSmallCourseService.getSmallCourseList({app_brand_id:e.$searchQuery.app_brand_id,app_shop_id:e.$searchQuery.app_shop_id,product_type:7}).subscribe()}))},methods:{moment:S.a,handleSelect:function(e){this.product_id=e,this.onResetDiscounts(),this.handleGetCourseInfo(e)},handleSearch:function(e){this.product_name=e,this.saleSmallCourseService.getSmallCourseList({product_name:e,current_page:1,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:7}).subscribe()},onResetDiscounts:function(){this.resetCoupon(),this.resetAdvance()},onReGetDiscounts:function(e){this.fetchAdvanceList(e),this.fetchCouponList(e)},onMemberChange:function(e){this.onResetDiscounts(),e&&this.onReGetDiscounts(e)},onSelectAdvance:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.advanceDropdownVisible=!1}))},onSelectCoupon:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.couponDropdownVisible=!1}))},resetAdvance:function(){this.advanceList=[],this.advanceText="未选择定金",this.selectAdvance="",this.advanceAmount=""},resetCoupon:function(){this.saleSmallCourseService.REST_COUPONLIST(),this.couponText="未选择优惠券",this.selectCoupon="",this.couponAmount=""},onCancel:function(){this.resetAdvance(),this.resetCoupon()},onSelectAdvanceChange:function(e){if(!e.target.value)return this.advanceAmount=0,void(this.advanceText="未选择定金");var t=this.advanceList.filter((function(t){return t.id===e.target.value}))[0].price;this.advanceAmount=t,this.advanceText="".concat(t,"元")},onSelectCouponChange:function(e){var t=Object(j["a"])(e.target.value,"id","");if(t){var n=this.couponList.filter((function(e){return e.id===t}))[0].price;this.couponAmount=n,this.couponText="".concat(n,"元")}else this.couponText="未选择优惠券",this.couponAmount=0},getPrice:function(e,t,n){var i=-1===t?"":t,a=this.form.getFieldValue("productId")||void 0;this.saleSmallCourseService.priceAction$.dispatch({product_id:a,product_type:this.info.contract_type,product_num:this.form.getFieldValue("course_num"),coupon_id:e?e.id:void 0,advance_id:i,reduce_amount:n,member_id:this.form.getFieldValue("member_id")})},getOrderPrice:function(){var e=this.form.getFieldValue("productId")||void 0;this.saleSmallCourseService.orderAmountPriceAction$.dispatch({product_id:e,product_type:this.info.contract_type,product_num:0})},onCreateOrder:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0;e.saleSmallCourseService.setTransactionOrder({member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,country_prefix:t.mobile?t.mobile.code_id:void 0,small_course_id:n,course_num:t.course_num,contract_number:e.info.contract_number,coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,sale_range:e.info.sale_range.type,order_amount:e.priceInfo,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.$emit("success",{type:"create",orderId:t.info.order_id}),e.show=!1}))}))},onPay:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0;e.saleSmallCourseService.setTransactionPay({member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,country_prefix:t.mobile?t.mobile.code_id:void 0,small_course_id:n,course_num:t.course_num,contract_number:e.info.contract_number,coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,sale_range:e.info.sale_range.type,order_amount:e.priceInfo,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.$emit("success",{type:"createPay",orderId:t.info.order_id}),e.show=!1}))}))},fetchCouponList:function(e){var t=this.form.getFieldValue("member_id")||e,n=this.personalPrice.sell_price,i=this.form.getFieldValue("course_num"),a=this.form.getFieldValue("productId")||void 0;if(a&&t){var o={member_id:t,course_id:a,price:n,buy_num:i};this.saleSmallCourseService.getCouponList(o).subscribe()}},fetchAdvanceList:function(e){var t=this,n=this.form.getFieldValue("member_id")||e;n&&this.saleSmallCourseService.getAdvanceList(n).subscribe((function(e){t.advanceList=Object(T["a"])(e.list)}))},handleGetList:function(){if(this.finished)return!1;this.saleSmallCourseService.getSmallCourseList({product_name:this.product_name,current_page:++this.page.current_page,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:7}).subscribe()},handleGetCourseInfo:function(e){var t=this;this.saleSmallCourseService.getInfo(e).subscribe((function(n){t.id&&t.saleSmallCourseService.SET_LIST([{id:+t.id,product_name:t.info.course_name}]),setTimeout((function(){t.form.setFieldsValue({productId:+e,course_num:t.info.buy_num}),t.onReGetDiscounts(),t.getPrice(),t.getOrderPrice()}))}))}}},M=F,N=n("2877"),V=Object(N["a"])(M,r,c,!1,null,null,null);t["a"]=V.exports},1377:function(e,t,n){"use strict";var i,a,o,s,r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("st-modal",{attrs:{title:"储值卡签单",wrapClassName:"modal-sold-deal-sale"},on:{cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[n("div",{class:e.sale("content")},[n("st-form",{attrs:{form:e.form,labelWidth:"88px"}},[n("member-search",{class:e.sale("member"),attrs:{form:e.form,memberInfo:e.memberInfo,saleRangeType:e.saleRangeType,isSoldDeal:""},on:{select:e.onMemberChange,change:e.onMemberChange}}),n("div",{class:e.sale("sale")},[n("st-form-item",{attrs:{label:"选择卡",required:""}},[n("select-scroll",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.productId,expression:"decorators.productId"}],attrs:{placeholder:"请选择卡",notFoundContent:"无搜索结果",list:e.cardList,loading:e.loading.getDepositCardList,disabled:!!e.id},on:{load:e.handleGetList,select:e.handleSelect,search:e.handleSearch}}),e.hasProductInfo?n("a-row",{class:e.sale("info"),attrs:{type:"flex",justify:"space-between"}},[n("a-col",{attrs:{span:12}},[n("st-info",[n("st-info-item",{attrs:{label:"储值面额"}},[e._v("\n                  "+e._s(e.info.card_price)+"\n                ")]),n("st-info-item",{attrs:{label:"有效期"}},[e._v("\n                  "+e._s(e.info.valid_time)+"天\n                ")]),n("st-info-item",{attrs:{label:"支持消费类目"}},[e._v("\n                  "+e._s(e.info.consume_product)+"\n                ")])],1)],1),n("a-col",{attrs:{span:11}},[n("st-info",[n("st-info-item",{attrs:{label:"允许转让"}},[e._v("\n                  "+e._s(e.info.is_transfer)+"\n                ")]),n("st-info-item",{attrs:{label:"转让手续费"}},[e._v("\n                  "+e._s(e.info.transfer_fee)+"\n                ")]),n("st-info-item",{attrs:{label:"支持消费门店"}},[e._v("\n                  "+e._s(e.info.support_shop)+"\n                ")])],1)],1)],1):e._e()],1),n("st-form-item",{attrs:{label:"到期时间"}},[e._v("\n          "+e._s(e.moment().add(e.info.valid_time,"d").format("YYYY-MM-DD HH:mm"))+"\n        ")]),n("editable-contract-number",{attrs:{form:e.form},model:{value:e.info.contract_number,callback:function(t){e.$set(e.info,"contract_number",t)},expression:"info.contract_number"}}),n("st-form-item",{staticClass:"mg-b12",attrs:{label:"商品价格"}},[e._v("\n          "+e._s(e.info.sell_price)+"元\n        ")]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"定金抵扣"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.advanceText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseAdvance}),attrs:{disabled:!e.canChoseAdvance,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.advanceDropdownVisible,callback:function(t){e.advanceDropdownVisible=t},expression:"advanceDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v("\n                    "+e._s(0===e.advanceList.length?"无定金":"定金选择")+"\n                  ")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectAdvanceChange},slot:"overlay",model:{value:e.selectAdvance,callback:function(t){e.selectAdvance=t},expression:"selectAdvance"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.advanceList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:t.id}},[e._v("\n                        定金 "+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{attrs:{label:"减免金额"}},[n("st-input-number",{attrs:{float:!0,placeholder:"请输入"},model:{value:e.reduceAmount,callback:function(t){e.reduceAmount=t},expression:"reduceAmount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1),n("st-form-item",{staticClass:"mg-b0",attrs:{validateStatus:"error",help:e.orderAmountText,label:"小计"}},[n("span",{staticClass:"total"},[e._v(e._s(e.priceInfo)+"元")])])],1),n("div",{class:e.sale("remarks")},[n("st-form-item",{attrs:{label:"销售人员",required:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.saleName,expression:"decorators.saleName"}],attrs:{placeholder:"选择签单的工作人员"}},e._l(e.saleList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1),n("div",[n("st-checkbox",{model:{value:e.isFollowSalesman,callback:function(t){e.isFollowSalesman=t},expression:"isFollowSalesman"}},[e._v("\n              作为用户跟进销售\n            ")])],1)],1),n("st-form-item",{staticClass:"mg-b0",attrs:{label:"备注"}},[n("st-textarea",{attrs:{autosize:{minRows:4,maxRows:6},maxlength:200},model:{value:e.description,callback:function(t){e.description=t},expression:"description"}})],1)],1)],1)],1),n("template",{slot:"footer"},[n("div",{class:e.sale("footer")},[n("div",{staticClass:"price"},[n("span",[e._v(e._s(e.priceInfo)+"元")]),n("span",[e._v("订单总额："+e._s(e.info.sell_price)+"元")])]),n("div",{staticClass:"button"},[n("st-button",{attrs:{loading:e.loading.setTransaction},on:{click:e.onCreateOrder}},[e._v("\n          创建订单\n        ")]),n("st-button",{attrs:{loading:e.loading.setTransactionPay,type:"primary"},on:{click:e.onPay}},[e._v("\n          立即支付\n        ")])],1)])])],2)},c=[],d=n("d225"),l=n("b0b4"),u=n("9ab4"),p=n("0cd5"),m=n("df29"),f=n("75ca"),_=n("1a2d"),h=n("d792"),b=n("f59d"),v=n("c4cc"),g=n("af6c"),y=n("1b92"),C=n("54da"),O=function(){function e(t,n){var i=this;Object(d["a"])(this,e),this.contractApi=t,this.transactionApi=n,this.priceInfo$=new m["d"]("0"),this.finished$=new m["d"]({}),this.loading$=new m["d"]({}),this.page$=new m["d"]({}),this.info$=new m["d"]({}),this.cardList$=new m["d"]([]),this.saleList$=new m["d"]({}),this.couponList$=new m["d"]({}),this.priceAction$=new m["a"]((function(e){return e.pipe(Object(_["a"])(200),Object(h["a"])((function(e){return i.getPrice(e).pipe(Object(b["a"])((function(){return y["a"]})))})),Object(v["a"])((function(e){i.priceInfo$.commit((function(){return e.info.price}))})))}))}return Object(l["a"])(e,[{key:"REST_COUPONLIST",value:function(){this.couponList$.commit((function(){return[]}))}},{key:"SET_LIST",value:function(e){this.cardList$.commit((function(){return e}))}},{key:"getDepositCardList",value:function(e){var t=this;return this.transactionApi.getTransactionList(e).pipe(Object(v["a"])((function(e){t.page$.commit((function(){return e.page})),t.finished$.commit((function(){return e.page.current_page>=e.page.total_pages})),t.cardList$.commit((function(t){return 1===e.page.current_page&&(t=[]),t.concat(e.list)}))})))}},{key:"getInfo",value:function(e){var t=this;return this.transactionApi.getTransactionInfo(e,"deposit/card").pipe(Object(v["a"])((function(e){t.info$.commit((function(){return e.info}))})))}},{key:"getSaleList",value:function(){var e=this;return this.transactionApi.getTransactionSaleList().pipe(Object(v["a"])((function(t){e.saleList$.commit((function(){return t.list}))})))}},{key:"getCouponList",value:function(e){var t=this;return this.transactionApi.getTransactionCouponList(e,"deposit").pipe(Object(v["a"])((function(e){t.couponList$.commit((function(){return e.list}))})))}},{key:"getAdvanceList",value:function(e){return this.transactionApi.getTransactionAdvanceList(e)}},{key:"serviceInit",value:function(){return Object(C["a"])(this.getSaleList())}},{key:"setTransaction",value:function(e){return this.transactionApi.setTransaction(e,"deposit")}},{key:"setTransactionPay",value:function(e){return this.transactionApi.setTransaction(e,"deposit")}},{key:"getPrice",value:function(e){return this.transactionApi.getTransactionPrice(e)}}]),e}();Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(i="undefined"!==typeof f["TransactionListInput"]&&f["TransactionListInput"])?i:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getDepositCardList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getAdvanceList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[]),Object(u["d"])("design:returntype",void 0)],O.prototype,"serviceInit",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransaction",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionPay",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(a="undefined"!==typeof f["TransactionPriceInput"]&&f["TransactionPriceInput"])?a:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getPrice",null),O=Object(u["b"])([Object(p["b"])(),Object(u["d"])("design:paramtypes",["function"===typeof(o="undefined"!==typeof g["a"]&&g["a"])?o:Object,"function"===typeof(s="undefined"!==typeof f["c"]&&f["c"])?s:Object])],O);var A=n("c32d"),S=n.n(A),j=n("ec41"),T=n("5c8a"),P=n("808d"),L=n("2527"),w=function(e){e.pattern;return{saleName:{rules:[{required:!0,message:"请选择销售人员"}]},productId:{initialValue:void 0,rules:[{required:!0,message:"请选择卡"}]}}},$=n("464d"),x=n("2d9d"),I=n("5ff9"),k={name:"ModalSoldDealSaleMemberCard",bem:{sale:"modal-sold-deal-sale"},components:{EditableContractNumber:$["a"],MemberSearch:x["a"],SelectScroll:I["a"]},serviceProviders:function(){return[O]},serviceInject:function(){return{saleDepositCardService:O,pattern:L["a"]}},rxState:function(){return{page:this.saleDepositCardService.page$,loading:this.saleDepositCardService.loading$,finished:this.saleDepositCardService.finished$,priceInfo:this.saleDepositCardService.priceInfo$,info:this.saleDepositCardService.info$,cardList:this.saleDepositCardService.cardList$,couponList:this.saleDepositCardService.couponList$,saleList:this.saleDepositCardService.saleList$}},props:{id:{type:String},memberInfo:{type:Object}},data:function(){var e=this.$stForm.create(),t=e.decorators(w);return{form:e,decorators:t,show:!1,advanceDropdownVisible:!1,advanceList:[],advanceText:"未选择定金",advanceAmount:"",selectAdvance:"",reduceAmount:null,description:"",selectCoupon:"",couponText:"未选择优惠券",couponAmount:"",couponDropdownVisible:!1,product_id:"",isFollowSalesman:0,product_name:""}},watch:{selectAdvance:{deep:!0,handler:function(e,t){this.getPrice(e,+this.reduceAmount)}},reduceAmount:function(e,t){this.getPrice(this.selectAdvance,+e)}},mounted:function(){var e=this;this.saleDepositCardService.serviceInit().subscribe((function(t){e.id?e.handleGetDepositCardInfo(e.id):e.saleDepositCardService.getDepositCardList({app_brand_id:e.$searchQuery.app_brand_id,app_shop_id:e.$searchQuery.app_shop_id,product_type:2}).subscribe()}))},computed:{canChoseCoupon:function(){var e=this.couponList.length;return!!e},canChoseAdvance:function(){var e=this.advanceList.length;return(this.id||this.product_id)&&e},orderAmountText:function(){return this.priceInfo<0?"小计不能为负":""},saleRangeType:function(){return Object(j["a"])(this.info.sale_range,"type",1)},hasProductInfo:function(){return"{}"!==JSON.stringify(this.info)}},methods:{moment:S.a,handleSelect:function(e){this.product_id=e,this.onResetDiscounts(),this.handleGetDepositCardInfo(e)},handleSearch:function(e){this.product_name=e,this.saleDepositCardService.getDepositCardList({product_name:e,page:1,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:2}).subscribe()},handleGetList:function(){if(this.finished)return!1;this.saleDepositCardService.getDepositCardList({product_name:this.product_name,page:++this.page.current_page,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:2}).subscribe()},onResetDiscounts:function(){this.resetAdvance()},onReGetDiscounts:function(e){this.fetchAdvanceList(e)},onMemberChange:function(e){this.onResetDiscounts(),e&&this.onReGetDiscounts(e)},onSelectAdvance:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.advanceDropdownVisible=!1}))},onSelectCouponChange:function(e){var t=Object(j["a"])(e.target.value,"id","");if(t){var n=this.couponList.filter((function(e){return e.id===t}))[0].price;this.couponAmount=n,this.couponText="".concat(n,"元")}else this.couponText="未选择优惠券",this.couponAmount=0},resetAdvance:function(){this.advanceList=[],this.advanceText="未选择定金",this.advanceAmount="",this.selectAdvance=""},resetCoupon:function(){this.saleDepositCardService.REST_COUPONLIST(),this.couponText="未选择优惠券",this.selectCoupon="",this.couponAmount=""},onCancel:function(){this.resetAdvance()},onSelectAdvanceChange:function(e){if(!e.target.value)return this.advanceAmount=0,void(this.advanceText="未选择定金");var t=this.advanceList.filter((function(t){return t.id===e.target.value}))[0].price;this.advanceAmount=t,this.advanceText="".concat(t,"元")},getPrice:function(e,t){var n=-1===e?"":e,i=this.form.getFieldValue("member_id"),a=this.form.getFieldValue("productId");this.saleDepositCardService.priceAction$.dispatch({product_id:a||void 0,product_type:this.info.contract_type,advance_id:n,member_id:i||void 0,reduce_amount:t})},onCreateOrder:function(){var e=this;this.form.validate().then((function(t){var n=e.reduceAmount?+e.reduceAmount:0,i=e.form.getFieldValue("productId")||void 0;e.saleDepositCardService.setTransaction({member_id:+t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,deposit_card_id:i,contract_number:e.info.contract_number,advance_id:-1===e.selectAdvance?void 0:e.selectAdvance,reduce_amount:n,sale_id:+t.saleName,description:e.description,order_amount:e.priceInfo,sale_range:+e.info.sale_range.type,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.show=!1,e.$emit("success",{type:"create",orderId:t.info.order_id})}))}))},onPay:function(){var e=this;this.form.validate().then((function(t){var n=e.reduceAmount?+e.reduceAmount:0,i=e.form.getFieldValue("productId")||void 0;e.saleDepositCardService.setTransactionPay({member_id:+t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,deposit_card_id:i,contract_number:e.info.contract_number,advance_id:-1===e.selectAdvance?void 0:e.selectAdvance,reduce_amount:n,sale_id:+t.saleName,description:e.description,order_amount:e.priceInfo,sale_range:+e.info.sale_range.type,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.show=!1,e.$emit("success",{type:"createPay",orderId:t.info.order_id})}))}))},handleGetDepositCardInfo:function(e){var t=this;this.saleDepositCardService.getInfo(e).subscribe((function(n){t.id&&t.saleDepositCardService.SET_LIST([{id:+t.id,product_name:t.info.product_name}]),setTimeout((function(){t.form.setFieldsValue({productId:+e}),t.onReGetDiscounts(),t.getPrice(t.selectAdvance,+t.reduceAmount)}))}))},fetchCouponList:function(e){var t=this.form.getFieldValue("member_id")||e,n=this.info.product_id;if(n&&t){var i={member_id:t,card_id:n};this.saleDepositCardService.getCouponList(i).subscribe()}},fetchAdvanceList:function(e){var t=this,n=this.form.getFieldValue("member_id")||e;n&&this.saleDepositCardService.getAdvanceList(n).subscribe((function(e){t.advanceList=Object(T["a"])(e.list)}))}}},D=k,F=n("2877"),M=Object(F["a"])(D,r,c,!1,null,null,null);t["a"]=M.exports},"4ede":function(e,t,n){"use strict";var i,a,o,s,r,c=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("st-modal",{attrs:{title:"租赁柜签单",wrapClassName:"modal-sold-deal-sale"},on:{cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[n("div",{class:e.sale("content")},[n("st-form",{attrs:{form:e.form,labelWidth:"88px"}},[n("member-search",{class:e.sale("member"),attrs:{form:e.form,memberInfo:e.memberInfo,saleRangeType:e.saleRangeType,isSoldDeal:""},on:{change:e.onMemberChange}}),n("div",{class:e.sale("sale")},[e.cabinetList?n("st-form-item",{attrs:{label:"租赁柜号",required:""}},[n("a-cascader",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.cabinet,expression:"decorators.cabinet"}],attrs:{allowClear:!1,fieldNames:e.cabinetFieldNames,options:e.cabinetList,placeholder:"请选择租赁柜号"},on:{change:e.onCabinetChange}}),e.hasProductInfo?n("a-row",{class:e.sale("info"),attrs:{type:"flex",justify:"space-between"}},[n("a-col",{attrs:{span:12}},[n("st-info",[n("st-info-item",{attrs:{label:"商品名称"}},[e._v("\n                  "+e._s(e.info.product_name)+"\n                ")]),n("st-info-item",{attrs:{label:"商品类型"}},[e._v("\n                  "+e._s(e.info.product_type)+"\n                ")]),n("st-info-item",{staticClass:"mg-b24",attrs:{label:"租赁计费"}},[e._v("\n                  "+e._s(e.info.price)+"\n                ")])],1)],1),n("a-col",{attrs:{span:11}},[n("st-info",[e.info.sale_range?n("st-info-item",{attrs:{label:"售卖群体"}},[e._v("\n                  "+e._s(e.info.sale_range.name)+"\n                ")]):e._e(),n("st-info-item",{attrs:{label:"允许转让"}},[e._v("\n                  "+e._s(e.info.is_transfer)+"\n                ")]),n("st-info-item",{staticClass:"mg-b24",attrs:{label:"转让手续费"}},[e._v("\n                  "+e._s(e.info.transfer)+"\n                ")])],1)],1)],1):e._e()],1):e._e(),n("st-form-item",{staticClass:"mg-b0",attrs:{required:"",label:"租赁时间"}},[n("div",{class:e.sale("time")},[n("a-form-item",{staticClass:"page-a-form"},[n("a-date-picker",{staticStyle:{width:"100%"},attrs:{disabled:"",format:"YYYY-MM-DD HH:mm",placeholder:"开始时间",showToday:!1},model:{value:e.startTime,callback:function(t){e.startTime=t},expression:"startTime"}})],1),n("span",[e._v("~")]),n("a-form-item",{staticClass:"page-a-form"},[n("a-date-picker",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.endTimePicker,expression:"decorators.endTimePicker"}],staticStyle:{width:"100%"},attrs:{allowClear:!1,disabled:e.disabledCalendar,showTime:{defaultValue:e.startTime,format:"HH:mm"},format:"YYYY-MM-DD HH:mm",placeholder:"结束时间",showToday:!1},on:{change:e.endTimeChange}})],1)],1)]),n("st-form-item",{attrs:{required:"",label:"租赁天数"}},[n("st-input-number",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.endTimeInput,expression:"decorators.endTimeInput"}],attrs:{disabledDate:e.disabledCalendar,max:999999},on:{change:e.onEndTimeInputChange}},[n("template",{slot:"addonAfter"},[e._v("\n              天\n            ")])],2)],1),n("editable-contract-number",{attrs:{form:e.form},model:{value:e.info.contract_number,callback:function(t){e.$set(e.info,"contract_number",t)},expression:"info.contract_number"}}),n("st-form-item",{staticClass:"mg-b12",attrs:{label:"租赁费用"}},[e._v("\n          "+e._s(e.orderAmountPrice)+"\n        ")]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"定金抵扣"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.advanceText))]),n("a-dropdown",{class:e.sale({disabled:0===e.advanceList.length}),attrs:{disabled:0===e.advanceList.length,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.advanceDropdownVisible,callback:function(t){e.advanceDropdownVisible=t},expression:"advanceDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v("\n                    "+e._s(0===e.advanceList.length?"无定金":"定金选择")+"\n                  ")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectAdvanceChange},slot:"overlay",model:{value:e.selectAdvance,callback:function(t){e.selectAdvance=t},expression:"selectAdvance"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.advanceList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:t.id}},[e._v("\n                        定金 "+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{attrs:{label:"减免金额"}},[n("st-input-number",{attrs:{float:!0,placeholder:"请输入"},model:{value:e.reduceAmount,callback:function(t){e.reduceAmount=t},expression:"reduceAmount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1),n("st-form-item",{staticClass:"mg-b0",attrs:{validateStatus:"error",help:e.orderAmountText,label:"小计"}},[n("span",{staticClass:"total"},[e._v(e._s(e.currentPrice))])])],1),n("div",{class:e.sale("remarks")},[n("st-form-item",{attrs:{label:"销售人员",required:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.saleName,expression:"decorators.saleName"}],attrs:{placeholder:"选择签单的工作人员"}},e._l(e.saleList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1),n("div",[n("st-checkbox",{model:{value:e.isFollowSalesman,callback:function(t){e.isFollowSalesman=t},expression:"isFollowSalesman"}},[e._v("\n              作为用户跟进销售\n            ")])],1)],1),n("st-form-item",{staticClass:"mg-b0",attrs:{label:"备注"}},[n("st-textarea",{attrs:{autosize:{minRows:4,maxRows:6},maxlength:200},model:{value:e.description,callback:function(t){e.description=t},expression:"description"}})],1)],1)],1)],1),n("template",{slot:"footer"},[n("div",{class:e.sale("footer")},[n("div",{staticClass:"price"},[n("span",[e._v(e._s(e.currentPrice))]),n("span",[e._v("订单总额："+e._s(e.orderAmountPrice))])]),n("div",{staticClass:"button"},[n("st-button",{attrs:{loading:e.loading.setTransaction},on:{click:e.onCreateOrder}},[e._v("\n          创建订单\n        ")]),n("st-button",{attrs:{loading:e.loading.setTransactionPay,type:"primary"},on:{click:e.onPay}},[e._v("\n          立即支付\n        ")])],1)])])],2)},d=[],l=(n("28a5"),n("c5f6"),n("d225")),u=n("b0b4"),p=n("9ab4"),m=n("0cd5"),f=n("df29"),_=n("af6c"),h=n("e555"),b=n("75ca"),v=n("c4cc"),g=n("1a2d"),y=n("d792"),C=n("f59d"),O=n("1b92"),A=n("54da"),S=n("dd5c"),j=function(){function e(t,n,i,a){var o=this;Object(l["a"])(this,e),this.contractApi=t,this.cabinetApi=n,this.memberApi=i,this.transactionApi=a,this.info$=new f["d"]({}),this.saleList$=new f["d"]([]),this.cabinetList$=new f["d"]([]),this.loading$=new f["d"]({}),this.currentPrice$=new f["d"]("0"),this.orderAmountPrice$=new f["d"]("0"),this.currentPriceAction$=new f["a"]((function(e){return e.pipe(o.debounceMap(),Object(v["a"])((function(e){o.currentPrice$.commit((function(){return e.info.price}))})))})),this.orderAmountPriceAction$=new f["a"]((function(e){return e.pipe(o.debounceMap(),Object(v["a"])((function(e){o.orderAmountPrice$.commit((function(){return e.info.price}))})))}))}return Object(u["a"])(e,[{key:"debounceMap",value:function(){var e=this;return function(t){return t.pipe(Object(g["a"])(200),Object(y["a"])((function(t){return e.getPrice(t).pipe(Object(C["a"])((function(){return O["a"]})))})))}}},{key:"getInfo",value:function(e){var t=this;return this.transactionApi.getTransactionInfo(e,"cabinet").pipe(Object(v["a"])((function(e){t.info$.commit((function(){return e.info}))})))}},{key:"getSaleList",value:function(){var e=this;return this.transactionApi.getTransactionSaleList().pipe(Object(v["a"])((function(t){e.saleList$.commit((function(){return t.list}))})))}},{key:"getCabinetList",value:function(e){var t=this;return this.cabinetApi.getCabinetList(e).pipe(Object(v["a"])((function(e){t.cabinetList$.commit((function(){return e.list}))})))}},{key:"getPrice",value:function(e){var t=this;return this.transactionApi.getTransactionPrice(e).pipe(Object(v["a"])((function(e){t.cabinetList$.commit((function(){return e.list}))})))}},{key:"init",value:function(e,t){return Object(A["a"])(this.getSaleList())}},{key:"getAdvanceList",value:function(e){return this.transactionApi.getTransactionAdvanceList(e)}},{key:"setTransaction",value:function(e){return this.transactionApi.setTransaction(e,"cabinet")}},{key:"setTransactionPay",value:function(e){return this.transactionApi.setTransaction(e,"cabinet")}}]),e}();Object(p["b"])([Object(f["c"])(),Object(p["d"])("design:type",Function),Object(p["d"])("design:paramtypes",["function"===typeof(i="undefined"!==typeof b["TransactionPriceInput"]&&b["TransactionPriceInput"])?i:Object]),Object(p["d"])("design:returntype",void 0)],j.prototype,"getPrice",null),Object(p["b"])([Object(f["c"])(),Object(p["d"])("design:type",Function),Object(p["d"])("design:paramtypes",[String,Object]),Object(p["d"])("design:returntype",void 0)],j.prototype,"init",null),Object(p["b"])([Object(f["c"])(),Object(p["d"])("design:type",Function),Object(p["d"])("design:paramtypes",[Object]),Object(p["d"])("design:returntype",void 0)],j.prototype,"getAdvanceList",null),Object(p["b"])([Object(f["c"])(),Object(p["d"])("design:type",Function),Object(p["d"])("design:paramtypes",[Object]),Object(p["d"])("design:returntype",void 0)],j.prototype,"setTransaction",null),Object(p["b"])([Object(f["c"])(),Object(p["d"])("design:type",Function),Object(p["d"])("design:paramtypes",[Object]),Object(p["d"])("design:returntype",void 0)],j.prototype,"setTransactionPay",null),j=Object(p["b"])([Object(m["b"])(),Object(p["d"])("design:paramtypes",["function"===typeof(a="undefined"!==typeof _["a"]&&_["a"])?a:Object,"function"===typeof(o="undefined"!==typeof S["a"]&&S["a"])?o:Object,"function"===typeof(s="undefined"!==typeof h["d"]&&h["d"])?s:Object,"function"===typeof(r="undefined"!==typeof b["c"]&&b["c"])?r:Object])],j);var T=n("ec41"),P=n("5c8a"),L=n("808d"),w=n("2527"),$=n("623a"),x=n("464d"),I=n("2d9d"),k={name:"ModalSoldDealSaleCabinet",bem:{sale:"modal-sold-deal-sale"},components:{EditableContractNumber:x["a"],MemberSearch:I["a"]},serviceProviders:function(){return[j]},serviceInject:function(){return{saleCabinetService:j,pattern:w["a"]}},rxState:function(){return{loading:this.saleCabinetService.loading$,saleList:this.saleCabinetService.saleList$,cabinetList:this.saleCabinetService.cabinetList$,info:this.saleCabinetService.info$,currentPrice:this.saleCabinetService.currentPrice$,orderAmountPrice:this.saleCabinetService.orderAmountPrice$}},props:{id:{type:String},areaId:{type:[String,Number],default:0},memberInfo:{type:Object}},data:function(){var e=this.$stForm.create(),t=e.decorators($["a"]);return{form:e,decorators:t,show:!1,cabinetFieldNames:{label:"name",value:"id",children:"cabinets"},cabinetId:"",disabledCalendar:!0,startTime:moment(),days:"",advanceDropdownVisible:!1,advanceList:[],advanceText:"未选择定金",advanceAmount:"",selectAdvance:"",reduceAmount:null,description:"",isFollowSalesman:0}},computed:{leaseFee:function(){return!this.cabinetId||!this.days>0?"无":"".concat(this.info.price_num*this.days,"元")},orderAmount:function(){return!this.cabinetId||!this.days>0?"无":"".concat(this.info.price_num*this.days-+this.reduceAmount-+this.advanceAmount,"元")},orderAmountText:function(){return this.orderAmount.split("元")[0]<0?"小计不能为负":""},saleRangeType:function(){return Object(T["a"])(this.info.sale_range,"type",1)},hasProductInfo:function(){return"{}"!==JSON.stringify(this.info)}},watch:{days:function(e,t){this.getOrderPrice(),this.getPrice(this.selectAdvance,+this.reduceAmount)},selectAdvance:{deep:!0,handler:function(e,t){this.getPrice(e,+this.reduceAmount)}},reduceAmount:function(e,t){this.getPrice(this.selectAdvance,+e)}},created:function(){var e=this;this.saleCabinetService.orderAmountPrice$.commit((function(){return 0})),this.saleCabinetService.currentPrice$.commit((function(){return 0})),this.saleCabinetService.init().subscribe((function(t){e.id&&e.saleCabinetService.getInfo(e.id).subscribe((function(t){setTimeout((function(){e.startTime=Object(P["a"])(moment(t.info.start_time))}))})),e.saleCabinetService.getCabinetList(e.areaId).subscribe()}))},methods:{onMemberChange:function(e){var t=this;this.resetAdvance(),e&&this.saleCabinetService.getAdvanceList(e).subscribe((function(e){t.advanceList=Object(P["a"])(e.list)}))},resetAdvance:function(){this.advanceList=[],this.advanceText="未选择定金",this.advanceAmount="",this.selectAdvance=""},onCabinetChange:function(e){this.cabinetId=e[1],this.saleCabinetService.getInfo(e[1]).subscribe()},disabledEndDate:function(e){return e.valueOf()<this.startTime.valueOf()||e.valueOf()>moment().add(999,"d").valueOf()},endTimeChange:function(e){this.form.setFieldsValue({endTimeInput:Math.ceil(e.diff(this.startTime,"minutes")/1440)}),this.days=Math.ceil(e.diff(this.startTime,"minutes")/1440)},onEndTimeInputChange:function(e){this.days=e;var t=Object(P["a"])(this.startTime);e>0?this.form.setFieldsValue({endTimePicker:t.add(e,"d")}):this.form.resetFields(["endTimePicker"])},onSelectAdvance:function(){var e=this;Object(L["a"])(200).subscribe((function(){e.advanceDropdownVisible=!1}))},onCancel:function(){this.resetAdvance()},onSelectAdvanceChange:function(e){if(!e.target.value)return this.advanceAmount=0,void(this.advanceText="未选择定金");var t=this.advanceList.filter((function(t){return t.id===e.target.value}))[0].price;this.advanceAmount=t,this.advanceText="".concat(t,"元")},getPrice:function(e,t){var n=this.form.getFieldValue("member_id");this.saleCabinetService.currentPriceAction$.dispatch({product_id:this.cabinetId,product_type:this.info.contract_type,product_num:this.days,advance_id:e||void 0,member_id:n||void 0,reduce_amount:t||void 0})},getOrderPrice:function(){this.saleCabinetService.orderAmountPriceAction$.dispatch({product_id:this.cabinetId,product_type:this.info.contract_type,product_num:this.days})},onCreateOrder:function(){var e=this;this.form.validate().then((function(t){var n=e.reduceAmount?+e.reduceAmount:0;e.saleCabinetService.setTransaction({cabinet_id:+e.cabinetId,start_time:"".concat(e.startTime.format("YYYY-MM-DD HH:mm")),end_time:"".concat(t.endTimePicker.format("YYYY-MM-DD HH:mm")),lease_days:+e.days,contract_number:e.info.contract_number,advance_id:-1===e.selectAdvance?void 0:e.selectAdvance,reduce_amount:n,order_amount:e.currentPrice,member_id:+t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,sale_id:+t.saleName,description:e.description,sale_range:+e.info.sale_range.type,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.show=!1,e.$emit("success",{type:"create",orderId:t.info.order_id})}))}))},onPay:function(){var e=this;this.form.validate().then((function(t){var n=e.reduceAmount?+e.reduceAmount:0;e.saleCabinetService.setTransactionPay({cabinet_id:+e.cabinetId,start_time:"".concat(e.startTime.format("YYYY-MM-DD HH:mm")),end_time:"".concat(t.endTimePicker.format("YYYY-MM-DD HH:mm")),lease_days:+e.days,contract_number:e.info.contract_number,advance_id:-1===e.selectAdvance?void 0:e.selectAdvance,reduce_amount:n,order_amount:e.currentPrice,member_id:+t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,sale_id:+t.saleName,description:e.description,sale_range:+e.info.sale_range.type,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.show=!1,e.$emit("success",{type:"createPay",orderId:t.info.order_id})}))}))}}},D=k,F=n("2877"),M=Object(F["a"])(D,c,d,!1,null,null,null);t["a"]=M.exports},"623a":function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var i=function(e){e.pattern;return{cabinet:{rules:[{validator:function(t,n,i){if(!n)return e.disabledCalendar=!0,"请选择租赁柜号";e.disabledCalendar=!1}}]},endTimePicker:{rules:[{required:!0,message:"请选择租赁时间"}]},endTimeInput:{rules:[{required:!0,message:"请输入租赁天数"}]},saleName:{rules:[{required:!0,message:"请选择销售人员"}]}}}},ab04:function(e,t,n){"use strict";var i,a,o,s,r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("st-modal",{attrs:{title:e.modelTitle,wrapClassName:"modal-sold-deal-sale"},on:{cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[n("div",{class:e.sale("content")},[n("st-form",{attrs:{form:e.form,labelWidth:"88px"}},[n("member-search",{class:e.sale("member"),attrs:{form:e.form,memberInfo:e.memberInfo,saleRangeType:e.saleRangeType,isSoldDeal:""},on:{select:e.onMemberChange,change:e.onMemberChange}}),n("div",{class:e.sale("sale")},[n("st-form-item",{attrs:{label:"选择卡",required:""}},[n("select-scroll",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.productId,expression:"decorators.productId"}],attrs:{placeholder:"请选择卡",notFoundContent:"无搜索结果",list:e.cardList,loading:e.loading.getMemberCardList,disabled:!!e.id},on:{load:e.handleGetList,select:e.handleSelect,search:e.handleSearch}}),e.hasProductInfo?n("a-row",{class:e.sale("info"),attrs:{type:"flex",justify:"space-between"}},[n("a-col",{attrs:{span:12}},[n("st-info",[e.info.product_type?n("st-info-item",{attrs:{label:"类型"}},[e._v("\n                  "+e._s(e.info.product_type.name)+"\n                ")]):e._e(),n("st-info-item",{attrs:{label:"允许转让"}},[e._v("\n                  "+e._s(e.info.is_transfer)+"\n                ")]),n("st-info-item",{attrs:{label:"转让手续费"}},[e._v("\n                  "+e._s(e.info.transfer_fee)+"\n                ")]),n("st-info-item",{attrs:{label:"赠送上限"}},[e._v("\n                  "+e._s(e.selectedNorm.gift_max_name)+"\n                ")]),n("st-info-item",{attrs:{label:"支持约课权益"}},[e._v("\n                  "+e._s(e.info.course_interests)+"\n                ")])],1)],1),n("a-col",{attrs:{span:11}},[n("st-info",[2===e.info.card_number_type?n("st-info-item",{attrs:{label:"支持入场人数"}},[e._v("\n                  "+e._s(e.info.support_member_num)+"\n                ")]):e._e(),e.info.sale_range?n("st-info-item",{attrs:{label:"售卖群体"}},[e._v("\n                  "+e._s(e.info.sale_range.name)+"\n                ")]):e._e(),n("st-info-item",{attrs:{label:"冻结上限"}},[e._v("\n                  "+e._s(e.selectedNorm.frozen_max_name)+"\n                ")])],1)],1)],1):e._e()],1),e.info.admission_range_info?n("assign-shop",{attrs:{label:"入场场馆",form:e.form,type:e.info.admission_range_info.admission_range,shopIds:e.info.admission_range_info.product_support_shops,required:"",disabled:e.info.auth&&!e.info.auth["shop:sold:transaction|right_price_edit"]},on:{change:e.onShopChange}}):e._e(),e.hasProductInfo?[2===e.info.card_number_type?n("st-form-item",{attrs:{label:"卡成员"}},[n("add-card-member",{attrs:{max:e.info.support_member_num-1,type:e.info.sale_range.type},model:{value:e.memberChildrenlist,callback:function(t){e.memberChildrenlist=t},expression:"memberChildrenlist"}})],1):e._e(),n("st-form-item",{attrs:{label:"规格",required:""}},[n("a-radio-group",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.specs,expression:"decorators.specs"}],on:{change:e.onChangeSpecs}},e._l(e.info.specs,(function(t,i){return n("a-radio",{key:i,attrs:{value:t}},[e._v("\n                "+e._s(t.specs_name)+"/"+e._s(t.price)+"\n              ")])})),1)],1),n("st-form-item",{attrs:{label:"开卡方式",required:""}},[n("a-radio-group",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.open_type,expression:"decorators.open_type"}],on:{change:e.onChangePayment}},e._l(e.info.open_type,(function(t,i){return n("a-radio",{key:i,attrs:{value:t}},[e._v("\n                "+e._s(t.open_type)+"\n              ")])})),1)],1),n("st-form-item",{attrs:{label:"有效时间"}},[1==e.selectedPayment.id?n("div",[e._v("\n              "+e._s(e.moment(e.validStartTime).format("YYYY-MM-DD HH:mm"))+" 至 "+e._s(e.validEndTime)+"\n            ")]):e._e(),2==e.selectedPayment.id?n("div",[e._v("\n              "+e._s(e.selectedPayment.automatic_num)+"天内未开卡，则"+e._s(e.selectedPayment.automatic_num+1)+"天0：00自动开卡\n            ")]):e._e(),3==e.selectedPayment.id?n("div",[n("a-date-picker",{attrs:{showTime:"",format:"YYYY-MM-DD HH:mm",placeholder:"请选择开始时间",disabledDate:e.disabledDate},on:{change:e.onChangeTime},model:{value:e.validStartTime,callback:function(t){e.validStartTime=t},expression:"validStartTime"}}),e._v("\n              至 "+e._s(e.validEndTime)+"\n            ")],1):e._e()])]:e._e(),n("st-form-item",{attrs:{label:"购买赠送"}},[n("st-input-number",{staticStyle:{width:"100%"},attrs:{min:0,max:e.selectedNorm.gift_max,placeholder:"请输入赠送的天数/次数"},model:{value:e.gift_amount,callback:function(t){e.gift_amount=t},expression:"gift_amount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v(e._s(e.giftUnit))])])],1),n("editable-contract-number",{attrs:{form:e.form},model:{value:e.info.contract_number,callback:function(t){e.$set(e.info,"contract_number",t)},expression:"info.contract_number"}}),n("st-form-item",{staticClass:"mg-b12",attrs:{label:"商品价格"}},[n("editable-number",{attrs:{unit:"元",disabled:e.info.auth&&!e.info.auth["shop:sold:transaction|right_price_edit"],form:e.form},on:{ok:e.onPriceChange},model:{value:e.selectedNorm.price,callback:function(t){e.$set(e.selectedNorm,"price",t)},expression:"selectedNorm.price"}})],1),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"优惠券"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.couponText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseCoupon}),attrs:{disabled:!e.canChoseCoupon,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.couponDropdownVisible,callback:function(t){e.couponDropdownVisible=t},expression:"couponDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v(e._s(e.couponList.length)+"张可用优惠券")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectCouponChange},slot:"overlay",model:{value:e.selectCoupon,callback:function(t){e.selectCoupon=t},expression:"selectCoupon"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.couponList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:t}},[e._v("\n                        "+e._s(t.name)+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"定金抵扣"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.advanceText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseAdvance}),attrs:{disabled:!e.canChoseAdvance,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.advanceDropdownVisible,callback:function(t){e.advanceDropdownVisible=t},expression:"advanceDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v("定金选择")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectAdvanceChange},slot:"overlay",model:{value:e.selectAdvance,callback:function(t){e.selectAdvance=t},expression:"selectAdvance"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.advanceList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:t.id}},[e._v("\n                        定金 "+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{attrs:{label:"减免金额"}},[n("st-input-number",{attrs:{float:!0,placeholder:"请输入"},model:{value:e.reduceAmount,callback:function(t){e.reduceAmount=t},expression:"reduceAmount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1),n("st-form-item",{staticClass:"mg-b0",attrs:{validateStatus:"error",help:e.orderAmountText,label:"小计"}},[n("span",{staticClass:"total"},[e._v(e._s(e.currentPrice)+"元")])])],2),n("div",{class:e.sale("remarks")},[n("st-form-item",{attrs:{label:"销售人员",required:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.saleName,expression:"decorators.saleName"}],attrs:{placeholder:"选择签单的工作人员"}},e._l(e.saleList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1),n("div",[n("st-checkbox",{model:{value:e.isFollowSalesman,callback:function(t){e.isFollowSalesman=t},expression:"isFollowSalesman"}},[e._v("\n              作为用户跟进销售\n            ")])],1)],1),n("st-form-item",{staticClass:"mg-b0",attrs:{label:"备注"}},[n("st-textarea",{attrs:{autosize:{minRows:4,maxRows:6},maxlength:200},model:{value:e.description,callback:function(t){e.description=t},expression:"description"}})],1)],1)],1)],1),n("template",{slot:"footer"},[n("div",{class:e.sale("footer")},[n("div",{staticClass:"price"},[n("span",[e._v(e._s(e.currentPrice)+"元")]),n("span",[e._v("订单总额："+e._s(e.selectedNorm.price)+"元")])]),n("div",{staticClass:"button"},[n("st-button",{attrs:{loading:e.loading.setTransactionOrder},on:{click:e.onCreateOrder}},[e._v("\n          创建订单\n        ")]),n("st-button",{attrs:{loading:e.loading.setTransactionPay,type:"primary"},on:{click:e.onPay}},[e._v("\n          立即支付\n        ")])],1)])])],2)},c=[],d=n("d225"),l=n("b0b4"),u=n("9ab4"),p=n("0cd5"),m=n("df29"),f=n("75ca"),_=n("c4cc"),h=n("1a2d"),b=n("d792"),v=n("f59d"),g=n("af6c"),y=n("1b92"),C=n("54da"),O=function(){function e(t,n){var i=this;Object(d["a"])(this,e),this.contractApi=t,this.transactionApi=n,this.loading$=new m["d"]({}),this.finished$=new m["d"]({}),this.page$=new m["d"]({}),this.cardList$=new m["d"]([]),this.saleList$=new m["d"]({}),this.couponList$=new m["d"]([]),this.info$=new m["d"]({}),this.currentPrice$=new m["d"]("0"),this.currentPriceAction$=new m["a"]((function(e){return e.pipe(i.debounceMap(),Object(_["a"])((function(e){i.currentPrice$.commit((function(){return e.info.price}))})))}))}return Object(l["a"])(e,[{key:"REST_COUPONLIST",value:function(){this.couponList$.commit((function(){return[]}))}},{key:"SET_LIST",value:function(e){this.cardList$.commit((function(){return e}))}},{key:"REST_INFO",value:function(){this.info$.commit((function(){return[]}))}},{key:"getMemberCardList",value:function(e){var t=this;return this.transactionApi.getTransactionList(e).pipe(Object(_["a"])((function(e){t.page$.commit((function(){return e.page})),t.finished$.commit((function(){return e.page.current_page>=e.page.total_pages})),t.cardList$.commit((function(t){return 1===e.page.current_page&&(t=[]),t.concat(e.list)}))})))}},{key:"debounceMap",value:function(){var e=this;return function(t){return t.pipe(Object(h["a"])(200),Object(b["a"])((function(t){return e.getPrice(t).pipe(Object(v["a"])((function(){return y["a"]})))})))}}},{key:"getInfo",value:function(e){var t=this;return this.transactionApi.getTransactionInfo(e,"member/card").pipe(Object(_["a"])((function(e){t.info$.commit((function(){return e.info}))})))}},{key:"getAdvanceList",value:function(e){return this.transactionApi.getTransactionAdvanceList(e)}},{key:"getSaleList",value:function(){var e=this;return this.transactionApi.getTransactionSaleList().pipe(Object(_["a"])((function(t){e.saleList$.commit((function(){return t.list}))})))}},{key:"getCouponList",value:function(e){var t=this;return this.transactionApi.getTransactionCouponList(e,"member").pipe(Object(_["a"])((function(e){t.couponList$.commit((function(){return e.list}))})))}},{key:"serviceInit",value:function(){return Object(C["a"])(this.getSaleList())}},{key:"setTransactionPay",value:function(e){return this.transactionApi.setTransaction(e,"member")}},{key:"setTransactionOrder",value:function(e){return this.transactionApi.setTransaction(e,"member")}},{key:"getPrice",value:function(e){return this.transactionApi.getTransactionPrice(e)}}]),e}();Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(i="undefined"!==typeof f["TransactionListInput"]&&f["TransactionListInput"])?i:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getMemberCardList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getAdvanceList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[]),Object(u["d"])("design:returntype",void 0)],O.prototype,"serviceInit",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionPay",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionOrder",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(a="undefined"!==typeof f["TransactionPriceInput"]&&f["TransactionPriceInput"])?a:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getPrice",null),O=Object(u["b"])([Object(p["b"])(),Object(u["d"])("design:paramtypes",["function"===typeof(o="undefined"!==typeof g["a"]&&g["a"])?o:Object,"function"===typeof(s="undefined"!==typeof f["c"]&&f["c"])?s:Object])],O);var A=n("c32d"),S=n.n(A),j=n("ec41"),T=n("5c8a"),P=n("808d"),L=n("2527"),w=function(e){e.pattern;return{specs:{},open_type:{},saleName:{rules:[{required:!0,message:"请选择销售人员"}]},productId:{initialValue:void 0,rules:[{required:!0,message:"请选择卡"}]}}},$=n("464d"),x=n("3577"),I=n("5ff9"),k=n("e69b"),D=n("2d9d"),F=n("9b2f"),M=n("7ca2"),N={name:"ModalSoldDealSaleMemberCard",bem:{sale:"modal-sold-deal-sale"},components:{EditableContractNumber:$["a"],AddCardMember:x["a"],MemberSearch:D["a"],SelectScroll:I["a"],AssignShop:F["a"],EditableNumber:M["default"]},serviceProviders:function(){return[O]},serviceInject:function(){return{saleMemberCardService:O,messageService:k["a"],pattern:L["a"]}},rxState:function(){return{page:this.saleMemberCardService.page$,loading:this.saleMemberCardService.loading$,finished:this.saleMemberCardService.finished$,info:this.saleMemberCardService.info$,cardList:this.saleMemberCardService.cardList$,saleList:this.saleMemberCardService.saleList$,couponList:this.saleMemberCardService.couponList$,currentPrice:this.saleMemberCardService.currentPrice$}},props:{id:{type:String,description:"会员卡id"},memberInfo:{type:Object}},data:function(){var e=this.$stForm.create(),t=e.decorators(w);return{form:e,decorators:t,show:!1,memberChildrenSearchText:"",searchMemberChildrenIsShow:!0,advanceDropdownVisible:!1,advanceList:[],advanceText:"未选择定金",advanceAmount:"",selectAdvance:"",reduceAmount:null,description:"",selectCoupon:"",couponText:"未选择优惠券",couponAmount:"",couponDropdownVisible:!1,selectedNorm:"",selectedPayment:"",validStartTime:S()(),validEndTime:"",gift_amount:0,memberChildrenlist:[],product_id:"",isFollowSalesman:0,product_name:""}},computed:{modelTitle:function(){return this.$c("member_card")+"签单"},canChoseAdvance:function(){var e=this.advanceList.length;return(this.id||this.product_id)&&e},canChoseCoupon:function(){var e=this.couponList.length;return!!e},orderAmountText:function(){return this.currentPrice<0?"小计不能为负":""},giftUnit:function(){var e="天";return this.info.product_type&&1===this.info.product_type.id&&(e="次"),e},saleRangeType:function(){return Object(j["a"])(this.info.sale_range,"type",1)},hasProductInfo:function(){return"{}"!==JSON.stringify(this.info)}},watch:{selectCoupon:{deep:!0,handler:function(e,t){this.getPrice(e,this.selectAdvance,+this.reduceAmount)}},selectAdvance:{deep:!0,handler:function(e,t){this.getPrice(this.selectCoupon,e,+this.reduceAmount)}},reduceAmount:function(e,t){this.getPrice(this.selectCoupon,this.selectAdvance,+e)}},mounted:function(){var e=this;this.saleMemberCardService.serviceInit().subscribe((function(t){e.id?e.handleGetMemberCardInfo(e.id):e.saleMemberCardService.getMemberCardList({app_brand_id:e.$searchQuery.app_brand_id,app_shop_id:e.$searchQuery.app_shop_id,product_type:1}).subscribe()}))},methods:{moment:S.a,handleSelect:function(e){this.product_id=e,this.onResetDiscounts(),this.handleGetMemberCardInfo(e)},handleSearch:function(e){this.product_name=e,this.saleMemberCardService.getMemberCardList({product_name:e,current_page:1,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:1}).subscribe()},onChangeSpecs:function(e){this.selectedNorm=e.target.value,this.fetchCouponList(),this.gift_amount="",this.getPrice(this.selectCoupon,this.selectAdvance,+this.reduceAmount),this.validEndTime=S()(this.validStartTime).add(e.target.value.valid_time,"days").format("YYYY-MM-DD HH:mm")},onChangePayment:function(e){this.selectedPayment=e.target.value,2!==this.selectedPayment.id&&(this.validStartTime=S()(),this.validEndTime=S()().add(this.selectedNorm.valid_time,"days").format("YYYY-MM-DD HH:mm")),this.fetchCouponList()},onChangeTime:function(e){e&&(this.validEndTime=S()(e._d).add(this.selectedNorm.valid_time,"days").format("YYYY-MM-DD HH:mm"))},onResetDiscounts:function(){this.resetCoupon(),this.resetAdvance()},onReGetDiscounts:function(e){this.fetchAdvanceList(e),this.fetchCouponList(e)},onMemberChange:function(e){this.onResetDiscounts(),e&&this.onReGetDiscounts(e)},onSelectAdvance:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.advanceDropdownVisible=!1}))},onSelectCoupon:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.couponDropdownVisible=!1}))},resetAdvance:function(){this.advanceList=[],this.advanceText="未选择定金",this.selectAdvance="",this.advanceAmount=""},resetCoupon:function(){this.couponText="未选择优惠券",this.selectCoupon="",this.couponAmount="",this.saleMemberCardService.REST_COUPONLIST()},onCancel:function(){this.onResetDiscounts()},onSelectAdvanceChange:function(e){if(!e.target.value)return this.advanceAmount=0,void(this.advanceText="未选择定金");var t=this.advanceList.filter((function(t){return t.id===e.target.value}))[0].price;this.advanceAmount=t,this.advanceText="".concat(t,"元")},onSelectCouponChange:function(e){var t=Object(j["a"])(e.target.value,"id","");if(t){var n=this.couponList.filter((function(e){return e.id===t}))[0].price;this.couponAmount=n,this.couponText="".concat(n,"元")}else this.couponText="未选择优惠券",this.couponAmount=0},getPrice:function(e,t,n){var i=this.form.getFieldValue("member_id"),a=this.form.getFieldValue("productId")||void 0;this.saleMemberCardService.currentPriceAction$.dispatch({product_id:a,product_type:this.info.contract_type,coupon_id:e?e.id:void 0,member_id:i||void 0,advance_id:t||void 0,reduce_amount:n||void 0,transaction_price:this.selectedNorm.price,specs_id:this.selectedNorm.id})},onPriceChange:function(){this.reduceAmount="",this.onResetDiscounts(),this.onReGetDiscounts(),this.getPrice(this.selectCoupon,this.selectAdvance,this.reduceAmount)},onCreateOrder:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0,i=e.info.admission_range_info,a=i.admission_range,o=i.product_support_shops;e.saleMemberCardService.setTransactionOrder({member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,product_id:n,contract_number:e.info.contract_number,admission_range:a,sold_product_support_shops:o,transaction_amount:e.selectedNorm.price,specs_id:t.specs.id,open_card_type:t.open_type.id,valid_start_time:S()(e.validStartTime).format("YYYY-MM-DD HH:mm"),coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,gift_amount:e.gift_amount||0,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,sale_range:e.info.sale_range.type,order_amount:e.currentPrice,family_member_ids:e.memberChildrenlist.filter((function(e){return!!e.id})).map((function(e){return e.id})),family_member_info:e.memberChildrenlist.filter((function(e){return!e.id})),is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.$emit("success",{type:"create",orderId:t.info.order_id}),e.show=!1}))}))},onPay:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0,i=e.info.admission_range_info,a=i.admission_range,o=i.product_support_shops;e.saleMemberCardService.setTransactionPay({member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,product_id:n,contract_number:e.info.contract_number,admission_range:a,sold_product_support_shops:o,transaction_amount:e.selectedNorm.price,specs_id:t.specs.id,open_card_type:t.open_type.id,valid_start_time:S()(e.validStartTime).format("YYYY-MM-DD HH:mm"),coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,gift_amount:e.gift_amount||0,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,sale_range:e.info.sale_range.type,order_amount:e.currentPrice,family_member_ids:e.memberChildrenlist.filter((function(e){return!!e.id})).map((function(e){return e.id})),family_member_info:e.memberChildrenlist.filter((function(e){return!e.id})),is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.$emit("success",{type:"createPay",orderId:t.info.order_id}),e.show=!1}))}))},handleGetList:function(e){if(this.finished)return!1;this.saleMemberCardService.getMemberCardList({product_name:this.product_name,current_page:++this.page.current_page,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:1}).subscribe()},handleGetMemberCardInfo:function(e){var t=this;this.saleMemberCardService.getInfo(e).subscribe((function(n){t.id&&t.saleMemberCardService.SET_LIST([{id:+t.id,product_name:t.info.product_name}]),setTimeout((function(){t.selectedNorm=t.info.specs[0],t.selectedPayment=t.info.open_type[0],t.form.setFieldsValue({productId:+e,specs:t.selectedNorm,open_type:t.selectedPayment}),t.validStartTime=S()(),t.validEndTime=S()().add(t.selectedNorm.valid_time,"days").format("YYYY-MM-DD HH:mm"),t.onReGetDiscounts(),t.getPrice()}))}))},fetchCouponList:function(e){var t=this.info.id,n=this.selectedNorm.id,i=this.form.getFieldValue("member_id")||e,a=this.selectedNorm.price;if(this.selectedNorm&&this.selectedPayment&&t&&i){var o={member_id:i,card_id:t,specs_id:n,transaction_price:a};this.saleMemberCardService.getCouponList(o).subscribe()}},fetchAdvanceList:function(e){var t=this,n=this.form.getFieldValue("member_id")||e;n&&this.saleMemberCardService.getAdvanceList(n).subscribe((function(e){t.advanceList=Object(T["a"])(e.list)}))},onShopChange:function(e,t){this.info.admission_range_info.admission_range=e,this.info.admission_range_info.product_support_shops=t},disabledDate:function(e){return e&&e<S()().subtract(90,"days")}}},V=N,R=n("2877"),E=Object(R["a"])(V,r,c,!1,null,null,null);t["a"]=E.exports},acee:function(e,t,n){"use strict";var i,a,o,s,r=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("st-modal",{attrs:{title:"私教课签单",size:"small",wrapClassName:"modal-sold-deal-sale"},on:{cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[n("div",{class:e.sale("content")},[n("st-form",{attrs:{form:e.form,labelWidth:"88px"}},[n("member-search",{class:e.sale("member"),attrs:{form:e.form,memberInfo:e.memberInfo,saleRangeType:e.saleRangeType,isSoldDeal:""},on:{select:e.onMemberChange,change:e.onMemberChange}}),n("div",{class:e.sale("sale")},[n("st-form-item",{attrs:{label:"选择课",required:""}},[n("select-scroll",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.productId,expression:"decorators.productId"}],staticStyle:{width:"316px"},attrs:{placeholder:"请选择课",notFoundContent:"无搜索结果",list:e.courseList,loading:e.loading.getPresonalCourseList,disabled:!!e.id},on:{load:e.handleGetList,select:e.handleSelect,search:e.handleSearch}}),e.hasProductInfo?n("a-row",{class:e.sale("info"),attrs:{type:"flex",justify:"space-between"}},[n("a-col",{attrs:{span:12}},[n("st-info",[e.info.sale_range?n("st-info-item",{attrs:{label:"售卖群体"}},[e._v("\n                  "+e._s(e.info.sale_range.name)+"\n                ")]):e._e()],1)],1),n("a-col",{attrs:{span:11}},[n("st-info",[n("st-info-item",{attrs:{label:"时长"}},[e._v(e._s(e.info.duration))])],1)],1)],1):e._e()],1),e.hasProductInfo&&2===e.info.price_model?n("st-form-item",{attrs:{label:"规格",required:""}},[n("a-radio-group",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.coach_level,expression:"decorators.coach_level"}],on:{change:e.changeSpeics}},e._l(e.info.coach_level,(function(t,i){return n("a-radio",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.name)+"\n            ")])})),1)],1):e._e(),n("st-form-item",{attrs:{required:""}},[n("template",{slot:"label"},[e._v("\n            购买数量\n            "),n("st-help-tooltip",{attrs:{id:"TSSD002"}})],1),n("div",{class:e.sale("contract")},[n("a-input-number",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.buyNum,expression:"decorators.buyNum"}],staticClass:"input-number",attrs:{min:1,max:9999,placeholder:"请输入购买数量",disabled:e.isAmountDisabled}}),e.isAmountDisabled?n("st-button",{staticClass:"create-button",on:{click:e.onClickCourseEdit}},[e._v("\n              编辑\n            ")]):n("st-button",{staticClass:"create-button",attrs:{loading:e.loading.getPersonalPriceInfo},on:{click:e.onClickCourseAmount}},[e._v("\n              确定\n            ")])],1)],2),1===e.info.sale_model?n("st-form-item",{attrs:{label:"单节价格",required:""}},[n("st-input-number",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.coursePrice,expression:"decorators.coursePrice"}],attrs:{min:+e.personalPrice.min_sell_price||0,max:+e.personalPrice.max_sell_price||0,float:!0,placeholder:"请输入课程的价格"},on:{blur:function(t){e.fetchCouponList(),e.getOrderPrice(),e.getPrice(null,null,null)}}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1):e._e(),2===e.info.sale_model?n("st-form-item",{attrs:{label:"单节价格"}},[n("div",[e._v(e._s(e.personalPrice.sell_price||0)+"元/节")])]):e._e(),1===e.info.sale_model?n("st-form-item",{attrs:{label:"价格区间"}},[n("div",[e._v("\n            "+e._s(e.personalPrice.min_sell_price||0)+"元/节 ~\n            "+e._s(e.personalPrice.max_sell_price||0)+"元/节\n          ")])]):e._e(),n("st-form-item",{attrs:{label:"到期时间"}},[e.isEditExpiredTime?n("div",[n("a-date-picker",{attrs:{disabledDate:e.disabledDate,placeholder:"到期时间"},model:{value:e.validEndTime,callback:function(t){e.validEndTime=t},expression:"validEndTime"}}),n("st-button",{staticClass:"mg-l8",on:{click:e.onClickTimeEdit}},[e._v("确定")])],1):n("div",[e._v("\n            "+e._s(e.validEndTime.format("YYYY-MM-DD"))+"\n            "),n("st-button",{staticClass:"mg-l8",on:{click:e.onClickTimeEdit}},[e._v("编辑")])],1)]),n("editable-contract-number",{attrs:{form:e.form},model:{value:e.info.contract_number,callback:function(t){e.$set(e.info,"contract_number",t)},expression:"info.contract_number"}}),n("st-form-item",{attrs:{label:"选择"+e.$c("coach"),required:""}},[n("a-radio-group",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.coach_type,expression:"decorators.coach_type"}],attrs:{options:e.coachTypeOptions},on:{change:e.onCoachTypeChange}})],1),e.isSupportSelectCoach?n("st-form-item",{attrs:{labelFix:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.coach_ids,expression:"decorators.coach_ids"}],attrs:{placeholder:"选择"+e.$c("coach"),mode:"multiple"}},e._l(e.coachList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1)],1):e._e(),n("st-form-item",{attrs:{label:"购买赠送"}},[n("st-input-number",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.gift_course_num,expression:"decorators.gift_course_num"}],attrs:{placeholder:"请输入赠送的上课节数"}})],1),n("st-form-item",{staticClass:"mg-b12",attrs:{label:"商品价格"}},[e._v("\n          "+e._s(e.orderAmountPrice)+"元\n        ")]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"优惠券"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.couponText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseCoupon}),attrs:{disabled:!e.canChoseCoupon,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.couponDropdownVisible,callback:function(t){e.couponDropdownVisible=t},expression:"couponDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v(e._s(e.couponList.length)+"张可用优惠券")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectCouponChange},slot:"overlay",model:{value:e.selectCoupon,callback:function(t){e.selectCoupon=t},expression:"selectCoupon"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.couponList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:t}},[e._v("\n                        "+e._s(t.name)+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"定金抵扣"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.advanceText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseAdvance}),attrs:{disabled:!e.canChoseAdvance,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.advanceDropdownVisible,callback:function(t){e.advanceDropdownVisible=t},expression:"advanceDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v("定金选择")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectAdvanceChange},slot:"overlay",model:{value:e.selectAdvance,callback:function(t){e.selectAdvance=t},expression:"selectAdvance"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.advanceList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:t.id}},[e._v("\n                        定金 "+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{attrs:{label:"减免金额"}},[n("st-input-number",{attrs:{float:!0,placeholder:"请输入"},model:{value:e.reduceAmount,callback:function(t){e.reduceAmount=t},expression:"reduceAmount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1),n("st-form-item",{staticClass:"mg-b0",attrs:{validateStatus:"error",help:e.orderAmountText,label:"小计"}},[n("span",{staticClass:"total"},[e._v(e._s(e.priceInfo)+"元")])])],1),n("div",{class:e.sale("remarks")},[n("st-form-item",{attrs:{label:"销售人员",required:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.saleName,expression:"decorators.saleName"}],attrs:{placeholder:"选择签单的工作人员"}},e._l(e.saleList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1),n("div",[n("st-checkbox",{model:{value:e.isFollowSalesman,callback:function(t){e.isFollowSalesman=t},expression:"isFollowSalesman"}},[e._v("\n              作为用户跟进销售\n            ")])],1)],1),n("st-form-item",{staticClass:"mg-b0",attrs:{label:"备注"}},[n("st-textarea",{attrs:{autosize:{minRows:4,maxRows:6},maxlength:200},model:{value:e.description,callback:function(t){e.description=t},expression:"description"}})],1)],1)],1)],1),n("template",{slot:"footer"},[n("div",{class:e.sale("footer")},[n("div",{staticClass:"price"},[n("span",[e._v(e._s(e.priceInfo)+"元")]),n("span",[e._v("订单总额："+e._s(e.orderAmountPrice)+"元")])]),n("div",{staticClass:"button"},[n("st-button",{attrs:{loading:e.loading.setTransactionOrder},on:{click:e.onCreateOrder}},[e._v("\n          创建订单\n        ")]),n("st-button",{attrs:{loading:e.loading.setTransactionPay,type:"primary"},on:{click:e.onPay}},[e._v("\n          立即支付\n        ")])],1)])])],2)},c=[],d=n("d225"),l=n("b0b4"),u=n("9ab4"),p=n("0cd5"),m=n("df29"),f=n("75ca"),_=n("1b92"),h=n("54da"),b=n("c4cc"),v=n("1a2d"),g=n("d792"),y=n("f59d"),C=n("2138"),O=function(){function e(t,n){var i=this;Object(d["a"])(this,e),this.transactionApi=t,this.userService=n,this.loading$=new m["d"]({}),this.finished$=new m["d"]({}),this.page$=new m["d"]({}),this.info$=new m["d"]({}),this.priceInfo$=new m["d"]("0"),this.orderAmountPrice$=new m["d"]("0"),this.courseList$=new m["d"]([]),this.saleList$=new m["d"]({}),this.couponList$=new m["d"]([]),this.coachList$=new m["d"]({}),this.personalPrice$=new m["d"]({}),this.coachTypeOptions$=this.userService.getOptions$("personal_course.coach_type"),this.priceAction$=new m["a"]((function(e){return e.pipe(i.debounceMap(),Object(b["a"])((function(e){i.priceInfo$.commit((function(){return e.info.price}))})))})),this.orderAmountPriceAction$=new m["a"]((function(e){return e.pipe(i.debounceMap(),Object(b["a"])((function(e){i.orderAmountPrice$.commit((function(){return e.info.price}))})))}))}return Object(l["a"])(e,[{key:"REST_COUPONLIST",value:function(){this.couponList$.commit((function(){return[]}))}},{key:"SET_LIST",value:function(e){this.courseList$.commit((function(){return e}))}},{key:"getPresonalCourseList",value:function(e){var t=this;return this.transactionApi.getTransactionList(e).pipe(Object(b["a"])((function(e){t.page$.commit((function(){return e.page})),t.finished$.commit((function(){return e.page.current_page>=e.page.total_pages})),t.courseList$.commit((function(t){return 1===e.page.current_page&&(t=[]),t.concat(e.list)}))})))}},{key:"debounceMap",value:function(){var e=this;return function(t){return t.pipe(Object(v["a"])(200),Object(g["a"])((function(t){return e.getPrice(t).pipe(Object(y["a"])((function(){return _["a"]})))})))}}},{key:"getInfo",value:function(e){var t=this;return this.transactionApi.getTransactionInfo(e,"personal/course").pipe(Object(b["a"])((function(e){t.info$.commit((function(){return e.info}))})))}},{key:"getAdvanceList",value:function(e){return this.transactionApi.getTransactionAdvanceList(e)}},{key:"getSaleList",value:function(){var e=this;return this.transactionApi.getTransactionSaleList().pipe(Object(b["a"])((function(t){e.saleList$.commit((function(){return t.list}))})))}},{key:"getCouponList",value:function(e){var t=this;return this.transactionApi.getTransactionCouponList(e,"personal").pipe(Object(b["a"])((function(e){t.couponList$.commit((function(){return e.list}))})))}},{key:"getCoachList",value:function(e,t){var n=this;return this.transactionApi.getTransactionCoachList(e,t).pipe(Object(b["a"])((function(e){n.coachList$.commit((function(){return e.list}))})))}},{key:"getPersonalPriceInfo",value:function(e){var t=this;return this.transactionApi.getPersonalCoursePrice(e).pipe(Object(b["a"])((function(e){t.personalPrice$.commit((function(){return e.info}))})))}},{key:"serviceInit",value:function(){return Object(h["a"])(this.getSaleList())}},{key:"setTransactionOrder",value:function(e){return this.transactionApi.setTransaction(e,"personal")}},{key:"setTransactionPay",value:function(e){return this.transactionApi.setTransaction(e,"personal")}},{key:"getPrice",value:function(e){return this.transactionApi.getTransactionPrice(e)}}]),e}();Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(i="undefined"!==typeof f["TransactionListInput"]&&f["TransactionListInput"])?i:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getPresonalCourseList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getAdvanceList",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getPersonalPriceInfo",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[]),Object(u["d"])("design:returntype",void 0)],O.prototype,"serviceInit",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionOrder",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",[Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"setTransactionPay",null),Object(u["b"])([Object(m["c"])(),Object(u["d"])("design:type",Function),Object(u["d"])("design:paramtypes",["function"===typeof(a="undefined"!==typeof f["TransactionPriceInput"]&&f["TransactionPriceInput"])?a:Object]),Object(u["d"])("design:returntype",void 0)],O.prototype,"getPrice",null),O=Object(u["b"])([Object(p["b"])(),Object(u["d"])("design:paramtypes",["function"===typeof(o="undefined"!==typeof f["c"]&&f["c"])?o:Object,"function"===typeof(s="undefined"!==typeof C["a"]&&C["a"])?s:Object])],O);var A=n("c32d"),S=n.n(A),j=n("ec41"),T=n("5c8a"),P=n("808d"),L=n("2527"),w=function(e){e.pattern;return{coach_level:{rules:[{required:!0,message:"请选择".concat(e.$c("coach"),"等级")}]},buyNum:{rules:[{validator:function(t,n,i){var a=0;return a=1===e.info.price_model?e.personalPrice.min_sell:e.minPrice,n?n<a?"不能少于课程定价的最低购买节数".concat(a):e.isAmountDisabled?void 0:"购买数量未确认，请点击确定":"请输入购买数量"}}]},coach_type:{},coach_ids:{rules:[{required:!0,message:"请选择上课".concat(e.$c("coach"))}]},gift_course_num:{},coursePrice:{rules:[{required:!0,message:"请输入课程的单价"}]},saleName:{rules:[{required:!0,message:"请选择销售人员"}]},productId:{initialValue:void 0,rules:[{required:!0,message:"请选择课"}]}}},$=n("464d"),x=n("2d9d"),I=n("5ff9"),k={_defaultOpts:{baseDate:new Date,limit:{num:5,unit:"years"}},_calc:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"add";n=Object.assign(this._defaultOpts,n),e=+e||0;var a=n,o=a.baseDate,s=a.limit,r="add"===i?"min":"max",c=S()(o)[i](e,t);return+c||(c=S()()),S()(Math[r](c,S()(o)[i](s.num,s.unit)))},add:function(e,t,n){return this._calc(e,t,n,"add")},subtract:function(e,t,n){return this._calc(e,t,n,"subtract")}},D={name:"ModalSoldDealSaleMemberCard",bem:{sale:"modal-sold-deal-sale"},components:{EditableContractNumber:$["a"],MemberSearch:x["a"],SelectScroll:I["a"]},serviceProviders:function(){return[O]},serviceInject:function(){return{salePersonalCourseService:O,pattern:L["a"]}},rxState:function(){return{loading:this.salePersonalCourseService.loading$,finished:this.salePersonalCourseService.finished$,page:this.salePersonalCourseService.page$,info:this.salePersonalCourseService.info$,courseList:this.salePersonalCourseService.courseList$,saleList:this.salePersonalCourseService.saleList$,couponList:this.salePersonalCourseService.couponList$,coachList:this.salePersonalCourseService.coachList$,personalPrice:this.salePersonalCourseService.personalPrice$,priceInfo:this.salePersonalCourseService.priceInfo$,orderAmountPrice:this.salePersonalCourseService.orderAmountPrice$,coachTypeOptions:this.salePersonalCourseService.coachTypeOptions$}},props:{id:{type:String},memberInfo:{type:Object}},data:function(){var e=this.$stForm.create(),t=e.decorators(w);return{form:e,decorators:t,show:!1,isAmountDisabled:!1,minPrice:0,validEndTime:S()(),advanceDropdownVisible:!1,advanceList:[],advanceText:"未选择定金",advanceAmount:"",selectAdvance:"",reduceAmount:null,description:"",selectCoupon:"",couponText:"未选择优惠券",couponAmount:"",couponDropdownVisible:!1,isAmountStateTip:"",isEditExpiredTime:!1,product_id:"",isFollowSalesman:0,product_name:"",coach_type:1}},computed:{canChoseCoupon:function(){var e=this.couponList.length;return!!e},canChoseAdvance:function(){var e=this.advanceList.length;return(this.id||this.product_id)&&e},orderPersonalType:function(){var e=1;return 1===this.info.price_model&&1===this.info.sale_model?e=1:1===this.info.price_model&&2===this.info.sale_model?e=2:2===this.info.price_model&&1===this.info.sale_model?e=3:2===this.info.price_model&&2===this.info.sale_model&&(e=4),e},orderAmountText:function(){return this.priceInfo<0?"小计不能为负":""},saleRangeType:function(){return Object(j["a"])(this.info.sale_range,"type",1)},hasProductInfo:function(){return"{}"!==JSON.stringify(this.info)},isSupportSelectCoach:function(){return 1===this.coach_type}},watch:{selectCoupon:{deep:!0,handler:function(e,t){this.getPrice(e,this.selectAdvance,+this.reduceAmount)}},selectAdvance:{deep:!0,handler:function(e,t){this.getPrice(this.selectCoupon,e,+this.reduceAmount)}},reduceAmount:function(e,t){this.getPrice(this.selectCoupon,this.selectAdvance,+e)}},mounted:function(){var e=this;this.salePersonalCourseService.serviceInit().subscribe((function(t){e.id?e.handleGetPersonalCourseInfo(e.id):e.salePersonalCourseService.getPresonalCourseList({app_brand_id:e.$searchQuery.app_brand_id,app_shop_id:e.$searchQuery.app_shop_id,product_type:3}).subscribe()})),this.initFieldsValue()},methods:{moment:S.a,onResetDiscounts:function(){this.resetCoupon(),this.resetAdvance()},onReGetDiscounts:function(e){this.fetchAdvanceList(e),this.fetchCouponList(e)},onMemberChange:function(e){this.onResetDiscounts(),e&&this.onReGetDiscounts(e)},handleSelect:function(e){this.product_id=e,this.onResetDiscounts(),this.handleGetPersonalCourseInfo(e)},handleSearch:function(e){this.product_name=e,this.salePersonalCourseService.getPresonalCourseList({product_name:e,current_page:1,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:3}).subscribe()},changeSpeics:function(e){this.isAmountDisabled=!1,this.resetOrderInfo();var t=this.info.coach_level.filter((function(t){return t.id===e.target.value}));this.minPrice=t[0].min_sell;var n=this.form.getFieldValue("productId")||void 0;this.salePersonalCourseService.getCoachList(t[0].id,n).subscribe()},resetOrderInfo:function(){this.form.resetFields(["buyNum","coach_ids","coursePrice","gift_course_num"]),this.personalPrice.sell_price=0,this.personalPrice.min_sell_price=0,this.personalPrice.max_sell_price=0,this.validEndTime=S()(),this.priceInfo=0,this.orderAmountPrice=0,this.reduceAmount=0,this.selectAdvance="",this.selectCoupon="",this.couponList=[]},onSelectAdvance:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.advanceDropdownVisible=!1}))},onSelectCoupon:function(){var e=this;Object(P["a"])(200).subscribe((function(){e.couponDropdownVisible=!1}))},resetAdvance:function(){this.advanceList=[],this.advanceText="未选择定金",this.selectAdvance="",this.advanceAmount=""},resetCoupon:function(){this.salePersonalCourseService.REST_COUPONLIST(),this.couponText="未选择优惠券",this.selectCoupon="",this.couponAmount=""},onCancel:function(){this.onResetDiscounts()},onSelectAdvanceChange:function(e){if(!e.target.value)return this.advanceAmount=0,void(this.advanceText="未选择定金");var t=this.advanceList.filter((function(t){return t.id===e.target.value}))[0].price;this.advanceAmount=t,this.advanceText="".concat(t,"元")},onSelectCouponChange:function(e){var t=Object(j["a"])(e.target.value,"id","");if(t){var n=this.couponList.filter((function(e){return e.id===t}))[0].price;this.couponAmount=n,this.couponText="".concat(n,"元")}else this.couponText="未选择优惠券",this.couponAmount=0},onClickCourseAmount:function(){var e=this,t=this.form.getFieldValue("productId")||void 0,n={id:t,buy_num:this.form.getFieldValue("buyNum"),coach_level_id:this.form.getFieldValue("coach_level")||0};this.salePersonalCourseService.getPersonalPriceInfo(n).subscribe((function(t){e.isAmountDisabled=!0,e.form.setFieldsValue({buyNum:n.buy_num});var i=e.info.effective_unit*n.buy_num||0;e.validEndTime=k.add(i,"days"),e.fetchCouponList(),(1!==e.info.sale_model||e.form.getFieldValue("coursePrice")||0===e.form.getFieldValue("coursePrice"))&&(e.getOrderPrice(),e.getPrice(e.selectCoupon,e.selectAdvance,+e.reduceAmount))}))},onClickCourseEdit:function(){var e=this.form.getFieldValue("buyNum");this.isAmountDisabled=!1,this.form.setFieldsValue({buyNum:e}),this.form.validate(["buyNum"])},onClickTimeEdit:function(){this.isEditExpiredTime=!this.isEditExpiredTime},getPrice:function(e,t,n){var i=-1===t?"":t,a=this.personalPrice.sell_price;if(1===this.info.sale_model&&(a=this.form.getFieldValue("coursePrice")),a){var o=this.form.getFieldValue("member_id"),s=this.form.getFieldValue("productId");this.salePersonalCourseService.priceAction$.dispatch({product_id:s||void 0,product_type:this.info.contract_type,product_num:this.form.getFieldValue("buyNum"),specs_id:this.form.getFieldValue("coach_level"),coupon_id:e?e.id:void 0,member_id:o||void 0,advance_id:i,reduce_amount:n,special_amount:+a||0})}},getOrderPrice:function(){var e=this.personalPrice.sell_price;if(1!==this.info.sale_model||(e=this.form.getFieldValue("coursePrice"),e)){var t=this.form.getFieldValue("productId")||void 0;this.salePersonalCourseService.orderAmountPriceAction$.dispatch({product_id:t,product_type:this.info.contract_type,product_num:this.form.getFieldValue("buyNum"),specs_id:this.form.getFieldValue("coach_level"),special_amount:+e||0})}},onCreateOrder:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0;e.salePersonalCourseService.setTransactionOrder({member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,course_id:n,contract_number:e.info.contract_number,buy_num:t.buyNum,course_price:2===e.info.sale_model?e.personalPrice.sell_price:t.coursePrice,coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,gift_course_num:t.gift_course_num||0,coach_type:t.coach_type,coach_ids:t.coach_ids,coach_level_id:t.coach_level,sale_range:e.info.sale_range.type,order_amount:e.priceInfo,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman,end_time:e.validEndTime.format("YYYY-MM-DD")}).subscribe((function(t){e.$emit("success",{type:"create",orderId:t.info.order_id}),e.show=!1}))}))},onPay:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0;e.salePersonalCourseService.setTransactionPay({member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,course_id:n,contract_number:e.info.contract_number,buy_num:t.buyNum,course_price:2===e.info.sale_model?e.personalPrice.sell_price:t.coursePrice,coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,gift_course_num:t.gift_course_num||0,coach_type:t.coach_type,coach_ids:t.coach_ids,coach_level_id:t.coach_level,sale_range:e.info.sale_range.type,order_amount:e.priceInfo,is_minors:t.is_minors,parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman,end_time:e.validEndTime.format("YYYY-MM-DD")}).subscribe((function(t){e.$emit("success",{type:"createPay",orderId:t.info.order_id}),e.show=!1}))}))},disabledDate:function(e){return e&&(e<S()().add(-1,"day")||e>S()().add(5,"years"))},fetchCouponList:function(e){var t=this.form.getFieldValue("member_id")||e,n=this.personalPrice.sell_price,i=this.form.getFieldValue("buyNum"),a=this.form.getFieldValue("productId")||void 0;if(a&&t){var o={member_id:t,course_id:a,price:n,buy_num:i};this.salePersonalCourseService.getCouponList(o).subscribe()}},fetchAdvanceList:function(e){var t=this,n=this.form.getFieldValue("member_id")||e;n&&this.salePersonalCourseService.getAdvanceList(n).subscribe((function(e){t.advanceList=Object(T["a"])(e.list)}))},handleGetList:function(){if(this.finished)return!1;this.salePersonalCourseService.getPresonalCourseList({product_name:this.product_name,current_page:++this.page.current_page,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:3}).subscribe()},handleGetPersonalCourseInfo:function(e){var t=this;this.salePersonalCourseService.getInfo(e).subscribe((function(n){t.id&&t.salePersonalCourseService.SET_LIST([{id:+t.id,product_name:t.info.product_name}]),setTimeout((function(){t.form.setFieldsValue({productId:+e}),t.info.coach_level&&t.info.coach_level.length>0&&(t.form.setFieldsValue({coach_level:t.info.coach_level[0].id}),t.minPrice=t.info.coach_level[0].min_sell);var n=0;2===t.info.price_model&&(n=t.info.coach_level[0].id),t.onReGetDiscounts(),t.salePersonalCourseService.getCoachList(n,e).subscribe()}))}))},initFieldsValue:function(){var e=this.coach_type;this.form.setFieldsValue({coach_type:e})},onCoachTypeChange:function(e){this.coach_type=e.target.value}}},F=D,M=n("2877"),N=Object(M["a"])(F,r,c,!1,null,null,null);t["a"]=N.exports},d5cb:function(e,t,n){"use strict";var i,a,o,s,r,c=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("st-modal",{attrs:{title:"课程包签单",width:"880px",wrapClassName:"modal-sold-deal-sale"},on:{cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:"show"}},[n("div",{class:e.sale("content")},[n("st-form",{attrs:{form:e.form,labelWidth:"88px"}},[n("member-search",{class:e.sale("member"),attrs:{form:e.form,memberInfo:e.memberInfo,saleRangeType:e.saleRangeType,isSoldDeal:""},on:{select:e.onMemberChange,change:e.onMemberChange}}),n("div",{class:e.sale("sale")},[n("st-form-item",{attrs:{label:"选择课",required:""}},[n("select-scroll",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.productId,expression:"decorators.productId"}],attrs:{placeholder:"请选择课",notFoundContent:"无搜索结果",list:e.courseList,loading:e.loading.getCourseList,disabled:!!e.id},on:{load:e.handleGetList,select:e.handleSelect,search:e.handleSearch}}),e.hasProductInfo?n("a-row",{class:e.sale("info"),attrs:{type:"flex",justify:"space-between"}},[n("a-col",{attrs:{span:12}},[n("st-info",[n("st-info-item",{attrs:{label:"允许转让"}},[e._v("\n                  "+e._s(e.info.is_transfer)+"\n                ")]),n("st-info-item",{attrs:{label:"转让手续费"}},[e._v("\n                  "+e._s(e.info.transfer_fee)+"\n                ")]),n("st-info-item",{attrs:{label:"有效期"}},[e._v("\n                  "+e._s(e.info.valid_time)+"天\n                ")]),e.info.max_use_num>1?n("st-info-item",{attrs:{label:"支持使用人数"}},[e._v("\n                  "+e._s(e.info.max_use_num)+"人\n                ")]):e._e()],1)],1),n("a-col",{attrs:{span:11}},[n("st-info",[e.info.sale_range?n("st-info-item",{attrs:{label:"售卖群体"}},[e._v("\n                  "+e._s(e.info.sale_range.name)+"\n                ")]):e._e(),n("st-info-item",{attrs:{label:"上课门店"}},[n("st-overflow-text",{attrs:{"max-width":"200px",needMaxContainerWidth:"",value:e.info.shop_name}})],1),n("st-info-item",{attrs:{label:"上课范围"}},[e._v("\n                  "+e._s(e.info.course_range)+"\n                ")])],1)],1)],1):e._e()],1),e.info.max_use_num>1?n("st-form-item",{attrs:{label:"成员"}},[n("add-card-member",{attrs:{addText:"新增成员",max:e.info.max_use_num-1,productType:"package"},model:{value:e.memberChildrenlist,callback:function(t){e.memberChildrenlist=t},expression:"memberChildrenlist"}})],1):e._e(),n("st-form-item",{attrs:{label:"生效方式",required:""}},[n("a-radio-group",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.effective_way,expression:"decorators.effective_way"}],attrs:{options:e.effectiveWayOptions},on:{change:e.onChangeEffectiveWay}})],1),1===e.isExpire?n("st-form-item",{attrs:{label:"到期时间"}},[n("div",[e._v("\n            "+e._s(e.moment().add(e.info.valid_time,"days").format("YYYY-MM-DD HH:mm"))+"\n          ")])]):e._e(),n("editable-contract-number",{attrs:{form:e.form},model:{value:e.info.contract_number,callback:function(t){e.$set(e.info,"contract_number",t)},expression:"info.contract_number"}}),n("st-form-item",{staticClass:"mg-b12",attrs:{label:"商品价格"}},[e._v("\n          "+e._s(e.info.sell_price)+"元\n        ")]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"优惠券"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.couponText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseCoupon}),attrs:{disabled:!e.canChoseCoupon,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.couponDropdownVisible,callback:function(t){e.couponDropdownVisible=t},expression:"couponDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v(e._s(e.couponList.length)+"张可用优惠券")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectCouponChange},slot:"overlay",model:{value:e.selectCoupon,callback:function(t){e.selectCoupon=t},expression:"selectCoupon"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.couponList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectCoupon}},[n("a-radio",{attrs:{value:t}},[e._v("\n                        "+e._s(t.name)+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{class:e.sale("discounts"),attrs:{label:"定金抵扣"}},[n("div",[n("div",{class:e.sale("discounts-total")},[n("span",[e._v(e._s(e.advanceText))]),n("a-dropdown",{class:e.sale({disabled:!e.canChoseAdvance}),attrs:{disabled:!e.canChoseAdvance,placement:"bottomRight",getPopupContainer:function(e){return e.parentNode},trigger:["click"]},model:{value:e.advanceDropdownVisible,callback:function(t){e.advanceDropdownVisible=t},expression:"advanceDropdownVisible"}},[n("div",{class:e.sale("discounts-promotion")},[n("span",[e._v("定金选择")]),n("a-icon",{attrs:{type:"right"}})],1),n("a-radio-group",{class:e.sale("dropdown"),attrs:{slot:"overlay"},on:{change:e.onSelectAdvanceChange},slot:"overlay",model:{value:e.selectAdvance,callback:function(t){e.selectAdvance=t},expression:"selectAdvance"}},[n("a-menu",[n("a-menu-item",{on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:void 0}},[e._v("不使用")])],1),e._l(e.advanceList,(function(t,i){return n("a-menu-item",{key:i,on:{click:e.onSelectAdvance}},[n("a-radio",{attrs:{value:t.id}},[e._v("\n                        定金 "+e._s(t.price)+"\n                      ")])],1)}))],2)],1)],1)],1)])]),n("st-form-item",{attrs:{label:"减免金额"}},[n("st-input-number",{attrs:{float:!0,placeholder:"请输入"},model:{value:e.reduceAmount,callback:function(t){e.reduceAmount=t},expression:"reduceAmount"}},[n("span",{attrs:{slot:"addonAfter"},slot:"addonAfter"},[e._v("元")])])],1),n("st-form-item",{staticClass:"mg-b0",attrs:{validateStatus:"error",help:e.orderAmountText,label:"小计"}},[n("span",{staticClass:"total"},[e._v(e._s(e.currentPrice)+"元")])])],1),n("div",{class:e.sale("remarks")},[n("st-form-item",{attrs:{label:"销售人员",required:""}},[n("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:e.decorators.saleName,expression:"decorators.saleName"}],attrs:{placeholder:"选择签单的工作人员"}},e._l(e.saleList,(function(t,i){return n("a-select-option",{key:i,attrs:{value:t.id}},[e._v("\n              "+e._s(t.staff_name)+"\n            ")])})),1),n("div",[n("st-checkbox",{model:{value:e.isFollowSalesman,callback:function(t){e.isFollowSalesman=t},expression:"isFollowSalesman"}},[e._v("\n              作为用户跟进销售\n            ")])],1)],1),n("st-form-item",{staticClass:"mg-b0",attrs:{label:"备注"}},[n("st-textarea",{attrs:{autosize:{minRows:4,maxRows:6},maxlength:200},model:{value:e.description,callback:function(t){e.description=t},expression:"description"}})],1)],1)],1)],1),n("template",{slot:"footer"},[n("div",{class:e.sale("footer")},[n("div",{staticClass:"price"},[n("span",[e._v(e._s(e.currentPrice)+"元")]),n("span",[e._v("订单总额："+e._s(e.info.sell_price)+"元")])]),n("div",{staticClass:"button"},[n("st-button",{attrs:{loading:e.loading.setTransactionOrder},on:{click:e.onCreateOrder}},[e._v("\n          创建订单\n        ")]),n("st-button",{attrs:{loading:e.loading.setTransactionPay,type:"primary"},on:{click:e.onPay}},[e._v("\n          立即支付\n        ")])],1)])])],2)},d=[],l=n("c32d"),u=n.n(l),p=n("d225"),m=n("b0b4"),f=n("9ab4"),_=n("0cd5"),h=n("df29"),b=n("75ca"),v=n("c4cc"),g=n("1a2d"),y=n("d792"),C=n("f59d"),O=n("af6c"),A=n("1b92"),S=n("54da"),j=n("2138"),T=function(){function e(t,n,i){var a=this;Object(p["a"])(this,e),this.contractApi=t,this.transactionApi=n,this.userService=i,this.finished$=new h["d"]({}),this.loading$=new h["d"]({}),this.page$=new h["d"]({}),this.info$=new h["d"]({}),this.courseList$=new h["d"]([]),this.saleList$=new h["d"]({}),this.couponList$=new h["d"]([]),this.currentPrice$=new h["d"]("0"),this.effectiveWayOptions$=this.userService.getOptions$("package_course.effective_way"),this.currentPriceAction$=new h["a"]((function(e){return e.pipe(a.debounceMap(),Object(v["a"])((function(e){a.currentPrice$.commit((function(){return e.info.price}))})))}))}return Object(m["a"])(e,[{key:"REST_COUPONLIST",value:function(){this.couponList$.commit((function(){return[]}))}},{key:"SET_LIST",value:function(e){this.courseList$.commit((function(){return e}))}},{key:"debounceMap",value:function(){var e=this;return function(t){return t.pipe(Object(g["a"])(200),Object(y["a"])((function(t){return e.getPrice(t).pipe(Object(C["a"])((function(){return A["a"]})))})))}}},{key:"getCourseList",value:function(e){var t=this;return this.transactionApi.getTransactionList(e).pipe(Object(v["a"])((function(e){t.page$.commit((function(){return e.page})),t.finished$.commit((function(){return e.page.current_page>=e.page.total_pages})),t.courseList$.commit((function(t){return 1===e.page.current_page&&(t=[]),t.concat(e.list)}))})))}},{key:"getInfo",value:function(e){var t=this;return this.transactionApi.getTransactionInfo(e,"package/course").pipe(Object(v["a"])((function(e){t.info$.commit((function(){return e.info}))})))}},{key:"getAdvanceList",value:function(e){return this.transactionApi.getTransactionAdvanceList(e)}},{key:"getSaleList",value:function(){var e=this;return this.transactionApi.getTransactionSaleList().pipe(Object(v["a"])((function(t){e.saleList$.commit((function(){return t.list}))})))}},{key:"getCouponList",value:function(e){var t=this;return this.transactionApi.getTransactionCouponList(e,"package").pipe(Object(v["a"])((function(e){t.couponList$.commit((function(){return e.list}))})))}},{key:"serviceInit",value:function(){return Object(S["a"])(this.getSaleList())}},{key:"setTransactionOrder",value:function(e){return this.transactionApi.setTransaction(e,"package")}},{key:"setTransactionPay",value:function(e){return this.transactionApi.setTransaction(e,"package")}},{key:"getPrice",value:function(e){return this.transactionApi.getTransactionPrice(e)}}]),e}();Object(f["b"])([Object(h["c"])(),Object(f["d"])("design:type",Function),Object(f["d"])("design:paramtypes",["function"===typeof(i="undefined"!==typeof b["TransactionListInput"]&&b["TransactionListInput"])?i:Object]),Object(f["d"])("design:returntype",void 0)],T.prototype,"getCourseList",null),Object(f["b"])([Object(h["c"])(),Object(f["d"])("design:type",Function),Object(f["d"])("design:paramtypes",[Object]),Object(f["d"])("design:returntype",void 0)],T.prototype,"getAdvanceList",null),Object(f["b"])([Object(h["c"])(),Object(f["d"])("design:type",Function),Object(f["d"])("design:paramtypes",[]),Object(f["d"])("design:returntype",void 0)],T.prototype,"serviceInit",null),Object(f["b"])([Object(h["c"])(),Object(f["d"])("design:type",Function),Object(f["d"])("design:paramtypes",[Object]),Object(f["d"])("design:returntype",void 0)],T.prototype,"setTransactionOrder",null),Object(f["b"])([Object(h["c"])(),Object(f["d"])("design:type",Function),Object(f["d"])("design:paramtypes",[Object]),Object(f["d"])("design:returntype",void 0)],T.prototype,"setTransactionPay",null),Object(f["b"])([Object(h["c"])(),Object(f["d"])("design:type",Function),Object(f["d"])("design:paramtypes",["function"===typeof(a="undefined"!==typeof b["TransactionPriceInput"]&&b["TransactionPriceInput"])?a:Object]),Object(f["d"])("design:returntype",void 0)],T.prototype,"getPrice",null),T=Object(f["b"])([Object(_["b"])(),Object(f["d"])("design:paramtypes",["function"===typeof(o="undefined"!==typeof O["a"]&&O["a"])?o:Object,"function"===typeof(s="undefined"!==typeof b["c"]&&b["c"])?s:Object,"function"===typeof(r="undefined"!==typeof j["a"]&&j["a"])?r:Object])],T);var P=n("ec41"),L=n("5c8a"),w=n("808d"),$=function(e){return{effective_way:{initialValue:1},saleName:{rules:[{required:!0,message:"请选择销售人员"}]},productId:{initialValue:void 0,rules:[{required:!0,message:"请选择课"}]}}},x=n("2527"),I=n("3577"),k=n("464d"),D=n("2d9d"),F=n("5ff9"),M={name:"ModalSoldDealSaleMemberCard",bem:{sale:"modal-sold-deal-sale"},components:{EditableContractNumber:k["a"],MemberSearch:D["a"],AddCardMember:I["a"],SelectScroll:F["a"]},serviceProviders:function(){return[T]},serviceInject:function(){return{saleCourseService:T,pattern:x["a"]}},rxState:function(){return{page:this.saleCourseService.page$,loading:this.saleCourseService.loading$,finished:this.saleCourseService.finished$,effectiveWayOptions:this.saleCourseService.effectiveWayOptions$,info:this.saleCourseService.info$,courseList:this.saleCourseService.courseList$,saleList:this.saleCourseService.saleList$,couponList:this.saleCourseService.couponList$,currentPrice:this.saleCourseService.currentPrice$}},props:{id:{type:String},memberInfo:{type:Object}},data:function(){var e=this.$stForm.create(),t=e.decorators($);return{form:e,decorators:t,show:!1,advanceDropdownVisible:!1,advanceList:[],advanceText:"未选择定金",advanceAmount:"",selectAdvance:"",reduceAmount:"",description:"",selectCoupon:"",memberChildrenlist:[],couponText:"未选择优惠券",couponAmount:"",couponDropdownVisible:!1,isExpire:1,product_id:"",isFollowSalesman:0,product_name:""}},computed:{canChoseCoupon:function(){var e=this.couponList.length;return!!e},canChoseAdvance:function(){var e=this.advanceList.length;return(this.id||this.product_id)&&e},orderAmountText:function(){return this.currentPrice<0?"小计不能为负":""},saleRangeType:function(){return Object(P["a"])(this.info.sale_range,"type",1)},hasProductInfo:function(){return"{}"!==JSON.stringify(this.info)}},watch:{selectCoupon:{deep:!0,handler:function(e,t){this.getPrice(e,this.selectAdvance,+this.reduceAmount)}},selectAdvance:{deep:!0,handler:function(e,t){this.getPrice(this.selectCoupon,e,+this.reduceAmount)}},reduceAmount:function(e,t){this.getPrice(this.selectCoupon,this.selectAdvance,+e)}},mounted:function(){var e=this;this.saleCourseService.serviceInit().subscribe((function(t){e.id?e.handleGetCourseInfo(e.id):e.saleCourseService.getCourseList({app_brand_id:e.$searchQuery.app_brand_id,app_shop_id:e.$searchQuery.app_shop_id,product_type:5}).subscribe()}))},methods:{moment:u.a,handleSelect:function(e){this.product_id=e,this.onResetDiscounts(),this.handleGetCourseInfo(e)},handleSearch:function(e){this.product_name=e,this.saleCourseService.getCourseList({product_name:e,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:5,page:1}).subscribe()},onChangeEffectiveWay:function(e){this.isExpire=e.target.value},onResetDiscounts:function(){this.resetCoupon(),this.resetAdvance()},onReGetDiscounts:function(e){this.fetchAdvanceList(e),this.fetchCouponList(e)},onMemberChange:function(e){this.onResetDiscounts(),e&&this.onReGetDiscounts(e)},onSelectAdvance:function(){var e=this;Object(w["a"])(200).subscribe((function(){e.advanceDropdownVisible=!1}))},onSelectCoupon:function(){var e=this;Object(w["a"])(200).subscribe((function(){e.couponDropdownVisible=!1}))},resetAdvance:function(){this.advanceList=[],this.advanceText="未选择定金",this.selectAdvance="",this.advanceAmount=""},resetCoupon:function(){this.saleCourseService.REST_COUPONLIST(),this.couponText="未选择优惠券",this.selectCoupon="",this.couponAmount=""},onCancel:function(){this.resetAdvance()},onSelectAdvanceChange:function(e){if(!e.target.value)return this.advanceAmount=0,void(this.advanceText="未选择定金");var t=this.advanceList.filter((function(t){return t.id===e.target.value}))[0].price;this.advanceAmount=t,this.advanceText="".concat(t,"元")},onSelectCouponChange:function(e){var t=Object(P["a"])(e.target.value,"id","");if(t){var n=this.couponList.filter((function(e){return e.id===t}))[0].price;this.couponAmount=n,this.couponText="".concat(n,"元")}else this.couponText="未选择优惠券",this.couponAmount=0},getPrice:function(e,t,n){var i=this.form.getFieldValue("member_id"),a=this.form.getFieldValue("productId")||void 0;this.saleCourseService.currentPriceAction$.dispatch({product_id:a,product_type:this.info.contract_type,coupon_id:e?e.id:void 0,member_id:i||void 0,advance_id:t||void 0,reduce_amount:n||void 0})},onCreateOrder:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0;e.saleCourseService.setTransactionOrder({effective_way:t.effective_way,member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,package_id:n,contract_number:e.info.contract_number,coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,advance_amount:e.validStartTime,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,sale_range:e.info.sale_range.type,order_amount:e.currentPrice,is_minors:t.is_minors,member_ids:e.memberChildrenlist.filter((function(e){return!!e.id})).map((function(e){return e.id})),member_info:e.memberChildrenlist.filter((function(e){return!e.id})).map((function(e){if(e.is_minors){var t=e.mobile;e.mobile="",e.parent_mobile=e.parent_mobile||t}return e})),parent_name:t.parent_name,parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.$emit("success",{type:"create",orderId:t.info.order_id}),e.show=!1}))}))},onPay:function(){var e=this;this.form.validate().then((function(t){var n=e.form.getFieldValue("productId")||void 0;e.saleCourseService.setTransactionPay({effective_way:t.effective_way,member_id:t.member_id,member_name:t.member_name,mobile:t.mobile?t.mobile.phone:void 0,package_id:n,contract_number:e.info.contract_number,coupon_id:e.selectCoupon.id,advance_id:e.selectAdvance,advance_amount:e.advanceAmount,reduce_amount:e.reduceAmount||0,sale_id:t.saleName,description:e.description,sale_range:e.info.sale_range.type,order_amount:e.currentPrice,is_minors:t.is_minors,parent_name:t.parent_name,member_ids:e.memberChildrenlist.filter((function(e){return!!e.id})).map((function(e){return e.id})),member_info:e.memberChildrenlist.filter((function(e){return!e.id})).map((function(e){if(e.is_minors){var t=e.mobile;e.mobile="",e.parent_mobile=e.parent_mobile||t}return e})),parent_mobile:t.parent_mobile?t.parent_mobile.phone:void 0,parent_country_prefix:t.parent_mobile?t.parent_mobile.code_id:void 0,parent_user_role:t.parent_user_role,physical_id:t.physical_id,card_num:t.card_num,id_card:t.id_card,id_card_type:t.id_card_type,is_follow_salesman:e.isFollowSalesman}).subscribe((function(t){e.$emit("success",{type:"createPay",orderId:t.info.order_id}),e.show=!1}))}))},handleGetList:function(){if(this.finished)return!1;this.saleCourseService.getCourseList({product_name:this.product_name,app_brand_id:this.$searchQuery.app_brand_id,app_shop_id:this.$searchQuery.app_shop_id,product_type:5,page:++this.page.current_page}).subscribe()},handleGetCourseInfo:function(e){var t=this;this.saleCourseService.getInfo(e).subscribe((function(n){t.id&&t.saleCourseService.SET_LIST([{id:+t.id,product_name:t.info.product_name}]),setTimeout((function(){t.form.setFieldsValue({productId:+e}),t.onReGetDiscounts(),t.getPrice()}))}))},fetchCouponList:function(e){var t=this.form.getFieldValue("productId")||void 0,n=this.form.getFieldValue("member_id")||e;if(t&&n){var i={member_id:n,package_id:t};this.saleCourseService.getCouponList(i).subscribe()}},fetchAdvanceList:function(e){var t=this,n=this.form.getFieldValue("member_id")||e;n&&this.saleCourseService.getAdvanceList(n).subscribe((function(e){t.advanceList=Object(L["a"])(e.list)}))}}},N=M,V=n("2877"),R=Object(V["a"])(N,c,d,!1,null,null,null);t["a"]=R.exports}}]);