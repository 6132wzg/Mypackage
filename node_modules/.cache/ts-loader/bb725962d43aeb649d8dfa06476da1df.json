{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js??ref--13-2!/Users/wangzhigang/Desktop/styd/web/src/services/user.service.ts","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/services/user.service.ts","mtime":1600926555631},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js","mtime":1591062571609}],"contextDependencies":[],"result":["import _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport _classCallCheck from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\n\nvar _a, _b, _c, _d, _e, _f;\n\nimport { __decorate, __metadata } from \"tslib\";\nimport { Injectable } from 'vue-service-app';\nimport { State, Computed, computed } from 'rx-state';\nimport { tap, pluck, map } from 'rxjs/operators';\nimport { ConstApi } from '@/api/const';\nimport { MenuApi } from '@/api/v1/common/menu';\nimport { StaffApi } from '@/api/v1/staff';\nimport { TooltipApi } from '@/api/v1/admin/tooltip';\nimport { get, reduce, isPlainObject, mapValues } from 'lodash-es';\nimport { ShopApi } from '@/api/v1/shop';\nimport { StatApi } from '@/api/v1/stat/shop';\nimport Vue from 'vue';\n/**\n * 用户的全局初始信息\n */\n\nvar UserService = /*#__PURE__*/function () {\n  function UserService(constApi, menuApi, staffApi, tooltipApi, shopApi, statApi) {\n    _classCallCheck(this, UserService);\n\n    this.constApi = constApi;\n    this.menuApi = menuApi;\n    this.staffApi = staffApi;\n    this.tooltipApi = tooltipApi;\n    this.shopApi = shopApi;\n    this.statApi = statApi;\n    this.firstInited$ = new State(false);\n    this.user$ = new State({});\n    this.brand$ = new State({});\n    this.shop$ = new State({}); // 用户的插件状态\n\n    this.pluginStatus$ = new State({});\n    this.shopList$ = new State([]);\n    this.staffList$ = new State([]);\n    this.menuData$ = new State({\n      favorite: [],\n      menus: [],\n      first_url: ''\n    });\n    this.config$ = new State({});\n    this.isShop$ = new Computed(this.shop$.pipe(map(function (shop) {\n      return !!shop.id;\n    })));\n    this.menus$ = new Computed(this.menuData$.pipe(pluck('menus')));\n    this.firstMenuUrl$ = new Computed(this.menuData$.pipe(pluck('first_url')));\n    this.favoriteMenu$ = new Computed(this.menuData$.pipe(pluck('favorite')));\n    /**\n     * 使用版本 club 俱乐部 studio\n     */\n\n    this.useVersion$ = new Computed(this.brand$.pipe(map(function (brand) {\n      return {\n        club: 'club',\n        old_studio: 'studio',\n        studio: 'studio'\n      }[brand.version];\n    })));\n    /**\n     * 标准工作室版本\n     */\n\n    this.isBrandStudio$ = new Computed(this.brand$.pipe(map(function (brand) {\n      return !!(brand.version === 'studio');\n    })));\n    this.isThemeClub$ = new Computed(this.useVersion$.pipe(map(function (useVersion) {\n      return useVersion === 'club';\n    })));\n    this.isThemeStudio$ = new Computed(this.useVersion$.pipe(map(function (useVersion) {\n      return useVersion === 'studio';\n    })));\n    this.theme$ = new Computed(this.useVersion$.pipe(map(function (useVersion) {\n      return \"theme-\".concat(useVersion);\n    }))); // 枚举对象\n\n    this.enums$ = new State({}); // 禁用的 tooltips\n\n    this.invalidTooltips$ = new State([]);\n    this.urlData$ = new State({});\n  }\n\n  _createClass(UserService, [{\n    key: \"SET_USER\",\n    value: function SET_USER(staff) {\n      var info = staff.info;\n      this.user$.commit(function (user) {\n        user.id = info.staff_id;\n        user.name = info.staff_name;\n        user.avatar = info.staff_avatar;\n        user.mobile = info.mobile;\n      });\n    }\n  }, {\n    key: \"SET_BRAND\",\n    value: function SET_BRAND(staff) {\n      var info = staff.info;\n      this.brand$.commit(function (brand) {\n        brand.id = info.brand_id;\n        brand.name = info.brand_name;\n        brand.logo = info.brand_logo;\n        brand.priceModel = info.price_model;\n        brand.saleModel = info.sale_model;\n        brand.version = info.brand_version;\n      });\n    }\n  }, {\n    key: \"SET_SHOP\",\n    value: function SET_SHOP(staff) {\n      var info = staff.info;\n      this.shop$.commit(function (shop) {\n        shop.id = info.shop_id;\n        shop.name = info.shop_name;\n        shop.logo = info.shop_logo;\n      });\n    }\n  }, {\n    key: \"SET_PLUGIN_STATUS\",\n    value: function SET_PLUGIN_STATUS(staff) {\n      var info = staff.info;\n      this.pluginStatus$.commit(function (status) {\n        status.pointActivityAtatus = info.point_activity_status;\n      });\n    }\n  }, {\n    key: \"SET_ENUMS\",\n    value: function SET_ENUMS(enums) {\n      this.enums$.commit(function () {\n        return enums;\n      });\n    }\n  }, {\n    key: \"SET_CONFIG\",\n    value: function SET_CONFIG(config) {\n      this.config$.commit(function () {\n        return config;\n      });\n    }\n  }, {\n    key: \"SET_MENU_DATA\",\n    value: function SET_MENU_DATA(menuData) {\n      this.menuData$.commit(function () {\n        return menuData;\n      });\n    }\n  }, {\n    key: \"SET_INVALID_TOOLTIP\",\n    value: function SET_INVALID_TOOLTIP(res) {\n      this.invalidTooltips$.commit(function () {\n        return res.list;\n      });\n    }\n  }, {\n    key: \"SET_SHOP_LIST\",\n    value: function SET_SHOP_LIST(res) {\n      this.shopList$.commit(function () {\n        return res.list;\n      });\n    }\n  }, {\n    key: \"SET_STAFF_LIST\",\n    value: function SET_STAFF_LIST(res) {\n      this.staffList$.commit(function () {\n        return res.list;\n      });\n    }\n  }, {\n    key: \"fetchStaffInfo\",\n    value: function fetchStaffInfo() {\n      var _this = this;\n\n      return this.staffApi.getGlobalStaffInfo().pipe(tap(function (res) {\n        _this.SET_BRAND(res);\n\n        _this.SET_USER(res);\n\n        _this.SET_SHOP(res);\n\n        _this.SET_PLUGIN_STATUS(res);\n      }));\n    }\n  }, {\n    key: \"fetchEnums\",\n    value: function fetchEnums() {\n      var _this2 = this;\n\n      return this.constApi.getEnum().pipe(tap(function (res) {\n        _this2.SET_ENUMS(res);\n\n        _this2.SET_CONFIG(get(res, 'version_conf.documents.value', {}));\n      }));\n    }\n  }, {\n    key: \"fetchMenuData\",\n    value: function fetchMenuData() {\n      var _this3 = this;\n\n      return this.menuApi.getList().pipe(tap(function (res) {\n        _this3.SET_MENU_DATA(res);\n      }));\n    }\n  }, {\n    key: \"fetchInvalidTooltips\",\n    value: function fetchInvalidTooltips() {\n      var _this4 = this;\n\n      return this.tooltipApi.getInvalid().pipe(tap(function (res) {\n        _this4.SET_INVALID_TOOLTIP(res);\n      }));\n    }\n  }, {\n    key: \"fetchShopList\",\n    value: function fetchShopList() {\n      var _this5 = this;\n\n      return this.shopApi.getShopList().pipe(tap(function (res) {\n        _this5.SET_SHOP_LIST(res);\n      }));\n    }\n  }, {\n    key: \"fetchStaffList\",\n    value: function fetchStaffList(query) {\n      var _this6 = this;\n\n      return this.statApi.getStaffList(query).pipe(tap(function (res) {\n        _this6.SET_STAFF_LIST(res);\n      }));\n    }\n  }, {\n    key: \"getOptions\",\n    value: function getOptions(enums, key) {\n      var labelField = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'label';\n      var enumObj = get(enums, key);\n\n      if (!enumObj) {\n        return [];\n      } else {\n        return reduce(enumObj.value, function (res, item, index) {\n          var _ref;\n\n          if (isPlainObject(item)) {\n            return res.concat([item]);\n          }\n\n          return res.concat([(_ref = {}, _defineProperty(_ref, labelField, item), _defineProperty(_ref, \"value\", +index), _ref)]);\n        }, []);\n      }\n    }\n    /**\n     * 通过key名获取下拉选项\n     * @example\n     * getOptions$('member.card_consume_type') => Observable([{label:'次卡',value:1},{label:'期限卡',2}])\n     */\n\n  }, {\n    key: \"getOptions$\",\n    value: function getOptions$(key) {\n      var _this7 = this;\n\n      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n      return computed(function (enums) {\n        var opts = _this7.getOptions(enums, key, options.labelField);\n\n        if (options.addAll) {\n          var allLabel = options.addAll === true ? '全部' : options.addAll;\n          opts = [_defineProperty({\n            value: -1\n          }, options.labelField || 'label', allLabel)].concat(opts);\n        }\n\n        console.log(opts);\n        return opts;\n      }, [this.enums$]);\n    }\n    /**\n     * 通过对象获取一组枚举值\n     * @param map\n     */\n\n  }, {\n    key: \"getOptionsMap$\",\n    value: function getOptionsMap$(map) {\n      var _this8 = this;\n\n      return computed(function (enums) {\n        return mapValues(map, function (enumKey) {\n          return _this8.getOptions(enums, enumKey);\n        });\n      }, [this.enums$]);\n    }\n    /**\n     * 获取set对象\n     * @param path\n     */\n\n  }, {\n    key: \"getEnumValue$\",\n    value: function getEnumValue$(path) {\n      return new State(get(this.enums$.snapshot(), \"\".concat(path, \".value\")));\n    }\n    /**\n     * 新增到常用菜单\n     * @param id\n     */\n\n  }, {\n    key: \"addFavorite\",\n    value: function addFavorite(id) {\n      return this.menuApi.addFavorite(id);\n    }\n    /**\n     * 删除常用菜单\n     * @param id\n     */\n\n  }, {\n    key: \"delFavorite\",\n    value: function delFavorite(id) {\n      return this.menuApi.delFavorite(id);\n    }\n  }, {\n    key: \"c\",\n    value: function c(key) {\n      return get(this.config$.snapshot(), key, key);\n    }\n  }, {\n    key: \"interpolation\",\n    value: function interpolation(title) {\n      if (!title) {\n        return '';\n      }\n\n      var vm = new Vue({\n        template: '<span>' + title + '</span>'\n      }).$mount();\n      return vm.$el.innerText;\n    }\n  }]);\n\n  return UserService;\n}();\n\nUserService = __decorate([Injectable(), __metadata(\"design:paramtypes\", [typeof (_a = typeof ConstApi !== \"undefined\" && ConstApi) === \"function\" ? _a : Object, typeof (_b = typeof MenuApi !== \"undefined\" && MenuApi) === \"function\" ? _b : Object, typeof (_c = typeof StaffApi !== \"undefined\" && StaffApi) === \"function\" ? _c : Object, typeof (_d = typeof TooltipApi !== \"undefined\" && TooltipApi) === \"function\" ? _d : Object, typeof (_e = typeof ShopApi !== \"undefined\" && ShopApi) === \"function\" ? _e : Object, typeof (_f = typeof StatApi !== \"undefined\" && StatApi) === \"function\" ? _f : Object])], UserService);\nexport { UserService };",{"version":3,"sources":["/Users/wangzhigang/Desktop/styd/web/src/services/user.service.ts"],"names":[],"mappings":";;;;;;;AAAA,SAAS,UAAT,QAAuC,iBAAvC;AACA,SAAS,KAAT,EAAgB,QAAhB,EAA0B,QAA1B,QAA0C,UAA1C;AAEA,SAAS,GAAT,EAAc,KAAd,EAAqB,GAArB,QAAgC,gBAAhC;AACA,SAAS,QAAT,QAAyB,aAAzB;AACA,SAAS,OAAT,QAAwB,sBAAxB;AACA,SAAS,QAAT,QAAyB,gBAAzB;AACA,SAAS,UAAT,QAA2B,wBAA3B;AACA,SAAS,GAAT,EAAc,MAAd,EAAsB,aAAtB,EAAqC,SAArC,QAAsD,WAAtD;AACA,SAAS,OAAT,QAAwB,eAAxB;AACA,SAAS,OAAT,QAAwB,oBAAxB;AACA,OAAO,GAAP,MAAgB,KAAhB;AAgCA;;;;AAIA,IAAa,WAAb;AA6DE,uBACU,QADV,EAEU,OAFV,EAGU,QAHV,EAIU,UAJV,EAKU,OALV,EAMU,OANV,EAM0B;AAAA;;AALhB,SAAA,QAAA,GAAA,QAAA;AACA,SAAA,OAAA,GAAA,OAAA;AACA,SAAA,QAAA,GAAA,QAAA;AACA,SAAA,UAAA,GAAA,UAAA;AACA,SAAA,OAAA,GAAA,OAAA;AACA,SAAA,OAAA,GAAA,OAAA;AAlEV,SAAA,YAAA,GAAe,IAAI,KAAJ,CAAU,KAAV,CAAf;AAEA,SAAA,KAAA,GAAQ,IAAI,KAAJ,CAAgB,EAAhB,CAAR;AACA,SAAA,MAAA,GAAS,IAAI,KAAJ,CAAiB,EAAjB,CAAT;AACA,SAAA,KAAA,GAAQ,IAAI,KAAJ,CAAgB,EAAhB,CAAR,CA8D0B,CA7D1B;;AACA,SAAA,aAAA,GAAgB,IAAI,KAAJ,CAAe,EAAf,CAAhB;AACA,SAAA,SAAA,GAAY,IAAI,KAAJ,CAAiB,EAAjB,CAAZ;AACA,SAAA,UAAA,GAAa,IAAI,KAAJ,CAAiB,EAAjB,CAAb;AACA,SAAA,SAAA,GAAY,IAAI,KAAJ,CAAe;AACzB,MAAA,QAAQ,EAAE,EADe;AAEzB,MAAA,KAAK,EAAE,EAFkB;AAGzB,MAAA,SAAS,EAAE;AAHc,KAAf,CAAZ;AAKA,SAAA,OAAA,GAAU,IAAI,KAAJ,CAAU,EAAV,CAAV;AACA,SAAA,OAAA,GAAU,IAAI,QAAJ,CAAa,KAAK,KAAL,CAAW,IAAX,CAAgB,GAAG,CAAC,UAAA,IAAI;AAAA,aAAI,CAAC,CAAC,IAAI,CAAC,EAAX;AAAA,KAAL,CAAnB,CAAb,CAAV;AACA,SAAA,MAAA,GAAS,IAAI,QAAJ,CAAoB,KAAK,SAAL,CAAe,IAAf,CAAoB,KAAK,CAAC,OAAD,CAAzB,CAApB,CAAT;AACA,SAAA,aAAA,GAAgB,IAAI,QAAJ,CAAqB,KAAK,SAAL,CAAe,IAAf,CAAoB,KAAK,CAAC,WAAD,CAAzB,CAArB,CAAhB;AACA,SAAA,aAAA,GAAgB,IAAI,QAAJ,CAAa,KAAK,SAAL,CAAe,IAAf,CAAoB,KAAK,CAAC,UAAD,CAAzB,CAAb,CAAhB;AACA;;;;AAGA,SAAA,WAAA,GAAc,IAAI,QAAJ,CACZ,KAAK,MAAL,CAAY,IAAZ,CACE,GAAG,CAAC,UAAA,KAAK,EAAG;AACV,aAAO;AACL,QAAA,IAAI,EAAE,MADD;AAEL,QAAA,UAAU,EAAE,QAFP;AAGL,QAAA,MAAM,EAAE;AAHH,QAIL,KAAK,CAAC,OAJD,CAAP;AAKD,KANE,CADL,CADY,CAAd;AAWA;;;;AAGA,SAAA,cAAA,GAAiB,IAAI,QAAJ,CACf,KAAK,MAAL,CAAY,IAAZ,CAAiB,GAAG,CAAC,UAAA,KAAK;AAAA,aAAI,CAAC,EAAE,KAAK,CAAC,OAAN,KAAkB,QAApB,CAAL;AAAA,KAAN,CAApB,CADe,CAAjB;AAIA,SAAA,YAAA,GAAe,IAAI,QAAJ,CACb,KAAK,WAAL,CAAiB,IAAjB,CAAsB,GAAG,CAAC,UAAA,UAAU;AAAA,aAAI,UAAU,KAAK,MAAnB;AAAA,KAAX,CAAzB,CADa,CAAf;AAGA,SAAA,cAAA,GAAiB,IAAI,QAAJ,CACf,KAAK,WAAL,CAAiB,IAAjB,CAAsB,GAAG,CAAC,UAAA,UAAU;AAAA,aAAI,UAAU,KAAK,QAAnB;AAAA,KAAX,CAAzB,CADe,CAAjB;AAIA,SAAA,MAAA,GAAS,IAAI,QAAJ,CACP,KAAK,WAAL,CAAiB,IAAjB,CACE,GAAG,CAAC,UAAA,UAAU,EAAG;AACf,6BAAgB,UAAhB;AACD,KAFE,CADL,CADO,CAAT,CAmB0B,CAZ1B;;AACA,SAAA,MAAA,GAAS,IAAI,KAAJ,CAAU,EAAV,CAAT,CAW0B,CAV1B;;AACA,SAAA,gBAAA,GAAmB,IAAI,KAAJ,CAAU,EAAV,CAAnB;AAEA,SAAA,QAAA,GAAW,IAAI,KAAJ,CAAU,EAAV,CAAX;AAQI;;AApEN;AAAA;AAAA,6BAqEW,KArEX,EAqEqB;AACjB,UAAM,IAAI,GAAG,KAAK,CAAC,IAAnB;AACA,WAAK,KAAL,CAAW,MAAX,CAAkB,UAAA,IAAI,EAAG;AACvB,QAAA,IAAI,CAAC,EAAL,GAAU,IAAI,CAAC,QAAf;AACA,QAAA,IAAI,CAAC,IAAL,GAAY,IAAI,CAAC,UAAjB;AACA,QAAA,IAAI,CAAC,MAAL,GAAc,IAAI,CAAC,YAAnB;AACA,QAAA,IAAI,CAAC,MAAL,GAAc,IAAI,CAAC,MAAnB;AACD,OALD;AAMD;AA7EH;AAAA;AAAA,8BA8EY,KA9EZ,EA8EsB;AAClB,UAAM,IAAI,GAAG,KAAK,CAAC,IAAnB;AACA,WAAK,MAAL,CAAY,MAAZ,CAAmB,UAAA,KAAK,EAAG;AACzB,QAAA,KAAK,CAAC,EAAN,GAAW,IAAI,CAAC,QAAhB;AACA,QAAA,KAAK,CAAC,IAAN,GAAa,IAAI,CAAC,UAAlB;AACA,QAAA,KAAK,CAAC,IAAN,GAAa,IAAI,CAAC,UAAlB;AACA,QAAA,KAAK,CAAC,UAAN,GAAmB,IAAI,CAAC,WAAxB;AACA,QAAA,KAAK,CAAC,SAAN,GAAkB,IAAI,CAAC,UAAvB;AACA,QAAA,KAAK,CAAC,OAAN,GAAgB,IAAI,CAAC,aAArB;AACD,OAPD;AAQD;AAxFH;AAAA;AAAA,6BAyFW,KAzFX,EAyFqB;AACjB,UAAM,IAAI,GAAG,KAAK,CAAC,IAAnB;AACA,WAAK,KAAL,CAAW,MAAX,CAAkB,UAAA,IAAI,EAAG;AACvB,QAAA,IAAI,CAAC,EAAL,GAAU,IAAI,CAAC,OAAf;AACA,QAAA,IAAI,CAAC,IAAL,GAAY,IAAI,CAAC,SAAjB;AACA,QAAA,IAAI,CAAC,IAAL,GAAY,IAAI,CAAC,SAAjB;AACD,OAJD;AAKD;AAhGH;AAAA;AAAA,sCAiGoB,KAjGpB,EAiGyB;AACrB,UAAM,IAAI,GAAG,KAAK,CAAC,IAAnB;AACA,WAAK,aAAL,CAAmB,MAAnB,CAA0B,UAAA,MAAM,EAAG;AACjC,QAAA,MAAM,CAAC,mBAAP,GAA6B,IAAI,CAAC,qBAAlC;AACD,OAFD;AAGD;AAtGH;AAAA;AAAA,8BAuGY,KAvGZ,EAuGsB;AAClB,WAAK,MAAL,CAAY,MAAZ,CAAmB;AAAA,eAAM,KAAN;AAAA,OAAnB;AACD;AAzGH;AAAA;AAAA,+BA0Ga,MA1Gb,EA0GwB;AACpB,WAAK,OAAL,CAAa,MAAb,CAAoB;AAAA,eAAM,MAAN;AAAA,OAApB;AACD;AA5GH;AAAA;AAAA,kCA6GgB,QA7GhB,EA6G6B;AACzB,WAAK,SAAL,CAAe,MAAf,CAAsB;AAAA,eAAM,QAAN;AAAA,OAAtB;AACD;AA/GH;AAAA;AAAA,wCAgHsB,GAhHtB,EAgH8B;AAC1B,WAAK,gBAAL,CAAsB,MAAtB,CAA6B;AAAA,eAAM,GAAG,CAAC,IAAV;AAAA,OAA7B;AACD;AAlHH;AAAA;AAAA,kCAmHgB,GAnHhB,EAmHwB;AACpB,WAAK,SAAL,CAAe,MAAf,CAAsB;AAAA,eAAM,GAAG,CAAC,IAAV;AAAA,OAAtB;AACD;AArHH;AAAA;AAAA,mCAsHiB,GAtHjB,EAsHyB;AACrB,WAAK,UAAL,CAAgB,MAAhB,CAAuB;AAAA,eAAM,GAAG,CAAC,IAAV;AAAA,OAAvB;AACD;AAxHH;AAAA;AAAA,qCAyHgB;AAAA;;AACZ,aAAO,KAAK,QAAL,CAAc,kBAAd,GAAmC,IAAnC,CACL,GAAG,CAAC,UAAC,GAAD,EAAa;AACf,QAAA,KAAI,CAAC,SAAL,CAAe,GAAf;;AACA,QAAA,KAAI,CAAC,QAAL,CAAc,GAAd;;AACA,QAAA,KAAI,CAAC,QAAL,CAAc,GAAd;;AACA,QAAA,KAAI,CAAC,iBAAL,CAAuB,GAAvB;AACD,OALE,CADE,CAAP;AAQD;AAlIH;AAAA;AAAA,iCAmIY;AAAA;;AACR,aAAO,KAAK,QAAL,CAAc,OAAd,GAAwB,IAAxB,CACL,GAAG,CAAC,UAAA,GAAG,EAAG;AACR,QAAA,MAAI,CAAC,SAAL,CAAe,GAAf;;AACA,QAAA,MAAI,CAAC,UAAL,CAAgB,GAAG,CAAC,GAAD,EAAM,8BAAN,EAAsC,EAAtC,CAAnB;AACD,OAHE,CADE,CAAP;AAMD;AA1IH;AAAA;AAAA,oCA2Ie;AAAA;;AACX,aAAO,KAAK,OAAL,CAAa,OAAb,GAAuB,IAAvB,CACL,GAAG,CAAC,UAAA,GAAG,EAAG;AACR,QAAA,MAAI,CAAC,aAAL,CAAmB,GAAnB;AACD,OAFE,CADE,CAAP;AAKD;AAjJH;AAAA;AAAA,2CAkJsB;AAAA;;AAClB,aAAO,KAAK,UAAL,CAAgB,UAAhB,GAA6B,IAA7B,CACL,GAAG,CAAC,UAAC,GAAD,EAAa;AACf,QAAA,MAAI,CAAC,mBAAL,CAAyB,GAAzB;AACD,OAFE,CADE,CAAP;AAKD;AAxJH;AAAA;AAAA,oCAyJe;AAAA;;AACX,aAAO,KAAK,OAAL,CAAa,WAAb,GAA2B,IAA3B,CACL,GAAG,CAAC,UAAA,GAAG,EAAG;AACR,QAAA,MAAI,CAAC,aAAL,CAAmB,GAAnB;AACD,OAFE,CADE,CAAP;AAKD;AA/JH;AAAA;AAAA,mCAgKiB,KAhKjB,EAgK2B;AAAA;;AACvB,aAAO,KAAK,OAAL,CAAa,YAAb,CAA0B,KAA1B,EAAiC,IAAjC,CACL,GAAG,CAAC,UAAA,GAAG,EAAG;AACR,QAAA,MAAI,CAAC,cAAL,CAAoB,GAApB;AACD,OAFE,CADE,CAAP;AAKD;AAtKH;AAAA;AAAA,+BAuKqB,KAvKrB,EAuKiC,GAvKjC,EAuKkE;AAAA,UAApB,UAAoB,uEAAP,OAAO;AAC9D,UAAM,OAAO,GAAG,GAAG,CAAC,KAAD,EAAQ,GAAR,CAAnB;;AACA,UAAI,CAAC,OAAL,EAAc;AACZ,eAAO,EAAP;AACD,OAFD,MAEO;AACL,eAAO,MAAM,CACX,OAAO,CAAC,KADG,EAEX,UAAC,GAAD,EAAa,IAAb,EAAwB,KAAxB,EAAkD;AAAA;;AAChD,cAAI,aAAa,CAAC,IAAD,CAAjB,EAAyB;AACvB,mBAAO,GAAG,CAAC,MAAJ,CAAW,CAAC,IAAD,CAAX,CAAP;AACD;;AACD,iBAAO,GAAG,CAAC,MAAJ,CAAW,mCAEb,UAFa,EAEA,IAFA,kCAGP,CAAC,KAHM,SAAX,CAAP;AAMD,SAZU,EAaX,EAbW,CAAb;AAeD;AACF;AAED;;;;;;AA9LF;AAAA;AAAA,gCAoMI,GApMJ,EAwMU;AAAA;;AAAA,UAHN,OAGM,uEAAF,EAAE;AAEN,aAAO,QAAQ,CACb,UAAC,KAAD,EAAe;AACb,YAAI,IAAI,GAAG,MAAI,CAAC,UAAL,CAAgB,KAAhB,EAAuB,GAAvB,EAA4B,OAAO,CAAC,UAApC,CAAX;;AACA,YAAI,OAAO,CAAC,MAAZ,EAAoB;AAClB,cAAM,QAAQ,GAAG,OAAO,CAAC,MAAR,KAAmB,IAAnB,GAA0B,IAA1B,GAAiC,OAAO,CAAC,MAA1D;AACA,UAAA,IAAI,GAAG;AACH,YAAA,KAAK,EAAE,CAAC;AADL,aACS,OAAO,CAAC,UAAR,IAAsB,OAD/B,EACyC,QADzC,GAEL,MAFK,CAEE,IAFF,CAAP;AAGD;;AACD,QAAA,OAAO,CAAC,GAAR,CAAY,IAAZ;AACA,eAAO,IAAP;AACD,OAXY,EAYb,CAAC,KAAK,MAAN,CAZa,CAAf;AAcD;AACD;;;;;AAzNF;AAAA;AAAA,mCA6NwB,GA7NxB,EA6N+C;AAAA;;AAC3C,aAAO,QAAQ,CACb,UAAC,KAAD,EAAe;AACb,eAAO,SAAS,CAAC,GAAD,EAAM,UAAA,OAAO;AAAA,iBAAI,MAAI,CAAC,UAAL,CAAgB,KAAhB,EAAuB,OAAvB,CAAJ;AAAA,SAAb,CAAhB;AACD,OAHY,EAIb,CAAC,KAAK,MAAN,CAJa,CAAf;AAMD;AACD;;;;;AArOF;AAAA;AAAA,kCAyOuB,IAzOvB,EAyOmC;AAC/B,aAAO,IAAI,KAAJ,CAAU,GAAG,CAAC,KAAK,MAAL,CAAY,QAAZ,EAAD,YAA4B,IAA5B,YAAb,CAAP;AACD;AACD;;;;;AA5OF;AAAA;AAAA,gCAgPqB,EAhPrB,EAgP+B;AAC3B,aAAO,KAAK,OAAL,CAAa,WAAb,CAAyB,EAAzB,CAAP;AACD;AACD;;;;;AAnPF;AAAA;AAAA,gCAuPqB,EAvPrB,EAuP+B;AAC3B,aAAO,KAAK,OAAL,CAAa,WAAb,CAAyB,EAAzB,CAAP;AACD;AAzPH;AAAA;AAAA,sBA0PW,GA1PX,EA0PsB;AAClB,aAAO,GAAG,CAAC,KAAK,OAAL,CAAa,QAAb,EAAD,EAA0B,GAA1B,EAA+B,GAA/B,CAAV;AACD;AA5PH;AAAA;AAAA,kCA6PuB,KA7PvB,EA6PoC;AAChC,UAAI,CAAC,KAAL,EAAY;AACV,eAAO,EAAP;AACD;;AACD,UAAM,EAAE,GAAQ,IAAI,GAAJ,CAAQ;AACtB,QAAA,QAAQ,EAAE,WAAW,KAAX,GAAmB;AADP,OAAR,EAEb,MAFa,EAAhB;AAGA,aAAO,EAAE,CAAC,GAAH,CAAO,SAAd;AACD;AArQH;;AAAA;AAAA,GAAA;;AAAa,WAAW,GAAA,UAAA,CAAA,CADvB,UAAU,EACa,E,qDA8DF,Q,KAAQ,W,IAAR,Q,MAAQ,U,GAAA,E,GAAA,M,EAAA,QAAA,EAAA,GAAA,OACT,OADS,KACF,WADE,IACT,OADS,MACF,UADE,GACF,EADE,GACF,M,EAAA,QAAA,EAAA,GAAA,OACN,QADM,KACE,WADF,IACN,QADM,MACE,UADF,GACE,EADF,GACE,M,EAAA,QAAA,EAAA,GAAA,OACN,UADM,KACI,WADJ,IACN,UADM,MACI,UADJ,GACI,EADJ,GACI,M,EAAA,QAAA,EAAA,GAAA,OACb,OADa,KACN,WADM,IACb,OADa,MACN,UADM,GACN,EADM,GACN,M,EAAA,QAAA,EAAA,GAAA,OACP,OADO,KACA,WADA,IACP,OADO,MACA,UADA,GACA,EADA,GACA,M,EAnEJ,CAAA,EAAX,WAAW,CAAX;SAAA,W","sourcesContent":["import { Injectable, Dictionary } from 'vue-service-app'\nimport { State, Computed, computed } from 'rx-state'\nimport { of } from 'rxjs'\nimport { tap, pluck, map } from 'rxjs/operators'\nimport { ConstApi } from '@/api/const'\nimport { MenuApi } from '@/api/v1/common/menu'\nimport { StaffApi } from '@/api/v1/staff'\nimport { TooltipApi } from '@/api/v1/admin/tooltip'\nimport { get, reduce, isPlainObject, mapValues } from 'lodash-es'\nimport { ShopApi } from '@/api/v1/shop'\nimport { StatApi } from '@/api/v1/stat/shop'\nimport Vue from 'vue'\n\ninterface User {\n  id?: string\n  name?: string\n  avatar?: string\n  mobile?: string\n}\ninterface Brand {\n  id?: string\n  name?: string\n  logo?: string\n  /**\n   * 私教课程定价模式 1、教练统一定价 2、教练分级定价\n   */\n  priceModel?: number\n  /**\n   * 私教课程售卖模式 1、教练谈单 2、统一标价\n   */\n  saleModel?: number\n  /**\n   * 品牌版本 studio 工作室 club 俱乐部 new_studio 新工作室(封闭会员卡|合同功能的版本)\n   */\n  version: 'club' | 'old_studio' | 'studio'\n}\n\ninterface Shop {\n  id?: string\n  name?: string\n  logo?: string\n}\n\n/**\n * 用户的全局初始信息\n */\n@Injectable()\nexport class UserService {\n  firstInited$ = new State(false)\n\n  user$ = new State<User>({})\n  brand$ = new State<Brand>({})\n  shop$ = new State<Shop>({})\n  // 用户的插件状态\n  pluginStatus$ = new State<any>({})\n  shopList$ = new State<any[]>([])\n  staffList$ = new State<any[]>([])\n  menuData$ = new State<any>({\n    favorite: [],\n    menus: [],\n    first_url: ''\n  })\n  config$ = new State({})\n  isShop$ = new Computed(this.shop$.pipe(map(shop => !!shop.id)))\n  menus$ = new Computed<any[]>(this.menuData$.pipe(pluck('menus')))\n  firstMenuUrl$ = new Computed<string>(this.menuData$.pipe(pluck('first_url')))\n  favoriteMenu$ = new Computed(this.menuData$.pipe(pluck('favorite')))\n  /**\n   * 使用版本 club 俱乐部 studio\n   */\n  useVersion$ = new Computed(\n    this.brand$.pipe(\n      map(brand => {\n        return {\n          club: 'club',\n          old_studio: 'studio',\n          studio: 'studio'\n        }[brand.version]\n      })\n    )\n  )\n  /**\n   * 标准工作室版本\n   */\n  isBrandStudio$ = new Computed(\n    this.brand$.pipe(map(brand => !!(brand.version === 'studio')))\n  )\n\n  isThemeClub$ = new Computed(\n    this.useVersion$.pipe(map(useVersion => useVersion === 'club'))\n  )\n  isThemeStudio$ = new Computed(\n    this.useVersion$.pipe(map(useVersion => useVersion === 'studio'))\n  )\n\n  theme$ = new Computed(\n    this.useVersion$.pipe(\n      map(useVersion => {\n        return `theme-${useVersion}`\n      })\n    )\n  )\n  // 枚举对象\n  enums$ = new State({})\n  // 禁用的 tooltips\n  invalidTooltips$ = new State([])\n\n  urlData$ = new State({})\n  constructor(\n    private constApi: ConstApi,\n    private menuApi: MenuApi,\n    private staffApi: StaffApi,\n    private tooltipApi: TooltipApi,\n    private shopApi: ShopApi,\n    private statApi: StatApi\n  ) {}\n  SET_USER(staff: any) {\n    const info = staff.info\n    this.user$.commit(user => {\n      user.id = info.staff_id\n      user.name = info.staff_name\n      user.avatar = info.staff_avatar\n      user.mobile = info.mobile\n    })\n  }\n  SET_BRAND(staff: any) {\n    const info = staff.info\n    this.brand$.commit(brand => {\n      brand.id = info.brand_id\n      brand.name = info.brand_name\n      brand.logo = info.brand_logo\n      brand.priceModel = info.price_model\n      brand.saleModel = info.sale_model\n      brand.version = info.brand_version\n    })\n  }\n  SET_SHOP(staff: any) {\n    const info = staff.info\n    this.shop$.commit(shop => {\n      shop.id = info.shop_id\n      shop.name = info.shop_name\n      shop.logo = info.shop_logo\n    })\n  }\n  SET_PLUGIN_STATUS(staff) {\n    const info = staff.info\n    this.pluginStatus$.commit(status => {\n      status.pointActivityAtatus = info.point_activity_status\n    })\n  }\n  SET_ENUMS(enums: any) {\n    this.enums$.commit(() => enums)\n  }\n  SET_CONFIG(config: any) {\n    this.config$.commit(() => config)\n  }\n  SET_MENU_DATA(menuData: any) {\n    this.menuData$.commit(() => menuData)\n  }\n  SET_INVALID_TOOLTIP(res: any) {\n    this.invalidTooltips$.commit(() => res.list)\n  }\n  SET_SHOP_LIST(res: any) {\n    this.shopList$.commit(() => res.list)\n  }\n  SET_STAFF_LIST(res: any) {\n    this.staffList$.commit(() => res.list)\n  }\n  fetchStaffInfo() {\n    return this.staffApi.getGlobalStaffInfo().pipe(\n      tap((res: any) => {\n        this.SET_BRAND(res)\n        this.SET_USER(res)\n        this.SET_SHOP(res)\n        this.SET_PLUGIN_STATUS(res)\n      })\n    )\n  }\n  fetchEnums() {\n    return this.constApi.getEnum().pipe(\n      tap(res => {\n        this.SET_ENUMS(res)\n        this.SET_CONFIG(get(res, 'version_conf.documents.value', {}))\n      })\n    )\n  }\n  fetchMenuData() {\n    return this.menuApi.getList().pipe(\n      tap(res => {\n        this.SET_MENU_DATA(res)\n      })\n    )\n  }\n  fetchInvalidTooltips() {\n    return this.tooltipApi.getInvalid().pipe(\n      tap((res: any) => {\n        this.SET_INVALID_TOOLTIP(res)\n      })\n    )\n  }\n  fetchShopList() {\n    return this.shopApi.getShopList().pipe(\n      tap(res => {\n        this.SET_SHOP_LIST(res)\n      })\n    )\n  }\n  fetchStaffList(query: any) {\n    return this.statApi.getStaffList(query).pipe(\n      tap(res => {\n        this.SET_STAFF_LIST(res)\n      })\n    )\n  }\n  private getOptions(enums: any, key: string, labelField = 'label') {\n    const enumObj = get(enums, key)\n    if (!enumObj) {\n      return []\n    } else {\n      return reduce(\n        enumObj.value,\n        (res: any[], item: any, index: string | number) => {\n          if (isPlainObject(item)) {\n            return res.concat([item])\n          }\n          return res.concat([\n            {\n              [labelField]: item,\n              value: +index\n            }\n          ])\n        },\n        []\n      )\n    }\n  }\n\n  /**\n   * 通过key名获取下拉选项\n   * @example\n   * getOptions$('member.card_consume_type') => Observable([{label:'次卡',value:1},{label:'期限卡',2}])\n   */\n  public getOptions$(\n    key: string,\n    options: {\n      addAll?: boolean | string\n      labelField?: string\n    } = {}\n  ): Computed<{ label: string; value: number }[]> {\n    return computed(\n      (enums: any) => {\n        let opts = this.getOptions(enums, key, options.labelField)\n        if (options.addAll) {\n          const allLabel = options.addAll === true ? '全部' : options.addAll\n          opts = [\n            { value: -1, [options.labelField || 'label']: allLabel }\n          ].concat(opts)\n        }\n        console.log(opts)\n        return opts\n      },\n      [this.enums$]\n    )\n  }\n  /**\n   * 通过对象获取一组枚举值\n   * @param map\n   */\n  public getOptionsMap$(map: Dictionary<string>) {\n    return computed(\n      (enums: any) => {\n        return mapValues(map, enumKey => this.getOptions(enums, enumKey))\n      },\n      [this.enums$]\n    )\n  }\n  /**\n   * 获取set对象\n   * @param path\n   */\n  public getEnumValue$(path: string) {\n    return new State(get(this.enums$.snapshot(), `${path}.value`))\n  }\n  /**\n   * 新增到常用菜单\n   * @param id\n   */\n  public addFavorite(id: number) {\n    return this.menuApi.addFavorite(id)\n  }\n  /**\n   * 删除常用菜单\n   * @param id\n   */\n  public delFavorite(id: number) {\n    return this.menuApi.delFavorite(id)\n  }\n  public c(key: string): string {\n    return get(this.config$.snapshot(), key, key)\n  }\n  public interpolation(title: string): string {\n    if (!title) {\n      return ''\n    }\n    const vm: any = new Vue({\n      template: '<span>' + title + '</span>'\n    }).$mount()\n    return vm.$el.innerText\n  }\n}\n"],"sourceRoot":""}]}