{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/product/package/component#/form.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/product/package/component#/form.vue","mtime":1600221940167},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { PatternService } from '@/services/pattern.service'\nimport ReserveIsLimit from './reserveIsLimit'\nimport { ruleOptions } from './form.config'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport SelectShop from '@/views/fragments/shop/select-shop'\nimport StImageUpload from '@/views/components/image-upload#/image-upload.vue'\nimport { FormService } from './form.service'\nimport moment from 'moment'\nimport { SHOP_RANGE, SHELF_STATUS } from '@/constants/course/package.ts'\nimport { cloneDeep, intersection } from 'lodash-es'\nexport default {\n  name: 'BrandPackageAdd',\n  bem: {\n    b: 'brand-package-add'\n  },\n  components: {\n    SelectShop,\n    StEditor,\n    ReserveIsLimit,\n    StImageUpload\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      formService: FormService\n    }\n  },\n  rxState() {\n    const {\n      supportSales$,\n      unitList$,\n      auth$,\n      transferUnitList$,\n      sellTypeList$\n    } = this.formService\n    return { supportSales$, unitList$, auth$, transferUnitList$, sellTypeList$ }\n  },\n  props: {\n    initInfo: {\n      type: Object,\n      default: () => {\n        return {}\n      }\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    }\n  },\n  watch: {\n    content(newValue) {\n      if (newValue && newValue.length > 10000) {\n        this.validateIntro = '输入字数不能超过10000， 请减少输入'\n      } else {\n        this.validateIntro = ''\n      }\n    },\n    fileList: {\n      handler: function(newValue, oldValue) {\n        if (!newValue.length) {\n          this.validateImage = '请上传封面'\n        } else {\n          this.validateImage = ''\n        }\n      },\n      deep: true\n    },\n    userShopList: {\n      handler: function(newValue, oldValue) {\n        if (intersection(newValue, oldValue).length !== oldValue.length) {\n          this.$emit('rest-use-shop')\n        }\n        this.$emit('use-shop', {\n          use_range: this.userRange,\n          use_shop_list: this.useShopIds\n        })\n      },\n      deep: true\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      SHOP_RANGE,\n      SHELF_STATUS,\n      moment,\n      validateIntro: '',\n      validateUseShop: '',\n      validateSaleShop: '',\n      form,\n      decorators,\n      isTransfer: false,\n      validateImage: '',\n      transfer: {\n        transfer_unit: 1,\n        is_allow_transfer: 0\n      },\n      packageData: {\n        transfer_unit: 1,\n        is_allow_transfer: 0,\n        sale_mode: [1]\n      },\n      reserveIsLimitOptions: [\n        { label: '不限制', value: 0 },\n        { label: '限制', value: 1 }\n      ],\n      useShopIds: [],\n      saleShopIds: [],\n      image: {},\n      content: '',\n      imageErrorText: '',\n      fileList: [],\n      saleDate: [null, null],\n      cropperModal: {},\n      reserveIsLimitInfo: {},\n      userRange: 3,\n      saleRange: 3,\n      // 支持使用门店\n      userShopList: [],\n      // 支持售卖门店\n      saleShopList: [],\n      // 备注\n      remarks: ''\n    }\n  },\n  methods: {\n    getFormdata(values) {\n      const obj = cloneDeep(values) || {}\n      console.log('this.image', this.image)\n      // 处理售卖时间\n      if (obj.saleDate && obj.saleDate.length) {\n        obj.start_time =\n          typeof obj.saleDate[0] === 'string'\n            ? obj.saleDate[0]\n            : obj.saleDate[0].format('YYYY-MM-DD')\n        obj.end_time =\n          typeof obj.saleDate[1] === 'string'\n            ? obj.saleDate[1]\n            : obj.saleDate[1].format('YYYY-MM-DD')\n        delete obj.saleDate\n      }\n\n      // 门店返回时，是对象。新增的时候是数组\n      const form = {\n        ...obj,\n        is_allow_transfer: +this.isTransfer,\n        remarks: this.remarks,\n        intro: this.content,\n        image: this.image,\n        sale_shop_list: this.saleShopList.map(item =>\n          typeof item === 'object' ? item.shop_id : item\n        ),\n        use_shop_list: this.userShopList.map(item =>\n          typeof item === 'object' ? item.shop_id : item\n        )\n      }\n      return form\n    },\n    validate() {\n      if (\n        this.useRange === SHOP_RANGE.SPECIFIED_STORE &&\n        !this.userShopList.length\n      ) {\n        this.validateUseShop = '请选择使用门店'\n      }\n      if (\n        this.saleRange === SHOP_RANGE.SPECIFIED_STORE &&\n        !this.saleShopList.length\n      ) {\n        this.validateUseShop = '请选择售卖门店'\n      }\n      if (!this.fileList.length) {\n        this.imageErrorText = '请上传封面'\n      } else {\n        this.imageErrorText = ''\n      }\n      return this.validateIntro || this.validateUseShop || this.validateSaleShop\n    },\n    onSave() {\n      if (this.validate()) return\n      this.form.validate().then(values => {\n        this.$emit('submit-form', this.getFormdata(values))\n      })\n    },\n    onSaveAndOnShelf() {\n      if (this.validate()) return\n      this.form.validate().then(values => {\n        this.$emit('up', this.getFormdata(values))\n      })\n    },\n    onUserShopChange(event) {\n      this.$emit('rest-use-shop')\n      this.userRange = event.target.value\n    },\n    onSaleShopChange(event) {\n      this.saleRange = event.target.value\n    },\n    getUserShopFormItem(userShopList) {\n      this.userShopList = userShopList\n      this.useShopIds = userShopList\n    },\n    getSaleShopFormItem(saleShopList) {\n      this.saleShopList = saleShopList\n    },\n    onSaleDate() {},\n    transferUnitChange(unit) {\n      this.transfer.transfer_unit = unit\n    },\n    onTransferChange(event) {\n      // console.log(event)\n    },\n    onChangeEditor() {\n      console.log('富文本编辑')\n    },\n    fileChange(data) {\n      if (data.length) {\n        // 上传\n        this.image.image_id = data[0].image_id\n        this.image.image_key = data[0].image_key\n        this.imageIsNone = false\n        this.imageErrorText = ''\n      } else {\n        // 删除\n        this.image.image_id = null\n        this.image.image_key = ''\n        this.imageIsNone = true\n        this.imageErrorText = '请上传封面'\n      }\n    }\n  },\n  created() {\n    this.fileList = this.initInfo.image ? [this.initInfo.image] : []\n    this.content = this.initInfo.intro\n    this.remarks = this.initInfo.remarks\n    this.isTransfer = !!this.initInfo.is_allow_transfer\n    this.transfer.transfer_unit = this.initInfo.transfer_unit\n    this.saleRange = this.initInfo.sale_range\n    this.userRange = this.initInfo.use_range\n    if (this.initInfo.sale_shop_list && this.initInfo.sale_shop_list.length) {\n      this.saleShopIds = this.initInfo.sale_shop_list.map(item => item.shop_id)\n      // 支持售卖门店\n      this.saleShopList = this.initInfo.sale_shop_list\n    }\n    if (this.initInfo.use_shop_list && this.initInfo.use_shop_list.length) {\n      this.userShopList = this.initInfo.use_shop_list\n      this.useShopIds = this.initInfo.use_shop_list.map(item => item.shop_id)\n    }\n  }\n}\n",{"version":3,"sources":["form.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"form.vue","sourceRoot":"src/views/pages/brand/product/package/component#","sourcesContent":["<template>\n  <div :class=\"b()\">\n    <a-alert\n      v-if=\"isEdit && initInfo.up_shelf_num\"\n      :message=\"\n        `${initInfo.up_shelf_num}家门店上架中，若需修改全部信息，请下架后编辑`\n      \"\n      banner\n    />\n    <st-panel :class=\"b('form-wapper')\" app>\n      <st-form :form=\"form\">\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"8\" :xs=\"11\" :offset=\"1\">\n            <st-form-item label=\"课程包名称\" labelWidth=\"118px\" required>\n              <a-input\n                v-decorator=\"decorators.course_name\"\n                :disabled=\"!!initInfo.course_name\"\n                placeholder=\"请输入课程包名称\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"16\" :xs=\"22\" :offset=\"1\">\n            <slot name=\"range\"></slot>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"8\" :xs=\"11\" :offset=\"1\">\n            <st-form-item label=\"支持使用人数\" labelWidth=\"118px\" required>\n              <st-input-number\n                :min=\"1\"\n                :max=\"20\"\n                style=\"width: 110px\"\n                v-decorator=\"decorators.support_num\"\n                placeholder=\"请输入支持使用人数\"\n              />\n              <span class=\"mg-l8\">限定20人</span>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\" :xs=\"22\" :offset=\"1\">\n            <st-form-item label=\"支持使用门店\" labelWidth=\"118px\" required>\n              <div v-if=\"initInfo.use_range === 1\">\n                {{ initInfo.shop_name }}\n              </div>\n              <a-radio-group\n                v-else\n                @change=\"onUserShopChange\"\n                v-decorator=\"decorators.use_range\"\n                :options=\"supportSales$\"\n              ></a-radio-group>\n              <div class=\"brand-range-shop\" v-if=\"userRange === 2\">\n                <p class=\"brand-range-shop__describe\">\n                  设置支持此课程包使用门店范围\n                </p>\n                <select-shop\n                  @change=\"getUserShopFormItem\"\n                  :shopIds=\"useShopIds\"\n                ></select-shop>\n                <span\n                  v-if=\"!userShopList.length\"\n                  style=\"color: red;font-size: 12px\"\n                >\n                  {{ validateUseShop }}\n                </span>\n              </div>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\" :offset=\"1\">\n            <st-form-item label=\"上课范围\" labelWidth=\"118px\" required>\n              <slot name=\"courseRange\" :decorators=\"decorators\"></slot>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <portal-target name=\"BRAND_PACKAGE_FORM_TOTAL\"></portal-target>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\" :xs=\"22\" :offset=\"1\">\n            <st-form-item\n              class=\"page-content-card-support-sales mg-t4\"\n              label=\"支持售卖门店\"\n              labelWidth=\"118px\"\n              required\n            >\n              <div v-if=\"initInfo.sale_range === SHOP_RANGE.SINGLE_STORE\">\n                {{ initInfo.shop_name }}\n              </div>\n              <a-radio-group\n                v-else\n                @change=\"onSaleShopChange\"\n                v-decorator=\"decorators.sale_range\"\n                :disabled=\"initInfo.shelf_status === SHELF_STATUS.UP\"\n                :options=\"supportSales$\"\n              />\n\n              <div\n                class=\"brand-range-shop\"\n                v-if=\"saleRange === SHOP_RANGE.SPECIFIED_STORE\"\n              >\n                <p class=\"brand-range-shop__describe\">\n                  设置支持此课程包售卖门店范围\n                </p>\n                <select-shop\n                  :shopIds=\"saleShopIds\"\n                  :disabled=\"this.initInfo.shelf_status === SHELF_STATUS.UP\"\n                  @change=\"getSaleShopFormItem\"\n                ></select-shop>\n                <span\n                  v-if=\"!saleShopList.length\"\n                  style=\"color: red;font-size: 12px\"\n                >\n                  {{ validateUseShop }}\n                </span>\n              </div>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"8\" :xs=\"11\" :offset=\"1\">\n            <st-form-item\n              labelWidth=\"118px\"\n              class=\"page-content-card-support-sales mg-t4\"\n              label=\"售卖价格\"\n              required\n            >\n              <st-input-number\n                :min=\"0\"\n                placeholder=\"请输入售卖价格\"\n                :max=\"999999.9\"\n                v-decorator=\"decorators.price\"\n                :float=\"true\"\n              >\n                <template slot=\"addonAfter\">\n                  元\n                </template>\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <reserve-is-limit\n          labelWidth=\"118px\"\n          :decorators=\"decorators\"\n          :reserveIsLimitInfo=\"reserveIsLimitInfo\"\n        />\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"14\" :xs=\"22\" :offset=\"1\">\n            <st-form-item\n              labelWidth=\"118px\"\n              class=\"page-content-card-support-sales mg-t4\"\n              label=\"支持售卖时间\"\n              required\n            >\n              <st-range-picker\n                :disabledDays=\"10950\"\n                @change=\"onSaleDate\"\n                :options=\"{\n                  start: {\n                    disable: initInfo.shelf_status === SHELF_STATUS.UP,\n                    disabledBegin: moment().format('YYYY-MM-DD')\n                  }\n                }\"\n                v-decorator=\"decorators.saleDate\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"8\" :xs=\"11\" :offset=\"1\">\n            <st-form-item labelWidth=\"118px\" label=\"有效时间\" required>\n              <st-input-number\n                placeholder=\"请输入有效时间\"\n                v-decorator=\"decorators.valid_time\"\n                :min=\"1\"\n                :max=\"99999\"\n              >\n                <a-select\n                  slot=\"addonAfter\"\n                  v-decorator=\"decorators.valid_time_unit\"\n                  style=\"width: 60px\"\n                  :options=\"unitList$\"\n                />\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"8\" :xs=\"11\" :offset=\"1\">\n            <st-form-item\n              labelWidth=\"118px\"\n              class=\"page-content-card-support-sales mg-t4\"\n              label=\"允许冻结天数\"\n              required\n            >\n              <st-input-number\n                placeholder=\"请输入允许冻结天数\"\n                :min=\"1\"\n                v-decorator=\"decorators.frozen_days\"\n                :max=\"99999\"\n              >\n                <span slot=\"addonAfter\" style=\"width: 60px\">\n                  天\n                </span>\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"16\" :xs=\"22\" :offset=\"1\">\n            <div :class=\"b('transfer')\">\n              <st-form-item\n                label=\"转让设置\"\n                labelWidth=\"118px\"\n                :required=\"isTransfer\"\n              >\n                <a-checkbox\n                  v-model=\"isTransfer\"\n                  @change=\"onTransferChange($event, 'transfer')\"\n                >\n                  支持转让\n                </a-checkbox>\n              </st-form-item>\n              <st-form-item label=\"\" v-if=\"isTransfer\" required>\n                <st-input-number\n                  :min=\"0\"\n                  :max=\"transfer.transfer_unit === 1 ? 100 : 999999.9\"\n                  :float=\"transfer.transfer_unit === 2\"\n                  :class=\"b('transfer-input')\"\n                  v-decorator=\"decorators.transfer_rate\"\n                  style=\"padding-right:0;\"\n                >\n                  <a-select\n                    slot=\"addonAfter\"\n                    v-decorator=\"decorators.transfer_unit\"\n                    @change=\"transferUnitChange\"\n                    :options=\"transferUnitList$\"\n                    style=\"width: 60px\"\n                  ></a-select>\n                </st-input-number>\n              </st-form-item>\n            </div>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"16\" :xs=\"22\" :offset=\"1\">\n            <st-form-item label=\"售卖方式\" labelWidth=\"118px\" required>\n              <a-checkbox-group\n                v-decorator=\"decorators.sale_mode\"\n                :options=\"sellTypeList$\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"11\" :offset=\"1\">\n            <st-form-item\n              :help=\"imageErrorText\"\n              label=\"封面\"\n              labelWidth=\"118px\"\n              required\n            >\n              <div :class=\"b('upload')\">\n                <st-image-upload\n                  :class=\"b('st-upload')\"\n                  v-decorator=\"decorators.image\"\n                  :cropperModal=\"cropperModal\"\n                  :sizeLimit=\"1\"\n                  :list=\"fileList\"\n                  @change=\"fileChange\"\n                >\n                  <i :class=\"b('st-upload-icon')\"></i>\n                  <div :class=\"b('st-upload-text')\">上传封面</div>\n                </st-image-upload>\n                <div :class=\"b('upload-describe')\">\n                  <p>\n                    图片格式必须为:png,bmp,jpeg,jpg,gif,建议使用png格式图片,以保存最佳效果\n                  </p>\n                  <p>建议尺寸为750像素X422像素,不可大于2m</p>\n                </div>\n              </div>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"14\" :xs=\"24\" :offset=\"1\">\n            <st-form-item\n              labelWidth=\"118px\"\n              class=\"page-content-card-support-sales mg-t4\"\n              label=\"课程包介绍\"\n            >\n              <st-editor @input=\"onChangeEditor\" v-model=\"content\"></st-editor>\n              <span style=\"color: red;font-size: 12px\">\n                {{ validateIntro }}\n              </span>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"14\" :xs=\"24\" :offset=\"1\">\n            <st-form-item\n              labelWidth=\"118px\"\n              class=\"page-content-card-support-sales mg-t4\"\n              label=\"备注\"\n            >\n              <st-textarea\n                v-model=\"remarks\"\n                maxlength=\"500\"\n                placeholder=\"请输入备注\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"16\" :xs=\"22\" :offset=\"1\">\n            <st-form-item labelWidth=\"118px\" label=\" \">\n              <st-button type=\"primary\" @click=\"onSave\">\n                保存\n              </st-button>\n              <st-button\n                v-if=\"!isEdit\"\n                class=\"mg-l16\"\n                :disabled=\"!auth$.up\"\n                @click=\"onSaveAndOnShelf\"\n              >\n                保存并上架\n              </st-button>\n            </st-form-item>\n          </a-col>\n        </a-row>\n      </st-form>\n    </st-panel>\n  </div>\n</template>\n\n<script>\nimport { PatternService } from '@/services/pattern.service'\nimport ReserveIsLimit from './reserveIsLimit'\nimport { ruleOptions } from './form.config'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport SelectShop from '@/views/fragments/shop/select-shop'\nimport StImageUpload from '@/views/components/image-upload#/image-upload.vue'\nimport { FormService } from './form.service'\nimport moment from 'moment'\nimport { SHOP_RANGE, SHELF_STATUS } from '@/constants/course/package.ts'\nimport { cloneDeep, intersection } from 'lodash-es'\nexport default {\n  name: 'BrandPackageAdd',\n  bem: {\n    b: 'brand-package-add'\n  },\n  components: {\n    SelectShop,\n    StEditor,\n    ReserveIsLimit,\n    StImageUpload\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      formService: FormService\n    }\n  },\n  rxState() {\n    const {\n      supportSales$,\n      unitList$,\n      auth$,\n      transferUnitList$,\n      sellTypeList$\n    } = this.formService\n    return { supportSales$, unitList$, auth$, transferUnitList$, sellTypeList$ }\n  },\n  props: {\n    initInfo: {\n      type: Object,\n      default: () => {\n        return {}\n      }\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    }\n  },\n  watch: {\n    content(newValue) {\n      if (newValue && newValue.length > 10000) {\n        this.validateIntro = '输入字数不能超过10000， 请减少输入'\n      } else {\n        this.validateIntro = ''\n      }\n    },\n    fileList: {\n      handler: function(newValue, oldValue) {\n        if (!newValue.length) {\n          this.validateImage = '请上传封面'\n        } else {\n          this.validateImage = ''\n        }\n      },\n      deep: true\n    },\n    userShopList: {\n      handler: function(newValue, oldValue) {\n        if (intersection(newValue, oldValue).length !== oldValue.length) {\n          this.$emit('rest-use-shop')\n        }\n        this.$emit('use-shop', {\n          use_range: this.userRange,\n          use_shop_list: this.useShopIds\n        })\n      },\n      deep: true\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      SHOP_RANGE,\n      SHELF_STATUS,\n      moment,\n      validateIntro: '',\n      validateUseShop: '',\n      validateSaleShop: '',\n      form,\n      decorators,\n      isTransfer: false,\n      validateImage: '',\n      transfer: {\n        transfer_unit: 1,\n        is_allow_transfer: 0\n      },\n      packageData: {\n        transfer_unit: 1,\n        is_allow_transfer: 0,\n        sale_mode: [1]\n      },\n      reserveIsLimitOptions: [\n        { label: '不限制', value: 0 },\n        { label: '限制', value: 1 }\n      ],\n      useShopIds: [],\n      saleShopIds: [],\n      image: {},\n      content: '',\n      imageErrorText: '',\n      fileList: [],\n      saleDate: [null, null],\n      cropperModal: {},\n      reserveIsLimitInfo: {},\n      userRange: 3,\n      saleRange: 3,\n      // 支持使用门店\n      userShopList: [],\n      // 支持售卖门店\n      saleShopList: [],\n      // 备注\n      remarks: ''\n    }\n  },\n  methods: {\n    getFormdata(values) {\n      const obj = cloneDeep(values) || {}\n      console.log('this.image', this.image)\n      // 处理售卖时间\n      if (obj.saleDate && obj.saleDate.length) {\n        obj.start_time =\n          typeof obj.saleDate[0] === 'string'\n            ? obj.saleDate[0]\n            : obj.saleDate[0].format('YYYY-MM-DD')\n        obj.end_time =\n          typeof obj.saleDate[1] === 'string'\n            ? obj.saleDate[1]\n            : obj.saleDate[1].format('YYYY-MM-DD')\n        delete obj.saleDate\n      }\n\n      // 门店返回时，是对象。新增的时候是数组\n      const form = {\n        ...obj,\n        is_allow_transfer: +this.isTransfer,\n        remarks: this.remarks,\n        intro: this.content,\n        image: this.image,\n        sale_shop_list: this.saleShopList.map(item =>\n          typeof item === 'object' ? item.shop_id : item\n        ),\n        use_shop_list: this.userShopList.map(item =>\n          typeof item === 'object' ? item.shop_id : item\n        )\n      }\n      return form\n    },\n    validate() {\n      if (\n        this.useRange === SHOP_RANGE.SPECIFIED_STORE &&\n        !this.userShopList.length\n      ) {\n        this.validateUseShop = '请选择使用门店'\n      }\n      if (\n        this.saleRange === SHOP_RANGE.SPECIFIED_STORE &&\n        !this.saleShopList.length\n      ) {\n        this.validateUseShop = '请选择售卖门店'\n      }\n      if (!this.fileList.length) {\n        this.imageErrorText = '请上传封面'\n      } else {\n        this.imageErrorText = ''\n      }\n      return this.validateIntro || this.validateUseShop || this.validateSaleShop\n    },\n    onSave() {\n      if (this.validate()) return\n      this.form.validate().then(values => {\n        this.$emit('submit-form', this.getFormdata(values))\n      })\n    },\n    onSaveAndOnShelf() {\n      if (this.validate()) return\n      this.form.validate().then(values => {\n        this.$emit('up', this.getFormdata(values))\n      })\n    },\n    onUserShopChange(event) {\n      this.$emit('rest-use-shop')\n      this.userRange = event.target.value\n    },\n    onSaleShopChange(event) {\n      this.saleRange = event.target.value\n    },\n    getUserShopFormItem(userShopList) {\n      this.userShopList = userShopList\n      this.useShopIds = userShopList\n    },\n    getSaleShopFormItem(saleShopList) {\n      this.saleShopList = saleShopList\n    },\n    onSaleDate() {},\n    transferUnitChange(unit) {\n      this.transfer.transfer_unit = unit\n    },\n    onTransferChange(event) {\n      // console.log(event)\n    },\n    onChangeEditor() {\n      console.log('富文本编辑')\n    },\n    fileChange(data) {\n      if (data.length) {\n        // 上传\n        this.image.image_id = data[0].image_id\n        this.image.image_key = data[0].image_key\n        this.imageIsNone = false\n        this.imageErrorText = ''\n      } else {\n        // 删除\n        this.image.image_id = null\n        this.image.image_key = ''\n        this.imageIsNone = true\n        this.imageErrorText = '请上传封面'\n      }\n    }\n  },\n  created() {\n    this.fileList = this.initInfo.image ? [this.initInfo.image] : []\n    this.content = this.initInfo.intro\n    this.remarks = this.initInfo.remarks\n    this.isTransfer = !!this.initInfo.is_allow_transfer\n    this.transfer.transfer_unit = this.initInfo.transfer_unit\n    this.saleRange = this.initInfo.sale_range\n    this.userRange = this.initInfo.use_range\n    if (this.initInfo.sale_shop_list && this.initInfo.sale_shop_list.length) {\n      this.saleShopIds = this.initInfo.sale_shop_list.map(item => item.shop_id)\n      // 支持售卖门店\n      this.saleShopList = this.initInfo.sale_shop_list\n    }\n    if (this.initInfo.use_shop_list && this.initInfo.use_shop_list.length) {\n      this.userShopList = this.initInfo.use_shop_list\n      this.useShopIds = this.initInfo.use_shop_list.map(item => item.shop_id)\n    }\n  }\n}\n</script>\n"]}]}