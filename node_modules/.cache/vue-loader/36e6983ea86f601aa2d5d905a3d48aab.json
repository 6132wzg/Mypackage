{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/lottery/add.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/lottery/add.vue","mtime":1598250255831},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { MessageService } from '@/services/message.service'\nimport { AddService } from './add.service'\nimport H5Container from '@/views/biz-components/h5/h5-container'\nimport Steps from './components#/step'\nimport { ruleOptions } from './form.config.ts'\nimport { PatternService } from '@/services/pattern.service'\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nimport BrandMarketingPluginAddPrize from '@/views/biz-modals/brand/marketing/plugin/add-prize'\nimport { cloneDeep } from 'lodash-es'\nimport 'swiper/dist/css/swiper.css'\nimport { swiper, swiperSlide } from 'vue-awesome-swiper'\nimport {\n  TIMES_TYPE,\n  CROWD_TYPE,\n  SHARE_TYPE,\n  STOP_SWIPER,\n  ACTIVITY_STATUS,\n  NOT_PRIZE_IMG_TYPE\n} from '@/constants/marketing/lottery'\n\nexport default {\n  name: 'PluginLotteryAdd',\n  data(vm) {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      TIMES_TYPE,\n      CROWD_TYPE,\n      SHARE_TYPE,\n      STOP_SWIPER,\n      ACTIVITY_STATUS,\n      NOT_PRIZE_IMG_TYPE,\n      columsTitlelist: [\n        '奖品名称',\n        '奖品类型',\n        '可用门店（家）',\n        '奖品数量（个）',\n        '中奖概率 (%)',\n        '操作'\n      ],\n      info: {},\n      preview: {\n        title: '',\n        startTime: '',\n        endTime: '',\n        perTimes: 0,\n        totalTimes: 0,\n        description: ''\n      },\n      shareTitle: '',\n      fileList: [],\n      fileShareList: [],\n      prizeList: [],\n      timesType: TIMES_TYPE.DEFAULT,\n      crowdType: CROWD_TYPE.DEFAULT,\n      shareType: SHARE_TYPE.DEFAULT,\n      isStopSwiper: STOP_SWIPER.DEFAULT,\n      stepArr: [\n        {\n          title: '基础信息',\n          key: 1\n        },\n        {\n          title: '抽奖规则',\n          key: 2\n        },\n        {\n          title: '奖项设置',\n          key: 3\n        }\n      ],\n      currentIndex: 0,\n      curPrizeIndex: -1,\n      notPrizeImgType: NOT_PRIZE_IMG_TYPE.DEFAULT,\n      dateRangeVal: [],\n      notPrize: {\n        prize_name: '未中奖',\n        prize: {\n          image_url: ''\n        }\n      },\n      sliderOptions: {\n        autoplay: {\n          delay: 3000,\n          disableOnInteraction: false\n        }\n      },\n      swiperOption: {\n        spaceBetween: 6,\n        slidesPerView: 1.05\n      },\n      defaultValue: [moment().format('HH:mm'), moment('11:59', 'HH:mm')],\n      isShowEditTable: -1,\n      prizeRate: [],\n      prizeNum: [],\n      // 奖品顺序\n      prizeSort: [\n        [],\n        [],\n        [0, 1, 2, -1, 0, 1, 2, -1],\n        [0, -1, 1, -1, 2, -1, 3, -1],\n        [0, -1, 1, -1, 2, 3, 4, -1],\n        [0, 1, 2, -1, 3, 4, 5, -1],\n        [0, 1, 2, 3, 4, 5, 6, -1]\n      ]\n    }\n  },\n  bem: {\n    bPage: 'page-brand-marketing-plugin-lottery-add'\n  },\n  serviceInject() {\n    return {\n      addService: AddService,\n      pattern: PatternService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      drawCondition: this.addService.drawCondition$,\n      drawTimesType: this.addService.drawTimesType$,\n      invitePoster: this.addService.invitePoster$,\n      wheelDefault: this.addService.wheelDefault$,\n      wheelTurnAround: this.addService.wheelTurnAround$,\n      joinCrowdAll: this.addService.joinCrowdAll$,\n      crowd: this.addService.crowd$,\n      imgType: this.addService.imgType$,\n      prizeInfoList: this.addService.prizeInfoList$,\n      lucky: this.addService.lucky$,\n      prize: this.addService.prize$,\n      share: this.addService.share$\n    }\n  },\n  modals: {\n    BrandMarketingPluginAddPrize\n  },\n  components: {\n    H5Container,\n    Steps,\n    swiper,\n    swiperSlide,\n    StImageUpload\n  },\n  mounted() {\n    // this.notPrize.prize = this.lucky[0]\n    if (this.$searchQuery.activity_id) {\n      this.editVIew(this.$searchQuery.activity_id)\n    }\n  },\n  computed: {\n    deleteBtnStatus() {\n      return this.$searchQuery.activity_id && this.$searchQuery.status === 1\n    },\n    prizeListFilters(value) {\n      if (this.prizeList.length <= 2) {\n        return this.prizeList\n      }\n      return this.prizeSort[this.prizeList.length - 1].map((item, index) => {\n        if (item > -1) {\n          return this.prizeList[item]\n        } else {\n          return {\n            prize: {\n              image_url:\n                this.notPrizeImgType === this.NOT_PRIZE_IMG_TYPE.CUSTOM\n                  ? this.notPrize.prize.image_url\n                  : this.lucky[0].image_url\n            },\n            prize_name: this.notPrize.prize_name\n          }\n        }\n      })\n    }\n  },\n  methods: {\n    showEditTable(index) {\n      if (this.isShowEditTable === index) {\n        this.prizeList[index].number = this.prizeNum[index]\n        this.prizeList[index].rate = this.prizeRate[index]\n        this.isShowEditTable = -1\n      } else {\n        this.isShowEditTable = index\n      }\n    },\n    next(para) {\n      if (para.index) {\n        para = para.index - 1\n      }\n      if (para === 0) {\n        this.currentIndex = 0\n      }\n      if (para === 1) {\n        this.form\n          .validate([\n            'activity_base.activity_name',\n            'activity_base.activity_description',\n            'activity_base.wheel_turn_around',\n            'activity_base.wheel_share_default',\n            'activity_base.share_title',\n            'activity_base.activity_sub_name'\n          ])\n          .then(() => {\n            this.currentIndex = para\n          })\n      }\n      if (para === 2) {\n        this.form\n          .validate([\n            'activity_base.activity_name',\n            'activity_base.activity_description',\n            'activity_base.wheel_turn_around',\n            'activity_base.wheel_share_default',\n            'activity_base.share_title',\n            'activity_base.activity_sub_name',\n            'activity_rule.join_crowd_all',\n            'activity_rule.draw_condition',\n            'activity_rule.draw_times_type',\n            'activity_rule.per_times',\n            'activity_rule.total_times'\n          ])\n          .then(() => {\n            this.currentIndex = para\n          })\n      }\n    },\n    onChangeGetAvatar(imageFiles) {\n      this.fileList = cloneDeep(imageFiles)\n      this.notPrize.prize = this.fileList[0]\n    },\n    onShareChangeGetAvatar(imageFiles) {\n      this.fileShareList = cloneDeep(imageFiles)\n    },\n    onSubmit() {\n      this.form.validate().then(value => {\n        value.activity_base.start_time = this.preview.startTime\n        value.activity_base.end_time = this.preview.endTime\n        value.activity_base.share_title = this.shareTitle\n        // 选择自定义却不传图片\n        value.activity_base.share_bg =\n          this.shareType === SHARE_TYPE.CUSTOM\n            ? this.fileShareList[0] || this.share[0]\n            : this.share[0]\n        value.activity_prizes = this.prizeList\n        value.activity_lucky.lucky =\n          this.notPrizeImgType === NOT_PRIZE_IMG_TYPE.CUSTOM\n            ? this.fileList[0] || this.prize[0]\n            : this.lucky[0]\n        if (this.timesType === 1 && !value.activity_rule.per_times) {\n          this.messageService.warn({\n            content: '请填写抽奖次数'\n          })\n          return\n        }\n        if (this.timesType === 2 && !value.activity_rule.total_times) {\n          this.messageService.warn({\n            content: '请填写抽奖次数'\n          })\n          return\n        }\n        value.activity_rule.prize_sort = this.prizeSort[\n          this.prizeList.length - 1\n        ]\n        if (this.$searchQuery.activity_id) {\n          value.activity_id = this.$searchQuery.activity_id\n          this.addService.edit(value).subscribe(res => {\n            this.$router.push('./success?id=' + res.id)\n          })\n        } else {\n          this.addService.add(value).subscribe(res => {\n            this.$router.push('./success?id=' + res.id)\n          })\n        }\n      })\n    },\n    getTitle(e) {\n      this.preview.title = e.target.value\n    },\n    getName(e) {\n      this.notPrize.prize_name = e.target.value\n    },\n    getPerTimes(val) {\n      this.preview.perTimes = val\n    },\n    getTotalTimes(val) {\n      this.preview.totalTimes = val\n    },\n    getDescription(val) {\n      this.preview.description = val\n    },\n    // 抽奖次数类型\n    getCurTimesType(e) {\n      this.timesType = e.target.value\n    },\n    // 人群类型\n    getCurCrowdType(e) {\n      this.crowdType = e.target.value\n    },\n    // 分享类型\n    getCurShareType(e) {\n      this.shareType = e.target.value\n    },\n    // 轮播开关\n    stopSwiper(e) {\n      this.isStopSwiper = e.target.value\n    },\n    onDateChange(data, str) {\n      this.preview.startTime = str[0]\n      this.preview.endTime = str[1]\n    },\n    getNotImgType(e) {\n      this.notPrizeImgType = e.target.value\n    },\n    getPrizeInfo(val) {\n      if (this.curPrizeIndex > -1) {\n        this.prizeList.splice(this.curPrizeIndex, 1, val)\n      } else {\n        this.prizeList.push(val)\n        this.prizeRate.push(val.rate)\n        this.prizeNum.push(val.number)\n      }\n    },\n    getCurPrizeIndex(index) {\n      this.curPrizeIndex = index\n    },\n    disabledDate(current) {\n      return (\n        current && current.format('YYYY-MM-DD') < moment().format('YYYY-MM-DD')\n      )\n    },\n    onDelete(para) {\n      if (this.isShowEditTable === para) {\n        this.isShowEditTable = -1\n        return false\n      } else {\n        this.prizeRate.splice(para, 1)\n        this.prizeNum.splice(para, 1)\n      }\n      this.prizeList = this.prizeList.filter((item, index) => {\n        return index !== para\n      })\n    },\n    editTableNum(val, index) {\n      this.prizeNum[index] = val\n    },\n    editTableRate(val, index) {\n      this.prizeRate[index] = val\n    },\n    editVIew(id) {\n      return this.addService.editVIew(id).subscribe(res => {\n        this.info = res\n        this.form.setFieldsValue({\n          activity_base: res.activity_base,\n          activity_lucky: res.activity_lucky,\n          activity_prizes: res.activity_prizes,\n          activity_rule: res.activity_rule\n        })\n        this.dateRangeVal = [\n          moment(res.activity_base.start_time.trim()),\n          moment(res.activity_base.end_time.trim())\n        ]\n        this.prizeList = res.activity_prizes\n        res.activity_prizes.forEach((item, index) => {\n          this.prizeNum[index] = item.number\n          this.prizeRate[index] = item.rate\n        })\n        this.preview.startTime = res.activity_base.start_time\n        this.preview.endTime = res.activity_base.end_time\n        this.preview.perTimes = res.activity_rule.per_times\n        this.preview.totalTimes = res.activity_rule.total_times\n        this.preview.description = res.activity_base.activity_description\n        this.preview.title = res.activity_base.activity_sub_name\n        this.notPrize.prize_name = res.activity_lucky.lucky_name\n        this.shareType = res.activity_base.wheel_share_default\n        this.timesType = res.activity_rule.draw_times_type\n        this.isStopSwiper = res.activity_base.wheel_turn_around\n        this.notPrizeImgType = res.activity_lucky.image_default\n        this.shareTitle = res.activity_base.share_title\n        this.share[0].image_id = res.activity_base.share_bg.image_id\n        res.activity_lucky.lucky &&\n          (this.fileList[0] = res.activity_lucky.lucky)\n        this.fileShareList[0] = res.activity_base.share_bg\n        this.prize[0] = res.activity_lucky.lucky\n        if (this.notPrizeImgType === this.NOT_PRIZE_IMG_TYPE.CUSTOM) {\n          this.notPrize.prize = res.activity_lucky.lucky\n        } else {\n          this.notPrize.prize = this.lucky[0]\n        }\n      })\n    }\n  }\n}\n",null]}