{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/coupon/add.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/coupon/add.vue","mtime":1591147717304},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { UserService } from '@/services/user.service'\nimport { TitleService } from '@/services/title.service'\nimport moment from 'moment'\nimport { cloneDeep, remove, find as lodashFind } from 'lodash-es'\nimport { AddService } from './add.service'\nimport SelectShop from '@/views/fragments/shop/select-shop'\nimport H5Container from '@/views/biz-components/h5/h5-container'\nimport { ruleOptions } from './add.config'\nexport default {\n  name: 'BrandMarketingPluginCouponAdd',\n  serviceInject() {\n    return {\n      addService: AddService,\n      userService: UserService,\n      titleService: TitleService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.addService.loading$,\n      couponTypeOptions: this.addService.couponTypeOptions$,\n      isShopRangeOptions: this.addService.isShopRangeOptions$,\n      product_ranges: this.addService.product_ranges$\n    }\n  },\n  bem: {\n    basic: 'brand-marketing-coupon-add'\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      // isEditMode: false,\n      // form: this.$form.createForm(this),\n      // 优惠类型\n      couponType: 1,\n      // 优惠范围\n      showProductRange: '2',\n      // 门店范围\n      showShopRange: '2',\n      // 满足金额\n      fullPrice: '',\n      // 是否共享\n      isShare: false,\n      // 限领数量\n      personLimit: '',\n      // 已经选择的类目ids\n      rangeIds: [],\n      // 已经选择的门店ids\n      shopIds: [],\n      shopNames: ''\n    }\n  },\n  props: {\n    isEditMode: {\n      type: Boolean,\n      default: false\n    },\n    info: {\n      type: Object,\n      default: () => {}\n    }\n  },\n  created() {\n    if (this.isEditMode) {\n      this.setFieldsValue()\n    }\n  },\n  methods: {\n    limitChange(e) {\n      this.form.resetFields(['person_limit'])\n    },\n    userTypeChange(e) {\n      this.form.resetFields(['full_price'])\n    },\n    getValidDay(days) {\n      return moment()\n        .add(days, 'd')\n        .format('YYYY年MM月DD日 23:59')\n    },\n    getRange() {\n      let ranges = this.rangeIds.map(id => {\n        return lodashFind(this.product_ranges, { value: id }).label\n      })\n      return ranges\n    },\n    changeProductRange(event) {\n      this.rangeIds = event\n    },\n    onSelectShop(event) {\n      this.shopIds = event\n    },\n    checkThisLimitRadio() {\n      this.form.setFieldsValue({ is_limit: 2 })\n    },\n    setFieldsValue() {\n      this.couponType = this.info.coupon_type.id\n      this.showProductRange = this.info.is_product_range + ''\n      this.showShopRange = this.info.is_shop_range + ''\n      this.shopIds = this.info.shop_ids\n      this.rangeIds = this.info.range_ids\n      setTimeout(() => {\n        this.form.setFieldsValue({\n          coupon_name: this.info.coupon_name,\n          price: +this.info.price,\n          use_type: this.info.use_type,\n          full_price: +this.info.full_price || '',\n          number: this.info.number,\n          valid_days: this.info.valid_days,\n          is_share: this.info.is_share,\n          is_limit: this.info.is_limit,\n          person_limit: this.info.person_limit || ''\n        })\n      })\n    },\n    // 保存\n    onSubmit() {\n      this.form.validate().then(values => {\n        let params = {}\n        if (this.isEditMode) {\n          params.id = this.$searchQuery.id\n          params.before_number = this.info.number\n          params.after_number = values.number\n        } else {\n          params = {\n            coupon_type: this.couponType,\n            coupon_name: values.coupon_name,\n            price: values.price,\n            is_product_range: this.showProductRange,\n            range_ids: this.rangeIds,\n            is_shop_range: this.showShopRange,\n            shop_ids: this.shopIds,\n            use_type: values.use_type,\n            full_price: values.full_price,\n            number: values.number,\n            valid_days: values.valid_days,\n            is_share: values.is_share,\n            is_limit: values.is_limit,\n            person_limit: values.person_limit || undefined\n          }\n        }\n        if (this.isEditMode) {\n          this.addService.editMarketingCoupon(params).subscribe(res => {\n            // 编辑成功\n            this.$router.push({\n              path: '/brand/marketing/plugin/coupon/list'\n            })\n          })\n        } else {\n          this.addService.addMarketingCoupon(params).subscribe(res => {\n            // 新增成功\n            this.$router.push({\n              path: `/brand/marketing/plugin/coupon/list`\n            })\n          })\n        }\n      })\n    }\n  },\n  watch: {\n    shopIds(val) {\n      if (val && val.length) {\n        this.addService.getShopBasic({ shop_ids: val }).subscribe(res => {\n          this.shopNames = res.map(({ shop_name }) => shop_name).join('/')\n        })\n      }\n    }\n  },\n  components: {\n    SelectShop,\n    H5Container\n  }\n}\n",null]}