{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js??ref--13-3!/Users/wangzhigang/Desktop/styd/web/src/services/oss.service.ts","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/services/oss.service.ts","mtime":1591147717087},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js","mtime":1591062571609}],"contextDependencies":[],"result":["import \"core-js/modules/es6.reflect.construct\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es7.array.includes\";\nimport \"core-js/modules/es6.string.includes\";\nimport _classCallCheck from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/inherits\";\n\nfunction _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport { __decorate } from \"tslib\";\nimport { Injectable } from 'vue-service-app';\nimport { Subject } from 'rxjs';\nimport { ajax } from 'rxjs/ajax';\nimport { mergeMap, map } from 'rxjs/operators';\nimport { Api } from '@/api/api';\nvar typeSuffix = {\n  'image/png': '.png'\n};\n\nvar OssService = /*#__PURE__*/function (_Api) {\n  _inherits(OssService, _Api);\n\n  var _super = _createSuper(OssService);\n\n  function OssService() {\n    var _this;\n\n    _classCallCheck(this, OssService);\n\n    _this = _super.apply(this, arguments);\n    _this.BUSINESS_TYPES = ['image', 'face', 'file', 'excel'];\n    _this.typeSuffix = [{\n      type: 'image/png',\n      suffix: '.png'\n    }];\n    return _this;\n  }\n\n  _createClass(OssService, [{\n    key: \"put\",\n    value: function put(_ref) {\n      var _this2 = this;\n\n      var file = _ref.file,\n          _ref$business = _ref.business,\n          business = _ref$business === void 0 ? '' : _ref$business,\n          _ref$uploadProgress = _ref.uploadProgress,\n          uploadProgress = _ref$uploadProgress === void 0 ? function () {} : _ref$uploadProgress,\n          _ref$isPrivate = _ref.isPrivate,\n          isPrivate = _ref$isPrivate === void 0 ? false : _ref$isPrivate;\n\n      if (!this.BUSINESS_TYPES.includes(business)) {\n        throw new Error(\"[oss.service] \\u4E0A\\u4F20\\u6587\\u4EF6\\u5FC5\\u987B\\u4F7F\\u7528\\u4E1A\\u52A1\\u7C7B\\u578B \".concat(this.BUSINESS_TYPES, \" \\u4E4B\\u4E00\"));\n      }\n\n      return this.getOssPolicy(business, isPrivate).pipe(mergeMap(function (_ref2) {\n        var res = _ref2.policy_info;\n\n        var key = _this2.getKey(file);\n\n        var formData = new FormData();\n        var fileKey = \"\".concat(res.dir).concat(key);\n        formData.append('key', fileKey);\n        formData.append('policy', res.policy);\n        formData.append('OSSAccessKeyId', res.accessid);\n        formData.append('success_action_status', '200');\n        formData.append('signature', res.signature);\n        formData.append('file', file);\n        var i = formData.entries();\n        var sub = new Subject();\n        var put$ = ajax({\n          url: res.host,\n          body: formData,\n          method: 'post',\n          crossDomain: true,\n          progressSubscriber: sub\n        });\n        sub.subscribe(function (val) {\n          uploadProgress(val);\n        });\n        var resData = {\n          fileName: file.name,\n          fileKey: fileKey,\n          host: res.host,\n          url: isPrivate ? URL.createObjectURL(file) : res.host + '/' + fileKey\n        };\n        return put$.pipe(map(function (val) {\n          return resData;\n        }));\n      }));\n    }\n  }, {\n    key: \"getOssPolicy\",\n    value: function getOssPolicy(business, isPrivate) {\n      return this.http.get(\"/upload/policy\", {\n        query: {\n          business: business,\n          acl: isPrivate ? 'private' : 'public-read-write'\n        }\n      });\n    }\n  }, {\n    key: \"getFileSuffix\",\n    value: function getFileSuffix(file) {\n      if (file.name) {\n        var lastDotIndex = file.name.lastIndexOf('.');\n        return file.name.slice(lastDotIndex);\n      } else {\n        return '.' + file.type.split('/')[1];\n      }\n    }\n  }, {\n    key: \"getKey\",\n    value: function getKey(file) {\n      var suffix = this.getFileSuffix(file);\n      var fileName = '';\n\n      if (file.name) {\n        fileName = file.name.replace(/[?\\s%<>&#\\\\:]/g, '').replace(suffix, '');\n      }\n\n      if (suffix === '.xlsx' || suffix === '.xls' || suffix === '.csv') {\n        return \"import__\".concat(fileName, \"___\").concat(Math.random().toString(16).slice(3), \"___\").concat(suffix);\n      }\n\n      return \"\".concat(fileName, \"___\").concat(Math.random().toString(16).slice(3), \"___\").concat(suffix);\n    }\n    /**\n     * 下载文件方法\n     * @param url 下载的url\n     */\n\n  }, {\n    key: \"downloadFile\",\n    value: function downloadFile(url) {\n      var filename = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'download.xlsx';\n      var a = document.createElement('a');\n      a.href = url;\n      a.target = '_blank';\n      a.download = filename;\n      a.click();\n    }\n    /**\n     * 打开新的tab标签页\n     * @param url 打开的url\n     */\n\n  }, {\n    key: \"openNewTab\",\n    value: function openNewTab(url) {\n      // const a = document.createElement('a')\n      // a.href = url\n      // a.target = '_blank'\n      // a.click()\n      window.open(url);\n    }\n  }]);\n\n  return OssService;\n}(Api);\n\nOssService = __decorate([Injectable()], OssService);\nexport { OssService };",null]}