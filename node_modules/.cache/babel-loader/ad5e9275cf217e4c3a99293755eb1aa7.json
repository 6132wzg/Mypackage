{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/personal/add-reserve.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/personal/add-reserve.vue","mtime":1600926555902},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.regexp.split\";\nimport _toConsumableArray from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/es7.array.includes\";\nimport \"core-js/modules/es6.string.includes\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/es6.regexp.constructor\";\nimport \"core-js/modules/es6.regexp.replace\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { PersonalScheduleCommonService as CommonService } from '@/views/pages/shop/product/course/schedule/personal/service#/common.service';\nimport { difference, cloneDeep } from 'lodash-es';\nimport { PersonalScheduleReserveService as ReserveService } from '@/views/pages/shop/product/course/schedule/personal/service#/reserve.service';\nimport { ruleOptions } from \"./add-reserve.config\";\nexport default {\n  name: 'AddReserve',\n  serviceInject: function serviceInject() {\n    return {\n      commonService: CommonService,\n      reserveService: ReserveService\n    };\n  },\n  serviceProviders: function serviceProviders() {\n    return [CommonService, ReserveService];\n  },\n  rxState: function rxState() {\n    var cs = this.commonService;\n    return {\n      deductInfo: cs.deductInfo$,\n      loading: this.reserveService.loading$,\n      courseCoachOptions: cs.courseCoachOptions$,\n      consumeOptions: cs.consumeOptions$,\n      memberOptions: cs.memberOptions$,\n      courseOptions: cs.courseOptions$,\n      dateOptions: cs.dateOptions$,\n      timeOptions: cs.timeOptions$\n    };\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      memberName: '',\n      consumeName: '',\n      form: form,\n      decorators: decorators,\n      member_id: '',\n      show: false,\n      effectiveState: 1,\n      keyword: '',\n      value: '',\n      fetching: false,\n      formKeyFlag: ['consume_type', 'course_id', 'coach_id', 'scheduling_id', 'reserve_start_time'],\n      reserveDate: ''\n    };\n  },\n  methods: {\n    keywordFilter: function keywordFilter(str) {\n      if (!this.keyword) return str;\n      str = str.replace(new RegExp(this.keyword), \"<span class=\\\"color-primary\\\">\".concat(this.keyword, \"</span>\"));\n      return str;\n    },\n    // 获取消费方式 权重2\n    onChangeConsume: function onChangeConsume(val) {\n      if (!val) return;\n      var v = JSON.parse(val); //  因为会员卡，私教课，储值卡，课程包只有课程包有这个字段 没这个字段也是生效 undefined也为1\n\n      this.effectiveState = v.effective_state === 0 ? 0 : 1;\n      this.consumeName = v.name;\n      this.form.setFieldsValue({\n        course_id: '',\n        coach_id: '',\n        scheduling_id: undefined,\n        'reserve_start_time:': undefined\n      });\n      this.commonService.getCourseList({\n        id: +v.id,\n        consume_type: +v.consume_type\n      }).subscribe();\n    },\n    // 获取会员 权重1\n    onSearchMember: function onSearchMember(val) {\n      var _this = this;\n\n      this.fetching = true;\n      this.keyword = val;\n      this.commonService.getOptions('getMemberList', {\n        member: val\n      }, function () {\n        _this.fetching = false;\n      });\n    },\n    // 获取上课课程 权重4\n    onChangeCourse: function onChangeCourse(val) {\n      this.form.setFieldsValue({\n        coach_id: '',\n        scheduling_id: undefined,\n        reserve_start_time: undefined\n      });\n      this.getCoachList(val);\n    },\n    getCoachList: function getCoachList(id) {\n      var consume = JSON.parse(this.form.getFieldValue('consume_type'));\n      var consume_id = consume.id,\n          consume_type = consume.consume_type;\n      var member_id = this.member_id;\n      var query = {\n        consume_id: consume_id,\n        consume_type: consume_type,\n        member_id: member_id\n      };\n      this.commonService.getCourseCoachList(id, query).subscribe();\n    },\n    // 获取时期\n    onChangeDatePick: function onChangeDatePick(val) {\n      var course_id = this.form.getFieldValue('course_id');\n      var reserveDate = {\n        id: '',\n        course_id: course_id\n      };\n      this.form.setFieldsValue({\n        reserve_start_time: undefined\n      });\n      this.dateOptions.forEach(function (item) {\n        val.format('YYYY-MM-DD') === item.schedule_date && (reserveDate.id = item.id);\n      });\n\n      var query = _objectSpread({}, reserveDate, {\n        member_id: this.member_id\n      });\n\n      this.commonService.getOptions('getTimeList', query, function () {});\n    },\n    onChangeCourseCoach: function onChangeCourseCoach(val) {\n      this.form.setFieldsValue({\n        scheduling_id: undefined,\n        reserve_start_time: undefined\n      });\n      this.commonService.getOptions('getDateList', {\n        id: val,\n        member_id: this.member_id\n      }, function () {});\n    },\n    range: function range(start, end) {\n      var result = [];\n\n      for (var i = start; i <= end; i++) {\n        result.push(i);\n      }\n\n      return result;\n    },\n    disabledDate: function disabledDate(current) {\n      return current && !this.dateOptions.map(function (item) {\n        return item.schedule_date;\n      }).includes(current.format('YYYY-MM-DD').valueOf());\n    },\n    disabledMinutes: function disabledMinutes(selectedHour) {\n      if (!this.timeOptions.timing) return;\n      var disabledMinutes = [];\n      var allTime = this.range(0, 60);\n\n      for (var i = 0; i < this.timeOptions.timing.length; i++) {\n        var startHour = +moment(\"\".concat(this.timeOptions.schedule_date, \" \").concat(this.timeOptions.timing[i].start_time)).format('H').valueOf();\n        var endHour = +moment(\"\".concat(this.timeOptions.schedule_date, \" \").concat(this.timeOptions.timing[i].end_time)).format('H').valueOf();\n        var start = +moment(\"\".concat(this.timeOptions.schedule_date, \" \").concat(this.timeOptions.timing[i].start_time)).format('mm').valueOf();\n        var end = +moment(\"\".concat(this.timeOptions.schedule_date, \" \").concat(this.timeOptions.timing[i].end_time)).format('mm').valueOf();\n\n        if (+selectedHour === startHour && +selectedHour === endHour) {\n          disabledMinutes = [].concat(_toConsumableArray(disabledMinutes), _toConsumableArray(this.range(start, end)));\n        } else {\n          if (+selectedHour === startHour) {\n            disabledMinutes = [].concat(_toConsumableArray(disabledMinutes), _toConsumableArray(this.range(start, 60)));\n          } else if (+selectedHour === endHour) {\n            disabledMinutes = [].concat(_toConsumableArray(disabledMinutes), _toConsumableArray(this.range(0, end)));\n          } else if (+selectedHour > startHour && endHour > +selectedHour) {\n            disabledMinutes = [].concat(_toConsumableArray(disabledMinutes), _toConsumableArray(this.range(0, 60)));\n          }\n        }\n      }\n\n      return difference(allTime, disabledMinutes);\n    },\n    disabledHours: function disabledHours() {\n      if (!this.timeOptions.timing) return;\n      var disabledHours = [];\n      var allTime = this.range(0, 24);\n\n      for (var i = 0; i < this.timeOptions.timing.length; i++) {\n        var start = +moment(\"\".concat(this.timeOptions.schedule_date, \" \").concat(this.timeOptions.timing[i].start_time)).format('H').valueOf();\n        var end = +moment(\"\".concat(this.timeOptions.schedule_date, \" \").concat(this.timeOptions.timing[i].end_time)).format('H').valueOf();\n\n        if (!end && this.timeOptions.timing[i].end_time.includes('24')) {\n          end = 24;\n        }\n\n        disabledHours = [].concat(_toConsumableArray(disabledHours), _toConsumableArray(this.range(start, end)));\n      }\n\n      return difference(allTime, disabledHours) || null;\n    },\n    add: function add() {\n      var _this2 = this;\n\n      this.form.validate().then(function (values) {\n        var consume = JSON.parse(values.consume_type);\n        var form = cloneDeep(values);\n        form.member_id = values.member_id;\n        form.consume_type = consume.consume_type;\n        form.consume_id = consume.id;\n        form.reserve_start_time = values.reserve_start_time.format('HH:mm').valueOf();\n\n        _this2.dateOptions.forEach(function (item) {\n          if (item.schedule_date === values.scheduling_id.format('YYYY-MM-DD').valueOf()) {\n            form.scheduling_id = item.id;\n          }\n        });\n\n        _this2.reserveService.add(form).subscribe(function (res) {\n          _this2.show = false;\n\n          _this2.$router.reload();\n        });\n      });\n    },\n    save: function save() {\n      var _this3 = this;\n\n      if (this.effectiveState) {\n        this.add();\n        return;\n      }\n\n      this.$confirm({\n        title: '',\n        content: \"\\u65B0\\u589E\\u9884\\u7EA6\\u540E, \".concat(this.memberName, \"\\u7684\\u8BFE\\u7A0B\\u5305\").concat(this.consumeName.split('(')[0], \"\\u4F1A\\u7ACB\\u5373\\u751F\\u6548\\uFF0C\\u786E\\u8BA4\\u65B0\\u589E?\"),\n        onOk: function onOk() {\n          _this3.add();\n\n          _this3.effectiveState = 1;\n        },\n        onCancel: function onCancel() {\n          console.log('Cancel');\n        }\n      });\n    },\n    getMemberName: function getMemberName(id) {\n      var memberName = '';\n      this.memberOptions.forEach(function (item) {\n        if (item.member_id === id) {\n          memberName = item.member_name;\n        }\n      });\n      return memberName;\n    },\n    onChangeMember: function onChangeMember(val) {\n      this.form.resetFields();\n      this.member_id = val;\n      this.memberName = this.getMemberName(val);\n      this.commonService.getOptions('getConsumeList', val, function () {});\n    }\n  }\n};",{"version":3,"sources":["add-reserve.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <st-modal\n    title=\"新增预约\"\n    @ok=\"save\"\n    v-model=\"show\"\n    size=\"small\"\n    :confirmLoading=\"loading.add\"\n  >\n    <st-form :form=\"form\">\n      <st-form-item label=\"会员名称\" required>\n        <a-select\n          showSearch\n          placeholder=\"请输入会员名称\"\n          v-decorator=\"decorators.member_id\"\n          style=\"width: 100%\"\n          :dropdownMatchSelectWidth=\"false\"\n          :filterOption=\"false\"\n          @search=\"onSearchMember\"\n          @change=\"onChangeMember\"\n          notFoundContent=\"无搜索结果\"\n        >\n          <a-spin v-if=\"fetching\" slot=\"notFoundContent\" size=\"small\" />\n          <a-select-option\n            v-for=\"member in memberOptions\"\n            :key=\"member.member_id\"\n            :value=\"+member.member_id\"\n          >\n            <div class=\"st-form-table__add-option\">\n              <span\n                class=\"item-name\"\n                v-html=\"keywordFilter(member.member_name)\"\n              ></span>\n              <span\n                class=\"item-phone\"\n                v-html=\"keywordFilter(member.mobile)\"\n              ></span>\n            </div>\n          </a-select-option>\n        </a-select>\n      </st-form-item>\n      <st-form-item label=\"消费方式\" required>\n        <a-select\n          v-decorator=\"decorators.consume_type\"\n          @change=\"onChangeConsume\"\n          :dropdownMatchSelectWidth=\"false\"\n          placeholder=\"请选择消费方式\"\n        >\n          <a-select-opt-group\n            v-for=\"consumeType in consumeOptions\"\n            :key=\"consumeType.id\"\n            :value=\"consumeType.id\"\n          >\n            <span slot=\"label\">\n              <a-icon type=\"snippets\" />\n              {{ consumeType.name }}\n            </span>\n            <a-select-option\n              v-for=\"consume in consumeType.children\"\n              :value=\"JSON.stringify(consume)\"\n              :key=\"consume.id\"\n            >\n              {{ consume.name }}\n            </a-select-option>\n          </a-select-opt-group>\n        </a-select>\n      </st-form-item>\n      <st-form-item label=\"课程\" required>\n        <a-select\n          placeholder=\"请选择课程\"\n          @change=\"onChangeCourse\"\n          v-decorator=\"decorators.course_id\"\n        >\n          <a-select-option\n            v-for=\"course in courseOptions\"\n            :key=\"course.id\"\n            :value=\"course.id\"\n          >\n            {{ course.course_name }}\n          </a-select-option>\n        </a-select>\n      </st-form-item>\n      <st-form-item v-if=\"deductInfo.deduct_num\" label=\"扣除额度\" required>\n        <span>\n          {{ deductInfo.deduct_num }}\n        </span>\n      </st-form-item>\n      <st-form-item :label=\"`上课${$c('coach')}`\" required>\n        <a-select\n          v-decorator=\"decorators.coach_id\"\n          :placeholder=\"`请选择上课${$c('coach')}`\"\n          @change=\"onChangeCourseCoach\"\n        >\n          <a-select-option\n            v-for=\"courseCoach in courseCoachOptions\"\n            :key=\"courseCoach.id\"\n            :value=\"courseCoach.id\"\n          >\n            {{ courseCoach.name }}\n          </a-select-option>\n        </a-select>\n      </st-form-item>\n      <st-form-item label=\"预约日期\" required>\n        <a-date-picker\n          @change=\"onChangeDatePick\"\n          v-decorator=\"decorators.scheduling_id\"\n          style=\"width:100%\"\n          :disabledDate=\"disabledDate\"\n        />\n      </st-form-item>\n      <st-form-item label=\"预约时间\" required class=\"mg-b0\">\n        <a-time-picker\n          format=\"HH:mm\"\n          v-decorator=\"decorators.reserve_start_time\"\n          :disabledMinutes=\"disabledMinutes\"\n          style=\"width:100%\"\n          :disabledHours=\"disabledHours\"\n        />\n      </st-form-item>\n    </st-form>\n  </st-modal>\n</template>\n\n<script>\nimport { PersonalScheduleCommonService as CommonService } from '@/views/pages/shop/product/course/schedule/personal/service#/common.service'\nimport { difference, cloneDeep } from 'lodash-es'\nimport { PersonalScheduleReserveService as ReserveService } from '@/views/pages/shop/product/course/schedule/personal/service#/reserve.service'\nimport { ruleOptions } from './add-reserve.config'\nexport default {\n  name: 'AddReserve',\n  serviceInject() {\n    return {\n      commonService: CommonService,\n      reserveService: ReserveService\n    }\n  },\n  serviceProviders() {\n    return [CommonService, ReserveService]\n  },\n  rxState() {\n    const cs = this.commonService\n    return {\n      deductInfo: cs.deductInfo$,\n      loading: this.reserveService.loading$,\n      courseCoachOptions: cs.courseCoachOptions$,\n      consumeOptions: cs.consumeOptions$,\n      memberOptions: cs.memberOptions$,\n      courseOptions: cs.courseOptions$,\n      dateOptions: cs.dateOptions$,\n      timeOptions: cs.timeOptions$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      memberName: '',\n      consumeName: '',\n      form,\n      decorators,\n      member_id: '',\n      show: false,\n      effectiveState: 1,\n      keyword: '',\n      value: '',\n      fetching: false,\n      formKeyFlag: [\n        'consume_type',\n        'course_id',\n        'coach_id',\n        'scheduling_id',\n        'reserve_start_time'\n      ],\n      reserveDate: ''\n    }\n  },\n  methods: {\n    keywordFilter(str) {\n      if (!this.keyword) return str\n      str = str.replace(\n        new RegExp(this.keyword),\n        `<span class=\"color-primary\">${this.keyword}</span>`\n      )\n      return str\n    },\n    // 获取消费方式 权重2\n    onChangeConsume(val) {\n      if (!val) return\n      const v = JSON.parse(val)\n      //  因为会员卡，私教课，储值卡，课程包只有课程包有这个字段 没这个字段也是生效 undefined也为1\n      this.effectiveState = v.effective_state === 0 ? 0 : 1\n      this.consumeName = v.name\n      this.form.setFieldsValue({\n        course_id: '',\n        coach_id: '',\n        scheduling_id: undefined,\n        'reserve_start_time:': undefined\n      })\n      this.commonService\n        .getCourseList({ id: +v.id, consume_type: +v.consume_type })\n        .subscribe()\n    },\n    // 获取会员 权重1\n    onSearchMember(val) {\n      this.fetching = true\n      this.keyword = val\n      this.commonService.getOptions('getMemberList', { member: val }, () => {\n        this.fetching = false\n      })\n    },\n    // 获取上课课程 权重4\n    onChangeCourse(val) {\n      this.form.setFieldsValue({\n        coach_id: '',\n        scheduling_id: undefined,\n        reserve_start_time: undefined\n      })\n      this.getCoachList(val)\n    },\n    getCoachList(id) {\n      const consume = JSON.parse(this.form.getFieldValue('consume_type'))\n      const { id: consume_id, consume_type } = consume\n      const { member_id } = this\n      const query = {\n        consume_id,\n        consume_type,\n        member_id\n      }\n      this.commonService.getCourseCoachList(id, query).subscribe()\n    },\n    // 获取时期\n    onChangeDatePick(val) {\n      const course_id = this.form.getFieldValue('course_id')\n      let reserveDate = {\n        id: '',\n        course_id\n      }\n      this.form.setFieldsValue({ reserve_start_time: undefined })\n      this.dateOptions.forEach(item => {\n        val.format('YYYY-MM-DD') === item.schedule_date &&\n          (reserveDate.id = item.id)\n      })\n      const query = { ...reserveDate, member_id: this.member_id }\n      this.commonService.getOptions('getTimeList', query, () => {})\n    },\n    onChangeCourseCoach(val) {\n      this.form.setFieldsValue({\n        scheduling_id: undefined,\n        reserve_start_time: undefined\n      })\n      this.commonService.getOptions(\n        'getDateList',\n        { id: val, member_id: this.member_id },\n        () => {}\n      )\n    },\n    range(start, end) {\n      const result = []\n      for (let i = start; i <= end; i++) {\n        result.push(i)\n      }\n      return result\n    },\n    disabledDate(current) {\n      return (\n        current &&\n        !this.dateOptions\n          .map(item => {\n            return item.schedule_date\n          })\n          .includes(current.format('YYYY-MM-DD').valueOf())\n      )\n    },\n    disabledMinutes(selectedHour) {\n      if (!this.timeOptions.timing) return\n      let disabledMinutes = []\n      const allTime = this.range(0, 60)\n      for (let i = 0; i < this.timeOptions.timing.length; i++) {\n        const startHour = +moment(\n          `${this.timeOptions.schedule_date} ${this.timeOptions.timing[i].start_time}`\n        )\n          .format('H')\n          .valueOf()\n        const endHour = +moment(\n          `${this.timeOptions.schedule_date} ${this.timeOptions.timing[i].end_time}`\n        )\n          .format('H')\n          .valueOf()\n        const start = +moment(\n          `${this.timeOptions.schedule_date} ${this.timeOptions.timing[i].start_time}`\n        )\n          .format('mm')\n          .valueOf()\n        const end = +moment(\n          `${this.timeOptions.schedule_date} ${this.timeOptions.timing[i].end_time}`\n        )\n          .format('mm')\n          .valueOf()\n        if (+selectedHour === startHour && +selectedHour === endHour) {\n          disabledMinutes = [...disabledMinutes, ...this.range(start, end)]\n        } else {\n          if (+selectedHour === startHour) {\n            disabledMinutes = [...disabledMinutes, ...this.range(start, 60)]\n          } else if (+selectedHour === endHour) {\n            disabledMinutes = [...disabledMinutes, ...this.range(0, end)]\n          } else if (+selectedHour > startHour && endHour > +selectedHour) {\n            disabledMinutes = [...disabledMinutes, ...this.range(0, 60)]\n          }\n        }\n      }\n      return difference(allTime, disabledMinutes)\n    },\n    disabledHours() {\n      if (!this.timeOptions.timing) return\n      let disabledHours = []\n      const allTime = this.range(0, 24)\n      for (let i = 0; i < this.timeOptions.timing.length; i++) {\n        const start = +moment(\n          `${this.timeOptions.schedule_date} ${this.timeOptions.timing[i].start_time}`\n        )\n          .format('H')\n          .valueOf()\n        let end = +moment(\n          `${this.timeOptions.schedule_date} ${this.timeOptions.timing[i].end_time}`\n        )\n          .format('H')\n          .valueOf()\n        if (!end && this.timeOptions.timing[i].end_time.includes('24')) {\n          end = 24\n        }\n        disabledHours = [...disabledHours, ...this.range(start, end)]\n      }\n      return difference(allTime, disabledHours) || null\n    },\n    add() {\n      this.form.validate().then(values => {\n        const consume = JSON.parse(values.consume_type)\n        let form = cloneDeep(values)\n        form.member_id = values.member_id\n        form.consume_type = consume.consume_type\n        form.consume_id = consume.id\n        form.reserve_start_time = values.reserve_start_time\n          .format('HH:mm')\n          .valueOf()\n        this.dateOptions.forEach(item => {\n          if (\n            item.schedule_date ===\n            values.scheduling_id.format('YYYY-MM-DD').valueOf()\n          ) {\n            form.scheduling_id = item.id\n          }\n        })\n        this.reserveService.add(form).subscribe(res => {\n          this.show = false\n          this.$router.reload()\n        })\n      })\n    },\n    save() {\n      if (this.effectiveState) {\n        this.add()\n        return\n      }\n      this.$confirm({\n        title: '',\n        content: `新增预约后, ${this.memberName}的课程包${\n          this.consumeName.split('(')[0]\n        }会立即生效，确认新增?`,\n        onOk: () => {\n          this.add()\n          this.effectiveState = 1\n        },\n        onCancel() {\n          console.log('Cancel')\n        }\n      })\n    },\n    getMemberName(id) {\n      let memberName = ''\n      this.memberOptions.forEach(item => {\n        if (item.member_id === id) {\n          memberName = item.member_name\n        }\n      })\n      return memberName\n    },\n    onChangeMember(val) {\n      this.form.resetFields()\n      this.member_id = val\n      this.memberName = this.getMemberName(val)\n      this.commonService.getOptions('getConsumeList', val, () => {})\n    }\n  }\n}\n</script>\n"],"sourceRoot":"src/views/biz-modals/schedule/personal"}]}