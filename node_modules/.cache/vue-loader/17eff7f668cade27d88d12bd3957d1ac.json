{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/card/brand-member/shelf.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/card/brand-member/shelf.vue","mtime":1595230476655},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { ShelfService } from './shelf.service'\nimport { cloneDeep } from 'lodash-es'\nimport { PatternService } from '@/services/pattern.service'\nimport ShopHourPicker from '@/views/biz-components/shop-hour-picker/shop-hour-picker'\nimport { ruleOptions, shopColumns, admissionTimeList } from './shelf.config'\nimport { BRAND_MEMBER } from '@/constants/card/brand-member'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalCardBrandMemberShelf',\n  bem: {\n    shelves: 'modal-card-batch-shelves'\n  },\n  components: {\n    ShopHourPicker\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      messageService: MessageService,\n      shelfService: ShelfService\n    }\n  },\n  rxState() {\n    return {\n      courseData: this.shelfService.courseList$,\n      course_interests: this.shelfService.course_interests$,\n      activateTypes: this.shelfService.activateTypes$,\n      loading: this.shelfService.loading$,\n      info: this.shelfService.info$,\n      shelfCardDetail: this.shelfService.shelfCardDetail$\n    }\n  },\n  props: {\n    id: {\n      type: Number,\n      default: 0\n    },\n    shelf_id: {\n      type: Number,\n      default: 0\n    },\n    actionType: {\n      type: String,\n      default: 'shelf'\n    },\n    title: {\n      type: String,\n      default: '标题'\n    }\n  },\n  computed: {\n    shopColumns,\n    admissionTimeList,\n    shopList() {\n      let shopList = []\n      if (this.info.sell_shops) {\n        this.info.sell_shops.forEach(i => {\n          let id = parseInt(Math.random() * 999999).toString()\n          shopList.push({ ...i, key: id })\n        })\n      }\n      return shopList\n    },\n    admissionTimeIsOk() {\n      return this.admissionTimeText === ''\n    },\n    courseInterestsIsOk() {\n      return this.courseInterestsStatus === 'success'\n    },\n    priceIsOk() {\n      return this.priceHelpText === ''\n    },\n    priceValidataArray() {\n      let array = []\n      this.priceList.forEach(i => {\n        array.push(i.priceInputValue)\n      })\n      return array\n    },\n    vipTree() {\n      let array = []\n      if (this.actionType === 'shelf' && this.info.areas) {\n        this.info.areas.forEach(i => {\n          let children = []\n          i.areas.forEach(o => {\n            children.push({\n              title: o.name,\n              key: `${i.id}-${o.id}`,\n              scopedSlots: { title: 'title' }\n            })\n          })\n          array.push({\n            title: i.name,\n            key: i.id,\n            scopedSlots: { title: 'title' },\n            children\n          })\n        })\n      }\n      return array\n    },\n    // 回传给后台的上架门店\n    sell_shops() {\n      let shops = []\n      if (this.info.sell_shops) {\n        this.info.sell_shops.forEach(i => {\n          shops.push(+i.id)\n        })\n      }\n      return shops\n    }\n  },\n  watch: {\n    priceList: {\n      deep: true,\n      handler() {\n        let b = this.priceValidataArray.every(i =>\n          this.pattern.NUM_FLOAT(1).test(i)\n        )\n        b && this.checkedPrice()\n      }\n    },\n    info: {\n      deep: true,\n      handler(newVal) {\n        newVal.specs.forEach(i => {\n          this.priceList.push({\n            ...i,\n            priceInputValue: ''\n          })\n        })\n      }\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      firstLoading: false,\n      BRAND_MEMBER,\n      form,\n      decorators,\n      show: true,\n      // 卡tag类型\n      cardTypeTag: {\n        1: 'number-card',\n        2: 'period-card'\n      },\n      // 门店明细\n      visible: false,\n      // 范围价格列表\n      priceList: [],\n      priceHelpText: '',\n      // 回传给后台的价格\n      specs: [],\n      // 开卡方式\n      openTypeList: [],\n      // 约课权益\n      // 输入是否正确\n      courseInterestsStatus: 'success',\n      courseInterestsHelpText: '',\n      // 课列表\n      courseInterests: null,\n      courseList: [],\n      // 显示更多\n      moreIsShow: true,\n      admissionTime: 1,\n      timeList: [],\n      // 回传给后台的时间段\n      inoutTime: [],\n      admissionTimeText: '',\n      expandedKeys: [],\n      autoExpandParent: true,\n      searchValue: '',\n      // 选择的vip区域\n      selectVipAreas: []\n    }\n  },\n  created() {\n    this.firstLoading = true\n    const query = {}\n    const { actionType, shelf_id } = this\n    if (actionType === 'updateShelf') {\n      query.shelf_id = shelf_id\n    }\n    this.shelfService.getInfo(this.id, query).subscribe(res => {\n      if (actionType === 'updateShelf') {\n        this.initShelfData()\n      }\n      this.firstLoading = false\n    })\n  },\n  methods: {\n    getCourseList(search) {\n      let query = { course_name: search }\n      this.shelfService.courseListAction$.dispatch(query)\n    },\n    // 检验入场时间是否输入正确\n    checkedAdmission() {\n      this.admissionTimeText =\n        this.admissionTime === 2 && this.moreIsShow && !this.timeList.length\n          ? '请选择入场时间'\n          : ''\n    },\n    brandPriceSettingHandleChange({ value, key }) {\n      this.priceList[key].priceInputValue = value\n    },\n    // 检验门店自主定价价格输入是否正确\n    checkedPrice() {\n      if (\n        !(\n          this.info.publish_channel === this.BRAND_MEMBER.PUBLISH_CHANNEL_1 &&\n          this.info.price_setting === this.BRAND_MEMBER.PRICE_SETTING_2\n        )\n      ) {\n        this.priceHelpText = ''\n        return false\n      }\n      let b = this.priceValidataArray.every(i =>\n        this.pattern.NUM_FLOAT(1).test(i)\n      )\n      this.priceHelpText = b ? '' : '请输入价格'\n    },\n    onTreeSearch(data) {\n      if (data === '') {\n        Object.assign(this, {\n          expandedKeys: [],\n          searchValue: data,\n          autoExpandParent: true\n        })\n        return\n      }\n      let expandedKeys = []\n      this.vipTree.forEach(i => {\n        if (i.children) {\n          i.children.forEach(o => {\n            if (o.title.includes(data)) {\n              expandedKeys.push(i.key)\n            }\n          })\n        }\n      })\n      this.expandedKeys = cloneDeep(expandedKeys)\n      this.searchValue = data\n      this.autoExpandParent = true\n    },\n    onExpand(expandedKeys) {\n      this.expandedKeys = expandedKeys\n      this.autoExpandParent = false\n    },\n    onTreeSelect(checkeds) {\n      let selectAreasObject = {}\n      let vipAreas = []\n      let selectAreasArray = []\n      vipAreas = checkeds.filter(i => `${i}`.includes('-'))\n      vipAreas.forEach(i => {\n        if (selectAreasObject[i.split('-')[0]]) {\n          selectAreasObject[i.split('-')[0]].push(+i.split('-')[1])\n        } else {\n          selectAreasObject[i.split('-')[0]] = [+i.split('-')[1]]\n        }\n      })\n      Object.keys(selectAreasObject).forEach(i => {\n        selectAreasArray.push({\n          shop_id: +i,\n          areas: cloneDeep(selectAreasObject[i])\n        })\n      })\n      this.selectVipAreas = cloneDeep(selectAreasArray)\n    },\n    // 格式化价格\n    formatSpecs() {\n      this.specs = []\n      if (\n        this.info.publish_channel === this.BRAND_MEMBER.PUBLISH_CHANNEL_1 &&\n        this.info.price_setting === this.BRAND_MEMBER.PRICE_SETTING_2\n      ) {\n        // 有价格范围\n        this.priceList.forEach(i => {\n          this.specs.push({\n            specs_id: i.spec_id,\n            price: i.priceInputValue\n          })\n        })\n      } else {\n        // 无价格范围,发布渠道为2是门店，一定是无范围的\n        this.priceList.forEach(i => {\n          this.specs.push({\n            specs_id: i.spec_id,\n            price: i.rally_price\n          })\n        })\n      }\n    },\n    // 格式化入场时段\n    formatWeek() {\n      this.inoutTime = []\n      this.timeList.forEach(i => {\n        this.inoutTime.push({\n          week_day: +i.week_day,\n          time_duration: [{ start_time: i.start_time, end_time: i.end_time }]\n        })\n      })\n    },\n    onSubmit() {\n      this.form.validate().then(values => {\n        this.checkedAdmission()\n        // TODO: shop hour picker后续修改，不能有默认值\n        this.formatWeek()\n        this.formatSpecs()\n        if (!this.inputCheck()) {\n          return\n        }\n        if (this.admissionTimeIsOk) {\n          if (this.openTypeList.toString() === '3') {\n            this.$confirm({\n              title: '确认上架?',\n              content:\n                '当前仅选择指定日期开卡，上架后小程序不显示该卡，确认上架？',\n              onOk: () => {\n                this.sendShelfCard(values)\n              }\n            })\n            return\n          }\n          this.sendShelfCard(values)\n        }\n      })\n    },\n    getParams(values, shelf_id) {\n      const params = {\n        sell_shops: this.sell_shops,\n        open_type: this.openTypeList,\n        activate_duration:\n          values.openDay === undefined ? values.openDay : +values.openDay,\n        course_interests: +this.courseInterests,\n        courses: values.courseList,\n        inout_type: this.admissionTime,\n        inout_time: this.inoutTime,\n        specs: this.specs\n      }\n      const { actionType, selectVipAreas, shelfCardDetail } = this\n      if (actionType === 'shelf') {\n        params.areas = selectVipAreas\n      } else {\n        params.areas = shelfCardDetail.areas\n      }\n      if (shelf_id) {\n        params.shelf_id = shelf_id\n        /**\n         * 变更上架信息不传 sell_shops\n         */\n\n        delete params.sell_shops\n      }\n      return params\n    },\n    inputCheck() {\n      if (!this.courseInterests) {\n        this.messageService.error({\n          content: '请选择约课权益'\n        })\n        return false\n      }\n      return true\n    },\n    sendShelfCard(values) {\n      const params = this.getParams(values)\n      this.shelfService.shelfCard(params, this.id).subscribe(() => {\n        this.show = false\n        this.$emit('success')\n      })\n    },\n    onUpdateShelf() {\n      this.form.validate().then(values => {\n        this.checkedAdmission()\n        this.formatWeek()\n        this.formatSpecs()\n        const params = this.getParams(values, this.shelf_id)\n        if (!this.inputCheck()) {\n          return\n        }\n        this.shelfService.updateShelf(this.id, params).subscribe(() => {\n          this.show = false\n          this.$emit('success')\n        })\n      })\n    },\n    /**\n     * 变更上架表单数据回显\n     */\n    initShelfData() {\n      const detail = this.shelfCardDetail\n      this.openTypeList = detail.activate_type\n      this.courseInterests = detail.course_interests\n      this.admissionTime = detail.inout_type\n      this.timeList = this.timeFilter(detail.inout_time)\n      this.vipAreaList = detail.areas\n      this.$nextTick(() => {\n        this.form.setFieldsValue({\n          openDay: detail.automatic_num,\n          courseList: detail.courses\n        })\n      })\n      this.getCourseList('')\n    },\n    timeFilter(timeList) {\n      return timeList.map(item => {\n        const { week_day } = item\n        const { start_time, end_time } = item.time_duration[0]\n        return {\n          week_day,\n          start_time,\n          end_time\n        }\n      })\n    }\n  }\n}\n",null]}