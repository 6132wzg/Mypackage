{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/setting/shop/edit.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/setting/shop/edit.vue","mtime":1597396799971},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { UserService } from '@/services/user.service'\nimport { EditService } from './edit.service'\nimport { PatternService } from '@/services/pattern.service'\nimport { cloneDeep } from 'lodash-es'\nimport CheckboxFacilityGroup from '@/views/biz-components/checkbox-facility/checkbox-facility-group'\nimport CheckboxFacilityItem from '@/views/biz-components/checkbox-facility/checkbox-facility-item'\nimport MapButton from '@/views/biz-components/map-button/map-button'\nimport ShopHourPicker from '@/views/biz-components/shop-hour-picker/shop-hour-picker'\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nexport default {\n  name: 'EditShopSetting',\n  components: {\n    CheckboxFacilityGroup,\n    CheckboxFacilityItem,\n    MapButton,\n    ShopHourPicker,\n    StImageUpload\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      editService: EditService,\n      userService: UserService\n    }\n  },\n  rxState() {\n    return {\n      serviceList: this.editService.serviceList$,\n      shopInfo: this.editService.shopInfo$,\n      editLoading: this.editService.loading$\n    }\n  },\n  mounted() {\n    this.init(this.shopInfo)\n  },\n  data() {\n    return {\n      editMap: {\n        lat: '',\n        lng: '',\n        address: '',\n        province: {},\n        city: {},\n        district: {}\n      },\n      fileList: [],\n      fileListHostiry: [],\n      cropperModal: {},\n      // 电话校验方式 1为点击新增校验，0为点击提交校验\n      phoneValidtorType: 1,\n      shopData: {\n        shop_name: '',\n        province_id: null,\n        city_id: null,\n        district_id: null,\n        address: '',\n        shop_phones: [],\n        shop_status: 1,\n        lat: '',\n        lng: '',\n        service_ids: [],\n        business_time: [],\n        email: '',\n        shop_images: []\n      },\n      shopCoverImageValidateText: '',\n      serviceIcon_icon_list: {\n        1: 'WIFI',\n        2: 'park',\n        3: 'shower',\n        4: 'medical',\n        5: 'heating',\n        6: 'snow',\n        7: 'nosmoking',\n        8: 'energy'\n      }\n    }\n  },\n  beforeCreate() {\n    this.form = this.$form.createForm(this)\n  },\n  computed: {\n    phoneAddDisabled() {\n      return this.shopData.shop_phones.length > 2\n    },\n    shopCoverImageIsOk() {\n      return this.shopCoverImageValidateText === ''\n    }\n  },\n  methods: {\n    // 获取门店信息\n    init(data) {\n      this.form.setFieldsValue({\n        shop_name: data.shop_name,\n        email: data.email\n      })\n      // 门店电话\n      this.shopData.shop_phones = cloneDeep(data.shop_phones)\n      // 门店地址\n      this.editMap.lat = data.lat\n      this.editMap.lng = data.lng\n      this.editMap.address = data.shop_position.address\n      this.editMap.province.id = data.shop_position.province_id\n      this.editMap.province.name = data.shop_position.province_name\n      this.editMap.city.id = data.shop_position.city_id\n      this.editMap.city.name = data.shop_position.city_name\n      this.editMap.district.id = data.shop_position.district_id\n      this.editMap.district.name = data.shop_position.district_name\n      // 服务设施\n      data.shop_services.forEach(i => {\n        this.shopData.service_ids.push(i.service_id)\n      })\n      // 店招\n      this.fileListHostiry = cloneDeep(data.shop_images)\n      this.fileList = cloneDeep(data.shop_images.filter(i => i.is_cover))\n      this.shopData.shop_images = cloneDeep(\n        data.shop_images.filter(i => i.is_cover)\n      )\n      // 营业状态\n      this.shopData.shop_status = data.shop_status\n      // 营业时间\n      this.shopData.business_time = data.business_time\n    },\n    // 校验店招是否已上传\n    shopCoverImageValidator() {\n      this.shopCoverImageValidateText = this.shopData.shop_images.length\n        ? ''\n        : '请上传店招'\n    },\n    fileChange(data) {\n      if (data.length) {\n        this.shopData.shop_images = cloneDeep(data)\n        this.shopData.shop_images[0].is_cover = 1\n      } else {\n        this.shopData.shop_images = []\n      }\n      this.shopCoverImageValidator()\n    },\n    editMapChange(data) {\n      this.editMap = cloneDeep(data)\n    },\n    // 新增电话\n    onValidtorPhone() {\n      if (this.form.getFieldValue('shop_phone') && !this.phoneAddDisabled) {\n        // input框里有值才新增\n        this.form.validateFields(['shop_phone'], {}).then(res => {\n          let arr = [...this.shopData.shop_phones]\n          arr.push(res.shop_phone)\n          this.shopData.shop_phones = [...new Set(arr)]\n        })\n      }\n    },\n    // 移除电话\n    onRemovePhone(index) {\n      this.shopData.shop_phones.splice(index, 1)\n    },\n    // 表单提交\n    onHandleSubmit(e) {\n      // 确认为提交表单校验\n      this.phoneValidtorType = 0\n      this.form.resetFields(['shop_phone'])\n      e.preventDefault()\n      this.shopCoverImageValidator()\n      this.form.validateFieldsAndScroll((err, values) => {\n        this.phoneValidtorType = 1\n        if (!err && this.shopCoverImageIsOk) {\n          this.shopData.shop_name = values.shop_name\n          this.shopData.province_id = this.editMap.province.id\n          this.shopData.province_name = this.editMap.province.name\n          this.shopData.city_id = this.editMap.city.id\n          this.shopData.city_name = this.editMap.city.name\n          this.shopData.district_id = this.editMap.district.id\n          this.shopData.district_name = this.editMap.district.name\n          this.shopData.address = this.editMap.address\n          this.shopData.lat = this.editMap.lat\n          this.shopData.lng = this.editMap.lng\n          this.shopData.email = values.email\n          // 替换店招\n          let i = 0\n          this.fileListHostiry.some((item, index) => {\n            if (item.is_cover) {\n              i = index\n            }\n          })\n          this.fileListHostiry.splice(i, 1)\n          this.fileListHostiry.unshift(...this.shopData.shop_images)\n          this.shopData.shop_images = cloneDeep(this.fileListHostiry)\n          this.editService\n            .edit(this.$searchQuery.id, this.shopData)\n            .subscribe(() => {\n              this.$router.push({\n                name: 'brand-setting-shop-list'\n              })\n            })\n        } else {\n        }\n      })\n    },\n    // shop_name validatorFn\n    shop_name_validator(rule, value, callback) {\n      if (value === undefined || !value) {\n        // eslint-disable-next-line\n        callback('请填写门店名称')\n      } else if (value && !this.pattern.CN_EN_NUM_SPACE('1-20').test(value)) {\n        // eslint-disable-next-line\n        callback('支持中英文、数字,不超过20个字')\n      } else {\n        // eslint-disable-next-line\n        callback()\n      }\n    },\n    // shop_phone validatorFn\n    shop_phone_validator(rule, value, callback) {\n      if (this.phoneValidtorType) {\n        callback()\n      } else {\n        if (!this.shopData.shop_phones.length) {\n          // eslint-disable-next-line\n          callback('请填写门店电话')\n        } else {\n          // eslint-disable-next-line\n          callback()\n        }\n      }\n    }\n  }\n}\n",null]}