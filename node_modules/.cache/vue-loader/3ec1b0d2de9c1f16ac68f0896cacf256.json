{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-personal-course.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-personal-course.vue","mtime":1596188219499},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { SalePersonalCourseService } from './sale-personal-course.service'\nimport moment from 'moment'\nimport { cloneDeep, get } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { PatternService } from '@/services/pattern.service'\nimport { ruleOptions } from './sale-personal-course.config'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nimport MemberSearch from '@/views/biz-components/member-search/member-search'\nimport SelectScroll from '@/views/biz-components/select-scroll/select-scroll'\nimport { momentPlus } from '@/utils/date'\n\nexport default {\n  name: 'ModalSoldDealSaleMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber,\n    MemberSearch,\n    SelectScroll\n  },\n  serviceProviders() {\n    return [SalePersonalCourseService]\n  },\n  serviceInject() {\n    return {\n      salePersonalCourseService: SalePersonalCourseService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.salePersonalCourseService.loading$,\n      finished: this.salePersonalCourseService.finished$,\n      page: this.salePersonalCourseService.page$,\n      info: this.salePersonalCourseService.info$,\n      courseList: this.salePersonalCourseService.courseList$,\n      saleList: this.salePersonalCourseService.saleList$,\n      couponList: this.salePersonalCourseService.couponList$,\n      coachList: this.salePersonalCourseService.coachList$,\n      personalPrice: this.salePersonalCourseService.personalPrice$,\n      priceInfo: this.salePersonalCourseService.priceInfo$,\n      orderAmountPrice: this.salePersonalCourseService.orderAmountPrice$,\n      coachTypeOptions: this.salePersonalCourseService.coachTypeOptions$\n    }\n  },\n  props: {\n    id: {\n      type: String\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      // 购买数量可编辑\n      isAmountDisabled: false,\n      // 最小输入购买数量\n      minPrice: 0,\n      // 到期有效时间\n      validEndTime: moment(), // 最大日期距当前时间不超过5年\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      // 优惠券\n      selectCoupon: '',\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      couponDropdownVisible: false,\n      // 购买数量处于编辑状态 提示语\n      isAmountStateTip: '',\n      // 到期时间可否编辑\n      isEditExpiredTime: false,\n      product_id: '',\n      isFollowSalesman: 0,\n      product_name: '',\n      coach_type: 1\n    }\n  },\n  computed: {\n    canChoseCoupon() {\n      let len = this.couponList.length\n      return !!len\n    },\n    canChoseAdvance() {\n      let len = this.advanceList.length\n      return (this.id || this.product_id) && len\n    },\n    orderPersonalType() {\n      // 1 教练平级 + 谈单模式 2 教练平级 + 统一标价 3 教练分级 + 谈单模式 4 教练分级 + 统一标价\n      let personalCourseType = 1\n      if (this.info.price_model === 1 && this.info.sale_model === 1) {\n        personalCourseType = 1\n      } else if (this.info.price_model === 1 && this.info.sale_model === 2) {\n        personalCourseType = 2\n      } else if (this.info.price_model === 2 && this.info.sale_model === 1) {\n        personalCourseType = 3\n      } else if (this.info.price_model === 2 && this.info.sale_model === 2) {\n        personalCourseType = 4\n      }\n      return personalCourseType\n    },\n    orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : ''\n    },\n    saleRangeType() {\n      return get(this.info.sale_range, 'type', 1)\n    },\n    hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}'\n    },\n    isSupportSelectCoach() {\n      /**\n       * coach_type 1 指定教练\n       */\n      return this.coach_type === 1\n    }\n  },\n  watch: {\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(newVal, this.selectAdvance, +this.reduceAmount)\n      }\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(this.selectCoupon, newVal, +this.reduceAmount)\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectCoupon, this.selectAdvance, +newVal)\n    }\n  },\n  mounted() {\n    this.salePersonalCourseService.serviceInit().subscribe(res => {\n      if (this.id) {\n        this.handleGetPersonalCourseInfo(this.id)\n      } else {\n        this.salePersonalCourseService\n          .getPresonalCourseList({\n            app_brand_id: this.$searchQuery.app_brand_id,\n            app_shop_id: this.$searchQuery.app_shop_id,\n            product_type: 3\n          })\n          .subscribe()\n      }\n    })\n    this.initFieldsValue()\n  },\n  methods: {\n    moment,\n    onResetDiscounts() {\n      // 重置优惠券及定金选择\n      this.resetCoupon()\n      this.resetAdvance()\n    },\n    // 重新获取优惠券及定金\n    onReGetDiscounts(data) {\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      this.fetchAdvanceList(data)\n      this.fetchCouponList(data)\n    },\n    // 会员选择\n    onMemberChange(data) {\n      // 重置优惠券及定金选择\n      this.onResetDiscounts()\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      if (data) this.onReGetDiscounts(data)\n    },\n    // 选择课,筛选\n    handleSelect(val) {\n      this.product_id = val\n      this.onResetDiscounts()\n      this.handleGetPersonalCourseInfo(val)\n    },\n    // 选择课,搜索\n    handleSearch(product_name) {\n      this.product_name = product_name\n      this.salePersonalCourseService\n        .getPresonalCourseList({\n          product_name,\n          current_page: 1,\n          app_brand_id: this.$searchQuery.app_brand_id,\n          app_shop_id: this.$searchQuery.app_shop_id,\n          product_type: 3\n        })\n        .subscribe()\n    },\n    // 卡规格切换\n    changeSpeics(event) {\n      this.isAmountDisabled = false\n      this.resetOrderInfo()\n      const selectCoach = this.info.coach_level.filter(item => {\n        return item.id === event.target.value\n      })\n      this.minPrice = selectCoach[0].min_sell\n      const productId = this.form.getFieldValue('productId') || undefined\n      this.salePersonalCourseService\n        .getCoachList(selectCoach[0].id, productId)\n        .subscribe()\n    },\n    // 重置订单信息\n    resetOrderInfo() {\n      this.form.resetFields([\n        'buyNum',\n        'coach_ids',\n        'coursePrice',\n        'gift_course_num'\n      ])\n      this.personalPrice.sell_price = 0\n      this.personalPrice.min_sell_price = 0\n      this.personalPrice.max_sell_price = 0\n      this.validEndTime = moment()\n      this.priceInfo = 0\n      this.orderAmountPrice = 0\n      this.reduceAmount = 0\n      this.selectAdvance = ''\n      this.selectCoupon = ''\n      this.couponList = []\n    },\n    // 定金选择\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    // 优惠券选择\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    // 重置定金选择\n    resetAdvance() {\n      this.advanceList = []\n      this.advanceText = '未选择定金'\n      this.selectAdvance = ''\n      this.advanceAmount = ''\n    },\n    // 重置优惠券选择\n    resetCoupon() {\n      this.salePersonalCourseService.REST_COUPONLIST()\n      this.couponText = '未选择优惠券'\n      this.selectCoupon = ''\n      this.couponAmount = ''\n    },\n    // 签单弹窗关闭\n    onCancel() {\n      this.onResetDiscounts()\n    },\n    // 定金选择\n    onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0\n        this.advanceText = `未选择定金`\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    // 优惠券选择\n    onSelectCouponChange(event) {\n      let id = get(event.target.value, 'id', '')\n      if (id) {\n        let price = this.couponList.filter(o => o.id === id)[0].price\n        this.couponAmount = price\n        this.couponText = `${price}元`\n      } else {\n        this.couponText = '未选择优惠券'\n        this.couponAmount = 0\n      }\n    },\n    // 确认购买课程的数量\n    onClickCourseAmount() {\n      const productId = this.form.getFieldValue('productId') || undefined\n      const params = {\n        id: productId,\n        buy_num: this.form.getFieldValue('buyNum'),\n        coach_level_id: this.form.getFieldValue('coach_level') || 0 // 默认0 为没有等级，否则分级\n      }\n      this.salePersonalCourseService\n        .getPersonalPriceInfo(params)\n        .subscribe(result => {\n          this.isAmountDisabled = true\n          this.form.setFieldsValue({\n            buyNum: params.buy_num\n          })\n          let time = this.info.effective_unit * params.buy_num || 0\n          this.validEndTime = momentPlus.add(time, 'days')\n          // 调用优惠券列表\n          this.fetchCouponList()\n          // 调用获取商品原价\n          if (\n            this.info.sale_model === 1 &&\n            !this.form.getFieldValue('coursePrice') &&\n            this.form.getFieldValue('coursePrice') !== 0\n          ) {\n            return\n          }\n          this.getOrderPrice()\n          this.getPrice(\n            this.selectCoupon,\n            this.selectAdvance,\n            +this.reduceAmount\n          )\n        })\n    },\n    // 编辑购买的课程数量\n    onClickCourseEdit() {\n      const val = this.form.getFieldValue('buyNum')\n      this.isAmountDisabled = false\n      this.form.setFieldsValue({\n        buyNum: val\n      })\n      this.form.validate(['buyNum'])\n    },\n    onClickTimeEdit() {\n      this.isEditExpiredTime = !this.isEditExpiredTime\n    },\n    // 计算实付金额\n    getPrice(coupon, advance, reduce) {\n      let advanceId = advance === -1 ? '' : advance\n      let special_amount = this.personalPrice.sell_price\n      if (this.info.sale_model === 1) {\n        special_amount = this.form.getFieldValue('coursePrice')\n      }\n      if (!special_amount) {\n        return\n      }\n      const memberId = this.form.getFieldValue('member_id')\n      const productId = this.form.getFieldValue('productId')\n      this.salePersonalCourseService.priceAction$.dispatch({\n        product_id: productId || undefined,\n        product_type: this.info.contract_type,\n        product_num: this.form.getFieldValue('buyNum'),\n        specs_id: this.form.getFieldValue('coach_level'),\n        coupon_id: coupon ? coupon.id : undefined,\n        member_id: memberId || undefined,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        special_amount: +special_amount || 0\n      })\n    },\n    // 获取订单总额\n    getOrderPrice() {\n      let special_amount = this.personalPrice.sell_price\n      if (this.info.sale_model === 1) {\n        special_amount = this.form.getFieldValue('coursePrice')\n        if (!special_amount) {\n          return\n        }\n      }\n      const productId = this.form.getFieldValue('productId') || undefined\n      this.salePersonalCourseService.orderAmountPriceAction$.dispatch({\n        product_id: productId,\n        product_type: this.info.contract_type,\n        product_num: this.form.getFieldValue('buyNum'),\n        specs_id: this.form.getFieldValue('coach_level'),\n        special_amount: +special_amount || 0\n      })\n    },\n    // 创建订单\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        const productId = this.form.getFieldValue('productId') || undefined\n        this.salePersonalCourseService\n          .setTransactionOrder({\n            member_id: values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            course_id: productId,\n            contract_number: this.info.contract_number,\n            buy_num: values.buyNum,\n            course_price:\n              this.info.sale_model === 2\n                ? this.personalPrice.sell_price\n                : values.coursePrice,\n            coupon_id: this.selectCoupon.id,\n            advance_id: this.selectAdvance,\n            reduce_amount: this.reduceAmount || 0,\n            sale_id: values.saleName,\n            description: this.description,\n            gift_course_num: values.gift_course_num || 0,\n            coach_type: values.coach_type,\n            coach_ids: values.coach_ids,\n            coach_level_id: values.coach_level,\n            sale_range: this.info.sale_range.type,\n            order_amount: this.priceInfo,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman,\n            end_time: this.validEndTime.format('YYYY-MM-DD')\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'create',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    // 支付订单\n    onPay() {\n      this.form.validate().then(values => {\n        const productId = this.form.getFieldValue('productId') || undefined\n        this.salePersonalCourseService\n          .setTransactionPay({\n            member_id: values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            course_id: productId,\n            contract_number: this.info.contract_number,\n            buy_num: values.buyNum,\n            course_price:\n              this.info.sale_model === 2\n                ? this.personalPrice.sell_price\n                : values.coursePrice,\n            coupon_id: this.selectCoupon.id,\n            advance_id: this.selectAdvance,\n            reduce_amount: this.reduceAmount || 0,\n            sale_id: values.saleName,\n            description: this.description,\n            gift_course_num: values.gift_course_num || 0,\n            coach_type: values.coach_type,\n            coach_ids: values.coach_ids,\n            coach_level_id: values.coach_level,\n            sale_range: this.info.sale_range.type,\n            order_amount: this.priceInfo,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman,\n            end_time: this.validEndTime.format('YYYY-MM-DD')\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    disabledDate(current) {\n      return (\n        current &&\n        (current < moment().add(-1, 'day') ||\n          current > moment().add(5, 'years'))\n      )\n    },\n    // 获取优惠券列表\n    fetchCouponList(id) {\n      const member_id = this.form.getFieldValue('member_id') || id\n      const price = this.personalPrice.sell_price\n      const buy_num = this.form.getFieldValue('buyNum')\n      const course_id = this.form.getFieldValue('productId') || undefined\n      if (course_id && member_id) {\n        const params = {\n          member_id,\n          course_id,\n          price,\n          buy_num\n        }\n        this.salePersonalCourseService.getCouponList(params).subscribe()\n      }\n    },\n    // 获取定金列表\n    fetchAdvanceList(id) {\n      let member_id = this.form.getFieldValue('member_id') || id\n      if (member_id) {\n        this.salePersonalCourseService\n          .getAdvanceList(member_id)\n          .subscribe(res => {\n            this.advanceList = cloneDeep(res.list)\n          })\n      }\n    },\n    // 获取课程列表\n    handleGetList() {\n      if (this.finished) return false\n      this.salePersonalCourseService\n        .getPresonalCourseList({\n          product_name: this.product_name,\n          current_page: ++this.page.current_page,\n          app_brand_id: this.$searchQuery.app_brand_id,\n          app_shop_id: this.$searchQuery.app_shop_id,\n          product_type: 3\n        })\n        .subscribe()\n    },\n    // 获取课程详情\n    handleGetPersonalCourseInfo(productId) {\n      this.salePersonalCourseService.getInfo(productId).subscribe(res => {\n        if (this.id) {\n          this.salePersonalCourseService.SET_LIST([\n            {\n              id: +this.id,\n              product_name: this.info.product_name\n            }\n          ])\n        }\n        setTimeout(() => {\n          this.form.setFieldsValue({\n            productId: +productId\n          })\n          if (this.info.coach_level && this.info.coach_level.length > 0) {\n            this.form.setFieldsValue({\n              coach_level: this.info.coach_level[0].id\n            })\n            this.minPrice = this.info.coach_level[0].min_sell\n          }\n          let level = 0\n          if (this.info.price_model === 2) {\n            level = this.info.coach_level[0].id\n          }\n          this.onReGetDiscounts()\n          this.salePersonalCourseService\n            .getCoachList(level, productId)\n            .subscribe()\n        })\n      })\n    },\n    initFieldsValue() {\n      const { coach_type } = this\n      this.form.setFieldsValue({\n        coach_type\n      })\n    },\n    onCoachTypeChange(e) {\n      this.coach_type = e.target.value\n    }\n  }\n}\n",null]}