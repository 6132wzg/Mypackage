{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue","mtime":1596188219491},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nimport { ruleOptions } from './time-table.config'\nimport TimeTable from './time-table/table'\nimport { TeamTimeTableService } from './time-table.service'\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service'\nimport { MessageService } from '@/services/message.service'\nimport { cloneDeep, omit, pick } from 'lodash-es'\nimport { ShsService } from '@/services/shs.service'\nexport default {\n  bem: {\n    b: 'schedule-team-time-table'\n  },\n  components: {\n    StImageUpload,\n    TimeTable\n  },\n  serviceInject() {\n    return {\n      teamScheduleCommomService: TeamScheduleCommonService,\n      timeTableService: TeamTimeTableService,\n      messageService: MessageService,\n      shsService: ShsService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.timeTableService.loading$,\n      courtList: this.teamScheduleCommomService.courtOptions$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      bgFileList: [],\n      codeFileList: [],\n      title: '', // 课表标题\n      bgUrl: '', // 背景图\n      codeUrl: '', // 二维码图片\n      rangeTime: '', // 时间范围\n      tableData: {},\n      bgErrorText: '',\n      codeErrorText: '',\n      startDate: '',\n      endDate: '',\n      downLoadLoading: false,\n      saveLoading: false\n    }\n  },\n  created() {},\n  mounted() {\n    let weekOfday = moment().format('E') // 今天是本周第几天\n    this.startDate = moment()\n      .subtract(weekOfday - 1, 'days')\n      .format('YYYY-MM-DD') // 周一日期\n    this.endDate = moment(this.startDate)\n      .add(6, 'days')\n      .format('YYYY-MM-DD')\n    this.getTimeTableTemplate()\n  },\n  computed: {\n    ruleOptions\n  },\n  watch: {\n    startDate() {\n      let startTime = moment(this.startDate)\n        .format('YYYY/MM/DD')\n        .slice(5, this.startDate.length)\n      let endDate = moment(this.startDate)\n        .add(6, 'days')\n        .format('YYYY/MM/DD')\n      let endTime = endDate.slice(5, endDate.length)\n      this.rangeTime = `${startTime}-${endTime}`\n    }\n  },\n  methods: {\n    getTimeTableTemplate() {\n      this.timeTableService.getTimeTableTemplate().subscribe(res => {\n        this.tableData = res.info\n        this.title = this.tableData.title\n        this.form.setFieldsValue({\n          title: this.tableData.title,\n          selected_court: this.tableData.selected_court\n        })\n        if (this.tableData.is_bgimage) {\n          // 背景自定义\n          this.bgFileList = [this.tableData.customize_bgimage]\n          this.bgUrl = this.tableData.customize_bgimage.image_url\n          this.tableData.bg_image = this.tableData.customize_bgimage.image_key\n        } else {\n          this.bgUrl = this.tableData.def_bgimage.image_url\n          this.tableData.bg_image = ''\n        }\n        if (this.tableData.is_qrcode) {\n          // 二维码自定义\n          this.codeFileList = this.tableData.customize_qrcode.image_key\n            ? [this.tableData.customize_qrcode]\n            : []\n          this.codeUrl = this.tableData.customize_qrcode.image_url\n          this.tableData.qrcode = this.tableData.customize_qrcode.image_key\n        } else {\n          this.codeUrl = this.tableData.def_qrcode.image_url\n          this.tableData.qrcode = ''\n        }\n      })\n    },\n    // 选择时间段\n    onChangeDate(date) {\n      this.startDate = date.start_date\n      this.endDate = date.end_date\n    },\n    changeTitle(e) {\n      this.title = e.target.value\n    },\n    changeBgType() {\n      if (!this.tableData.is_bgimage) {\n        this.bgUrl = this.tableData.def_bgimage.image_url\n        this.tableData.bg_image = ''\n      } else {\n        this.bgUrl = this.bgFileList.length\n          ? this.bgFileList[0].image_url\n          : this.bgUrl\n        this.tableData.bg_image = this.bgFileList.length\n          ? this.bgFileList[0].image_key\n          : ''\n        this.bgImgValidate()\n      }\n    },\n    changeCodeType() {\n      if (!this.tableData.is_qrcode) {\n        this.codeUrl = this.tableData.def_qrcode.image_url\n        this.tableData.qrcode = ''\n      } else {\n        this.codeUrl = this.codeFileList.length\n          ? this.codeFileList[0].image_url\n          : ''\n        this.tableData.qrcode = this.codeFileList.length\n          ? this.codeFileList[0].image_key\n          : ''\n        this.codeImgValidate()\n      }\n    },\n    bgFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.bg_image = fileData[0].image_key\n        this.bgUrl = fileData[0].image_url\n        this.bgFileList = fileData\n      } else {\n        this.tableData.bg_image = ''\n      }\n      this.bgImgValidate()\n    },\n    codeFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.qrcode = fileData[0].image_key\n        this.codeUrl = fileData[0].image_url\n        this.codeFileList = fileData\n      } else {\n        this.tableData.qrcode = ''\n      }\n      this.codeImgValidate()\n    },\n    saveTimeTable() {\n      this.editTimeTable()\n    },\n    downloadTimeTable() {\n      this.editTimeTable(true)\n    },\n    editTimeTable(isDownload = false) {\n      this.bgImgValidate()\n      this.codeImgValidate()\n      this.form.validate().then(value => {\n        if (!this.bgErrorText && !this.codeErrorText) {\n          let tableData = omit(this.tableData, [\n            'brand_log',\n            'shop_name',\n            'customize_bgimage',\n            'customize_qrcode',\n            'def_bgimage',\n            'def_qrcode'\n          ])\n          let saveData = {\n            ...tableData,\n            title: value.title,\n            selected_court: value.selected_court\n          }\n          console.log(saveData)\n\n          if (isDownload) {\n            this.downLoadLoading = true\n          } else {\n            this.saveLoading = true\n          }\n          this.timeTableService\n            .saveTimeTableTemplate(saveData)\n            .subscribe(res => {\n              if (!isDownload) {\n                this.saveLoading = false\n                this.messageService.success({ content: '保存成功' })\n              } else {\n                this.timeTableService\n                  .getTimeTableList({\n                    start_date: this.startDate,\n                    end_date: this.endDate\n                  })\n                  .subscribe(res => {\n                    if (!res.list.length) {\n                      this.downLoadLoading = false\n                      this.messageService.error({ content: '当前时间段未排课' })\n                    } else {\n                      let pickData = pick(this.tableData, [\n                        'is_bgimage',\n                        'brand_log',\n                        'prompt_message',\n                        'is_show_nickname',\n                        'is_show_strength_level'\n                      ])\n                      let shsData = {\n                        ...pickData,\n                        bgUrl: this.bgUrl,\n                        qrcode_url: this.codeUrl,\n                        shop_name: this.tableData.is_show_shop\n                          ? this.tableData.shop_name\n                          : '',\n                        rangeTime: this.rangeTime,\n                        title: this.title,\n                        timeTableList: JSON.stringify(res.list),\n                        isSaveFile: 1\n                      }\n\n                      this.shsService\n                        .getShsImage(shsData, '/saas/time_table')\n                        .subscribe(url => {\n                          this.downLoadLoading = false\n                          this.messageService.success({\n                            content: '保存并下载成功'\n                          })\n                          console.log(url)\n                          this.downloadFile(url, `${this.title}.png`)\n                        })\n                    }\n                  })\n              }\n            })\n        }\n      })\n    },\n    downloadFile(url, filename = '') {\n      fetch(url, {\n        headers: new Headers({\n          Origin: location.origin\n        }),\n        mode: 'cors'\n      })\n        .then(res => res.blob())\n        .then(blob => {\n          const blobUrl = window.URL.createObjectURL(blob)\n          this.download(blobUrl, filename)\n          window.URL.revokeObjectURL(blobUrl)\n        })\n    },\n    download(blobUrl, filename) {\n      const a = document.createElement('a')\n      a.href = blobUrl\n      a.target = '_blank'\n      a.download = filename\n      document.body.appendChild(a)\n      a.click()\n      a.remove()\n    },\n    bgImgValidate() {\n      if (this.tableData.is_bgimage) {\n        this.bgErrorText = !this.tableData.bg_image ? '请上传背景图' : ''\n      } else {\n        this.bgErrorText = ''\n      }\n    },\n    codeImgValidate() {\n      if (this.tableData.is_qrcode) {\n        this.codeErrorText = !this.tableData.qrcode ? '请上传二维码图片' : ''\n      } else {\n        this.codeErrorText = ''\n      }\n    }\n  }\n}\n",{"version":3,"sources":["time-table.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"time-table.vue","sourceRoot":"src/views/biz-modals/schedule/team","sourcesContent":["<template>\n  <st-modal\n    v-model=\"show\"\n    title=\"生成课表\"\n    :class=\"b()\"\n    width=\"864px\"\n    :footer=\"null\"\n  >\n    <div :class=\"b('content')\">\n      <div :class=\"b('left')\">\n        <st-form :form=\"form\">\n          <st-form-item label=\"课表时间\">\n            <st-switch-week\n              :limitWeeks=\"25\"\n              @pre=\"onChangeDate\"\n              @next=\"onChangeDate\"\n            ></st-switch-week>\n          </st-form-item>\n          <st-form-item label=\"课表标题\" required>\n            <a-input\n              placeholder=\"请输入课表名称，不超过10个字\"\n              required\n              :maxLength=\"10\"\n              v-decorator=\"decorators.title\"\n              @change=\"changeTitle\"\n            ></a-input>\n          </st-form-item>\n          <st-form-item required>\n            <template slot=\"label\">\n              选择场地\n              <st-help-tooltip id=\"TSKB001\"></st-help-tooltip>\n            </template>\n            <a-select\n              mode=\"multiple\"\n              placeholder=\"请选择场地\"\n              v-decorator=\"decorators.selected_court\"\n            >\n              <a-select-option\n                v-for=\"court in courtList\"\n                :key=\"court.id\"\n                :value=\"court.id\"\n              >\n                {{ court.name }}\n              </a-select-option>\n              <a-select-option :value=\"0\">未关联场地</a-select-option>\n            </a-select>\n          </st-form-item>\n          <st-form-item label=\"内容展示\">\n            <a-row :gutter=\"24\">\n              <a-col :lg=\"12\">\n                门店名称\n                <st-switch\n                  v-model=\"tableData.is_show_shop\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n              <a-col :lg=\"12\">\n                教练昵称\n                <st-switch\n                  v-model=\"tableData.is_show_nickname\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n            </a-row>\n            <a-row :gutter=\"24\">\n              <a-col :lg=\"12\">\n                场地名称\n                <st-switch\n                  v-model=\"tableData.is_show_court\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n              <a-col :lg=\"12\">\n                难度等级\n                <st-switch\n                  v-model=\"tableData.is_show_strength_level\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n            </a-row>\n          </st-form-item>\n          <st-form-item label=\"背景图\">\n            <a-radio-group\n              v-model=\"tableData.is_bgimage\"\n              @change=\"changeBgType\"\n            >\n              <a-radio :value=\"0\">默认样式</a-radio>\n              <a-radio :value=\"1\">自定义</a-radio>\n            </a-radio-group>\n          </st-form-item>\n          <st-form-item\n            class=\"image-upload\"\n            label=\"\"\n            required\n            v-if=\"tableData.is_bgimage\"\n            validateStatus=\"error\"\n            :help=\"bgErrorText\"\n          >\n            <st-image-upload\n              :sizeLimit=\"5\"\n              :list=\"bgFileList\"\n              @change=\"bgFileChange\"\n              width=\"240px\"\n              height=\"135px\"\n              placeholder=\"上传图片\"\n              description=\"建议尺寸 16:9，大小不超过5M\"\n              :cropperModal=\"{\n                title: '门店图片裁切',\n                cropper: { aspectRatio: 16 / 9 }\n              }\"\n            ></st-image-upload>\n          </st-form-item>\n          <st-form-item label=\"二维码\">\n            <a-radio-group\n              v-model=\"tableData.is_qrcode\"\n              @change=\"changeCodeType\"\n            >\n              <a-radio\n                :value=\"0\"\n                v-if=\"tableData.def_qrcode && tableData.def_qrcode.image_url\"\n              >\n                小程序二维码\n              </a-radio>\n              <a-radio :value=\"1\">自定义</a-radio>\n            </a-radio-group>\n          </st-form-item>\n          <st-form-item\n            class=\"flex-style image-upload\"\n            label=\"\"\n            required\n            v-if=\"tableData.is_qrcode\"\n            validateStatus=\"error\"\n            :help=\"codeErrorText\"\n          >\n            <a-row :gutter=\"24\">\n              <a-col :lg=\"11\">\n                <st-image-upload\n                  :sizeLimit=\"2\"\n                  :list=\"codeFileList\"\n                  @change=\"codeFileChange\"\n                  width=\"114px\"\n                  height=\"114px\"\n                  placeholder=\"上传图片\"\n                  :cropperModal=\"{\n                    title: '图片裁切',\n                    cropper: { aspectRatio: 1 / 1 }\n                  }\"\n                ></st-image-upload>\n              </a-col>\n              <a-col :lg=\"13\" class=\"image-tips mg-t24\">\n                <div class=\"mg-b8\">建议尺寸 1:1</div>\n                <div class=\"st-des\">支持jpg、png、bmp格式，大小不超过2M</div>\n              </a-col>\n            </a-row>\n          </st-form-item>\n          <st-form-item label=\"温馨提示\">\n            <st-textarea\n              :autosize=\"{ minRows: 4, maxRows: 8 }\"\n              v-model=\"tableData.prompt_message\"\n              maxlength=\"100\"\n            ></st-textarea>\n          </st-form-item>\n        </st-form>\n      </div>\n      <div :class=\"b('right')\">\n        <time-table\n          :title=\"title\"\n          :bgUrl=\"bgUrl\"\n          :codeUrl=\"codeUrl\"\n          :rangeTime=\"rangeTime\"\n          :tableData=\"tableData\"\n        ></time-table>\n        <div :class=\"b('footer')\" class=\"mg-t8\">\n          <st-button\n            class=\"mg-r16\"\n            @click=\"saveTimeTable\"\n            :loading=\"saveLoading\"\n          >\n            保存设置\n          </st-button>\n          <st-button\n            type=\"primary\"\n            @click=\"downloadTimeTable\"\n            :loading=\"loading.getTimeTableList || downLoadLoading\"\n          >\n            下载课表\n          </st-button>\n        </div>\n      </div>\n    </div>\n  </st-modal>\n</template>\n<script>\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nimport { ruleOptions } from './time-table.config'\nimport TimeTable from './time-table/table'\nimport { TeamTimeTableService } from './time-table.service'\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service'\nimport { MessageService } from '@/services/message.service'\nimport { cloneDeep, omit, pick } from 'lodash-es'\nimport { ShsService } from '@/services/shs.service'\nexport default {\n  bem: {\n    b: 'schedule-team-time-table'\n  },\n  components: {\n    StImageUpload,\n    TimeTable\n  },\n  serviceInject() {\n    return {\n      teamScheduleCommomService: TeamScheduleCommonService,\n      timeTableService: TeamTimeTableService,\n      messageService: MessageService,\n      shsService: ShsService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.timeTableService.loading$,\n      courtList: this.teamScheduleCommomService.courtOptions$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      bgFileList: [],\n      codeFileList: [],\n      title: '', // 课表标题\n      bgUrl: '', // 背景图\n      codeUrl: '', // 二维码图片\n      rangeTime: '', // 时间范围\n      tableData: {},\n      bgErrorText: '',\n      codeErrorText: '',\n      startDate: '',\n      endDate: '',\n      downLoadLoading: false,\n      saveLoading: false\n    }\n  },\n  created() {},\n  mounted() {\n    let weekOfday = moment().format('E') // 今天是本周第几天\n    this.startDate = moment()\n      .subtract(weekOfday - 1, 'days')\n      .format('YYYY-MM-DD') // 周一日期\n    this.endDate = moment(this.startDate)\n      .add(6, 'days')\n      .format('YYYY-MM-DD')\n    this.getTimeTableTemplate()\n  },\n  computed: {\n    ruleOptions\n  },\n  watch: {\n    startDate() {\n      let startTime = moment(this.startDate)\n        .format('YYYY/MM/DD')\n        .slice(5, this.startDate.length)\n      let endDate = moment(this.startDate)\n        .add(6, 'days')\n        .format('YYYY/MM/DD')\n      let endTime = endDate.slice(5, endDate.length)\n      this.rangeTime = `${startTime}-${endTime}`\n    }\n  },\n  methods: {\n    getTimeTableTemplate() {\n      this.timeTableService.getTimeTableTemplate().subscribe(res => {\n        this.tableData = res.info\n        this.title = this.tableData.title\n        this.form.setFieldsValue({\n          title: this.tableData.title,\n          selected_court: this.tableData.selected_court\n        })\n        if (this.tableData.is_bgimage) {\n          // 背景自定义\n          this.bgFileList = [this.tableData.customize_bgimage]\n          this.bgUrl = this.tableData.customize_bgimage.image_url\n          this.tableData.bg_image = this.tableData.customize_bgimage.image_key\n        } else {\n          this.bgUrl = this.tableData.def_bgimage.image_url\n          this.tableData.bg_image = ''\n        }\n        if (this.tableData.is_qrcode) {\n          // 二维码自定义\n          this.codeFileList = this.tableData.customize_qrcode.image_key\n            ? [this.tableData.customize_qrcode]\n            : []\n          this.codeUrl = this.tableData.customize_qrcode.image_url\n          this.tableData.qrcode = this.tableData.customize_qrcode.image_key\n        } else {\n          this.codeUrl = this.tableData.def_qrcode.image_url\n          this.tableData.qrcode = ''\n        }\n      })\n    },\n    // 选择时间段\n    onChangeDate(date) {\n      this.startDate = date.start_date\n      this.endDate = date.end_date\n    },\n    changeTitle(e) {\n      this.title = e.target.value\n    },\n    changeBgType() {\n      if (!this.tableData.is_bgimage) {\n        this.bgUrl = this.tableData.def_bgimage.image_url\n        this.tableData.bg_image = ''\n      } else {\n        this.bgUrl = this.bgFileList.length\n          ? this.bgFileList[0].image_url\n          : this.bgUrl\n        this.tableData.bg_image = this.bgFileList.length\n          ? this.bgFileList[0].image_key\n          : ''\n        this.bgImgValidate()\n      }\n    },\n    changeCodeType() {\n      if (!this.tableData.is_qrcode) {\n        this.codeUrl = this.tableData.def_qrcode.image_url\n        this.tableData.qrcode = ''\n      } else {\n        this.codeUrl = this.codeFileList.length\n          ? this.codeFileList[0].image_url\n          : ''\n        this.tableData.qrcode = this.codeFileList.length\n          ? this.codeFileList[0].image_key\n          : ''\n        this.codeImgValidate()\n      }\n    },\n    bgFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.bg_image = fileData[0].image_key\n        this.bgUrl = fileData[0].image_url\n        this.bgFileList = fileData\n      } else {\n        this.tableData.bg_image = ''\n      }\n      this.bgImgValidate()\n    },\n    codeFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.qrcode = fileData[0].image_key\n        this.codeUrl = fileData[0].image_url\n        this.codeFileList = fileData\n      } else {\n        this.tableData.qrcode = ''\n      }\n      this.codeImgValidate()\n    },\n    saveTimeTable() {\n      this.editTimeTable()\n    },\n    downloadTimeTable() {\n      this.editTimeTable(true)\n    },\n    editTimeTable(isDownload = false) {\n      this.bgImgValidate()\n      this.codeImgValidate()\n      this.form.validate().then(value => {\n        if (!this.bgErrorText && !this.codeErrorText) {\n          let tableData = omit(this.tableData, [\n            'brand_log',\n            'shop_name',\n            'customize_bgimage',\n            'customize_qrcode',\n            'def_bgimage',\n            'def_qrcode'\n          ])\n          let saveData = {\n            ...tableData,\n            title: value.title,\n            selected_court: value.selected_court\n          }\n          console.log(saveData)\n\n          if (isDownload) {\n            this.downLoadLoading = true\n          } else {\n            this.saveLoading = true\n          }\n          this.timeTableService\n            .saveTimeTableTemplate(saveData)\n            .subscribe(res => {\n              if (!isDownload) {\n                this.saveLoading = false\n                this.messageService.success({ content: '保存成功' })\n              } else {\n                this.timeTableService\n                  .getTimeTableList({\n                    start_date: this.startDate,\n                    end_date: this.endDate\n                  })\n                  .subscribe(res => {\n                    if (!res.list.length) {\n                      this.downLoadLoading = false\n                      this.messageService.error({ content: '当前时间段未排课' })\n                    } else {\n                      let pickData = pick(this.tableData, [\n                        'is_bgimage',\n                        'brand_log',\n                        'prompt_message',\n                        'is_show_nickname',\n                        'is_show_strength_level'\n                      ])\n                      let shsData = {\n                        ...pickData,\n                        bgUrl: this.bgUrl,\n                        qrcode_url: this.codeUrl,\n                        shop_name: this.tableData.is_show_shop\n                          ? this.tableData.shop_name\n                          : '',\n                        rangeTime: this.rangeTime,\n                        title: this.title,\n                        timeTableList: JSON.stringify(res.list),\n                        isSaveFile: 1\n                      }\n\n                      this.shsService\n                        .getShsImage(shsData, '/saas/time_table')\n                        .subscribe(url => {\n                          this.downLoadLoading = false\n                          this.messageService.success({\n                            content: '保存并下载成功'\n                          })\n                          console.log(url)\n                          this.downloadFile(url, `${this.title}.png`)\n                        })\n                    }\n                  })\n              }\n            })\n        }\n      })\n    },\n    downloadFile(url, filename = '') {\n      fetch(url, {\n        headers: new Headers({\n          Origin: location.origin\n        }),\n        mode: 'cors'\n      })\n        .then(res => res.blob())\n        .then(blob => {\n          const blobUrl = window.URL.createObjectURL(blob)\n          this.download(blobUrl, filename)\n          window.URL.revokeObjectURL(blobUrl)\n        })\n    },\n    download(blobUrl, filename) {\n      const a = document.createElement('a')\n      a.href = blobUrl\n      a.target = '_blank'\n      a.download = filename\n      document.body.appendChild(a)\n      a.click()\n      a.remove()\n    },\n    bgImgValidate() {\n      if (this.tableData.is_bgimage) {\n        this.bgErrorText = !this.tableData.bg_image ? '请上传背景图' : ''\n      } else {\n        this.bgErrorText = ''\n      }\n    },\n    codeImgValidate() {\n      if (this.tableData.is_qrcode) {\n        this.codeErrorText = !this.tableData.qrcode ? '请上传二维码图片' : ''\n      } else {\n        this.codeErrorText = ''\n      }\n    }\n  }\n}\n</script>\n"]}]}