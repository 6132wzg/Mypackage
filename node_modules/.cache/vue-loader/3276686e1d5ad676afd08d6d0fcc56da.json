{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/product/card/deposit/add.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/product/card/deposit/add.vue","mtime":1600926556371},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { UserService } from '@/services/user.service'\nimport moment from 'moment'\nimport { PatternService } from '@/services/pattern.service'\nimport { cloneDeep, remove } from 'lodash-es'\nimport { AddService } from './add.service'\nimport MemberCard from '@/views/biz-components/h5/pages/member-card'\nimport H5Container from '@/views/biz-components/h5/h5-container'\nimport h5mixin from '@/views/pages/brand/product/card/member/period/h5mixin'\nimport { MEMBER_CARD } from '@/views/biz-components/h5/pages/member-card.config'\nimport CardBgRadio from '@/views/biz-components/card-bg-radio/card-bg-radio'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport {\n  CONSUMPTION_RANGE,\n  UNIT,\n  SELL_TYPE,\n  TRANSFER_UNIT,\n  IS_TRANSFER\n} from '@/constants/card/deposit'\nimport { ruleOptions } from './deposit.config'\nexport default {\n  mixins: [h5mixin],\n  components: {\n    StEditor,\n    MemberCard,\n    H5Container,\n    CardBgRadio\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      addService: AddService,\n      userService: UserService\n    }\n  },\n  rxState() {\n    return {\n      addLoading: this.addService.loading$,\n      shopName: this.userService.shop$,\n      cardBgList: this.addService.cardBgList$,\n      unit: this.addService.unit$,\n      consumerType: this.addService.consumerType$,\n      consumptionRange: this.addService.consumptionRange$,\n      transferUnit: this.addService.transferUnit$,\n      supportSales: this.addService.supportSales$,\n      sellType: this.addService.sellType$\n    }\n  },\n  bem: {\n    b: 'st-help-popover'\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      // cardData\n      CONSUMPTION_RANGE,\n      UNIT,\n      SELL_TYPE,\n      TRANSFER_UNIT,\n      cardType: MEMBER_CARD.DEPOSIT_CARD,\n      MEMBER_CARD,\n      cardData: {\n        // 储值卡名称\n        card_name: '',\n        // 特殊说明\n        special_note: '',\n        // 储值金额\n        card_price: null,\n        // 售卖价格\n        sell_price: null,\n        // 期限\n        num: null,\n        // 期限单位\n        unit: UNIT.DAY,\n        // 消费类目\n        card_consumer_id: [],\n        // 支持售卖时间\n        start_time: '',\n        end_time: '',\n        // 结束时间面板是否显示\n        endOpen: false,\n        // 卡背景\n        bg_image: {\n          image_id: 0,\n          image_key: this.cardBgList[0].image_key,\n          image_url: '',\n          index: 1\n        },\n        // 是否配置了用户端\n        appConfig: true,\n        // 卡介绍\n        card_contents: '',\n        // 备注\n        description: '',\n        // 是否支持转让\n        _is_transfer: false,\n        is_transfer: IS_TRANSFER.NOT_ALLOW,\n        // 转让单位\n        transfer_unit: TRANSFER_UNIT.RMB,\n        // 转让手续费\n        transfer_num: undefined,\n        // 售卖方式\n        card_sell_type: [SELL_TYPE.OFFLINE]\n      },\n      // 卡背景的help文本\n      cardBgValidatorText: '',\n      // 售卖时间\n      start_time: null,\n      end_time: null\n    }\n  },\n  mounted() {\n    this.syncAdmission()\n    this.h5CardInfo.consumption_range = {\n      id: CONSUMPTION_RANGE.ONLY_STORE,\n      name: this.shopName.name\n    }\n  },\n  methods: {\n    // 保存\n    onHandleSubmit(e) {\n      e.preventDefault()\n      this.cardBgValidator()\n      this.form.validate().then(values => {\n        if (this.cardBgIsOk) {\n          this.addService\n            .addCard({\n              card_name: values.cardData.card_name,\n              special_note: values.cardData.special_note,\n              sell_price: +values.cardData.sell_price,\n              card_price: +values.cardData.card_price,\n              num: +values.cardData.num,\n              unit: +this.cardData.unit,\n              card_consumer_id: values.cardData.card_consumer_id,\n              start_time: `${this.start_time.format('YYYY-MM-DD')}`,\n              end_time: `${this.end_time.format('YYYY-MM-DD')}`,\n              card_contents: this.cardData.card_contents,\n              description: this.cardData.description,\n              bg_image: this.cardData.bg_image,\n              card_sell_type: this.cardData.card_sell_type,\n              is_transfer: +this.cardData.is_transfer,\n              transfer_unit: this.cardData._is_transfer\n                ? +this.cardData.transfer_unit\n                : undefined,\n              transfer_num: this.cardData._is_transfer\n                ? +values.cardData.transfer_num\n                : undefined\n            })\n            .subscribe(res => {\n              // 新增成功\n              this.$router.push({\n                name: 'shop-product-card-deposit-list-all'\n              })\n            })\n        }\n      })\n    },\n    // 售卖时间-start\n    start_time_change(data) {\n      this.start_time = cloneDeep(data)\n    },\n    handleStartOpenChange(open) {\n      if (!open) {\n        this.cardData.endOpen = true\n      }\n    },\n    disabledStartDate(startValue) {\n      const endValue = this.end_time\n      if (!endValue) {\n        // 结束时间未选择\n        return (\n          startValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n        )\n      }\n      let start =\n        endValue.valueOf() >\n        moment()\n          .add(30, 'y')\n          .valueOf()\n          ? moment(endValue)\n              .subtract(30, 'y')\n              .valueOf()\n          : moment()\n              .startOf('day')\n              .valueOf()\n      return (\n        startValue.valueOf() < start ||\n        startValue.valueOf() > moment(endValue).valueOf()\n      )\n    },\n    // 售卖时间-end\n    end_time_change(data) {\n      this.end_time = cloneDeep(data)\n    },\n    handleEndOpenChange(open) {\n      this.cardData.endOpen = open\n    },\n    disabledEndDate(endValue) {\n      const startValue = this.start_time\n      if (!startValue) {\n        // 开始时间未选择\n        return (\n          endValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n        )\n      }\n      return (\n        endValue.valueOf() >=\n          moment(startValue)\n            .add(30, 'y')\n            .valueOf() ||\n        endValue.valueOf() < moment(startValue).valueOf() ||\n        endValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n      )\n    },\n    // moment\n    moment,\n    // 转让\n    transfer(e) {\n      this.cardData._is_transfer = e.target.checked\n      // 重置转让费用的校验\n      this.form.resetFields(['cardData.transfer_num'])\n    },\n    onCardBgChange(e) {\n      this.cardBgValidatorText = ''\n    },\n    // 卡背景校验\n    cardBgValidator() {\n      let validata = this.cardData.bg_image.image_key !== ''\n      this.cardBgValidatorText = validata ? '' : '请上传卡背景'\n    }\n  },\n  watch: {\n    'cardData._is_transfer': {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.cardData.is_transfer = +newVal\n      }\n    },\n    'cardData.transfer_unit': {\n      deep: true,\n      handler() {\n        this.form.resetFields(['cardData.transfer_num'])\n      }\n    }\n  },\n  computed: {\n    // 售卖方式\n    sell_type_list() {\n      let sell_type = cloneDeep(this.sellType)\n      let arr = []\n      sell_type.forEach(i => {\n        arr.push({\n          value: i.value,\n          label: i.label\n        })\n      })\n      if (!this.cardData.appConfig) {\n        remove(arr, i => i.value === SELL_TYPE.CLIENT)\n      }\n      return arr\n    },\n    // 卡背景是否校验通过\n    cardBgIsOk() {\n      return this.cardBgValidatorText === ''\n    },\n    // 转让设置的min\n    transferMin() {\n      return 0\n    },\n    // 转让设置的max\n    transferMax() {\n      return this.cardData.transfer_unit === TRANSFER_UNIT.PERCENT\n        ? 100\n        : 999999.9\n    }\n  }\n}\n",{"version":3,"sources":["add.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"add.vue","sourceRoot":"src/views/pages/shop/product/card/deposit","sourcesContent":["<template>\n  <st-mina-panel class=\"page-shop-basic-card page-shop-add-deposit-card\">\n    <h5-container slot=\"preview\" fixed>\n      <template v-slot:title>\n        购卡\n      </template>\n      <template v-slot:default>\n        <member-card\n          :data=\"h5CardInfo\"\n          :cardType=\"MEMBER_CARD.DEPOSIT_CARD\"\n          :isAdd=\"true\"\n        ></member-card>\n      </template>\n    </h5-container>\n\n    <div slot=\"actions\">\n      <st-button\n        :loading=\"addLoading.addCard\"\n        type=\"primary\"\n        @click=\"onHandleSubmit\"\n      >\n        保 存\n      </st-button>\n    </div>\n\n    <div class=\"page-content\">\n      <st-form :form=\"form\" labelWidth=\"118px\">\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\">\n            <st-form-item\n              class=\"page-content-card-line\"\n              label=\"储值卡名称\"\n              required\n            >\n              <a-input\n                v-decorator=\"decorators.cardData.card_name\"\n                maxlength=\"30\"\n                class=\"page-content-card-input\"\n                placeholder=\"请输入储值卡名称\"\n                @change=\"syncName\"\n              ></a-input>\n            </st-form-item>\n            <st-form-item class=\"page-content-card-line\" label=\"特别说明\">\n              <a-input\n                class=\"page-content-card-input\"\n                maxlength=\"20\"\n                v-decorator=\"decorators.cardData.special_note\"\n                placeholder=\"最多显示20个字符\"\n                @change=\"syncSpecialNote\"\n              ></a-input>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\" class=\"page-content-card-line__row\">\n          <a-col :lg=\"22\">\n            <st-form-item label=\"储值金额\" required>\n              <st-input-number\n                :float=\"true\"\n                :min=\"1\"\n                :max=\"9999999.9\"\n                v-decorator=\"decorators.cardData.card_price\"\n                class=\"page-content-card-input\"\n                placeholder=\"请输入储值金额\"\n                @change=\"syncDepositPrice\"\n              >\n                <span slot=\"addonAfter\">元</span>\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\">\n            <st-form-item label=\"售卖价格\" required>\n              <st-input-number\n                :float=\"true\"\n                :min=\"0\"\n                :max=\"9999999.9\"\n                v-decorator=\"decorators.cardData.sell_price\"\n                class=\"page-content-card-input\"\n                placeholder=\"请输入售卖价格\"\n              >\n                <span slot=\"addonAfter\">元</span>\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\">\n            <st-form-item label=\"期限\" required>\n              <st-input-number\n                :min=\"1\"\n                :max=\"99999\"\n                v-decorator=\"decorators.cardData.num\"\n                class=\"page-content-card-input\"\n                placeholder=\"请输入期限\"\n                @change=\"syncDeadlineNum\"\n              >\n                <a-select\n                  v-model=\"cardData.unit\"\n                  slot=\"addonAfter\"\n                  class=\"page-content-card-small-select\"\n                >\n                  <a-select-option\n                    v-for=\"(item, index) in unit\"\n                    :value=\"item.value\"\n                    :key=\"index\"\n                  >\n                    {{ item.label }}\n                  </a-select-option>\n                </a-select>\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\">\n            <st-form-item label=\"支持消费类目\" required>\n              <a-checkbox-group\n                v-decorator=\"decorators.cardData.card_consumer_id\"\n                @change=\"syncConsumer\"\n              >\n                <a-checkbox\n                  v-for=\"item in consumerType\"\n                  :key=\"item.value\"\n                  :value=\"item.value\"\n                >\n                  {{ item.label }}\n                </a-checkbox>\n              </a-checkbox-group>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"23\">\n            <st-form-item\n              class=\"page-content-card-admission-range\"\n              label=\"支持消费门店\"\n            >\n              {{ shopName.name }}\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"23\">\n            <st-form-item\n              class=\"page-content-card-support-sales\"\n              label=\"支持售卖门店\"\n            >\n              {{ shopName.name }}\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"20\">\n            <st-form-item class=\"page-content-card-time mg-b0\" required>\n              <span slot=\"label\">\n                支持售卖时间\n              </span>\n              <a-form-item class=\"page-a-form\">\n                <a-date-picker\n                  :disabledDate=\"disabledStartDate\"\n                  v-decorator=\"decorators.start_time\"\n                  format=\"YYYY-MM-DD\"\n                  placeholder=\"开始时间\"\n                  :showToday=\"false\"\n                  @openChange=\"handleStartOpenChange\"\n                  @change=\"start_time_change\"\n                />\n              </a-form-item>\n              ~\n              <a-form-item class=\"page-a-form\">\n                <a-date-picker\n                  :disabledDate=\"disabledEndDate\"\n                  v-decorator=\"decorators.end_time\"\n                  format=\"YYYY-MM-DD\"\n                  placeholder=\"结束时间\"\n                  :showToday=\"false\"\n                  :open=\"cardData.endOpen\"\n                  @openChange=\"handleEndOpenChange\"\n                  @change=\"end_time_change\"\n                />\n              </a-form-item>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"20\">\n            <st-form-item class=\"page-content-card-transfer\" label=\"转让设置\">\n              <div class=\"page-content-card-transfer-body\">\n                <a-checkbox class=\"page-checkbox\" @change=\"transfer\">\n                  支持转让\n                </a-checkbox>\n                <st-input-number\n                  class=\"page-content-card-num-input page-input-group\"\n                  v-decorator=\"decorators.cardData.transfer_num\"\n                  :float=\"cardData.transfer_unit === TRANSFER_UNIT.RMB\"\n                  :disabled=\"!cardData._is_transfer\"\n                  :min=\"transferMin\"\n                  :max=\"transferMax\"\n                >\n                  <a-select\n                    slot=\"addonAfter\"\n                    v-model=\"cardData.transfer_unit\"\n                    :disabled=\"!cardData._is_transfer\"\n                  >\n                    <a-select-option\n                      v-for=\"item in transferUnit\"\n                      :key=\"item.value\"\n                      :value=\"item.value\"\n                    >\n                      {{ item.label }}\n                    </a-select-option>\n                  </a-select>\n                </st-input-number>\n              </div>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"20\">\n            <st-form-item\n              class=\"page-content-card-sell-type\"\n              label=\"售卖方式\"\n              required\n            >\n              <a-checkbox-group v-model=\"cardData.card_sell_type\">\n                <a-checkbox\n                  v-for=\"item in sell_type_list\"\n                  :key=\"item.value\"\n                  :disabled=\"item.value === SELL_TYPE.OFFLINE\"\n                  :value=\"item.value\"\n                >\n                  {{ item.label }}\n                </a-checkbox>\n              </a-checkbox-group>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"20\">\n            <st-form-item\n              class=\"page-content-card-bg\"\n              label=\"卡背景\"\n              required\n              :help=\"cardBgValidatorText\"\n            >\n              <card-bg-radio\n                @change=\"onCardBgChange\"\n                v-model=\"cardData.bg_image\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\">\n            <st-form-item\n              class=\"page-content-card-introduction mg-t4\"\n              label=\"储值卡介绍\"\n            >\n              <st-editor v-model=\"cardData.card_contents\"></st-editor>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :lg=\"22\">\n            <st-form-item\n              class=\"page-content-card-contents mg-t4\"\n              label=\"内部备注\"\n            >\n              <st-textarea\n                v-model=\"cardData.description\"\n                maxlength=\"500\"\n                class=\"page-content-card-textarea\"\n                placeholder=\"请输入\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n      </st-form>\n    </div>\n  </st-mina-panel>\n</template>\n<script>\nimport { UserService } from '@/services/user.service'\nimport moment from 'moment'\nimport { PatternService } from '@/services/pattern.service'\nimport { cloneDeep, remove } from 'lodash-es'\nimport { AddService } from './add.service'\nimport MemberCard from '@/views/biz-components/h5/pages/member-card'\nimport H5Container from '@/views/biz-components/h5/h5-container'\nimport h5mixin from '@/views/pages/brand/product/card/member/period/h5mixin'\nimport { MEMBER_CARD } from '@/views/biz-components/h5/pages/member-card.config'\nimport CardBgRadio from '@/views/biz-components/card-bg-radio/card-bg-radio'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport {\n  CONSUMPTION_RANGE,\n  UNIT,\n  SELL_TYPE,\n  TRANSFER_UNIT,\n  IS_TRANSFER\n} from '@/constants/card/deposit'\nimport { ruleOptions } from './deposit.config'\nexport default {\n  mixins: [h5mixin],\n  components: {\n    StEditor,\n    MemberCard,\n    H5Container,\n    CardBgRadio\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      addService: AddService,\n      userService: UserService\n    }\n  },\n  rxState() {\n    return {\n      addLoading: this.addService.loading$,\n      shopName: this.userService.shop$,\n      cardBgList: this.addService.cardBgList$,\n      unit: this.addService.unit$,\n      consumerType: this.addService.consumerType$,\n      consumptionRange: this.addService.consumptionRange$,\n      transferUnit: this.addService.transferUnit$,\n      supportSales: this.addService.supportSales$,\n      sellType: this.addService.sellType$\n    }\n  },\n  bem: {\n    b: 'st-help-popover'\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      // cardData\n      CONSUMPTION_RANGE,\n      UNIT,\n      SELL_TYPE,\n      TRANSFER_UNIT,\n      cardType: MEMBER_CARD.DEPOSIT_CARD,\n      MEMBER_CARD,\n      cardData: {\n        // 储值卡名称\n        card_name: '',\n        // 特殊说明\n        special_note: '',\n        // 储值金额\n        card_price: null,\n        // 售卖价格\n        sell_price: null,\n        // 期限\n        num: null,\n        // 期限单位\n        unit: UNIT.DAY,\n        // 消费类目\n        card_consumer_id: [],\n        // 支持售卖时间\n        start_time: '',\n        end_time: '',\n        // 结束时间面板是否显示\n        endOpen: false,\n        // 卡背景\n        bg_image: {\n          image_id: 0,\n          image_key: this.cardBgList[0].image_key,\n          image_url: '',\n          index: 1\n        },\n        // 是否配置了用户端\n        appConfig: true,\n        // 卡介绍\n        card_contents: '',\n        // 备注\n        description: '',\n        // 是否支持转让\n        _is_transfer: false,\n        is_transfer: IS_TRANSFER.NOT_ALLOW,\n        // 转让单位\n        transfer_unit: TRANSFER_UNIT.RMB,\n        // 转让手续费\n        transfer_num: undefined,\n        // 售卖方式\n        card_sell_type: [SELL_TYPE.OFFLINE]\n      },\n      // 卡背景的help文本\n      cardBgValidatorText: '',\n      // 售卖时间\n      start_time: null,\n      end_time: null\n    }\n  },\n  mounted() {\n    this.syncAdmission()\n    this.h5CardInfo.consumption_range = {\n      id: CONSUMPTION_RANGE.ONLY_STORE,\n      name: this.shopName.name\n    }\n  },\n  methods: {\n    // 保存\n    onHandleSubmit(e) {\n      e.preventDefault()\n      this.cardBgValidator()\n      this.form.validate().then(values => {\n        if (this.cardBgIsOk) {\n          this.addService\n            .addCard({\n              card_name: values.cardData.card_name,\n              special_note: values.cardData.special_note,\n              sell_price: +values.cardData.sell_price,\n              card_price: +values.cardData.card_price,\n              num: +values.cardData.num,\n              unit: +this.cardData.unit,\n              card_consumer_id: values.cardData.card_consumer_id,\n              start_time: `${this.start_time.format('YYYY-MM-DD')}`,\n              end_time: `${this.end_time.format('YYYY-MM-DD')}`,\n              card_contents: this.cardData.card_contents,\n              description: this.cardData.description,\n              bg_image: this.cardData.bg_image,\n              card_sell_type: this.cardData.card_sell_type,\n              is_transfer: +this.cardData.is_transfer,\n              transfer_unit: this.cardData._is_transfer\n                ? +this.cardData.transfer_unit\n                : undefined,\n              transfer_num: this.cardData._is_transfer\n                ? +values.cardData.transfer_num\n                : undefined\n            })\n            .subscribe(res => {\n              // 新增成功\n              this.$router.push({\n                name: 'shop-product-card-deposit-list-all'\n              })\n            })\n        }\n      })\n    },\n    // 售卖时间-start\n    start_time_change(data) {\n      this.start_time = cloneDeep(data)\n    },\n    handleStartOpenChange(open) {\n      if (!open) {\n        this.cardData.endOpen = true\n      }\n    },\n    disabledStartDate(startValue) {\n      const endValue = this.end_time\n      if (!endValue) {\n        // 结束时间未选择\n        return (\n          startValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n        )\n      }\n      let start =\n        endValue.valueOf() >\n        moment()\n          .add(30, 'y')\n          .valueOf()\n          ? moment(endValue)\n              .subtract(30, 'y')\n              .valueOf()\n          : moment()\n              .startOf('day')\n              .valueOf()\n      return (\n        startValue.valueOf() < start ||\n        startValue.valueOf() > moment(endValue).valueOf()\n      )\n    },\n    // 售卖时间-end\n    end_time_change(data) {\n      this.end_time = cloneDeep(data)\n    },\n    handleEndOpenChange(open) {\n      this.cardData.endOpen = open\n    },\n    disabledEndDate(endValue) {\n      const startValue = this.start_time\n      if (!startValue) {\n        // 开始时间未选择\n        return (\n          endValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n        )\n      }\n      return (\n        endValue.valueOf() >=\n          moment(startValue)\n            .add(30, 'y')\n            .valueOf() ||\n        endValue.valueOf() < moment(startValue).valueOf() ||\n        endValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n      )\n    },\n    // moment\n    moment,\n    // 转让\n    transfer(e) {\n      this.cardData._is_transfer = e.target.checked\n      // 重置转让费用的校验\n      this.form.resetFields(['cardData.transfer_num'])\n    },\n    onCardBgChange(e) {\n      this.cardBgValidatorText = ''\n    },\n    // 卡背景校验\n    cardBgValidator() {\n      let validata = this.cardData.bg_image.image_key !== ''\n      this.cardBgValidatorText = validata ? '' : '请上传卡背景'\n    }\n  },\n  watch: {\n    'cardData._is_transfer': {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.cardData.is_transfer = +newVal\n      }\n    },\n    'cardData.transfer_unit': {\n      deep: true,\n      handler() {\n        this.form.resetFields(['cardData.transfer_num'])\n      }\n    }\n  },\n  computed: {\n    // 售卖方式\n    sell_type_list() {\n      let sell_type = cloneDeep(this.sellType)\n      let arr = []\n      sell_type.forEach(i => {\n        arr.push({\n          value: i.value,\n          label: i.label\n        })\n      })\n      if (!this.cardData.appConfig) {\n        remove(arr, i => i.value === SELL_TYPE.CLIENT)\n      }\n      return arr\n    },\n    // 卡背景是否校验通过\n    cardBgIsOk() {\n      return this.cardBgValidatorText === ''\n    },\n    // 转让设置的min\n    transferMin() {\n      return 0\n    },\n    // 转让设置的max\n    transferMax() {\n      return this.cardData.transfer_unit === TRANSFER_UNIT.PERCENT\n        ? 100\n        : 999999.9\n    }\n  }\n}\n</script>\n"]}]}