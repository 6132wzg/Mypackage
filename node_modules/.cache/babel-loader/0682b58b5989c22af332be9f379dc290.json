{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/sold/transaction/store.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/sold/transaction/store.vue","mtime":1600926556499},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.function.name\";\nimport \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport tableMixin from '@/mixins/table.mixin';\nimport { columns, ruleOptions } from \"./store.config\";\nimport StoreChooseSku from '@/views/biz-modals/store/choose-sku';\nimport StoreOrderTip from '@/views/biz-modals/store/order-tip';\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering';\nimport SoldDealAddMember from '@/views/biz-modals/sold/deal/add-member';\nimport SoldDealWaitPay from '@/views/biz-modals/brand/app/pos/wait-pay-result';\nimport { ListService } from \"./list.service\";\nimport { PatternService } from '@/services/pattern.service';\nimport { PRODUCT_TYPE } from '@/constants/sold/transaction';\nimport { MessageService } from '@/services/message.service';\nimport defaultImg from '@/assets/img/placeholder_good.png';\nexport default {\n  name: 'shopSoldTransactionCloud',\n  mixins: [tableMixin],\n  bem: {\n    basic: 'shop-sold-transaction-cloud'\n  },\n  modals: {\n    StoreChooseSku: StoreChooseSku,\n    StoreOrderTip: StoreOrderTip,\n    SoldDealGathering: SoldDealGathering,\n    SoldDealAddMember: SoldDealAddMember,\n    SoldDealWaitPay: SoldDealWaitPay\n  },\n  serviceInject: function serviceInject() {\n    return {\n      listService: ListService,\n      pattern: PatternService,\n      messageService: MessageService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.listService.loading$,\n      memberList: this.listService.memberList$,\n      saleList: this.listService.saleList$,\n      storeProductList: this.listService.storeProductList$,\n      currentPrice: this.listService.currentPrice$,\n      actualAmount: this.listService.actualAmount$,\n      couponList: this.listService.couponList$,\n      productPage: this.listService.productPage$\n    };\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      form: form,\n      decorators: decorators,\n      PRODUCT_TYPE: PRODUCT_TYPE,\n      defaultImg: defaultImg,\n      memberSearchText: '',\n      // 搜索会员value\n      couponText: '未选择优惠券',\n      // 选择的优惠券名\n      couponDropdownVisible: false,\n      selectCoupon: '',\n      // 优惠券选择的信息\n      reducePrice: null,\n      description: '',\n      buyCar: [],\n      productUrl: ''\n    };\n  },\n  watch: {\n    $searchQuery: function $searchQuery() {\n      this.productPage = {};\n      this.getList();\n    }\n  },\n  mounted: function mounted() {\n    this.getList();\n    this.$searchQuery.product_type = PRODUCT_TYPE.STORE;\n    this.listService.couponList$.commit(function () {\n      return [];\n    });\n    this.getUseCouponList(0);\n    this.listService.getSaleList().subscribe();\n  },\n  methods: {\n    productImg: function productImg(index) {\n      this.storeProductList[index].isError = true;\n    },\n    // 获取商品列表\n    getList: function getList() {\n      this.listService.getStoreProductList(this.$searchQuery).subscribe();\n    },\n    // 新增购物车\n    onSku: function onSku(record) {\n      var _this = this;\n\n      this.listService.getGoodsDetail(record).subscribe(function (res) {\n        if (res.all_spec) {\n          // 多规格新增至购物车\n          _this.$modalRouter.push({\n            name: 'store-choose-sku',\n            props: {\n              productData: res\n            },\n            on: {\n              success: function success(result) {\n                var state = _this.buyCarJudge(result.sku_id, result.stock_amount);\n\n                if (state === 'error') {\n                  return;\n                }\n\n                result.product_id = record;\n\n                if (!state) {\n                  _this.buyCar.push(result);\n                }\n\n                _this.onSelectProductChange();\n              }\n            }\n          });\n        } else {\n          // 单规格新增至购物车\n          var state = _this.buyCarJudge(res.product_sku[0].sku_id, res.product_sku[0].stock_amount);\n\n          if (state === 'error') {\n            return;\n          }\n\n          if (!state) {\n            _this.buyCar.push({\n              sku_id: res.product_sku[0].sku_id,\n              product_id: record,\n              nums: 1,\n              rule_name: '',\n              product_name: res.product_name,\n              unit_price: res.product_sku[0].selling_price,\n              stock_amount: res.product_sku[0].stock_amount\n            });\n          }\n\n          _this.onSelectProductChange();\n        }\n      });\n    },\n    // 购物车新增商品库存验证\n    buyCarJudge: function buyCarJudge(id, number) {\n      if (!number) {\n        this.messageService.warn({\n          content: '商品库存不足'\n        });\n        return 'error';\n      }\n\n      for (var i = 0; i < this.buyCar.length; i++) {\n        var val = this.buyCar[i];\n\n        if (val.sku_id === id) {\n          if (val.nums >= number) {\n            this.messageService.warn({\n              content: '商品库存不足'\n            });\n            return 'error';\n          } else {\n            val.nums = val.nums + 1;\n            return 'noAdd';\n          }\n        }\n      }\n\n      if (this.buyCar.length >= 20) {\n        this.messageService.warn({\n          content: '购物车已满'\n        });\n        return 'error';\n      }\n    },\n    // 删除购物车商品\n    onDelBuyCar: function onDelBuyCar(i) {\n      this.buyCar.splice(i, 1);\n\n      if (!this.buyCar.length) {\n        this.resetCoupon();\n      }\n\n      this.onSelectProductChange();\n    },\n    // 生成订单号\n    createOrderNum: function createOrderNum(type) {\n      var _this2 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this2.form.validate().then(function (values) {\n          var params = {\n            member_id: values.memberId,\n            coupon_id: _this2.selectCoupon.id,\n            sale_id: values.saleName,\n            reduce_price: _this2.reducePrice || 0,\n            description: _this2.description,\n            sale_range: 1,\n            shipping_mode: 1,\n            order_amount: _this2.currentPrice,\n            sku_info: _this2.buyCar\n          };\n\n          if (type === 'order') {\n            _this2.listService.createOrder(params).subscribe(function (result) {\n              _this2.clearData();\n\n              resolve(result.info.order_id.order_id);\n            });\n          } else {\n            _this2.listService.createOrderPay(params).subscribe(function (result) {\n              _this2.clearData();\n\n              resolve(result.info.order_id.order_id);\n            });\n          }\n        });\n      });\n    },\n    clearData: function clearData() {\n      this.buyCar = [];\n      this.selectCoupon = '';\n      this.reducePrice = '';\n      this.description = '';\n      this.listService.couponList$.commit(function () {\n        return [];\n      });\n      this.listService.currentPrice$.commit(function () {\n        return 0;\n      });\n      this.couponText = '未选择优惠券';\n      this.form.setFieldsValue({\n        memberId: '',\n        saleName: ''\n      });\n    },\n    // 创建订单\n    onCreateOrder: function () {\n      var _onCreateOrder = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var orderId;\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.createOrderNum('order');\n\n              case 2:\n                orderId = _context.sent;\n                this.payCallBack({\n                  type: 'create',\n                  message: '订单创建成功'\n                }, orderId);\n\n              case 4:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function onCreateOrder() {\n        return _onCreateOrder.apply(this, arguments);\n      }\n\n      return onCreateOrder;\n    }(),\n    createdWaitPay: function createdWaitPay(props) {\n      var _this3 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this3.$modalRouter.push({\n          name: 'sold-deal-wait-pay',\n          props: props,\n          on: {\n            success: resolve\n          }\n        });\n      });\n    },\n    // 立即支付\n    onPayOrder: function () {\n      var _onPayOrder = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2(orderId) {\n        var _this4 = this;\n\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (orderId) {\n                  _context2.next = 4;\n                  break;\n                }\n\n                _context2.next = 3;\n                return this.createOrderNum('orderPay');\n\n              case 3:\n                orderId = _context2.sent;\n\n              case 4:\n                this.$modalRouter.push({\n                  name: 'sold-deal-gathering',\n                  props: {\n                    order_id: orderId,\n                    type: 'cloud_store'\n                  },\n                  on: {\n                    success: function success(res) {\n                      if (res.type === 'pos') {\n                        _this4.createdWaitPay(res).then(function () {\n                          // 判断是否为pos机支付\n                          _this4.payCallBack({\n                            type: 'pay',\n                            message: '收款成功'\n                          }, orderId);\n                        });\n                      } else {\n                        // 判断是否为pos机支付\n                        _this4.payCallBack({\n                          type: 'pay',\n                          message: '收款成功'\n                        }, orderId);\n                      }\n                    }\n                  }\n                });\n\n              case 5:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function onPayOrder(_x) {\n        return _onPayOrder.apply(this, arguments);\n      }\n\n      return onPayOrder;\n    }(),\n    // 收款完提示\n    payCallBack: function payCallBack(props, orderId) {\n      var _this5 = this;\n\n      this.$modalRouter.push({\n        name: 'store-order-tip',\n        props: props,\n        on: {\n          success: function success(res) {\n            switch (res.type) {\n              case 'PrintOrder':\n                _this5.printOrder(orderId);\n\n                break;\n\n              case 'ViewOrder':\n                _this5.createdOrderViewOrder(orderId);\n\n                break;\n\n              case 'Pay':\n                _this5.onPayOrder(orderId);\n\n                break;\n            }\n          }\n        }\n      });\n    },\n    // 小票打印\n    printOrder: function printOrder(order_id) {\n      window.open('/ticket/gathering-print?id=' + order_id, '_blank', 'width=800,height=600');\n    },\n    // 查看订单\n    createdOrderViewOrder: function createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      });\n    },\n    // 新增会员\n    addMember: function addMember() {\n      var _this6 = this;\n\n      this.$modalRouter.push({\n        name: 'sold-deal-add-member',\n        on: {\n          success: function success(res) {\n            _this6.onMemberSearch(res.name, res.id);\n          }\n        }\n      });\n    },\n    // 清空优惠券\n    resetCoupon: function resetCoupon() {\n      this.selectCoupon = '';\n      this.listService.couponList$.commit(function () {\n        return [];\n      });\n      this.couponText = '未选择优惠券';\n    },\n    // 购买商品的变化\n    onSelectProductChange: function onSelectProductChange() {\n      this.getPrice();\n      this.getUseCouponList();\n    },\n    // 会员搜索\n    onMemberSearch: function onMemberSearch(data, memberId) {\n      var _this7 = this;\n\n      this.memberSearchText = data;\n\n      if (!data) {\n        this.listService.memberList$.commit(function () {\n          return [];\n        });\n        this.form.resetFields(['memberId']);\n      } else {\n        this.listService.getMember(data, 1).subscribe(function (res) {\n          if (!res.list.length) {\n            _this7.form.resetFields(['memberId']);\n          }\n\n          if (memberId) {\n            _this7.form.setFieldsValue({\n              memberId: memberId\n            });\n          }\n        });\n      }\n    },\n    onMemberBlur: function onMemberBlur() {\n      var memberId = this.form.getFieldValue('memberId');\n\n      if (!memberId) {\n        this.resetCoupon();\n        this.getPrice();\n      }\n    },\n    // 会员Id变化 获取价格和优惠券列表\n    onMemberChange: function onMemberChange(data) {\n      console.log('onMemberChange', data);\n      this.resetCoupon();\n      this.getPrice(data);\n      if (data) this.getUseCouponList(data);\n    },\n    // 优惠券处理\n    onSelectCouponChange: function onSelectCouponChange(event) {\n      var price = this.couponList.filter(function (o) {\n        return o.id === event.target.value.id;\n      })[0].price;\n      this.couponText = \"\".concat(price, \"\\u5143\");\n      this.getPrice(0);\n    },\n    // 优惠券处理\n    onSelectCoupon: function onSelectCoupon() {\n      this.couponDropdownVisible = false;\n    },\n    // 价格计算\n    getPrice: function getPrice() {\n      var selectMemberId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';\n      var productInfo = [];\n      var memberId = selectMemberId || this.form.getFieldValue('memberId');\n      this.buyCar.forEach(function (val) {\n        productInfo.push({\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        });\n      });\n      this.listService.getStorePrice({\n        product_type: 8,\n        reduce_amount: this.reducePrice || undefined,\n        coupon_id: this.selectCoupon.id || undefined,\n        member_id: memberId || undefined,\n        product_info: productInfo.length ? productInfo : undefined\n      }).subscribe();\n    },\n    // 获取可用优惠券\n    getUseCouponList: function getUseCouponList(cardId) {\n      var productInfo = [];\n      var memberId = cardId ? cardId : this.form.getFieldValue('memberId');\n      this.buyCar.forEach(function (val) {\n        productInfo.push({\n          product_id: val.product_id,\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        });\n      });\n      this.listService.getUseCoupon({\n        product_info: JSON.stringify(productInfo),\n        member_id: memberId\n      }).subscribe();\n    },\n    // 分页切换\n    onChange: function onChange(pagination) {\n      this.$searchQuery.current_page = pagination.current;\n      this.$searchQuery.size = pagination.pageSize;\n      this.getList();\n    }\n  },\n  computed: {\n    columns: columns\n  }\n};",{"version":3,"sources":["store.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <st-panel :class=\"basic()\" :loading=\"loading.getStoreProductList\">\n    <st-mina-panel app>\n      <div slot=\"actions\" :class=\"basic('footer')\">\n        <div :class=\"basic('footer-page')\">\n          <st-pagination :page=\"productPage\" @change=\"onChange\" class=\"mg-t8\" />\n        </div>\n        <div :class=\"basic('footer-action')\">\n          <div class=\"price\">\n            <span>共{{ buyCar.length }}件商品 合计：</span>\n            <span class=\"money font-number\">&yen; {{ currentPrice }}</span>\n          </div>\n          <div class=\"button\">\n            <st-button @click=\"onCreateOrder\" :loading=\"loading.createOrder\">\n              创建订单\n            </st-button>\n            <st-button\n              type=\"primary\"\n              class=\"mg-l16\"\n              @click=\"onPayOrder(null)\"\n              :loading=\"loading.createOrderPay\"\n            >\n              立即支付\n            </st-button>\n          </div>\n        </div>\n      </div>\n      <div :class=\"basic('list')\">\n        <div :class=\"basic('head')\">\n          <p :class=\"basic('title')\">查看商品</p>\n          <st-input-search\n            style=\"width: 291px\"\n            v-model=\"$searchQuery.product_name\"\n            @search=\"onKeywordsSearch('product_name', $event)\"\n            placeholder=\"请输入商品名查找\"\n            :class=\"basic('search')\"\n          />\n        </div>\n        <ul :class=\"basic('product')\" v-if=\"storeProductList.length\">\n          <li v-for=\"(item, index) in storeProductList\" :key=\"index\">\n            <img\n              :class=\"basic('product-img')\"\n              v-if=\"item.isError\"\n              :src=\"defaultImg\"\n              alt=\"\"\n            />\n            <img\n              v-else\n              :class=\"basic('product-img')\"\n              :src=\"item.img | imgFilter({ w: 194, h: 172 })\"\n              @error=\"productImg(index)\"\n              alt=\"\"\n            />\n            <div :class=\"basic('product-name')\">\n              <span>{{ item.product_name }}</span>\n            </div>\n            <div :class=\"basic('product-price')\">\n              <span class=\"font-number\">\n                {{ item.price }}\n              </span>\n              <span>库存:{{ item.count }}件</span>\n            </div>\n            <div class=\"product-mask\" @click=\"onSku(item.id)\">\n              <img src=\"@/assets/img/icon-buy-car.png\" alt=\"\" />\n              <p>新增至购物车</p>\n            </div>\n          </li>\n        </ul>\n        <st-no-data v-else></st-no-data>\n      </div>\n      <div :class=\"basic('buycar')\">\n        <p class=\"title\">购物车</p>\n        <div>\n          <st-form :form=\"form\" labelWidth=\"66px\">\n            <st-form-item :class=\"basic('padding')\">\n              <st-table\n                :class=\"basic('table')\"\n                rowKey=\"sku_id\"\n                :pagination=\"false\"\n                :columns=\"columns\"\n                :scroll=\"{ y: 320 }\"\n                :dataSource=\"buyCar\"\n              >\n                <template slot=\"product_name\" slot-scope=\"customRender, record\">\n                  <div>\n                    {{ record.product_name }}\n                    <span v-if=\"record.rule_name\">\n                      ({{ record.rule_name }})\n                    </span>\n                  </div>\n                </template>\n                <template slot=\"stock_amount\" slot-scope=\"customRender, record\">\n                  <a-input-number\n                    :min=\"1\"\n                    :max=\"record.stock_amount\"\n                    @change=\"onSelectProductChange\"\n                    v-model=\"record.nums\"\n                  />\n                </template>\n                <template slot=\"priceSum\" slot-scope=\"customRender, record\">\n                  {{ (record.nums * record.unit_price).toFixed(1) }}\n                </template>\n                <template\n                  slot=\"action\"\n                  slot-scope=\"customRender, record, index\"\n                >\n                  <st-table-actions sytle=\"width: 120px\">\n                    <a @click=\"onDelBuyCar(index)\">\n                      删除\n                    </a>\n                  </st-table-actions>\n                </template>\n              </st-table>\n              <div\n                :class=\"basic('all-price')\"\n                class=\"font-number\"\n                v-if=\"buyCar.length\"\n              >\n                总额：&yen; {{ actualAmount }}\n              </div>\n            </st-form-item>\n            <st-form-item :class=\"basic('padding')\">\n              <div class=\"divider-line\"></div>\n            </st-form-item>\n            <st-form-item label=\"购买会员\" required>\n              <a-select\n                showSearch\n                allowClear\n                placeholder=\"输入手机号或会员名搜索\"\n                :defaultActiveFirstOption=\"false\"\n                :showArrow=\"false\"\n                :filterOption=\"false\"\n                v-decorator=\"decorators.memberId\"\n                @search=\"onMemberSearch\"\n                @change=\"onMemberChange\"\n                @blur=\"onMemberBlur\"\n              >\n                <template\n                  slot=\"notFoundContent\"\n                  v-if=\"!memberList.length && memberSearchText !== ''\"\n                >\n                  <div>\n                    暂无此会员，\n                    <span :class=\"basic('add-member')\" @click=\"addMember\">\n                      新增新会员？\n                    </span>\n                  </div>\n                </template>\n                <a-select-option\n                  v-for=\"(item, index) in memberList\"\n                  :value=\"item.id\"\n                  :key=\"index\"\n                >\n                  <span\n                    v-html=\"\n                      `${item.member_name} ${item.mobile}`.replace(\n                        new RegExp(memberSearchText, 'g'),\n                        `\\<span class='global-highlight-color'\\>${memberSearchText}\\<\\/span\\>`\n                      )\n                    \"\n                  >\n                    {{ item.member_name }} {{ item.mobile }}\n                  </span>\n                </a-select-option>\n              </a-select>\n            </st-form-item>\n            <st-form-item :class=\"basic('discounts')\" label=\"优惠券\">\n              <div>\n                <div :class=\"basic('discounts-total')\">\n                  <span>{{ couponText }}</span>\n                  <a-dropdown\n                    v-model=\"couponDropdownVisible\"\n                    :disabled=\"couponList.length === 0\"\n                    :class=\"basic({ disabled: couponList.length === 0 })\"\n                    placement=\"bottomRight\"\n                    :getPopupContainer=\"trigger => trigger.parentNode\"\n                    :trigger=\"['click']\"\n                  >\n                    <div :class=\"basic('discounts-promotion')\">\n                      <span>{{ couponList.length }}张可用优惠券</span>\n                      <a-icon type=\"right\" />\n                    </div>\n                    <a-radio-group\n                      v-model=\"selectCoupon\"\n                      @change=\"onSelectCouponChange\"\n                      :class=\"basic('dropdown')\"\n                      slot=\"overlay\"\n                    >\n                      <a-menu>\n                        <a-menu-item\n                          @click=\"onSelectCoupon\"\n                          :key=\"index\"\n                          v-for=\"(item, index) in couponList\"\n                        >\n                          <a-radio :value=\"item\">\n                            {{ item.name }}{{ item.price }}\n                          </a-radio>\n                        </a-menu-item>\n                      </a-menu>\n                    </a-radio-group>\n                  </a-dropdown>\n                </div>\n              </div>\n            </st-form-item>\n            <st-form-item label=\"减免\">\n              <st-input-number\n                :float=\"true\"\n                @input=\"getPrice(0)\"\n                v-model=\"reducePrice\"\n                maxlength=\"12\"\n                placeholder=\"请输入减免金额\"\n              >\n                <span slot=\"addonAfter\">元</span>\n              </st-input-number>\n            </st-form-item>\n            <st-form-item label=\"销售\">\n              <a-select\n                v-decorator=\"decorators.saleName\"\n                placeholder=\"请选择销售名字\"\n              >\n                <a-select-option\n                  v-for=\"(item, index) in saleList\"\n                  :key=\"index\"\n                  :value=\"item.id\"\n                >\n                  {{ item.staff_name }}\n                </a-select-option>\n              </a-select>\n            </st-form-item>\n            <st-form-item label=\"备注\">\n              <a-textarea\n                v-model=\"description\"\n                maxlength=\"200\"\n                placeholder=\"请填写备注\"\n                class=\"st-textarea\"\n              ></a-textarea>\n            </st-form-item>\n          </st-form>\n        </div>\n      </div>\n    </st-mina-panel>\n  </st-panel>\n</template>\n\n<script>\nimport tableMixin from '@/mixins/table.mixin'\nimport { columns, ruleOptions } from './store.config'\nimport StoreChooseSku from '@/views/biz-modals/store/choose-sku'\nimport StoreOrderTip from '@/views/biz-modals/store/order-tip'\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering'\nimport SoldDealAddMember from '@/views/biz-modals/sold/deal/add-member'\nimport SoldDealWaitPay from '@/views/biz-modals/brand/app/pos/wait-pay-result'\nimport { ListService } from './list.service'\nimport { PatternService } from '@/services/pattern.service'\nimport { PRODUCT_TYPE } from '@/constants/sold/transaction'\nimport { MessageService } from '@/services/message.service'\nimport defaultImg from '@/assets/img/placeholder_good.png'\nexport default {\n  name: 'shopSoldTransactionCloud',\n  mixins: [tableMixin],\n  bem: {\n    basic: 'shop-sold-transaction-cloud'\n  },\n  modals: {\n    StoreChooseSku,\n    StoreOrderTip,\n    SoldDealGathering,\n    SoldDealAddMember,\n    SoldDealWaitPay\n  },\n  serviceInject() {\n    return {\n      listService: ListService,\n      pattern: PatternService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.listService.loading$,\n      memberList: this.listService.memberList$,\n      saleList: this.listService.saleList$,\n      storeProductList: this.listService.storeProductList$,\n      currentPrice: this.listService.currentPrice$,\n      actualAmount: this.listService.actualAmount$,\n      couponList: this.listService.couponList$,\n      productPage: this.listService.productPage$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      PRODUCT_TYPE,\n      defaultImg,\n      memberSearchText: '', // 搜索会员value\n      couponText: '未选择优惠券', // 选择的优惠券名\n      couponDropdownVisible: false,\n      selectCoupon: '', // 优惠券选择的信息\n      reducePrice: null,\n      description: '',\n      buyCar: [],\n      productUrl: ''\n    }\n  },\n  watch: {\n    $searchQuery() {\n      this.productPage = {}\n      this.getList()\n    }\n  },\n  mounted() {\n    this.getList()\n    this.$searchQuery.product_type = PRODUCT_TYPE.STORE\n    this.listService.couponList$.commit(() => [])\n    this.getUseCouponList(0)\n    this.listService.getSaleList().subscribe()\n  },\n  methods: {\n    productImg(index) {\n      this.storeProductList[index].isError = true\n    },\n    // 获取商品列表\n    getList() {\n      this.listService.getStoreProductList(this.$searchQuery).subscribe()\n    },\n    // 新增购物车\n    onSku(record) {\n      this.listService.getGoodsDetail(record).subscribe(res => {\n        if (res.all_spec) {\n          // 多规格新增至购物车\n          this.$modalRouter.push({\n            name: 'store-choose-sku',\n            props: {\n              productData: res\n            },\n            on: {\n              success: result => {\n                let state = this.buyCarJudge(result.sku_id, result.stock_amount)\n                if (state === 'error') {\n                  return\n                }\n                result.product_id = record\n                if (!state) {\n                  this.buyCar.push(result)\n                }\n                this.onSelectProductChange()\n              }\n            }\n          })\n        } else {\n          // 单规格新增至购物车\n          let state = this.buyCarJudge(\n            res.product_sku[0].sku_id,\n            res.product_sku[0].stock_amount\n          )\n          if (state === 'error') {\n            return\n          }\n          if (!state) {\n            this.buyCar.push({\n              sku_id: res.product_sku[0].sku_id,\n              product_id: record,\n              nums: 1,\n              rule_name: '',\n              product_name: res.product_name,\n              unit_price: res.product_sku[0].selling_price,\n              stock_amount: res.product_sku[0].stock_amount\n            })\n          }\n          this.onSelectProductChange()\n        }\n      })\n    },\n    // 购物车新增商品库存验证\n    buyCarJudge(id, number) {\n      if (!number) {\n        this.messageService.warn({ content: '商品库存不足' })\n        return 'error'\n      }\n      for (let i = 0; i < this.buyCar.length; i++) {\n        let val = this.buyCar[i]\n        if (val.sku_id === id) {\n          if (val.nums >= number) {\n            this.messageService.warn({ content: '商品库存不足' })\n            return 'error'\n          } else {\n            val.nums = val.nums + 1\n            return 'noAdd'\n          }\n        }\n      }\n      if (this.buyCar.length >= 20) {\n        this.messageService.warn({ content: '购物车已满' })\n        return 'error'\n      }\n    },\n    // 删除购物车商品\n    onDelBuyCar(i) {\n      this.buyCar.splice(i, 1)\n      if (!this.buyCar.length) {\n        this.resetCoupon()\n      }\n      this.onSelectProductChange()\n    },\n    // 生成订单号\n    createOrderNum(type) {\n      return new Promise((resolve, reject) => {\n        this.form.validate().then(values => {\n          let params = {\n            member_id: values.memberId,\n            coupon_id: this.selectCoupon.id,\n            sale_id: values.saleName,\n            reduce_price: this.reducePrice || 0,\n            description: this.description,\n            sale_range: 1,\n            shipping_mode: 1,\n            order_amount: this.currentPrice,\n            sku_info: this.buyCar\n          }\n          if (type === 'order') {\n            this.listService.createOrder(params).subscribe(result => {\n              this.clearData()\n              resolve(result.info.order_id.order_id)\n            })\n          } else {\n            this.listService.createOrderPay(params).subscribe(result => {\n              this.clearData()\n              resolve(result.info.order_id.order_id)\n            })\n          }\n        })\n      })\n    },\n    clearData() {\n      this.buyCar = []\n      this.selectCoupon = ''\n      this.reducePrice = ''\n      this.description = ''\n      this.listService.couponList$.commit(() => [])\n      this.listService.currentPrice$.commit(() => 0)\n      this.couponText = '未选择优惠券'\n      this.form.setFieldsValue({\n        memberId: '',\n        saleName: ''\n      })\n    },\n    // 创建订单\n    async onCreateOrder() {\n      let orderId = await this.createOrderNum('order')\n      this.payCallBack(\n        {\n          type: 'create',\n          message: '订单创建成功'\n        },\n        orderId\n      )\n    },\n    createdWaitPay(props) {\n      return new Promise((resolve, reject) => {\n        this.$modalRouter.push({\n          name: 'sold-deal-wait-pay',\n          props,\n          on: {\n            success: resolve\n          }\n        })\n      })\n    },\n    // 立即支付\n    async onPayOrder(orderId) {\n      if (!orderId) {\n        orderId = await this.createOrderNum('orderPay')\n      }\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering',\n        props: {\n          order_id: orderId,\n          type: 'cloud_store'\n        },\n        on: {\n          success: res => {\n            if (res.type === 'pos') {\n              this.createdWaitPay(res).then(() => {\n                // 判断是否为pos机支付\n                this.payCallBack(\n                  {\n                    type: 'pay',\n                    message: '收款成功'\n                  },\n                  orderId\n                )\n              })\n            } else {\n              // 判断是否为pos机支付\n              this.payCallBack(\n                {\n                  type: 'pay',\n                  message: '收款成功'\n                },\n                orderId\n              )\n            }\n          }\n        }\n      })\n    },\n    // 收款完提示\n    payCallBack(props, orderId) {\n      this.$modalRouter.push({\n        name: 'store-order-tip',\n        props,\n        on: {\n          success: res => {\n            switch (res.type) {\n              case 'PrintOrder':\n                this.printOrder(orderId)\n                break\n              case 'ViewOrder':\n                this.createdOrderViewOrder(orderId)\n                break\n              case 'Pay':\n                this.onPayOrder(orderId)\n                break\n            }\n          }\n        }\n      })\n    },\n    // 小票打印\n    printOrder(order_id) {\n      window.open(\n        '/ticket/gathering-print?id=' + order_id,\n        '_blank',\n        'width=800,height=600'\n      )\n    },\n    // 查看订单\n    createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      })\n    },\n    // 新增会员\n    addMember() {\n      this.$modalRouter.push({\n        name: 'sold-deal-add-member',\n        on: {\n          success: res => {\n            this.onMemberSearch(res.name, res.id)\n          }\n        }\n      })\n    },\n    // 清空优惠券\n    resetCoupon() {\n      this.selectCoupon = ''\n      this.listService.couponList$.commit(() => [])\n      this.couponText = '未选择优惠券'\n    },\n    // 购买商品的变化\n    onSelectProductChange() {\n      this.getPrice()\n      this.getUseCouponList()\n    },\n    // 会员搜索\n    onMemberSearch(data, memberId) {\n      this.memberSearchText = data\n      if (!data) {\n        this.listService.memberList$.commit(() => [])\n        this.form.resetFields(['memberId'])\n      } else {\n        this.listService.getMember(data, 1).subscribe(res => {\n          if (!res.list.length) {\n            this.form.resetFields(['memberId'])\n          }\n          if (memberId) {\n            this.form.setFieldsValue({\n              memberId\n            })\n          }\n        })\n      }\n    },\n    onMemberBlur() {\n      let memberId = this.form.getFieldValue('memberId')\n      if (!memberId) {\n        this.resetCoupon()\n        this.getPrice()\n      }\n    },\n    // 会员Id变化 获取价格和优惠券列表\n    onMemberChange(data) {\n      console.log('onMemberChange', data)\n      this.resetCoupon()\n      this.getPrice(data)\n      if (data) this.getUseCouponList(data)\n    },\n    // 优惠券处理\n    onSelectCouponChange(event) {\n      let price = this.couponList.filter(o => o.id === event.target.value.id)[0]\n        .price\n      this.couponText = `${price}元`\n      this.getPrice(0)\n    },\n    // 优惠券处理\n    onSelectCoupon() {\n      this.couponDropdownVisible = false\n    },\n    // 价格计算\n    getPrice(selectMemberId = '') {\n      let productInfo = []\n      const memberId = selectMemberId || this.form.getFieldValue('memberId')\n      this.buyCar.forEach(val => {\n        productInfo.push({\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        })\n      })\n      this.listService\n        .getStorePrice({\n          product_type: 8,\n          reduce_amount: this.reducePrice || undefined,\n          coupon_id: this.selectCoupon.id || undefined,\n          member_id: memberId || undefined,\n          product_info: productInfo.length ? productInfo : undefined\n        })\n        .subscribe()\n    },\n    // 获取可用优惠券\n    getUseCouponList(cardId) {\n      let productInfo = []\n      const memberId = cardId ? cardId : this.form.getFieldValue('memberId')\n      this.buyCar.forEach(val => {\n        productInfo.push({\n          product_id: val.product_id,\n          sku_id: val.sku_id,\n          nums: val.nums || 0\n        })\n      })\n      this.listService\n        .getUseCoupon({\n          product_info: JSON.stringify(productInfo),\n          member_id: memberId\n        })\n        .subscribe()\n    },\n    // 分页切换\n    onChange(pagination) {\n      this.$searchQuery.current_page = pagination.current\n      this.$searchQuery.size = pagination.pageSize\n      this.getList()\n    }\n  },\n  computed: {\n    columns\n  }\n}\n</script>\n"],"sourceRoot":"src/views/pages/shop/sold/transaction"}]}