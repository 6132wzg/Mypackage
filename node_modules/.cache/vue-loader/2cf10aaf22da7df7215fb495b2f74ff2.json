{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/store/add.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/store/add.vue","mtime":1600926556578},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { ruleOptions, skuColumns } from './add.config'\nimport StImageUpload from '@/views/components/image-upload#/image-upload.vue'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport StoreClassManage from '@/views/biz-modals/store/class-manage.vue'\nimport { PatternService } from '@/services/pattern.service'\nimport { AddService } from './add.service.ts'\nimport StoreAddSku from '@/views/biz-modals/store/add-sku'\nimport { result } from 'lodash-es'\nimport { UserService } from '@/services/user.service'\nimport { cloneDeep } from 'lodash-es'\nexport default {\n  bem: {\n    basic: 'shop-store-add',\n    skuItem: 'sku-item'\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      addService: AddService,\n      userService: UserService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.addService.loading$,\n      saleType: this.userService.getOptions$('cloud_store.sale_type'),\n      shippingMode: this.userService.getOptions$('cloud_store.shipping_mode'),\n      shelvesStatus: this.userService.getOptions$(\n        'cloud_store.edit_shelves_status'\n      )\n    }\n  },\n  modals: { StoreClassManage, StoreAddSku },\n  props: {\n    isEditMode: {\n      type: Boolean,\n      default: false\n    },\n    info: {\n      type: Object,\n      default: () => {}\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      cropperModal: {\n        cropper: {\n          aspectRatio: 1\n        }\n      },\n      name: '', // 商品名称\n      isMore: 1, // 是否是多规格\n      tableData: [\n        {\n          market_price: '',\n          selling_price: '',\n          stock_amount: '',\n          key: parseInt(Math.random() * 999999).toString()\n        }\n      ],\n      skuList: [],\n      content: '',\n      isEditor: false,\n      fileList: [], // 商品图片组件中\n      imgList: [], //上传的图片\n      isImgError: false,\n      shelves_status: 1,\n      product_images_del: [],\n      product_images_add: [],\n      classList: [],\n      tableErr: false,\n      tableTips: '',\n      isChoose: false,\n      isDisabledCourier: false\n    }\n  },\n  components: {\n    StEditor,\n    StImageUpload\n  },\n  computed: {\n    skuColumns,\n    sku() {\n      let list = []\n      this.skuList.forEach((item, index) => {\n        let skuItem = {\n          title: item.spec_name,\n          dataIndex: index\n        }\n        list.push(skuItem)\n      })\n      return list\n    }\n  },\n  mounted() {\n    this.addService.getList().subscribe(res => {\n      this.classList = res.list\n    })\n    if (this.isEditMode) {\n      this.goodDetail()\n    }\n  },\n  methods: {\n    changeSale(event) {\n      let type = this.form.getFieldValue('delivery_type')\n      let deliveryType = []\n      if (event.indexOf(1) !== -1) {\n        this.isChoose = true\n        if (type !== undefined) {\n          deliveryType = type\n        }\n        if (deliveryType.indexOf(1) === -1) {\n          deliveryType.push(1)\n          this.form.setFieldsValue({\n            delivery_type: deliveryType\n          })\n        }\n      } else {\n        this.isChoose = false\n      }\n      if (event.indexOf(1) !== -1 && event.indexOf(2) === -1) {\n        this.isDisabledCourier = true\n      } else {\n        this.isDisabledCourier = false\n      }\n    },\n    // 保存\n    onSubmit() {\n      let isReturn = false\n      let tableError = false\n      if (!this.imgList.length) {\n        this.isReturn = true\n        this.isImgError = true\n      }\n      this.skuList.forEach(item => {\n        item.isErr = false\n        item.isNameErr = false\n        if (!item.spec_item_name.length) {\n          item.isErr = true\n          isReturn = true\n        }\n        if (!item.spec_name) {\n          item.isNameErr = true\n          isReturn = true\n        }\n      })\n      this.tableData.forEach(item => {\n        if (\n          !item.market_price ||\n          !item.selling_price ||\n          (!this.isEditMode && !item.stock_amount)\n        ) {\n          tableError = true\n          this.tableTips = '请正确填写表格'\n          this.tableErr = true\n          isReturn = true\n        }\n      })\n      if (!tableError) {\n        this.tableTips = ''\n        this.tableErr = false\n      }\n      this.form.validate().then(values => {\n        if (isReturn) {\n          return\n        }\n        if (this.isEditMode) {\n          this.editGoodOld(values)\n        } else {\n          this.addGoodNew(values)\n        }\n      })\n    },\n    addGoodNew(values) {\n      let data = {}\n      let product_sku = []\n      let spec_name_arr = []\n      this.tableData.forEach((item, index) => {\n        let skuItem = {}\n        skuItem.market_price = item.market_price\n        skuItem.selling_price = item.selling_price\n        skuItem.stock_amount = item.stock_amount\n        skuItem.spec_arr = []\n        if (this.skuList.length > 0) {\n          skuItem.spec_arr.push({\n            spec_name: this.skuList[0].spec_name,\n            spec_item_name: item['0']\n          })\n        }\n        if (this.skuList.length > 1) {\n          skuItem.spec_arr.push({\n            spec_name: this.skuList[1].spec_name,\n            spec_item_name: item['1']\n          })\n        }\n        if (this.skuList.length > 2) {\n          skuItem.spec_arr.push({\n            spec_name: this.skuList[2].spec_name,\n            spec_item_name: item['2']\n          })\n        }\n        product_sku.push(skuItem)\n      })\n      this.skuList.forEach(item => {\n        spec_name_arr.push(item.spec_name)\n      })\n      data = {\n        product_images: this.imgList, // 商品图片\n        product_intro: this.content, // 商品介绍\n        product_sku: product_sku, // 规格设置\n        shelves_status: this.shelves_status, // 上架状态\n        product_name: values.product_name, // 商品名称\n        category_id: values.category_id, // 分类id\n        delivery_type:\n          values.delivery_type.length === this.shippingMode.length\n            ? -1\n            : values.delivery_type[0], // 配送方式\n        sale_type:\n          values.sale_type.length === this.saleType.length\n            ? -1\n            : values.sale_type[0], // 售卖方式\n        spec_name_arr\n      }\n      this.addService.addGoods(data).subscribe(res => {\n        this.$router.push({\n          path: './list'\n        })\n      })\n    },\n    editGoodOld(values) {\n      let data = {}\n      let product_sku = []\n      this.tableData.forEach((item, index) => {\n        let skuItem = {}\n        skuItem.market_price = item.market_price\n        skuItem.selling_price = item.selling_price\n        skuItem.stock_amount = item.stock_amount\n        if (item.sku_id) {\n          skuItem.is_update = item.is_update\n          skuItem.sku_id = item.sku_id\n        }\n        skuItem.spec_arr = []\n        if (this.skuList.length > 0) {\n          let sku = {}\n          this.info.all_spec[0].spec_item_arr.forEach(spec => {\n            sku.spec_id = this.info.all_spec[0].spec_id\n            if (spec.spec_item_name === item['0']) {\n              sku.spec_item_id = spec.spec_item_id\n            }\n          })\n          sku.spec_name = this.skuList[0].spec_name\n          sku.spec_item_name = item['0']\n          skuItem.spec_arr.push(sku)\n        }\n        if (this.skuList.length > 1) {\n          let sku = {}\n          this.info.all_spec[1].spec_item_arr.forEach(spec => {\n            sku.spec_id = this.info.all_spec[1].spec_id\n            if (spec.spec_item_name === item['1']) {\n              sku.spec_item_id = spec.spec_item_id\n            }\n          })\n          sku.spec_name = this.skuList[1].spec_name\n          sku.spec_item_name = item['1']\n          skuItem.spec_arr.push(sku)\n        }\n        if (this.skuList.length > 2) {\n          let sku = {}\n          this.info.all_spec[2].spec_item_arr.forEach(spec => {\n            sku.spec_id = this.info.all_spec[2].spec_id\n            if (spec.spec_item_name === item['2']) {\n              sku.spec_item_id = spec.spec_item_id\n            }\n          })\n          sku.spec_name = this.skuList[2].spec_name\n          sku.spec_item_name = item['2']\n          skuItem.spec_arr.push(sku)\n        }\n        product_sku.push(skuItem)\n      })\n      data = {\n        product_images_del: this.product_images_del, // 商品图片\n        product_images_add: this.imgList.filter(item => item.isNew), // 商品图片\n        product_intro: this.content, // 商品介绍\n        product_sku: product_sku, // 规格设置\n        shelves_status: this.shelves_status, // 上架状态\n        product_name: values.product_name, // 商品名称\n        category_id: values.category_id, // 分类id\n        delivery_type:\n          values.delivery_type.length === this.shippingMode.length\n            ? -1\n            : values.delivery_type[0], // 配送方式\n        sale_type:\n          values.sale_type.length === this.saleType.length\n            ? -1\n            : values.sale_type[0] // 售卖方式\n      }\n      this.addService.editGoods(this.$route.query.id, data).subscribe(res => {\n        this.$router.push({\n          path: './list'\n        })\n      })\n    },\n    goodDetail() {\n      this.form.setFieldsValue({\n        product_name: this.info.product_name,\n        category_id: this.info.category_id,\n        delivery_type:\n          this.info.delivery_type === -1\n            ? this.shippingMode.map(item => item.value)\n            : [this.info.delivery_type],\n        sale_type:\n          this.info.sale_type === -1\n            ? this.saleType.map(item => item.value)\n            : [this.info.sale_type]\n      })\n      this.name = this.info.product_name\n      this.isMore = this.info.all_spec ? 2 : 1\n      this.imgList = this.info.product_images\n      this.content = this.info.product_intro\n      this.shelves_status = this.info.shelves_status\n      this.skuList = []\n      if (this.info.all_spec) {\n        this.info.all_spec.forEach(item => {\n          let list = []\n          if (item.spec_item_arr) {\n            item.spec_item_arr.forEach(it => {\n              list.push(it.spec_item_name)\n            })\n            this.skuList.push({\n              spec_name: item.spec_name,\n              spec_item_name: list,\n              isErr: false,\n              isNameErr: false\n            })\n          }\n        })\n      }\n      let tableData = []\n      this.info.product_sku.forEach((item, index) => {\n        let tableItem = {}\n        tableItem.market_price = item.market_price\n        tableItem.selling_price = item.selling_price\n        tableItem.stock_amount = item.stock_amount\n        tableItem.sku_id = item.sku_id\n        tableItem.is_update = 0\n        tableItem.key = parseInt(Math.random() * 999999).toString()\n        if (item.spec_arr) {\n          item.spec_arr.forEach((item, index) => {\n            tableItem[index] = item.spec_item_name\n          })\n        }\n\n        tableData.push(tableItem)\n      })\n      this.tableData = tableData\n    },\n    // 为了同步字数\n    changeName(e) {\n      this.name = e.target.value\n    },\n    delImg(item, index) {\n      if (this.isEditMode && item.image_id) {\n        this.product_images_del.push(item.image_id)\n      }\n      this.imgList.splice(index, 1)\n    },\n    addSku() {\n      this.skuList.push({\n        spec_name: '',\n        spec_item_name: [],\n        isErr: false,\n        isNameErr: false\n      })\n    },\n    addSkuItem(index) {\n      this.$modalRouter.push({\n        name: 'store-add-sku',\n        props: { list: this.skuList[index].spec_item_name },\n        on: {\n          success: result => {\n            this.skuList[index].spec_item_name.push(result)\n            this.changeTable()\n          }\n        }\n      })\n    },\n\n    delSkuItem(index, i) {\n      this.skuList[index].spec_item_name.splice(i, 1)\n      this.changeTable()\n    },\n    delSku(index) {\n      this.skuList.splice(index, 1)\n      if (!this.skuList.length) {\n        this.isMore = 1\n        this.tableData = [\n          {\n            market_price: '',\n            selling_price: '',\n            stock_amount: '',\n            key: parseInt(Math.random() * 999999).toString()\n          }\n        ]\n      }\n    },\n    getImageUrl(imageUrl) {\n      const imgEl = `<img src='${imageUrl.url}' width='400' height='400'>`\n      this.content = this.content + imgEl\n    },\n    onChangeEditor() {\n      this.isEditor = this.content.length === 0\n      return this.content.length === 0\n    },\n    getImage(data) {\n      let img = {\n        image_id: data[0].image_id,\n        image_key: data[0].image_key,\n        image_url: data[0].image_url,\n        is_cover: 0\n      }\n      this.imgList.push(img)\n      if (this.isEditMode) {\n        img.isNew = true\n      }\n      this.isImgError = false\n      this.fileList = []\n    },\n    // 规格发生改变时列表数据相应改变\n    changeTable() {\n      let list = []\n      let skuList = []\n      this.skuList.forEach((item, index) => {\n        if (item.spec_item_name.length !== 0) {\n          skuList.push(item)\n        }\n      })\n      skuList[0].spec_item_name.forEach((item, index) => {\n        let skuItem = { market_price: '', selling_price: '', stock_amount: '' }\n        skuItem['0'] = item\n        if (skuList[1] && skuList[1].spec_item_name.length) {\n          skuList[1].spec_item_name.forEach((ite, inde) => {\n            skuItem['1'] = ite\n            if (skuList[2] && skuList[2].spec_item_name.length) {\n              skuList[2].spec_item_name.forEach((it, ind) => {\n                skuItem['2'] = it\n                list.push(cloneDeep(skuItem))\n              })\n            } else {\n              list.push(cloneDeep(skuItem))\n            }\n          })\n        } else {\n          list.push(cloneDeep(skuItem))\n        }\n      })\n      list.forEach(o => {\n        o.key = parseInt(Math.random() * 999999).toString()\n      })\n      this.tableData = list\n      console.log(this.tableData, 'tableDatatableData')\n    },\n    openClass() {\n      this.$modalRouter.push({\n        name: 'store-class-manage',\n        props: { shopList: 1 },\n        on: {\n          success: res => {\n            this.addService.getList().subscribe(res => {\n              this.classList = res.list\n              let data = this.form.getFieldsValue()\n              if (!this.classList.some(item => item.id === data.category_id)) {\n                this.form.setFieldsValue({ category_id: '' })\n              }\n            })\n          }\n        }\n      })\n    },\n    changeMore() {\n      this.skuList = []\n      this.tableData = [\n        {\n          market_price: '',\n          selling_price: '',\n          stock_amount: '',\n          key: parseInt(Math.random() * 999999).toString()\n        }\n      ]\n    },\n    allApply(attr, value) {\n      this.tableData.map(item => (item[attr] = value))\n    }\n  }\n}\n",{"version":3,"sources":["add.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA6UA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"add.vue","sourceRoot":"src/views/pages/shop/store","sourcesContent":["<template>\n  <st-mina-panel app>\n    <div slot=\"actions\">\n      <st-button\n        type=\"primary\"\n        :loading=\"isEditMode ? loading.editGoods : loading.addGoods\"\n        @click=\"onSubmit\"\n      >\n        保 存\n      </st-button>\n    </div>\n    <div :class=\"basic()\">\n      <st-form :form=\"form\" labelWidth=\"118px\">\n        <a-row :gutter=\"8\">\n          <a-col :span=\"10\">\n            <st-form-item label=\"商品名称\" required>\n              <a-input\n                v-decorator=\"decorators.product_name\"\n                placeholder=\"请输入商品名称\"\n                @change=\"changeName\"\n                maxlength=\"30\"\n              >\n                <span :class=\"basic('name--gray')\" slot=\"suffix\">\n                  {{ name.length }}\n                  /30\n                </span>\n              </a-input>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :span=\"10\">\n            <st-form-item label=\"商品分类\" required>\n              <a-select\n                showSearch\n                v-decorator=\"decorators.category_id\"\n                placeholder=\"请选择分类\"\n              >\n                <a-select-option\n                  :value=\"item.category_id\"\n                  v-for=\"item in classList\"\n                  :key=\"item.category_id\"\n                >\n                  {{ item.category_name }}\n                </a-select-option>\n              </a-select>\n            </st-form-item>\n          </a-col>\n          <a-col :span=\"6\" :class=\"basic('class--manage')\">\n            <a @click=\"openClass\">\n              分类管理\n            </a>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :span=\"16\">\n            <st-form-item label=\"商品图片\" required>\n              <ul :class=\"basic('img--container')\">\n                <li\n                  :class=\"['mg-r12', 'mg-t12', basic('img')]\"\n                  v-for=\"(item, index) in imgList\"\n                  :key=\"index\"\n                >\n                  <img\n                    :data-src=\"item.image_url | imgFilter({ w: 1000 })\"\n                    :src=\"item.image_url | imgFilter({ w: 126, h: 126 })\"\n                    width=\"126\"\n                    height=\"126\"\n                    alt=\"商品图片\"\n                  />\n                  <div :class=\"basic('img--del')\">\n                    <span\n                      :class=\"basic('img--del-text')\"\n                      @click=\"delImg(item, index)\"\n                    >\n                      删除\n                    </span>\n                  </div>\n                </li>\n                <li :class=\"basic('img')\">\n                  <st-image-upload\n                    v-if=\"imgList.length < 5\"\n                    class=\"mg-t12\"\n                    width=\"126px\"\n                    height=\"126px\"\n                    :cropperModal=\"cropperModal\"\n                    :list=\"fileList\"\n                    @change=\"getImage\"\n                    :numLimit=\"5\"\n                    :sizeLimit=\"2\"\n                    placeholder=\"上传图片\"\n                  >\n                    <template v-slot:description>\n                      <p>建议尺寸为750px*750px</p>\n                    </template>\n                  </st-image-upload>\n                  <div :class=\"basic('img--tip')\">可上传5张商品图片</div>\n                </li>\n              </ul>\n              <div class=\"color-danger\" v-if=\"isImgError\">请上传商品图片</div>\n            </st-form-item>\n            <st-form-item label=\"售卖方式\" required>\n              <a-checkbox-group\n                v-decorator=\"decorators.sale_type\"\n                @change=\"changeSale\"\n              >\n                <a-checkbox\n                  :value=\"item.value\"\n                  v-for=\"item in saleType\"\n                  :key=\"item.value\"\n                  style=\"margin-right: 16px;\"\n                >\n                  {{ item.label }}\n                </a-checkbox>\n              </a-checkbox-group>\n            </st-form-item>\n            <st-form-item label=\"配送方式\" required>\n              <a-checkbox-group v-decorator=\"decorators.delivery_type\">\n                <a-checkbox\n                  :value=\"item.value\"\n                  :disabled=\"\n                    (isChoose && item.value === 1) ||\n                      (isDisabledCourier && item.value === 2)\n                  \"\n                  v-for=\"item in shippingMode\"\n                  :key=\"item.value\"\n                  style=\"margin-right: 16px;\"\n                >\n                  {{ item.label }}\n                </a-checkbox>\n              </a-checkbox-group>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :span=\"18\">\n            <st-form-item label=\"商品介绍\">\n              <st-editor\n                @image-change=\"getImageUrl\"\n                @input=\"onChangeEditor\"\n                v-model=\"content\"\n              ></st-editor>\n              <div class=\"color-danger\" v-if=\"isEditor\">请输入活动详情</div>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :span=\"20\">\n            <!-- <a-col :span=\"10\"> -->\n            <st-form-item label=\"规格设置\" required>\n              <a-radio-group\n                v-model=\"isMore\"\n                @change=\"changeMore\"\n                :disabled=\"isEditMode\"\n              >\n                <a-radio :value=\"1\">单规格</a-radio>\n                <a-radio :value=\"2\">多规格</a-radio>\n              </a-radio-group>\n              <st-button\n                type=\"dashed\"\n                :class=\"basic('sku--add')\"\n                v-if=\"isMore === 2 && !isEditMode && skuList.length < 3\"\n                @click=\"addSku\"\n              >\n                <a-icon type=\"plus\" :class=\"basic('sku--add-icon')\" />\n                <span>新增规格项（{{ skuList.length }}/3）</span>\n              </st-button>\n              <div\n                :class=\"skuItem()\"\n                v-for=\"(item, index) in skuList\"\n                :key=\"index\"\n              >\n                <st-form-item\n                  label=\"规格项名称\"\n                  :help=\"item.isNameErr ? '请正确填写规格项' : ''\"\n                  :validateStatus=\"item.isNameErr ? 'error' : ''\"\n                >\n                  <a-input\n                    v-model=\"item.spec_name\"\n                    placeholder=\"请输入规格项名称\"\n                    :disabled=\"isEditMode\"\n                    maxlength=\"20\"\n                    style=\"width: 220px;\"\n                  ></a-input>\n                  <span\n                    :class=\"skuItem('del')\"\n                    @click=\"delSku(index)\"\n                    v-if=\"!isEditMode\"\n                  >\n                    <st-icon\n                      type=\"delete\"\n                      :class=\"skuItem('icon')\"\n                      color=\"#3F66F6\"\n                    ></st-icon>\n                    <span :class=\"skuItem('text')\">\n                      删除\n                    </span>\n                  </span>\n                </st-form-item>\n                <st-form-item\n                  label=\"规格项设置\"\n                  :help=\"item.isErr ? '请正确填写规格' : ''\"\n                  :validateStatus=\"item.isErr ? 'error' : ''\"\n                >\n                  <span\n                    v-for=\"(sku, i) in item.spec_item_name\"\n                    :key=\"i\"\n                    :class=\"basic('sku--tag')\"\n                  >\n                    {{ sku }}\n                    <a-icon\n                      type=\"close\"\n                      @click=\"delSkuItem(index, i)\"\n                      v-if=\"isEditMode ? item.spec_item_name.length > 1 : true\"\n                    />\n                  </span>\n                  <a\n                    :class=\"skuItem('add')\"\n                    @click=\"addSkuItem(index)\"\n                    v-if=\"item.spec_item_name.length <= 10\"\n                  >\n                    新增规格\n                  </a>\n                </st-form-item>\n              </div>\n            </st-form-item>\n            <st-form-item\n              label-fix\n              :help=\"tableTips\"\n              :validateStatus=\"tableErr ? 'error' : ''\"\n            >\n              <st-container>\n                <st-table\n                  rowKey=\"key\"\n                  :columns=\"skuColumns\"\n                  :dataSource=\"tableData\"\n                  :pagination=\"false\"\n                >\n                  <template\n                    slot=\"market_price\"\n                    slot-scope=\"customRender, record\"\n                  >\n                    <div :class=\"basic('apply')\">\n                      <st-input-number\n                        v-model=\"record.market_price\"\n                        :float=\"true\"\n                        style=\"width: 110px;\"\n                        @change=\"record.is_update = 1\"\n                      >\n                        <template slot=\"addonAfter\">\n                          元\n                        </template>\n                      </st-input-number>\n                      <a\n                        style=\"margin-left: 8px;\"\n                        :class=\"basic('apply--all')\"\n                        v-if=\"isMore === 2 && tableData.length > 1\"\n                        @click=\"allApply('market_price', record.market_price)\"\n                      >\n                        批量应用\n                      </a>\n                    </div>\n                  </template>\n                  <template\n                    slot=\"selling_price\"\n                    slot-scope=\"customRender, record\"\n                  >\n                    <div :class=\"basic('apply')\">\n                      <st-input-number\n                        v-model=\"record.selling_price\"\n                        :float=\"true\"\n                        style=\"width: 110px;\"\n                        @change=\"record.is_update = 1\"\n                      >\n                        <template slot=\"addonAfter\">\n                          元\n                        </template>\n                      </st-input-number>\n                      <a\n                        style=\"margin-left: 8px;\"\n                        :class=\"basic('apply--all')\"\n                        v-if=\"isMore === 2 && tableData.length > 1\"\n                        @click=\"allApply('selling_price', record.selling_price)\"\n                      >\n                        批量应用\n                      </a>\n                    </div>\n                  </template>\n                  <template\n                    slot=\"stock_amount\"\n                    slot-scope=\"customRender, record\"\n                  >\n                    <div :class=\"basic('apply')\">\n                      <st-input-number\n                        v-model=\"record.stock_amount\"\n                        style=\"width: 110px;\"\n                        :disabled=\"isEditMode\"\n                      ></st-input-number>\n                      <a\n                        style=\"margin-left: 8px;\"\n                        :class=\"basic('apply--all')\"\n                        v-if=\"isMore === 2 && tableData.length > 1\"\n                        @click=\"allApply('stock_amount', record.stock_amount)\"\n                      >\n                        批量应用\n                      </a>\n                    </div>\n                  </template>\n                </st-table>\n              </st-container>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"8\">\n          <a-col :span=\"10\">\n            <st-form-item label=\"上架状态\" required>\n              <a-radio-group v-model=\"shelves_status\">\n                <a-radio\n                  :value=\"item.value\"\n                  v-for=\"item in shelvesStatus\"\n                  :key=\"item.value\"\n                >\n                  {{ item.label }}\n                </a-radio>\n              </a-radio-group>\n            </st-form-item>\n          </a-col>\n        </a-row>\n      </st-form>\n    </div>\n  </st-mina-panel>\n</template>\n<script>\nimport { ruleOptions, skuColumns } from './add.config'\nimport StImageUpload from '@/views/components/image-upload#/image-upload.vue'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport StoreClassManage from '@/views/biz-modals/store/class-manage.vue'\nimport { PatternService } from '@/services/pattern.service'\nimport { AddService } from './add.service.ts'\nimport StoreAddSku from '@/views/biz-modals/store/add-sku'\nimport { result } from 'lodash-es'\nimport { UserService } from '@/services/user.service'\nimport { cloneDeep } from 'lodash-es'\nexport default {\n  bem: {\n    basic: 'shop-store-add',\n    skuItem: 'sku-item'\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      addService: AddService,\n      userService: UserService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.addService.loading$,\n      saleType: this.userService.getOptions$('cloud_store.sale_type'),\n      shippingMode: this.userService.getOptions$('cloud_store.shipping_mode'),\n      shelvesStatus: this.userService.getOptions$(\n        'cloud_store.edit_shelves_status'\n      )\n    }\n  },\n  modals: { StoreClassManage, StoreAddSku },\n  props: {\n    isEditMode: {\n      type: Boolean,\n      default: false\n    },\n    info: {\n      type: Object,\n      default: () => {}\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      cropperModal: {\n        cropper: {\n          aspectRatio: 1\n        }\n      },\n      name: '', // 商品名称\n      isMore: 1, // 是否是多规格\n      tableData: [\n        {\n          market_price: '',\n          selling_price: '',\n          stock_amount: '',\n          key: parseInt(Math.random() * 999999).toString()\n        }\n      ],\n      skuList: [],\n      content: '',\n      isEditor: false,\n      fileList: [], // 商品图片组件中\n      imgList: [], //上传的图片\n      isImgError: false,\n      shelves_status: 1,\n      product_images_del: [],\n      product_images_add: [],\n      classList: [],\n      tableErr: false,\n      tableTips: '',\n      isChoose: false,\n      isDisabledCourier: false\n    }\n  },\n  components: {\n    StEditor,\n    StImageUpload\n  },\n  computed: {\n    skuColumns,\n    sku() {\n      let list = []\n      this.skuList.forEach((item, index) => {\n        let skuItem = {\n          title: item.spec_name,\n          dataIndex: index\n        }\n        list.push(skuItem)\n      })\n      return list\n    }\n  },\n  mounted() {\n    this.addService.getList().subscribe(res => {\n      this.classList = res.list\n    })\n    if (this.isEditMode) {\n      this.goodDetail()\n    }\n  },\n  methods: {\n    changeSale(event) {\n      let type = this.form.getFieldValue('delivery_type')\n      let deliveryType = []\n      if (event.indexOf(1) !== -1) {\n        this.isChoose = true\n        if (type !== undefined) {\n          deliveryType = type\n        }\n        if (deliveryType.indexOf(1) === -1) {\n          deliveryType.push(1)\n          this.form.setFieldsValue({\n            delivery_type: deliveryType\n          })\n        }\n      } else {\n        this.isChoose = false\n      }\n      if (event.indexOf(1) !== -1 && event.indexOf(2) === -1) {\n        this.isDisabledCourier = true\n      } else {\n        this.isDisabledCourier = false\n      }\n    },\n    // 保存\n    onSubmit() {\n      let isReturn = false\n      let tableError = false\n      if (!this.imgList.length) {\n        this.isReturn = true\n        this.isImgError = true\n      }\n      this.skuList.forEach(item => {\n        item.isErr = false\n        item.isNameErr = false\n        if (!item.spec_item_name.length) {\n          item.isErr = true\n          isReturn = true\n        }\n        if (!item.spec_name) {\n          item.isNameErr = true\n          isReturn = true\n        }\n      })\n      this.tableData.forEach(item => {\n        if (\n          !item.market_price ||\n          !item.selling_price ||\n          (!this.isEditMode && !item.stock_amount)\n        ) {\n          tableError = true\n          this.tableTips = '请正确填写表格'\n          this.tableErr = true\n          isReturn = true\n        }\n      })\n      if (!tableError) {\n        this.tableTips = ''\n        this.tableErr = false\n      }\n      this.form.validate().then(values => {\n        if (isReturn) {\n          return\n        }\n        if (this.isEditMode) {\n          this.editGoodOld(values)\n        } else {\n          this.addGoodNew(values)\n        }\n      })\n    },\n    addGoodNew(values) {\n      let data = {}\n      let product_sku = []\n      let spec_name_arr = []\n      this.tableData.forEach((item, index) => {\n        let skuItem = {}\n        skuItem.market_price = item.market_price\n        skuItem.selling_price = item.selling_price\n        skuItem.stock_amount = item.stock_amount\n        skuItem.spec_arr = []\n        if (this.skuList.length > 0) {\n          skuItem.spec_arr.push({\n            spec_name: this.skuList[0].spec_name,\n            spec_item_name: item['0']\n          })\n        }\n        if (this.skuList.length > 1) {\n          skuItem.spec_arr.push({\n            spec_name: this.skuList[1].spec_name,\n            spec_item_name: item['1']\n          })\n        }\n        if (this.skuList.length > 2) {\n          skuItem.spec_arr.push({\n            spec_name: this.skuList[2].spec_name,\n            spec_item_name: item['2']\n          })\n        }\n        product_sku.push(skuItem)\n      })\n      this.skuList.forEach(item => {\n        spec_name_arr.push(item.spec_name)\n      })\n      data = {\n        product_images: this.imgList, // 商品图片\n        product_intro: this.content, // 商品介绍\n        product_sku: product_sku, // 规格设置\n        shelves_status: this.shelves_status, // 上架状态\n        product_name: values.product_name, // 商品名称\n        category_id: values.category_id, // 分类id\n        delivery_type:\n          values.delivery_type.length === this.shippingMode.length\n            ? -1\n            : values.delivery_type[0], // 配送方式\n        sale_type:\n          values.sale_type.length === this.saleType.length\n            ? -1\n            : values.sale_type[0], // 售卖方式\n        spec_name_arr\n      }\n      this.addService.addGoods(data).subscribe(res => {\n        this.$router.push({\n          path: './list'\n        })\n      })\n    },\n    editGoodOld(values) {\n      let data = {}\n      let product_sku = []\n      this.tableData.forEach((item, index) => {\n        let skuItem = {}\n        skuItem.market_price = item.market_price\n        skuItem.selling_price = item.selling_price\n        skuItem.stock_amount = item.stock_amount\n        if (item.sku_id) {\n          skuItem.is_update = item.is_update\n          skuItem.sku_id = item.sku_id\n        }\n        skuItem.spec_arr = []\n        if (this.skuList.length > 0) {\n          let sku = {}\n          this.info.all_spec[0].spec_item_arr.forEach(spec => {\n            sku.spec_id = this.info.all_spec[0].spec_id\n            if (spec.spec_item_name === item['0']) {\n              sku.spec_item_id = spec.spec_item_id\n            }\n          })\n          sku.spec_name = this.skuList[0].spec_name\n          sku.spec_item_name = item['0']\n          skuItem.spec_arr.push(sku)\n        }\n        if (this.skuList.length > 1) {\n          let sku = {}\n          this.info.all_spec[1].spec_item_arr.forEach(spec => {\n            sku.spec_id = this.info.all_spec[1].spec_id\n            if (spec.spec_item_name === item['1']) {\n              sku.spec_item_id = spec.spec_item_id\n            }\n          })\n          sku.spec_name = this.skuList[1].spec_name\n          sku.spec_item_name = item['1']\n          skuItem.spec_arr.push(sku)\n        }\n        if (this.skuList.length > 2) {\n          let sku = {}\n          this.info.all_spec[2].spec_item_arr.forEach(spec => {\n            sku.spec_id = this.info.all_spec[2].spec_id\n            if (spec.spec_item_name === item['2']) {\n              sku.spec_item_id = spec.spec_item_id\n            }\n          })\n          sku.spec_name = this.skuList[2].spec_name\n          sku.spec_item_name = item['2']\n          skuItem.spec_arr.push(sku)\n        }\n        product_sku.push(skuItem)\n      })\n      data = {\n        product_images_del: this.product_images_del, // 商品图片\n        product_images_add: this.imgList.filter(item => item.isNew), // 商品图片\n        product_intro: this.content, // 商品介绍\n        product_sku: product_sku, // 规格设置\n        shelves_status: this.shelves_status, // 上架状态\n        product_name: values.product_name, // 商品名称\n        category_id: values.category_id, // 分类id\n        delivery_type:\n          values.delivery_type.length === this.shippingMode.length\n            ? -1\n            : values.delivery_type[0], // 配送方式\n        sale_type:\n          values.sale_type.length === this.saleType.length\n            ? -1\n            : values.sale_type[0] // 售卖方式\n      }\n      this.addService.editGoods(this.$route.query.id, data).subscribe(res => {\n        this.$router.push({\n          path: './list'\n        })\n      })\n    },\n    goodDetail() {\n      this.form.setFieldsValue({\n        product_name: this.info.product_name,\n        category_id: this.info.category_id,\n        delivery_type:\n          this.info.delivery_type === -1\n            ? this.shippingMode.map(item => item.value)\n            : [this.info.delivery_type],\n        sale_type:\n          this.info.sale_type === -1\n            ? this.saleType.map(item => item.value)\n            : [this.info.sale_type]\n      })\n      this.name = this.info.product_name\n      this.isMore = this.info.all_spec ? 2 : 1\n      this.imgList = this.info.product_images\n      this.content = this.info.product_intro\n      this.shelves_status = this.info.shelves_status\n      this.skuList = []\n      if (this.info.all_spec) {\n        this.info.all_spec.forEach(item => {\n          let list = []\n          if (item.spec_item_arr) {\n            item.spec_item_arr.forEach(it => {\n              list.push(it.spec_item_name)\n            })\n            this.skuList.push({\n              spec_name: item.spec_name,\n              spec_item_name: list,\n              isErr: false,\n              isNameErr: false\n            })\n          }\n        })\n      }\n      let tableData = []\n      this.info.product_sku.forEach((item, index) => {\n        let tableItem = {}\n        tableItem.market_price = item.market_price\n        tableItem.selling_price = item.selling_price\n        tableItem.stock_amount = item.stock_amount\n        tableItem.sku_id = item.sku_id\n        tableItem.is_update = 0\n        tableItem.key = parseInt(Math.random() * 999999).toString()\n        if (item.spec_arr) {\n          item.spec_arr.forEach((item, index) => {\n            tableItem[index] = item.spec_item_name\n          })\n        }\n\n        tableData.push(tableItem)\n      })\n      this.tableData = tableData\n    },\n    // 为了同步字数\n    changeName(e) {\n      this.name = e.target.value\n    },\n    delImg(item, index) {\n      if (this.isEditMode && item.image_id) {\n        this.product_images_del.push(item.image_id)\n      }\n      this.imgList.splice(index, 1)\n    },\n    addSku() {\n      this.skuList.push({\n        spec_name: '',\n        spec_item_name: [],\n        isErr: false,\n        isNameErr: false\n      })\n    },\n    addSkuItem(index) {\n      this.$modalRouter.push({\n        name: 'store-add-sku',\n        props: { list: this.skuList[index].spec_item_name },\n        on: {\n          success: result => {\n            this.skuList[index].spec_item_name.push(result)\n            this.changeTable()\n          }\n        }\n      })\n    },\n\n    delSkuItem(index, i) {\n      this.skuList[index].spec_item_name.splice(i, 1)\n      this.changeTable()\n    },\n    delSku(index) {\n      this.skuList.splice(index, 1)\n      if (!this.skuList.length) {\n        this.isMore = 1\n        this.tableData = [\n          {\n            market_price: '',\n            selling_price: '',\n            stock_amount: '',\n            key: parseInt(Math.random() * 999999).toString()\n          }\n        ]\n      }\n    },\n    getImageUrl(imageUrl) {\n      const imgEl = `<img src='${imageUrl.url}' width='400' height='400'>`\n      this.content = this.content + imgEl\n    },\n    onChangeEditor() {\n      this.isEditor = this.content.length === 0\n      return this.content.length === 0\n    },\n    getImage(data) {\n      let img = {\n        image_id: data[0].image_id,\n        image_key: data[0].image_key,\n        image_url: data[0].image_url,\n        is_cover: 0\n      }\n      this.imgList.push(img)\n      if (this.isEditMode) {\n        img.isNew = true\n      }\n      this.isImgError = false\n      this.fileList = []\n    },\n    // 规格发生改变时列表数据相应改变\n    changeTable() {\n      let list = []\n      let skuList = []\n      this.skuList.forEach((item, index) => {\n        if (item.spec_item_name.length !== 0) {\n          skuList.push(item)\n        }\n      })\n      skuList[0].spec_item_name.forEach((item, index) => {\n        let skuItem = { market_price: '', selling_price: '', stock_amount: '' }\n        skuItem['0'] = item\n        if (skuList[1] && skuList[1].spec_item_name.length) {\n          skuList[1].spec_item_name.forEach((ite, inde) => {\n            skuItem['1'] = ite\n            if (skuList[2] && skuList[2].spec_item_name.length) {\n              skuList[2].spec_item_name.forEach((it, ind) => {\n                skuItem['2'] = it\n                list.push(cloneDeep(skuItem))\n              })\n            } else {\n              list.push(cloneDeep(skuItem))\n            }\n          })\n        } else {\n          list.push(cloneDeep(skuItem))\n        }\n      })\n      list.forEach(o => {\n        o.key = parseInt(Math.random() * 999999).toString()\n      })\n      this.tableData = list\n      console.log(this.tableData, 'tableDatatableData')\n    },\n    openClass() {\n      this.$modalRouter.push({\n        name: 'store-class-manage',\n        props: { shopList: 1 },\n        on: {\n          success: res => {\n            this.addService.getList().subscribe(res => {\n              this.classList = res.list\n              let data = this.form.getFieldsValue()\n              if (!this.classList.some(item => item.id === data.category_id)) {\n                this.form.setFieldsValue({ category_id: '' })\n              }\n            })\n          }\n        }\n      })\n    },\n    changeMore() {\n      this.skuList = []\n      this.tableData = [\n        {\n          market_price: '',\n          selling_price: '',\n          stock_amount: '',\n          key: parseInt(Math.random() * 999999).toString()\n        }\n      ]\n    },\n    allApply(attr, value) {\n      this.tableData.map(item => (item[attr] = value))\n    }\n  }\n}\n</script>\n"]}]}