{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue","mtime":1600926555911},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport StImageUpload from '@/views/components/image-upload#/image-upload.vue';\nimport { ruleOptions } from \"./time-table.config\";\nimport TimeTable from \"./time-table/table\";\nimport { TeamTimeTableService } from \"./time-table.service\";\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service';\nimport { MessageService } from '@/services/message.service';\nimport { cloneDeep, omit, pick } from 'lodash-es';\nimport { ShsService } from '@/services/shs.service';\nexport default {\n  bem: {\n    b: 'schedule-team-time-table'\n  },\n  components: {\n    StImageUpload: StImageUpload,\n    TimeTable: TimeTable\n  },\n  serviceInject: function serviceInject() {\n    return {\n      teamScheduleCommomService: TeamScheduleCommonService,\n      timeTableService: TeamTimeTableService,\n      messageService: MessageService,\n      shsService: ShsService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.timeTableService.loading$,\n      courtList: this.teamScheduleCommomService.courtOptions$\n    };\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      form: form,\n      decorators: decorators,\n      show: false,\n      bgFileList: [],\n      codeFileList: [],\n      title: '',\n      // 课表标题\n      bgUrl: '',\n      // 背景图\n      codeUrl: '',\n      // 二维码图片\n      rangeTime: '',\n      // 时间范围\n      tableData: {},\n      bgErrorText: '',\n      codeErrorText: '',\n      startDate: '',\n      endDate: '',\n      downLoadLoading: false,\n      saveLoading: false\n    };\n  },\n  created: function created() {},\n  mounted: function mounted() {\n    var weekOfday = moment().format('E'); // 今天是本周第几天\n\n    this.startDate = moment().subtract(weekOfday - 1, 'days').format('YYYY-MM-DD'); // 周一日期\n\n    this.endDate = moment(this.startDate).add(6, 'days').format('YYYY-MM-DD');\n    this.getTimeTableTemplate();\n  },\n  computed: {\n    ruleOptions: ruleOptions\n  },\n  watch: {\n    startDate: function startDate() {\n      var startTime = moment(this.startDate).format('YYYY/MM/DD').slice(5, this.startDate.length);\n      var endDate = moment(this.startDate).add(6, 'days').format('YYYY/MM/DD');\n      var endTime = endDate.slice(5, endDate.length);\n      this.rangeTime = \"\".concat(startTime, \"-\").concat(endTime);\n    }\n  },\n  methods: {\n    getTimeTableTemplate: function getTimeTableTemplate() {\n      var _this = this;\n\n      this.timeTableService.getTimeTableTemplate().subscribe(function (res) {\n        _this.tableData = res.info;\n        _this.title = _this.tableData.title;\n\n        _this.form.setFieldsValue({\n          title: _this.tableData.title,\n          selected_court: _this.tableData.selected_court\n        });\n\n        if (_this.tableData.is_bgimage) {\n          // 背景自定义\n          _this.bgFileList = [_this.tableData.customize_bgimage];\n          _this.bgUrl = _this.tableData.customize_bgimage.image_url;\n          _this.tableData.bg_image = _this.tableData.customize_bgimage.image_key;\n        } else {\n          _this.bgUrl = _this.tableData.def_bgimage.image_url;\n          _this.tableData.bg_image = '';\n        }\n\n        if (_this.tableData.is_qrcode) {\n          // 二维码自定义\n          _this.codeFileList = _this.tableData.customize_qrcode.image_key ? [_this.tableData.customize_qrcode] : [];\n          _this.codeUrl = _this.tableData.customize_qrcode.image_url;\n          _this.tableData.qrcode = _this.tableData.customize_qrcode.image_key;\n        } else {\n          _this.codeUrl = _this.tableData.def_qrcode.image_url;\n          _this.tableData.qrcode = '';\n        }\n      });\n    },\n    // 选择时间段\n    onChangeDate: function onChangeDate(date) {\n      this.startDate = date.start_date;\n      this.endDate = date.end_date;\n    },\n    changeTitle: function changeTitle(e) {\n      this.title = e.target.value;\n    },\n    changeBgType: function changeBgType() {\n      if (!this.tableData.is_bgimage) {\n        this.bgUrl = this.tableData.def_bgimage.image_url;\n        this.tableData.bg_image = '';\n      } else {\n        this.bgUrl = this.bgFileList.length ? this.bgFileList[0].image_url : this.bgUrl;\n        this.tableData.bg_image = this.bgFileList.length ? this.bgFileList[0].image_key : '';\n        this.bgImgValidate();\n      }\n    },\n    changeCodeType: function changeCodeType() {\n      if (!this.tableData.is_qrcode) {\n        this.codeUrl = this.tableData.def_qrcode.image_url;\n        this.tableData.qrcode = '';\n      } else {\n        this.codeUrl = this.codeFileList.length ? this.codeFileList[0].image_url : '';\n        this.tableData.qrcode = this.codeFileList.length ? this.codeFileList[0].image_key : '';\n        this.codeImgValidate();\n      }\n    },\n    bgFileChange: function bgFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.bg_image = fileData[0].image_key;\n        this.bgUrl = fileData[0].image_url;\n        this.bgFileList = fileData;\n      } else {\n        this.tableData.bg_image = '';\n      }\n\n      this.bgImgValidate();\n    },\n    codeFileChange: function codeFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.qrcode = fileData[0].image_key;\n        this.codeUrl = fileData[0].image_url;\n        this.codeFileList = fileData;\n      } else {\n        this.tableData.qrcode = '';\n      }\n\n      this.codeImgValidate();\n    },\n    saveTimeTable: function saveTimeTable() {\n      this.editTimeTable();\n    },\n    downloadTimeTable: function downloadTimeTable() {\n      this.editTimeTable(true);\n    },\n    editTimeTable: function editTimeTable() {\n      var _this2 = this;\n\n      var isDownload = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n      this.bgImgValidate();\n      this.codeImgValidate();\n      this.form.validate().then(function (value) {\n        if (!_this2.bgErrorText && !_this2.codeErrorText) {\n          var tableData = omit(_this2.tableData, ['brand_log', 'shop_name', 'customize_bgimage', 'customize_qrcode', 'def_bgimage', 'def_qrcode']);\n\n          var saveData = _objectSpread({}, tableData, {\n            title: value.title,\n            selected_court: value.selected_court\n          });\n\n          console.log(saveData);\n\n          if (isDownload) {\n            _this2.downLoadLoading = true;\n          } else {\n            _this2.saveLoading = true;\n          }\n\n          _this2.timeTableService.saveTimeTableTemplate(saveData).subscribe(function (res) {\n            if (!isDownload) {\n              _this2.saveLoading = false;\n\n              _this2.messageService.success({\n                content: '保存成功'\n              });\n            } else {\n              _this2.timeTableService.getTimeTableList({\n                start_date: _this2.startDate,\n                end_date: _this2.endDate\n              }).subscribe(function (res) {\n                if (!res.list.length) {\n                  _this2.downLoadLoading = false;\n\n                  _this2.messageService.error({\n                    content: '当前时间段未排课'\n                  });\n                } else {\n                  var pickData = pick(_this2.tableData, ['is_bgimage', 'brand_log', 'prompt_message', 'is_show_nickname', 'is_show_strength_level']);\n\n                  var shsData = _objectSpread({}, pickData, {\n                    bgUrl: _this2.bgUrl,\n                    qrcode_url: _this2.codeUrl,\n                    shop_name: _this2.tableData.is_show_shop ? _this2.tableData.shop_name : '',\n                    rangeTime: _this2.rangeTime,\n                    title: _this2.title,\n                    timeTableList: JSON.stringify(res.list),\n                    isSaveFile: 1\n                  });\n\n                  _this2.shsService.getShsImage(shsData, '/saas/time_table').subscribe(function (url) {\n                    _this2.downLoadLoading = false;\n\n                    _this2.messageService.success({\n                      content: '保存并下载成功'\n                    });\n\n                    console.log(url);\n\n                    _this2.downloadFile(url, \"\".concat(_this2.title, \".png\"));\n                  });\n                }\n              });\n            }\n          });\n        }\n      });\n    },\n    downloadFile: function downloadFile(url) {\n      var _this3 = this;\n\n      var filename = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n      fetch(url, {\n        headers: new Headers({\n          Origin: location.origin\n        }),\n        mode: 'cors'\n      }).then(function (res) {\n        return res.blob();\n      }).then(function (blob) {\n        var blobUrl = window.URL.createObjectURL(blob);\n\n        _this3.download(blobUrl, filename);\n\n        window.URL.revokeObjectURL(blobUrl);\n      });\n    },\n    download: function download(blobUrl, filename) {\n      var a = document.createElement('a');\n      a.href = blobUrl;\n      a.target = '_blank';\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      a.remove();\n    },\n    bgImgValidate: function bgImgValidate() {\n      if (this.tableData.is_bgimage) {\n        this.bgErrorText = !this.tableData.bg_image ? '请上传背景图' : '';\n      } else {\n        this.bgErrorText = '';\n      }\n    },\n    codeImgValidate: function codeImgValidate() {\n      if (this.tableData.is_qrcode) {\n        this.codeErrorText = !this.tableData.qrcode ? '请上传二维码图片' : '';\n      } else {\n        this.codeErrorText = '';\n      }\n    }\n  }\n};",{"version":3,"sources":["time-table.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <st-modal\n    v-model=\"show\"\n    title=\"生成课表\"\n    :class=\"b()\"\n    width=\"864px\"\n    :footer=\"null\"\n  >\n    <div :class=\"b('content')\">\n      <div :class=\"b('left')\">\n        <st-form :form=\"form\">\n          <st-form-item label=\"课表时间\">\n            <st-switch-week\n              :limitWeeks=\"25\"\n              @pre=\"onChangeDate\"\n              @next=\"onChangeDate\"\n            ></st-switch-week>\n          </st-form-item>\n          <st-form-item label=\"课表标题\" required>\n            <a-input\n              placeholder=\"请输入课表名称，不超过10个字\"\n              required\n              :maxLength=\"10\"\n              v-decorator=\"decorators.title\"\n              @change=\"changeTitle\"\n            ></a-input>\n          </st-form-item>\n          <st-form-item required>\n            <template slot=\"label\">\n              选择场地\n              <st-help-tooltip id=\"TSKB001\"></st-help-tooltip>\n            </template>\n            <a-select\n              mode=\"multiple\"\n              placeholder=\"请选择场地\"\n              v-decorator=\"decorators.selected_court\"\n            >\n              <a-select-option\n                v-for=\"court in courtList\"\n                :key=\"court.id\"\n                :value=\"court.id\"\n              >\n                {{ court.name }}\n              </a-select-option>\n              <a-select-option :value=\"0\">未关联场地</a-select-option>\n            </a-select>\n          </st-form-item>\n          <st-form-item label=\"内容展示\">\n            <a-row :gutter=\"24\">\n              <a-col :lg=\"12\">\n                门店名称\n                <st-switch\n                  v-model=\"tableData.is_show_shop\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n              <a-col :lg=\"12\">\n                教练昵称\n                <st-switch\n                  v-model=\"tableData.is_show_nickname\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n            </a-row>\n            <a-row :gutter=\"24\">\n              <a-col :lg=\"12\">\n                场地名称\n                <st-switch\n                  v-model=\"tableData.is_show_court\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n              <a-col :lg=\"12\">\n                难度等级\n                <st-switch\n                  v-model=\"tableData.is_show_strength_level\"\n                  class=\"mg-l8\"\n                ></st-switch>\n              </a-col>\n            </a-row>\n          </st-form-item>\n          <st-form-item label=\"背景图\">\n            <a-radio-group\n              v-model=\"tableData.is_bgimage\"\n              @change=\"changeBgType\"\n            >\n              <a-radio :value=\"0\">默认样式</a-radio>\n              <a-radio :value=\"1\">自定义</a-radio>\n            </a-radio-group>\n          </st-form-item>\n          <st-form-item\n            class=\"image-upload\"\n            label=\"\"\n            required\n            v-if=\"tableData.is_bgimage\"\n            validateStatus=\"error\"\n            :help=\"bgErrorText\"\n          >\n            <st-image-upload\n              :sizeLimit=\"5\"\n              :list=\"bgFileList\"\n              @change=\"bgFileChange\"\n              width=\"240px\"\n              height=\"135px\"\n              placeholder=\"上传图片\"\n              description=\"建议尺寸 16:9，大小不超过5M\"\n              :cropperModal=\"{\n                title: '门店图片裁切',\n                cropper: { aspectRatio: 16 / 9 }\n              }\"\n            ></st-image-upload>\n          </st-form-item>\n          <st-form-item label=\"二维码\">\n            <a-radio-group\n              v-model=\"tableData.is_qrcode\"\n              @change=\"changeCodeType\"\n            >\n              <a-radio\n                :value=\"0\"\n                v-if=\"tableData.def_qrcode && tableData.def_qrcode.image_url\"\n              >\n                小程序二维码\n              </a-radio>\n              <a-radio :value=\"1\">自定义</a-radio>\n            </a-radio-group>\n          </st-form-item>\n          <st-form-item\n            class=\"flex-style image-upload\"\n            label=\"\"\n            required\n            v-if=\"tableData.is_qrcode\"\n            validateStatus=\"error\"\n            :help=\"codeErrorText\"\n          >\n            <a-row :gutter=\"24\">\n              <a-col :lg=\"11\">\n                <st-image-upload\n                  :sizeLimit=\"2\"\n                  :list=\"codeFileList\"\n                  @change=\"codeFileChange\"\n                  width=\"114px\"\n                  height=\"114px\"\n                  placeholder=\"上传图片\"\n                  :cropperModal=\"{\n                    title: '图片裁切',\n                    cropper: { aspectRatio: 1 / 1 }\n                  }\"\n                ></st-image-upload>\n              </a-col>\n              <a-col :lg=\"13\" class=\"image-tips mg-t24\">\n                <div class=\"mg-b8\">建议尺寸 1:1</div>\n                <div class=\"st-des\">支持jpg、png、bmp格式，大小不超过2M</div>\n              </a-col>\n            </a-row>\n          </st-form-item>\n          <st-form-item label=\"温馨提示\">\n            <st-textarea\n              :autosize=\"{ minRows: 4, maxRows: 8 }\"\n              v-model=\"tableData.prompt_message\"\n              maxlength=\"100\"\n            ></st-textarea>\n          </st-form-item>\n        </st-form>\n      </div>\n      <div :class=\"b('right')\">\n        <time-table\n          :title=\"title\"\n          :bgUrl=\"bgUrl\"\n          :codeUrl=\"codeUrl\"\n          :rangeTime=\"rangeTime\"\n          :tableData=\"tableData\"\n        ></time-table>\n        <div :class=\"b('footer')\" class=\"mg-t8\">\n          <st-button\n            class=\"mg-r16\"\n            @click=\"saveTimeTable\"\n            :loading=\"saveLoading\"\n          >\n            保存设置\n          </st-button>\n          <st-button\n            type=\"primary\"\n            @click=\"downloadTimeTable\"\n            :loading=\"loading.getTimeTableList || downLoadLoading\"\n          >\n            下载课表\n          </st-button>\n        </div>\n      </div>\n    </div>\n  </st-modal>\n</template>\n<script>\nimport StImageUpload from '@/views/components/image-upload#/image-upload.vue'\nimport { ruleOptions } from './time-table.config'\nimport TimeTable from './time-table/table'\nimport { TeamTimeTableService } from './time-table.service'\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service'\nimport { MessageService } from '@/services/message.service'\nimport { cloneDeep, omit, pick } from 'lodash-es'\nimport { ShsService } from '@/services/shs.service'\nexport default {\n  bem: {\n    b: 'schedule-team-time-table'\n  },\n  components: {\n    StImageUpload,\n    TimeTable\n  },\n  serviceInject() {\n    return {\n      teamScheduleCommomService: TeamScheduleCommonService,\n      timeTableService: TeamTimeTableService,\n      messageService: MessageService,\n      shsService: ShsService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.timeTableService.loading$,\n      courtList: this.teamScheduleCommomService.courtOptions$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      bgFileList: [],\n      codeFileList: [],\n      title: '', // 课表标题\n      bgUrl: '', // 背景图\n      codeUrl: '', // 二维码图片\n      rangeTime: '', // 时间范围\n      tableData: {},\n      bgErrorText: '',\n      codeErrorText: '',\n      startDate: '',\n      endDate: '',\n      downLoadLoading: false,\n      saveLoading: false\n    }\n  },\n  created() {},\n  mounted() {\n    let weekOfday = moment().format('E') // 今天是本周第几天\n    this.startDate = moment()\n      .subtract(weekOfday - 1, 'days')\n      .format('YYYY-MM-DD') // 周一日期\n    this.endDate = moment(this.startDate)\n      .add(6, 'days')\n      .format('YYYY-MM-DD')\n    this.getTimeTableTemplate()\n  },\n  computed: {\n    ruleOptions\n  },\n  watch: {\n    startDate() {\n      let startTime = moment(this.startDate)\n        .format('YYYY/MM/DD')\n        .slice(5, this.startDate.length)\n      let endDate = moment(this.startDate)\n        .add(6, 'days')\n        .format('YYYY/MM/DD')\n      let endTime = endDate.slice(5, endDate.length)\n      this.rangeTime = `${startTime}-${endTime}`\n    }\n  },\n  methods: {\n    getTimeTableTemplate() {\n      this.timeTableService.getTimeTableTemplate().subscribe(res => {\n        this.tableData = res.info\n        this.title = this.tableData.title\n        this.form.setFieldsValue({\n          title: this.tableData.title,\n          selected_court: this.tableData.selected_court\n        })\n        if (this.tableData.is_bgimage) {\n          // 背景自定义\n          this.bgFileList = [this.tableData.customize_bgimage]\n          this.bgUrl = this.tableData.customize_bgimage.image_url\n          this.tableData.bg_image = this.tableData.customize_bgimage.image_key\n        } else {\n          this.bgUrl = this.tableData.def_bgimage.image_url\n          this.tableData.bg_image = ''\n        }\n        if (this.tableData.is_qrcode) {\n          // 二维码自定义\n          this.codeFileList = this.tableData.customize_qrcode.image_key\n            ? [this.tableData.customize_qrcode]\n            : []\n          this.codeUrl = this.tableData.customize_qrcode.image_url\n          this.tableData.qrcode = this.tableData.customize_qrcode.image_key\n        } else {\n          this.codeUrl = this.tableData.def_qrcode.image_url\n          this.tableData.qrcode = ''\n        }\n      })\n    },\n    // 选择时间段\n    onChangeDate(date) {\n      this.startDate = date.start_date\n      this.endDate = date.end_date\n    },\n    changeTitle(e) {\n      this.title = e.target.value\n    },\n    changeBgType() {\n      if (!this.tableData.is_bgimage) {\n        this.bgUrl = this.tableData.def_bgimage.image_url\n        this.tableData.bg_image = ''\n      } else {\n        this.bgUrl = this.bgFileList.length\n          ? this.bgFileList[0].image_url\n          : this.bgUrl\n        this.tableData.bg_image = this.bgFileList.length\n          ? this.bgFileList[0].image_key\n          : ''\n        this.bgImgValidate()\n      }\n    },\n    changeCodeType() {\n      if (!this.tableData.is_qrcode) {\n        this.codeUrl = this.tableData.def_qrcode.image_url\n        this.tableData.qrcode = ''\n      } else {\n        this.codeUrl = this.codeFileList.length\n          ? this.codeFileList[0].image_url\n          : ''\n        this.tableData.qrcode = this.codeFileList.length\n          ? this.codeFileList[0].image_key\n          : ''\n        this.codeImgValidate()\n      }\n    },\n    bgFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.bg_image = fileData[0].image_key\n        this.bgUrl = fileData[0].image_url\n        this.bgFileList = fileData\n      } else {\n        this.tableData.bg_image = ''\n      }\n      this.bgImgValidate()\n    },\n    codeFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.qrcode = fileData[0].image_key\n        this.codeUrl = fileData[0].image_url\n        this.codeFileList = fileData\n      } else {\n        this.tableData.qrcode = ''\n      }\n      this.codeImgValidate()\n    },\n    saveTimeTable() {\n      this.editTimeTable()\n    },\n    downloadTimeTable() {\n      this.editTimeTable(true)\n    },\n    editTimeTable(isDownload = false) {\n      this.bgImgValidate()\n      this.codeImgValidate()\n      this.form.validate().then(value => {\n        if (!this.bgErrorText && !this.codeErrorText) {\n          let tableData = omit(this.tableData, [\n            'brand_log',\n            'shop_name',\n            'customize_bgimage',\n            'customize_qrcode',\n            'def_bgimage',\n            'def_qrcode'\n          ])\n          let saveData = {\n            ...tableData,\n            title: value.title,\n            selected_court: value.selected_court\n          }\n          console.log(saveData)\n\n          if (isDownload) {\n            this.downLoadLoading = true\n          } else {\n            this.saveLoading = true\n          }\n          this.timeTableService\n            .saveTimeTableTemplate(saveData)\n            .subscribe(res => {\n              if (!isDownload) {\n                this.saveLoading = false\n                this.messageService.success({ content: '保存成功' })\n              } else {\n                this.timeTableService\n                  .getTimeTableList({\n                    start_date: this.startDate,\n                    end_date: this.endDate\n                  })\n                  .subscribe(res => {\n                    if (!res.list.length) {\n                      this.downLoadLoading = false\n                      this.messageService.error({ content: '当前时间段未排课' })\n                    } else {\n                      let pickData = pick(this.tableData, [\n                        'is_bgimage',\n                        'brand_log',\n                        'prompt_message',\n                        'is_show_nickname',\n                        'is_show_strength_level'\n                      ])\n                      let shsData = {\n                        ...pickData,\n                        bgUrl: this.bgUrl,\n                        qrcode_url: this.codeUrl,\n                        shop_name: this.tableData.is_show_shop\n                          ? this.tableData.shop_name\n                          : '',\n                        rangeTime: this.rangeTime,\n                        title: this.title,\n                        timeTableList: JSON.stringify(res.list),\n                        isSaveFile: 1\n                      }\n\n                      this.shsService\n                        .getShsImage(shsData, '/saas/time_table')\n                        .subscribe(url => {\n                          this.downLoadLoading = false\n                          this.messageService.success({\n                            content: '保存并下载成功'\n                          })\n                          console.log(url)\n                          this.downloadFile(url, `${this.title}.png`)\n                        })\n                    }\n                  })\n              }\n            })\n        }\n      })\n    },\n    downloadFile(url, filename = '') {\n      fetch(url, {\n        headers: new Headers({\n          Origin: location.origin\n        }),\n        mode: 'cors'\n      })\n        .then(res => res.blob())\n        .then(blob => {\n          const blobUrl = window.URL.createObjectURL(blob)\n          this.download(blobUrl, filename)\n          window.URL.revokeObjectURL(blobUrl)\n        })\n    },\n    download(blobUrl, filename) {\n      const a = document.createElement('a')\n      a.href = blobUrl\n      a.target = '_blank'\n      a.download = filename\n      document.body.appendChild(a)\n      a.click()\n      a.remove()\n    },\n    bgImgValidate() {\n      if (this.tableData.is_bgimage) {\n        this.bgErrorText = !this.tableData.bg_image ? '请上传背景图' : ''\n      } else {\n        this.bgErrorText = ''\n      }\n    },\n    codeImgValidate() {\n      if (this.tableData.is_qrcode) {\n        this.codeErrorText = !this.tableData.qrcode ? '请上传二维码图片' : ''\n      } else {\n        this.codeErrorText = ''\n      }\n    }\n  }\n}\n</script>\n"],"sourceRoot":"src/views/biz-modals/schedule/team"}]}