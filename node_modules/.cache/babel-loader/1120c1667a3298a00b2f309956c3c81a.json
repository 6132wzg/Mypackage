{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/shop/map.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/shop/map.vue","mtime":1594718339933},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.search\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.function.name\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { RegionService } from \"../../../services/region.service\";\nimport { QqMapService } from '@/services/qq-map.service';\nimport { AppConfig } from '@/constants/config';\nimport { findIndex, cloneDeep } from 'lodash-es';\nexport default {\n  bem: {\n    map: 'st-modal-map'\n  },\n  name: 'StModalMap',\n  serviceInject: function serviceInject() {\n    return {\n      regionService: RegionService,\n      appConfig: AppConfig,\n      qqMapService: QqMapService\n    };\n  },\n  computed: {\n    isAdd: function isAdd() {\n      return this.lat === '' || this.lng === '';\n    }\n  },\n  props: {\n    title: {\n      type: String,\n      default: function _default() {\n        return '门店定位';\n      }\n    },\n    address: {\n      type: String,\n      default: function _default() {\n        return '无';\n      }\n    },\n    province: {\n      type: Object,\n      default: function _default() {\n        return {};\n      }\n    },\n    city: {\n      type: Object,\n      default: function _default() {\n        return {};\n      }\n    },\n    district: {\n      type: Object,\n      default: function _default() {\n        return {};\n      }\n    },\n    lat: {\n      type: String,\n      default: function _default() {\n        return '';\n      }\n    },\n    lng: {\n      type: String,\n      default: function _default() {\n        return '';\n      }\n    }\n  },\n  data: function data() {\n    return {\n      show: false,\n      dropdownVisible: false,\n      errorText: '',\n      latlngIsOk: true,\n      addressIsOk: true,\n      fieldNames: {\n        label: 'name',\n        value: 'id',\n        children: 'children'\n      },\n      regions: [],\n      searchText: '',\n      selectCity: '上海市',\n      PC: [310000, 310100],\n      st_address: '',\n      st_province: {},\n      st_city: {},\n      st_district: {},\n      // 定位data\n      locationData: {},\n      // 注释以下三个对象，提升vue性能\n      // mapObject: null,\n      // markerObject: null,\n      // searchServiceObject: null,\n      locationObject: null,\n      // 检索列表\n      poisList: [],\n      selectData: {\n        province: {},\n        city: {},\n        district: {},\n        address: '',\n        lat: '',\n        lng: ''\n      }\n    };\n  },\n  mounted: function mounted() {\n    this.init();\n  },\n  watch: {\n    st_address: function st_address(newVal, oldVal) {\n      this.selectData.address = newVal;\n      this.addressIsOk = true;\n      this.errorText = this.latlngIsOk ? '' : '请选择具体地址!';\n    }\n  },\n  methods: {\n    init: function init() {\n      var _this = this;\n\n      // 获取省市区\n      this.getRegions();\n      this.st_address = this.address;\n      this.st_province = cloneDeep(this.province);\n      this.st_city = cloneDeep(this.city);\n      this.st_district = cloneDeep(this.district);\n\n      if (this.isAdd) {\n        this.qqMapService.getLocation(\"https://apis.map.qq.com/ws/location/v1/ip?output=jsonp&key=\".concat(this.appConfig.QQ_MAP_KEY, \"&callback=\")).subscribe(function (res) {\n          if (res.status === 0) {\n            var code = res.result.ad_info.adcode;\n            var provinceId = \"\".concat(code).substr(0, 2) + '0000';\n            var cityId = \"\".concat(code).substr(0, 4) + '00'; // 定位成功\n\n            _this.selectData.province = {\n              // id: ~~(res.result.ad_info.adcode / 10000) * 10000,\n              id: +provinceId,\n              name: res.result.ad_info.province\n            };\n            _this.selectData.city = {\n              // id: ~~(res.result.ad_info.adcode / 100) * 100,\n              id: +cityId,\n              name: res.result.ad_info.city\n            };\n            _this.PC = [+provinceId, +cityId, res.result.ad_info.adcode];\n            _this.selectCity = res.result.ad_info.city;\n            _this.locationData = cloneDeep(res.result);\n          } else {\n            // 定位失败,设置为上海市政府\n            _this.locationFailed();\n\n            _this.locationData = {\n              location: {\n                lat: '31.230350',\n                lng: '121.473720'\n              }\n            };\n          } // 实例化map\n\n\n          var _this$locationData$lo = _this.locationData.location,\n              lat = _this$locationData$lo.lat,\n              lng = _this$locationData$lo.lng;\n\n          _this.qqMapService.init({\n            lat: lat,\n            lng: lng\n          }).then(function () {\n            _this.initSearch({\n              location: _this.selectCity\n            });\n          });\n        });\n      } else {\n        this.selectData.province = cloneDeep(this.st_province);\n        this.selectData.city = cloneDeep(this.st_city);\n        this.PC = [this.st_province.id, this.st_city.id];\n        this.selectCity = this.st_city.name;\n        this.locationData = {\n          location: {\n            lat: this.lat,\n            lng: this.lng\n          }\n        }; // 实例化map\n\n        var _this$locationData$lo2 = this.locationData.location,\n            lat = _this$locationData$lo2.lat,\n            lng = _this$locationData$lo2.lng;\n        this.qqMapService.init({\n          lat: lat,\n          lng: lng\n        }).then(function () {\n          _this.initSearch({\n            location: _this.selectCity\n          });\n        });\n      }\n    },\n    getRegions: function getRegions() {\n      var _this2 = this;\n\n      this.regionService.getRegionPC().subscribe(function (res) {\n        _this2.regions = res;\n      });\n    },\n    // 定位失败\n    locationFailed: function locationFailed() {\n      this.selectData.province = {\n        id: 310000,\n        name: '上海市'\n      };\n      this.selectData.city = {\n        id: 310100,\n        name: '上海市'\n      };\n      this.selectCity = '上海市';\n    },\n    // 省市change\n    cascaderChange: function cascaderChange(data) {\n      var province = cloneDeep(this.regions[findIndex(this.regions, function (o) {\n        return o.id === data[0];\n      })]);\n      var city = cloneDeep(province.children[findIndex(province.children, function (o) {\n        return o.id === data[1];\n      })]);\n      this.selectData.province = {\n        id: data[0],\n        name: province.name\n      };\n      this.selectData.city = {\n        id: data[1],\n        name: city.name\n      };\n      this.selectCity = city.name;\n      this.searchText = '';\n      this.poisList = [];\n      this.selectData.address = this.st_address = '';\n      this.selectData.lat = '';\n      this.selectData.lng = '';\n    },\n    // 实例化检索服务\n    initSearch: function initSearch(_ref) {\n      var location = _ref.location;\n      var that = this;\n      this.searchServiceObject = new qq.maps.SearchService({\n        location: '上海市',\n        autoExtend: false,\n        // eslint-disable-next-line\n        error: function error(_error) {\n          that.poisList = [];\n        },\n        complete: function complete(results) {\n          if (results.type === 'POI_LIST') {\n            if (results.detail.pois.length) {\n              results.detail.pois.forEach(function (i, index) {\n                var latLng = new qq.maps.LatLng(i.latLng.lat, i.latLng.lng);\n                that.initLocation(index).searchCityByLatLng(latLng);\n              });\n            }\n\n            that.poisList = cloneDeep(results.detail.pois);\n          } else {\n            that.poisList = [];\n          }\n        }\n      });\n    },\n    // 实例化坐标定位服务\n    initLocation: function initLocation(index) {\n      var that = this;\n      return new qq.maps.CityService({\n        complete: function complete(results) {\n          that.$set(that.poisList[index], 'location', results);\n        }\n      });\n    },\n    onSearch: function onSearch(data) {\n      this.dropdownVisible = true;\n      this.searchServiceObject.setLocation(this.selectCity);\n      this.searchServiceObject.search(data);\n    },\n    onChange: function onChange(data) {\n      this.dropdownVisible = true;\n      this.searchServiceObject.setLocation(this.selectCity);\n      this.searchServiceObject.search(data.target.value);\n    },\n    selectLocation: function selectLocation(data) {\n      this.dropdownVisible = false;\n      this.searchText = data.name;\n      this.selectData.address = this.st_address = data.address;\n      var position = new qq.maps.LatLng(data.latLng.lat, data.latLng.lng);\n      this.qqMapService.resetMap(position);\n      this.selectData.lat = String(data.latLng.lat);\n      this.selectData.lng = String(data.latLng.lng);\n    },\n    searchInput: function searchInput() {\n      this.latlngIsOk = true;\n      this.errorText = this.addressIsOk ? '' : '请输入详细地址！';\n    },\n    handleOk: function handleOk() {\n      var _this3 = this;\n\n      this.latlngIsOk = this.selectData.lat !== '' && this.selectData.lng !== '';\n      this.addressIsOk = this.selectData.address !== '';\n\n      if (!this.latlngIsOk && !this.addressIsOk) {\n        this.errorText = '请选择具体地址并输入详细地址!';\n      } else {\n        if (!this.latlngIsOk) {\n          this.errorText = '请选择具体地址!';\n        } else if (!this.addressIsOk) {\n          this.errorText = '请输入详细地址!';\n        } else {\n          this.qqMapService.getLocation(\"https://apis.map.qq.com/ws/geocoder/v1/?location=\".concat(this.selectData.lat, \",\").concat(this.selectData.lng, \"&output=jsonp&key=\").concat(this.appConfig.QQ_MAP_KEY, \"&callback=\")).subscribe(function (res) {\n            var code = res.result.ad_info.adcode;\n            var provinceId = \"\".concat(code).substr(0, 2) + '0000';\n            var cityId = \"\".concat(code).substr(0, 4) + '00'; // 定位成功\n\n            _this3.selectData.province.id = +provinceId;\n            _this3.selectData.province.name = res.result.ad_info.province;\n            _this3.selectData.city.id = +cityId;\n            _this3.selectData.city.name = res.result.ad_info.city;\n            _this3.selectData.district.id = +res.result.ad_info.adcode;\n            _this3.selectData.district.name = res.result.ad_info.district;\n            _this3.selectData.district.id = +res.result.ad_info.adcode;\n            _this3.selectData.district.name = res.result.ad_info.district;\n\n            _this3.$emit('ok', _this3.selectData);\n\n            _this3.show = false;\n          });\n        }\n      }\n    }\n  }\n};",null]}