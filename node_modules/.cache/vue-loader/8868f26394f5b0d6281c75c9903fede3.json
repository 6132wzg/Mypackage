{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/shop/finance/split.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/shop/finance/split.vue","mtime":1591147717217},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport moment from 'moment'\nimport { SplitService } from './split.service'\nimport { cloneDeep } from 'lodash-es'\nimport { columns } from './split.config'\nimport { SPLIT } from '@/constants/finance/split'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalShopFinanceOrderSplit',\n  bem: {\n    basic: 'modal-shop-finance-split'\n  },\n  serviceInject() {\n    return {\n      splitService: SplitService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      info: this.splitService.info$,\n      loading: this.splitService.loading$,\n      saleList: this.splitService.saleList$\n    }\n  },\n  props: ['id'],\n  data() {\n    return {\n      SPLIT,\n      form: this.$form.createForm(this),\n      show: false,\n      description: '',\n      rate: 0,\n      saleMan: ''\n    }\n  },\n  computed: {\n    columns\n  },\n  created() {\n    this.splitService.serviceInit(this.id).subscribe(result => {\n      this.description = this.info.description || ''\n      const item = {\n        edit: this.SPLIT.EDIT_TYPE_3, // 1 主销售编辑 2 协助销售编辑 3协助销售新增\n        staff_id: undefined,\n        staff_name: '',\n        staff_type: this.SPLIT.STAFF_TYPE_2,\n        staff_type_name: '协助销售',\n        split_ratio: '',\n        split_money: ''\n      }\n      return this.info.split_items.unshift(item)\n    })\n  },\n  methods: {\n    changeSaleMan(saler, index) {\n      this.info.split_items[index].staff_id = saler.staff_id\n      this.info.split_items[index].staff_name = saler.staff_name\n    },\n    validSaleMan(record) {\n      if (!this.info.split_items || this.info.split_items.length >= 7) {\n        return false\n      }\n      let percent = 0\n      for (let i = 1; i < this.info.split_items.length; i++) {\n        percent += parseInt(this.info.split_items[i].split_ratio || 0, 10)\n        if (this.info.split_items[i].staff_id === record.staff_id) {\n          this.messageService.error({\n            content: '销售人员不能重复'\n          })\n          return false\n        }\n      }\n      percent += parseInt(record.split_ratio, 10)\n      if (percent > 100) {\n        this.messageService.error({\n          content: '拆分比例总和不能超过100%'\n        })\n        return false\n      }\n      return true\n    },\n    addSaleMan(record) {\n      if (!record.staff_id || !record.split_ratio) {\n        return\n      }\n      if (!this.validSaleMan(record)) {\n        return\n      }\n      delete record.edit\n      let split_money = (+record.split_ratio / 100) * +this.info.actual_price\n      split_money = Math.floor(split_money * 10) / 10\n      record.split_money = split_money\n      this.info.split_items.splice(0, 1, record)\n      const newRecord = {\n        edit: this.SPLIT.EDIT_TYPE_3,\n        staff_id: undefined,\n        staff_name: '',\n        staff_type: this.SPLIT.STAFF_TYPE_2,\n        staff_type_name: '协助销售',\n        split_ratio: '',\n        split_money: ''\n      }\n      this.info.split_items.unshift(newRecord)\n    },\n    onSave(record, index) {\n      let percent = 0\n      const arr = cloneDeep(this.info.split_items)\n      arr.shift()\n      arr.map(item => {\n        percent += parseInt(item.split_ratio || 0, 10)\n      })\n      // percent += parseInt(record.split_ratio, 10)\n      if (percent > 100) {\n        this.messageService.error({\n          content: '拆分比例总和不能超过100%'\n        })\n        return\n      }\n      delete record.edit\n      let split_money = (+record.split_ratio / 100) * +this.info.actual_price\n      split_money = Math.floor(split_money * 10) / 10\n      record.split_money = split_money\n      this.info.split_items.splice(index, 1, record)\n      this.info.split_items[0].staff_id = undefined\n      this.info.split_items[0].split_ratio = ''\n    },\n    onEidt(record, index) {\n      record.meta = cloneDeep(record)\n      record.edit = record.staff_type\n      this.info.split_items.splice(index, 1, record)\n    },\n    onCanel(record, index) {\n      record = record.meta\n      this.info.split_items.splice(index, 1, record)\n    },\n    onDelete(index) {\n      this.info.split_items.splice(index, 1)\n    },\n    moment,\n    onSubmit() {\n      const list = this.info.split_items.map(item => {\n        const params = {}\n        if (item.staff_id !== -1) {\n          params.staff_id = item.staff_id\n          params.staff_rate = item.split_ratio\n        }\n        return params\n      })\n      list.shift()\n      const params = {\n        order_id: this.id,\n        description: this.description,\n        split_data: list\n      }\n      this.splitService.split(params).subscribe(result => {\n        this.show = false\n        this.$emit('success')\n      })\n    }\n  }\n}\n",{"version":3,"sources":["split.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA2HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"split.vue","sourceRoot":"src/views/biz-modals/shop/finance","sourcesContent":["<template>\n  <st-modal\n    title=\"业绩拆分\"\n    width=\"800px\"\n    v-model=\"show\"\n    :loading=\"loading.serviceInit\"\n    wrapClassName=\"modal-shop-finance-split\"\n  >\n    <div :class=\"basic('content')\">\n      <a-row :class=\"basic('info')\">\n        <a-col :span=\"12\" class=\"mg-b36\">\n          <st-info>\n            <st-info-item label=\"订单号\">{{ info.order_id }}</st-info-item>\n            <st-info-item label=\"下单人\">{{ info.operator_name }}</st-info-item>\n            <st-info-item label=\"销售\">{{ info.staff_name }}</st-info-item>\n          </st-info>\n        </a-col>\n        <a-col :span=\"12\" class=\"mg-b36\">\n          <st-info>\n            <st-info-item label=\"下单时间\">\n              {{ info.created_time }}\n            </st-info-item>\n            <st-info-item label=\"订单总额\">\n              {{ info.total_price }}元\n            </st-info-item>\n            <st-info-item label=\"实收金额\">\n              {{ info.actual_price }}元\n            </st-info-item>\n          </st-info>\n        </a-col>\n      </a-row>\n      <st-table\n        rowKey=\"staff_id\"\n        :pagination=\"false\"\n        :columns=\"columns\"\n        :dataSource=\"info.split_items\"\n      >\n        <template slot=\"staff_name\" slot-scope=\"text, record, index\">\n          <a-select\n            v-if=\"record.edit && record.staff_type !== SPLIT.STAFF_TYPE_1\"\n            v-model=\"record.staff_id\"\n            style=\"width: 150px\"\n            placeholder=\"选择销售人员\"\n          >\n            <a-select-option\n              v-for=\"(saler, salerIndex) in saleList\"\n              @click=\"changeSaleMan(saler, index)\"\n              :key=\"salerIndex\"\n              :value=\"+saler.id\"\n            >\n              {{ saler.staff_name }}\n            </a-select-option>\n          </a-select>\n          <template v-else>\n            {{ text }}\n          </template>\n        </template>\n        <template slot=\"split_ratio\" slot-scope=\"text, record\">\n          <st-input-number\n            v-if=\"record.edit\"\n            :min=\"0\"\n            :max=\"100\"\n            v-model=\"record.split_ratio\"\n            :float=\"false\"\n            placeholder=\"请输入占比\"\n            style=\"width:150px\"\n          >\n            <span slot=\"addonAfter\">%</span>\n          </st-input-number>\n          <template v-else>\n            {{ text }}\n          </template>\n        </template>\n        <div slot=\"action\" slot-scope=\"text, record, index\">\n          <st-table-actions>\n            <a\n              v-if=\"record.edit === SPLIT.EDIT_TYPE_3\"\n              @click=\"addSaleMan(record)\"\n            >\n              协助售卖人\n            </a>\n            <a\n              v-if=\"record.edit && record.edit !== SPLIT.EDIT_TYPE_3\"\n              @click=\"onSave(record, index)\"\n            >\n              确定\n            </a>\n            <a v-if=\"!record.edit\" @click=\"onEidt(record, index)\">编辑</a>\n            <a\n              v-if=\"\n                record.edit === SPLIT.EDIT_TYPE_1 ||\n                  record.edit === SPLIT.EDIT_TYPE_2\n              \"\n              @click=\"onCanel(record, index)\"\n            >\n              取消\n            </a>\n            <a\n              v-if=\"!record.edit && record.staff_type !== SPLIT.STAFF_TYPE_1\"\n              @click=\"onDelete(index)\"\n            >\n              删除\n            </a>\n          </st-table-actions>\n        </div>\n      </st-table>\n      <div :class=\"basic('descrip')\">\n        <label>备注</label>\n        <a-textarea\n          v-model=\"description\"\n          :autosize=\"{ minRows: 4, maxRows: 6 }\"\n        />\n      </div>\n    </div>\n    <template slot=\"footer\">\n      <st-button @click=\"onSubmit\" :loading=\"loading.split\" type=\"primary\">\n        确认拆分\n      </st-button>\n    </template>\n  </st-modal>\n</template>\n\n<script>\nimport moment from 'moment'\nimport { SplitService } from './split.service'\nimport { cloneDeep } from 'lodash-es'\nimport { columns } from './split.config'\nimport { SPLIT } from '@/constants/finance/split'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalShopFinanceOrderSplit',\n  bem: {\n    basic: 'modal-shop-finance-split'\n  },\n  serviceInject() {\n    return {\n      splitService: SplitService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      info: this.splitService.info$,\n      loading: this.splitService.loading$,\n      saleList: this.splitService.saleList$\n    }\n  },\n  props: ['id'],\n  data() {\n    return {\n      SPLIT,\n      form: this.$form.createForm(this),\n      show: false,\n      description: '',\n      rate: 0,\n      saleMan: ''\n    }\n  },\n  computed: {\n    columns\n  },\n  created() {\n    this.splitService.serviceInit(this.id).subscribe(result => {\n      this.description = this.info.description || ''\n      const item = {\n        edit: this.SPLIT.EDIT_TYPE_3, // 1 主销售编辑 2 协助销售编辑 3协助销售新增\n        staff_id: undefined,\n        staff_name: '',\n        staff_type: this.SPLIT.STAFF_TYPE_2,\n        staff_type_name: '协助销售',\n        split_ratio: '',\n        split_money: ''\n      }\n      return this.info.split_items.unshift(item)\n    })\n  },\n  methods: {\n    changeSaleMan(saler, index) {\n      this.info.split_items[index].staff_id = saler.staff_id\n      this.info.split_items[index].staff_name = saler.staff_name\n    },\n    validSaleMan(record) {\n      if (!this.info.split_items || this.info.split_items.length >= 7) {\n        return false\n      }\n      let percent = 0\n      for (let i = 1; i < this.info.split_items.length; i++) {\n        percent += parseInt(this.info.split_items[i].split_ratio || 0, 10)\n        if (this.info.split_items[i].staff_id === record.staff_id) {\n          this.messageService.error({\n            content: '销售人员不能重复'\n          })\n          return false\n        }\n      }\n      percent += parseInt(record.split_ratio, 10)\n      if (percent > 100) {\n        this.messageService.error({\n          content: '拆分比例总和不能超过100%'\n        })\n        return false\n      }\n      return true\n    },\n    addSaleMan(record) {\n      if (!record.staff_id || !record.split_ratio) {\n        return\n      }\n      if (!this.validSaleMan(record)) {\n        return\n      }\n      delete record.edit\n      let split_money = (+record.split_ratio / 100) * +this.info.actual_price\n      split_money = Math.floor(split_money * 10) / 10\n      record.split_money = split_money\n      this.info.split_items.splice(0, 1, record)\n      const newRecord = {\n        edit: this.SPLIT.EDIT_TYPE_3,\n        staff_id: undefined,\n        staff_name: '',\n        staff_type: this.SPLIT.STAFF_TYPE_2,\n        staff_type_name: '协助销售',\n        split_ratio: '',\n        split_money: ''\n      }\n      this.info.split_items.unshift(newRecord)\n    },\n    onSave(record, index) {\n      let percent = 0\n      const arr = cloneDeep(this.info.split_items)\n      arr.shift()\n      arr.map(item => {\n        percent += parseInt(item.split_ratio || 0, 10)\n      })\n      // percent += parseInt(record.split_ratio, 10)\n      if (percent > 100) {\n        this.messageService.error({\n          content: '拆分比例总和不能超过100%'\n        })\n        return\n      }\n      delete record.edit\n      let split_money = (+record.split_ratio / 100) * +this.info.actual_price\n      split_money = Math.floor(split_money * 10) / 10\n      record.split_money = split_money\n      this.info.split_items.splice(index, 1, record)\n      this.info.split_items[0].staff_id = undefined\n      this.info.split_items[0].split_ratio = ''\n    },\n    onEidt(record, index) {\n      record.meta = cloneDeep(record)\n      record.edit = record.staff_type\n      this.info.split_items.splice(index, 1, record)\n    },\n    onCanel(record, index) {\n      record = record.meta\n      this.info.split_items.splice(index, 1, record)\n    },\n    onDelete(index) {\n      this.info.split_items.splice(index, 1)\n    },\n    moment,\n    onSubmit() {\n      const list = this.info.split_items.map(item => {\n        const params = {}\n        if (item.staff_id !== -1) {\n          params.staff_id = item.staff_id\n          params.staff_rate = item.split_ratio\n        }\n        return params\n      })\n      list.shift()\n      const params = {\n        order_id: this.id,\n        description: this.description,\n        split_data: list\n      }\n      this.splitService.split(params).subscribe(result => {\n        this.show = false\n        this.$emit('success')\n      })\n    }\n  }\n}\n</script>\n"]}]}