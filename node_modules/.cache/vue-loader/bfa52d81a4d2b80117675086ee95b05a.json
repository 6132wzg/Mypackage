{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-small-course.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-small-course.vue","mtime":1600926555978},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { SaleSmallCourseService } from './sale-small-course.service'\nimport moment from 'moment'\nimport { cloneDeep, get } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { PatternService } from '@/services/pattern.service'\nimport { ruleOptions } from './sale-small-course.config'\nimport { UserService } from '@/services/user.service'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nimport MemberSearch from '@/views/biz-components/member/member-search/member-search'\nimport SelectScroll from '@/views/components/select-scroll#/select-scroll'\n\nimport { COURSE_TYPE } from '@/constants/course/small-course'\nexport default {\n  name: 'ModalSoldDealSaleMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber,\n    MemberSearch,\n    SelectScroll\n  },\n  serviceProviders() {\n    return [SaleSmallCourseService]\n  },\n  serviceInject() {\n    return {\n      saleSmallCourseService: SaleSmallCourseService,\n      userService: UserService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      page: this.saleSmallCourseService.page$,\n      loading: this.saleSmallCourseService.loading$,\n      finished: this.saleSmallCourseService.finished$,\n      info: this.saleSmallCourseService.info$,\n      courseList: this.saleSmallCourseService.courseList$,\n      saleList: this.saleSmallCourseService.saleList$,\n      couponList: this.saleSmallCourseService.couponList$,\n      personalPrice: this.saleSmallCourseService.personalPrice$,\n      priceInfo: this.saleSmallCourseService.priceInfo$,\n      orderAmountPrice: this.saleSmallCourseService.orderAmountPrice$\n    }\n  },\n  props: {\n    id: {\n      type: String\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      COURSE_TYPE,\n      form,\n      decorators,\n      show: false,\n      // 到期有效时间\n      validEndTime: 0,\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      // 优惠券\n      selectCoupon: '',\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      couponDropdownVisible: false,\n      product_id: '',\n      isFollowSalesman: 0,\n      product_name: ''\n    }\n  },\n  computed: {\n    modelTitle() {\n      return this.$c('small_course') + '签单'\n    },\n    canChoseCoupon() {\n      let len = this.couponList.length\n      return (this.id || this.product_id) && len\n    },\n    canChoseAdvance() {\n      let len = this.advanceList.length\n      return (this.id || this.product_id) && len\n    },\n    onViewCourseHref() {\n      const course_id = this.form.getFieldValue('productId') || undefined\n      return `/shop/product/course/schedule/small-course?app_brand_id=${this.$searchQuery.app_brand_id}&app_shop_id=${this.$searchQuery.app_shop_id}&course_id=${course_id}`\n    },\n    courseBeginTime() {\n      return (\n        moment(this.info.course_begin_time * 1000).format('YYYY-MM-DD HH:MM') +\n        '~' +\n        moment(this.info.course_end_time * 1000).format('YYYY-MM-DD HH:MM')\n      )\n    },\n    orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : ''\n    },\n    amountMax() {\n      // if (this.info.course_type === this.COURSE_TYPE.FIXED_COURSE) {\n      //   return this.info.buy_num || 0\n      // }\n      return this.info.buy_num || 1\n    },\n    amountMin() {\n      // if (this.info.course_type === this.COURSE_TYPE.FIXED_COURSE) {\n      //   return this.info.buy_num || 0\n      // }\n      return 1\n    },\n    isDisabledBuyNum() {\n      return this.info.course_type === this.COURSE_TYPE.FIXED_COURSE\n    },\n    saleRangeType() {\n      return get(this.info.sale_range, 'type', 1)\n    },\n    hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}'\n    }\n  },\n  watch: {\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(newVal, this.selectAdvance, +this.reduceAmount)\n      }\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(this.selectCoupon, newVal, +this.reduceAmount)\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectCoupon, this.selectAdvance, +newVal)\n    }\n  },\n  mounted() {\n    this.saleSmallCourseService.serviceInit().subscribe(result => {\n      if (this.id) {\n        this.handleGetCourseInfo(this.id)\n      } else {\n        this.saleSmallCourseService\n          .getSmallCourseList({\n            app_brand_id: this.$searchQuery.app_brand_id,\n            app_shop_id: this.$searchQuery.app_shop_id,\n            product_type: 7\n          })\n          .subscribe()\n      }\n    })\n  },\n  methods: {\n    moment,\n    // 选择课,筛选\n    handleSelect(val) {\n      this.product_id = val\n      this.onResetDiscounts()\n      this.handleGetCourseInfo(val)\n    },\n    // 选择课,搜索\n    handleSearch(product_name) {\n      this.product_name = product_name\n      this.saleSmallCourseService\n        .getSmallCourseList({\n          product_name,\n          current_page: 1,\n          app_brand_id: this.$searchQuery.app_brand_id,\n          app_shop_id: this.$searchQuery.app_shop_id,\n          product_type: 7\n        })\n        .subscribe()\n    },\n    onResetDiscounts() {\n      console.log('onResetDiscounts')\n      // 重置优惠券及定金选择\n      this.resetCoupon()\n      this.resetAdvance()\n    },\n    // 重新获取优惠券及定金\n    onReGetDiscounts(data) {\n      console.log('onReGetDiscounts')\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      this.fetchAdvanceList(data)\n      this.fetchCouponList(data)\n    },\n    // 重新获取定金及优惠券\n    onMemberChange(data) {\n      // 重置优惠券及定金选择\n      this.onResetDiscounts()\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      if (data) this.onReGetDiscounts(data)\n    },\n    // 选择定金\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    // 选择优惠券\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    // 重置定金选择\n    resetAdvance() {\n      this.advanceList = []\n      this.advanceText = '未选择定金'\n      this.selectAdvance = ''\n      this.advanceAmount = ''\n    },\n    // 重置优惠券选择\n    resetCoupon() {\n      this.saleSmallCourseService.REST_COUPONLIST()\n      this.couponText = '未选择优惠券'\n      this.selectCoupon = ''\n      this.couponAmount = ''\n    },\n    // 关闭签单弹窗\n    onCancel() {\n      this.resetAdvance()\n      this.resetCoupon()\n    },\n    // 选择定金\n    onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0\n        this.advanceText = `未选择定金`\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    // 选择优惠券\n    onSelectCouponChange(event) {\n      let id = get(event.target.value, 'id', '')\n      if (id) {\n        let price = this.couponList.filter(o => o.id === id)[0].price\n        this.couponAmount = price\n        this.couponText = `${price}元`\n      } else {\n        this.couponText = '未选择优惠券'\n        this.couponAmount = 0\n      }\n    },\n    // 计算实付金额\n    getPrice(coupon, advance, reduce) {\n      let advanceId = advance === -1 ? '' : advance\n      const product_id = this.form.getFieldValue('productId') || undefined\n      this.saleSmallCourseService.priceAction$.dispatch({\n        product_id,\n        product_type: this.info.contract_type,\n        product_num: this.form.getFieldValue('course_num'),\n        coupon_id: coupon ? coupon.id : undefined,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        member_id: this.form.getFieldValue('member_id')\n      })\n    },\n    // 获取订单总额\n    getOrderPrice() {\n      const product_id = this.form.getFieldValue('productId') || undefined\n      this.saleSmallCourseService.orderAmountPriceAction$.dispatch({\n        product_id,\n        product_type: this.info.contract_type,\n        product_num: 0\n      })\n    },\n    // 创建订单\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        const small_course_id =\n          this.form.getFieldValue('productId') || undefined\n        this.saleSmallCourseService\n          .setTransactionOrder({\n            member_id: values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            country_prefix: values.mobile ? values.mobile.code_id : undefined,\n            small_course_id,\n            course_num: values.course_num,\n            contract_number: this.info.contract_number,\n            coupon_id: this.selectCoupon.id,\n            advance_id: this.selectAdvance,\n            reduce_amount: this.reduceAmount || 0,\n            sale_id: values.saleName,\n            description: this.description,\n            sale_range: this.info.sale_range.type,\n            order_amount: this.priceInfo,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'create',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    // 订单支付\n    onPay() {\n      this.form.validate().then(values => {\n        const small_course_id =\n          this.form.getFieldValue('productId') || undefined\n        this.saleSmallCourseService\n          .setTransactionPay({\n            member_id: values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            country_prefix: values.mobile ? values.mobile.code_id : undefined,\n            small_course_id,\n            course_num: values.course_num,\n            contract_number: this.info.contract_number,\n            coupon_id: this.selectCoupon.id,\n            advance_id: this.selectAdvance,\n            reduce_amount: this.reduceAmount || 0,\n            sale_id: values.saleName,\n            description: this.description,\n            sale_range: this.info.sale_range.type,\n            order_amount: this.priceInfo,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    // 获取优惠券列表\n    fetchCouponList(id) {\n      const member_id = this.form.getFieldValue('member_id') || id\n      const price = this.personalPrice.sell_price\n      const buy_num = this.form.getFieldValue('course_num')\n      const course_id = this.form.getFieldValue('productId') || undefined\n      if (course_id && member_id) {\n        const params = {\n          member_id,\n          course_id,\n          price,\n          buy_num\n        }\n        this.saleSmallCourseService.getCouponList(params).subscribe()\n      }\n    },\n    // 获取定金列表\n    fetchAdvanceList(id) {\n      let member_id = this.form.getFieldValue('member_id') || id\n      if (member_id) {\n        this.saleSmallCourseService.getAdvanceList(member_id).subscribe(res => {\n          this.advanceList = cloneDeep(res.list)\n        })\n      }\n    },\n    // 获取课程列表\n    handleGetList() {\n      console.log('finished 1', this.finished)\n      console.log('page', this.page)\n      if (this.finished) return false\n      this.saleSmallCourseService\n        .getSmallCourseList({\n          product_name: this.product_name,\n          current_page: ++this.page.current_page,\n          app_brand_id: this.$searchQuery.app_brand_id,\n          app_shop_id: this.$searchQuery.app_shop_id,\n          product_type: 7\n        })\n        .subscribe()\n    },\n    // 获取课程详情\n    handleGetCourseInfo(productId) {\n      this.saleSmallCourseService.getInfo(productId).subscribe(res => {\n        if (this.id) {\n          this.saleSmallCourseService.SET_LIST([\n            {\n              id: +this.id,\n              product_name: this.info.course_name\n            }\n          ])\n        }\n        setTimeout(() => {\n          // 设置\n          this.form.setFieldsValue({\n            productId: +productId,\n            course_num: this.info.buy_num\n          })\n          this.onReGetDiscounts()\n          this.getPrice()\n          this.getOrderPrice()\n        })\n      })\n    }\n  }\n}\n",{"version":3,"sources":["sale-small-course.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"sale-small-course.vue","sourceRoot":"src/views/biz-modals/sold/deal","sourcesContent":["<template>\n  <st-modal\n    title=\"小班课签单\"\n    v-model=\"show\"\n    @cancel=\"onCancel\"\n    wrapClassName=\"modal-sold-deal-sale\"\n  >\n    <div :class=\"sale('content')\">\n      <st-form :form=\"form\" labelWidth=\"88px\">\n        <member-search\n          :class=\"sale('member')\"\n          :form=\"form\"\n          :memberInfo=\"memberInfo\"\n          :saleRangeType=\"saleRangeType\"\n          isSoldDeal\n          @select=\"onMemberChange\"\n          @change=\"onMemberChange\"\n        ></member-search>\n        <div :class=\"sale('sale')\">\n          <st-form-item label=\"选择课\" required>\n            <select-scroll\n              v-decorator=\"decorators.productId\"\n              placeholder=\"请选择课\"\n              notFoundContent=\"无搜索结果\"\n              :list=\"courseList\"\n              :loading=\"loading.getSmallCourseList\"\n              :disabled=\"!!id\"\n              @load=\"handleGetList\"\n              @select=\"handleSelect\"\n              @search=\"handleSearch\"\n            ></select-scroll>\n            <a-row\n              :class=\"sale('info')\"\n              v-if=\"hasProductInfo\"\n              type=\"flex\"\n              justify=\"space-between\"\n            >\n              <a-col :span=\"12\">\n                <st-info>\n                  <st-info-item label=\"允许转让\">\n                    {{ info.is_transfer }}\n                  </st-info-item>\n                  <st-info-item label=\"转让手续费\">\n                    {{ info.transfer_fee }}\n                  </st-info-item>\n                  <st-info-item label=\"开班条件\">\n                    {{ info.num_min }}~{{ info.num_max }}人\n                  </st-info-item>\n                  <st-info-item label=\"开班时间\">\n                    {{ courseBeginTime }}\n                  </st-info-item>\n                  <st-info-item label=\"上课方式\">\n                    {{ info.course_type_name }}\n                  </st-info-item>\n                </st-info>\n              </a-col>\n              <a-col :span=\"11\">\n                <st-info>\n                  <st-info-item label=\"售卖群体\" v-if=\"info.sale_range\">\n                    {{ info.sale_range.name }}\n                  </st-info-item>\n                  <st-info-item label=\"总课时\">\n                    {{ info.course_times }}节\n                  </st-info-item>\n                  <st-info-item label=\"排课状态\" v-if=\"info.has_schedule\">\n                    {{ info.has_schedule.name }}\n                    <a\n                      v-if=\"info.has_schedule.status\"\n                      :href=\"onViewCourseHref\"\n                      target=\"_blank\"\n                    >\n                      查看排期\n                    </a>\n                  </st-info-item>\n                  <st-info-item label=\"报名人数\">\n                    {{ info.buy_member_counts }}人\n                  </st-info-item>\n                </st-info>\n              </a-col>\n            </a-row>\n          </st-form-item>\n          <st-form-item required label=\"购买课时\">\n            <st-input-number\n              placeholder=\"请输入购买课时\"\n              v-decorator=\"decorators.course_num\"\n              :disabled=\"isDisabledBuyNum\"\n              :max=\"amountMax\"\n              :min=\"amountMin\"\n            >\n              <span slot=\"addonAfter\">节</span>\n            </st-input-number>\n          </st-form-item>\n          <editable-contract-number\n            v-model=\"info.contract_number\"\n            :form=\"form\"\n          />\n          <st-form-item class=\"mg-b12\" label=\"商品价格\">\n            {{ orderAmountPrice }}元\n          </st-form-item>\n          <st-form-item :class=\"sale('discounts')\" label=\"优惠券\">\n            <div>\n              <div :class=\"sale('discounts-total')\">\n                <span>{{ couponText }}</span>\n                <a-dropdown\n                  v-model=\"couponDropdownVisible\"\n                  :disabled=\"!canChoseAdvance\"\n                  :class=\"sale({ disabled: !canChoseAdvance })\"\n                  placement=\"bottomRight\"\n                  :getPopupContainer=\"trigger => trigger.parentNode\"\n                  :trigger=\"['click']\"\n                >\n                  <div :class=\"sale('discounts-promotion')\">\n                    <span>{{ couponList.length }}张可用优惠券</span>\n                    <a-icon type=\"right\" />\n                  </div>\n                  <a-radio-group\n                    v-model=\"selectCoupon\"\n                    @change=\"onSelectCouponChange\"\n                    :class=\"sale('dropdown')\"\n                    slot=\"overlay\"\n                  >\n                    <a-menu>\n                      <a-menu-item @click=\"onSelectCoupon\">\n                        <a-radio :value=\"undefined\">不使用</a-radio>\n                      </a-menu-item>\n                      <a-menu-item\n                        @click=\"onSelectCoupon\"\n                        :key=\"index\"\n                        v-for=\"(item, index) in couponList\"\n                      >\n                        <a-radio :value=\"item\">\n                          {{ item.name }}{{ item.price }}\n                        </a-radio>\n                      </a-menu-item>\n                    </a-menu>\n                  </a-radio-group>\n                </a-dropdown>\n              </div>\n            </div>\n          </st-form-item>\n          <st-form-item :class=\"sale('discounts')\" label=\"定金抵扣\">\n            <div>\n              <div :class=\"sale('discounts-total')\">\n                <span>{{ advanceText }}</span>\n                <a-dropdown\n                  v-model=\"advanceDropdownVisible\"\n                  :disabled=\"!canChoseAdvance\"\n                  :class=\"\n                    sale({\n                      disabled: !canChoseAdvance\n                    })\n                  \"\n                  placement=\"bottomRight\"\n                  :getPopupContainer=\"trigger => trigger.parentNode\"\n                  :trigger=\"['click']\"\n                >\n                  <div :class=\"sale('discounts-promotion')\">\n                    <span>定金选择</span>\n                    <a-icon type=\"right\" />\n                  </div>\n                  <a-radio-group\n                    v-model=\"selectAdvance\"\n                    @change=\"onSelectAdvanceChange\"\n                    :class=\"sale('dropdown')\"\n                    slot=\"overlay\"\n                  >\n                    <a-menu>\n                      <a-menu-item @click=\"onSelectAdvance\">\n                        <a-radio :value=\"undefined\">不使用</a-radio>\n                      </a-menu-item>\n                      <a-menu-item\n                        @click=\"onSelectAdvance\"\n                        :key=\"index\"\n                        v-for=\"(item, index) in advanceList\"\n                      >\n                        <a-radio :value=\"item.id\">\n                          定金 {{ item.price }}\n                        </a-radio>\n                      </a-menu-item>\n                    </a-menu>\n                  </a-radio-group>\n                </a-dropdown>\n              </div>\n            </div>\n          </st-form-item>\n          <st-form-item label=\"减免金额\">\n            <st-input-number\n              v-model=\"reduceAmount\"\n              :float=\"true\"\n              placeholder=\"请输入减免金额\"\n            >\n              <span slot=\"addonAfter\">元</span>\n            </st-input-number>\n          </st-form-item>\n          <st-form-item\n            validateStatus=\"error\"\n            :help=\"orderAmountText\"\n            class=\"mg-b0\"\n            label=\"小计\"\n          >\n            <span class=\"total\">{{ priceInfo }}元</span>\n          </st-form-item>\n        </div>\n        <div :class=\"sale('remarks')\">\n          <st-form-item label=\"销售人员\" required>\n            <a-select\n              v-decorator=\"decorators.saleName\"\n              placeholder=\"选择签单的工作人员\"\n            >\n              <a-select-option\n                v-for=\"(item, index) in saleList\"\n                :key=\"index\"\n                :value=\"item.id\"\n              >\n                {{ item.staff_name }}\n              </a-select-option>\n            </a-select>\n            <div>\n              <st-checkbox v-model=\"isFollowSalesman\">\n                作为用户跟进销售\n              </st-checkbox>\n            </div>\n          </st-form-item>\n          <st-form-item label=\"备注\" class=\"mg-b0\">\n            <st-textarea\n              v-model=\"description\"\n              :autosize=\"{ minRows: 4, maxRows: 6 }\"\n              :maxlength=\"200\"\n            />\n          </st-form-item>\n        </div>\n      </st-form>\n    </div>\n    <template slot=\"footer\">\n      <div :class=\"sale('footer')\">\n        <div class=\"price\">\n          <span>{{ priceInfo }}元</span>\n          <span>订单总额：{{ orderAmountPrice }}元</span>\n        </div>\n        <div class=\"button\">\n          <st-button\n            @click=\"onCreateOrder\"\n            :loading=\"loading.setTransactionOrder\"\n          >\n            创建订单\n          </st-button>\n          <st-button\n            @click=\"onPay\"\n            :loading=\"loading.setTransactionPay\"\n            type=\"primary\"\n          >\n            立即支付\n          </st-button>\n        </div>\n      </div>\n    </template>\n  </st-modal>\n</template>\n\n<script>\nimport { SaleSmallCourseService } from './sale-small-course.service'\nimport moment from 'moment'\nimport { cloneDeep, get } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { PatternService } from '@/services/pattern.service'\nimport { ruleOptions } from './sale-small-course.config'\nimport { UserService } from '@/services/user.service'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nimport MemberSearch from '@/views/biz-components/member/member-search/member-search'\nimport SelectScroll from '@/views/components/select-scroll#/select-scroll'\n\nimport { COURSE_TYPE } from '@/constants/course/small-course'\nexport default {\n  name: 'ModalSoldDealSaleMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber,\n    MemberSearch,\n    SelectScroll\n  },\n  serviceProviders() {\n    return [SaleSmallCourseService]\n  },\n  serviceInject() {\n    return {\n      saleSmallCourseService: SaleSmallCourseService,\n      userService: UserService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      page: this.saleSmallCourseService.page$,\n      loading: this.saleSmallCourseService.loading$,\n      finished: this.saleSmallCourseService.finished$,\n      info: this.saleSmallCourseService.info$,\n      courseList: this.saleSmallCourseService.courseList$,\n      saleList: this.saleSmallCourseService.saleList$,\n      couponList: this.saleSmallCourseService.couponList$,\n      personalPrice: this.saleSmallCourseService.personalPrice$,\n      priceInfo: this.saleSmallCourseService.priceInfo$,\n      orderAmountPrice: this.saleSmallCourseService.orderAmountPrice$\n    }\n  },\n  props: {\n    id: {\n      type: String\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      COURSE_TYPE,\n      form,\n      decorators,\n      show: false,\n      // 到期有效时间\n      validEndTime: 0,\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      // 优惠券\n      selectCoupon: '',\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      couponDropdownVisible: false,\n      product_id: '',\n      isFollowSalesman: 0,\n      product_name: ''\n    }\n  },\n  computed: {\n    modelTitle() {\n      return this.$c('small_course') + '签单'\n    },\n    canChoseCoupon() {\n      let len = this.couponList.length\n      return (this.id || this.product_id) && len\n    },\n    canChoseAdvance() {\n      let len = this.advanceList.length\n      return (this.id || this.product_id) && len\n    },\n    onViewCourseHref() {\n      const course_id = this.form.getFieldValue('productId') || undefined\n      return `/shop/product/course/schedule/small-course?app_brand_id=${this.$searchQuery.app_brand_id}&app_shop_id=${this.$searchQuery.app_shop_id}&course_id=${course_id}`\n    },\n    courseBeginTime() {\n      return (\n        moment(this.info.course_begin_time * 1000).format('YYYY-MM-DD HH:MM') +\n        '~' +\n        moment(this.info.course_end_time * 1000).format('YYYY-MM-DD HH:MM')\n      )\n    },\n    orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : ''\n    },\n    amountMax() {\n      // if (this.info.course_type === this.COURSE_TYPE.FIXED_COURSE) {\n      //   return this.info.buy_num || 0\n      // }\n      return this.info.buy_num || 1\n    },\n    amountMin() {\n      // if (this.info.course_type === this.COURSE_TYPE.FIXED_COURSE) {\n      //   return this.info.buy_num || 0\n      // }\n      return 1\n    },\n    isDisabledBuyNum() {\n      return this.info.course_type === this.COURSE_TYPE.FIXED_COURSE\n    },\n    saleRangeType() {\n      return get(this.info.sale_range, 'type', 1)\n    },\n    hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}'\n    }\n  },\n  watch: {\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(newVal, this.selectAdvance, +this.reduceAmount)\n      }\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(this.selectCoupon, newVal, +this.reduceAmount)\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectCoupon, this.selectAdvance, +newVal)\n    }\n  },\n  mounted() {\n    this.saleSmallCourseService.serviceInit().subscribe(result => {\n      if (this.id) {\n        this.handleGetCourseInfo(this.id)\n      } else {\n        this.saleSmallCourseService\n          .getSmallCourseList({\n            app_brand_id: this.$searchQuery.app_brand_id,\n            app_shop_id: this.$searchQuery.app_shop_id,\n            product_type: 7\n          })\n          .subscribe()\n      }\n    })\n  },\n  methods: {\n    moment,\n    // 选择课,筛选\n    handleSelect(val) {\n      this.product_id = val\n      this.onResetDiscounts()\n      this.handleGetCourseInfo(val)\n    },\n    // 选择课,搜索\n    handleSearch(product_name) {\n      this.product_name = product_name\n      this.saleSmallCourseService\n        .getSmallCourseList({\n          product_name,\n          current_page: 1,\n          app_brand_id: this.$searchQuery.app_brand_id,\n          app_shop_id: this.$searchQuery.app_shop_id,\n          product_type: 7\n        })\n        .subscribe()\n    },\n    onResetDiscounts() {\n      console.log('onResetDiscounts')\n      // 重置优惠券及定金选择\n      this.resetCoupon()\n      this.resetAdvance()\n    },\n    // 重新获取优惠券及定金\n    onReGetDiscounts(data) {\n      console.log('onReGetDiscounts')\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      this.fetchAdvanceList(data)\n      this.fetchCouponList(data)\n    },\n    // 重新获取定金及优惠券\n    onMemberChange(data) {\n      // 重置优惠券及定金选择\n      this.onResetDiscounts()\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      if (data) this.onReGetDiscounts(data)\n    },\n    // 选择定金\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    // 选择优惠券\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    // 重置定金选择\n    resetAdvance() {\n      this.advanceList = []\n      this.advanceText = '未选择定金'\n      this.selectAdvance = ''\n      this.advanceAmount = ''\n    },\n    // 重置优惠券选择\n    resetCoupon() {\n      this.saleSmallCourseService.REST_COUPONLIST()\n      this.couponText = '未选择优惠券'\n      this.selectCoupon = ''\n      this.couponAmount = ''\n    },\n    // 关闭签单弹窗\n    onCancel() {\n      this.resetAdvance()\n      this.resetCoupon()\n    },\n    // 选择定金\n    onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0\n        this.advanceText = `未选择定金`\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    // 选择优惠券\n    onSelectCouponChange(event) {\n      let id = get(event.target.value, 'id', '')\n      if (id) {\n        let price = this.couponList.filter(o => o.id === id)[0].price\n        this.couponAmount = price\n        this.couponText = `${price}元`\n      } else {\n        this.couponText = '未选择优惠券'\n        this.couponAmount = 0\n      }\n    },\n    // 计算实付金额\n    getPrice(coupon, advance, reduce) {\n      let advanceId = advance === -1 ? '' : advance\n      const product_id = this.form.getFieldValue('productId') || undefined\n      this.saleSmallCourseService.priceAction$.dispatch({\n        product_id,\n        product_type: this.info.contract_type,\n        product_num: this.form.getFieldValue('course_num'),\n        coupon_id: coupon ? coupon.id : undefined,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        member_id: this.form.getFieldValue('member_id')\n      })\n    },\n    // 获取订单总额\n    getOrderPrice() {\n      const product_id = this.form.getFieldValue('productId') || undefined\n      this.saleSmallCourseService.orderAmountPriceAction$.dispatch({\n        product_id,\n        product_type: this.info.contract_type,\n        product_num: 0\n      })\n    },\n    // 创建订单\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        const small_course_id =\n          this.form.getFieldValue('productId') || undefined\n        this.saleSmallCourseService\n          .setTransactionOrder({\n            member_id: values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            country_prefix: values.mobile ? values.mobile.code_id : undefined,\n            small_course_id,\n            course_num: values.course_num,\n            contract_number: this.info.contract_number,\n            coupon_id: this.selectCoupon.id,\n            advance_id: this.selectAdvance,\n            reduce_amount: this.reduceAmount || 0,\n            sale_id: values.saleName,\n            description: this.description,\n            sale_range: this.info.sale_range.type,\n            order_amount: this.priceInfo,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'create',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    // 订单支付\n    onPay() {\n      this.form.validate().then(values => {\n        const small_course_id =\n          this.form.getFieldValue('productId') || undefined\n        this.saleSmallCourseService\n          .setTransactionPay({\n            member_id: values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            country_prefix: values.mobile ? values.mobile.code_id : undefined,\n            small_course_id,\n            course_num: values.course_num,\n            contract_number: this.info.contract_number,\n            coupon_id: this.selectCoupon.id,\n            advance_id: this.selectAdvance,\n            reduce_amount: this.reduceAmount || 0,\n            sale_id: values.saleName,\n            description: this.description,\n            sale_range: this.info.sale_range.type,\n            order_amount: this.priceInfo,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    // 获取优惠券列表\n    fetchCouponList(id) {\n      const member_id = this.form.getFieldValue('member_id') || id\n      const price = this.personalPrice.sell_price\n      const buy_num = this.form.getFieldValue('course_num')\n      const course_id = this.form.getFieldValue('productId') || undefined\n      if (course_id && member_id) {\n        const params = {\n          member_id,\n          course_id,\n          price,\n          buy_num\n        }\n        this.saleSmallCourseService.getCouponList(params).subscribe()\n      }\n    },\n    // 获取定金列表\n    fetchAdvanceList(id) {\n      let member_id = this.form.getFieldValue('member_id') || id\n      if (member_id) {\n        this.saleSmallCourseService.getAdvanceList(member_id).subscribe(res => {\n          this.advanceList = cloneDeep(res.list)\n        })\n      }\n    },\n    // 获取课程列表\n    handleGetList() {\n      console.log('finished 1', this.finished)\n      console.log('page', this.page)\n      if (this.finished) return false\n      this.saleSmallCourseService\n        .getSmallCourseList({\n          product_name: this.product_name,\n          current_page: ++this.page.current_page,\n          app_brand_id: this.$searchQuery.app_brand_id,\n          app_shop_id: this.$searchQuery.app_shop_id,\n          product_type: 7\n        })\n        .subscribe()\n    },\n    // 获取课程详情\n    handleGetCourseInfo(productId) {\n      this.saleSmallCourseService.getInfo(productId).subscribe(res => {\n        if (this.id) {\n          this.saleSmallCourseService.SET_LIST([\n            {\n              id: +this.id,\n              product_name: this.info.course_name\n            }\n          ])\n        }\n        setTimeout(() => {\n          // 设置\n          this.form.setFieldsValue({\n            productId: +productId,\n            course_num: this.info.buy_num\n          })\n          this.onReGetDiscounts()\n          this.getPrice()\n          this.getOrderPrice()\n        })\n      })\n    }\n  }\n}\n</script>\n"]}]}