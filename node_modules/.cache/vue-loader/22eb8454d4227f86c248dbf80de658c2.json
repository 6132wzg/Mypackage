{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/member/add-card-member/add-card-member.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/member/add-card-member/add-card-member.vue","mtime":1600926555687},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { cloneDeep } from 'lodash-es'\nimport { AddCardMemberService } from './add-card-member.service'\nimport { MessageService } from '@/services/message.service'\nimport { PatternService } from '@/services/pattern.service'\nexport default {\n  name: 'AddCardMember',\n  bem: {\n    b: 'page-add-card-member'\n  },\n  serviceProviders() {\n    return [AddCardMemberService]\n  },\n  serviceInject() {\n    return {\n      addCardMemberService: AddCardMemberService,\n      messageService: MessageService,\n      patternService: PatternService\n    }\n  },\n  rxState() {\n    let { parentTypeOptions$, minorsTypeOptions$ } = this.addCardMemberService\n    return {\n      memberList: this.addCardMemberService.memberList$,\n      parentTypeOptions$,\n      minorsTypeOptions$\n    }\n  },\n  model: {\n    prop: 'list',\n    event: 'change'\n  },\n  props: {\n    addText: {\n      type: String,\n      default: '新增卡成员'\n    },\n    type: {\n      type: Number,\n      default: 1\n    },\n    productType: {\n      type: String\n    },\n    max: {\n      type: Number,\n      default: 10\n    },\n    list: {\n      type: Array,\n      default: () => []\n    }\n  },\n  data() {\n    return {\n      visible: false,\n      memberSearchText: '',\n      searchMemberIsShow: true,\n      memberId: '',\n      searchFlag: false,\n      searchWidth: ''\n    }\n  },\n  mounted() {\n    this.$nextTick(function() {\n      this.searchWidth =\n        this.$refs.addMemberCardButton.$el.offsetWidth - 32 + 'px'\n    })\n  },\n  methods: {\n    parentUserRoleStr(value) {\n      let label = value\n      if (typeof value === 'number') {\n        this.parentTypeOptions$.forEach(element => {\n          if (element.value === value) {\n            label = element.label\n          }\n        })\n      }\n      return label\n    },\n    selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`\n      }\n      return `${item.member_name} ${item.mobile}`\n    },\n    onConfirmItem(data, index) {\n      if (!data.name) {\n        this.messageService.error({\n          content: '请填写正确成员姓名'\n        })\n        return\n      }\n      if (!data.mobile || !this.patternService.MOBILE.test(data.mobile)) {\n        this.messageService.error({\n          content: '请填写正确手机号'\n        })\n        return\n      }\n\n      const isExist = this.list.filter(\n        item => item.mobile === data.mobile && !item.isEdit\n      )\n      if (data.is_minors) {\n        data.parent_mobile = data.mobile\n      }\n      // 未成年人不校验手机重复 20200720\n      if (!data.is_minors && isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        })\n        return\n      }\n      data.isEdit = false\n      this.$emit('change', this.list)\n    },\n    onCancelItem(item, index) {\n      this.list.shift()\n      this.$emit('change', this.list)\n    },\n    onDeleteItem(item, index) {\n      this.list.splice(index, 1)\n      this.$emit('change', this.list)\n    },\n    onChangeMinors($event, item) {\n      console.log($event, item)\n      // 未成年需要关系字段\n      if ($event === 1) {\n        item.parent_mobile = item.mobile\n        this.$set(item, 'parent_user_role', 1)\n      }\n    },\n    onAddMember() {\n      this.memberSearchText = ''\n      const isExistEdit = this.list.filter(item => item.isEdit)\n      if (isExistEdit && isExistEdit.length > 0) {\n        this.messageService.error({\n          content: '还有没有新增完成的成员'\n        })\n        return\n      }\n      this.visible = false\n      this.list.unshift({\n        name: '',\n        mobile: '',\n        is_minors: 0,\n        isEdit: true\n      })\n    },\n    onMemberSearch(data) {\n      this.memberSearchText = data.target.value\n      if (data) {\n        this.addCardMemberService.memberListAction$.dispatch(\n          data.target.value,\n          this.type\n        )\n      }\n    },\n    onMemberChange(data) {\n      if (this.list.length >= this.max) return\n      const isExist = this.list.filter(\n        item => item.mobile === data.mobile && !item.isEdit\n      )\n      if (isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        })\n        return\n      }\n      const isExistEdit = this.list.filter(item => item.isEdit)\n      let insertIndex = 0\n      if (isExistEdit && isExistEdit.length > 0) {\n        insertIndex = 1\n      }\n      this.list.splice(insertIndex, 0, {\n        id: data.id,\n        name: data.member_name,\n        mobile: data.mobile,\n        is_minors: data.is_minors,\n        parent_mobile: data.parent_mobile,\n        parent_name: data.parent_name,\n        parent_user_role: data.parent_user_role\n      })\n      this.visible = false\n      this.resetSearchCondition()\n      this.$emit('change', this.list)\n    },\n    resetSearchCondition() {\n      this.memberSearchText = ''\n      this.memberList = []\n    }\n  }\n}\n",{"version":3,"sources":["add-card-member.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"add-card-member.vue","sourceRoot":"src/views/biz-components/member/add-card-member","sourcesContent":["<template>\n  <st-container>\n    <st-form-table :class=\"b()\">\n      <colgroup>\n        <col style=\"width:40%;\" />\n        <col style=\"width:40%;\" />\n        <col style=\"width:20%;\" />\n      </colgroup>\n      <thead>\n        <tr>\n          <th>成员姓名</th>\n          <th>手机号</th>\n          <th>操作</th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr>\n          <td colspan=\"3\" :class=\"b('search-wrapper')\">\n            <a-popover\n              trigger=\"click\"\n              v-model=\"visible\"\n              placement=\"bottom\"\n              :arrowPointAtCenter=\"true\"\n              overlayClassName=\"change-member-popover\"\n            >\n              <div\n                slot=\"content\"\n                :class=\"b('search-section')\"\n                id=\"search-section\"\n                ref=\"searchSection\"\n              >\n                <a-input-search\n                  placeholder=\"请输入手机号码或者会员姓名\"\n                  v-model=\"memberSearchText\"\n                  @change=\"onMemberSearch\"\n                  :style=\"{\n                    width: searchWidth\n                  }\"\n                  class=\"test-input\"\n                />\n                <ul :class=\"b('search-list')\">\n                  <li\n                    :class=\"b('search-text')\"\n                    v-for=\"(item, index) in memberList\"\n                    :value=\"item.id\"\n                    :key=\"index\"\n                    @click.stop=\"onMemberChange(item)\"\n                  >\n                    <span\n                      v-html=\"\n                        `${selectItemLabel(item)}`.replace(\n                          new RegExp(memberSearchText, 'g'),\n                          `\\<span class='global-highlight-color'\\>${memberSearchText}\\<\\/span\\>`\n                        )\n                      \"\n                    >\n                      {{ selectItemLabel(item) }}\n                    </span>\n                  </li>\n                  <li\n                    v-if=\"type !== 2\"\n                    :class=\"[b('search-text'), b('search-tip')]\"\n                  >\n                    查无此会员，\n                    <a @click=\"onAddMember\">新增新会员？</a>\n                  </li>\n                </ul>\n              </div>\n              <st-button\n                :disabled=\"list.length >= max\"\n                type=\"dashed\"\n                icon=\"add\"\n                block\n                ref=\"addMemberCardButton\"\n              >\n                {{ addText }}\n              </st-button>\n            </a-popover>\n          </td>\n        </tr>\n        <tr v-for=\"(item, index) in list\" :key=\"index\">\n          <td>\n            <template v-if=\"item.isEdit\">\n              <a-input placeholder=\"输入姓名\" v-model=\"item.name\">\n                <a-select\n                  slot=\"addonAfter\"\n                  default-value=\"1\"\n                  style=\"width: 100px\"\n                  v-if=\"productType === 'package'\"\n                  @change=\"onChangeMinors($event, item)\"\n                  v-model=\"item.is_minors\"\n                  :options=\"minorsTypeOptions$\"\n                ></a-select>\n              </a-input>\n            </template>\n            <template v-else>\n              {{ item.name }}\n              <st-icon\n                v-if=\"item.is_minors\"\n                type=\"user-type\"\n                color=\"#3F66F6\"\n              ></st-icon>\n            </template>\n          </td>\n          <td>\n            <template v-if=\"item.isEdit\">\n              <a-input placeholder=\"输入手机号\" v-model=\"item.mobile\">\n                <a-select\n                  slot=\"addonAfter\"\n                  :default-value=\"1\"\n                  v-model=\"item.parent_user_role\"\n                  style=\"width: 80px\"\n                  v-if=\"productType === 'package' && item.is_minors\"\n                  :options=\"parentTypeOptions$\"\n                ></a-select>\n              </a-input>\n            </template>\n            <template v-else-if=\"item.is_minors\">\n              {{ item.parent_mobile }}({{\n                parentUserRoleStr(item.parent_user_role)\n              }})\n            </template>\n            <template v-else>\n              {{ item.mobile }}\n            </template>\n          </td>\n          <td>\n            <a\n              v-if=\"item.isEdit\"\n              class=\"mg-r8\"\n              @click=\"onConfirmItem(item, index)\"\n            >\n              确认\n            </a>\n            <a v-if=\"item.isEdit\" @click=\"onCancelItem(item, index)\">取消</a>\n            <a v-if=\"!item.isEdit\" @click=\"onDeleteItem(item, index)\">删除</a>\n          </td>\n        </tr>\n        <tr v-if=\"list.length <= 0\">\n          <td colspan=\"3\">\n            <st-no-data />\n          </td>\n        </tr>\n      </tbody>\n    </st-form-table>\n  </st-container>\n</template>\n<script>\nimport { cloneDeep } from 'lodash-es'\nimport { AddCardMemberService } from './add-card-member.service'\nimport { MessageService } from '@/services/message.service'\nimport { PatternService } from '@/services/pattern.service'\nexport default {\n  name: 'AddCardMember',\n  bem: {\n    b: 'page-add-card-member'\n  },\n  serviceProviders() {\n    return [AddCardMemberService]\n  },\n  serviceInject() {\n    return {\n      addCardMemberService: AddCardMemberService,\n      messageService: MessageService,\n      patternService: PatternService\n    }\n  },\n  rxState() {\n    let { parentTypeOptions$, minorsTypeOptions$ } = this.addCardMemberService\n    return {\n      memberList: this.addCardMemberService.memberList$,\n      parentTypeOptions$,\n      minorsTypeOptions$\n    }\n  },\n  model: {\n    prop: 'list',\n    event: 'change'\n  },\n  props: {\n    addText: {\n      type: String,\n      default: '新增卡成员'\n    },\n    type: {\n      type: Number,\n      default: 1\n    },\n    productType: {\n      type: String\n    },\n    max: {\n      type: Number,\n      default: 10\n    },\n    list: {\n      type: Array,\n      default: () => []\n    }\n  },\n  data() {\n    return {\n      visible: false,\n      memberSearchText: '',\n      searchMemberIsShow: true,\n      memberId: '',\n      searchFlag: false,\n      searchWidth: ''\n    }\n  },\n  mounted() {\n    this.$nextTick(function() {\n      this.searchWidth =\n        this.$refs.addMemberCardButton.$el.offsetWidth - 32 + 'px'\n    })\n  },\n  methods: {\n    parentUserRoleStr(value) {\n      let label = value\n      if (typeof value === 'number') {\n        this.parentTypeOptions$.forEach(element => {\n          if (element.value === value) {\n            label = element.label\n          }\n        })\n      }\n      return label\n    },\n    selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`\n      }\n      return `${item.member_name} ${item.mobile}`\n    },\n    onConfirmItem(data, index) {\n      if (!data.name) {\n        this.messageService.error({\n          content: '请填写正确成员姓名'\n        })\n        return\n      }\n      if (!data.mobile || !this.patternService.MOBILE.test(data.mobile)) {\n        this.messageService.error({\n          content: '请填写正确手机号'\n        })\n        return\n      }\n\n      const isExist = this.list.filter(\n        item => item.mobile === data.mobile && !item.isEdit\n      )\n      if (data.is_minors) {\n        data.parent_mobile = data.mobile\n      }\n      // 未成年人不校验手机重复 20200720\n      if (!data.is_minors && isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        })\n        return\n      }\n      data.isEdit = false\n      this.$emit('change', this.list)\n    },\n    onCancelItem(item, index) {\n      this.list.shift()\n      this.$emit('change', this.list)\n    },\n    onDeleteItem(item, index) {\n      this.list.splice(index, 1)\n      this.$emit('change', this.list)\n    },\n    onChangeMinors($event, item) {\n      console.log($event, item)\n      // 未成年需要关系字段\n      if ($event === 1) {\n        item.parent_mobile = item.mobile\n        this.$set(item, 'parent_user_role', 1)\n      }\n    },\n    onAddMember() {\n      this.memberSearchText = ''\n      const isExistEdit = this.list.filter(item => item.isEdit)\n      if (isExistEdit && isExistEdit.length > 0) {\n        this.messageService.error({\n          content: '还有没有新增完成的成员'\n        })\n        return\n      }\n      this.visible = false\n      this.list.unshift({\n        name: '',\n        mobile: '',\n        is_minors: 0,\n        isEdit: true\n      })\n    },\n    onMemberSearch(data) {\n      this.memberSearchText = data.target.value\n      if (data) {\n        this.addCardMemberService.memberListAction$.dispatch(\n          data.target.value,\n          this.type\n        )\n      }\n    },\n    onMemberChange(data) {\n      if (this.list.length >= this.max) return\n      const isExist = this.list.filter(\n        item => item.mobile === data.mobile && !item.isEdit\n      )\n      if (isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        })\n        return\n      }\n      const isExistEdit = this.list.filter(item => item.isEdit)\n      let insertIndex = 0\n      if (isExistEdit && isExistEdit.length > 0) {\n        insertIndex = 1\n      }\n      this.list.splice(insertIndex, 0, {\n        id: data.id,\n        name: data.member_name,\n        mobile: data.mobile,\n        is_minors: data.is_minors,\n        parent_mobile: data.parent_mobile,\n        parent_name: data.parent_name,\n        parent_user_role: data.parent_user_role\n      })\n      this.visible = false\n      this.resetSearchCondition()\n      this.$emit('change', this.list)\n    },\n    resetSearchCondition() {\n      this.memberSearchText = ''\n      this.memberList = []\n    }\n  }\n}\n</script>\n"]}]}