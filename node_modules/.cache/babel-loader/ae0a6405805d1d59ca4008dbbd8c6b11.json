{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue","mtime":1596188219491},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue';\nimport { ruleOptions } from \"./time-table.config\";\nimport TimeTable from \"./time-table/table\";\nimport { TeamTimeTableService } from \"./time-table.service\";\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service';\nimport { MessageService } from '@/services/message.service';\nimport { cloneDeep, omit, pick } from 'lodash-es';\nimport { ShsService } from '@/services/shs.service';\nexport default {\n  bem: {\n    b: 'schedule-team-time-table'\n  },\n  components: {\n    StImageUpload: StImageUpload,\n    TimeTable: TimeTable\n  },\n  serviceInject: function serviceInject() {\n    return {\n      teamScheduleCommomService: TeamScheduleCommonService,\n      timeTableService: TeamTimeTableService,\n      messageService: MessageService,\n      shsService: ShsService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.timeTableService.loading$,\n      courtList: this.teamScheduleCommomService.courtOptions$\n    };\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      form: form,\n      decorators: decorators,\n      show: false,\n      bgFileList: [],\n      codeFileList: [],\n      title: '',\n      // 课表标题\n      bgUrl: '',\n      // 背景图\n      codeUrl: '',\n      // 二维码图片\n      rangeTime: '',\n      // 时间范围\n      tableData: {},\n      bgErrorText: '',\n      codeErrorText: '',\n      startDate: '',\n      endDate: '',\n      downLoadLoading: false,\n      saveLoading: false\n    };\n  },\n  created: function created() {},\n  mounted: function mounted() {\n    var weekOfday = moment().format('E'); // 今天是本周第几天\n\n    this.startDate = moment().subtract(weekOfday - 1, 'days').format('YYYY-MM-DD'); // 周一日期\n\n    this.endDate = moment(this.startDate).add(6, 'days').format('YYYY-MM-DD');\n    this.getTimeTableTemplate();\n  },\n  computed: {\n    ruleOptions: ruleOptions\n  },\n  watch: {\n    startDate: function startDate() {\n      var startTime = moment(this.startDate).format('YYYY/MM/DD').slice(5, this.startDate.length);\n      var endDate = moment(this.startDate).add(6, 'days').format('YYYY/MM/DD');\n      var endTime = endDate.slice(5, endDate.length);\n      this.rangeTime = \"\".concat(startTime, \"-\").concat(endTime);\n    }\n  },\n  methods: {\n    getTimeTableTemplate: function getTimeTableTemplate() {\n      var _this = this;\n\n      this.timeTableService.getTimeTableTemplate().subscribe(function (res) {\n        _this.tableData = res.info;\n        _this.title = _this.tableData.title;\n\n        _this.form.setFieldsValue({\n          title: _this.tableData.title,\n          selected_court: _this.tableData.selected_court\n        });\n\n        if (_this.tableData.is_bgimage) {\n          // 背景自定义\n          _this.bgFileList = [_this.tableData.customize_bgimage];\n          _this.bgUrl = _this.tableData.customize_bgimage.image_url;\n          _this.tableData.bg_image = _this.tableData.customize_bgimage.image_key;\n        } else {\n          _this.bgUrl = _this.tableData.def_bgimage.image_url;\n          _this.tableData.bg_image = '';\n        }\n\n        if (_this.tableData.is_qrcode) {\n          // 二维码自定义\n          _this.codeFileList = _this.tableData.customize_qrcode.image_key ? [_this.tableData.customize_qrcode] : [];\n          _this.codeUrl = _this.tableData.customize_qrcode.image_url;\n          _this.tableData.qrcode = _this.tableData.customize_qrcode.image_key;\n        } else {\n          _this.codeUrl = _this.tableData.def_qrcode.image_url;\n          _this.tableData.qrcode = '';\n        }\n      });\n    },\n    // 选择时间段\n    onChangeDate: function onChangeDate(date) {\n      this.startDate = date.start_date;\n      this.endDate = date.end_date;\n    },\n    changeTitle: function changeTitle(e) {\n      this.title = e.target.value;\n    },\n    changeBgType: function changeBgType() {\n      if (!this.tableData.is_bgimage) {\n        this.bgUrl = this.tableData.def_bgimage.image_url;\n        this.tableData.bg_image = '';\n      } else {\n        this.bgUrl = this.bgFileList.length ? this.bgFileList[0].image_url : this.bgUrl;\n        this.tableData.bg_image = this.bgFileList.length ? this.bgFileList[0].image_key : '';\n        this.bgImgValidate();\n      }\n    },\n    changeCodeType: function changeCodeType() {\n      if (!this.tableData.is_qrcode) {\n        this.codeUrl = this.tableData.def_qrcode.image_url;\n        this.tableData.qrcode = '';\n      } else {\n        this.codeUrl = this.codeFileList.length ? this.codeFileList[0].image_url : '';\n        this.tableData.qrcode = this.codeFileList.length ? this.codeFileList[0].image_key : '';\n        this.codeImgValidate();\n      }\n    },\n    bgFileChange: function bgFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.bg_image = fileData[0].image_key;\n        this.bgUrl = fileData[0].image_url;\n        this.bgFileList = fileData;\n      } else {\n        this.tableData.bg_image = '';\n      }\n\n      this.bgImgValidate();\n    },\n    codeFileChange: function codeFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.qrcode = fileData[0].image_key;\n        this.codeUrl = fileData[0].image_url;\n        this.codeFileList = fileData;\n      } else {\n        this.tableData.qrcode = '';\n      }\n\n      this.codeImgValidate();\n    },\n    saveTimeTable: function saveTimeTable() {\n      this.editTimeTable();\n    },\n    downloadTimeTable: function downloadTimeTable() {\n      this.editTimeTable(true);\n    },\n    editTimeTable: function editTimeTable() {\n      var _this2 = this;\n\n      var isDownload = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n      this.bgImgValidate();\n      this.codeImgValidate();\n      this.form.validate().then(function (value) {\n        if (!_this2.bgErrorText && !_this2.codeErrorText) {\n          var tableData = omit(_this2.tableData, ['brand_log', 'shop_name', 'customize_bgimage', 'customize_qrcode', 'def_bgimage', 'def_qrcode']);\n\n          var saveData = _objectSpread({}, tableData, {\n            title: value.title,\n            selected_court: value.selected_court\n          });\n\n          console.log(saveData);\n\n          if (isDownload) {\n            _this2.downLoadLoading = true;\n          } else {\n            _this2.saveLoading = true;\n          }\n\n          _this2.timeTableService.saveTimeTableTemplate(saveData).subscribe(function (res) {\n            if (!isDownload) {\n              _this2.saveLoading = false;\n\n              _this2.messageService.success({\n                content: '保存成功'\n              });\n            } else {\n              _this2.timeTableService.getTimeTableList({\n                start_date: _this2.startDate,\n                end_date: _this2.endDate\n              }).subscribe(function (res) {\n                if (!res.list.length) {\n                  _this2.downLoadLoading = false;\n\n                  _this2.messageService.error({\n                    content: '当前时间段未排课'\n                  });\n                } else {\n                  var pickData = pick(_this2.tableData, ['is_bgimage', 'brand_log', 'prompt_message', 'is_show_nickname', 'is_show_strength_level']);\n\n                  var shsData = _objectSpread({}, pickData, {\n                    bgUrl: _this2.bgUrl,\n                    qrcode_url: _this2.codeUrl,\n                    shop_name: _this2.tableData.is_show_shop ? _this2.tableData.shop_name : '',\n                    rangeTime: _this2.rangeTime,\n                    title: _this2.title,\n                    timeTableList: JSON.stringify(res.list),\n                    isSaveFile: 1\n                  });\n\n                  _this2.shsService.getShsImage(shsData, '/saas/time_table').subscribe(function (url) {\n                    _this2.downLoadLoading = false;\n\n                    _this2.messageService.success({\n                      content: '保存并下载成功'\n                    });\n\n                    console.log(url);\n\n                    _this2.downloadFile(url, \"\".concat(_this2.title, \".png\"));\n                  });\n                }\n              });\n            }\n          });\n        }\n      });\n    },\n    downloadFile: function downloadFile(url) {\n      var _this3 = this;\n\n      var filename = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n      fetch(url, {\n        headers: new Headers({\n          Origin: location.origin\n        }),\n        mode: 'cors'\n      }).then(function (res) {\n        return res.blob();\n      }).then(function (blob) {\n        var blobUrl = window.URL.createObjectURL(blob);\n\n        _this3.download(blobUrl, filename);\n\n        window.URL.revokeObjectURL(blobUrl);\n      });\n    },\n    download: function download(blobUrl, filename) {\n      var a = document.createElement('a');\n      a.href = blobUrl;\n      a.target = '_blank';\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      a.remove();\n    },\n    bgImgValidate: function bgImgValidate() {\n      if (this.tableData.is_bgimage) {\n        this.bgErrorText = !this.tableData.bg_image ? '请上传背景图' : '';\n      } else {\n        this.bgErrorText = '';\n      }\n    },\n    codeImgValidate: function codeImgValidate() {\n      if (this.tableData.is_qrcode) {\n        this.codeErrorText = !this.tableData.qrcode ? '请上传二维码图片' : '';\n      } else {\n        this.codeErrorText = '';\n      }\n    }\n  }\n};",null]}