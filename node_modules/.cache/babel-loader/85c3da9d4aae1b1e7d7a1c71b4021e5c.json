{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/card/renewal-member.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/card/renewal-member.vue","mtime":1594718340025},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { RenewalMemberService } from \"./renewal-member.service\";\nimport moment from 'moment';\nimport { cloneDeep } from 'lodash-es';\nimport { timer } from 'rxjs';\nimport { ruleOptions } from \"./renewal-member.config\";\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue';\nexport default {\n  name: 'ModalSoldRenewalMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  serviceProviders: function serviceProviders() {\n    return [RenewalMemberService];\n  },\n  serviceInject: function serviceInject() {\n    return {\n      renewalMemberService: RenewalMemberService\n    };\n  },\n  components: {\n    EditableContractNumber: EditableContractNumber\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.renewalMemberService.loading$,\n      couponList: this.renewalMemberService.couponList$,\n      advanceList: this.renewalMemberService.advanceList$,\n      priceInfo: this.renewalMemberService.priceInfo$,\n      saleList: this.renewalMemberService.saleList$,\n      info: this.renewalMemberService.info$\n    };\n  },\n  props: ['id'],\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      form: form,\n      decorators: decorators,\n      show: false,\n      // 规格\n      selectSpecs: 1,\n      // 时间\n      startTime: null,\n      endTime: '',\n      // 赠送\n      giftAmount: null,\n      // 优惠\n      couponDropdownVisible: false,\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      selectCoupon: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      // 减免金额\n      reduceAmount: null,\n      // 描述\n      description: ''\n    };\n  },\n  created: function created() {\n    var _this = this;\n\n    this.renewalMemberService.serviceInit(this.id).subscribe(function (res) {\n      // 获取优惠券\n      _this.renewalMemberService.getCouponList({\n        member_id: res[0].info.member_id,\n        card_id: res[0].info.card_id,\n        specs_id: res[0].info.specs[0].id\n      }).subscribe(); // 获取定金\n\n\n      _this.renewalMemberService.getAdvanceList(res[0].info.member_id).subscribe(); // 规格\n\n\n      _this.selectSpecs = res[0].info.specs[0].id;\n\n      _this.form.setFieldsValue({\n        startTime: moment(res[0].info.default_start_time * 1000)\n      }); // 实付金额\n\n\n      _this.getPrice('', 0, '', res[0].info.specs[0].id);\n\n      _this.startTime = cloneDeep(moment(res[0].info.default_start_time * 1000));\n      _this.endTime = moment(res[0].info.default_start_time * 1000).add(res[0].info.specs[0].valid_time, 'd').format('YYYY-MM-DD HH:mm');\n    });\n  },\n  watch: {\n    selectSpecs: function selectSpecs(newVal, oldVal) {\n      this.getPrice(this.selectAdvance, +this.reduceAmount, this.selectCoupon, newVal);\n    },\n    selectAdvance: {\n      deep: true,\n      handler: function handler(newVal, oldVal) {\n        this.getPrice(newVal, +this.reduceAmount, this.selectCoupon, this.selectSpecs);\n      }\n    },\n    selectCoupon: {\n      deep: true,\n      handler: function handler(newVal, oldVal) {\n        this.getPrice(this.selectAdvance, +this.reduceAmount, newVal, this.selectSpecs);\n      }\n    },\n    reduceAmount: function reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectAdvance, +newVal, this.selectCoupon, this.selectSpecs);\n    }\n  },\n  computed: {\n    // 商品价格\n    cardPrice: function cardPrice() {\n      var _this2 = this;\n\n      if (this.info.specs) {\n        var arr = this.info.specs.filter(function (i) {\n          return i.id === _this2.selectSpecs;\n        });\n\n        if (arr.length > 0) {\n          return arr[0].price;\n        }\n\n        return '0';\n      }\n\n      return '0';\n    },\n    orderAmountText: function orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : '';\n    },\n    isFamilyCard: function isFamilyCard() {\n      return this.info.card_number_type === 2;\n    }\n  },\n  methods: {\n    moment: moment,\n    // 规格\n    onSpecsChange: function onSpecsChange(data) {\n      var _this3 = this;\n\n      var item = this.info.specs.filter(function (i) {\n        return i.id === data.target.value;\n      })[0];\n      var s = cloneDeep(this.startTime);\n      var dayScope = item.valid_time;\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm'); // 获取优惠券\n\n      this.renewalMemberService.getCouponList({\n        member_id: this.info.member_id,\n        card_id: this.info.card_id,\n        specs_id: item.id\n      }).subscribe(function (res) {\n        _this3.resetCoupon();\n      });\n    },\n    // 时间\n    disabledStartDate: function disabledStartDate(startTime) {\n      return startTime.valueOf() < this.info.default_start_time * 1000;\n    },\n    onStartTimeChange: function onStartTimeChange(data) {\n      var _this4 = this;\n\n      this.startTime = cloneDeep(data);\n      var s = cloneDeep(data);\n      var dayScope = this.info.specs.filter(function (i) {\n        return i.id === _this4.selectSpecs;\n      })[0].valid_time;\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm');\n    },\n    // 优惠\n    onSelectCouponChange: function onSelectCouponChange(data) {\n      if (data.target.value === -1) {\n        this.couponAmount = '';\n        this.couponText = '未选择优惠券';\n        return;\n      }\n\n      var price = this.couponList.filter(function (o) {\n        return o.id === data.target.value;\n      })[0].price;\n      this.couponAmount = price;\n      this.couponText = \"\".concat(price, \"\\u5143\");\n    },\n    onSelectCoupon: function onSelectCoupon() {\n      var _this5 = this;\n\n      timer(200).subscribe(function () {\n        _this5.couponDropdownVisible = false;\n      });\n    },\n    resetCoupon: function resetCoupon() {\n      this.renewalMemberService.resetCouponList();\n      this.couponText = '未选择优惠券';\n      this.couponAmount = '';\n      this.selectcoupon = '';\n    },\n    // 定金\n    onSelectAdvanceChange: function onSelectAdvanceChange(data) {\n      if (data.target.value === -1) {\n        this.advanceAmount = '';\n        this.advanceText = '未选择定金';\n        return;\n      }\n\n      var price = this.advanceList.filter(function (o) {\n        return o.id === data.target.value;\n      })[0].price;\n      this.advanceAmount = price;\n      this.advanceText = \"\".concat(price, \"\\u5143\");\n    },\n    onSelectAdvance: function onSelectAdvance() {\n      var _this6 = this;\n\n      timer(200).subscribe(function () {\n        _this6.advanceDropdownVisible = false;\n      });\n    },\n    resetAdvance: function resetAdvance() {\n      this.renewalMemberService.resetAdvanceList();\n      this.advanceText = '未选择定金';\n      this.advanceAmount = '';\n      this.selectAdvance = '';\n    },\n    // 计算实付金额\n    getPrice: function getPrice(advance, reduce, coupon, specs_id) {\n      var advanceId = advance === -1 ? '' : advance;\n      var couponId = coupon === -1 ? '' : coupon;\n      this.renewalMemberService.priceAction$.dispatch({\n        id: this.id,\n        product_id: this.info.card_id,\n        product_type: this.info.contract_type,\n        specs_id: specs_id,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        coupon_id: couponId,\n        member_id: this.info.member_id\n      });\n    },\n    onCreateOrder: function onCreateOrder() {\n      var _this7 = this;\n\n      this.form.validate().then(function (values) {\n        var reduce_amount = _this7.reduceAmount ? +_this7.reduceAmount : undefined;\n\n        _this7.renewalMemberService.renewal({\n          contract_number: _this7.info.contract_number,\n          rule_id: _this7.selectSpecs,\n          valid_start_time: moment(values.startTime).format('YYYY-MM-DD HH:mm'),\n          gift_amount: +_this7.giftAmount,\n          user_coupon_id: _this7.selectCoupon === -1 ? undefined : +_this7.selectCoupon,\n          advance_id: _this7.selectAdvance === -1 ? undefined : _this7.selectAdvance,\n          reduce_price: reduce_amount,\n          description: _this7.description,\n          staff_sale_id: +values.saleName,\n          contract_type: _this7.info.contract_type,\n          discounts_price: +_this7.info.specs.filter(function (i) {\n            return i.id === _this7.selectSpecs;\n          })[0].price\n        }, _this7.id).subscribe(function (res) {\n          _this7.show = false;\n\n          _this7.$emit('success', {\n            type: 'create',\n            orderId: res.info.order_id,\n            soldId: res.info.sold_id,\n            isFamilyCard: _this7.isFamilyCard\n          });\n        });\n      });\n    },\n    onPay: function onPay() {\n      var _this8 = this;\n\n      this.form.validate().then(function (values) {\n        var reduce_amount = _this8.reduceAmount ? +_this8.reduceAmount : undefined;\n\n        _this8.renewalMemberService.renewalPay({\n          contract_number: _this8.info.contract_number,\n          rule_id: _this8.selectSpecs,\n          valid_start_time: moment(values.startTime).format('YYYY-MM-DD HH:mm'),\n          gift_amount: +_this8.giftAmount,\n          user_coupon_id: _this8.selectCoupon === -1 ? undefined : +_this8.selectCoupon,\n          advance_id: _this8.selectAdvance === -1 ? undefined : _this8.selectAdvance,\n          reduce_price: reduce_amount,\n          description: _this8.description,\n          staff_sale_id: +values.saleName,\n          contract_type: _this8.info.contract_type,\n          discounts_price: +_this8.info.specs.filter(function (i) {\n            return i.id === _this8.selectSpecs;\n          })[0].price\n        }, _this8.id).subscribe(function (res) {\n          _this8.show = false;\n\n          _this8.$emit('success', {\n            type: 'createPay',\n            orderId: res.info.order_id,\n            soldId: res.info.sold_id,\n            isFamilyCard: _this8.isFamilyCard\n          });\n        });\n      });\n    }\n  }\n};",null]}