{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/time-table.vue","mtime":1596188219491},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nimport { ruleOptions } from './time-table.config'\nimport TimeTable from './time-table/table'\nimport { TeamTimeTableService } from './time-table.service'\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service'\nimport { MessageService } from '@/services/message.service'\nimport { cloneDeep, omit, pick } from 'lodash-es'\nimport { ShsService } from '@/services/shs.service'\nexport default {\n  bem: {\n    b: 'schedule-team-time-table'\n  },\n  components: {\n    StImageUpload,\n    TimeTable\n  },\n  serviceInject() {\n    return {\n      teamScheduleCommomService: TeamScheduleCommonService,\n      timeTableService: TeamTimeTableService,\n      messageService: MessageService,\n      shsService: ShsService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.timeTableService.loading$,\n      courtList: this.teamScheduleCommomService.courtOptions$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      bgFileList: [],\n      codeFileList: [],\n      title: '', // 课表标题\n      bgUrl: '', // 背景图\n      codeUrl: '', // 二维码图片\n      rangeTime: '', // 时间范围\n      tableData: {},\n      bgErrorText: '',\n      codeErrorText: '',\n      startDate: '',\n      endDate: '',\n      downLoadLoading: false,\n      saveLoading: false\n    }\n  },\n  created() {},\n  mounted() {\n    let weekOfday = moment().format('E') // 今天是本周第几天\n    this.startDate = moment()\n      .subtract(weekOfday - 1, 'days')\n      .format('YYYY-MM-DD') // 周一日期\n    this.endDate = moment(this.startDate)\n      .add(6, 'days')\n      .format('YYYY-MM-DD')\n    this.getTimeTableTemplate()\n  },\n  computed: {\n    ruleOptions\n  },\n  watch: {\n    startDate() {\n      let startTime = moment(this.startDate)\n        .format('YYYY/MM/DD')\n        .slice(5, this.startDate.length)\n      let endDate = moment(this.startDate)\n        .add(6, 'days')\n        .format('YYYY/MM/DD')\n      let endTime = endDate.slice(5, endDate.length)\n      this.rangeTime = `${startTime}-${endTime}`\n    }\n  },\n  methods: {\n    getTimeTableTemplate() {\n      this.timeTableService.getTimeTableTemplate().subscribe(res => {\n        this.tableData = res.info\n        this.title = this.tableData.title\n        this.form.setFieldsValue({\n          title: this.tableData.title,\n          selected_court: this.tableData.selected_court\n        })\n        if (this.tableData.is_bgimage) {\n          // 背景自定义\n          this.bgFileList = [this.tableData.customize_bgimage]\n          this.bgUrl = this.tableData.customize_bgimage.image_url\n          this.tableData.bg_image = this.tableData.customize_bgimage.image_key\n        } else {\n          this.bgUrl = this.tableData.def_bgimage.image_url\n          this.tableData.bg_image = ''\n        }\n        if (this.tableData.is_qrcode) {\n          // 二维码自定义\n          this.codeFileList = this.tableData.customize_qrcode.image_key\n            ? [this.tableData.customize_qrcode]\n            : []\n          this.codeUrl = this.tableData.customize_qrcode.image_url\n          this.tableData.qrcode = this.tableData.customize_qrcode.image_key\n        } else {\n          this.codeUrl = this.tableData.def_qrcode.image_url\n          this.tableData.qrcode = ''\n        }\n      })\n    },\n    // 选择时间段\n    onChangeDate(date) {\n      this.startDate = date.start_date\n      this.endDate = date.end_date\n    },\n    changeTitle(e) {\n      this.title = e.target.value\n    },\n    changeBgType() {\n      if (!this.tableData.is_bgimage) {\n        this.bgUrl = this.tableData.def_bgimage.image_url\n        this.tableData.bg_image = ''\n      } else {\n        this.bgUrl = this.bgFileList.length\n          ? this.bgFileList[0].image_url\n          : this.bgUrl\n        this.tableData.bg_image = this.bgFileList.length\n          ? this.bgFileList[0].image_key\n          : ''\n        this.bgImgValidate()\n      }\n    },\n    changeCodeType() {\n      if (!this.tableData.is_qrcode) {\n        this.codeUrl = this.tableData.def_qrcode.image_url\n        this.tableData.qrcode = ''\n      } else {\n        this.codeUrl = this.codeFileList.length\n          ? this.codeFileList[0].image_url\n          : ''\n        this.tableData.qrcode = this.codeFileList.length\n          ? this.codeFileList[0].image_key\n          : ''\n        this.codeImgValidate()\n      }\n    },\n    bgFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.bg_image = fileData[0].image_key\n        this.bgUrl = fileData[0].image_url\n        this.bgFileList = fileData\n      } else {\n        this.tableData.bg_image = ''\n      }\n      this.bgImgValidate()\n    },\n    codeFileChange(fileData) {\n      if (fileData.length) {\n        this.tableData.qrcode = fileData[0].image_key\n        this.codeUrl = fileData[0].image_url\n        this.codeFileList = fileData\n      } else {\n        this.tableData.qrcode = ''\n      }\n      this.codeImgValidate()\n    },\n    saveTimeTable() {\n      this.editTimeTable()\n    },\n    downloadTimeTable() {\n      this.editTimeTable(true)\n    },\n    editTimeTable(isDownload = false) {\n      this.bgImgValidate()\n      this.codeImgValidate()\n      this.form.validate().then(value => {\n        if (!this.bgErrorText && !this.codeErrorText) {\n          let tableData = omit(this.tableData, [\n            'brand_log',\n            'shop_name',\n            'customize_bgimage',\n            'customize_qrcode',\n            'def_bgimage',\n            'def_qrcode'\n          ])\n          let saveData = {\n            ...tableData,\n            title: value.title,\n            selected_court: value.selected_court\n          }\n          console.log(saveData)\n\n          if (isDownload) {\n            this.downLoadLoading = true\n          } else {\n            this.saveLoading = true\n          }\n          this.timeTableService\n            .saveTimeTableTemplate(saveData)\n            .subscribe(res => {\n              if (!isDownload) {\n                this.saveLoading = false\n                this.messageService.success({ content: '保存成功' })\n              } else {\n                this.timeTableService\n                  .getTimeTableList({\n                    start_date: this.startDate,\n                    end_date: this.endDate\n                  })\n                  .subscribe(res => {\n                    if (!res.list.length) {\n                      this.downLoadLoading = false\n                      this.messageService.error({ content: '当前时间段未排课' })\n                    } else {\n                      let pickData = pick(this.tableData, [\n                        'is_bgimage',\n                        'brand_log',\n                        'prompt_message',\n                        'is_show_nickname',\n                        'is_show_strength_level'\n                      ])\n                      let shsData = {\n                        ...pickData,\n                        bgUrl: this.bgUrl,\n                        qrcode_url: this.codeUrl,\n                        shop_name: this.tableData.is_show_shop\n                          ? this.tableData.shop_name\n                          : '',\n                        rangeTime: this.rangeTime,\n                        title: this.title,\n                        timeTableList: JSON.stringify(res.list),\n                        isSaveFile: 1\n                      }\n\n                      this.shsService\n                        .getShsImage(shsData, '/saas/time_table')\n                        .subscribe(url => {\n                          this.downLoadLoading = false\n                          this.messageService.success({\n                            content: '保存并下载成功'\n                          })\n                          console.log(url)\n                          this.downloadFile(url, `${this.title}.png`)\n                        })\n                    }\n                  })\n              }\n            })\n        }\n      })\n    },\n    downloadFile(url, filename = '') {\n      fetch(url, {\n        headers: new Headers({\n          Origin: location.origin\n        }),\n        mode: 'cors'\n      })\n        .then(res => res.blob())\n        .then(blob => {\n          const blobUrl = window.URL.createObjectURL(blob)\n          this.download(blobUrl, filename)\n          window.URL.revokeObjectURL(blobUrl)\n        })\n    },\n    download(blobUrl, filename) {\n      const a = document.createElement('a')\n      a.href = blobUrl\n      a.target = '_blank'\n      a.download = filename\n      document.body.appendChild(a)\n      a.click()\n      a.remove()\n    },\n    bgImgValidate() {\n      if (this.tableData.is_bgimage) {\n        this.bgErrorText = !this.tableData.bg_image ? '请上传背景图' : ''\n      } else {\n        this.bgErrorText = ''\n      }\n    },\n    codeImgValidate() {\n      if (this.tableData.is_qrcode) {\n        this.codeErrorText = !this.tableData.qrcode ? '请上传二维码图片' : ''\n      } else {\n        this.codeErrorText = ''\n      }\n    }\n  }\n}\n",null]}