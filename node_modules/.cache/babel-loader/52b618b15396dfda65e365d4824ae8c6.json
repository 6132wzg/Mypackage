{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/app/plugin/components#/product-setting.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/app/plugin/components#/product-setting.vue","mtime":1601342942392},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\nimport \"core-js/modules/es6.set\";\nimport _toConsumableArray from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/es7.array.includes\";\nimport \"core-js/modules/es6.string.includes\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { PRODUCT_TYPE } from '@/constants/brand/app/plugin/discount';\nimport { typeOf } from '@/utils/type';\nimport { listToMap } from '@/utils/list-to-map';\nimport { isEqual, merge } from 'lodash-es';\nimport FormMixin from \"./form.mixin\";\nimport { MessageService } from '@/services/message.service';\nimport { memberCardColumns, depositCardColumns, personalCourseLevelColumns, personalCourseColumns, productSettingRules } from \"./product-setting.config\";\nimport { ProductSettingService } from \"./product-setting.service\";\nexport default {\n  name: 'PluginProductSetting',\n  mixins: [FormMixin],\n  serviceInject: function serviceInject() {\n    return {\n      service: ProductSettingService,\n      messageService: MessageService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.service.loading$,\n      productType: this.service.productType$,\n      memberList: this.service.memberList$,\n      depositList: this.service.depositList$,\n      personalList: this.service.personalList$,\n      coachLevelList: this.service.coachLevelList$,\n      brand: this.service.brand$\n    };\n  },\n  // decorators() {\n  //   return this.form.addDecorators(this.productSettingRules)\n  // },\n  props: {\n    discountPriceLabel: {\n      type: String,\n      default: '优惠价(元)'\n    },\n    form: {\n      type: Object,\n      default: function _default() {\n        return {};\n      }\n    }\n  },\n  data: function data() {\n    return {\n      PRODUCT_TYPE: PRODUCT_TYPE,\n      selectedRowKeys: [],\n      allSelected: false\n    };\n  },\n  computed: {\n    productSettingRules: productSettingRules,\n    decorators: function decorators() {\n      return this.form.addDecorators(this.productSettingRules);\n    },\n    productTypeList: function productTypeList() {\n      var _this = this;\n\n      return this.productType.filter(function (item) {\n        return !(_this.PRODUCT_TYPE.PERSONAL_COURSE === item.value && _this.brand.saleModel === 1);\n      });\n    },\n    tableList: {\n      get: function get() {\n        var _this2 = this;\n\n        var list = [];\n\n        if (this.formValue.product_type === PRODUCT_TYPE.MEMBER_CARD) {\n          list = this.tableMemberList;\n        }\n\n        if (this.formValue.product_type === PRODUCT_TYPE.DEPOSIT_CARD) {\n          list = this.tableDepositList;\n        }\n\n        if (this.formValue.product_type === PRODUCT_TYPE.PERSONAL_COURSE) {\n          list = this.tableCourseList;\n        }\n\n        return list.map(function (item) {\n          var id = item.id !== undefined ? item.id : item.product_sku_id;\n          return _objectSpread({}, item, {\n            product_sku_id: item.id || item.product_sku_id || 0,\n            discount_price: item.discount_price || null,\n            hour: _this2.formValue.limit_course_num\n          }, _this2.discountInfoMap[id] || {}, {\n            isSelected: !_this2.isEdit && _this2.allSelected || _this2.selectedRowKeys.includes(item.id) || _this2.selectedRowKeys.includes(item.product_sku_id)\n          });\n        });\n      },\n      set: function set(value) {\n        this.getDiscountInfo(value);\n      }\n    },\n    tableMemberList: function tableMemberList() {\n      var _this3 = this;\n\n      var itemArr = this.memberList.filter(function (item) {\n        return item.id === _this3.formValue.product_id;\n      });\n      return itemArr.length ? itemArr[0].product_spec : [];\n    },\n    tableDepositList: function tableDepositList() {\n      var _this4 = this;\n\n      var itemArr = this.depositList.filter(function (item) {\n        return item.id == _this4.formValue.product_id;\n      });\n      return itemArr.length ? itemArr[0].product_spec : [];\n    },\n    tableCourseList: function tableCourseList() {\n      if (this.brand.priceModel !== 2) {\n        // 私教课 priceModel = 1 统一定价模式\n        return [{\n          product_sku_id: 0,\n          discount_price: null\n        }];\n      }\n\n      return this.coachLevelList;\n    },\n    discountInfoMap: function discountInfoMap() {\n      return listToMap(this.formValue.discount_info, {\n        keyField: 'product_sku_id'\n      });\n    },\n    columns: function columns() {\n      if (this.formValue.product_type === PRODUCT_TYPE.PERSONAL_COURSE) {\n        return this.brand.priceModel === 2 ? personalCourseLevelColumns(this) : personalCourseColumns(this);\n      }\n\n      if (this.formValue.product_type === PRODUCT_TYPE.DEPOSIT_CARD) {\n        return depositCardColumns(this);\n      }\n\n      if (this.formValue.product_type === PRODUCT_TYPE.MEMBER_CARD) {\n        return memberCardColumns(this);\n      }\n\n      return [];\n    }\n  },\n  watch: {\n    'formValue.discount_info': {\n      deep: true,\n      immediate: true,\n      handler: function handler(value) {\n        var list = [];\n        value && value.map(function (item) {\n          list.push(item.product_sku_id);\n        }); // 去重\n\n        this.selectedRowKeys = _toConsumableArray(new Set([].concat(_toConsumableArray(this.selectedRowKeys), list)));\n      }\n    },\n    'formValue.product_id': {\n      deep: true,\n      immediate: true,\n      handler: function handler(newVal, oldVal) {\n        if (!newVal || newVal === oldVal) return; // 私教课 统一定价模式, 非教练谈单模式 选择的私教课发生变更，则更新对应的 教练等级列表\n\n        this.brand.priceModel === 2 && this.brand.saleModel !== 1 && this.service.getCoachLevelList(newVal).subscribe(); // 非编辑状态 如果商品选择发生改变则默认全部勾选\n\n        if (!this.isEdit) {\n          this.allSelected = true;\n        }\n      }\n    },\n    tableList: {\n      deep: true,\n      handler: function handler(newVal, oldVal) {\n        var _this5 = this;\n\n        if (!newVal || newVal === oldVal) return; // 非编辑状态 如果商品选择发生改变则默认全部勾选\n\n        if (!this.isEdit && this.allSelected) {\n          this.$nextTick(function () {\n            var list = [];\n\n            _this5.tableList.map(function (item) {\n              list.push(item.product_sku_id);\n            });\n\n            console.log(list, _this5.tableList);\n            _this5.selectedRowKeys = _toConsumableArray(new Set([].concat(_toConsumableArray(_this5.selectedRowKeys), list)));\n          });\n        }\n      }\n    }\n  },\n  mounted: function mounted() {\n    var _this6 = this;\n\n    console.log(this.decorators);\n\n    if (!this.isEdit) {\n      this.service.getMemberList().subscribe();\n      this.service.getDepositList().subscribe();\n      this.service.getPersonalList().subscribe();\n    } else {\n      var name = 'getMemberList';\n\n      switch (this.formValue.product_type) {\n        case PRODUCT_TYPE.MEMBER_CARD:\n          name = 'getMemberList';\n          break;\n\n        case PRODUCT_TYPE.DEPOSIT_CARD:\n          name = 'getDepositList';\n          break;\n\n        case PRODUCT_TYPE.PERSONAL_COURSE:\n          name = 'getPersonalList';\n          break;\n      }\n\n      console.log(222222);\n      this.service[name]().subscribe(function (res) {\n        _this6.checkProductIsExist(res.list);\n      });\n    }\n  },\n  methods: {\n    onTypeChange: function onTypeChange(val) {\n      this.setFieldsValue('product_id', undefined);\n      this.formValue.limit_course_num = 1;\n      this.formValue.discount_info = [];\n      this.selectedRowKeys = [];\n    },\n    // onMemberChange(val) {},\n    // onDepositChange(val) {},\n    // onPersonalChange(val) {},\n    onTableChange: function onTableChange(value) {\n      console.log(value);\n      this.allSelected = false;\n      this.selectedRowKeys = value;\n      this.getDiscountInfo(this.tableList);\n    },\n    // 修改列表对应 index 下的 price\n    onTablePriceChange: function onTablePriceChange(index, val) {\n      var list = this.tableList;\n      this.allSelected = false;\n      list.splice(index, 1, _objectSpread({}, this.tableList[index], {\n        discount_price: val\n      }));\n      this.tableList = list;\n    },\n    getDiscountInfo: function getDiscountInfo(value) {\n      var list = [];\n      value.map(function (item) {\n        if (item.isSelected) {\n          list.push({\n            product_sku_id: item.id || item.product_sku_id || 0,\n            discount_price: item.discount_price || null\n          });\n        }\n      });\n      this.formValue.discount_info = list;\n    },\n    checkProductIsExist: function checkProductIsExist(list) {\n      var _this7 = this;\n\n      var itemArr = list.filter(function (item) {\n        return item.id === _this7.formValue.product_id;\n      });\n\n      if (!itemArr.length) {\n        this.$confirm({\n          title: '提示',\n          content: '该商品不存在或已被删除'\n        });\n      }\n    },\n    validate: function validate() {\n      var _this8 = this;\n\n      var is_pass = true;\n\n      if (!this.formValue.discount_info.length) {\n        this.messageError({\n          content: '请设置优惠价格'\n        });\n        return false;\n      }\n\n      this.formValue.discount_info.map(function (item) {\n        if (is_pass && (item.discount_price === null || item.discount_price === undefined || item.discount_price === '')) {\n          _this8.messageError({\n            content: '请设置优惠价格'\n          });\n\n          is_pass = false;\n          return;\n        }\n      });\n      return is_pass;\n    }\n  }\n};",{"version":3,"sources":["product-setting.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div>\n    <st-form-item required label=\"请选择商品类型\">\n      <st-select\n        placeholder=\"请选择\"\n        style=\"width: 470px\"\n        v-decorator=\"decorators.product_type\"\n        @change=\"\n          formValueChange('product_type', $event, onTypeChange, formValue)\n        \"\n        :options=\"productTypeList\"\n        :disabled=\"isEdit\"\n      ></st-select>\n    </st-form-item>\n    <!-- 会员卡 -->\n    <template v-if=\"formValue.product_type === PRODUCT_TYPE.MEMBER_CARD\">\n      <st-form-item required :label=\"`请选择${$c('member_card')}`\">\n        <st-select-scroll\n          placeholder=\"请选择\"\n          style=\"width: 470px\"\n          _label=\"product_name\"\n          _value=\"id\"\n          filter=\"label\"\n          showArrow\n          :isScroll=\"false\"\n          :options=\"memberList\"\n          v-decorator=\"decorators.product_id\"\n          @change=\"formValueChange('product_id', $event, formValue)\"\n          :disabled=\"isEdit\"\n        ></st-select-scroll>\n      </st-form-item>\n    </template>\n    <!-- 储值卡 -->\n    <template v-if=\"formValue.product_type === PRODUCT_TYPE.DEPOSIT_CARD\">\n      <st-form-item required label=\"请选择储值卡\">\n        <st-select-scroll\n          placeholder=\"请选择\"\n          style=\"width: 470px\"\n          _label=\"product_name\"\n          _value=\"id\"\n          filter=\"label\"\n          showArrow\n          :isScroll=\"false\"\n          :options=\"depositList\"\n          v-decorator=\"decorators.product_id\"\n          @change=\"formValueChange('product_id', $event, formValue)\"\n          :disabled=\"isEdit\"\n        ></st-select-scroll>\n      </st-form-item>\n    </template>\n    <!-- 私教课 -->\n    <template v-if=\"formValue.product_type === PRODUCT_TYPE.PERSONAL_COURSE\">\n      <st-form-item required label=\"请选择私教课\">\n        <st-select-scroll\n          style=\"width: 470px\"\n          placeholder=\"请选择\"\n          _label=\"product_name\"\n          _value=\"id\"\n          filter=\"label\"\n          showArrow\n          :isScroll=\"false\"\n          :options=\"personalList\"\n          v-decorator=\"decorators.product_id\"\n          @change=\"formValueChange('product_id', $event, formValue)\"\n          :disabled=\"isEdit\"\n        ></st-select-scroll>\n      </st-form-item>\n    </template>\n    <!-- 必须用v-show， 否则集联关系报错 -->\n    <st-form-item\n      required\n      label=\"限定课时\"\n      v-show=\"formValue.product_type === PRODUCT_TYPE.PERSONAL_COURSE\"\n    >\n      <st-input-number\n        v-decorator=\"decorators.limit_course_num\"\n        @change=\"formValueChange('limit_course_num', $event, formValue)\"\n        placeholder=\"\"\n        style=\"width: 150px\"\n        :min=\"1\"\n        :max=\"9999\"\n      >\n        <span slot=\"addonAfter\">节</span>\n      </st-input-number>\n    </st-form-item>\n    <st-form-item required label=\"优惠设置\">\n      <a-card size=\"small\" style=\"width: 470px\">\n        <st-table\n          emptyText=\"暂无数据\"\n          :rowKey=\"record => record.id || record.product_sku_id\"\n          :columns=\"columns\"\n          :dataSource=\"tableList\"\n          :page=\"false\"\n          :rowSelection=\"{\n            onChange: onTableChange,\n            selectedRowKeys: selectedRowKeys\n          }\"\n        >\n          <span slot=\"discount_price\" slot-scope=\"text, record, index\">\n            <st-input-number\n              style=\"width: 130px\"\n              :min=\"0\"\n              :max=\"999999.9\"\n              :disabled=\"!record.isSelected\"\n              :value=\"text\"\n              float\n              @change=\"onTablePriceChange(index, $event)\"\n            >\n              <span slot=\"addonAfter\">元</span>\n            </st-input-number>\n          </span>\n        </st-table>\n      </a-card>\n    </st-form-item>\n  </div>\n</template>\n<script>\nimport { PRODUCT_TYPE } from '@/constants/brand/app/plugin/discount'\nimport { typeOf } from '@/utils/type'\nimport { listToMap } from '@/utils/list-to-map'\nimport { isEqual, merge } from 'lodash-es'\nimport FormMixin from './form.mixin'\n\nimport { MessageService } from '@/services/message.service'\nimport {\n  memberCardColumns,\n  depositCardColumns,\n  personalCourseLevelColumns,\n  personalCourseColumns,\n  productSettingRules\n} from './product-setting.config'\nimport { ProductSettingService } from './product-setting.service'\nexport default {\n  name: 'PluginProductSetting',\n  mixins: [FormMixin],\n  serviceInject() {\n    return {\n      service: ProductSettingService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.service.loading$,\n      productType: this.service.productType$,\n      memberList: this.service.memberList$,\n      depositList: this.service.depositList$,\n      personalList: this.service.personalList$,\n      coachLevelList: this.service.coachLevelList$,\n      brand: this.service.brand$\n    }\n  },\n  // decorators() {\n  //   return this.form.addDecorators(this.productSettingRules)\n  // },\n  props: {\n    discountPriceLabel: {\n      type: String,\n      default: '优惠价(元)'\n    },\n    form: {\n      type: Object,\n      default: () => {\n        return {}\n      }\n    }\n  },\n  data() {\n    return {\n      PRODUCT_TYPE,\n      selectedRowKeys: [],\n      allSelected: false\n    }\n  },\n  computed: {\n    productSettingRules,\n    decorators() {\n      return this.form.addDecorators(this.productSettingRules)\n    },\n    productTypeList() {\n      return this.productType.filter(\n        item =>\n          !(\n            this.PRODUCT_TYPE.PERSONAL_COURSE === item.value &&\n            this.brand.saleModel === 1\n          )\n      )\n    },\n    tableList: {\n      get() {\n        let list = []\n        if (this.formValue.product_type === PRODUCT_TYPE.MEMBER_CARD) {\n          list = this.tableMemberList\n        }\n        if (this.formValue.product_type === PRODUCT_TYPE.DEPOSIT_CARD) {\n          list = this.tableDepositList\n        }\n        if (this.formValue.product_type === PRODUCT_TYPE.PERSONAL_COURSE) {\n          list = this.tableCourseList\n        }\n        return list.map(item => {\n          const id = item.id !== undefined ? item.id : item.product_sku_id\n          return {\n            ...item,\n            product_sku_id: item.id || item.product_sku_id || 0,\n            discount_price: item.discount_price || null,\n            hour: this.formValue.limit_course_num,\n            ...(this.discountInfoMap[id] || {}),\n            isSelected:\n              (!this.isEdit && this.allSelected) ||\n              this.selectedRowKeys.includes(item.id) ||\n              this.selectedRowKeys.includes(item.product_sku_id)\n          }\n        })\n      },\n      set(value) {\n        this.getDiscountInfo(value)\n      }\n    },\n    tableMemberList() {\n      const itemArr = this.memberList.filter(item => {\n        return item.id === this.formValue.product_id\n      })\n      return itemArr.length ? itemArr[0].product_spec : []\n    },\n    tableDepositList() {\n      const itemArr = this.depositList.filter(item => {\n        return item.id == this.formValue.product_id\n      })\n      return itemArr.length ? itemArr[0].product_spec : []\n    },\n    tableCourseList() {\n      if (this.brand.priceModel !== 2) {\n        // 私教课 priceModel = 1 统一定价模式\n        return [\n          {\n            product_sku_id: 0,\n            discount_price: null\n          }\n        ]\n      }\n      return this.coachLevelList\n    },\n    discountInfoMap() {\n      return listToMap(this.formValue.discount_info, {\n        keyField: 'product_sku_id'\n      })\n    },\n    columns() {\n      if (this.formValue.product_type === PRODUCT_TYPE.PERSONAL_COURSE) {\n        return this.brand.priceModel === 2\n          ? personalCourseLevelColumns(this)\n          : personalCourseColumns(this)\n      }\n      if (this.formValue.product_type === PRODUCT_TYPE.DEPOSIT_CARD) {\n        return depositCardColumns(this)\n      }\n      if (this.formValue.product_type === PRODUCT_TYPE.MEMBER_CARD) {\n        return memberCardColumns(this)\n      }\n      return []\n    }\n  },\n  watch: {\n    'formValue.discount_info': {\n      deep: true,\n      immediate: true,\n      handler(value) {\n        let list = []\n        value &&\n          value.map(item => {\n            list.push(item.product_sku_id)\n          })\n        // 去重\n        this.selectedRowKeys = [...new Set([...this.selectedRowKeys, ...list])]\n      }\n    },\n    'formValue.product_id': {\n      deep: true,\n      immediate: true,\n      handler(newVal, oldVal) {\n        if (!newVal || newVal === oldVal) return\n        // 私教课 统一定价模式, 非教练谈单模式 选择的私教课发生变更，则更新对应的 教练等级列表\n        this.brand.priceModel === 2 &&\n          this.brand.saleModel !== 1 &&\n          this.service.getCoachLevelList(newVal).subscribe()\n        // 非编辑状态 如果商品选择发生改变则默认全部勾选\n        if (!this.isEdit) {\n          this.allSelected = true\n        }\n      }\n    },\n    tableList: {\n      deep: true,\n      handler(newVal, oldVal) {\n        if (!newVal || newVal === oldVal) return\n        // 非编辑状态 如果商品选择发生改变则默认全部勾选\n        if (!this.isEdit && this.allSelected) {\n          this.$nextTick(() => {\n            let list = []\n            this.tableList.map(item => {\n              list.push(item.product_sku_id)\n            })\n            console.log(list, this.tableList)\n            this.selectedRowKeys = [\n              ...new Set([...this.selectedRowKeys, ...list])\n            ]\n          })\n        }\n      }\n    }\n  },\n  mounted() {\n    console.log(this.decorators)\n    if (!this.isEdit) {\n      this.service.getMemberList().subscribe()\n      this.service.getDepositList().subscribe()\n      this.service.getPersonalList().subscribe()\n    } else {\n      let name = 'getMemberList'\n      switch (this.formValue.product_type) {\n        case PRODUCT_TYPE.MEMBER_CARD:\n          name = 'getMemberList'\n          break\n        case PRODUCT_TYPE.DEPOSIT_CARD:\n          name = 'getDepositList'\n          break\n        case PRODUCT_TYPE.PERSONAL_COURSE:\n          name = 'getPersonalList'\n          break\n      }\n      console.log(222222)\n      this.service[name]().subscribe(res => {\n        this.checkProductIsExist(res.list)\n      })\n    }\n  },\n  methods: {\n    onTypeChange(val) {\n      this.setFieldsValue('product_id', undefined)\n      this.formValue.limit_course_num = 1\n      this.formValue.discount_info = []\n      this.selectedRowKeys = []\n    },\n    // onMemberChange(val) {},\n    // onDepositChange(val) {},\n    // onPersonalChange(val) {},\n    onTableChange(value) {\n      console.log(value)\n      this.allSelected = false\n      this.selectedRowKeys = value\n      this.getDiscountInfo(this.tableList)\n    },\n    // 修改列表对应 index 下的 price\n    onTablePriceChange(index, val) {\n      let list = this.tableList\n      this.allSelected = false\n      list.splice(index, 1, {\n        ...this.tableList[index],\n        discount_price: val\n      })\n      this.tableList = list\n    },\n    getDiscountInfo(value) {\n      let list = []\n      value.map(item => {\n        if (item.isSelected) {\n          list.push({\n            product_sku_id: item.id || item.product_sku_id || 0,\n            discount_price: item.discount_price || null\n          })\n        }\n      })\n      this.formValue.discount_info = list\n    },\n    checkProductIsExist(list) {\n      const itemArr = list.filter(item => {\n        return item.id === this.formValue.product_id\n      })\n      if (!itemArr.length) {\n        this.$confirm({\n          title: '提示',\n          content: '该商品不存在或已被删除'\n        })\n      }\n    },\n    validate() {\n      let is_pass = true\n      if (!this.formValue.discount_info.length) {\n        this.messageError({ content: '请设置优惠价格' })\n        return false\n      }\n      this.formValue.discount_info.map(item => {\n        if (\n          is_pass &&\n          (item.discount_price === null ||\n            item.discount_price === undefined ||\n            item.discount_price === '')\n        ) {\n          this.messageError({ content: '请设置优惠价格' })\n          is_pass = false\n          return\n        }\n      })\n      return is_pass\n    }\n  }\n}\n</script>\n"],"sourceRoot":"src/views/pages/brand/app/plugin/components#"}]}