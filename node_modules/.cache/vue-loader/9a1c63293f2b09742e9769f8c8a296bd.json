{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/card/shop-member/shelf.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/card/shop-member/shelf.vue","mtime":1600926555845},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { ShelfService } from './shelf.service'\nimport { UserService } from '@/services/user.service'\nimport { cloneDeep } from 'lodash-es'\nimport { PatternService } from '@/services/pattern.service'\nimport ShopHourPicker from '@/views/components/hour-picker#/hour-picker'\nimport { ruleOptions, shopColumns, admissionTimeList } from './shelf.config'\nimport { SHOP_MEMBER } from '@/constants/card/shop-member'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalCardShopMemberShelf',\n  bem: {\n    shelves: 'modal-card-batch-shelves'\n  },\n  components: {\n    ShopHourPicker\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      userService: UserService,\n      messageService: MessageService,\n      shelfService: ShelfService\n    }\n  },\n  rxState() {\n    return {\n      course_interests: this.shelfService.course_interests$,\n      activateTypes: this.shelfService.activateTypes$,\n      shopName: this.userService.shop$,\n      courseData: this.shelfService.courseList$,\n      loading: this.shelfService.loading$,\n      info: this.shelfService.info$,\n      shelfCardDetail: this.shelfService.shelfCardDetail$\n    }\n  },\n  props: {\n    id: {\n      type: Number,\n      default: 0\n    },\n    actionType: {\n      type: String,\n      default: 'shelf'\n    },\n    title: {\n      type: String,\n      default: '标题'\n    }\n  },\n  computed: {\n    shopColumns,\n    admissionTimeList,\n    admissionTimeIsOk() {\n      return this.admissionTimeText === ''\n    },\n    courseInterestsIsOk() {\n      return this.courseInterestsStatus === 'success'\n    },\n    priceIsOk() {\n      return this.priceHelpText === ''\n    },\n    priceValidataArray() {\n      let array = []\n      this.priceList.forEach(i => {\n        array.push(i.priceInputValue)\n      })\n      return array\n    }\n  },\n  watch: {\n    priceList: {\n      deep: true,\n      handler() {\n        let b = this.priceValidataArray.every(i =>\n          this.pattern.NUM_FLOAT(1).test(i)\n        )\n        b && this.checkedPrice()\n      }\n    },\n    info: {\n      deep: true,\n      handler(newVal) {\n        newVal.specs.forEach(i => {\n          this.priceList.push({\n            ...i,\n            priceInputValue: ''\n          })\n        })\n      }\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      SHOP_MEMBER,\n      form,\n      decorators,\n      show: false,\n      // 卡tag类型\n      cardTypeTag: {\n        1: 'number-card',\n        2: 'period-card'\n      },\n      // 门店明细\n      visible: false,\n      // 范围价格列表\n      priceList: [],\n      priceHelpText: '',\n      // 回传给后台的价格\n      specs: [],\n      // 开卡方式\n      openTypeList: [],\n      // 约课权益\n      courseInterests: null,\n      // 输入是否正确\n      courseInterestsStatus: 'success',\n      courseInterestsHelpText: '',\n      // 课列表\n      courseList: [],\n      // 显示更多\n      moreIsShow: true,\n      admissionTime: 1,\n      timeList: [],\n      // 回传给后台的时间段\n      inoutTime: [],\n      admissionTimeText: '',\n      // 选择的vip区域\n      vipAreaList: []\n    }\n  },\n  created() {\n    const { actionType } = this\n    this.shelfService.getInfo(this.id).subscribe(() => {\n      if (actionType === 'updateShelf') {\n        this.initShelfData()\n      }\n    })\n  },\n  methods: {\n    getCourseList(search) {\n      let query = { course_name: search }\n      this.shelfService.courseListAction$.dispatch(query)\n    },\n    // 检验入场时间是否输入正确\n    checkedAdmission() {\n      this.admissionTimeText =\n        this.admissionTime === this.SHOP_MEMBER.ADMISSION_TIME_2 &&\n        this.moreIsShow &&\n        !this.timeList.length\n          ? '请选择入场时间'\n          : ''\n    },\n    brandPriceSettingHandleChange({ value, key }) {\n      this.priceList[key].priceInputValue = value\n    },\n    // 检验门店自主定价价格输入是否正确\n    checkedPrice() {\n      if (\n        !(\n          this.info.publish_channel === this.SHOP_MEMBER.PUBLISH_CHANNEL_1 &&\n          this.info.price_setting === this.SHOP_MEMBER.PRICE_SETTING_2\n        )\n      ) {\n        this.priceHelpText = ''\n        return false\n      }\n      let b = this.priceValidataArray.every(i =>\n        this.pattern.NUM_FLOAT(1).test(i)\n      )\n      this.priceHelpText = b ? '' : '请输入价格'\n    },\n    // 格式化价格\n    formatSpecs() {\n      this.specs = []\n      if (\n        this.info.publish_channel === this.SHOP_MEMBER.PUBLISH_CHANNEL_1 &&\n        this.info.price_setting === this.SHOP_MEMBER.PRICE_SETTING_2\n      ) {\n        // 有价格范围\n        this.priceList.forEach(i => {\n          this.specs.push({\n            specs_id: i.spec_id,\n            price: i.priceInputValue\n          })\n        })\n      } else {\n        // 无价格范围,发布渠道为2是门店，一定是无范围的\n        this.priceList.forEach(i => {\n          this.specs.push({\n            specs_id: i.spec_id,\n            price: i.rally_price\n          })\n        })\n      }\n    },\n    // 格式化入场时段\n    formatWeek() {\n      this.inoutTime = []\n      this.timeList.forEach(i => {\n        this.inoutTime.push({\n          week_day: +i.week_day,\n          time_duration: [{ start_time: i.start_time, end_time: i.end_time }]\n        })\n      })\n    },\n    // 去设置vip场地\n    goSet() {\n      this.show = false\n      this.$router.push({\n        path: '/shop/setting/court/list'\n      })\n    },\n    onSubmit() {\n      this.form.validate().then(values => {\n        this.checkedAdmission()\n        // TODO: shop hour picker后续修改，不能有默认值\n        this.formatWeek()\n        this.formatSpecs()\n        if (!this.inputCheck()) {\n          return\n        }\n\n        if (this.admissionTimeIsOk) {\n          if (this.openTypeList.toString() === '3') {\n            this.$confirm({\n              title: '确认上架?',\n              content:\n                '当前仅选择指定日期开卡，上架后小程序不显示该卡，确认上架？',\n              onOk: () => {\n                this.sendShelfCard(values)\n              }\n            })\n            return\n          }\n          this.sendShelfCard(values)\n        }\n      })\n    },\n    getParams(values) {\n      const params = {\n        areas: this.vipAreaList,\n        open_type: this.openTypeList,\n        activate_duration:\n          values.openDay === undefined ? undefined : +values.openDay,\n        course_interests: +this.courseInterests,\n        courses: values.courseList,\n        inout_type: this.admissionTime,\n        inout_time: this.inoutTime,\n        specs: this.specs\n      }\n      return params\n    },\n    inputCheck() {\n      if (!this.courseInterests) {\n        this.messageService.error({\n          content: '请选择约课权益'\n        })\n        return false\n      }\n      return true\n    },\n    sendShelfCard(values) {\n      const params = this.getParams(values)\n      this.shelfService.shelfCard(params, this.id).subscribe(() => {\n        this.show = false\n        this.$emit('success')\n      })\n    },\n    onUpdateShelf() {\n      this.form.validate().then(values => {\n        this.checkedAdmission()\n        this.formatWeek()\n        this.formatSpecs()\n        const params = this.getParams(values)\n        if (!this.inputCheck()) {\n          return\n        }\n        this.shelfService.updateShelf(this.id, params).subscribe(() => {\n          this.show = false\n          this.$emit('success')\n        })\n      })\n    },\n    /**\n     * 变更上架表单数据回显\n     */\n    initShelfData() {\n      const detail = this.shelfCardDetail\n      this.openTypeList = detail.activate_type\n      this.courseInterests = detail.course_interests\n      this.admissionTime = detail.inout_type\n      this.timeList = this.timeFilter(detail.inout_time)\n      this.vipAreaList = detail.areas\n      this.$nextTick(() => {\n        this.form.setFieldsValue({\n          openDay: detail.automatic_num,\n          courseList: detail.courses\n        })\n      })\n      this.getCourseList()\n    },\n    timeFilter(timeList) {\n      return timeList.map(item => {\n        const { week_day } = item\n        const { start_time, end_time } = item.time_duration[0]\n        return {\n          week_day,\n          start_time,\n          end_time\n        }\n      })\n    }\n  }\n}\n",{"version":3,"sources":["shelf.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqZA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"shelf.vue","sourceRoot":"src/views/biz-modals/card/shop-member","sourcesContent":["<template>\n  <st-modal\n    :title=\"title\"\n    v-model=\"show\"\n    wrapClassName=\"modal-card-batch-shelves\"\n  >\n    <section :class=\"shelves('content')\">\n      <div :class=\"shelves('info')\" class=\"mg-b24\">\n        <img\n          :class=\"shelves('card_bg')\"\n          v-if=\"info.bg_image\"\n          :src=\"info.bg_image | imgFilter({ w: 142, h: 80 })\"\n          width=\"142\"\n          height=\"80\"\n          alt=\"卡背景\"\n        />\n        <div :class=\"shelves('detail')\">\n          <p :class=\"shelves('detail-title')\" v-if=\"info.card_type\">\n            <st-tag\n              :type=\"cardTypeTag[info.card_type]\"\n              style=\"margin-right:8px;\"\n            />\n            {{ info.card_name }}\n          </p>\n          <p v-if=\"actionType === 'shelf'\" :class=\"shelves('detail-cards')\">\n            上架场馆：{{ shopName.name }}\n          </p>\n          <p :class=\"shelves('detail-saletype')\" v-if=\"info.sell_type\">\n            <span v-for=\"(item, index) in info.sell_type\" :key=\"index\">\n              {{ item | enumFilter('member_card.sell_type') }}\n            </span>\n          </p>\n        </div>\n      </div>\n      <st-form :form=\"form\" labelWidth=\"67px\" :class=\"shelves('form')\">\n        <!-- 次卡，无价格范围 -->\n        <div\n          :class=\"shelves('price')\"\n          v-if=\"\n            (info.publish_channel === SHOP_MEMBER.PUBLISH_CHANNEL_2 &&\n              info.card_type === SHOP_MEMBER.CARD_TYPE_1) ||\n              (info.price_setting === SHOP_MEMBER.PRICE_SETTING_1 &&\n                info.card_type === SHOP_MEMBER.CARD_TYPE_1)\n          \"\n          class=\"mg-b0\"\n        >\n          <st-form-table>\n            <colgroup>\n              <col style=\"width:4%;\" />\n              <col style=\"width:16%;\" />\n              <col style=\"width:22%;\" />\n              <col style=\"width:22%;\" />\n              <col style=\"width:18%;\" />\n              <col style=\"width:18%;\" />\n            </colgroup>\n            <tr>\n              <th></th>\n              <th>次数</th>\n              <th>售卖价格</th>\n              <th>有效期限</th>\n              <th>允许冻结</th>\n              <th>赠送上限</th>\n            </tr>\n            <tbody>\n              <tr v-for=\"(item, index) in info.specs\" :key=\"index\">\n                <td></td>\n                <td>{{ item.validity_times }}次</td>\n                <td>{{ item.rally_price }}元</td>\n                <td>\n                  {{ item.duration_num }}\n                  {{\n                    item.duration_unit | enumFilter('member_card.duration_unit')\n                  }}\n                </td>\n                <td>{{ item.frozen_day }}天</td>\n                <td>{{ item.gift_unit }}次</td>\n              </tr>\n            </tbody>\n          </st-form-table>\n        </div>\n        <!-- 期卡，无价格范围 -->\n        <div\n          :class=\"shelves('price')\"\n          v-if=\"\n            (info.publish_channel === SHOP_MEMBER.PUBLISH_CHANNEL_2 &&\n              info.card_type === SHOP_MEMBER.CARD_TYPE_2) ||\n              (info.price_setting === SHOP_MEMBER.PRICE_SETTING_1 &&\n                info.card_type === SHOP_MEMBER.CARD_TYPE_2)\n          \"\n          class=\"mg-b0\"\n        >\n          <st-form-table>\n            <colgroup>\n              <col style=\"width:4%;\" />\n              <col style=\"width:26%;\" />\n              <col style=\"width:26%;\" />\n              <col style=\"width:22%;\" />\n              <col style=\"width:22%;\" />\n            </colgroup>\n            <tr>\n              <th></th>\n              <th>有效期限</th>\n              <th>售卖价格</th>\n              <th>允许冻结</th>\n              <th>赠送上限</th>\n            </tr>\n            <tbody>\n              <tr v-for=\"(item, index) in info.specs\" :key=\"index\">\n                <td></td>\n                <td>\n                  {{ item.duration_num\n                  }}{{\n                    item.duration_unit | enumFilter('member_card.duration_unit')\n                  }}\n                </td>\n                <td>{{ item.rally_price }}元</td>\n                <td>{{ item.frozen_day }}天</td>\n                <td>{{ item.gift_unit }}天</td>\n              </tr>\n            </tbody>\n          </st-form-table>\n        </div>\n        <!-- 次卡，有价格范围 -->\n        <div\n          :class=\"{\n            'modal-card-batch-shelves__price-error': priceHelpText !== ''\n          }\"\n          v-if=\"\n            info.publish_channel === SHOP_MEMBER.PUBLISH_CHANNEL_1 &&\n              info.price_setting === SHOP_MEMBER.PRICE_SETTING_2 &&\n              info.card_type === SHOP_MEMBER.CARD_TYPE_1\n          \"\n          class=\"modal-card-batch-shelves__price mg-b0\"\n        >\n          <st-form-table>\n            <colgroup>\n              <col style=\"width:2%;\" />\n              <col style=\"width:10%;\" />\n              <col style=\"width:20%;\" />\n              <col style=\"width:17%;\" />\n              <col style=\"width:17%;\" />\n              <col style=\"width:17%;\" />\n              <col style=\"width:17%;\" />\n            </colgroup>\n            <tr>\n              <th></th>\n              <th>次数</th>\n              <th>售卖价格</th>\n              <th></th>\n              <th>有效期限</th>\n              <th>允许冻结</th>\n              <th>赠送上限</th>\n            </tr>\n            <tbody>\n              <tr v-for=\"(item, index) in priceList\" :key=\"index\">\n                <td></td>\n                <td>{{ item.validity_times }}次</td>\n                <td :class=\"shelves('price-input')\">\n                  <st-input-number\n                    :float=\"true\"\n                    :value=\"item.select_price || undefined\"\n                    :max=\"+item.max_price || undefined\"\n                    :min=\"+item.min_price || undefined\"\n                    @change=\"\n                      e =>\n                        brandPriceSettingHandleChange({ value: e, key: index })\n                    \"\n                    style=\"width:140px;\"\n                  >\n                    <span slot=\"addonAfter\">元</span>\n                  </st-input-number>\n                </td>\n                <td>\n                  &nbsp;&nbsp;{{ item.min_price }}&nbsp;~&nbsp;{{\n                    item.max_price\n                  }}&nbsp;&nbsp;\n                </td>\n                <td>\n                  {{ item.duration_num\n                  }}{{\n                    item.duration_unit | enumFilter('member_card.duration_unit')\n                  }}\n                </td>\n                <td>{{ item.frozen_day }}天</td>\n                <td>{{ item.gift_unit }}次</td>\n              </tr>\n            </tbody>\n          </st-form-table>\n        </div>\n        <!-- 期卡，有价格范围 -->\n        <div\n          :class=\"{\n            'modal-card-batch-shelves__price-error': priceHelpText !== ''\n          }\"\n          v-if=\"\n            info.publish_channel === SHOP_MEMBER.PUBLISH_CHANNEL_1 &&\n              info.price_setting === SHOP_MEMBER.PRICE_SETTING_2 &&\n              info.card_type === SHOP_MEMBER.CARD_TYPE_2\n          \"\n          class=\"modal-card-batch-shelves__price mg-b0\"\n        >\n          <st-form-table>\n            <colgroup>\n              <col style=\"width:2%;\" />\n              <col style=\"width:19%;\" />\n              <col style=\"width:22%;\" />\n              <col style=\"width:19%;\" />\n              <col style=\"width:19%;\" />\n              <col style=\"width:19%;\" />\n            </colgroup>\n            <tr>\n              <th></th>\n              <th>有效期限</th>\n              <th>售卖价格</th>\n              <th></th>\n              <th>允许冻结</th>\n              <th>赠送上限</th>\n            </tr>\n            <tbody>\n              <tr v-for=\"(item, index) in priceList\" :key=\"index\">\n                <td></td>\n                <td>\n                  {{ item.duration_num\n                  }}{{\n                    item.duration_unit | enumFilter('member_card.duration_unit')\n                  }}\n                </td>\n                <td :class=\"shelves('price-input')\">\n                  <st-input-number\n                    :float=\"true\"\n                    :value=\"item.select_price || undefined\"\n                    :max=\"+item.max_price || undefined\"\n                    :min=\"+item.min_price || undefined\"\n                    @change=\"\n                      e =>\n                        brandPriceSettingHandleChange({ value: e, key: index })\n                    \"\n                    style=\"width:140px;\"\n                  >\n                    <span slot=\"addonAfter\">元</span>\n                  </st-input-number>\n                </td>\n                <td>\n                  &nbsp;&nbsp;{{ item.min_price }}&nbsp;~&nbsp;{{\n                    item.max_price\n                  }}&nbsp;&nbsp;\n                </td>\n                <td>{{ item.frozen_day }}天</td>\n                <td>{{ item.gift_unit }}天</td>\n              </tr>\n            </tbody>\n          </st-form-table>\n        </div>\n        <p :class=\"shelves('price-valid-text')\">{{ priceHelpText }}</p>\n        <st-form-item\n          labelGutter=\"12px\"\n          class=\"mg-b0\"\n          label=\"开卡方式\"\n          required\n        >\n          <a-checkbox-group\n            v-model=\"openTypeList\"\n            :class=\"shelves('open-type')\"\n          >\n            <template\n              v-for=\"(item, index) in activateTypes\"\n              :value=\"+item.value\"\n            >\n              <span\n                :class=\"shelves('day-input')\"\n                v-if=\"+item.value === 2\"\n                :key=\"index\"\n              >\n                <a-checkbox :value=\"+item.value\">{{ item.label }}</a-checkbox>\n                <div class=\"autoplay-card-day\" v-if=\"openTypeList.includes(2)\">\n                  <a-form-item class=\"page-a-form\">\n                    <st-input-number\n                      v-decorator=\"decorators.openDay\"\n                      class=\"autoplay-card-day-input\"\n                    >\n                      <span slot=\"addonAfter\">天</span>\n                    </st-input-number>\n                    <span>内未开卡，则自动开卡</span>\n                  </a-form-item>\n                </div>\n              </span>\n              <a-checkbox v-else :key=\"index\" :value=\"+item.value\">\n                {{ item.label }}\n              </a-checkbox>\n            </template>\n          </a-checkbox-group>\n        </st-form-item>\n        <st-form-item labelGutter=\"12px\" label=\"约课权益\" required>\n          <a-radio-group v-model=\"courseInterests\" :class=\"shelves('course')\">\n            <a-radio\n              v-for=\"(item, index) in course_interests\"\n              :value=\"+item.value\"\n              :key=\"index\"\n            >\n              {{ item.label }}\n            </a-radio>\n          </a-radio-group>\n          <a-select\n            v-if=\"courseInterests === 3\"\n            mode=\"multiple\"\n            style=\"width: 419px;\"\n            v-decorator=\"decorators.courseList\"\n            placeholder=\"请输入课程名称搜索\"\n            :filterOption=\"false\"\n            @search=\"getCourseList\"\n            :notFoundContent=\"loading.getCourseList ? undefined : null\"\n          >\n            <a-spin\n              v-if=\"loading.getCourseList\"\n              slot=\"notFoundContent\"\n              size=\"small\"\n            />\n            <a-select-option v-for=\"d in courseData\" :key=\"d.id\">\n              {{ d.name }}\n            </a-select-option>\n          </a-select>\n        </st-form-item>\n        <div v-if=\"!moreIsShow\" :class=\"shelves('show-more')\" class=\"mg-b18\">\n          <span @click=\"moreIsShow = true\">展开更多设置</span>\n          <st-icon @click=\"moreIsShow = true\" type=\"down-small\" />\n        </div>\n        <st-form-item\n          v-if=\"moreIsShow\"\n          labelGutter=\"12px\"\n          label=\"入场时段\"\n          class=\"mg-b16\"\n          required\n        >\n          <a-radio-group v-model=\"admissionTime\">\n            <a-radio\n              v-for=\"(item, index) in admissionTimeList\"\n              :value=\"+item.value\"\n              :key=\"index\"\n            >\n              {{ item.label }}\n            </a-radio>\n          </a-radio-group>\n        </st-form-item>\n        <shop-hour-picker\n          v-model=\"timeList\"\n          v-if=\"admissionTime === SHOP_MEMBER.ADMISSION_TIME_2 && moreIsShow\"\n        ></shop-hour-picker>\n        <p\n          :class=\"shelves('admission-time-validata')\"\n          v-if=\"admissionTime === SHOP_MEMBER.ADMISSION_TIME_2 && moreIsShow\"\n        >\n          {{ admissionTimeText }}\n        </p>\n        <st-form-item\n          v-if=\"moreIsShow\"\n          labelGutter=\"12px\"\n          class=\"mg-t18 mg-b8\"\n          labelWidth=\"78px\"\n          label=\"VIP场地通行\"\n        >\n          <span v-if=\"info.areas && !info.areas.length\">\n            没有VIP场地?\n            <a @click=\"goSet\">去设置</a>\n          </span>\n          <a-checkbox-group v-else v-model=\"vipAreaList\">\n            <a-checkbox\n              v-for=\"(item, index) in info.areas\"\n              :key=\"index\"\n              :value=\"item.id\"\n            >\n              {{ item.area_name }}\n            </a-checkbox>\n          </a-checkbox-group>\n        </st-form-item>\n        <div :class=\"shelves('hide-more')\" v-if=\"moreIsShow\">\n          <span @click=\"moreIsShow = false\">收起</span>\n        </div>\n      </st-form>\n    </section>\n    <template slot=\"footer\">\n      <div :class=\"shelves('footer')\">\n        <st-button @click=\"show = false\">取消</st-button>\n        <!-- 上架 -->\n        <st-button\n          v-if=\"actionType === 'shelf'\"\n          @click=\"onSubmit\"\n          :loading=\"loading.shelfCard\"\n          type=\"primary\"\n        >\n          确认上架\n        </st-button>\n        <!-- 变更上架 -->\n        <st-button\n          v-if=\"actionType === 'updateShelf'\"\n          @click=\"onUpdateShelf\"\n          :loading=\"loading.updateShelf\"\n          type=\"primary\"\n        >\n          确认变更\n        </st-button>\n      </div>\n    </template>\n  </st-modal>\n</template>\n<script>\nimport { ShelfService } from './shelf.service'\nimport { UserService } from '@/services/user.service'\nimport { cloneDeep } from 'lodash-es'\nimport { PatternService } from '@/services/pattern.service'\nimport ShopHourPicker from '@/views/components/hour-picker#/hour-picker'\nimport { ruleOptions, shopColumns, admissionTimeList } from './shelf.config'\nimport { SHOP_MEMBER } from '@/constants/card/shop-member'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalCardShopMemberShelf',\n  bem: {\n    shelves: 'modal-card-batch-shelves'\n  },\n  components: {\n    ShopHourPicker\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      userService: UserService,\n      messageService: MessageService,\n      shelfService: ShelfService\n    }\n  },\n  rxState() {\n    return {\n      course_interests: this.shelfService.course_interests$,\n      activateTypes: this.shelfService.activateTypes$,\n      shopName: this.userService.shop$,\n      courseData: this.shelfService.courseList$,\n      loading: this.shelfService.loading$,\n      info: this.shelfService.info$,\n      shelfCardDetail: this.shelfService.shelfCardDetail$\n    }\n  },\n  props: {\n    id: {\n      type: Number,\n      default: 0\n    },\n    actionType: {\n      type: String,\n      default: 'shelf'\n    },\n    title: {\n      type: String,\n      default: '标题'\n    }\n  },\n  computed: {\n    shopColumns,\n    admissionTimeList,\n    admissionTimeIsOk() {\n      return this.admissionTimeText === ''\n    },\n    courseInterestsIsOk() {\n      return this.courseInterestsStatus === 'success'\n    },\n    priceIsOk() {\n      return this.priceHelpText === ''\n    },\n    priceValidataArray() {\n      let array = []\n      this.priceList.forEach(i => {\n        array.push(i.priceInputValue)\n      })\n      return array\n    }\n  },\n  watch: {\n    priceList: {\n      deep: true,\n      handler() {\n        let b = this.priceValidataArray.every(i =>\n          this.pattern.NUM_FLOAT(1).test(i)\n        )\n        b && this.checkedPrice()\n      }\n    },\n    info: {\n      deep: true,\n      handler(newVal) {\n        newVal.specs.forEach(i => {\n          this.priceList.push({\n            ...i,\n            priceInputValue: ''\n          })\n        })\n      }\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      SHOP_MEMBER,\n      form,\n      decorators,\n      show: false,\n      // 卡tag类型\n      cardTypeTag: {\n        1: 'number-card',\n        2: 'period-card'\n      },\n      // 门店明细\n      visible: false,\n      // 范围价格列表\n      priceList: [],\n      priceHelpText: '',\n      // 回传给后台的价格\n      specs: [],\n      // 开卡方式\n      openTypeList: [],\n      // 约课权益\n      courseInterests: null,\n      // 输入是否正确\n      courseInterestsStatus: 'success',\n      courseInterestsHelpText: '',\n      // 课列表\n      courseList: [],\n      // 显示更多\n      moreIsShow: true,\n      admissionTime: 1,\n      timeList: [],\n      // 回传给后台的时间段\n      inoutTime: [],\n      admissionTimeText: '',\n      // 选择的vip区域\n      vipAreaList: []\n    }\n  },\n  created() {\n    const { actionType } = this\n    this.shelfService.getInfo(this.id).subscribe(() => {\n      if (actionType === 'updateShelf') {\n        this.initShelfData()\n      }\n    })\n  },\n  methods: {\n    getCourseList(search) {\n      let query = { course_name: search }\n      this.shelfService.courseListAction$.dispatch(query)\n    },\n    // 检验入场时间是否输入正确\n    checkedAdmission() {\n      this.admissionTimeText =\n        this.admissionTime === this.SHOP_MEMBER.ADMISSION_TIME_2 &&\n        this.moreIsShow &&\n        !this.timeList.length\n          ? '请选择入场时间'\n          : ''\n    },\n    brandPriceSettingHandleChange({ value, key }) {\n      this.priceList[key].priceInputValue = value\n    },\n    // 检验门店自主定价价格输入是否正确\n    checkedPrice() {\n      if (\n        !(\n          this.info.publish_channel === this.SHOP_MEMBER.PUBLISH_CHANNEL_1 &&\n          this.info.price_setting === this.SHOP_MEMBER.PRICE_SETTING_2\n        )\n      ) {\n        this.priceHelpText = ''\n        return false\n      }\n      let b = this.priceValidataArray.every(i =>\n        this.pattern.NUM_FLOAT(1).test(i)\n      )\n      this.priceHelpText = b ? '' : '请输入价格'\n    },\n    // 格式化价格\n    formatSpecs() {\n      this.specs = []\n      if (\n        this.info.publish_channel === this.SHOP_MEMBER.PUBLISH_CHANNEL_1 &&\n        this.info.price_setting === this.SHOP_MEMBER.PRICE_SETTING_2\n      ) {\n        // 有价格范围\n        this.priceList.forEach(i => {\n          this.specs.push({\n            specs_id: i.spec_id,\n            price: i.priceInputValue\n          })\n        })\n      } else {\n        // 无价格范围,发布渠道为2是门店，一定是无范围的\n        this.priceList.forEach(i => {\n          this.specs.push({\n            specs_id: i.spec_id,\n            price: i.rally_price\n          })\n        })\n      }\n    },\n    // 格式化入场时段\n    formatWeek() {\n      this.inoutTime = []\n      this.timeList.forEach(i => {\n        this.inoutTime.push({\n          week_day: +i.week_day,\n          time_duration: [{ start_time: i.start_time, end_time: i.end_time }]\n        })\n      })\n    },\n    // 去设置vip场地\n    goSet() {\n      this.show = false\n      this.$router.push({\n        path: '/shop/setting/court/list'\n      })\n    },\n    onSubmit() {\n      this.form.validate().then(values => {\n        this.checkedAdmission()\n        // TODO: shop hour picker后续修改，不能有默认值\n        this.formatWeek()\n        this.formatSpecs()\n        if (!this.inputCheck()) {\n          return\n        }\n\n        if (this.admissionTimeIsOk) {\n          if (this.openTypeList.toString() === '3') {\n            this.$confirm({\n              title: '确认上架?',\n              content:\n                '当前仅选择指定日期开卡，上架后小程序不显示该卡，确认上架？',\n              onOk: () => {\n                this.sendShelfCard(values)\n              }\n            })\n            return\n          }\n          this.sendShelfCard(values)\n        }\n      })\n    },\n    getParams(values) {\n      const params = {\n        areas: this.vipAreaList,\n        open_type: this.openTypeList,\n        activate_duration:\n          values.openDay === undefined ? undefined : +values.openDay,\n        course_interests: +this.courseInterests,\n        courses: values.courseList,\n        inout_type: this.admissionTime,\n        inout_time: this.inoutTime,\n        specs: this.specs\n      }\n      return params\n    },\n    inputCheck() {\n      if (!this.courseInterests) {\n        this.messageService.error({\n          content: '请选择约课权益'\n        })\n        return false\n      }\n      return true\n    },\n    sendShelfCard(values) {\n      const params = this.getParams(values)\n      this.shelfService.shelfCard(params, this.id).subscribe(() => {\n        this.show = false\n        this.$emit('success')\n      })\n    },\n    onUpdateShelf() {\n      this.form.validate().then(values => {\n        this.checkedAdmission()\n        this.formatWeek()\n        this.formatSpecs()\n        const params = this.getParams(values)\n        if (!this.inputCheck()) {\n          return\n        }\n        this.shelfService.updateShelf(this.id, params).subscribe(() => {\n          this.show = false\n          this.$emit('success')\n        })\n      })\n    },\n    /**\n     * 变更上架表单数据回显\n     */\n    initShelfData() {\n      const detail = this.shelfCardDetail\n      this.openTypeList = detail.activate_type\n      this.courseInterests = detail.course_interests\n      this.admissionTime = detail.inout_type\n      this.timeList = this.timeFilter(detail.inout_time)\n      this.vipAreaList = detail.areas\n      this.$nextTick(() => {\n        this.form.setFieldsValue({\n          openDay: detail.automatic_num,\n          courseList: detail.courses\n        })\n      })\n      this.getCourseList()\n    },\n    timeFilter(timeList) {\n      return timeList.map(item => {\n        const { week_day } = item\n        const { start_time, end_time } = item.time_duration[0]\n        return {\n          week_day,\n          start_time,\n          end_time\n        }\n      })\n    }\n  }\n}\n</script>\n"]}]}