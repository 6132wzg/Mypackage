{"code":"(window[\"webpackJsonp\"]=window[\"webpackJsonp\"]||[]).push([[\"tier-4~brand-staff~shop-member~shop-reception~shop-staff\"],{\"188d\":function(e,t,i){\"use strict\";var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i(\"div\",{directives:[{name:\"viewer\",rawName:\"v-viewer\",value:{url:\"data-src\",toolbar:!1},expression:\"{ url: 'data-src', toolbar: false }\"}],staticClass:\"st-face-upload\"},[e._l(e.fileList,(function(t,a){return i(\"div\",{key:a,staticClass:\"st-face-upload__item st-preview-item\"},[i(\"img\",{staticClass:\"st-face-upload__item-img\",style:e.sizeStyle,attrs:{src:t[e.imageUrl]||t[e.imageKey],\"data-src\":t[e.imageUrl]||t[e.imageKey]}}),e._t(\"item-extra\",null,{item:t,index:a})],2)})),i(\"div\",{directives:[{name:\"show\",rawName:\"v-show\",value:e.isShowFaceUpload&&e.faceEditAuth,expression:\"isShowFaceUpload && faceEditAuth\"}],staticClass:\"st-face-upload__face\",on:{click:e.handlerOpenFaceModal}},[i(\"div\",{staticClass:\"container\"},[i(\"a-spin\",{attrs:{spinning:e.isLoading,tip:e.progress+\"%\"}},[i(\"a-icon\",{style:{fontSize:\"36px\",color:\"#9BACB9\"},attrs:{type:\"plus-circle\",theme:\"filled\"}}),i(\"div\",{staticClass:\"placeholder\"},[e._v(e._s(e.placeholder))])],1)],1)]),e.$slots.actionContent||e.fileList.length&&e.actionAuth?i(\"div\",{staticClass:\"st-face-upload__actions\"},[e._t(\"actionContent\"),e._t(\"actions\",[e.fileList.length&&e.actionAuth?i(\"span\",{staticClass:\"action\",on:{click:function(t){return t.stopPropagation(),e.onDel(t)}}},[e._v(\"\\n        删除\\n      \")]):e._e()])],2):e._e()],2)},s=[],n=(i(\"c5f6\"),i(\"da41\")),r=i(\"74d8\"),o=i(\"e69b\"),c=i(\"5783\"),l={w:\"182px\",h:\"114px\"},h={name:\"StFaceUpload\",serviceInject:function(){return{oss:n[\"a\"],appConfig:r[\"a\"],messageService:o[\"a\"]}},modals:{FaceRecognition:c[\"a\"]},props:{numLimit:{type:Number,default:1},placeholder:{type:String,default:\"上传照片\"},width:{type:String,default:l.w},height:{type:String,default:l.h},list:{type:Array,default:function(){return[]}},filterOptions:{type:Object,default:function(){return{}}},props:{type:Object,default:function(){return{image_id:\"image_id\",image_key:\"image_key\",image_url:\"image_url\"}}},faceEditAuth:{type:Boolean,default:!0},actionAuth:{type:Boolean,default:!0}},data:function(){return{fileList:this.list,isLoading:!1,progress:0,isShowFaceUpload:!0}},computed:{imageId:function(){return this.props.image_id},imageKey:function(){return this.props.image_key},imageUrl:function(){return this.props.image_url},sizeStyle:function(){return\"width: \".concat(this.width,\";  height: \").concat(this.height)},computedFilterOptions:function(){var e=2*parseInt(this.width),t=2*parseInt(this.height);return Object.assign({w:e,h:t},this.filterOptions)}},watch:{list:{handler:function(e){this.isShowFaceUpload=this.list.length<this.numLimit,this.fileList=this.list},immediate:!0}},methods:{handlerOpenFaceModal:function(){this.$modalRouter.push({name:\"face-recognition\",props:{fileList:this.fileList},on:{change:this.onChange,processChange:this.processChange,loadingChange:this.loadingChange}})},onDel:function(){var e=this.fileList,t=e.splice(0,1);this.fileList=e,this.$emit(\"delete\",t[0]),this.$emit(\"change\",this.fileList)},onChange:function(e){this.fileList=e,this.isShowFaceUpload=this.fileList.length<this.numLimit,this.$emit(\"change\",this.fileList)},processChange:function(e){this.progress=e},loadingChange:function(e){this.isLoading=e}}},d=h,u=i(\"2877\"),g=Object(u[\"a\"])(d,a,s,!1,null,null,null);t[\"a\"]=g.exports},\"1ea6\":function(e,t,i){e.exports=i.p+\"img/userLinePic.d9025132.png\"},5783:function(e,t,i){\"use strict\";var a,s,n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a(\"st-modal\",{attrs:{title:e.title,\"ok-text\":e.okText,okButtonProps:{props:{disabled:!e.userImgSrc}},bodyStyle:{padding:0},confirmLoading:e.loading.getMemberCheckResult,width:\"484px\"},on:{ok:e.uploadUserImageAndQualityTest,cancel:e.onCancel},model:{value:e.show,callback:function(t){e.show=t},expression:\"show\"}},[a(\"a-alert\",{attrs:{slot:\"prepend\",message:\"为保证人脸录入质量，请确保光线充足，以免影响识别精度。\",type:\"warning\",banner:\"\"},slot:\"prepend\"}),a(\"div\",{class:e.recognition()},[a(\"div\",{class:e.recognition(\"header\")},[a(\"div\",{class:e.recognition(\"space\")},[a(\"a-spin\",{class:e.recognition(\"loading\"),attrs:{spinning:e.isLoading}},[a(\"div\",{class:e.recognition(\"img\")},[a(\"div\",{directives:[{name:\"show\",rawName:\"v-show\",value:e.userImgSrc,expression:\"userImgSrc\"}],staticClass:\"user-img-src\",style:{backgroundImage:\"url(\"+e.userImgSrc+\")\"}}),a(\"video\",{directives:[{name:\"show\",rawName:\"v-show\",value:!e.userImgSrc,expression:\"!userImgSrc\"}],ref:\"video\",attrs:{width:\"270\",height:\"270\",autoplay:\"\"}}),a(\"canvas\",{ref:\"canvas\",class:e.recognition(\"canvas\"),attrs:{width:\"270\",height:\"270\"}}),a(\"img\",{directives:[{name:\"show\",rawName:\"v-show\",value:e.openCameraError&&!e.userImgSrc,expression:\"openCameraError && !userImgSrc\"}],class:e.recognition(\"userLinePic\"),attrs:{src:i(\"8d4e\"),alt:\"\"}}),a(\"img\",{directives:[{name:\"show\",rawName:\"v-show\",value:!e.openCameraError&&!e.userImgSrc,expression:\"!openCameraError && !userImgSrc\"}],class:e.recognition(\"userLinePic\"),attrs:{src:i(\"1ea6\"),alt:\"\"}})])]),a(\"div\",{class:e.recognition(\"operation\")},[a(\"st-button\",{staticClass:\"mg-b8\",attrs:{type:\"primary\",disabled:e.openCameraError},on:{click:e.handlerTakePhoto}},[e._v(\"\\n            \"+e._s(e.userImgSrc?\"重拍\":\"拍照\")+\"\\n          \")]),a(\"a-upload\",{attrs:{name:\"file\",showUploadList:!1,customRequest:e.uploadUserImageFormPhoto}},[a(\"st-button\",[e._v(\"\\n              \"+e._s(e.userImgSrc?\"重新上传\":\"上传照片\")+\"\\n            \")])],1)],1)],1)])])],1)},r=[],o=(i(\"34ef\"),i(\"28a5\"),i(\"ac6a\"),i(\"bd86\")),c=i(\"da41\"),l=i(\"74d8\"),h=i(\"e69b\"),d=i(\"d225\"),u=i(\"b0b4\"),g=i(\"9ab4\"),p=i(\"0cd5\"),m=i(\"df29\"),f=i(\"3231\"),v=function(){function e(t){Object(d[\"a\"])(this,e),this.MemberApi=t,this.loading$=new m[\"d\"]({})}return Object(u[\"a\"])(e,[{key:\"getMemberCheckResult\",value:function(e){return this.MemberApi.getMemberCheckResult(e)}}]),e}();Object(g[\"b\"])([Object(m[\"c\"])(),Object(g[\"d\"])(\"design:type\",Function),Object(g[\"d\"])(\"design:paramtypes\",[\"function\"===typeof(a=\"undefined\"!==typeof f[\"FaceCheckQuery\"]&&f[\"FaceCheckQuery\"])?a:Object]),Object(g[\"d\"])(\"design:returntype\",void 0)],v.prototype,\"getMemberCheckResult\",null),v=Object(g[\"b\"])([Object(p[\"b\"])(),Object(g[\"d\"])(\"design:paramtypes\",[\"function\"===typeof(s=\"undefined\"!==typeof f[\"e\"]&&f[\"e\"])?s:Object])],v);var b=i(\"ec41\"),C={bem:{recognition:\"st-face-recognition\"},serviceInject:function(){return{oss:c[\"a\"],appConfig:l[\"a\"],messageService:h[\"a\"],recognitionService:v}},rxState:function(){return{loading:this.recognitionService.loading$}},props:{fileList:{type:Array,default:function(){return[]}},props:{type:Object,default:function(){return{image_id:\"image_id\",image_key:\"image_key\",image_url:\"image_url\"}}}},data:function(){return{title:\"人脸信息录入\",okText:\"确认上传\",show:!1,list:this.fileList,face:null,canvasElm:null,confirmLoading:!1,openCameraError:!1,isLoading:!1,picWidth:270,picHeight:270,canvasCardContext:\"\",canvasCard:\"\"}},watch:{fileList:function(e){this.list=this.fileList,this.list.length&&(this.face={url:this.list[0][this.imageUrl],fileKey:this.list[0][this.imageKey]})},\"loading.getMemberCheckResult\":function(e){this.$emit(\"loadingChange\",e)},progress:function(e){this.$emit(\"progressChange\",e)}},computed:{imageId:function(){return this.props.image_id},imageKey:function(){return this.props.image_key},imageUrl:function(){return this.props.image_url},userImgSrc:function(){return Object(b[\"a\"])(this.face,\"url\",\"\")}},created:function(){this.createOutCanvas()},mounted:function(){var e=this;this.$nextTick((function(){navigator.mediaDevices.getUserMedia||navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia?(e.openCamera(),e.canvasElm=e.$refs.canvas):(e.openCameraError=!0,e.face=null)}))},methods:{onCancel:function(){this.show=!1},uploadUserImageFormPhoto:function(e){var t=this;this.isLoading=!0,this.oss.put({business:\"face\",isPrivate:!0,file:e.file}).subscribe({next:function(e){t.face=e},error:function(e){t.messageService.error({content:\"Error \".concat(e.message)}),t.isLoading=!1},complete:function(){t.isLoading=!1}})},uploadUserImageFormCamera:function(e){var t=this,i=this.canvasElm;i.toBlob((function(e){t.isLoading=!0,t.oss.put({file:e,isPrivate:!0,business:\"face\",uploadProgress:function(e){t.progress=parseInt(e.loaded/e.total*100)}}).subscribe({next:function(e){t.isLoading=!1,t.face=e},error:function(e){t.isLoading=!1,t.messageService.error({content:\"Error \".concat(e.message)})},complete:function(){t.isLoading=!1}})}))},uploadUserImageAndQualityTest:function(){var e=this,t=this.face;this.recognitionService.getMemberCheckResult({image_key:t.fileKey}).subscribe((function(i){var a=i.is_scan;if(a){e.list.length&&e.list[0][e.imageId];var s,n=e.list.length&&e.list[0];if(n)n[e.imageKey]=t.fileKey;else e.list.push((s={},Object(o[\"a\"])(s,e.imageId,0),Object(o[\"a\"])(s,e.imageKey,t.fileKey),Object(o[\"a\"])(s,e.imageUrl,t.url),s));e.$emit(\"change\",e.list),e.show=!1}else e.messageService.error({content:\"上传图片质量不佳,请重新拍照\"}),e.face=null}))},createOutCanvas:function(){this.canvasCard=document.createElement(\"canvas\"),this.canvasCard.style.opacity=0,this.canvasCard.width=this.picWidth,this.canvasCard.height=this.picHeight,this.canvasCard.style.width=this.picWidth+\"px\",this.canvasCard.style.height=this.picHeight+\"px\",this.canvasCardContext=this.canvasCard.getContext(\"2d\"),this.canvasCardContext.fillStyle=\"#ffffff\",this.canvasCardContext.fillRect(0,0,this.picWidth,this.picHeight)},handlerTakePhoto:function(){if(this.userImgSrc)this.face=null;else{var e=this.canvasElm.getContext(\"2d\"),t=this.$refs.video;e.drawImage(t,0,0,this.picWidth,this.picHeight),this.canvasCardContext.drawImage(this.canvasElm,0,0,this.picWidth,this.picHeight,0,0,this.picWidth,this.picHeight),this.uploadUserImageFormCamera()}},openCamera:function(){navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;return t?(this.openCameraError=!1,new Promise((function(i,a){t.call(navigator,e,i,a)}))):(this.openCameraError=!0,Promise.reject(new Error(\"getUserMedia is not implemented in this browser\")))});var e={video:{width:this.picWidth,height:this.picHeight}};this.isLoading=!0,navigator.mediaDevices.getUserMedia(e).then(this.CameraOpensuccess).catch(this.CameraOpenerror)},closeCamera:function(){if(this.$refs[\"video\"].srcObject){var e=this.$refs[\"video\"].srcObject,t=e.getTracks();t.forEach((function(e){e.stop()})),this.$refs[\"video\"].srcObject=null}},CameraOpensuccess:function(e){var t=this.$refs.video;\"srcObject\"in t?t.srcObject=e:t.src=window.URL.createObjectURL(e);var i=this;t.oncanplay=function(e){i.isLoading=!1},t.onloadedmetadata=function(e){t.play()}},CameraOpenerror:function(e){this.openCameraError=!0,this.isLoading=!1},dataURItoBlob:function(e){for(var t=atob(e.split(\",\")[1]),i=e.split(\",\")[0].split(\":\")[1].split(\";\")[0],a=new ArrayBuffer(t.length),s=new Uint8Array(a),n=0;n<t.length;n++)s[n]=t.charCodeAt(n);return new Blob([a],{type:i})}},beforeDestroy:function(){this.closeCamera()}},y=C,w=i(\"2877\"),_=Object(w[\"a\"])(y,n,r,!1,null,null,null);t[\"a\"]=_.exports},\"8d4e\":function(e,t,i){e.exports=i.p+\"img/userBitmap.3cc317dd.png\"}}]);","extractedComments":[]}