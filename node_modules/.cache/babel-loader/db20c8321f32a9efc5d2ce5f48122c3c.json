{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/app/venue/booking.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/app/venue/booking.vue","mtime":1591147717376},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.array.fill\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { BookingService } from \"./booking.service\";\nimport { swiper, swiperSlide } from 'vue-awesome-swiper';\nimport 'swiper/dist/css/swiper.css';\nimport moment from 'moment';\nimport bookingTable from \"./components#/booking-table\";\nimport memberSearch from '@/views/biz-components/member-search/member-search';\nimport { ruleOptions, columns } from \"./booking.config\";\nimport SoldDealGatheringTip from '@/views/biz-modals/sold/deal/gathering-tip';\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering';\nimport { PatternService } from '@/services/pattern.service';\nimport { debounce } from 'lodash-es';\nexport default {\n  name: 'PageShopAppVenueBooking',\n  bem: {\n    b: 'page-shop-app-venue-booking',\n    calendar: 'calendar',\n    list: 'list',\n    right: 'right'\n  },\n  serviceInject: function serviceInject() {\n    return {\n      bookingService: BookingService,\n      pattern: PatternService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      venueList: this.bookingService.venueList$,\n      loading: this.bookingService.loading$,\n      auth: this.bookingService.auth$,\n      hasNext: this.bookingService.hasNext$\n    };\n  },\n  modals: {\n    SoldDealGatheringTip: SoldDealGatheringTip,\n    SoldDealGathering: SoldDealGathering\n  },\n  components: {\n    swiper: swiper,\n    swiperSlide: swiperSlide,\n    bookingTable: bookingTable,\n    memberSearch: memberSearch\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      sum: 0,\n      finalAmount: 0,\n      reduce_price: '',\n      form: form,\n      decorators: decorators,\n      selectedList: [],\n      columns: columns,\n      sliderOptions: {\n        autoplay: false,\n        navigation: {\n          nextEl: '.swiper-booking-button-next',\n          prevEl: '.swiper-booking-button-prev'\n        },\n        slidesPerView: 7,\n        slidesPerGroup: 7,\n        centeredSlides: false,\n        normalizeSlideIndex: false\n      },\n      calendarData: [],\n      query: {\n        venues_id: '',\n        page: 1,\n        size: 10,\n        reserve_day: ''\n      },\n      pickedIndex: 0,\n      bookingList: [],\n      siteX: [],\n      siteY: []\n    };\n  },\n  mounted: function mounted() {\n    this.calendarData = Array(28).fill().map(function (item, index) {\n      return {\n        week: moment().add(index, 'days').format('ddd'),\n        date: moment().add(index, 'days').format('YYYY-MM-DD'),\n        day: moment().add(index, 'days').format('MM/DD')\n      };\n    });\n    this.query.venues_id = this.venueList[0].venues_id;\n    this.pickDate(this.calendarData[0], 0);\n  },\n  watch: {\n    reduce_price: debounce(function (val) {\n      if (!this.selectedList.length) return;\n      this.calcPrice();\n    }, 500)\n  },\n  methods: {\n    onNextPage: function onNextPage() {\n      var _this = this;\n\n      if (!this.hasNext) return;\n      this.query.page++;\n      this.bookingService.getBookingList(this.query).subscribe(function (res) {\n        _this.bookingList = _this.bookingList.concat(res.list);\n        _this.siteX = _this.siteX.concat(res.site_x);\n        _this.siteY = res.site_y;\n      });\n    },\n    resetPage: function resetPage() {\n      this.form.resetFields();\n      this.reduce_price = '';\n      this.getList();\n    },\n    createdOrderPay: function createdOrderPay(props) {\n      var _this2 = this;\n\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering',\n        props: props,\n        on: {\n          success: function success(res) {\n            _this2.payCallBack(props.order_id, res.type);\n          },\n          cancel: function cancel() {\n            _this2.resetPage();\n          }\n        }\n      });\n    },\n    payCallBack: function payCallBack(orderId, callBackType) {\n      switch (callBackType) {\n        case 'cancel':\n          this.resetPage();\n          break;\n\n        case 'pay':\n          this.createdGatheringTip({\n            message: '收款成功',\n            order_id: orderId,\n            needPay: false,\n            needContract: false,\n            needTicket: false\n          });\n          break;\n      }\n    },\n    tipCallBack: function tipCallBack(_ref) {\n      var orderId = _ref.orderId,\n          type = _ref.type;\n\n      switch (type) {\n        case 'cancel':\n          this.resetPage();\n          break;\n\n        case 'ViewOrder':\n          this.createdOrderViewOrder(orderId);\n          break;\n\n        case 'Pay':\n          this.createdOrderPay({\n            order_id: orderId,\n            type: 'venues'\n          });\n          break;\n      }\n    },\n    createdGatheringTip: function createdGatheringTip(props) {\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering-tip',\n        props: props,\n        on: {\n          success: this.tipCallBack\n        }\n      });\n    },\n    createdOrderViewOrder: function createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      });\n    },\n    createOrder: function createOrder() {\n      var _this3 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this3.form.validate().then(function (values) {\n          console.log(values);\n\n          var venues_data = _this3.selectedList.map(function (item) {\n            return {\n              time_start: item.start_time,\n              time_end: item.end_time,\n              venues_site_id: +item.id.replace(/\\-.*/, ''),\n              price: item.price,\n              venues_site_name: item.site_name\n            };\n          });\n\n          values.mobile = values.mobile ? values.mobile.phone : undefined;\n          values.country_prefix = values.mobile ? values.mobile.code_id : undefined;\n          values.parent_mobile = values.parent_mobile ? values.parent_mobile.phone : undefined;\n          values.parent_country_prefix = values.parent_mobile ? values.parent_mobile.code_id : undefined;\n\n          _this3.bookingService.createOrder(_objectSpread({\n            venues_id: _this3.query.venues_id,\n            venues_name: _this3.query.venues_name,\n            reduce_price: _this3.reduce_price,\n            actual_amount: _this3.finalAmount,\n            order_amount: _this3.sum,\n            reserve_day: _this3.query.reserve_day,\n            venues_data: venues_data\n          }, values)).subscribe(function (result) {\n            resolve(result);\n          });\n        });\n      });\n    },\n    onCreateOrder: function onCreateOrder() {\n      var _this4 = this;\n\n      this.createOrder().then(function (result) {\n        var props = {\n          order_id: result.info.order_id,\n          message: '订单创建成功',\n          needPay: true,\n          needContract: false,\n          needTicket: false\n        };\n\n        _this4.createdGatheringTip(props);\n      });\n    },\n    onPay: function onPay() {\n      var _this5 = this;\n\n      this.createOrder().then(function (result) {\n        _this5.createdOrderPay({\n          order_id: result.info.order_id,\n          type: 'venues'\n        });\n      });\n    },\n    deleteRow: function deleteRow(row) {\n      var index;\n      this.selectedList.forEach(function (item, inx) {\n        if (item.id === row.id) {\n          index = inx;\n        }\n      });\n      this.$refs.bookingTable.deleteRow(index);\n    },\n    calcPrice: function calcPrice() {\n      var _this6 = this;\n\n      var list = this.selectedList;\n      var venues_site_time = list.map(function (item) {\n        return {\n          start_time: item.start_time,\n          end_time: item.end_time,\n          site_id: +item.id.replace(/\\-.*/, '')\n        };\n      });\n      var params = {\n        venues_id: this.query.venues_id,\n        date: this.query.reserve_day,\n        reduce_price: this.reduce_price || 0,\n        venues_site_time: venues_site_time\n      };\n      this.bookingService.calcPrice(params).subscribe(function (res) {\n        _this6.sum = res.total_price;\n        _this6.finalAmount = res.price;\n      });\n    },\n    getSelectedList: function getSelectedList(list) {\n      this.selectedList = list;\n\n      if (list.length === 0) {\n        this.sum = 0;\n        this.finalAmount = 0;\n        return;\n      }\n\n      this.calcPrice();\n    },\n    pickDate: function pickDate(dateObj, index) {\n      this.calendarData.forEach(function (item) {\n        return item.ispick = false;\n      });\n      this.pickedIndex = index;\n      this.query.reserve_day = dateObj.date;\n      this.resetPagination();\n      this.getList();\n    },\n    selectHandler: function selectHandler(e) {\n      this.query.venues_id = e.target.value;\n      this.resetPagination();\n      this.getList();\n    },\n    resetPagination: function resetPagination() {\n      this.query.page = 1;\n      this.$refs.bookingTable.resetScroll();\n    },\n    getList: function getList() {\n      var _this7 = this;\n\n      this.bookingService.getBookingList(this.query).subscribe(function (res) {\n        _this7.$refs.bookingTable.deleteAll();\n\n        _this7.bookingList = res.list;\n        _this7.siteX = res.site_x;\n        _this7.siteY = res.site_y;\n      });\n    }\n  }\n};",null]}