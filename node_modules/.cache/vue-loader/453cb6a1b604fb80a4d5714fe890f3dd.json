{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/product/course/manage/package/edit-unlimit-package.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/product/course/manage/package/edit-unlimit-package.vue","mtime":1596188219728},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport moment from 'moment'\nimport { cloneDeep, remove } from 'lodash-es'\nimport { EditUnlimitPackageService } from './edit-unlimit-package.service'\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nimport ReserveIsLimit from './components#/reserveIsLimit'\nexport default {\n  name: 'ShopUnlimitPackageEdit',\n  serviceInject() {\n    return {\n      editPackageService: EditUnlimitPackageService\n    }\n  },\n  rxState() {\n    return {\n      transferUnitList: this.editPackageService.transferUnitList$,\n      sellTypeList: this.editPackageService.sellTypeList$,\n      unitList: this.editPackageService.unitList$,\n      editLoading: this.editPackageService.loading$,\n      packageInfo: this.editPackageService.packageInfo$\n    }\n  },\n  components: {\n    StImageUpload,\n    ReserveIsLimit\n  },\n  bem: {\n    add: 'page-shop-add-unlimit-package',\n    basic: 'page-shop-add-basic-package'\n  },\n  data() {\n    return {\n      packageData: {\n        // 是否支持团体课 0为不支持 1为支持\n        is_team: 0,\n        // 团体课总节数\n        team_times: undefined,\n        // 团体课单价\n        team_unit_price: undefined,\n        // 是否支持私教课 0为不支持 1为支持\n        is_personal: 0,\n        // 私教课总节数\n        personal_times: undefined,\n        // 私教课单价\n        personal_unit_price: undefined,\n        // 售价\n        price: undefined,\n        // 售卖开始时间\n        start_time: '',\n        // 售卖截止时间\n        end_time: '',\n        // 有效时间值\n        valid_time: undefined,\n        // 有效时间单位 1:天 2:月 3:年\n        valid_time_unit: 1,\n        // 允许冻结天数\n        frozen_days: undefined,\n        // 是否可以转让: 0 不可以 1 可以\n        is_allow_transfer: 0,\n        // 转让费率\n        transfer_rate: undefined,\n        // 转让单位 1:百分比 2:元\n        transfer_unit: 1,\n        // 售卖方式\n        sale_mode: [2],\n        // 封面对象\n        image: {\n          image_id: null,\n          image_key: ''\n        },\n        // 课程包介绍\n        intro: '',\n        // 备注\n        remarks: ''\n      },\n      form: this.$form.createForm(this),\n      start_time: null,\n      end_time: null,\n      endOpen: false,\n      // 课程范围是否未输入过\n      courseIsFirstInput: true,\n      // 课程范围是否未配置\n      courseIsNone: false,\n      courseErrorText: '',\n      // 是否未传了封面\n      imageIsNone: false,\n      imageErrorText: '',\n      fileList: [],\n      cropperModal: {},\n      reserveIsLimitInfo: {}\n    }\n  },\n  mounted() {\n    this.init()\n  },\n  methods: {\n    onChangeReserveIsliimt(event) {\n      console.log(event)\n      this.reserveIsLimit = event.target.value\n    },\n    init() {\n      if (!this.packageInfo.is_allow_transfer) {\n        this.packageInfo.transfer_rate = undefined\n      }\n      if (!this.packageInfo.is_team) {\n        this.packageInfo.team_times = undefined\n        this.packageInfo.team_unit_price = undefined\n      }\n      if (!this.packageInfo.is_personal) {\n        this.packageInfo.personal_times = undefined\n        this.packageInfo.personal_unit_price = undefined\n      }\n      // 初始化约课限制对象 5.22 start\n      const {\n        reserve_is_limit,\n        reserve_limit_day,\n        reserve_limit_times\n      } = this.packageInfo\n      this.reserveIsLimitInfo = {\n        reserve_is_limit,\n        reserve_limit_day,\n        reserve_limit_times\n      }\n      // 初始化约课限制对象 5.22 end\n      this.form.setFieldsValue({\n        support_num: this.packageInfo.support_num,\n        price: this.packageInfo.price,\n        start_time: moment(this.packageInfo.start_time),\n        end_time: moment(this.packageInfo.end_time),\n        valid_time: this.packageInfo.valid_time,\n        frozen_days: this.packageInfo.frozen_days,\n        transfer_rate: this.packageInfo.transfer_rate\n      })\n      // 课程范围\n      this.packageData.is_team = this.packageInfo.is_team\n      this.packageData.team_times = this.packageInfo.team_times\n      this.packageData.team_unit_price = this.packageInfo.team_unit_price\n      this.packageData.is_personal = this.packageInfo.is_personal\n      this.packageData.personal_times = this.packageInfo.personal_times\n      this.packageData.personal_unit_price = this.packageInfo.personal_unit_price\n      // 售卖时间\n      this.start_time = moment(this.packageInfo.start_time)\n      this.end_time = moment(this.packageInfo.end_time)\n      // 有效时间单位\n      this.packageData.valid_time_unit = this.packageInfo.valid_time_unit\n      // 转让设置\n      this.packageData.is_allow_transfer = this.packageInfo.is_allow_transfer\n      this.packageData.transfer_unit = this.packageInfo.transfer_unit\n      // 售卖方式\n      this.packageData.sale_mode = this.packageInfo.sale_mode\n      // 封面\n      this.fileList = [this.packageInfo.image]\n      this.packageData.image.image_id = this.fileList[0].image_id\n      this.packageData.image.image_key = this.fileList[0].image_key\n      this.imageIsNone = false\n      this.imageErrorText = ''\n      // 介绍\n      this.packageData.intro = this.packageInfo.intro\n      // 备注\n      this.packageData.remarks = this.packageInfo.remarks\n    },\n    // 保存\n    save() {\n      this.course_validator()\n      this.image_validator()\n      this.form.validateFieldsAndScroll((err, values) => {\n        if (!err && !this.courseIsNone && !this.imageIsNone) {\n          this.packageData.price = values.price\n          this.packageData.valid_time = values.valid_time\n          this.packageData.frozen_days = values.frozen_days\n          this.packageData.support_num = values.support_num\n          // 约课限制 5.22 start\n          this.packageData.reserve_is_limit = values.reserve_is_limit\n          this.packageData.reserve_limit_day = values.reserve_limit_day\n          this.packageData.reserve_limit_times = +values.reserve_limit_times\n          // 约课限制 5.22 end\n          this.packageData.transfer_rate = this.packageData.is_allow_transfer\n            ? +values.transfer_rate\n            : undefined\n          this.packageData.start_time =\n            typeof this.start_time === 'string'\n              ? this.start_time\n              : `${this.start_time.format('YYYY-MM-DD')}`\n          this.packageData.end_time =\n            typeof this.end_time === 'string'\n              ? this.end_time\n              : `${this.end_time.format('YYYY-MM-DD')}`\n          this.packageData.album_id = this.packageInfo.album_id\n          this.packageData.team_unit_price = +this.packageData.team_unit_price\n          this.packageData.personal_unit_price = +this.packageData\n            .personal_unit_price\n          this.editPackageService\n            .editPackage(this.packageData)\n            .subscribe(res => {\n              this.$router.push({\n                path: '/shop/product/course/manage/package/list'\n              })\n            })\n        }\n      })\n    },\n    // course validatorFn\n    course_validator() {\n      this.courseIsFirstInput = false\n      let teamIsOk = this.packageData.is_team ? !!this.team_total : true\n      let personalIsOk = this.packageData.is_personal\n        ? !!this.personal_total\n        : true\n      if (\n        teamIsOk &&\n        personalIsOk &&\n        !(!this.packageData.is_team && !this.packageData.is_personal)\n      ) {\n        // 校验通过\n        this.courseIsNone = false\n        this.courseErrorText = ''\n      } else {\n        // 校验未通过\n        this.courseIsNone = true\n        this.courseErrorText = '请输入上课范围'\n      }\n    },\n    // image validatorFn\n    image_validator() {\n      if (this.packageData.image.image_key !== '') {\n        // 校验通过\n        this.imageIsNone = false\n        this.imageErrorText = ''\n      } else {\n        // 校验未通过\n        this.imageIsNone = true\n        this.imageErrorText = '请上传封面'\n      }\n    },\n    // checkboxChange\n    teamCheckboxChange(e) {\n      this.packageData.is_team = +e.target.checked\n      this.courseIsFirstInput = false\n    },\n    personalCheckboxChange(e) {\n      this.packageData.is_personal = +e.target.checked\n      this.courseIsFirstInput = false\n    },\n    // 转让\n    transfer(e) {\n      this.packageData.is_allow_transfer = +e.target.checked\n      // 重置转让费用的校验\n      this.packageData.transfer_rate = undefined\n      this.form.resetFields(['transfer_rate'])\n    },\n    fileChange(data) {\n      if (data.length) {\n        // 上传\n        this.packageData.image.image_id = data[0].image_id\n        this.packageData.image.image_key = data[0].image_key\n        this.imageIsNone = false\n        this.imageErrorText = ''\n      } else {\n        // 删除\n        this.packageData.image.image_id = null\n        this.packageData.image.image_key = ''\n        this.imageIsNone = true\n        this.imageErrorText = '请上传封面'\n      }\n    },\n    transferUnitChange() {\n      this.packageData.transfer_rate = undefined\n      this.form.setFieldsValue({\n        transfer_rate: undefined\n      })\n    },\n    // start_time validatorFn\n    start_time_validator(rule, value, callback) {\n      if (!value) {\n        // eslint-disable-next-line\n        callback('请选择开始售卖时间')\n      } else {\n        // eslint-disable-next-line\n        callback()\n      }\n    },\n    // end_time validatorFn\n    end_time_validator(rule, value, callback) {\n      if (!value) {\n        // eslint-disable-next-line\n        callback('请选择结束售卖时间')\n      } else {\n        // eslint-disable-next-line\n        callback()\n      }\n    },\n    // 售卖时间-start\n    start_time_change(data) {\n      this.start_time = cloneDeep(data)\n    },\n    handleStartOpenChange(open) {\n      if (!open) {\n        this.endOpen = true\n      }\n    },\n    disabledStartDate(startValue) {\n      const endValue = this.end_time\n      if (!endValue) {\n        // 结束时间未选择\n        return (\n          startValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n        )\n      }\n      let start =\n        endValue.valueOf() >\n        moment()\n          .add(30, 'y')\n          .valueOf()\n          ? moment(endValue)\n              .subtract(30, 'y')\n              .valueOf()\n          : moment()\n              .startOf('day')\n              .valueOf()\n      return (\n        startValue.valueOf() < start ||\n        startValue.valueOf() > moment(endValue).valueOf()\n      )\n    },\n    // 售卖时间-end\n    end_time_change(data) {\n      this.end_time = cloneDeep(data)\n    },\n    handleEndOpenChange(open) {\n      this.endOpen = open\n    },\n    disabledEndDate(endValue) {\n      const startValue = this.start_time\n      if (!startValue) {\n        // 开始时间未选择\n        return (\n          endValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n        )\n      }\n      return (\n        endValue.valueOf() >=\n          moment(startValue)\n            .add(30, 'y')\n            .valueOf() ||\n        endValue.valueOf() < moment(startValue).valueOf() ||\n        endValue.valueOf() <\n          moment()\n            .startOf('day')\n            .valueOf()\n      )\n    },\n    // moment\n    moment\n  },\n  computed: {\n    // 团课小计\n    team_total() {\n      if (+this.packageData.team_times && +this.packageData.team_unit_price) {\n        return (\n          (this.packageData.team_times *\n            (this.packageData.team_unit_price * 10)) /\n          10\n        )\n      } else {\n        return 0\n      }\n    },\n    // 私教小计\n    personal_total() {\n      if (\n        +this.packageData.personal_times &&\n        +this.packageData.personal_unit_price\n      ) {\n        return (\n          (this.packageData.personal_times *\n            (this.packageData.personal_unit_price * 10)) /\n          10\n        )\n      } else {\n        return 0\n      }\n    },\n    // 总价\n    all_total() {\n      let teamTotal = this.packageData.is_team ? this.team_total : 0\n      let personalTotal = this.packageData.is_personal ? this.personal_total : 0\n      return teamTotal + personalTotal\n    }\n  }\n}\n",null]}