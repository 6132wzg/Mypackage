{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/activity-registration/components#/step3-form.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/activity-registration/components#/step3-form.vue","mtime":1600926556120},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import _toConsumableArray from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es7.array.includes\";\nimport \"core-js/modules/es6.string.includes\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport draggable from 'vuedraggable';\nimport { Step3FormService } from \"./step3-form.service\";\nimport MarketingAddSignup from '@/views/biz-modals/marketing/add-signup';\nimport { CopyService } from \"../copy.service\";\nimport { cloneDeep } from 'lodash-es';\nimport { ACTIVITY_STATUS } from '@/constants/brand/marketing';\nimport { MessageService } from \"../../../../../../../services/message.service\";\nexport default {\n  name: 'Step3Form',\n  bem: {\n    pComponents: 'step-form-signup'\n  },\n  modals: {\n    MarketingAddSignup: MarketingAddSignup\n  },\n  serviceInject: function serviceInject() {\n    return {\n      service: Step3FormService,\n      msg: MessageService,\n      copyService: CopyService\n    };\n  },\n  rxState: function rxState() {\n    var defaultExtInfo$ = this.service.defaultExtInfo$;\n    var defaultForm$ = this.copyService.defaultForm$;\n    return {\n      defaultExtInfo$: defaultExtInfo$,\n      defaultForm$: defaultForm$\n    };\n  },\n  data: function data() {\n    return {\n      ACTIVITY_STATUS: ACTIVITY_STATUS,\n      checkedShopIds: [],\n      addDataSource: [],\n      formData: [],\n      isStep3: 0,\n      extraSort: 3,\n      list: []\n    };\n  },\n  components: {\n    draggable: draggable\n  },\n  props: {\n    isCopy: {\n      type: Boolean,\n      default: false\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    },\n    show: {\n      type: Boolean\n    }\n  },\n  created: function created() {\n    this.service.getDefaultExtInfo().subscribe();\n    if (!this.isCopy && !this.isEdit) return;\n    this.initForm();\n  },\n  computed: {\n    colspanNum: function colspanNum() {\n      return 5;\n    },\n    activityStatus: function activityStatus() {\n      return this.defaultForm$.activity_status;\n    },\n    // 如果是编辑的时候，需要活动id\n    activity_id: function activity_id() {\n      return this.defaultForm$.activity_id;\n    },\n    isSaveDraft: function isSaveDraft() {\n      return this.$route.path.includes('/activity-registration/edit') && this.activityStatus === ACTIVITY_STATUS.PUBLISHED;\n    },\n    dataSource: function dataSource() {\n      var isDefault = false;\n      this.addDataSource.forEach(function (item) {\n        if (item.extra_key === 'username') {\n          isDefault = true;\n        }\n      });\n\n      if (isDefault) {\n        return _toConsumableArray(this.addDataSource);\n      } else {\n        return [].concat(_toConsumableArray(this.defaultExtInfo$), _toConsumableArray(this.addDataSource));\n      }\n    }\n  },\n  methods: {\n    onEnd: function onEnd() {\n      var list = this.addDataSource.map(function (item, index) {\n        item.extra_sort = index;\n        return item;\n      });\n      this.$set(this, 'addDataSource', list);\n      this.$emit('change', this.dataSource);\n    },\n    isDel: function isDel(value) {\n      if (value.extra_sort === 0 || value.extra_sort === 1) {\n        return false;\n      } else if (this.activityStatus === ACTIVITY_STATUS.DRAFT) {\n        return true;\n      } else if (this.isEdit) {\n        var extraSortArr = cloneDeep(this.defaultForm$.rule_settings.join_ext_info).extra_data.map(function (item) {\n          return item.extra_sort;\n        });\n        return !extraSortArr.includes(value.extra_sort);\n      }\n\n      return true;\n    },\n    initForm: function initForm() {\n      var _this = this;\n\n      this.$nextTick().then(function () {\n        var joinExtInfo = cloneDeep(_this.defaultForm$.rule_settings.join_ext_info);\n        var extraData = joinExtInfo.extra_data;\n        _this.isStep3 = _this.isEdit ? joinExtInfo.extra_type : 0;\n\n        _this.$set(_this, 'addDataSource', extraData);\n\n        _this.formData = _toConsumableArray(extraData);\n\n        _this.$emit('change', _this.dataSource);\n      });\n    },\n    onClickBack: function onClickBack() {\n      this.$emit('back', 1);\n    },\n    onCLickOpenmodal: function onCLickOpenmodal() {\n      this.extraSort = Math.max.apply(Math, _toConsumableArray(this.dataSource.map(function (item) {\n        return item.extra_sort;\n      }))) + 1;\n      this.$modalRouter.push({\n        name: 'marketing-add-signup',\n        props: {\n          signUpList: this.dataSource,\n          extra_sort: this.extraSort\n        },\n        on: {\n          show: this.getTableItem,\n          submit: this.getFormItem\n        }\n      });\n    },\n    getTableItem: function getTableItem(item) {\n      this.addDataSource.push(item);\n      this.$emit('change', this.dataSource);\n    },\n    getFormItem: function getFormItem(item) {\n      this.formData.push(item);\n    },\n    getStepForm: function getStepForm() {\n      var isDefault = false;\n      var extra_data = [];\n      this.formData.forEach(function (item) {\n        if (item.extra_key === 'username') {\n          isDefault = true;\n        }\n      });\n\n      if (isDefault) {\n        extra_data = _toConsumableArray(this.isStep3 ? this.formData : []);\n      } else {\n        extra_data = [].concat(_toConsumableArray(this.defaultExtInfo$), _toConsumableArray(this.isStep3 ? this.formData : []));\n      }\n\n      return {\n        join_ext_info: {\n          extra_type: this.isStep3,\n          extra_data: extra_data\n        }\n      };\n    },\n    delExtraItemRecord: function delExtraItemRecord(extraKey) {\n      this.addDataSource = this.addDataSource.filter(function (item) {\n        return item.extra_key !== extraKey;\n      });\n      this.formData = this.formData.filter(function (item) {\n        return item.extra_key !== extraKey;\n      });\n      this.$emit('change', this.addDataSource);\n    },\n    onClickRelease: function onClickRelease() {\n      this.$emit('release', this.getStepForm());\n    },\n    onClickSaveDraft: function onClickSaveDraft() {\n      this.$emit('save-draft', this.getStepForm());\n    },\n    onChangeIsShow: function onChangeIsShow() {\n      if (this.isEdit && this.defaultForm$.activity_status === ACTIVITY_STATUS.PUBLISHED && this.defaultForm$.rule_settings.join_ext_info.extra_type === 1) {\n        this.isStep3 = this.defaultForm$.rule_settings.join_ext_info.extra_type;\n        this.msg.error({\n          content: '已发布的活动，不能关闭活动信息'\n        });\n      }\n\n      var data = this.isStep3 ? this.dataSource : [];\n      this.$emit('change', data);\n    }\n  }\n};",{"version":3,"sources":["step3-form.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div :class=\"pComponents()\">\n    <div :class=\"pComponents('switch')\">\n      <span class=\"mg-r24\">您是否需要收集参与者的必要信息</span>\n      <st-switch v-model=\"isStep3\" @change=\"onChangeIsShow\"></st-switch>\n    </div>\n    <div class=\"mg-t24\" v-if=\"isStep3\">\n      <ul :class=\"pComponents('table-header')\">\n        <li :class=\"pComponents('table-header-item')\">报名项标题</li>\n        <li :class=\"pComponents('table-header-item')\">操作</li>\n      </ul>\n      <st-button\n        :disabled=\"dataSource.length === 10\"\n        type=\"dashed\"\n        icon=\"add\"\n        class=\"mg-t8\"\n        @click=\"onCLickOpenmodal\"\n        block\n      >\n        新增\n      </st-button>\n      <ul class=\"mg-t8\" :class=\"pComponents('draggable')\" tag=\"ul\">\n        <template v-for=\"(item, index) in dataSource\">\n          <li\n            v-if=\"index <= 1 || !isDel(item)\"\n            :class=\"pComponents('draggable-li')\"\n            :key=\"index\"\n          >\n            <div :class=\"pComponents('draggable-name')\">\n              <span style=\"color: red\" v-if=\"index <= 1\">*</span>\n              {{ item.extra_name }}\n            </div>\n            <div :class=\"pComponents('draggable-action')\">\n              <a @click=\"delExtraItemRecord(item.extra_key)\">\n                --\n              </a>\n            </div>\n          </li>\n        </template>\n      </ul>\n      <!-- v-if=\"index > 1\" v-if=\"isDel(item)\" -->\n      <draggable\n        class=\"mg-t8\"\n        v-model=\"addDataSource\"\n        @end=\"onEnd\"\n        :class=\"pComponents('draggable')\"\n        tag=\"ul\"\n      >\n        <template v-for=\"(item, index) in dataSource\">\n          <li\n            v-if=\"index > 1 && isDel(item)\"\n            :class=\"pComponents('draggable-li')\"\n            :key=\"index\"\n          >\n            <div :class=\"pComponents('draggable-name')\">\n              <st-icon color=\"#9BACB9\" type=\"draggable\" class=\"mg-r8\"></st-icon>\n              <a-popover\n                v-if=\"\n                  item.extra_type === 'radio' || item.extra_type === 'checkbox'\n                \"\n                placement=\"bottomLeft\"\n              >\n                <template slot=\"content\">\n                  <st-button\n                    size=\"small\"\n                    :key=\"idx\"\n                    class=\"mg-r8 option-tip\"\n                    v-for=\"(option, idx) in item.extra_info\"\n                  >\n                    {{ option }}\n                  </st-button>\n                </template>\n                <template slot=\"title\">\n                  <span>{{ item.extra_name }}选项</span>\n                </template>\n                <span>{{ item.extra_name }}</span>\n              </a-popover>\n              <span v-else>{{ item.extra_name }}</span>\n            </div>\n            <div :class=\"pComponents('draggable-action')\">\n              <a v-if=\"isDel(item)\" @click=\"delExtraItemRecord(item.extra_key)\">\n                删除\n              </a>\n              <a v-else>--</a>\n            </div>\n          </li>\n        </template>\n      </draggable>\n    </div>\n\n    <portal to=\"BRAND_MARKETING_ACTIVITY_FORM_ACTIONS\" v-if=\"show\">\n      <st-button class=\"mg-r8\" @click=\"onClickBack\">\n        上一步\n      </st-button>\n      <st-button v-if=\"!isSaveDraft\" class=\"mg-r8\" @click=\"onClickSaveDraft\">\n        存草稿\n      </st-button>\n      <st-button @click=\"onClickRelease\" type=\"primary\">\n        发布\n      </st-button>\n    </portal>\n  </div>\n</template>\n<script>\nimport draggable from 'vuedraggable'\nimport { Step3FormService } from './step3-form.service'\nimport MarketingAddSignup from '@/views/biz-modals/marketing/add-signup'\nimport { CopyService } from '../copy.service'\nimport { cloneDeep } from 'lodash-es'\nimport { ACTIVITY_STATUS } from '@/constants/brand/marketing'\nimport { MessageService } from '../../../../../../../services/message.service'\nexport default {\n  name: 'Step3Form',\n  bem: {\n    pComponents: 'step-form-signup'\n  },\n  modals: {\n    MarketingAddSignup\n  },\n  serviceInject() {\n    return {\n      service: Step3FormService,\n      msg: MessageService,\n      copyService: CopyService\n    }\n  },\n  rxState() {\n    const { defaultExtInfo$ } = this.service\n    const { defaultForm$ } = this.copyService\n    return {\n      defaultExtInfo$,\n      defaultForm$\n    }\n  },\n  data() {\n    return {\n      ACTIVITY_STATUS,\n      checkedShopIds: [],\n      addDataSource: [],\n      formData: [],\n      isStep3: 0,\n      extraSort: 3,\n      list: []\n    }\n  },\n  components: {\n    draggable\n  },\n  props: {\n    isCopy: {\n      type: Boolean,\n      default: false\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    },\n    show: {\n      type: Boolean\n    }\n  },\n  created() {\n    this.service.getDefaultExtInfo().subscribe()\n    if (!this.isCopy && !this.isEdit) return\n    this.initForm()\n  },\n  computed: {\n    colspanNum() {\n      return 5\n    },\n    activityStatus() {\n      return this.defaultForm$.activity_status\n    },\n    // 如果是编辑的时候，需要活动id\n    activity_id() {\n      return this.defaultForm$.activity_id\n    },\n    isSaveDraft() {\n      return (\n        this.$route.path.includes('/activity-registration/edit') &&\n        this.activityStatus === ACTIVITY_STATUS.PUBLISHED\n      )\n    },\n    dataSource() {\n      let isDefault = false\n      this.addDataSource.forEach(item => {\n        if (item.extra_key === 'username') {\n          isDefault = true\n        }\n      })\n      if (isDefault) {\n        return [...this.addDataSource]\n      } else {\n        return [...this.defaultExtInfo$, ...this.addDataSource]\n      }\n    }\n  },\n  methods: {\n    onEnd() {\n      const list = this.addDataSource.map((item, index) => {\n        item.extra_sort = index\n        return item\n      })\n      this.$set(this, 'addDataSource', list)\n      this.$emit('change', this.dataSource)\n    },\n    isDel(value) {\n      if (value.extra_sort === 0 || value.extra_sort === 1) {\n        return false\n      } else if (this.activityStatus === ACTIVITY_STATUS.DRAFT) {\n        return true\n      } else if (this.isEdit) {\n        const extraSortArr = cloneDeep(\n          this.defaultForm$.rule_settings.join_ext_info\n        ).extra_data.map(item => item.extra_sort)\n        return !extraSortArr.includes(value.extra_sort)\n      }\n      return true\n    },\n    initForm() {\n      this.$nextTick().then(() => {\n        const joinExtInfo = cloneDeep(\n          this.defaultForm$.rule_settings.join_ext_info\n        )\n        const extraData = joinExtInfo.extra_data\n        this.isStep3 = this.isEdit ? joinExtInfo.extra_type : 0\n\n        this.$set(this, 'addDataSource', extraData)\n        this.formData = [...extraData]\n        this.$emit('change', this.dataSource)\n      })\n    },\n    onClickBack() {\n      this.$emit('back', 1)\n    },\n    onCLickOpenmodal() {\n      this.extraSort =\n        Math.max(...this.dataSource.map(item => item.extra_sort)) + 1\n      this.$modalRouter.push({\n        name: 'marketing-add-signup',\n        props: {\n          signUpList: this.dataSource,\n          extra_sort: this.extraSort\n        },\n        on: {\n          show: this.getTableItem,\n          submit: this.getFormItem\n        }\n      })\n    },\n    getTableItem(item) {\n      this.addDataSource.push(item)\n      this.$emit('change', this.dataSource)\n    },\n    getFormItem(item) {\n      this.formData.push(item)\n    },\n    getStepForm() {\n      let isDefault = false\n      let extra_data = []\n      this.formData.forEach(item => {\n        if (item.extra_key === 'username') {\n          isDefault = true\n        }\n      })\n      if (isDefault) {\n        extra_data = [...(this.isStep3 ? this.formData : [])]\n      } else {\n        extra_data = [\n          ...this.defaultExtInfo$,\n          ...(this.isStep3 ? this.formData : [])\n        ]\n      }\n      return {\n        join_ext_info: {\n          extra_type: this.isStep3,\n          extra_data\n        }\n      }\n    },\n    delExtraItemRecord(extraKey) {\n      this.addDataSource = this.addDataSource.filter(\n        item => item.extra_key !== extraKey\n      )\n      this.formData = this.formData.filter(item => item.extra_key !== extraKey)\n      this.$emit('change', this.addDataSource)\n    },\n    onClickRelease() {\n      this.$emit('release', this.getStepForm())\n    },\n    onClickSaveDraft() {\n      this.$emit('save-draft', this.getStepForm())\n    },\n    onChangeIsShow() {\n      if (\n        this.isEdit &&\n        this.defaultForm$.activity_status === ACTIVITY_STATUS.PUBLISHED &&\n        this.defaultForm$.rule_settings.join_ext_info.extra_type === 1\n      ) {\n        this.isStep3 = this.defaultForm$.rule_settings.join_ext_info.extra_type\n        this.msg.error({ content: '已发布的活动，不能关闭活动信息' })\n      }\n      const data = this.isStep3 ? this.dataSource : []\n      this.$emit('change', data)\n    }\n  }\n}\n</script>\n"],"sourceRoot":"src/views/pages/brand/marketing/plugin/activity-registration/components#"}]}