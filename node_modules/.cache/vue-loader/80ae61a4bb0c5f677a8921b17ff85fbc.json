{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/card/renewal-member.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/card/renewal-member.vue","mtime":1600926382262},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { RenewalMemberService } from './renewal-member.service'\nimport moment from 'moment'\nimport { cloneDeep } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { ruleOptions } from './renewal-member.config'\nimport autoContractBtn from '@/views/biz-components/contract/auto-contract-btn.vue'\nexport default {\n  name: 'ModalSoldRenewalMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  serviceProviders() {\n    return [RenewalMemberService]\n  },\n  serviceInject() {\n    return {\n      renewalMemberService: RenewalMemberService\n    }\n  },\n  components: {\n    autoContractBtn\n  },\n  rxState() {\n    return {\n      loading: this.renewalMemberService.loading$,\n      couponList: this.renewalMemberService.couponList$,\n      advanceList: this.renewalMemberService.advanceList$,\n      priceInfo: this.renewalMemberService.priceInfo$,\n      saleList: this.renewalMemberService.saleList$,\n      info: this.renewalMemberService.info$\n    }\n  },\n  props: ['id'],\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      // 规格\n      selectSpecs: 1,\n      // 时间\n      startTime: null,\n      endTime: '',\n      // 赠送\n      giftAmount: null,\n      // 优惠\n      couponDropdownVisible: false,\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      selectCoupon: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      // 减免金额\n      reduceAmount: null,\n      // 描述\n      description: ''\n    }\n  },\n  created() {\n    this.renewalMemberService.serviceInit(this.id).subscribe(res => {\n      // 获取优惠券\n      this.renewalMemberService\n        .getCouponList({\n          member_id: res[0].info.member_id,\n          card_id: res[0].info.card_id,\n          specs_id: res[0].info.specs[0].id\n        })\n        .subscribe()\n      // 获取定金\n      this.renewalMemberService\n        .getAdvanceList(res[0].info.member_id)\n        .subscribe()\n      // 规格\n      this.selectSpecs = res[0].info.specs[0].id\n      this.form.setFieldsValue({\n        startTime: moment(res[0].info.default_start_time * 1000)\n      })\n      // 实付金额\n      this.getPrice('', 0, '', res[0].info.specs[0].id)\n      this.startTime = cloneDeep(moment(res[0].info.default_start_time * 1000))\n      this.endTime = moment(res[0].info.default_start_time * 1000)\n        .add(res[0].info.specs[0].valid_time, 'd')\n        .format('YYYY-MM-DD HH:mm')\n    })\n  },\n  watch: {\n    selectSpecs(newVal, oldVal) {\n      this.getPrice(\n        this.selectAdvance,\n        +this.reduceAmount,\n        this.selectCoupon,\n        newVal\n      )\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(\n          newVal,\n          +this.reduceAmount,\n          this.selectCoupon,\n          this.selectSpecs\n        )\n      }\n    },\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(\n          this.selectAdvance,\n          +this.reduceAmount,\n          newVal,\n          this.selectSpecs\n        )\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(\n        this.selectAdvance,\n        +newVal,\n        this.selectCoupon,\n        this.selectSpecs\n      )\n    }\n  },\n  computed: {\n    // 商品价格\n    cardPrice() {\n      if (this.info.specs) {\n        const arr = this.info.specs.filter(i => i.id === this.selectSpecs)\n        if (arr.length > 0) {\n          return arr[0].price\n        }\n        return '0'\n      }\n      return '0'\n    },\n    orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : ''\n    },\n    isFamilyCard() {\n      return this.info.card_number_type === 2\n    }\n  },\n  methods: {\n    moment,\n    // 规格\n    onSpecsChange(data) {\n      let item = this.info.specs.filter(i => i.id === data.target.value)[0]\n      let s = cloneDeep(this.startTime)\n      let dayScope = item.valid_time\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm')\n      // 获取优惠券\n      this.renewalMemberService\n        .getCouponList({\n          member_id: this.info.member_id,\n          card_id: this.info.card_id,\n          specs_id: item.id\n        })\n        .subscribe(res => {\n          this.resetCoupon()\n        })\n    },\n    // 时间\n    disabledStartDate(startTime) {\n      return startTime.valueOf() < this.info.default_start_time * 1000\n    },\n    onStartTimeChange(data) {\n      this.startTime = cloneDeep(data)\n      let s = cloneDeep(data)\n      let dayScope = this.info.specs.filter(i => i.id === this.selectSpecs)[0]\n        .valid_time\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm')\n    },\n    // 合同\n    onCodeNumber() {\n      this.renewalMemberService\n        .getCodeNumber(this.info.contract_type)\n        .subscribe(res => {\n          this.form.setFieldsValue({\n            contractNumber: res.info.code\n          })\n        })\n    },\n    // 优惠\n    onSelectCouponChange(data) {\n      if (data.target.value === -1) {\n        this.couponAmount = ''\n        this.couponText = '未选择优惠券'\n        return\n      }\n      let price = this.couponList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.couponAmount = price\n      this.couponText = `${price}元`\n    },\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    resetCoupon() {\n      this.renewalMemberService.resetCouponList()\n      this.couponText = '未选择优惠券'\n      this.couponAmount = ''\n      this.selectcoupon = ''\n    },\n    // 定金\n    onSelectAdvanceChange(data) {\n      if (data.target.value === -1) {\n        this.advanceAmount = ''\n        this.advanceText = '未选择定金'\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    resetAdvance() {\n      this.renewalMemberService.resetAdvanceList()\n      this.advanceText = '未选择定金'\n      this.advanceAmount = ''\n      this.selectAdvance = ''\n    },\n    // 计算实付金额\n    getPrice(advance, reduce, coupon, specs_id) {\n      let advanceId = advance === -1 ? '' : advance\n      let couponId = coupon === -1 ? '' : coupon\n      this.renewalMemberService.priceAction$.dispatch({\n        id: this.id,\n        product_id: this.info.card_id,\n        product_type: this.info.contract_type,\n        specs_id,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        coupon_id: couponId,\n        member_id: this.info.member_id\n      })\n    },\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : undefined\n        this.renewalMemberService\n          .renewal(\n            {\n              contract_number: values.contractNumber,\n              rule_id: this.selectSpecs,\n              valid_start_time: moment(values.startTime).format(\n                'YYYY-MM-DD HH:mm'\n              ),\n              gift_amount: +this.giftAmount,\n              user_coupon_id:\n                this.selectCoupon === -1 ? undefined : +this.selectCoupon,\n              advance_id:\n                this.selectAdvance === -1 ? undefined : this.selectAdvance,\n              reduce_price: reduce_amount,\n              description: this.description,\n              staff_sale_id: +values.saleName,\n              contract_type: this.info.contract_type,\n              discounts_price: +this.info.specs.filter(\n                i => i.id === this.selectSpecs\n              )[0].price\n            },\n            this.id\n          )\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'create',\n              orderId: res.info.order_id,\n              soldId: res.info.sold_id,\n              isFamilyCard: this.isFamilyCard\n            })\n          })\n      })\n    },\n    onPay() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : undefined\n        this.renewalMemberService\n          .renewalPay(\n            {\n              contract_number: values.contractNumber,\n              rule_id: this.selectSpecs,\n              valid_start_time: moment(values.startTime).format(\n                'YYYY-MM-DD HH:mm'\n              ),\n              gift_amount: +this.giftAmount,\n              user_coupon_id:\n                this.selectCoupon === -1 ? undefined : +this.selectCoupon,\n              advance_id:\n                this.selectAdvance === -1 ? undefined : this.selectAdvance,\n              reduce_price: reduce_amount,\n              description: this.description,\n              staff_sale_id: +values.saleName,\n              contract_type: this.info.contract_type,\n              discounts_price: +this.info.specs.filter(\n                i => i.id === this.selectSpecs\n              )[0].price\n            },\n            this.id\n          )\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: res.info.order_id,\n              soldId: res.info.sold_id,\n              isFamilyCard: this.isFamilyCard\n            })\n          })\n      })\n    }\n  }\n}\n",{"version":3,"sources":["renewal-member.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"renewal-member.vue","sourceRoot":"src/views/biz-modals/sold/card","sourcesContent":["<template>\n  <st-modal v-model=\"show\" wrapClassName=\"modal-sold-deal-sale\">\n    <div slot=\"title\">\n      续卡\n      <st-help-tooltip id=\"TSMC001\" placement=\"right\" />\n    </div>\n    <div :class=\"sale('content')\">\n      <st-form :form=\"form\" labelWidth=\"88px\">\n        <div :class=\"sale('sale')\" class=\"modal-sold-renewal-member-card\">\n          <st-form-item labelGutter=\"12px\" label=\"续卡会员\" class=\"mg-b16\">\n            {{ info.member_name }}\n          </st-form-item>\n          <st-form-item labelGutter=\"12px\" label=\"卡名\" class=\"mg-b16\">\n            {{ info.card_name }}\n          </st-form-item>\n          <st-form-item\n            labelGutter=\"12px\"\n            label=\"卡成员\"\n            class=\"mg-b16\"\n            v-if=\"isFamilyCard\"\n          >\n            {{ info.card_member }}\n          </st-form-item>\n\n          <st-form-item\n            labelGutter=\"12px\"\n            label=\"规格\"\n            class=\"mg-b16\"\n            required\n            v-if=\"info.specs\"\n          >\n            <a-radio-group v-model=\"selectSpecs\" @change=\"onSpecsChange\">\n              <a-radio\n                v-for=\"(item, index) in info.specs\"\n                :value=\"item.id\"\n                :key=\"index\"\n              >\n                {{ item.specs_name }}/{{ item.price }}元\n              </a-radio>\n            </a-radio-group>\n          </st-form-item>\n          <st-form-item\n            labelGutter=\"12px\"\n            class=\"mg-b0\"\n            label=\"有效时间\"\n            required\n          >\n            <div :class=\"sale('time')\">\n              <a-form-item class=\"page-a-form\">\n                <a-date-picker\n                  :disabledDate=\"disabledStartDate\"\n                  v-decorator=\"decorators.startTime\"\n                  @change=\"onStartTimeChange\"\n                  style=\"width: 188px;\"\n                  format=\"YYYY-MM-DD HH:mm\"\n                  :showTime=\"{ format: 'HH:mm' }\"\n                  placeholder=\"开始时间\"\n                  :allowClear=\"false\"\n                  :showToday=\"false\"\n                />\n                <span style=\"width:158px;\">\n                  &nbsp;&nbsp;至&nbsp;&nbsp;{{ endTime }}\n                </span>\n              </a-form-item>\n            </div>\n          </st-form-item>\n          <st-form-item labelGutter=\"12px\" label=\"购买赠送\">\n            <st-input-number\n              v-model=\"giftAmount\"\n              :placeholder=\"\n                `请输入赠送的${info.card_type !== 1 ? '天数' : '次数'}`\n              \"\n            >\n              <span slot=\"addonAfter\">\n                {{ info.card_type !== 1 ? '天' : '次' }}\n              </span>\n            </st-input-number>\n          </st-form-item>\n          <st-form-item labelGutter=\"12px\" required>\n            <template slot=\"label\">\n              合同编号\n              <st-help-tooltip id=\"TSSD001\" />\n            </template>\n            <div :class=\"sale('contract')\">\n              <a-input\n                v-decorator=\"decorators.contractNumber\"\n                placeholder=\"请输入合同编号\"\n              ></a-input>\n              <auto-contract-btn\n                class=\"create-button\"\n                @click=\"onCodeNumber\"\n                :loading=\"loading.getCodeNumber\"\n              >\n                自动生成\n              </auto-contract-btn>\n            </div>\n          </st-form-item>\n          <st-form-item labelGutter=\"12px\" class=\"mg-b12\" label=\"商品价格\">\n            {{ cardPrice }}元\n          </st-form-item>\n          <st-form-item\n            labelGutter=\"12px\"\n            :class=\"sale('discounts')\"\n            label=\"优惠金额\"\n          >\n            <div>\n              <div :class=\"sale('discounts-total')\">\n                <span>{{ couponText }}</span>\n                <a-dropdown\n                  v-model=\"couponDropdownVisible\"\n                  :disabled=\"couponList.length === 0\"\n                  :class=\"sale({ disabled: couponList.length === 0 })\"\n                  placement=\"bottomRight\"\n                  :getPopupContainer=\"trigger => trigger.parentNode\"\n                  :trigger=\"['click']\"\n                >\n                  <div :class=\"sale('discounts-promotion')\">\n                    <span>\n                      {{ couponList.length === 0 ? '无优惠券' : '优惠券选择' }}\n                    </span>\n                    <a-icon type=\"right\" />\n                  </div>\n                  <a-radio-group\n                    v-model=\"selectCoupon\"\n                    @change=\"onSelectCouponChange\"\n                    :class=\"sale('dropdown')\"\n                    slot=\"overlay\"\n                  >\n                    <a-menu>\n                      <a-menu-item @click=\"onSelectCoupon\">\n                        <a-radio :value=\"-1\">不使用</a-radio>\n                      </a-menu-item>\n                      <a-menu-item\n                        @click=\"onSelectCoupon\"\n                        :key=\"index\"\n                        v-for=\"(item, index) in couponList\"\n                      >\n                        <a-radio :value=\"item.id\">\n                          {{ item.name }} {{ item.price }}\n                        </a-radio>\n                      </a-menu-item>\n                    </a-menu>\n                  </a-radio-group>\n                </a-dropdown>\n              </div>\n            </div>\n          </st-form-item>\n          <st-form-item\n            labelGutter=\"12px\"\n            :class=\"sale('discounts')\"\n            label=\"定金抵扣\"\n          >\n            <div>\n              <div :class=\"sale('discounts-total')\">\n                <span>{{ advanceText }}</span>\n                <a-dropdown\n                  v-model=\"advanceDropdownVisible\"\n                  :disabled=\"advanceList.length === 0\"\n                  :class=\"sale({ disabled: advanceList.length === 0 })\"\n                  placement=\"bottomRight\"\n                  :getPopupContainer=\"trigger => trigger.parentNode\"\n                  :trigger=\"['click']\"\n                >\n                  <div :class=\"sale('discounts-promotion')\">\n                    <span>\n                      {{ advanceList.length === 0 ? '无定金' : '定金选择' }}\n                    </span>\n                    <a-icon type=\"right\" />\n                  </div>\n                  <a-radio-group\n                    v-model=\"selectAdvance\"\n                    @change=\"onSelectAdvanceChange\"\n                    :class=\"sale('dropdown')\"\n                    slot=\"overlay\"\n                  >\n                    <a-menu>\n                      <a-menu-item @click=\"onSelectAdvance\">\n                        <a-radio :value=\"-1\">不使用</a-radio>\n                      </a-menu-item>\n                      <a-menu-item\n                        @click=\"onSelectAdvance\"\n                        :key=\"index\"\n                        v-for=\"(item, index) in advanceList\"\n                      >\n                        <a-radio :value=\"item.id\">\n                          定金 {{ item.price }}\n                        </a-radio>\n                      </a-menu-item>\n                    </a-menu>\n                  </a-radio-group>\n                </a-dropdown>\n              </div>\n            </div>\n          </st-form-item>\n          <st-form-item labelGutter=\"12px\" label=\"减免金额\">\n            <st-input-number\n              v-model=\"reduceAmount\"\n              :float=\"true\"\n              placeholder=\"请输入\"\n            >\n              <span slot=\"addonAfter\">元</span>\n            </st-input-number>\n          </st-form-item>\n          <st-form-item\n            labelGutter=\"12px\"\n            validateStatus=\"error\"\n            :help=\"orderAmountText\"\n            class=\"mg-b0\"\n            label=\"小计\"\n          >\n            <span class=\"total\">{{ priceInfo }}元</span>\n          </st-form-item>\n        </div>\n        <div :class=\"sale('remarks')\">\n          <st-form-item labelGutter=\"12px\" label=\"销售人员\" required>\n            <a-select\n              v-decorator=\"decorators.saleName\"\n              placeholder=\"选择签单的工作人员\"\n            >\n              <a-select-option\n                v-for=\"(item, index) in saleList\"\n                :key=\"index\"\n                :value=\"item.id\"\n              >\n                {{ item.staff_name }}\n              </a-select-option>\n            </a-select>\n          </st-form-item>\n          <st-form-item labelGutter=\"12px\" label=\"备注\" class=\"mg-b0\">\n            <a-textarea\n              v-model=\"description\"\n              :autosize=\"{ minRows: 4, maxRows: 6 }\"\n            />\n          </st-form-item>\n        </div>\n      </st-form>\n    </div>\n    <template slot=\"footer\">\n      <div :class=\"sale('footer')\">\n        <div class=\"price\">\n          <span>{{ priceInfo }}元</span>\n          <span>订单总额：{{ cardPrice }}元</span>\n        </div>\n        <div class=\"button\">\n          <st-button @click=\"onCreateOrder\" :loading=\"loading.renewal\">\n            创建订单\n          </st-button>\n          <st-button\n            @click=\"onPay\"\n            :loading=\"loading.renewalPay\"\n            type=\"primary\"\n          >\n            立即支付\n          </st-button>\n        </div>\n      </div>\n    </template>\n  </st-modal>\n</template>\n\n<script>\nimport { RenewalMemberService } from './renewal-member.service'\nimport moment from 'moment'\nimport { cloneDeep } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { ruleOptions } from './renewal-member.config'\nimport autoContractBtn from '@/views/biz-components/contract/auto-contract-btn.vue'\nexport default {\n  name: 'ModalSoldRenewalMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  serviceProviders() {\n    return [RenewalMemberService]\n  },\n  serviceInject() {\n    return {\n      renewalMemberService: RenewalMemberService\n    }\n  },\n  components: {\n    autoContractBtn\n  },\n  rxState() {\n    return {\n      loading: this.renewalMemberService.loading$,\n      couponList: this.renewalMemberService.couponList$,\n      advanceList: this.renewalMemberService.advanceList$,\n      priceInfo: this.renewalMemberService.priceInfo$,\n      saleList: this.renewalMemberService.saleList$,\n      info: this.renewalMemberService.info$\n    }\n  },\n  props: ['id'],\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      // 规格\n      selectSpecs: 1,\n      // 时间\n      startTime: null,\n      endTime: '',\n      // 赠送\n      giftAmount: null,\n      // 优惠\n      couponDropdownVisible: false,\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      selectCoupon: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      // 减免金额\n      reduceAmount: null,\n      // 描述\n      description: ''\n    }\n  },\n  created() {\n    this.renewalMemberService.serviceInit(this.id).subscribe(res => {\n      // 获取优惠券\n      this.renewalMemberService\n        .getCouponList({\n          member_id: res[0].info.member_id,\n          card_id: res[0].info.card_id,\n          specs_id: res[0].info.specs[0].id\n        })\n        .subscribe()\n      // 获取定金\n      this.renewalMemberService\n        .getAdvanceList(res[0].info.member_id)\n        .subscribe()\n      // 规格\n      this.selectSpecs = res[0].info.specs[0].id\n      this.form.setFieldsValue({\n        startTime: moment(res[0].info.default_start_time * 1000)\n      })\n      // 实付金额\n      this.getPrice('', 0, '', res[0].info.specs[0].id)\n      this.startTime = cloneDeep(moment(res[0].info.default_start_time * 1000))\n      this.endTime = moment(res[0].info.default_start_time * 1000)\n        .add(res[0].info.specs[0].valid_time, 'd')\n        .format('YYYY-MM-DD HH:mm')\n    })\n  },\n  watch: {\n    selectSpecs(newVal, oldVal) {\n      this.getPrice(\n        this.selectAdvance,\n        +this.reduceAmount,\n        this.selectCoupon,\n        newVal\n      )\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(\n          newVal,\n          +this.reduceAmount,\n          this.selectCoupon,\n          this.selectSpecs\n        )\n      }\n    },\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(\n          this.selectAdvance,\n          +this.reduceAmount,\n          newVal,\n          this.selectSpecs\n        )\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(\n        this.selectAdvance,\n        +newVal,\n        this.selectCoupon,\n        this.selectSpecs\n      )\n    }\n  },\n  computed: {\n    // 商品价格\n    cardPrice() {\n      if (this.info.specs) {\n        const arr = this.info.specs.filter(i => i.id === this.selectSpecs)\n        if (arr.length > 0) {\n          return arr[0].price\n        }\n        return '0'\n      }\n      return '0'\n    },\n    orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : ''\n    },\n    isFamilyCard() {\n      return this.info.card_number_type === 2\n    }\n  },\n  methods: {\n    moment,\n    // 规格\n    onSpecsChange(data) {\n      let item = this.info.specs.filter(i => i.id === data.target.value)[0]\n      let s = cloneDeep(this.startTime)\n      let dayScope = item.valid_time\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm')\n      // 获取优惠券\n      this.renewalMemberService\n        .getCouponList({\n          member_id: this.info.member_id,\n          card_id: this.info.card_id,\n          specs_id: item.id\n        })\n        .subscribe(res => {\n          this.resetCoupon()\n        })\n    },\n    // 时间\n    disabledStartDate(startTime) {\n      return startTime.valueOf() < this.info.default_start_time * 1000\n    },\n    onStartTimeChange(data) {\n      this.startTime = cloneDeep(data)\n      let s = cloneDeep(data)\n      let dayScope = this.info.specs.filter(i => i.id === this.selectSpecs)[0]\n        .valid_time\n      this.endTime = s.add(dayScope, 'd').format('YYYY-MM-DD HH:mm')\n    },\n    // 合同\n    onCodeNumber() {\n      this.renewalMemberService\n        .getCodeNumber(this.info.contract_type)\n        .subscribe(res => {\n          this.form.setFieldsValue({\n            contractNumber: res.info.code\n          })\n        })\n    },\n    // 优惠\n    onSelectCouponChange(data) {\n      if (data.target.value === -1) {\n        this.couponAmount = ''\n        this.couponText = '未选择优惠券'\n        return\n      }\n      let price = this.couponList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.couponAmount = price\n      this.couponText = `${price}元`\n    },\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    resetCoupon() {\n      this.renewalMemberService.resetCouponList()\n      this.couponText = '未选择优惠券'\n      this.couponAmount = ''\n      this.selectcoupon = ''\n    },\n    // 定金\n    onSelectAdvanceChange(data) {\n      if (data.target.value === -1) {\n        this.advanceAmount = ''\n        this.advanceText = '未选择定金'\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    resetAdvance() {\n      this.renewalMemberService.resetAdvanceList()\n      this.advanceText = '未选择定金'\n      this.advanceAmount = ''\n      this.selectAdvance = ''\n    },\n    // 计算实付金额\n    getPrice(advance, reduce, coupon, specs_id) {\n      let advanceId = advance === -1 ? '' : advance\n      let couponId = coupon === -1 ? '' : coupon\n      this.renewalMemberService.priceAction$.dispatch({\n        id: this.id,\n        product_id: this.info.card_id,\n        product_type: this.info.contract_type,\n        specs_id,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        coupon_id: couponId,\n        member_id: this.info.member_id\n      })\n    },\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : undefined\n        this.renewalMemberService\n          .renewal(\n            {\n              contract_number: values.contractNumber,\n              rule_id: this.selectSpecs,\n              valid_start_time: moment(values.startTime).format(\n                'YYYY-MM-DD HH:mm'\n              ),\n              gift_amount: +this.giftAmount,\n              user_coupon_id:\n                this.selectCoupon === -1 ? undefined : +this.selectCoupon,\n              advance_id:\n                this.selectAdvance === -1 ? undefined : this.selectAdvance,\n              reduce_price: reduce_amount,\n              description: this.description,\n              staff_sale_id: +values.saleName,\n              contract_type: this.info.contract_type,\n              discounts_price: +this.info.specs.filter(\n                i => i.id === this.selectSpecs\n              )[0].price\n            },\n            this.id\n          )\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'create',\n              orderId: res.info.order_id,\n              soldId: res.info.sold_id,\n              isFamilyCard: this.isFamilyCard\n            })\n          })\n      })\n    },\n    onPay() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : undefined\n        this.renewalMemberService\n          .renewalPay(\n            {\n              contract_number: values.contractNumber,\n              rule_id: this.selectSpecs,\n              valid_start_time: moment(values.startTime).format(\n                'YYYY-MM-DD HH:mm'\n              ),\n              gift_amount: +this.giftAmount,\n              user_coupon_id:\n                this.selectCoupon === -1 ? undefined : +this.selectCoupon,\n              advance_id:\n                this.selectAdvance === -1 ? undefined : this.selectAdvance,\n              reduce_price: reduce_amount,\n              description: this.description,\n              staff_sale_id: +values.saleName,\n              contract_type: this.info.contract_type,\n              discounts_price: +this.info.specs.filter(\n                i => i.id === this.selectSpecs\n              )[0].price\n            },\n            this.id\n          )\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: res.info.order_id,\n              soldId: res.info.sold_id,\n              isFamilyCard: this.isFamilyCard\n            })\n          })\n      })\n    }\n  }\n}\n</script>\n"]}]}