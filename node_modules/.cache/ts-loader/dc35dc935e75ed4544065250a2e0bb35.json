{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js??ref--13-3!/Users/wangzhigang/Desktop/styd/web/src/services/shs.service.ts","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/services/shs.service.ts","mtime":1596188219479},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js","mtime":1591062571609}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.typed.uint8-array\";\nimport \"core-js/modules/es6.regexp.split\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport _classCallCheck from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar _a, _b, _c, _d;\n\nimport { __decorate, __metadata } from \"tslib\";\nimport { State } from 'rx-state';\nimport { OssService } from \"./oss.service\";\nimport { Injectable } from 'vue-service-app';\nimport { AppConfig } from '@/constants/config';\nimport { HttpService } from \"./http.service\";\nimport { tap, switchMap } from 'rxjs/operators';\nimport { Observable } from 'rxjs';\nimport { NotificationService } from \"./notification.service\";\n/**\n * shs相关服务\n */\n\nvar ShsService = /*#__PURE__*/function () {\n  function ShsService(ossService, http, appConfig, notification) {\n    _classCallCheck(this, ShsService);\n\n    this.ossService = ossService;\n    this.http = http;\n    this.appConfig = appConfig;\n    this.notification = notification;\n    /**\n     * 是否处于加载过程\n     */\n\n    this.token$ = new State('');\n    this.loading$ = new State(true);\n  }\n  /**\n   * 处理图片\n   */\n\n\n  _createClass(ShsService, [{\n    key: \"getShsImage\",\n    value: function getShsImage(params) {\n      var _this = this;\n\n      var shsUrl = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '/saas/poster';\n      return this.getToken().pipe( // switchMap(() => {\n      //   return this.ossService.put({\n      //     business: 'image',\n      //     isPrivate: false,\n      //     file: this.convertBase64UrlToBlob(params.qrcode_url)\n      //   })\n      // }),\n      switchMap(function () {\n        return _this.http.originalPost(\"\".concat(_this.appConfig.SHS_API_ENV).concat(shsUrl), _objectSpread({}, params, {\n          token: _this.token$.snapshot()\n        }));\n      }), switchMap(function (res) {\n        console.log(res);\n        var imageUrl = \"\".concat(_this.appConfig.SHS_API_ENV).concat(res.response.data.url);\n        return _this.loadImage(imageUrl);\n      }));\n    }\n  }, {\n    key: \"loadImage\",\n    value: function loadImage(url) {\n      var _this2 = this;\n\n      this.loading$.commit(function () {\n        return true;\n      });\n      return new Observable(function (observer) {\n        var _img = new Image();\n\n        _img.src = url;\n\n        _img.onload = function () {\n          observer.next(url);\n\n          _this2.loading$.commit(function () {\n            return false;\n          });\n\n          observer.complete();\n        };\n\n        _img.onerror = function (e) {\n          _this2.loading$.commit(function () {\n            return false;\n          });\n\n          observer.error(e);\n          observer.complete();\n        };\n      });\n    }\n    /**\n     * 将base64位生成blob\n     * @param urlData\n     */\n\n  }, {\n    key: \"convertBase64UrlToBlob\",\n    value: function convertBase64UrlToBlob(urlData) {\n      if (!urlData) {\n        this.notification.error({\n          title: '海报',\n          content: 'is not qrcode url'\n        });\n      }\n\n      var bytes = window.atob(urlData.split(',')[1]);\n      var ab = new ArrayBuffer(bytes.length);\n      var ia = new Uint8Array(ab);\n\n      for (var i = 0; i < bytes.length; i++) {\n        ia[i] = bytes.charCodeAt(i);\n      }\n\n      return new Blob([ab], {\n        type: 'image/png'\n      });\n    }\n    /**\n     * 获取shs token\n     */\n\n  }, {\n    key: \"getToken\",\n    value: function getToken() {\n      var _this3 = this;\n\n      return this.http.originalPost(\"\".concat(this.appConfig.SHS_API_ENV, \"/user/token\")).pipe(tap(function (res) {\n        _this3.token$.commit(function () {\n          return res.response.data.token;\n        });\n      }));\n    }\n  }]);\n\n  return ShsService;\n}();\n\nShsService = __decorate([Injectable(), __metadata(\"design:paramtypes\", [typeof (_a = typeof OssService !== \"undefined\" && OssService) === \"function\" ? _a : Object, typeof (_b = typeof HttpService !== \"undefined\" && HttpService) === \"function\" ? _b : Object, typeof (_c = typeof AppConfig !== \"undefined\" && AppConfig) === \"function\" ? _c : Object, typeof (_d = typeof NotificationService !== \"undefined\" && NotificationService) === \"function\" ? _d : Object])], ShsService);\nexport { ShsService };",null]}