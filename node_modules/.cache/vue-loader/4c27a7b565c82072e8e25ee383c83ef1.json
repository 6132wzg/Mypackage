{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/course/package/upgrade.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/course/package/upgrade.vue","mtime":1594718340033},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport moment from 'moment'\nimport { UpgradeService } from './upgrade.service.ts'\nimport { cloneDeep, get } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport BizSoldCourseInfo from '@/views/biz-components/sold/cource-info.vue'\nimport { ruleOptions } from './upgrade.config'\nimport { PatternService } from '@/services/pattern.service'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nimport MemberSearch from '@/views/biz-components/member-search/member-search'\nimport SelectScroll from '@/views/biz-components/select-scroll/select-scroll'\n\nexport default {\n  name: 'ModalSoldDealSaleMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber,\n    BizSoldCourseInfo,\n    SelectScroll\n  },\n  serviceProviders() {\n    return [UpgradeService]\n  },\n  serviceInject() {\n    return {\n      upgradeService: UpgradeService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    const {\n      info$,\n      packageOptions$,\n      loading$,\n      newPackageInfo$,\n      effectiveWayOptions$,\n      couponList$,\n      advanceList$,\n      currentPrice$,\n      saleList$\n    } = this.upgradeService\n    return {\n      loading$,\n      info$,\n      newPackageInfo$,\n      advanceList$,\n      couponList$,\n      effectiveWayOptions$,\n      saleList$,\n      currentPrice$,\n      packageOptions$\n    }\n  },\n  props: {\n    id: {\n      type: Number\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      isTeamDisable: true,\n      isPersonalDisabled: true,\n      isValidDaysDisable: true,\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      deductionAmount: '',\n      description: '',\n      // 优惠券\n      selectCoupon: '',\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      couponDropdownVisible: false,\n      isExpire: 1,\n      product_id: '',\n      couponList: []\n    }\n  },\n  computed: {\n    validDate() {\n      return `${moment().format('YYYY-MM-DD')}~${moment()\n        .add(this.newPackageInfo$.valid_time, 'days')\n        .format('YYYY-MM-DD')}`\n    },\n    canChoseCoupon() {\n      let len = this.couponList$.length\n      return !!len\n    },\n    canChoseAdvance() {\n      let len = this.advanceList$.length\n      return (this.id || this.product_id) && len\n    },\n    orderAmountText() {\n      return this.currentPrice < 0 ? '小计不能为负' : ''\n    },\n    saleRangeType() {\n      return get(this.info.sale_range, 'type', 1)\n    },\n    hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}'\n    }\n  },\n  watch: {\n    selectCoupon: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(newVal, this.selectAdvance, +this.deductionAmount)\n      }\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(this.selectCoupon, newVal, +this.deductionAmount)\n      }\n    },\n    deductionAmount(newVal, oldVal) {\n      this.getPrice(this.selectCoupon, this.selectAdvance, +newVal)\n    }\n  },\n  mounted() {\n    this.upgradeService.init(this.id).subscribe(res => {\n      console.log('初始化页面完成')\n    })\n  },\n  methods: {\n    moment,\n    getDeductionAmount(value) {\n      console.log(event)\n      this.deductionAmount = value\n    },\n    // 选择课,筛选\n    handleSelect(val) {\n      this.product_id = val\n      this.onResetDiscounts()\n      this.handleGetCourseInfo(val)\n    },\n    // 选择课,搜索\n    handleSearch(keywords) {\n      this.handleGetList(keywords)\n    },\n    onChangeEffectiveWay(e) {\n      console.log(e.target.value)\n      this.isExpire = e.target.value\n    },\n    onClickTeamConfirm() {\n      this.isTeamDisable = !this.isTeamDisable\n    },\n    onClickPersonalConfirm() {\n      this.isPersonalDisabled = !this.isPersonalDisabled\n    },\n    onClickValidDaysConfirm() {\n      this.isValidDaysDisable = !this.isValidDaysDisable\n    },\n    onResetDiscounts() {\n      console.log('onResetDiscounts')\n      // 重置优惠券及定金选择\n      this.resetCoupon()\n      this.resetAdvance()\n    },\n    // 重新获取优惠券及定金\n    onReGetDiscounts(data) {\n      console.log('onReGetDiscounts')\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      this.fetchAdvanceList(data)\n      this.fetchCouponList(data)\n    },\n    onMemberChange(data) {\n      // 重置优惠券及定金选择\n      this.onResetDiscounts()\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      if (data) this.onReGetDiscounts(data)\n    },\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    onSelectCoupon() {\n      timer(200).subscribe(() => {\n        this.couponDropdownVisible = false\n      })\n    },\n    // 重置定金选择\n    resetAdvance() {\n      this.advanceList = []\n      this.advanceText = '未选择定金'\n      this.selectAdvance = ''\n      this.advanceAmount = ''\n    },\n    // 重置优惠券选择\n    resetCoupon() {\n      this.upgradeService.REST_COUPONLIST()\n      this.couponText = '未选择优惠券'\n      this.selectCoupon = ''\n      this.couponAmount = ''\n    },\n    onCancel() {\n      this.resetAdvance()\n    },\n    onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0\n        this.advanceText = `未选择定金`\n        return\n      }\n      let price = this.advanceList$.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    onSelectCouponChange(event) {\n      let id = get(event.target.value, 'id', '')\n      if (id) {\n        let price = this.couponList$.filter(o => o.id === id)[0].price\n        this.couponAmount = price\n        this.couponText = `${price}元`\n      } else {\n        this.resetCoupon()\n      }\n    },\n    // 计算实付金额\n    getPrice(coupon, advance, reduce) {\n      const memberId = this.info$.member_id\n      const product_id = this.newPackageInfo$.product_id || undefined\n      // 1会员卡 2 私教课程 3 课程包 4储值卡 5 储物柜租赁\n      this.upgradeService\n        .getPrice({\n          product_id,\n          product_type: 3,\n          coupon_id: coupon ? coupon.id : undefined,\n          member_id: memberId || undefined,\n          advance_id: advance || undefined,\n          reduce_amount: reduce || undefined\n        })\n        .subscribe(res => {\n          console.log(res)\n        })\n    },\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        const form = cloneDeep(values)\n        form.package_id = form.productId\n        form.personal_times = +form.personal_times\n        form.team_times = +form.team_times\n        form.contract_number = this.info$.contract_number\n        delete form.productId\n        this.upgradeService\n          .upgrade({\n            id: this.info$.id,\n            ...form,\n            member_id: this.info$.member_id\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'create',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    onPay() {\n      this.form.validate().then(values => {\n        const form = cloneDeep(values)\n        form.package_id = form.productId\n        form.personal_times = +form.personal_times\n        form.team_times = +form.team_times\n        form.contract_number = this.info$.contract_number\n        delete form.productId\n        console.log(form, this.info$.member_id)\n        this.upgradeService\n          .upgrade({\n            id: this.info$.id,\n            ...form,\n            member_id: this.info$.member_id\n          })\n          .subscribe(result => {\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: result.info.order_id\n            })\n            this.show = false\n          })\n      })\n    },\n    // 获取课程列表\n    handleGetList(keyword) {\n      // if (this.finished) return false\n      this.upgradeService\n        .getUpgradePackageList({\n          keyword\n        })\n        .subscribe()\n    },\n    // 获取课程详情\n    handleGetCourseInfo(productId) {\n      this.upgradeService.getNewUpgradePackageInfo(productId).subscribe(res => {\n        this.$nextTick().then(() => {\n          this.form.setFieldsValue({\n            productId,\n            team_times: res.info.team_times,\n            personal_times: res.info.personal_times,\n            valid_days: res.info.valid_time\n          })\n        })\n      })\n    },\n    // 获取优惠券列表\n    fetchCouponList(id) {\n      const package_id = this.form.getFieldValue('productId') || undefined\n      const member_id = this.form.getFieldValue('member_id') || id\n      if (package_id && member_id) {\n        const params = {\n          member_id,\n          package_id\n        }\n        this.upgradeService.getCouponList(params).subscribe()\n      }\n    },\n    // 获取定金列表\n    fetchAdvanceList(id) {\n      let member_id = this.form.getFieldValue('member_id') || id\n      if (member_id) {\n        this.upgradeService.getAdvanceList(member_id).subscribe(res => {\n          this.advanceList$ = cloneDeep(res.list)\n        })\n      }\n    }\n  }\n}\n",null]}