{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js??ref--13-2!/Users/wangzhigang/Desktop/styd/web/src/services/oss.service.ts","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/services/oss.service.ts","mtime":1591147717087},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/ts-loader/index.js","mtime":1591062571609}],"contextDependencies":[],"result":["import \"core-js/modules/es6.reflect.construct\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es7.array.includes\";\nimport \"core-js/modules/es6.string.includes\";\nimport _classCallCheck from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\nimport _possibleConstructorReturn from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/getPrototypeOf\";\nimport _inherits from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/inherits\";\n\nfunction _createSuper(Derived) { return function () { var Super = _getPrototypeOf(Derived), result; if (_isNativeReflectConstruct()) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nimport { __decorate } from \"tslib\";\nimport { Injectable } from 'vue-service-app';\nimport { Subject } from 'rxjs';\nimport { ajax } from 'rxjs/ajax';\nimport { mergeMap, map } from 'rxjs/operators';\nimport { Api } from '@/api/api';\nvar typeSuffix = {\n  'image/png': '.png'\n};\n\nvar OssService = /*#__PURE__*/function (_Api) {\n  _inherits(OssService, _Api);\n\n  var _super = _createSuper(OssService);\n\n  function OssService() {\n    var _this;\n\n    _classCallCheck(this, OssService);\n\n    _this = _super.apply(this, arguments);\n    _this.BUSINESS_TYPES = ['image', 'face', 'file', 'excel'];\n    _this.typeSuffix = [{\n      type: 'image/png',\n      suffix: '.png'\n    }];\n    return _this;\n  }\n\n  _createClass(OssService, [{\n    key: \"put\",\n    value: function put(_ref) {\n      var _this2 = this;\n\n      var file = _ref.file,\n          _ref$business = _ref.business,\n          business = _ref$business === void 0 ? '' : _ref$business,\n          _ref$uploadProgress = _ref.uploadProgress,\n          uploadProgress = _ref$uploadProgress === void 0 ? function () {} : _ref$uploadProgress,\n          _ref$isPrivate = _ref.isPrivate,\n          isPrivate = _ref$isPrivate === void 0 ? false : _ref$isPrivate;\n\n      if (!this.BUSINESS_TYPES.includes(business)) {\n        throw new Error(\"[oss.service] \\u4E0A\\u4F20\\u6587\\u4EF6\\u5FC5\\u987B\\u4F7F\\u7528\\u4E1A\\u52A1\\u7C7B\\u578B \".concat(this.BUSINESS_TYPES, \" \\u4E4B\\u4E00\"));\n      }\n\n      return this.getOssPolicy(business, isPrivate).pipe(mergeMap(function (_ref2) {\n        var res = _ref2.policy_info;\n\n        var key = _this2.getKey(file);\n\n        var formData = new FormData();\n        var fileKey = \"\".concat(res.dir).concat(key);\n        formData.append('key', fileKey);\n        formData.append('policy', res.policy);\n        formData.append('OSSAccessKeyId', res.accessid);\n        formData.append('success_action_status', '200');\n        formData.append('signature', res.signature);\n        formData.append('file', file);\n        var i = formData.entries();\n        var sub = new Subject();\n        var put$ = ajax({\n          url: res.host,\n          body: formData,\n          method: 'post',\n          crossDomain: true,\n          progressSubscriber: sub\n        });\n        sub.subscribe(function (val) {\n          uploadProgress(val);\n        });\n        var resData = {\n          fileName: file.name,\n          fileKey: fileKey,\n          host: res.host,\n          url: isPrivate ? URL.createObjectURL(file) : res.host + '/' + fileKey\n        };\n        return put$.pipe(map(function (val) {\n          return resData;\n        }));\n      }));\n    }\n  }, {\n    key: \"getOssPolicy\",\n    value: function getOssPolicy(business, isPrivate) {\n      return this.http.get(\"/upload/policy\", {\n        query: {\n          business: business,\n          acl: isPrivate ? 'private' : 'public-read-write'\n        }\n      });\n    }\n  }, {\n    key: \"getFileSuffix\",\n    value: function getFileSuffix(file) {\n      if (file.name) {\n        var lastDotIndex = file.name.lastIndexOf('.');\n        return file.name.slice(lastDotIndex);\n      } else {\n        return '.' + file.type.split('/')[1];\n      }\n    }\n  }, {\n    key: \"getKey\",\n    value: function getKey(file) {\n      var suffix = this.getFileSuffix(file);\n      var fileName = '';\n\n      if (file.name) {\n        fileName = file.name.replace(/[?\\s%<>&#\\\\:]/g, '').replace(suffix, '');\n      }\n\n      if (suffix === '.xlsx' || suffix === '.xls' || suffix === '.csv') {\n        return \"import__\".concat(fileName, \"___\").concat(Math.random().toString(16).slice(3), \"___\").concat(suffix);\n      }\n\n      return \"\".concat(fileName, \"___\").concat(Math.random().toString(16).slice(3), \"___\").concat(suffix);\n    }\n    /**\n     * 下载文件方法\n     * @param url 下载的url\n     */\n\n  }, {\n    key: \"downloadFile\",\n    value: function downloadFile(url) {\n      var filename = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'download.xlsx';\n      var a = document.createElement('a');\n      a.href = url;\n      a.target = '_blank';\n      a.download = filename;\n      a.click();\n    }\n    /**\n     * 打开新的tab标签页\n     * @param url 打开的url\n     */\n\n  }, {\n    key: \"openNewTab\",\n    value: function openNewTab(url) {\n      // const a = document.createElement('a')\n      // a.href = url\n      // a.target = '_blank'\n      // a.click()\n      window.open(url);\n    }\n  }]);\n\n  return OssService;\n}(Api);\n\nOssService = __decorate([Injectable()], OssService);\nexport { OssService };",{"version":3,"sources":["/Users/wangzhigang/Desktop/styd/web/src/services/oss.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from 'vue-service-app'\nimport { Subject } from 'rxjs'\nimport { ajax } from 'rxjs/ajax'\nimport { mergeMap, map } from 'rxjs/operators'\nimport { Api } from '@/api/api'\n\nconst typeSuffix = {\n  'image/png': '.png'\n}\n\n/**\n * http://showdoc.corp.rrr.me/web/#/9?page_id=457\n */\ninterface PutOptions {\n  /**\n   * 上传的文件\n   */\n  file: any\n  /**\n   * 上传的文件业务类型，当前可用类型为 image | face | file\n   */\n  business: string\n  /**\n   * 上传进度cb\n   */\n  uploadProgress?: (val: any) => any\n  /**\n   * 是否使用私有oss空间\n   */\n  isPrivate?: boolean\n}\n@Injectable()\nexport class OssService extends Api {\n  BUSINESS_TYPES = ['image', 'face', 'file', 'excel']\n  typeSuffix = [\n    {\n      type: 'image/png',\n      suffix: '.png'\n    }\n  ]\n  put({\n    file,\n    business = '',\n    uploadProgress = () => {},\n    isPrivate = false\n  }: PutOptions) {\n    if (!this.BUSINESS_TYPES.includes(business)) {\n      throw new Error(\n        `[oss.service] 上传文件必须使用业务类型 ${this.BUSINESS_TYPES} 之一`\n      )\n    }\n    return this.getOssPolicy(business, isPrivate).pipe(\n      mergeMap(({ policy_info: res }: any) => {\n        let key = this.getKey(file)\n        let formData = new FormData()\n        const fileKey = `${res.dir}${key}`\n        formData.append('key', fileKey)\n        formData.append('policy', res.policy)\n        formData.append('OSSAccessKeyId', res.accessid)\n        formData.append('success_action_status', '200')\n        formData.append('signature', res.signature)\n        formData.append('file', file)\n        let i = formData.entries()\n        const sub: any = new Subject()\n        const put$ = ajax({\n          url: res.host,\n          body: formData,\n          method: 'post',\n          crossDomain: true,\n          progressSubscriber: sub\n        })\n        sub.subscribe((val: any) => {\n          uploadProgress(val)\n        })\n        let resData = {\n          fileName: file.name,\n          fileKey,\n          host: res.host,\n          url: isPrivate ? URL.createObjectURL(file) : res.host + '/' + fileKey\n        }\n        return put$.pipe(map(val => resData))\n      })\n    )\n  }\n  private getOssPolicy(business: string, isPrivate: boolean) {\n    return this.http.get(`/upload/policy`, {\n      query: {\n        business,\n        acl: isPrivate ? 'private' : 'public-read-write'\n      }\n    })\n  }\n\n  private getFileSuffix(file: File): string {\n    if (file.name) {\n      const lastDotIndex = file.name.lastIndexOf('.')\n      return file.name.slice(lastDotIndex)\n    } else {\n      return '.' + file.type.split('/')[1]\n    }\n  }\n  private getKey(file: File): string {\n    const suffix = this.getFileSuffix(file)\n    let fileName = ''\n    if (file.name) {\n      fileName = file.name.replace(/[?\\s%<>&#\\\\:]/g, '').replace(suffix, '')\n    }\n    if (suffix === '.xlsx' || suffix === '.xls' || suffix === '.csv') {\n      return `import__${fileName}___${Math.random()\n        .toString(16)\n        .slice(3)}___${suffix}`\n    }\n    return `${fileName}___${Math.random()\n      .toString(16)\n      .slice(3)}___${suffix}`\n  }\n  /**\n   * 下载文件方法\n   * @param url 下载的url\n   */\n  downloadFile(url: string, filename: string = 'download.xlsx') {\n    const a = document.createElement('a')\n    a.href = url\n    a.target = '_blank'\n    a.download = filename\n    a.click()\n  }\n  /**\n   * 打开新的tab标签页\n   * @param url 打开的url\n   */\n  openNewTab(url: string) {\n    // const a = document.createElement('a')\n    // a.href = url\n    // a.target = '_blank'\n    // a.click()\n    window.open(url)\n  }\n}\n"],"sourceRoot":""}]}