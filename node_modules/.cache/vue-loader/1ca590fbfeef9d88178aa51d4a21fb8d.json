{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/setting/mina/components#/h5/h5-setting-index.component.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/setting/mina/components#/h5/h5-setting-index.component.vue","mtime":1598250255840},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { cloneDeep, omit } from 'lodash-es'\nimport H5ModuleComponent from './h5-module.component'\nimport h5ShopListComponent from './h5-shop-list.component'\nimport h5PhoneComponent from './h5-phone.component'\nimport { H5SettingIndexService } from './h5-setting-index.service'\nimport { swiper, swiperSlide } from 'vue-awesome-swiper'\nimport draggable from 'vuedraggable'\nimport BrandSettingMinaCheckoutShopinfoLayout from '@/views/biz-modals/brand/setting/mina/checkout-shopinfo-layout'\n\nimport h5FormShopinfoComponent from './form-components#/h5-form.shopinfo.component'\nimport h5FormFnComponent from './form-components#/h5-form.fn.component'\nimport h5FormCoachComponent from './form-components#/h5-form.coach.component'\nimport h5FormCardComponent from './form-components#/h5-form.card.component'\nimport h5FormCourseComponent from './form-components#/h5-form.course.component'\nimport h5FormPackageComponent from './form-components#/h5-form.package.component'\nimport h5FormCouponComponent from './form-components#/h5-form.coupon.component'\nimport h5FormInvitationComponent from './form-components#/h5-form.invitation.component'\nimport h5FormTurntableComponent from './form-components#/h5-form.turntable.component'\nimport h5FormActivityComponent from './form-components#/h5-form.activity.component'\nimport h5FormGroupComponent from './form-components#/h5-form.group.component'\nimport { MessageService } from '@/services/message.service'\n\nexport default {\n  name: 'H5SettingIndexComponent',\n  components: {\n    H5ModuleComponent,\n    h5PhoneComponent,\n    h5ShopListComponent,\n    swiper,\n    swiperSlide,\n    h5FormShopinfoComponent,\n    h5FormFnComponent,\n    h5FormCoachComponent,\n    h5FormCardComponent,\n    h5FormCourseComponent,\n    h5FormPackageComponent,\n    h5FormCouponComponent,\n    h5FormInvitationComponent,\n    h5FormTurntableComponent,\n    h5FormActivityComponent,\n    h5FormGroupComponent,\n    draggable\n  },\n  bem: {\n    h5: 'h5-setting-index-component'\n  },\n  modals: {\n    BrandSettingMinaCheckoutShopinfoLayout\n  },\n  serviceInject() {\n    return {\n      messageService: MessageService,\n      h5SettingIndexService: H5SettingIndexService\n    }\n  },\n  rxState() {\n    return {\n      shopList: this.h5SettingIndexService.shopList$,\n      currentShopInfo: this.h5SettingIndexService.currentShopInfo$,\n      fnModules: this.h5SettingIndexService.fnModules$,\n      modulesData: this.h5SettingIndexService.modulesData$,\n      marketingModules: this.h5SettingIndexService.marketingModules$,\n      loading: this.h5SettingIndexService.loading$\n    }\n  },\n  computed: {\n    moduleType: function() {\n      return (\n        this.modulesData[this.sliderIndex] && this.modulesData[this.sliderIndex]\n      )\n    }\n  },\n  data() {\n    return {\n      draggableOptions: {},\n      shopId: '',\n      shopActiveIndex: 0,\n      sliderIndex: 0,\n      phoneIndex: 0,\n      componentList: {\n        1: 'h5FormShopinfoComponent',\n        2: 'h5FormFnComponent',\n        3: 'h5FormCoachComponent',\n        4: 'h5FormCardComponent',\n        5: 'h5FormCourseComponent',\n        6: 'h5FormPackageComponent',\n        12: 'h5FormCouponComponent',\n        13: 'h5FormInvitationComponent',\n        14: 'h5FormTurntableComponent',\n        15: 'h5FormActivityComponent',\n        16: 'h5FormGroupComponent'\n      },\n      isEditFlag: false,\n      canDrag: true\n    }\n  },\n  created() {\n    this.init()\n  },\n  mounted() {},\n  watch: {\n    sliderIndex(newVal) {\n      if (this.$refs.leftModules) {\n        this.$refs.leftModules.scrollTop = newVal * 72\n      }\n    }\n  },\n  methods: {\n    init() {\n      this.h5SettingIndexService.getShopList().subscribe(res => {\n        if (!!res.list.length) {\n          this.getModuleDataAndShopInfo(res.list[0].shop_id)\n        }\n      })\n    },\n\n    // 添加模块\n    selectModule(item) {\n      let showModuleList = this.modulesData.filter(item => {\n        return +!item.module_is_delete\n      })\n      if (showModuleList.length === 15) {\n        return this.messageService.warn({\n          content:\n            '小程序最多可添加15个功能模块，当前已达数量上限，请在删除模块后再行添加'\n        })\n      }\n      let moduleItem = cloneDeep(item)\n      this.modulesData.push(moduleItem)\n      this.editEmit()\n      setTimeout(() => {\n        this.setIndex(this.modulesData.length - 1)\n      })\n    },\n    // 门店信息模块切换样式\n    shopDetailChange() {\n      this.$modalRouter.push({\n        name: 'brand-setting-mina-checkout-shopinfo-layout',\n        props: {\n          layout: this.modulesData[0].content.show_style\n        },\n        on: {\n          success: e => {\n            this.editEmit()\n            this.modulesData[0].content.show_style = e\n          }\n        }\n      })\n    },\n    // 操作了模块\n    moduleItemChange(module, index) {\n      this.modulesData.splice(index, 1, cloneDeep(module))\n      this.editEmit()\n    },\n    // 删除模块\n    deleteModuleItem(module, index) {\n      this.editEmit()\n      if (+!this.modulesData[index].module_id) {\n        // 新模块module_id为0\n        this.modulesData.splice(index, 1)\n      } else {\n        this.modulesData.splice(index, 1, cloneDeep(module))\n      }\n      console.log(this.modulesData)\n      let remainingModules = this.modulesData.slice(index + 1)\n      let moduleNoDelete = []\n      if (remainingModules.length) {\n        remainingModules.forEach(item => {\n          if (+!item.module_is_delete) {\n            moduleNoDelete.push(item)\n          }\n        })\n      }\n      if (moduleNoDelete.length > 0) {\n        // 向下查找到没有删除的\n        let i = index + 1\n        let num = 1\n        while (this.modulesData[i].module_is_delete) {\n          i++\n          num++\n        }\n        this.sliderIndex = i\n        this.phoneIndex = i - num\n      } else {\n        // 向上查找到没有删除的\n        let i = index - 1\n        while (this.modulesData[i].module_is_delete) {\n          i--\n        }\n        this.setIndex(i)\n      }\n    },\n    // 拖拽模块\n    dragModule(e) {\n      this.setIndex(e.moved.newIndex)\n      this.editEmit()\n    },\n    // 点击模块\n    tapModuleItem(module, index) {\n      this.setIndex(index)\n    },\n    // 切换了门店\n    switchShop(shopId) {\n      if (shopId != this.currentShopInfo.id) {\n        if (this.isEditFlag) {\n          this.$confirm({\n            title: '确定要离开？',\n            content: '此时离开将丢失已编辑的内容，是否确认离开？',\n            onOk: () => {\n              this.getModuleDataAndShopInfo(shopId)\n              this.editEmit(false)\n            }\n          })\n        } else {\n          this.getModuleDataAndShopInfo(shopId)\n        }\n      }\n    },\n    // 手机中点击\n    tapSlide({ sliderIndex }) {\n      this.setIndex(sliderIndex)\n    },\n    // 获取模块数据和门店详情\n    getModuleDataAndShopInfo(shopId) {\n      this.shopId = shopId\n      this.shopActiveIndex = this.shopList.findIndex(item => {\n        return item.shop_id === shopId\n      })\n      this.h5SettingIndexService\n        .getShopModules({ shop_id: shopId, tab_type: '1' })\n        .subscribe(res => {\n          this.setIndex(0)\n        })\n      this.h5SettingIndexService.getShopInfo(shopId).subscribe()\n      this.h5SettingIndexService.getModules(shopId).subscribe()\n    },\n    setIndex(index) {\n      this.sliderIndex = this.phoneIndex = index\n    },\n    saveData() {\n      let modulesData = cloneDeep(this.modulesData)\n      for (let i = 0; i < modulesData.length; i++) {\n        if (!modulesData[i].module_is_delete) {\n          if (modulesData[i].module_type === 2) {\n            let noHasImg = modulesData[i].content.list.find(list => {\n              return !Object.keys(list.image).length\n            })\n            if (noHasImg) {\n              this.messageService.warn({\n                content: `请上传${modulesData[i].module_name}图片`\n              })\n              return false\n            }\n          }\n          if (modulesData[i].module_type === 3) {\n            if (\n              modulesData[i].content.list.length &&\n              modulesData[i].content.list.length > modulesData[i].max_num\n            ) {\n              this.messageService.warn({\n                content: `${modulesData[i].module_name}最多添加${modulesData[i].max_num}项`\n              })\n              return false\n            }\n          }\n        }\n      }\n      let saveData = modulesData.map(item => {\n        item = omit(item, ['is_can_rename', 'is_can_display', 'is_can_delete'])\n        if (item.module_type === 3 && !!item.content.list.length) {\n          // 教练模块\n          let coachList = item.content.list.map(coach => {\n            return coach.id\n          })\n          item.content.list = coachList\n        }\n        return item\n      })\n      console.log(saveData)\n      this.$confirm({\n        title: '',\n        content: '确认将当前设置内容发布到小程序？',\n        onOk: () => {\n          this.h5SettingIndexService\n            .saveIndexConfig({\n              shop_id: this.shopId,\n              tab_type: 1,\n              module_list: saveData\n            })\n            .subscribe(res => {\n              this.messageService.success({\n                content: '保存成功'\n              })\n              this.editEmit(false)\n              this.getModuleDataAndShopInfo(this.shopId)\n              this.setIndex(0)\n            })\n        }\n      })\n    },\n    editEmit(flag = true) {\n      this.isEditFlag = flag\n      this.$emit('change', this.isEditFlag)\n    },\n    mouseEvent(e) {\n      this.canDrag = e\n    }\n  }\n}\n",null]}