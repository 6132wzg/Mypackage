{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/member/member-search/member-search.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/member/member-search/member-search.vue","mtime":1601345390864},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"core-js/modules/es6.number.constructor\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { MemberSearchService } from \"./member-search.service\";\nimport { merge } from 'lodash-es';\nimport { ruleOptions } from \"./member-search.config\";\nimport { PatternService } from '@/services/pattern.service';\nimport InputPhone from '@/views/biz-components/account/input-phone/input-phone';\nexport default {\n  name: 'MemberSearch',\n  model: {\n    event: 'change'\n  },\n  props: {\n    value: {\n      type: String\n    },\n    id: {\n      type: String\n    },\n    label: {\n      type: String,\n      default: '购买会员'\n    },\n\n    /**\n     * 会员查询类型 transaction | transfer\n     */\n    type: {\n      type: String,\n      default: 'transaction' // required: true\n\n    },\n    placeholder: {\n      type: String,\n      default: '输入手机号或会员名搜索'\n    },\n    // 外部 form 表单 必传\n    form: {\n      type: Object,\n      required: true\n    },\n    fields: {\n      type: Object,\n      default: function _default() {\n        return {};\n      }\n    },\n    // 回填会员填写信息\n    memberInfo: {\n      type: Object // default: () => {\n      //   return {\n      //     member_id: 110676207534127,\n      //     member_name: '张飞123222',\n      //     member_mobile: 19134752085\n      //   }\n      // }\n\n    },\n    saleRangeType: {\n      type: Number,\n      default: 1\n    },\n    isSoldDeal: {\n      type: Boolean,\n      default: false\n    }\n  },\n  serviceInject: function serviceInject() {\n    return {\n      memberSearchService: MemberSearchService,\n      pattern: PatternService\n    };\n  },\n  serviceProviders: function serviceProviders() {\n    return [MemberSearchService];\n  },\n  rxState: function rxState() {\n    var _this$memberSearchSer = this.memberSearchService,\n        memberList$ = _this$memberSearchSer.memberList$,\n        loading$ = _this$memberSearchSer.loading$,\n        id_types$ = _this$memberSearchSer.id_types$;\n    return {\n      memberList$: memberList$,\n      loading$: loading$,\n      parent_types: this.memberSearchService.parent_types$,\n      id_types: this.memberSearchService.id_types$\n    };\n  },\n  data: function data() {\n    return {\n      memberSearchText: '',\n      searchMemberIsShow: true,\n      personModel: 0,\n      selectInfo: {},\n      disabledParentMobile: false,\n      idCardValidatorText: '',\n      cardNumValidatorText: '',\n      pidValidatorText: ''\n    };\n  },\n  computed: {\n    ruleOptions: ruleOptions,\n    decorators: function decorators() {\n      return this.form.addDecorators(this.ruleOptions);\n    },\n    usedFields: function usedFields() {\n      return merge({\n        member_id: 'member_id',\n        mobile: 'mobile',\n        member_name: 'member_name',\n        parent_name: 'parent_name',\n        is_minors: 'is_minors',\n        parent_mobile: 'parent_mobile',\n        parent_user_role: 'parent_user_role',\n        id_card: 'id_card',\n        id_card_type: 'id_card_type',\n        card_num: 'card_num',\n        physical_id: 'physical_id'\n      }, this.fields);\n    },\n    memberId: function memberId() {\n      return this.usedFields.member_id;\n    },\n    memberMobile: function memberMobile() {\n      return this.usedFields.mobile;\n    },\n    memberName: function memberName() {\n      return this.usedFields.member_name;\n    },\n    parentName: function parentName() {\n      return this.usedFields.parent_name;\n    },\n    isMinors: function isMinors() {\n      return this.usedFields.is_minors;\n    },\n    parentMobile: function parentMobile() {\n      return this.usedFields.parent_mobile;\n    },\n    parentUserRole: function parentUserRole() {\n      return this.usedFields.parent_user_role;\n    },\n    idCard: function idCard() {\n      return this.usedFields.id_card;\n    },\n    idCardType: function idCardType() {\n      return this.usedFields.id_card_type;\n    },\n    cardNum: function cardNum() {\n      return this.usedFields.card_num;\n    },\n    physicalId: function physicalId() {\n      return this.usedFields.physical_id;\n    }\n  },\n  methods: {\n    idCardValidator: function idCardValidator(e) {\n      var value = e.target.value;\n      var pattern = this.pattern;\n      var id_card_type = this.form.getFieldValue('id_card_type');\n      this.idCardValidatorText = '';\n\n      if (id_card_type === 1 && value && !pattern.ID.test(value)) {\n        this.idCardValidatorText = '请填写正确的身份证号';\n      }\n\n      if (id_card_type === 2 && value && !pattern.PASSPORT.test(value)) {\n        this.idCardValidatorText = '请填写正确的护照号码';\n      }\n    },\n    cardNumValidator: function cardNumValidator(e) {\n      var value = e.target.value;\n\n      if (!value || value.length > 20) {\n        this.cardNumValidatorText = '请输入正确格式的卡号';\n      } else {\n        this.cardNumValidatorText = '';\n      }\n    },\n    pidValidator: function pidValidator(e) {\n      var value = e.target.value;\n\n      if (!value || value.length > 10) {\n        this.pidValidatorText = '请输入正确格式的物理ID';\n      } else {\n        this.pidValidatorText = '';\n      }\n    },\n    onChangeParentMobile: function onChangeParentMobile(val) {\n      var _this = this;\n\n      setTimeout(function () {\n        _this.form.validate(['parent_mobile']).then(function (values) {\n          val.mobile = val.phone;\n\n          _this.memberSearchService.getParentInfoByPhone(val).subscribe(function (res) {\n            if (res.exists) {\n              _this.disabledParentMobile = true;\n\n              _this.form.setFieldsValue({\n                parent_name: res.info.member_name\n              });\n            } else {\n              _this.disabledParentMobile = false;\n\n              _this.form.setFieldsValue({\n                parent_name: ''\n              });\n            }\n          });\n        });\n      });\n    },\n    selectItemLabel: function selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return \"\".concat(item.member_name, \"(\\u672A\\u6210\\u5E74) \").concat(item.parent_mobile, \"(\").concat(item.parent_user_role, \")\");\n      }\n\n      return \"\".concat(item.member_name, \" \").concat(item.mobile);\n    },\n    onSelectMember: function onSelectMember(val) {\n      var _this$form$setFieldsV;\n\n      console.log('memberList', this.memberList$);\n      this.selectInfo = val ? this.memberList$.filter(function (item) {\n        return item.id === val;\n      })[0] : {};\n      this.form.setFieldsValue((_this$form$setFieldsV = {}, _defineProperty(_this$form$setFieldsV, this.memberId, this.selectInfo.id || undefined), _defineProperty(_this$form$setFieldsV, this.physicalId, this.selectInfo.physical_id || undefined), _defineProperty(_this$form$setFieldsV, this.idCard, this.selectInfo.id_card || undefined), _defineProperty(_this$form$setFieldsV, this.cardNum, this.selectInfo.card_num || undefined), _defineProperty(_this$form$setFieldsV, this.idCardType, this.selectInfo.id_card_type || 1), _this$form$setFieldsV));\n      console.log('this.selectInfo', this.selectInfo); // setTimeout(() => {\n      // })\n\n      this.$emit('select', val);\n    },\n    onChangeMember: function onChangeMember(val) {\n      console.log('onChangeMember', val);\n\n      if (!val) {\n        this.onSelectMember(val);\n      } else {\n        // TODO: b254dd12 fix: 购买会员change事件 三个月前\n        this.$emit('change', val);\n      }\n    },\n    onChangeModel: function onChangeModel(val) {\n      this.personModel = val;\n    },\n    // 搜索会员\n    onMemberSearch: function onMemberSearch(data) {\n      var _this2 = this;\n\n      this.memberSearchText = data;\n\n      if (data === '') {\n        this.memberSearchService.RESET_LIST();\n        this.form.resetFields([this.memberId]);\n        this.$emit('change:list', []);\n      } else {\n        this.memberSearchService.getMember(data, this.saleRangeType);\n        this.memberSearchService.getMemberAction$.subscribe(function (list) {\n          if (!list.length) {\n            _this2.form.resetFields([_this2.memberId]);\n\n            _this2.onChangeMember('');\n          } else {\n            console.log('memberInfo', _this2.memberInfo);\n\n            if (_this2.memberInfo) {\n              _this2.form.setFieldsValue(_defineProperty({}, _this2.memberId, _this2.memberInfo.member_id));\n\n              _this2.onChangeMember(_this2.memberInfo.member_id);\n            }\n          }\n        });\n      }\n    },\n    // 切换新增会员\n    onAddMember: function onAddMember() {\n      this.selectInfo = {};\n      this.searchMemberIsShow = false;\n    },\n    onCancelMember: function onCancelMember() {\n      this.searchMemberIsShow = true;\n      this.selectInfo = {}; // 取消新增，重置为成年人模式\n\n      this.personModel = 0;\n      this.form.resetFields([this.memberId, this.memberName, this.memberMobile]);\n    }\n  },\n  mounted: function mounted() {\n    var _this3 = this;\n\n    this.memberSearchService.SET_TYPE(this.type);\n    console.log('member-search');\n\n    try {\n      if (this.memberInfo) {\n        console.log('memberInfo', this.memberInfo);\n        this.onMemberSearch(this.memberInfo.member_name);\n\n        if (this.isSoldDeal) {\n          var _this$form$setFieldsV2;\n\n          this.form.setFieldsValue((_this$form$setFieldsV2 = {}, _defineProperty(_this$form$setFieldsV2, this.physicalId, this.memberInfo.physical_id), _defineProperty(_this$form$setFieldsV2, this.idCard, this.memberInfo.id_card), _defineProperty(_this$form$setFieldsV2, this.cardNum, this.memberInfo.card_num), _defineProperty(_this$form$setFieldsV2, this.idCardType, this.memberInfo.id_card_type), _this$form$setFieldsV2));\n        }\n      } else {\n        this.memberSearchService.getMemberAction$.subscribe(function (list) {\n          console.log('list', list);\n\n          if (!list.length) {\n            _this3.form.resetFields([_this3.memberId]);\n          }\n        });\n      }\n    } catch (error) {\n      console.log('error', error);\n    }\n  },\n  components: {\n    InputPhone: InputPhone\n  }\n};",{"version":3,"sources":["member-search.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div>\n    <div class=\"search-member__select\" v-if=\"searchMemberIsShow\">\n      <st-form-item\n        class=\"search-member__select-item\"\n        :label=\"label\"\n        required\n        v-bind=\"$attrs\"\n      >\n        <a-select\n          style=\"width:calc(100% - 85px)\"\n          showSearch\n          allowClear\n          v-decorator=\"decorators[memberId]\"\n          :placeholder=\"placeholder\"\n          :defaultActiveFirstOption=\"false\"\n          :filterOption=\"false\"\n          :showArrow=\"false\"\n          suffixIcon=\"add\"\n          @search=\"onMemberSearch\"\n          @select=\"onSelectMember\"\n          @change=\"onChangeMember\"\n        >\n          <div slot=\"notFoundContent\">\n            <a-spin size=\"small\" v-if=\"loading$.getTransactionMember\"></a-spin>\n            <div v-else-if=\"!memberSearchText\">无搜索结果</div>\n            <div v-else>\n              查无此会员，\n              <a @click=\"onAddMember\">新增新会员？</a>\n            </div>\n          </div>\n          <a-select-option\n            v-for=\"item in memberList$\"\n            :value=\"item.id\"\n            :key=\"item.id\"\n          >\n            <span\n              v-html=\"\n                `${selectItemLabel(item)}`.replace(\n                  new RegExp(memberSearchText, 'g'),\n                  `\\<span class='global-highlight-color'\\>${memberSearchText}\\<\\/span\\>`\n                )\n              \"\n            >\n              {{ selectItemLabel(item) }}\n            </span>\n          </a-select-option>\n          <span slot=\"suffixIcon\">未成年</span>\n        </a-select>\n        <a class=\"search-member__select-href\" @click=\"onAddMember\">新增会员</a>\n      </st-form-item>\n    </div>\n\n    <template v-if=\"selectInfo && selectInfo.is_minors === 1\">\n      <st-form-item label=\"家长手机号\" required v-bind=\"$attrs\">\n        <label>{{ selectInfo.parent_mobile }}</label>\n      </st-form-item>\n      <st-form-item label=\"家长姓名\" required v-bind=\"$attrs\">\n        <label>\n          {{ selectInfo.parent_name }}({{ selectInfo.parent_user_role }})\n        </label>\n      </st-form-item>\n    </template>\n\n    <template v-if=\"!searchMemberIsShow\">\n      <st-form-item label=\"姓名\" required v-bind=\"$attrs\">\n        <a-input\n          v-decorator=\"decorators[memberName]\"\n          placeholder=\"请输入会员姓名\"\n          :maxLength=\"30\"\n        >\n          <a-select\n            slot=\"addonAfter\"\n            style=\"width: 100px\"\n            v-decorator=\"decorators[isMinors]\"\n            @change=\"onChangeModel\"\n          >\n            <a-select-option :value=\"0\">成年人</a-select-option>\n            <a-select-option :value=\"1\">未成年人</a-select-option>\n          </a-select>\n        </a-input>\n      </st-form-item>\n      <st-form-item\n        label=\"手机号\"\n        required\n        v-if=\"personModel === 0\"\n        v-bind=\"$attrs\"\n      >\n        <input-phone\n          size=\"default\"\n          v-decorator=\"decorators[memberMobile]\"\n          placeholder=\"请输入手机号\"\n        ></input-phone>\n        <p class=\"mg-b0\">\n          <a @click=\"onCancelMember\">取消新增</a>\n        </p>\n      </st-form-item>\n      <st-form-item\n        label=\"家长手机号\"\n        required\n        v-if=\"personModel === 1\"\n        v-bind=\"$attrs\"\n      >\n        <input-phone\n          size=\"default\"\n          v-decorator=\"decorators[parentMobile]\"\n          placeholder=\"请输入手机号\"\n          @change=\"onChangeParentMobile\"\n        ></input-phone>\n      </st-form-item>\n      <st-form-item\n        label=\"家长姓名\"\n        required\n        v-if=\"personModel === 1\"\n        v-bind=\"$attrs\"\n      >\n        <a-input\n          v-decorator=\"decorators[parentName]\"\n          placeholder=\"请输入家长姓名\"\n          :disabled=\"disabledParentMobile\"\n          :maxLength=\"30\"\n        >\n          <a-select\n            slot=\"addonAfter\"\n            style=\"width: 80px\"\n            v-decorator=\"decorators[parentUserRole]\"\n          >\n            <a-select-option\n              :value=\"item.value\"\n              v-for=\"(item, index) in parent_types\"\n              :key=\"index\"\n            >\n              {{ item.label }}\n            </a-select-option>\n          </a-select>\n        </a-input>\n        <p class=\"mg-b0\">\n          <a @click=\"onCancelMember\">取消新增</a>\n        </p>\n      </st-form-item>\n    </template>\n    <template v-if=\"isSoldDeal\">\n      <st-form-item label=\"证件\" v-bind=\"$attrs\" :help=\"idCardValidatorText\">\n        <a-input\n          placeholder=\"请输入\"\n          v-decorator=\"decorators[idCard]\"\n          @change=\"idCardValidator\"\n        >\n          <a-select\n            v-decorator=\"decorators[idCardType]\"\n            placeholder=\"请选择\"\n            style=\"width:100px\"\n            slot=\"addonBefore\"\n          >\n            <a-select-option\n              v-for=\"(item, index) in id_types\"\n              :key=\"index\"\n              :value=\"+item.value\"\n            >\n              {{ item.label }}\n            </a-select-option>\n          </a-select>\n        </a-input>\n      </st-form-item>\n      <st-form-item label=\"卡号\" v-bind=\"$attrs\" :help=\"cardNumValidatorText\">\n        <a-input\n          placeholder=\"请输入卡号\"\n          v-decorator=\"decorators[cardNum]\"\n          @change=\"cardNumValidator\"\n        />\n      </st-form-item>\n      <st-form-item label=\"物理卡号\" v-bind=\"$attrs\" :help=\"pidValidatorText\">\n        <a-input\n          placeholder=\"请输入物理卡号\"\n          v-decorator=\"decorators[physicalId]\"\n          @change=\"pidValidator\"\n        />\n      </st-form-item>\n    </template>\n  </div>\n</template>\n\n<script>\nimport { MemberSearchService } from './member-search.service'\nimport { merge } from 'lodash-es'\nimport { ruleOptions } from './member-search.config'\nimport { PatternService } from '@/services/pattern.service'\nimport InputPhone from '@/views/biz-components/account/input-phone/input-phone'\nexport default {\n  name: 'MemberSearch',\n  model: {\n    event: 'change'\n  },\n  props: {\n    value: {\n      type: String\n    },\n    id: {\n      type: String\n    },\n    label: {\n      type: String,\n      default: '购买会员'\n    },\n    /**\n     * 会员查询类型 transaction | transfer\n     */\n    type: {\n      type: String,\n      default: 'transaction'\n      // required: true\n    },\n    placeholder: {\n      type: String,\n      default: '输入手机号或会员名搜索'\n    },\n    // 外部 form 表单 必传\n    form: {\n      type: Object,\n      required: true\n    },\n    fields: {\n      type: Object,\n      default: () => ({})\n    },\n    // 回填会员填写信息\n    memberInfo: {\n      type: Object\n      // default: () => {\n      //   return {\n      //     member_id: 110676207534127,\n      //     member_name: '张飞123222',\n      //     member_mobile: 19134752085\n      //   }\n      // }\n    },\n    saleRangeType: {\n      type: Number,\n      default: 1\n    },\n    isSoldDeal: {\n      type: Boolean,\n      default: false\n    }\n  },\n  serviceInject() {\n    return {\n      memberSearchService: MemberSearchService,\n      pattern: PatternService\n    }\n  },\n  serviceProviders() {\n    return [MemberSearchService]\n  },\n  rxState() {\n    const { memberList$, loading$, id_types$ } = this.memberSearchService\n    return {\n      memberList$,\n      loading$,\n      parent_types: this.memberSearchService.parent_types$,\n      id_types: this.memberSearchService.id_types$\n    }\n  },\n\n  data() {\n    return {\n      memberSearchText: '',\n      searchMemberIsShow: true,\n      personModel: 0,\n      selectInfo: {},\n      disabledParentMobile: false,\n      idCardValidatorText: '',\n      cardNumValidatorText: '',\n      pidValidatorText: ''\n    }\n  },\n  computed: {\n    ruleOptions,\n    decorators() {\n      return this.form.addDecorators(this.ruleOptions)\n    },\n    usedFields() {\n      return merge(\n        {\n          member_id: 'member_id',\n          mobile: 'mobile',\n          member_name: 'member_name',\n          parent_name: 'parent_name',\n          is_minors: 'is_minors',\n          parent_mobile: 'parent_mobile',\n          parent_user_role: 'parent_user_role',\n          id_card: 'id_card',\n          id_card_type: 'id_card_type',\n          card_num: 'card_num',\n          physical_id: 'physical_id'\n        },\n        this.fields\n      )\n    },\n    memberId() {\n      return this.usedFields.member_id\n    },\n    memberMobile() {\n      return this.usedFields.mobile\n    },\n    memberName() {\n      return this.usedFields.member_name\n    },\n    parentName() {\n      return this.usedFields.parent_name\n    },\n    isMinors() {\n      return this.usedFields.is_minors\n    },\n    parentMobile() {\n      return this.usedFields.parent_mobile\n    },\n    parentUserRole() {\n      return this.usedFields.parent_user_role\n    },\n    idCard() {\n      return this.usedFields.id_card\n    },\n    idCardType() {\n      return this.usedFields.id_card_type\n    },\n    cardNum() {\n      return this.usedFields.card_num\n    },\n    physicalId() {\n      return this.usedFields.physical_id\n    }\n  },\n  methods: {\n    idCardValidator(e) {\n      let value = e.target.value\n      let pattern = this.pattern\n      let id_card_type = this.form.getFieldValue('id_card_type')\n      this.idCardValidatorText = ''\n      if (id_card_type === 1 && value && !pattern.ID.test(value)) {\n        this.idCardValidatorText = '请填写正确的身份证号'\n      }\n      if (id_card_type === 2 && value && !pattern.PASSPORT.test(value)) {\n        this.idCardValidatorText = '请填写正确的护照号码'\n      }\n    },\n    cardNumValidator(e) {\n      let value = e.target.value\n      if (!value || value.length > 20) {\n        this.cardNumValidatorText = '请输入正确格式的卡号'\n      } else {\n        this.cardNumValidatorText = ''\n      }\n    },\n    pidValidator(e) {\n      let value = e.target.value\n      if (!value || value.length > 10) {\n        this.pidValidatorText = '请输入正确格式的物理ID'\n      } else {\n        this.pidValidatorText = ''\n      }\n    },\n    onChangeParentMobile(val) {\n      setTimeout(() => {\n        this.form.validate(['parent_mobile']).then(values => {\n          val.mobile = val.phone\n          this.memberSearchService.getParentInfoByPhone(val).subscribe(res => {\n            if (res.exists) {\n              this.disabledParentMobile = true\n              this.form.setFieldsValue({\n                parent_name: res.info.member_name\n              })\n            } else {\n              this.disabledParentMobile = false\n              this.form.setFieldsValue({\n                parent_name: ''\n              })\n            }\n          })\n        })\n      })\n    },\n    selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`\n      }\n      return `${item.member_name} ${item.mobile}`\n    },\n    onSelectMember(val) {\n      console.log('memberList', this.memberList$)\n      this.selectInfo = val\n        ? this.memberList$.filter(item => item.id === val)[0]\n        : {}\n      this.form.setFieldsValue({\n        [this.memberId]: this.selectInfo.id || undefined,\n        [this.physicalId]: this.selectInfo.physical_id || undefined,\n        [this.idCard]: this.selectInfo.id_card || undefined,\n        [this.cardNum]: this.selectInfo.card_num || undefined,\n        [this.idCardType]: this.selectInfo.id_card_type || 1\n      })\n      console.log('this.selectInfo', this.selectInfo)\n      // setTimeout(() => {\n\n      // })\n      this.$emit('select', val)\n    },\n    onChangeMember(val) {\n      console.log('onChangeMember', val)\n      if (!val) {\n        this.onSelectMember(val)\n      } else {\n        // TODO: b254dd12 fix: 购买会员change事件 三个月前\n        this.$emit('change', val)\n      }\n    },\n    onChangeModel(val) {\n      this.personModel = val\n    },\n    // 搜索会员\n    onMemberSearch(data) {\n      this.memberSearchText = data\n      if (data === '') {\n        this.memberSearchService.RESET_LIST()\n        this.form.resetFields([this.memberId])\n        this.$emit('change:list', [])\n      } else {\n        this.memberSearchService.getMember(data, this.saleRangeType)\n        this.memberSearchService.getMemberAction$.subscribe(list => {\n          if (!list.length) {\n            this.form.resetFields([this.memberId])\n            this.onChangeMember('')\n          } else {\n            console.log('memberInfo', this.memberInfo)\n            if (this.memberInfo) {\n              this.form.setFieldsValue({\n                [this.memberId]: this.memberInfo.member_id\n              })\n              this.onChangeMember(this.memberInfo.member_id)\n            }\n          }\n        })\n      }\n    },\n    // 切换新增会员\n    onAddMember() {\n      this.selectInfo = {}\n      this.searchMemberIsShow = false\n    },\n    onCancelMember() {\n      this.searchMemberIsShow = true\n      this.selectInfo = {}\n      // 取消新增，重置为成年人模式\n      this.personModel = 0\n      this.form.resetFields([this.memberId, this.memberName, this.memberMobile])\n    }\n  },\n  mounted() {\n    this.memberSearchService.SET_TYPE(this.type)\n    console.log('member-search')\n    try {\n      if (this.memberInfo) {\n        console.log('memberInfo', this.memberInfo)\n        this.onMemberSearch(this.memberInfo.member_name)\n        if (this.isSoldDeal) {\n          this.form.setFieldsValue({\n            [this.physicalId]: this.memberInfo.physical_id,\n            [this.idCard]: this.memberInfo.id_card,\n            [this.cardNum]: this.memberInfo.card_num,\n            [this.idCardType]: this.memberInfo.id_card_type\n          })\n        }\n      } else {\n        this.memberSearchService.getMemberAction$.subscribe(list => {\n          console.log('list', list)\n          if (!list.length) {\n            this.form.resetFields([this.memberId])\n          }\n        })\n      }\n    } catch (error) {\n      console.log('error', error)\n    }\n  },\n  components: {\n    InputPhone\n  }\n}\n</script>\n"],"sourceRoot":"src/views/biz-components/member/member-search"}]}