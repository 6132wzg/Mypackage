{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-personal-course.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-personal-course.vue","mtime":1596188219499},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { SalePersonalCourseService } from \"./sale-personal-course.service\";\nimport moment from 'moment';\nimport { cloneDeep, get } from 'lodash-es';\nimport { timer } from 'rxjs';\nimport { PatternService } from '@/services/pattern.service';\nimport { ruleOptions } from \"./sale-personal-course.config\";\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue';\nimport MemberSearch from '@/views/biz-components/member-search/member-search';\nimport SelectScroll from '@/views/biz-components/select-scroll/select-scroll';\nimport { momentPlus } from '@/utils/date';\nexport default {\n  name: 'ModalSoldDealSaleMemberCard',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber: EditableContractNumber,\n    MemberSearch: MemberSearch,\n    SelectScroll: SelectScroll\n  },\n  serviceProviders: function serviceProviders() {\n    return [SalePersonalCourseService];\n  },\n  serviceInject: function serviceInject() {\n    return {\n      salePersonalCourseService: SalePersonalCourseService,\n      pattern: PatternService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.salePersonalCourseService.loading$,\n      finished: this.salePersonalCourseService.finished$,\n      page: this.salePersonalCourseService.page$,\n      info: this.salePersonalCourseService.info$,\n      courseList: this.salePersonalCourseService.courseList$,\n      saleList: this.salePersonalCourseService.saleList$,\n      couponList: this.salePersonalCourseService.couponList$,\n      coachList: this.salePersonalCourseService.coachList$,\n      personalPrice: this.salePersonalCourseService.personalPrice$,\n      priceInfo: this.salePersonalCourseService.priceInfo$,\n      orderAmountPrice: this.salePersonalCourseService.orderAmountPrice$,\n      coachTypeOptions: this.salePersonalCourseService.coachTypeOptions$\n    };\n  },\n  props: {\n    id: {\n      type: String\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      form: form,\n      decorators: decorators,\n      show: false,\n      // 购买数量可编辑\n      isAmountDisabled: false,\n      // 最小输入购买数量\n      minPrice: 0,\n      // 到期有效时间\n      validEndTime: moment(),\n      // 最大日期距当前时间不超过5年\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      // 优惠券\n      selectCoupon: '',\n      couponText: '未选择优惠券',\n      couponAmount: '',\n      couponDropdownVisible: false,\n      // 购买数量处于编辑状态 提示语\n      isAmountStateTip: '',\n      // 到期时间可否编辑\n      isEditExpiredTime: false,\n      product_id: '',\n      isFollowSalesman: 0,\n      product_name: '',\n      coach_type: 1\n    };\n  },\n  computed: {\n    canChoseCoupon: function canChoseCoupon() {\n      var len = this.couponList.length;\n      return !!len;\n    },\n    canChoseAdvance: function canChoseAdvance() {\n      var len = this.advanceList.length;\n      return (this.id || this.product_id) && len;\n    },\n    orderPersonalType: function orderPersonalType() {\n      // 1 教练平级 + 谈单模式 2 教练平级 + 统一标价 3 教练分级 + 谈单模式 4 教练分级 + 统一标价\n      var personalCourseType = 1;\n\n      if (this.info.price_model === 1 && this.info.sale_model === 1) {\n        personalCourseType = 1;\n      } else if (this.info.price_model === 1 && this.info.sale_model === 2) {\n        personalCourseType = 2;\n      } else if (this.info.price_model === 2 && this.info.sale_model === 1) {\n        personalCourseType = 3;\n      } else if (this.info.price_model === 2 && this.info.sale_model === 2) {\n        personalCourseType = 4;\n      }\n\n      return personalCourseType;\n    },\n    orderAmountText: function orderAmountText() {\n      return this.priceInfo < 0 ? '小计不能为负' : '';\n    },\n    saleRangeType: function saleRangeType() {\n      return get(this.info.sale_range, 'type', 1);\n    },\n    hasProductInfo: function hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}';\n    },\n    isSupportSelectCoach: function isSupportSelectCoach() {\n      /**\n       * coach_type 1 指定教练\n       */\n      return this.coach_type === 1;\n    }\n  },\n  watch: {\n    selectCoupon: {\n      deep: true,\n      handler: function handler(newVal, oldVal) {\n        this.getPrice(newVal, this.selectAdvance, +this.reduceAmount);\n      }\n    },\n    selectAdvance: {\n      deep: true,\n      handler: function handler(newVal, oldVal) {\n        this.getPrice(this.selectCoupon, newVal, +this.reduceAmount);\n      }\n    },\n    reduceAmount: function reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectCoupon, this.selectAdvance, +newVal);\n    }\n  },\n  mounted: function mounted() {\n    var _this = this;\n\n    this.salePersonalCourseService.serviceInit().subscribe(function (res) {\n      if (_this.id) {\n        _this.handleGetPersonalCourseInfo(_this.id);\n      } else {\n        _this.salePersonalCourseService.getPresonalCourseList({\n          app_brand_id: _this.$searchQuery.app_brand_id,\n          app_shop_id: _this.$searchQuery.app_shop_id,\n          product_type: 3\n        }).subscribe();\n      }\n    });\n    this.initFieldsValue();\n  },\n  methods: {\n    moment: moment,\n    onResetDiscounts: function onResetDiscounts() {\n      // 重置优惠券及定金选择\n      this.resetCoupon();\n      this.resetAdvance();\n    },\n    // 重新获取优惠券及定金\n    onReGetDiscounts: function onReGetDiscounts(data) {\n      // 如果存在会员id则请求重新拉取优惠券及定金列表\n      this.fetchAdvanceList(data);\n      this.fetchCouponList(data);\n    },\n    // 会员选择\n    onMemberChange: function onMemberChange(data) {\n      // 重置优惠券及定金选择\n      this.onResetDiscounts(); // 如果存在会员id则请求重新拉取优惠券及定金列表\n\n      if (data) this.onReGetDiscounts(data);\n    },\n    // 选择课,筛选\n    handleSelect: function handleSelect(val) {\n      this.product_id = val;\n      this.onResetDiscounts();\n      this.handleGetPersonalCourseInfo(val);\n    },\n    // 选择课,搜索\n    handleSearch: function handleSearch(product_name) {\n      this.product_name = product_name;\n      this.salePersonalCourseService.getPresonalCourseList({\n        product_name: product_name,\n        current_page: 1,\n        app_brand_id: this.$searchQuery.app_brand_id,\n        app_shop_id: this.$searchQuery.app_shop_id,\n        product_type: 3\n      }).subscribe();\n    },\n    // 卡规格切换\n    changeSpeics: function changeSpeics(event) {\n      this.isAmountDisabled = false;\n      this.resetOrderInfo();\n      var selectCoach = this.info.coach_level.filter(function (item) {\n        return item.id === event.target.value;\n      });\n      this.minPrice = selectCoach[0].min_sell;\n      var productId = this.form.getFieldValue('productId') || undefined;\n      this.salePersonalCourseService.getCoachList(selectCoach[0].id, productId).subscribe();\n    },\n    // 重置订单信息\n    resetOrderInfo: function resetOrderInfo() {\n      this.form.resetFields(['buyNum', 'coach_ids', 'coursePrice', 'gift_course_num']);\n      this.personalPrice.sell_price = 0;\n      this.personalPrice.min_sell_price = 0;\n      this.personalPrice.max_sell_price = 0;\n      this.validEndTime = moment();\n      this.priceInfo = 0;\n      this.orderAmountPrice = 0;\n      this.reduceAmount = 0;\n      this.selectAdvance = '';\n      this.selectCoupon = '';\n      this.couponList = [];\n    },\n    // 定金选择\n    onSelectAdvance: function onSelectAdvance() {\n      var _this2 = this;\n\n      timer(200).subscribe(function () {\n        _this2.advanceDropdownVisible = false;\n      });\n    },\n    // 优惠券选择\n    onSelectCoupon: function onSelectCoupon() {\n      var _this3 = this;\n\n      timer(200).subscribe(function () {\n        _this3.couponDropdownVisible = false;\n      });\n    },\n    // 重置定金选择\n    resetAdvance: function resetAdvance() {\n      this.advanceList = [];\n      this.advanceText = '未选择定金';\n      this.selectAdvance = '';\n      this.advanceAmount = '';\n    },\n    // 重置优惠券选择\n    resetCoupon: function resetCoupon() {\n      this.salePersonalCourseService.REST_COUPONLIST();\n      this.couponText = '未选择优惠券';\n      this.selectCoupon = '';\n      this.couponAmount = '';\n    },\n    // 签单弹窗关闭\n    onCancel: function onCancel() {\n      this.onResetDiscounts();\n    },\n    // 定金选择\n    onSelectAdvanceChange: function onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0;\n        this.advanceText = \"\\u672A\\u9009\\u62E9\\u5B9A\\u91D1\";\n        return;\n      }\n\n      var price = this.advanceList.filter(function (o) {\n        return o.id === data.target.value;\n      })[0].price;\n      this.advanceAmount = price;\n      this.advanceText = \"\".concat(price, \"\\u5143\");\n    },\n    // 优惠券选择\n    onSelectCouponChange: function onSelectCouponChange(event) {\n      var id = get(event.target.value, 'id', '');\n\n      if (id) {\n        var price = this.couponList.filter(function (o) {\n          return o.id === id;\n        })[0].price;\n        this.couponAmount = price;\n        this.couponText = \"\".concat(price, \"\\u5143\");\n      } else {\n        this.couponText = '未选择优惠券';\n        this.couponAmount = 0;\n      }\n    },\n    // 确认购买课程的数量\n    onClickCourseAmount: function onClickCourseAmount() {\n      var _this4 = this;\n\n      var productId = this.form.getFieldValue('productId') || undefined;\n      var params = {\n        id: productId,\n        buy_num: this.form.getFieldValue('buyNum'),\n        coach_level_id: this.form.getFieldValue('coach_level') || 0 // 默认0 为没有等级，否则分级\n\n      };\n      this.salePersonalCourseService.getPersonalPriceInfo(params).subscribe(function (result) {\n        _this4.isAmountDisabled = true;\n\n        _this4.form.setFieldsValue({\n          buyNum: params.buy_num\n        });\n\n        var time = _this4.info.effective_unit * params.buy_num || 0;\n        _this4.validEndTime = momentPlus.add(time, 'days'); // 调用优惠券列表\n\n        _this4.fetchCouponList(); // 调用获取商品原价\n\n\n        if (_this4.info.sale_model === 1 && !_this4.form.getFieldValue('coursePrice') && _this4.form.getFieldValue('coursePrice') !== 0) {\n          return;\n        }\n\n        _this4.getOrderPrice();\n\n        _this4.getPrice(_this4.selectCoupon, _this4.selectAdvance, +_this4.reduceAmount);\n      });\n    },\n    // 编辑购买的课程数量\n    onClickCourseEdit: function onClickCourseEdit() {\n      var val = this.form.getFieldValue('buyNum');\n      this.isAmountDisabled = false;\n      this.form.setFieldsValue({\n        buyNum: val\n      });\n      this.form.validate(['buyNum']);\n    },\n    onClickTimeEdit: function onClickTimeEdit() {\n      this.isEditExpiredTime = !this.isEditExpiredTime;\n    },\n    // 计算实付金额\n    getPrice: function getPrice(coupon, advance, reduce) {\n      var advanceId = advance === -1 ? '' : advance;\n      var special_amount = this.personalPrice.sell_price;\n\n      if (this.info.sale_model === 1) {\n        special_amount = this.form.getFieldValue('coursePrice');\n      }\n\n      if (!special_amount) {\n        return;\n      }\n\n      var memberId = this.form.getFieldValue('member_id');\n      var productId = this.form.getFieldValue('productId');\n      this.salePersonalCourseService.priceAction$.dispatch({\n        product_id: productId || undefined,\n        product_type: this.info.contract_type,\n        product_num: this.form.getFieldValue('buyNum'),\n        specs_id: this.form.getFieldValue('coach_level'),\n        coupon_id: coupon ? coupon.id : undefined,\n        member_id: memberId || undefined,\n        advance_id: advanceId,\n        reduce_amount: reduce,\n        special_amount: +special_amount || 0\n      });\n    },\n    // 获取订单总额\n    getOrderPrice: function getOrderPrice() {\n      var special_amount = this.personalPrice.sell_price;\n\n      if (this.info.sale_model === 1) {\n        special_amount = this.form.getFieldValue('coursePrice');\n\n        if (!special_amount) {\n          return;\n        }\n      }\n\n      var productId = this.form.getFieldValue('productId') || undefined;\n      this.salePersonalCourseService.orderAmountPriceAction$.dispatch({\n        product_id: productId,\n        product_type: this.info.contract_type,\n        product_num: this.form.getFieldValue('buyNum'),\n        specs_id: this.form.getFieldValue('coach_level'),\n        special_amount: +special_amount || 0\n      });\n    },\n    // 创建订单\n    onCreateOrder: function onCreateOrder() {\n      var _this5 = this;\n\n      this.form.validate().then(function (values) {\n        var productId = _this5.form.getFieldValue('productId') || undefined;\n\n        _this5.salePersonalCourseService.setTransactionOrder({\n          member_id: values.member_id,\n          member_name: values.member_name,\n          mobile: values.mobile ? values.mobile.phone : undefined,\n          course_id: productId,\n          contract_number: _this5.info.contract_number,\n          buy_num: values.buyNum,\n          course_price: _this5.info.sale_model === 2 ? _this5.personalPrice.sell_price : values.coursePrice,\n          coupon_id: _this5.selectCoupon.id,\n          advance_id: _this5.selectAdvance,\n          reduce_amount: _this5.reduceAmount || 0,\n          sale_id: values.saleName,\n          description: _this5.description,\n          gift_course_num: values.gift_course_num || 0,\n          coach_type: values.coach_type,\n          coach_ids: values.coach_ids,\n          coach_level_id: values.coach_level,\n          sale_range: _this5.info.sale_range.type,\n          order_amount: _this5.priceInfo,\n          is_minors: values.is_minors,\n          parent_name: values.parent_name,\n          parent_mobile: values.parent_mobile ? values.parent_mobile.phone : undefined,\n          parent_country_prefix: values.parent_mobile ? values.parent_mobile.code_id : undefined,\n          parent_user_role: values.parent_user_role,\n          physical_id: values.physical_id,\n          card_num: values.card_num,\n          id_card: values.id_card,\n          id_card_type: values.id_card_type,\n          is_follow_salesman: _this5.isFollowSalesman,\n          end_time: _this5.validEndTime.format('YYYY-MM-DD')\n        }).subscribe(function (result) {\n          _this5.$emit('success', {\n            type: 'create',\n            orderId: result.info.order_id\n          });\n\n          _this5.show = false;\n        });\n      });\n    },\n    // 支付订单\n    onPay: function onPay() {\n      var _this6 = this;\n\n      this.form.validate().then(function (values) {\n        var productId = _this6.form.getFieldValue('productId') || undefined;\n\n        _this6.salePersonalCourseService.setTransactionPay({\n          member_id: values.member_id,\n          member_name: values.member_name,\n          mobile: values.mobile ? values.mobile.phone : undefined,\n          course_id: productId,\n          contract_number: _this6.info.contract_number,\n          buy_num: values.buyNum,\n          course_price: _this6.info.sale_model === 2 ? _this6.personalPrice.sell_price : values.coursePrice,\n          coupon_id: _this6.selectCoupon.id,\n          advance_id: _this6.selectAdvance,\n          reduce_amount: _this6.reduceAmount || 0,\n          sale_id: values.saleName,\n          description: _this6.description,\n          gift_course_num: values.gift_course_num || 0,\n          coach_type: values.coach_type,\n          coach_ids: values.coach_ids,\n          coach_level_id: values.coach_level,\n          sale_range: _this6.info.sale_range.type,\n          order_amount: _this6.priceInfo,\n          is_minors: values.is_minors,\n          parent_name: values.parent_name,\n          parent_mobile: values.parent_mobile ? values.parent_mobile.phone : undefined,\n          parent_country_prefix: values.parent_mobile ? values.parent_mobile.code_id : undefined,\n          parent_user_role: values.parent_user_role,\n          physical_id: values.physical_id,\n          card_num: values.card_num,\n          id_card: values.id_card,\n          id_card_type: values.id_card_type,\n          is_follow_salesman: _this6.isFollowSalesman,\n          end_time: _this6.validEndTime.format('YYYY-MM-DD')\n        }).subscribe(function (result) {\n          _this6.$emit('success', {\n            type: 'createPay',\n            orderId: result.info.order_id\n          });\n\n          _this6.show = false;\n        });\n      });\n    },\n    disabledDate: function disabledDate(current) {\n      return current && (current < moment().add(-1, 'day') || current > moment().add(5, 'years'));\n    },\n    // 获取优惠券列表\n    fetchCouponList: function fetchCouponList(id) {\n      var member_id = this.form.getFieldValue('member_id') || id;\n      var price = this.personalPrice.sell_price;\n      var buy_num = this.form.getFieldValue('buyNum');\n      var course_id = this.form.getFieldValue('productId') || undefined;\n\n      if (course_id && member_id) {\n        var params = {\n          member_id: member_id,\n          course_id: course_id,\n          price: price,\n          buy_num: buy_num\n        };\n        this.salePersonalCourseService.getCouponList(params).subscribe();\n      }\n    },\n    // 获取定金列表\n    fetchAdvanceList: function fetchAdvanceList(id) {\n      var _this7 = this;\n\n      var member_id = this.form.getFieldValue('member_id') || id;\n\n      if (member_id) {\n        this.salePersonalCourseService.getAdvanceList(member_id).subscribe(function (res) {\n          _this7.advanceList = cloneDeep(res.list);\n        });\n      }\n    },\n    // 获取课程列表\n    handleGetList: function handleGetList() {\n      if (this.finished) return false;\n      this.salePersonalCourseService.getPresonalCourseList({\n        product_name: this.product_name,\n        current_page: ++this.page.current_page,\n        app_brand_id: this.$searchQuery.app_brand_id,\n        app_shop_id: this.$searchQuery.app_shop_id,\n        product_type: 3\n      }).subscribe();\n    },\n    // 获取课程详情\n    handleGetPersonalCourseInfo: function handleGetPersonalCourseInfo(productId) {\n      var _this8 = this;\n\n      this.salePersonalCourseService.getInfo(productId).subscribe(function (res) {\n        if (_this8.id) {\n          _this8.salePersonalCourseService.SET_LIST([{\n            id: +_this8.id,\n            product_name: _this8.info.product_name\n          }]);\n        }\n\n        setTimeout(function () {\n          _this8.form.setFieldsValue({\n            productId: +productId\n          });\n\n          if (_this8.info.coach_level && _this8.info.coach_level.length > 0) {\n            _this8.form.setFieldsValue({\n              coach_level: _this8.info.coach_level[0].id\n            });\n\n            _this8.minPrice = _this8.info.coach_level[0].min_sell;\n          }\n\n          var level = 0;\n\n          if (_this8.info.price_model === 2) {\n            level = _this8.info.coach_level[0].id;\n          }\n\n          _this8.onReGetDiscounts();\n\n          _this8.salePersonalCourseService.getCoachList(level, productId).subscribe();\n        });\n      });\n    },\n    initFieldsValue: function initFieldsValue() {\n      var coach_type = this.coach_type;\n      this.form.setFieldsValue({\n        coach_type: coach_type\n      });\n    },\n    onCoachTypeChange: function onCoachTypeChange(e) {\n      this.coach_type = e.target.value;\n    }\n  }\n};",null]}