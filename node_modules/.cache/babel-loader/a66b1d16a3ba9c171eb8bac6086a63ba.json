{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/app/venue/booking.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/app/venue/booking.vue","mtime":1600926556316},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/web.dom.iterable\";\nimport _defineProperty from \"/Users/wangzhigang/Desktop/styd/web/node_modules/@babel/runtime-corejs2/helpers/esm/defineProperty\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.array.fill\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { BookingService } from \"./booking.service\";\nimport { swiper, swiperSlide } from 'vue-awesome-swiper';\nimport 'swiper/dist/css/swiper.css';\nimport moment from 'moment';\nimport bookingTable from \"./components#/booking-table\";\nimport memberSearch from '@/views/biz-components/member/member-search/member-search';\nimport { ruleOptions, columns } from \"./booking.config\";\nimport SoldDealGatheringTip from '@/views/biz-modals/sold/deal/gathering-tip';\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering';\nimport SoldDealWaitPay from '@/views/biz-modals/brand/app/pos/wait-pay-result';\nimport { PatternService } from '@/services/pattern.service';\nimport { debounce } from 'lodash-es';\nexport default {\n  name: 'PageShopAppVenueBooking',\n  bem: {\n    b: 'page-shop-app-venue-booking',\n    calendar: 'calendar',\n    list: 'list',\n    right: 'right'\n  },\n  serviceInject: function serviceInject() {\n    return {\n      bookingService: BookingService,\n      pattern: PatternService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      venueList: this.bookingService.venueList$,\n      loading: this.bookingService.loading$,\n      auth: this.bookingService.auth$,\n      hasNext: this.bookingService.hasNext$\n    };\n  },\n  modals: {\n    SoldDealGatheringTip: SoldDealGatheringTip,\n    SoldDealGathering: SoldDealGathering,\n    SoldDealWaitPay: SoldDealWaitPay\n  },\n  components: {\n    swiper: swiper,\n    swiperSlide: swiperSlide,\n    bookingTable: bookingTable,\n    memberSearch: memberSearch\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      sum: 0,\n      finalAmount: 0,\n      reduce_price: '',\n      form: form,\n      decorators: decorators,\n      selectedList: [],\n      columns: columns,\n      sliderOptions: {\n        autoplay: false,\n        navigation: {\n          nextEl: '.swiper-booking-button-next',\n          prevEl: '.swiper-booking-button-prev'\n        },\n        slidesPerView: 7,\n        slidesPerGroup: 7,\n        centeredSlides: false,\n        normalizeSlideIndex: false\n      },\n      calendarData: [],\n      query: {\n        venues_id: '',\n        page: 1,\n        size: 10,\n        reserve_day: ''\n      },\n      pickedIndex: 0,\n      bookingList: [],\n      siteX: [],\n      siteY: []\n    };\n  },\n  mounted: function mounted() {\n    this.calendarData = Array(28).fill().map(function (item, index) {\n      return {\n        week: moment().add(index, 'days').format('ddd'),\n        date: moment().add(index, 'days').format('YYYY-MM-DD'),\n        day: moment().add(index, 'days').format('MM/DD')\n      };\n    });\n    this.query.venues_id = this.venueList[0].venues_id;\n    this.pickDate(this.calendarData[0], 0);\n  },\n  watch: {\n    reduce_price: debounce(function (val) {\n      if (!this.selectedList.length) return;\n      this.calcPrice();\n    }, 500)\n  },\n  methods: {\n    onNextPage: function onNextPage() {\n      var _this = this;\n\n      if (!this.hasNext) return;\n      this.query.page++;\n      this.bookingService.getBookingList(this.query).subscribe(function (res) {\n        _this.bookingList = _this.bookingList.concat(res.list);\n        _this.siteX = _this.siteX.concat(res.site_x);\n        _this.siteY = res.site_y;\n      });\n    },\n    resetPage: function resetPage() {\n      this.form.resetFields();\n      this.reduce_price = '';\n      this.getList();\n    },\n    createdOrderPay: function createdOrderPay(props) {\n      var _this2 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this2.$modalRouter.push({\n          name: 'sold-deal-gathering',\n          props: props,\n          on: {\n            success: resolve,\n            cancel: function cancel() {\n              _this2.resetPage();\n            }\n          }\n        });\n      }); // this.$modalRouter.push({\n      //   name: 'sold-deal-gathering',\n      //   props,\n      //   on: {\n      //     success: res => {\n      //       this.payCallBack(props.order_id, res.type, res)\n      //     },\n      //     cancel: () => {\n      //       this.resetPage()\n      //     }\n      //   }\n      // })\n    },\n    // 等待支付回调modal\n    createdWaitPay: function createdWaitPay(props) {\n      var _this3 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this3.$modalRouter.push({\n          name: 'sold-deal-wait-pay',\n          props: props,\n          on: {\n            success: resolve\n          }\n        });\n      });\n    },\n    payCallBack: function payCallBack(orderId, callBackType, callBackData) {\n      var _this4 = this;\n\n      switch (callBackType) {\n        case 'cancel':\n          this.resetPage();\n          break;\n\n        case 'pay':\n          this.createdGatheringTip({\n            message: '收款成功',\n            order_id: orderId,\n            needPay: false,\n            needContract: false,\n            needTicket: false\n          });\n          break;\n\n        case 'pos':\n          this.createdWaitPay(callBackData).then(function () {\n            _this4.createdGatheringTip({\n              message: '收款成功',\n              order_id: orderId\n            });\n          });\n          break;\n      }\n    },\n    tipCallBack: function tipCallBack(_ref) {\n      var _this5 = this;\n\n      var orderId = _ref.orderId,\n          type = _ref.type;\n\n      switch (type) {\n        case 'cancel':\n          this.resetPage();\n          break;\n\n        case 'ViewOrder':\n          this.createdOrderViewOrder(orderId);\n          break;\n\n        case 'Pay':\n          this.createdOrderPay({\n            order_id: orderId,\n            type: 'venues'\n          }).then(function (res) {\n            _this5.payCallBack(orderId, res.type, res);\n          });\n          break;\n      }\n    },\n    createdGatheringTip: function createdGatheringTip(props) {\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering-tip',\n        props: props,\n        on: {\n          success: this.tipCallBack\n        }\n      });\n    },\n    createdOrderViewOrder: function createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      });\n    },\n    createOrder: function createOrder() {\n      var _this6 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this6.form.validate().then(function (values) {\n          var venues_data = _this6.selectedList.map(function (item) {\n            return {\n              time_start: item.start_time,\n              time_end: item.end_time,\n              venues_site_id: +item.id.replace(/\\-.*/, ''),\n              price: item.price,\n              venues_site_name: item.site_name\n            };\n          });\n\n          values.mobile = values.mobile ? values.mobile.phone : undefined;\n          values.country_prefix = values.mobile ? values.mobile.code_id : undefined;\n          values.parent_mobile = values.parent_mobile ? values.parent_mobile.phone : undefined;\n          values.parent_country_prefix = values.parent_mobile ? values.parent_mobile.code_id : undefined;\n\n          _this6.bookingService.createOrder(_objectSpread({\n            venues_id: _this6.query.venues_id,\n            venues_name: _this6.query.venues_name,\n            reduce_price: _this6.reduce_price,\n            actual_amount: _this6.finalAmount,\n            order_amount: _this6.sum,\n            reserve_day: _this6.query.reserve_day,\n            venues_data: venues_data\n          }, values)).subscribe(function (result) {\n            resolve(result);\n          });\n        });\n      });\n    },\n    onCreateOrder: function onCreateOrder() {\n      var _this7 = this;\n\n      this.createOrder().then(function (result) {\n        var props = {\n          order_id: result.info.order_id,\n          message: '订单创建成功',\n          needPay: true,\n          needContract: false,\n          needTicket: false\n        };\n\n        _this7.createdGatheringTip(props);\n      });\n    },\n    onPay: function onPay() {\n      var _this8 = this;\n\n      this.createOrder().then(function (result) {\n        _this8.createdOrderPay({\n          order_id: result.info.order_id,\n          type: 'venues'\n        }).then(function (res) {\n          _this8.payCallBack(result.info.order_id, res.type, res);\n        });\n      });\n    },\n    deleteRow: function deleteRow(row) {\n      var index;\n      this.selectedList.forEach(function (item, inx) {\n        if (item.id === row.id) {\n          index = inx;\n        }\n      });\n      this.$refs.bookingTable.deleteRow(index);\n    },\n    calcPrice: function calcPrice() {\n      var _this9 = this;\n\n      var list = this.selectedList;\n      var venues_site_time = list.map(function (item) {\n        return {\n          start_time: item.start_time,\n          end_time: item.end_time,\n          site_id: +item.id.replace(/\\-.*/, '')\n        };\n      });\n      var params = {\n        venues_id: this.query.venues_id,\n        date: this.query.reserve_day,\n        reduce_price: this.reduce_price || 0,\n        venues_site_time: venues_site_time\n      };\n      this.bookingService.calcPrice(params).subscribe(function (res) {\n        _this9.sum = res.total_price;\n        _this9.finalAmount = res.price;\n      });\n    },\n    getSelectedList: function getSelectedList(list) {\n      this.selectedList = list;\n\n      if (list.length === 0) {\n        this.sum = 0;\n        this.finalAmount = 0;\n        return;\n      }\n\n      this.calcPrice();\n    },\n    pickDate: function pickDate(dateObj, index) {\n      this.calendarData.forEach(function (item) {\n        return item.ispick = false;\n      });\n      this.pickedIndex = index;\n      this.query.reserve_day = dateObj.date;\n      this.resetPagination();\n      this.getList();\n    },\n    selectHandler: function selectHandler(e) {\n      this.query.venues_id = e.target.value;\n      this.resetPagination();\n      this.getList();\n    },\n    resetPagination: function resetPagination() {\n      this.query.page = 1;\n      this.$refs.bookingTable.resetScroll();\n    },\n    getList: function getList() {\n      var _this10 = this;\n\n      this.bookingService.getBookingList(this.query).subscribe(function (res) {\n        _this10.$refs.bookingTable.deleteAll();\n\n        _this10.bookingList = res.list;\n        _this10.siteX = res.site_x;\n        _this10.siteY = res.site_y;\n      });\n    }\n  }\n};",{"version":3,"sources":["booking.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div :class=\"b()\">\n    <div :class=\"right()\">\n      <div :class=\"right('top')\">\n        <st-t2>代预约</st-t2>\n        <st-table\n          :class=\"right('table')\"\n          :columns=\"columns\"\n          :dataSource=\"selectedList\"\n          rowKey=\"id\"\n          :pagination=\"false\"\n          :scroll=\"{ y: 148 }\"\n        >\n          <div slot=\"action\" slot-scope=\"text, record\">\n            <st-table-actions>\n              <a @click=\"deleteRow(record)\">\n                删除\n              </a>\n            </st-table-actions>\n          </div>\n        </st-table>\n        <div :class=\"right('sum')\">\n          <span v-if=\"sum\">{{ `总额：¥${sum}` }}</span>\n        </div>\n        <st-hr></st-hr>\n        <st-form :form=\"form\" labelWidth=\"88px\">\n          <member-search\n            label=\"购买会员\"\n            :form=\"form\"\n            :decorators=\"decorators\"\n            :fields=\"{ member_id: 'member_id' }\"\n            type=\"transaction\"\n          ></member-search>\n          <st-form-item label=\"减免\">\n            <st-input-number\n              :float=\"true\"\n              v-model=\"reduce_price\"\n              placeholder=\"请输入减免金额\"\n            >\n              <span slot=\"addonAfter\">元</span>\n            </st-input-number>\n          </st-form-item>\n          <st-form-item label=\"备注\" class=\"mg-b0\">\n            <a-textarea\n              placeholder=\"请填写备注\"\n              v-decorator=\"decorators.description\"\n              :autosize=\"{ minRows: 4, maxRows: 6 }\"\n            />\n          </st-form-item>\n        </st-form>\n      </div>\n      <div :class=\"right('footer')\">\n        <div class=\"price\">\n          <span>共{{ selectedList.length }}件商品&nbsp;合计：</span>\n          <span class=\"font-number\">&yen;{{ finalAmount }}</span>\n        </div>\n        <div class=\"button\">\n          <st-button\n            v-if=\"auth.reserve\"\n            @click=\"onCreateOrder\"\n            :loading=\"loading.createOrder\"\n          >\n            预约\n          </st-button>\n          <st-button\n            v-if=\"auth.pay\"\n            type=\"primary\"\n            @click=\"onPay\"\n            :loading=\"loading.createPay\"\n          >\n            预约并收款\n          </st-button>\n        </div>\n      </div>\n    </div>\n    <div :class=\"b('left')\" id=\"booking-left\">\n      <a-radio-group\n        :value=\"query.venues_id\"\n        id=\"booking-left-venue\"\n        @change=\"selectHandler\"\n      >\n        <a-radio-button\n          v-for=\"(item, index) in venueList\"\n          :key=\"index\"\n          :value=\"item.venues_id\"\n        >\n          {{ item.venues_name }}\n        </a-radio-button>\n      </a-radio-group>\n      <div :class=\"calendar()\" id=\"booking-left-calendar\">\n        <div :class=\"calendar('wrapper')\">\n          <swiper :options=\"sliderOptions\">\n            <swiper-slide v-for=\"(item, index) in calendarData\" :key=\"index\">\n              <div\n                :class=\"[calendar('date'), { act: pickedIndex === index }]\"\n                @click=\"pickDate(item, index)\"\n              >\n                <div :class=\"calendar('week')\">{{ item.week }}</div>\n                <div :class=\"calendar('day')\">{{ item.day }}</div>\n              </div>\n            </swiper-slide>\n          </swiper>\n          <div\n            class=\"swiper-button-prev swiper-booking-button-prev\"\n            slot=\"button-prev\"\n          >\n            <div :class=\"calendar('icon')\">\n              <st-icon type=\"arrow-left\" class=\"arrow-left\" />\n            </div>\n          </div>\n\n          <div\n            class=\"swiper-button-next swiper-booking-button-next\"\n            slot=\"button-next\"\n          >\n            <div :class=\"calendar('icon')\">\n              <st-icon type=\"arrow-right\" class=\"arrow-right\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div :class=\"list()\">\n        <a-spin :class=\"list('loading')\" :spinning=\"!!loading.getBookingList\">\n          <booking-table\n            ref=\"bookingTable\"\n            :data=\"bookingList\"\n            :siteX=\"siteX\"\n            :siteY=\"siteY\"\n            :query=\"query\"\n            :selectedData=\"selectedList\"\n            @change=\"getSelectedList\"\n            @nextPage=\"onNextPage\"\n          ></booking-table>\n        </a-spin>\n      </div>\n    </div>\n  </div>\n</template>\n<script>\nimport { BookingService } from './booking.service'\nimport { swiper, swiperSlide } from 'vue-awesome-swiper'\nimport 'swiper/dist/css/swiper.css'\nimport moment from 'moment'\nimport bookingTable from './components#/booking-table'\nimport memberSearch from '@/views/biz-components/member/member-search/member-search'\nimport { ruleOptions, columns } from './booking.config'\nimport SoldDealGatheringTip from '@/views/biz-modals/sold/deal/gathering-tip'\nimport SoldDealGathering from '@/views/biz-modals/sold/deal/gathering'\nimport SoldDealWaitPay from '@/views/biz-modals/brand/app/pos/wait-pay-result'\nimport { PatternService } from '@/services/pattern.service'\nimport { debounce } from 'lodash-es'\nexport default {\n  name: 'PageShopAppVenueBooking',\n  bem: {\n    b: 'page-shop-app-venue-booking',\n    calendar: 'calendar',\n    list: 'list',\n    right: 'right'\n  },\n  serviceInject() {\n    return {\n      bookingService: BookingService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      venueList: this.bookingService.venueList$,\n      loading: this.bookingService.loading$,\n      auth: this.bookingService.auth$,\n      hasNext: this.bookingService.hasNext$\n    }\n  },\n  modals: {\n    SoldDealGatheringTip,\n    SoldDealGathering,\n    SoldDealWaitPay\n  },\n  components: {\n    swiper,\n    swiperSlide,\n    bookingTable,\n    memberSearch\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      sum: 0,\n      finalAmount: 0,\n      reduce_price: '',\n      form,\n      decorators,\n      selectedList: [],\n      columns,\n      sliderOptions: {\n        autoplay: false,\n        navigation: {\n          nextEl: '.swiper-booking-button-next',\n          prevEl: '.swiper-booking-button-prev'\n        },\n        slidesPerView: 7,\n        slidesPerGroup: 7,\n        centeredSlides: false,\n        normalizeSlideIndex: false\n      },\n      calendarData: [],\n      query: {\n        venues_id: '',\n        page: 1,\n        size: 10,\n        reserve_day: ''\n      },\n      pickedIndex: 0,\n      bookingList: [],\n      siteX: [],\n      siteY: []\n    }\n  },\n  mounted() {\n    this.calendarData = Array(28)\n      .fill()\n      .map((item, index) => {\n        return {\n          week: moment()\n            .add(index, 'days')\n            .format('ddd'),\n          date: moment()\n            .add(index, 'days')\n            .format('YYYY-MM-DD'),\n          day: moment()\n            .add(index, 'days')\n            .format('MM/DD')\n        }\n      })\n    this.query.venues_id = this.venueList[0].venues_id\n    this.pickDate(this.calendarData[0], 0)\n  },\n  watch: {\n    reduce_price: debounce(function(val) {\n      if (!this.selectedList.length) return\n      this.calcPrice()\n    }, 500)\n  },\n  methods: {\n    onNextPage() {\n      if (!this.hasNext) return\n      this.query.page++\n      this.bookingService.getBookingList(this.query).subscribe(res => {\n        this.bookingList = this.bookingList.concat(res.list)\n        this.siteX = this.siteX.concat(res.site_x)\n        this.siteY = res.site_y\n      })\n    },\n    resetPage() {\n      this.form.resetFields()\n      this.reduce_price = ''\n      this.getList()\n    },\n    createdOrderPay(props) {\n      return new Promise((resolve, reject) => {\n        this.$modalRouter.push({\n          name: 'sold-deal-gathering',\n          props,\n          on: {\n            success: resolve,\n            cancel: () => {\n              this.resetPage()\n            }\n          }\n        })\n      })\n      // this.$modalRouter.push({\n      //   name: 'sold-deal-gathering',\n      //   props,\n      //   on: {\n      //     success: res => {\n      //       this.payCallBack(props.order_id, res.type, res)\n      //     },\n      //     cancel: () => {\n      //       this.resetPage()\n      //     }\n      //   }\n      // })\n    },\n    // 等待支付回调modal\n    createdWaitPay(props) {\n      return new Promise((resolve, reject) => {\n        this.$modalRouter.push({\n          name: 'sold-deal-wait-pay',\n          props,\n          on: {\n            success: resolve\n          }\n        })\n      })\n    },\n    payCallBack(orderId, callBackType, callBackData) {\n      switch (callBackType) {\n        case 'cancel':\n          this.resetPage()\n          break\n        case 'pay':\n          this.createdGatheringTip({\n            message: '收款成功',\n            order_id: orderId,\n            needPay: false,\n            needContract: false,\n            needTicket: false\n          })\n          break\n        case 'pos':\n          this.createdWaitPay(callBackData).then(() => {\n            this.createdGatheringTip({\n              message: '收款成功',\n              order_id: orderId\n            })\n          })\n          break\n      }\n    },\n    tipCallBack({ orderId, type }) {\n      switch (type) {\n        case 'cancel':\n          this.resetPage()\n          break\n        case 'ViewOrder':\n          this.createdOrderViewOrder(orderId)\n          break\n        case 'Pay':\n          this.createdOrderPay({ order_id: orderId, type: 'venues' }).then(\n            res => {\n              this.payCallBack(orderId, res.type, res)\n            }\n          )\n          break\n      }\n    },\n    createdGatheringTip(props) {\n      this.$modalRouter.push({\n        name: 'sold-deal-gathering-tip',\n        props,\n        on: {\n          success: this.tipCallBack\n        }\n      })\n    },\n    createdOrderViewOrder(order_id) {\n      this.$router.push({\n        name: 'shop-finance-order-info-collection-details',\n        query: {\n          id: order_id\n        }\n      })\n    },\n    createOrder() {\n      return new Promise((resolve, reject) => {\n        this.form.validate().then(values => {\n          const venues_data = this.selectedList.map(item => {\n            return {\n              time_start: item.start_time,\n              time_end: item.end_time,\n              venues_site_id: +item.id.replace(/\\-.*/, ''),\n              price: item.price,\n              venues_site_name: item.site_name\n            }\n          })\n          values.mobile = values.mobile ? values.mobile.phone : undefined\n          values.country_prefix = values.mobile\n            ? values.mobile.code_id\n            : undefined\n          values.parent_mobile = values.parent_mobile\n            ? values.parent_mobile.phone\n            : undefined\n          values.parent_country_prefix = values.parent_mobile\n            ? values.parent_mobile.code_id\n            : undefined\n          this.bookingService\n            .createOrder({\n              venues_id: this.query.venues_id,\n              venues_name: this.query.venues_name,\n              reduce_price: this.reduce_price,\n              actual_amount: this.finalAmount,\n              order_amount: this.sum,\n              reserve_day: this.query.reserve_day,\n              venues_data: venues_data,\n              ...values\n            })\n            .subscribe(result => {\n              resolve(result)\n            })\n        })\n      })\n    },\n    onCreateOrder() {\n      this.createOrder().then(result => {\n        const props = {\n          order_id: result.info.order_id,\n          message: '订单创建成功',\n          needPay: true,\n          needContract: false,\n          needTicket: false\n        }\n        this.createdGatheringTip(props)\n      })\n    },\n    onPay() {\n      this.createOrder().then(result => {\n        this.createdOrderPay({\n          order_id: result.info.order_id,\n          type: 'venues'\n        }).then(res => {\n          this.payCallBack(result.info.order_id, res.type, res)\n        })\n      })\n    },\n    deleteRow(row) {\n      let index\n      this.selectedList.forEach((item, inx) => {\n        if (item.id === row.id) {\n          index = inx\n        }\n      })\n      this.$refs.bookingTable.deleteRow(index)\n    },\n    calcPrice() {\n      const list = this.selectedList\n      const venues_site_time = list.map(item => {\n        return {\n          start_time: item.start_time,\n          end_time: item.end_time,\n          site_id: +item.id.replace(/\\-.*/, '')\n        }\n      })\n      const params = {\n        venues_id: this.query.venues_id,\n        date: this.query.reserve_day,\n        reduce_price: this.reduce_price || 0,\n        venues_site_time\n      }\n      this.bookingService.calcPrice(params).subscribe(res => {\n        this.sum = res.total_price\n        this.finalAmount = res.price\n      })\n    },\n    getSelectedList(list) {\n      this.selectedList = list\n      if (list.length === 0) {\n        this.sum = 0\n        this.finalAmount = 0\n        return\n      }\n      this.calcPrice()\n    },\n    pickDate(dateObj, index) {\n      this.calendarData.forEach(item => (item.ispick = false))\n      this.pickedIndex = index\n      this.query.reserve_day = dateObj.date\n      this.resetPagination()\n      this.getList()\n    },\n    selectHandler(e) {\n      this.query.venues_id = e.target.value\n      this.resetPagination()\n      this.getList()\n    },\n    resetPagination() {\n      this.query.page = 1\n      this.$refs.bookingTable.resetScroll()\n    },\n    getList() {\n      this.bookingService.getBookingList(this.query).subscribe(res => {\n        this.$refs.bookingTable.deleteAll()\n        this.bookingList = res.list\n        this.siteX = res.site_x\n        this.siteY = res.site_y\n      })\n    }\n  }\n}\n</script>\n"],"sourceRoot":"src/views/pages/shop/app/venue"}]}