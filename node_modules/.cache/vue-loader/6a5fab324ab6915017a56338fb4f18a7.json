{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/gathering.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/gathering.vue","mtime":1600926555969},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { GatheringService } from './gathering.service'\nimport { ruleOptions } from './gathering.config'\nimport { PAYMENT_TYPES } from '@/constants/pay'\nimport StPayment from '@/views/biz-components/payment/payment'\nimport StInputPay from '@/views/biz-components/input-pay/input-pay'\nimport BrandAppPosWaitPay from '@/views/biz-modals/brand/app/pos/wait-pay-result'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalSoldDealGathering',\n  bem: {\n    b: 'modal-sold-deal-gathering',\n    bOrderContent: 'modal-sold-deal-gathering-order-content',\n    bOrderPay: 'modal-sold-deal-gathering-order-pay',\n    bPayment: 'modal-sold-deal-gathering-payment',\n    bFooter: 'modal-sold-deal-gathering-footer',\n    bFold: 'modal-sold-deal-gathering-fold'\n  },\n  components: { StPayment, StInputPay },\n  modals: { BrandAppPosWaitPay },\n  serviceProviders() {\n    return [GatheringService]\n  },\n  serviceInject() {\n    return {\n      gatheringService: GatheringService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      info: this.gatheringService.info$,\n      loading: this.gatheringService.loading$,\n      paymentMethodList: this.gatheringService.paymentMethodList$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      description: '',\n      isPosReqError: false,\n      posReqErrorStr: '',\n      contentFold: true,\n      currentPaymentType: -1,\n      inputShowList: [],\n      price: ''\n    }\n  },\n  // 订单id，签单类型\n  props: ['order_id', 'type'],\n  computed: {\n    isStPos() {\n      return this.currentPaymentType > 32\n    }\n  },\n  created() {\n    this.gatheringService\n      .getPaymentInfo(this.order_id, this.type)\n      .subscribe(res => {\n        this.price = parseFloat(res.info.remain_amount)\n        this.inputShowList = [\n          { label: '已收金额(元)', value: this.info.payed_amount, type: 1 },\n          { label: '应收金额(元)', value: this.info.remain_amount, type: 0 }\n        ]\n      })\n  },\n  filters: {\n    dealMaxNumber: value => {\n      if (!value) return\n      return Number(value.substr(0, value.length - 1))\n    }\n  },\n  methods: {\n    onPaymentTypeChange(value) {\n      this.currentPaymentType = value\n    },\n    handleContentToggleFold() {\n      this.contentFold = !this.contentFold\n    },\n    // 关闭modal\n    onCancel() {\n      this.show = false\n      this.$emit('cancel')\n    },\n    onSubmit(e) {\n      e.preventDefault()\n      console.log('isStPos', this.isStPos)\n      if (this.currentPaymentType === -1) {\n        this.messageService.error({\n          content: '请选择支付方式'\n        })\n      }\n      this.form.validate().then(values => {\n        values.order_id = this.order_id\n        values.description = this.description || undefined\n        values.payment_type = this.currentPaymentType\n        values.price = this.price\n        console.log('values', values)\n        this.isReqError = false\n        this.gatheringService.payTransaction(values).subscribe(\n          result => {\n            console.log('result', result)\n            this.isReqError = false\n            // 如果是pos机支付,弹出pos机支付订单状态等待页\n            if (this.isStPos) {\n              this.show = false\n              this.$emit('success', {\n                type: 'pos',\n                order_id: this.order_id,\n                soldId: result.info.sold_id,\n                posInfo: result.info,\n                payInfo: values\n              })\n            } else {\n              this.$emit('success', {\n                type: 'pay',\n                soldId: result.info.sold_id\n              })\n              this.show = false\n            }\n          },\n          err => {\n            // 判断是否是pos机支付方式,并且报错信息为pos机正在使用中\n            if (err && err.response && err.response.code === 108009) {\n              this.isPosReqError = true\n              this.posReqErrorStr = err.response.msg\n            }\n          }\n        )\n      })\n    }\n  }\n}\n",{"version":3,"sources":["gathering.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"gathering.vue","sourceRoot":"src/views/biz-modals/sold/deal","sourcesContent":["<template>\n  <st-modal\n    title=\"订单收款\"\n    v-model=\"show\"\n    wrapClassName=\"modal-sold-deal-gathering\"\n    @cancel=\"onCancel\"\n    width=\"800px\"\n  >\n    <div :class=\"b('content')\">\n      <!-- 支付金额 -->\n      <st-form :form=\"form\">\n        <st-input-pay\n          :isValueCanEdit=\"false\"\n          :max=\"info.remain_amount | dealMaxNumber\"\n          :showList=\"inputShowList\"\n          v-model=\"price\"\n        ></st-input-pay>\n        <div\n          class=\"modal-sold-deal-gathering-order-content\"\n          :class=\"{ contentFold }\"\n        >\n          <!-- 用户信息 -->\n          <div :class=\"bOrderContent('info')\">\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">用户：</span>\n              <!-- <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.member_name }}&nbsp;{{\n                  info.is_minors ? '' : info.member_mobile\n                }}\n              </span>-->\n              <st-overflow-text\n                title=\"用户：\"\n                max-width=\"190px\"\n                :value=\"\n                  `${info.member_name}&nbsp;${\n                    info.is_minors ? '' : info.member_mobile\n                  }`\n                \"\n              ></st-overflow-text>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">购买:</span>\n              <st-overflow-text\n                title=\"购买：\"\n                max-width=\"200px\"\n                :value=\"\n                  info.venues_site &&\n                    info.venues_site.map(\n                      item =>\n                        `${item.site_name} ${item.time_start}~${item.time_end} 金额：&yen;${item.price}元`\n                    )\n                \"\n                v-if=\"type === 'venues'\"\n              ></st-overflow-text>\n              <st-overflow-text\n                title=\"购买：\"\n                max-width=\"200px\"\n                :value=\"\n                  info.order_sub &&\n                    info.order_sub.map(\n                      item =>\n                        `${item.product_name}${item.rule_name ? '规格：' : ''}${\n                          item.rule_name\n                        }*${item.product_count} 金额：&yen;${item.price}`\n                    )\n                \"\n                v-else-if=\"type === 'cloud_store'\"\n              ></st-overflow-text>\n              <st-overflow-text\n                title=\"购买：\"\n                max-width=\"200px\"\n                :value=\"info.rule_name\"\n                v-else\n              ></st-overflow-text>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">销售：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.sale_name }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">\n                {{ type === 'venues' ? '门店：' : '场馆：' }}\n              </span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.shop_name }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\" v-if=\"type === 'venues'\">\n              <span :class=\"bOrderContent('info-item-label')\">预约时间：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.reserve_day }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">下单人：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.operate_name }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\" v-if=\"type === 'venues'\">\n              <span :class=\"bOrderContent('info-item-label')\">赠送：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.gift_amount }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\" v-if=\"type === 'venues'\">\n              <span :class=\"bOrderContent('info-item-label')\">定金抵扣：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.advance_amount }}\n              </span>\n            </div>\n          </div>\n          <!-- 订单信息 -->\n          <div :class=\"bOrderContent('info')\">\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">订单总额：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.order_amount }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">订单号：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.order_id }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">下单时间：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.order_time }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">减免金额：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.reduce_amount }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">优惠金额：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.discount_amount }}\n              </span>\n            </div>\n            <div :class=\"bOrderContent('info-item')\">\n              <span :class=\"bOrderContent('info-item-label')\">应付金额：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.actual_amount }}\n              </span>\n            </div>\n          </div>\n          <!-- 备注 -->\n          <div :class=\"bOrderContent('info')\" v-if=\"type !== 'cloud_store'\">\n            <div :class=\"bOrderContent('info-item')\" style=\"margin-bottom: 0\">\n              <span :class=\"bOrderContent('info-item-label')\">备注：</span>\n              <span :class=\"bOrderContent('info-item-value')\">\n                {{ info.description }}\n              </span>\n            </div>\n          </div>\n        </div>\n        <div :class=\"bFold()\">\n          <div @click=\"handleContentToggleFold\">\n            <span class=\"mg-r4\">{{ contentFold ? '展开' : '收起' }}</span>\n            <st-icon\n              :type=\"contentFold ? 'gathering-down' : 'gathering-up'\"\n              style=\"font-size: 13px\"\n            ></st-icon>\n          </div>\n        </div>\n        <div :class=\"bPayment()\">\n          <!-- 支付方式组件 -->\n          <st-payment\n            :order_id=\"order_id\"\n            :form=\"form\"\n            @change=\"onPaymentTypeChange\"\n          ></st-payment>\n          <!-- 备注信息 -->\n          <div>\n            <a-textarea\n              placeholder=\"请输入备注信息\"\n              style=\"height:32px;\"\n              v-model=\"description\"\n            ></a-textarea>\n          </div>\n        </div>\n      </st-form>\n    </div>\n    <template slot=\"footer\">\n      <div :class=\"bFooter()\">\n        <div :class=\"bFooter('error-tip')\" v-if=\"isStPos && isPosReqError\">\n          当前POS正在使用中，请选择其他POS机或稍后再试\n        </div>\n        <st-button\n          type=\"primary\"\n          @click=\"onSubmit\"\n          :loading=\"loading.payTransaction\"\n        >\n          确认收款\n        </st-button>\n      </div>\n    </template>\n  </st-modal>\n</template>\n\n<script>\nimport { GatheringService } from './gathering.service'\nimport { ruleOptions } from './gathering.config'\nimport { PAYMENT_TYPES } from '@/constants/pay'\nimport StPayment from '@/views/biz-components/payment/payment'\nimport StInputPay from '@/views/biz-components/input-pay/input-pay'\nimport BrandAppPosWaitPay from '@/views/biz-modals/brand/app/pos/wait-pay-result'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'ModalSoldDealGathering',\n  bem: {\n    b: 'modal-sold-deal-gathering',\n    bOrderContent: 'modal-sold-deal-gathering-order-content',\n    bOrderPay: 'modal-sold-deal-gathering-order-pay',\n    bPayment: 'modal-sold-deal-gathering-payment',\n    bFooter: 'modal-sold-deal-gathering-footer',\n    bFold: 'modal-sold-deal-gathering-fold'\n  },\n  components: { StPayment, StInputPay },\n  modals: { BrandAppPosWaitPay },\n  serviceProviders() {\n    return [GatheringService]\n  },\n  serviceInject() {\n    return {\n      gatheringService: GatheringService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      info: this.gatheringService.info$,\n      loading: this.gatheringService.loading$,\n      paymentMethodList: this.gatheringService.paymentMethodList$\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      description: '',\n      isPosReqError: false,\n      posReqErrorStr: '',\n      contentFold: true,\n      currentPaymentType: -1,\n      inputShowList: [],\n      price: ''\n    }\n  },\n  // 订单id，签单类型\n  props: ['order_id', 'type'],\n  computed: {\n    isStPos() {\n      return this.currentPaymentType > 32\n    }\n  },\n  created() {\n    this.gatheringService\n      .getPaymentInfo(this.order_id, this.type)\n      .subscribe(res => {\n        this.price = parseFloat(res.info.remain_amount)\n        this.inputShowList = [\n          { label: '已收金额(元)', value: this.info.payed_amount, type: 1 },\n          { label: '应收金额(元)', value: this.info.remain_amount, type: 0 }\n        ]\n      })\n  },\n  filters: {\n    dealMaxNumber: value => {\n      if (!value) return\n      return Number(value.substr(0, value.length - 1))\n    }\n  },\n  methods: {\n    onPaymentTypeChange(value) {\n      this.currentPaymentType = value\n    },\n    handleContentToggleFold() {\n      this.contentFold = !this.contentFold\n    },\n    // 关闭modal\n    onCancel() {\n      this.show = false\n      this.$emit('cancel')\n    },\n    onSubmit(e) {\n      e.preventDefault()\n      console.log('isStPos', this.isStPos)\n      if (this.currentPaymentType === -1) {\n        this.messageService.error({\n          content: '请选择支付方式'\n        })\n      }\n      this.form.validate().then(values => {\n        values.order_id = this.order_id\n        values.description = this.description || undefined\n        values.payment_type = this.currentPaymentType\n        values.price = this.price\n        console.log('values', values)\n        this.isReqError = false\n        this.gatheringService.payTransaction(values).subscribe(\n          result => {\n            console.log('result', result)\n            this.isReqError = false\n            // 如果是pos机支付,弹出pos机支付订单状态等待页\n            if (this.isStPos) {\n              this.show = false\n              this.$emit('success', {\n                type: 'pos',\n                order_id: this.order_id,\n                soldId: result.info.sold_id,\n                posInfo: result.info,\n                payInfo: values\n              })\n            } else {\n              this.$emit('success', {\n                type: 'pay',\n                soldId: result.info.sold_id\n              })\n              this.show = false\n            }\n          },\n          err => {\n            // 判断是否是pos机支付方式,并且报错信息为pos机正在使用中\n            if (err && err.response && err.response.code === 108009) {\n              this.isPosReqError = true\n              this.posReqErrorStr = err.response.msg\n            }\n          }\n        )\n      })\n    }\n  }\n}\n</script>\n"]}]}