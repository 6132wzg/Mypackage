{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/invitation/index/setting.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/marketing/plugin/invitation/index/setting.vue","mtime":1598250255829},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { SettingService } from './setting.service'\nimport { cloneDeep } from 'lodash-es'\nimport { IndexService } from '../index.service'\nimport StInvitationBgRadio from './components#/invitation-bg-radio'\nimport MarketingAddCoupon from '@/views/biz-modals/marketing/add-coupon'\nimport CouponTag from '@/views/biz-components/coupon-tag/coupon-tag'\nexport default {\n  name: 'PageBrandMarketingInviationSetting',\n  bem: {\n    inviation: 'page-brand-marketing-inviation-setting'\n  },\n  modals: {\n    MarketingAddCoupon\n  },\n  serviceInject() {\n    return {\n      settingService: SettingService,\n      indexService: IndexService\n    }\n  },\n  rxState() {\n    return {\n      isOpen: this.indexService.isOpen$,\n      loading: this.settingService.loading$,\n      settingInfo: this.settingService.settingInfo$,\n      auth: this.settingService.auth$\n    }\n  },\n  data() {\n    return {\n      // 缓存settingInfo\n      settingInfoHistory: null,\n      form: this.$form.createForm(this),\n      // 活动状态\n      openStatus: 1,\n      // 邀请人\n      inviteeCoupon: {},\n      inviteeHelpText: '',\n      inviteeCouponNum: undefined,\n      // 被邀请人\n      inviterCoupon: {},\n      inviterHelpText: '',\n      inviterCouponNum: undefined,\n      // 邀请海报\n      invite_poster: {\n        image_id: 0,\n        image_key: 'image/VZ0RGBwTX7FA1yKb.png',\n        image_url: '',\n        index: 1\n      }\n    }\n  },\n  computed: {\n    inviteeIsOk() {\n      return this.inviteeHelpText === ''\n    },\n    inviterIsOk() {\n      return this.inviterHelpText === ''\n    }\n  },\n  watch: {\n    settingInfo: {\n      deep: true,\n      handler() {\n        this.init()\n      }\n    }\n  },\n  methods: {\n    onConfigHandle() {\n      this.$router.push({\n        path: '/brand/setting/mina/index'\n      })\n    },\n    init() {\n      this.settingInfoHistory = cloneDeep(this.settingInfo)\n      this.inviteeHelpText = ''\n      this.inviterHelpText = ''\n      this.openStatus = this.settingInfo.activity_status === 1 ? 1 : 0\n      if (this.settingInfo.invitee_coupon_id) {\n        // 开启过，需要回显\n        this.inviterCoupon = {\n          id: this.settingInfo.inviter_coupon_id,\n          coupon_name: this.settingInfo.inviter_coupon_name\n        }\n        this.inviterCouponNum = this.settingInfo.inviter_coupon_num\n        this.inviteeCoupon = {\n          id: this.settingInfo.invitee_coupon_id,\n          coupon_name: this.settingInfo.invitee_coupon_name\n        }\n        this.inviteeCouponNum = this.settingInfo.invitee_coupon_num\n        this.invite_poster = this.settingInfo.invite_poster\n      }\n    },\n    // 开关\n    onOpenStatusChange(data) {\n      if (\n        !data &&\n        this.settingInfoHistory.activity_status === 1 &&\n        this.settingInfoHistory.invitee_coupon_id\n      ) {\n        this.$confirm({\n          title: '提示',\n          content: `一旦关闭，全部推广功能将失效，请谨慎操作。`,\n          onCancel: () => {\n            this.openStatus = 1\n          },\n          onOk: () => {\n            let params = { ...this.settingInfoHistory, activity_status: 2 }\n            return this.settingService\n              .edit(params)\n              .toPromise()\n              .then(() => {\n                // 关闭成功\n                this.$router.push({\n                  path: '/brand/marketing/plugin/invitation/index/data'\n                })\n                // this.$router.reload()\n              })\n          }\n        })\n      }\n    },\n    // 校验\n    onValidate(type) {\n      if (!this[`${type}Coupon`]) {\n        this[`${type}HelpText`] = '请选择优惠券'\n        return\n      }\n      if (!this[`${type}CouponNum`]) {\n        this[`${type}HelpText`] = '请输入优惠券数量'\n        return\n      }\n      this[`${type}HelpText`] = ''\n    },\n    // 新增券\n    onAddCoupon(type) {\n      this.$modalRouter.push({\n        name: 'marketing-add-coupon',\n        on: {\n          success: res => {\n            this[`${type}Coupon`] = cloneDeep(res.coupon)\n          }\n        }\n      })\n    },\n    onEditCoupon(type) {\n      this.$modalRouter.push({\n        name: 'marketing-add-coupon',\n        props: {\n          id: this[`${type}Coupon`].id\n        },\n        on: {\n          success: res => {\n            this[`${type}Coupon`] = cloneDeep(res.coupon)\n          }\n        }\n      })\n    },\n    onClose(type) {\n      this[`${type}Coupon`] = {}\n    },\n    onSubmit() {\n      this.onValidate('invitee')\n      this.onValidate('inviter')\n      if (this.inviteeIsOk && this.inviterIsOk) {\n        let fn = this.isOpen ? 'edit' : 'add'\n        console.log(fn)\n        this.settingService[fn]({\n          activity_status: this.openStatus ? 1 : 2,\n          // 邀请人\n          inviter_coupon_id: this.inviterCoupon.id,\n          inviter_coupon_num: +this.inviterCouponNum,\n          // 被邀请人\n          invitee_coupon_id: this.inviteeCoupon.id,\n          invitee_coupon_num: +this.inviteeCouponNum,\n          invite_poster: this.invite_poster\n        }).subscribe(() => {\n          this.$router.push({\n            path: './data'\n          })\n        })\n      }\n    }\n  },\n  mounted() {\n    this.init()\n  },\n  components: {\n    StInvitationBgRadio,\n    CouponTag\n  }\n}\n",null]}