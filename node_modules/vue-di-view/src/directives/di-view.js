import refs from '../refs'

export default {
  name: 'di-view',
  inserted: (el, binding) => {
    if (!binding.value) {
      throw new Error('[v-di-child] should pass arguments')
    }
    if (!binding.value.name) {
      throw new Error('[v-di-child] prop [name] required')
    }

    // 先重置为none 避免布局闪烁
    el.style.display = 'none'

    // 确保placeholder存在
    setTimeout(() => {
      const placeEl = refs[binding.value.name]
      const finded = [...placeEl.children].find(c => c === el)
      if (!finded) {
        placeEl.appendChild(el)
        if ('show' in binding.value && !binding.value.show) {
          el.style.display = 'none'
        } else {
          el.style.display = ''
        }
      }
    })
  },
  componentUpdated(el, binding) {
    if ('show' in binding.value) {
      const newVal = binding.value
      const oldVal = binding.oldValue
      if (newVal.show !== oldVal.show) {
        const placeEl = refs[binding.value.name]
        const finded = [...placeEl.children].find(c => c === el)
        if (!finded) {
          placeEl.appendChild(el)
        }
        el.style.display = newVal.show ? '' : 'none'
      }
    }
  },
  unbind(el, binding) {
    const placeEl = refs[binding.value.name]
    placeEl.removeChild(el)
  }
}
