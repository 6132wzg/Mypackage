{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js!/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-cabinet.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-cabinet.vue","mtime":1594718340047},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/thread-loader/dist/cjs.js","mtime":1591062572352},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/es6.number.constructor\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { SaleCabinetService } from \"./sale-cabinet.service\";\nimport { cloneDeep, get } from 'lodash-es';\nimport { timer } from 'rxjs';\nimport { PatternService } from '@/services/pattern.service';\nimport { ruleOptions } from \"./sale-cabinet.config\";\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue';\nimport MemberSearch from '@/views/biz-components/member-search/member-search';\nexport default {\n  name: 'ModalSoldDealSaleCabinet',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber: EditableContractNumber,\n    MemberSearch: MemberSearch\n  },\n  serviceProviders: function serviceProviders() {\n    return [SaleCabinetService];\n  },\n  serviceInject: function serviceInject() {\n    return {\n      saleCabinetService: SaleCabinetService,\n      pattern: PatternService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.saleCabinetService.loading$,\n      saleList: this.saleCabinetService.saleList$,\n      cabinetList: this.saleCabinetService.cabinetList$,\n      info: this.saleCabinetService.info$,\n      currentPrice: this.saleCabinetService.currentPrice$,\n      orderAmountPrice: this.saleCabinetService.orderAmountPrice$\n    };\n  },\n  props: {\n    id: {\n      type: String\n    },\n    areaId: {\n      type: [String, Number],\n      default: 0\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data: function data() {\n    var form = this.$stForm.create();\n    var decorators = form.decorators(ruleOptions);\n    return {\n      form: form,\n      decorators: decorators,\n      show: false,\n      // 租赁柜\n      cabinetFieldNames: {\n        label: 'name',\n        value: 'id',\n        children: 'cabinets'\n      },\n      cabinetId: '',\n      // 租赁天数\n      disabledCalendar: true,\n      startTime: moment(),\n      days: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      isFollowSalesman: 0\n    };\n  },\n  computed: {\n    // 租赁费用\n    leaseFee: function leaseFee() {\n      if (!this.cabinetId || !this.days > 0) {\n        return '无';\n      } else {\n        return \"\".concat(this.info.price_num * this.days, \"\\u5143\");\n      }\n    },\n    // 小计\n    orderAmount: function orderAmount() {\n      if (!this.cabinetId || !this.days > 0) {\n        return '无';\n      } else {\n        return \"\".concat(this.info.price_num * this.days - +this.reduceAmount - +this.advanceAmount, \"\\u5143\");\n      }\n    },\n    orderAmountText: function orderAmountText() {\n      return this.orderAmount.split('元')[0] < 0 ? '小计不能为负' : '';\n    },\n    saleRangeType: function saleRangeType() {\n      return get(this.info.sale_range, 'type', 1);\n    },\n    hasProductInfo: function hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}';\n    }\n  },\n  watch: {\n    days: function days(newVal, oldVal) {\n      this.getOrderPrice();\n      this.getPrice(this.selectAdvance, +this.reduceAmount);\n    },\n    selectAdvance: {\n      deep: true,\n      handler: function handler(newVal, oldVal) {\n        this.getPrice(newVal, +this.reduceAmount);\n      }\n    },\n    reduceAmount: function reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectAdvance, +newVal);\n    }\n  },\n  created: function created() {\n    var _this = this;\n\n    this.saleCabinetService.orderAmountPrice$.commit(function () {\n      return 0;\n    });\n    this.saleCabinetService.currentPrice$.commit(function () {\n      return 0;\n    });\n    this.saleCabinetService.init().subscribe(function (res) {\n      if (_this.id) {\n        _this.saleCabinetService.getInfo(_this.id).subscribe(function (res) {\n          setTimeout(function () {\n            _this.startTime = cloneDeep(moment(res.info.start_time));\n          });\n        });\n      }\n\n      _this.saleCabinetService.getCabinetList(_this.areaId).subscribe();\n    });\n  },\n  methods: {\n    onMemberChange: function onMemberChange(data) {\n      var _this2 = this;\n\n      this.resetAdvance();\n\n      if (data) {\n        this.saleCabinetService.getAdvanceList(data).subscribe(function (res) {\n          _this2.advanceList = cloneDeep(res.list);\n        });\n      }\n    },\n    // 重置定金选择\n    resetAdvance: function resetAdvance() {\n      this.advanceList = [];\n      this.advanceText = '未选择定金';\n      this.advanceAmount = '';\n      this.selectAdvance = '';\n    },\n    onCabinetChange: function onCabinetChange(data) {\n      this.cabinetId = data[1];\n      this.saleCabinetService.getInfo(data[1]).subscribe();\n    },\n    // 租赁时间\n    disabledEndDate: function disabledEndDate(endValue) {\n      return endValue.valueOf() < this.startTime.valueOf() || endValue.valueOf() > moment().add(999, 'd').valueOf();\n    },\n    // 租赁时间-end\n    endTimeChange: function endTimeChange(data) {\n      this.form.setFieldsValue({\n        endTimeInput: Math.ceil(data.diff(this.startTime, 'minutes') / (24 * 60))\n      });\n      this.days = Math.ceil(data.diff(this.startTime, 'minutes') / (24 * 60));\n    },\n    onEndTimeInputChange: function onEndTimeInputChange(data) {\n      this.days = data;\n      var start = cloneDeep(this.startTime);\n\n      if (data > 0) {\n        // 有效天数\n        this.form.setFieldsValue({\n          endTimePicker: start.add(data, 'd')\n        });\n      } else {\n        // 无效天数\n        this.form.resetFields(['endTimePicker']);\n      }\n    },\n    onSelectAdvance: function onSelectAdvance() {\n      var _this3 = this;\n\n      timer(200).subscribe(function () {\n        _this3.advanceDropdownVisible = false;\n      });\n    },\n    onCancel: function onCancel() {\n      this.resetAdvance();\n    },\n    onSelectAdvanceChange: function onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0;\n        this.advanceText = \"\\u672A\\u9009\\u62E9\\u5B9A\\u91D1\";\n        return;\n      }\n\n      var price = this.advanceList.filter(function (o) {\n        return o.id === data.target.value;\n      })[0].price;\n      this.advanceAmount = price;\n      this.advanceText = \"\".concat(price, \"\\u5143\");\n    },\n    // 获取当前价钱\n    getPrice: function getPrice(advance, reduce) {\n      var memberId = this.form.getFieldValue('member_id');\n      this.saleCabinetService.currentPriceAction$.dispatch({\n        product_id: this.cabinetId,\n        product_type: this.info.contract_type,\n        product_num: this.days,\n        advance_id: advance || undefined,\n        member_id: memberId || undefined,\n        reduce_amount: reduce || undefined\n      });\n    },\n    // 获取订单总额\n    getOrderPrice: function getOrderPrice() {\n      this.saleCabinetService.orderAmountPriceAction$.dispatch({\n        product_id: this.cabinetId,\n        product_type: this.info.contract_type,\n        product_num: this.days\n      });\n    },\n    onCreateOrder: function onCreateOrder() {\n      var _this4 = this;\n\n      this.form.validate().then(function (values) {\n        var reduce_amount = _this4.reduceAmount ? +_this4.reduceAmount : 0;\n\n        _this4.saleCabinetService.setTransaction({\n          cabinet_id: +_this4.cabinetId,\n          start_time: \"\".concat(_this4.startTime.format('YYYY-MM-DD HH:mm')),\n          end_time: \"\".concat(values.endTimePicker.format('YYYY-MM-DD HH:mm')),\n          lease_days: +_this4.days,\n          contract_number: _this4.info.contract_number,\n          advance_id: _this4.selectAdvance === -1 ? undefined : _this4.selectAdvance,\n          reduce_amount: reduce_amount,\n          order_amount: _this4.currentPrice,\n          member_id: +values.member_id,\n          member_name: values.member_name,\n          mobile: values.mobile ? values.mobile.phone : undefined,\n          sale_id: +values.saleName,\n          description: _this4.description,\n          sale_range: +_this4.info.sale_range.type,\n          is_minors: values.is_minors,\n          parent_name: values.parent_name,\n          parent_mobile: values.parent_mobile ? values.parent_mobile.phone : undefined,\n          parent_country_prefix: values.parent_mobile ? values.parent_mobile.code_id : undefined,\n          parent_user_role: values.parent_user_role,\n          physical_id: values.physical_id,\n          card_num: values.card_num,\n          id_card: values.id_card,\n          id_card_type: values.id_card_type,\n          is_follow_salesman: _this4.isFollowSalesman\n        }).subscribe(function (res) {\n          _this4.show = false;\n\n          _this4.$emit('success', {\n            type: 'create',\n            orderId: res.info.order_id\n          });\n        });\n      });\n    },\n    onPay: function onPay() {\n      var _this5 = this;\n\n      this.form.validate().then(function (values) {\n        var reduce_amount = _this5.reduceAmount ? +_this5.reduceAmount : 0;\n\n        _this5.saleCabinetService.setTransactionPay({\n          cabinet_id: +_this5.cabinetId,\n          start_time: \"\".concat(_this5.startTime.format('YYYY-MM-DD HH:mm')),\n          end_time: \"\".concat(values.endTimePicker.format('YYYY-MM-DD HH:mm')),\n          lease_days: +_this5.days,\n          contract_number: _this5.info.contract_number,\n          advance_id: _this5.selectAdvance === -1 ? undefined : _this5.selectAdvance,\n          reduce_amount: reduce_amount,\n          order_amount: _this5.currentPrice,\n          member_id: +values.member_id,\n          member_name: values.member_name,\n          mobile: values.mobile ? values.mobile.phone : undefined,\n          sale_id: +values.saleName,\n          description: _this5.description,\n          sale_range: +_this5.info.sale_range.type,\n          is_minors: values.is_minors,\n          parent_name: values.parent_name,\n          parent_mobile: values.parent_mobile ? values.parent_mobile.phone : undefined,\n          parent_country_prefix: values.parent_mobile ? values.parent_mobile.code_id : undefined,\n          parent_user_role: values.parent_user_role,\n          physical_id: values.physical_id,\n          card_num: values.card_num,\n          id_card: values.id_card,\n          id_card_type: values.id_card_type,\n          is_follow_salesman: _this5.isFollowSalesman\n        }).subscribe(function (res) {\n          _this5.show = false;\n\n          _this5.$emit('success', {\n            type: 'createPay',\n            orderId: res.info.order_id\n          });\n        });\n      });\n    }\n  }\n};",null]}