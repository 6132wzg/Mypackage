{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/reception/index.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/shop/reception/index.vue","mtime":1600926556431},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { IndexService } from \"./index.service\";\nimport { cloneDeep, debounce, get } from 'lodash-es';\nimport moment from 'moment';\nimport FrontAddMember from '@/views/biz-modals/front/add-member';\nimport ShopReceptionEntrance from '@/views/biz-modals/shop/reception/entrance';\nimport TodoList from \"./components#/todolist\";\nimport MemberOnline from \"./components#/member-online\";\nimport ShortcutNav from \"./components#/shortcut-nav\";\nimport ShortcutModel from \"./components#/shortcut-model\";\nimport { enumFilter } from \"../../../../filters/other.filters\";\nimport { tap } from 'rxjs/operators';\nexport default {\n  name: 'PageShopReception',\n  bem: {\n    reception: 'page-shop-reception'\n  },\n  modals: {\n    FrontAddMember: FrontAddMember,\n    ShopReceptionEntrance: ShopReceptionEntrance\n  },\n  serviceInject: function serviceInject() {\n    return {\n      indexService: IndexService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      auth: this.indexService.auth$,\n      memberList: this.indexService.memberList$,\n      hasNext: this.indexService.hasNext$,\n      page: this.indexService.page$,\n      loading: this.indexService.loading$,\n      parent_types: this.indexService.parent_types$\n    };\n  },\n  components: {\n    TodoList: TodoList,\n    MemberOnline: MemberOnline,\n    ShortcutNav: ShortcutNav,\n    ShortcutModel: ShortcutModel\n  },\n  data: function data() {\n    return {\n      // 搜索会员的关键字\n      memberSearchText: '',\n      // 搜索会员的最后一次关键字\n      lastMemberSearchText: '',\n      // 选择的会员\n      selectMember: undefined,\n      // memberId\n      memberId: undefined,\n      page: {\n        current_page: 1,\n        size: 10\n      },\n      memberSearchOpen: false\n    };\n  },\n  computed: {\n    isSearchNone: function isSearchNone() {\n      return this.memberSearchText !== '' && !this.memberList.length;\n    },\n    // 是否确定了会员\n    isSelectMember: function isSelectMember() {\n      return this.selectMember && this.memberId && this.memberList.length;\n    }\n  },\n  mounted: function mounted() {\n    var _this = this;\n\n    if (this.auth.checkinPage) {\n      this.indexService.getMemberOnlineList().subscribe(function (res) {\n        setTimeout(function () {\n          _this.$refs.searchSelect.$el.click();\n        }, 200);\n      });\n    }\n  },\n  methods: {\n    handleRefresh: function handleRefresh() {\n      var _this2 = this;\n\n      this.indexService.getMemberOnlineList().subscribe(function () {\n        setTimeout(function () {\n          _this2.$refs.searchSelect.$el.click();\n        }, 200);\n      });\n    },\n    handleMemberSearch: function handleMemberSearch() {\n      var _this3 = this;\n\n      console.log('handleMemberSearch', this.memberId);\n      this.lastMemberSearchText = '';\n      this.memberSearchText = '';\n      this.$modalRouter.push({\n        name: 'shop-reception-entrance',\n        props: {\n          member_id: this.memberId\n        },\n        on: {\n          done: function done() {\n            _this3.selectMember = undefined;\n            _this3.memberId = undefined;\n            _this3.lastMemberSearchText = '';\n            _this3.memberSearchText = '';\n\n            _this3.indexService.setMemberList([]);\n\n            if (_this3.auth.checkinPage) {\n              _this3.indexService.getMemberOnlineList().subscribe(function (res) {\n                setTimeout(function () {\n                  _this3.$refs.searchSelect.$el.click();\n                }, 200);\n              });\n            } else {\n              setTimeout(function () {\n                _this3.$refs.searchSelect.$el.click();\n              }, 200);\n            }\n          }\n        }\n      });\n    },\n    selectItemLabel: function selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return \"\".concat(item.member_name, \"(\\u672A\\u6210\\u5E74) \").concat(item.parent_mobile, \"(\").concat(this.filterParentUserRole(item), \")\");\n      }\n\n      return \"\".concat(item.member_name, \" \").concat(item.mobile);\n    },\n    filterParentUserRole: function filterParentUserRole(item) {\n      return this.parent_types.filter(function (i) {\n        return i.value === item.parent_user_role;\n      })[0].label;\n    },\n    // 搜索会员\n    onMemberSearch: function onMemberSearch(data) {\n      this.memberSearchOpen = true;\n\n      if (!this.hasNext && this.memberSearchText === data.trim()) {\n        return;\n      }\n\n      if (this.memberSearchText !== data.trim()) {\n        this.page.current_page = 1;\n        this.indexService.setMemberList([]);\n      }\n\n      this.memberSearchText = data.trim();\n\n      if (data.trim() !== '') {\n        this.lastMemberSearchText = data.trim();\n        this.indexService.memberListAction$.dispatch({\n          keyword: data,\n          current_page: this.page.current_page,\n          size: this.page.size\n        });\n      }\n    },\n    // 选择了会员\n    onMemberSelect: function onMemberSelect(data) {\n      this.selectMember = data;\n      this.memberId = data;\n      this.handleMemberSearch();\n    },\n    // 监听回车入场\n    onMemberEnter: function onMemberEnter(e) {\n      var _this4 = this;\n\n      var keyCode = e.keyCode;\n\n      if (keyCode === 13 && !this.memberList.length && !this.loading.getMemberList) {\n        this.indexService.getMemberList({\n          keyword: this.lastMemberSearchText\n        }).subscribe(function (res) {\n          var list = res.list;\n          var id = list.length ? list[0]['id'] : undefined;\n\n          if (id) {\n            _this4.onMemberSelect(id);\n          } else {\n            _this4.selectMember = undefined;\n            _this4.memberId = undefined;\n            _this4.lastMemberSearchText = '';\n            _this4.memberSearchText = '';\n\n            _this4.indexService.setMemberList([]);\n\n            _this4.$refs.searchSelect.$children[0]['setInputValue']('');\n          }\n        });\n      }\n    },\n    // 会员搜索框失去焦点\n    onMemberBlur: function onMemberBlur() {\n      this.memberId = undefined;\n      this.selectMember = undefined;\n      this.lastMemberSearchText = '';\n      this.memberSearchText = '';\n      this.memberSearchOpen = false;\n      this.indexService.setMemberList([]);\n    },\n    onMemberFocus: function onMemberFocus() {\n      if (!this.memberSearchText) {\n        this.memberSearchOpen = false;\n        return;\n      }\n\n      if (!this.memberSearchOpen) this.memberSearchOpen = true;\n    },\n    // 新增会员\n    onAddUser: function onAddUser() {\n      var _this5 = this;\n\n      this.$modalRouter.push({\n        name: 'front-add-member',\n        on: {\n          success: function success(res) {\n            _this5.onMemberSelect(res.id);\n\n            _this5.onMemberSearch(res.name);\n          }\n        }\n      });\n    },\n    scroll: debounce(function (e) {\n      var target = e.target;\n\n      if (Math.floor(target.scrollTop) + target.clientHeight > target.scrollHeight - 20) {\n        if (this.hasNext) {\n          this.page.current_page++;\n          this.onMemberSearch(this.memberSearchText);\n        }\n      }\n    }, 200)\n  }\n};",{"version":3,"sources":["index.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div :class=\"reception()\">\n    <div :class=\"reception('wrapper')\">\n      <div :class=\"reception('main')\">\n        <shortcut-nav></shortcut-nav>\n        <div class=\"member\">\n          <div class=\"member-wrapper\">\n            <div class=\"member-title\">会员入离场</div>\n            <div class=\"member-search\">\n              <a-select\n                v-model=\"selectMember\"\n                class=\"member-search-select\"\n                showSearch\n                allowClear\n                :showArrow=\"false\"\n                placeholder=\"输入手机号码、姓名、卡号进行搜索\"\n                :defaultActiveFirstOption=\"true\"\n                :filterOption=\"false\"\n                :open=\"memberSearchOpen\"\n                dropdownClassName=\"member-search-select-dropdown\"\n                @popupScroll=\"scroll\"\n                @select=\"onMemberSelect\"\n                @search=\"onMemberSearch\"\n                @inputKeydown=\"onMemberEnter\"\n                @blur=\"onMemberBlur\"\n                @focus=\"onMemberFocus\"\n                ref=\"searchSelect\"\n              >\n                <a-spin\n                  size=\"small\"\n                  v-if=\"loading.getMemberList\"\n                  slot=\"notFoundContent\"\n                ></a-spin>\n                <span slot=\"notFoundContent\" v-else-if=\"isSearchNone\">\n                  查无此用户，\n                  <a @click=\"onAddUser\">新增新用户？</a>\n                </span>\n                <span slot=\"notFoundContent\" v-else>无搜索结果</span>\n                <a-select-option v-for=\"item in memberList\" :key=\"item.id\">\n                  <span\n                    v-html=\"\n                      `${selectItemLabel(item)}`.replace(\n                        new RegExp(lastMemberSearchText, 'g'),\n                        `\\<span class='global-highlight-color'\\>${lastMemberSearchText}\\<\\/span\\>`\n                      )\n                    \"\n                  >\n                    {{ selectItemLabel(item) }}\n                  </span>\n                </a-select-option>\n                <!-- !isSearchNone && page.current_page < page.total_pages  -->\n                <!-- <a-select-option\n                  disabled\n                  :class=\"reception('member-search-tip')\"\n                  :key=\"new Date() + Math.random()\"\n                  v-if=\"!isSearchNone && page.current_page >= page.total_pages\"\n                >\n                  已经到底啦\n                </a-select-option> -->\n              </a-select>\n              <st-button\n                class=\"search\"\n                :disabled=\"!isSelectMember\"\n                @click=\"handleMemberSearch\"\n              >\n                <a-icon type=\"search\"></a-icon>\n              </st-button>\n            </div>\n          </div>\n        </div>\n        <shortcut-model></shortcut-model>\n      </div>\n      <div :class=\"reception('aside')\">\n        <member-online v-if=\"auth.checkinPage\" @refresh=\"handleRefresh\" />\n        <todo-list />\n      </div>\n    </div>\n  </div>\n</template>\n<script>\nimport { IndexService } from './index.service'\nimport { cloneDeep, debounce, get } from 'lodash-es'\nimport moment from 'moment'\nimport FrontAddMember from '@/views/biz-modals/front/add-member'\nimport ShopReceptionEntrance from '@/views/biz-modals/shop/reception/entrance'\nimport TodoList from './components#/todolist'\nimport MemberOnline from './components#/member-online'\nimport ShortcutNav from './components#/shortcut-nav'\nimport ShortcutModel from './components#/shortcut-model'\nimport { enumFilter } from '../../../../filters/other.filters'\nimport { tap } from 'rxjs/operators'\nexport default {\n  name: 'PageShopReception',\n  bem: {\n    reception: 'page-shop-reception'\n  },\n  modals: {\n    FrontAddMember,\n    ShopReceptionEntrance\n  },\n  serviceInject() {\n    return {\n      indexService: IndexService\n    }\n  },\n  rxState() {\n    return {\n      auth: this.indexService.auth$,\n      memberList: this.indexService.memberList$,\n      hasNext: this.indexService.hasNext$,\n      page: this.indexService.page$,\n      loading: this.indexService.loading$,\n      parent_types: this.indexService.parent_types$\n    }\n  },\n  components: {\n    TodoList,\n    MemberOnline,\n    ShortcutNav,\n    ShortcutModel\n  },\n  data() {\n    return {\n      // 搜索会员的关键字\n      memberSearchText: '',\n      // 搜索会员的最后一次关键字\n      lastMemberSearchText: '',\n      // 选择的会员\n      selectMember: undefined,\n      // memberId\n      memberId: undefined,\n      page: {\n        current_page: 1,\n        size: 10\n      },\n      memberSearchOpen: false\n    }\n  },\n  computed: {\n    isSearchNone() {\n      return this.memberSearchText !== '' && !this.memberList.length\n    },\n    // 是否确定了会员\n    isSelectMember() {\n      return this.selectMember && this.memberId && this.memberList.length\n    }\n  },\n  mounted() {\n    if (this.auth.checkinPage) {\n      this.indexService.getMemberOnlineList().subscribe(res => {\n        setTimeout(() => {\n          this.$refs.searchSelect.$el.click()\n        }, 200)\n      })\n    }\n  },\n  methods: {\n    handleRefresh() {\n      this.indexService.getMemberOnlineList().subscribe(() => {\n        setTimeout(() => {\n          this.$refs.searchSelect.$el.click()\n        }, 200)\n      })\n    },\n    handleMemberSearch() {\n      console.log('handleMemberSearch', this.memberId)\n      this.lastMemberSearchText = ''\n      this.memberSearchText = ''\n      this.$modalRouter.push({\n        name: 'shop-reception-entrance',\n        props: {\n          member_id: this.memberId\n        },\n        on: {\n          done: () => {\n            this.selectMember = undefined\n            this.memberId = undefined\n            this.lastMemberSearchText = ''\n            this.memberSearchText = ''\n            this.indexService.setMemberList([])\n            if (this.auth.checkinPage) {\n              this.indexService.getMemberOnlineList().subscribe(res => {\n                setTimeout(() => {\n                  this.$refs.searchSelect.$el.click()\n                }, 200)\n              })\n            } else {\n              setTimeout(() => {\n                this.$refs.searchSelect.$el.click()\n              }, 200)\n            }\n          }\n        }\n      })\n    },\n    selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return `${item.member_name}(未成年) ${\n          item.parent_mobile\n        }(${this.filterParentUserRole(item)})`\n      }\n      return `${item.member_name} ${item.mobile}`\n    },\n    filterParentUserRole(item) {\n      return this.parent_types.filter(i => i.value === item.parent_user_role)[0]\n        .label\n    },\n    // 搜索会员\n    onMemberSearch(data) {\n      this.memberSearchOpen = true\n      if (!this.hasNext && this.memberSearchText === data.trim()) {\n        return\n      }\n      if (this.memberSearchText !== data.trim()) {\n        this.page.current_page = 1\n        this.indexService.setMemberList([])\n      }\n      this.memberSearchText = data.trim()\n      if (data.trim() !== '') {\n        this.lastMemberSearchText = data.trim()\n        this.indexService.memberListAction$.dispatch({\n          keyword: data,\n          current_page: this.page.current_page,\n          size: this.page.size\n        })\n      }\n    },\n    // 选择了会员\n    onMemberSelect(data) {\n      this.selectMember = data\n      this.memberId = data\n      this.handleMemberSearch()\n    },\n    // 监听回车入场\n    onMemberEnter(e) {\n      let keyCode = e.keyCode\n      if (\n        keyCode === 13 &&\n        !this.memberList.length &&\n        !this.loading.getMemberList\n      ) {\n        this.indexService\n          .getMemberList({\n            keyword: this.lastMemberSearchText\n          })\n          .subscribe(res => {\n            let list = res.list\n            let id = list.length ? list[0]['id'] : undefined\n            if (id) {\n              this.onMemberSelect(id)\n            } else {\n              this.selectMember = undefined\n              this.memberId = undefined\n              this.lastMemberSearchText = ''\n              this.memberSearchText = ''\n              this.indexService.setMemberList([])\n              this.$refs.searchSelect.$children[0]['setInputValue']('')\n            }\n          })\n      }\n    },\n    // 会员搜索框失去焦点\n    onMemberBlur() {\n      this.memberId = undefined\n      this.selectMember = undefined\n      this.lastMemberSearchText = ''\n      this.memberSearchText = ''\n      this.memberSearchOpen = false\n      this.indexService.setMemberList([])\n    },\n    onMemberFocus() {\n      if (!this.memberSearchText) {\n        this.memberSearchOpen = false\n        return\n      }\n      if (!this.memberSearchOpen) this.memberSearchOpen = true\n    },\n    // 新增会员\n    onAddUser() {\n      this.$modalRouter.push({\n        name: 'front-add-member',\n        on: {\n          success: res => {\n            this.onMemberSelect(res.id)\n            this.onMemberSearch(res.name)\n          }\n        }\n      })\n    },\n    scroll: debounce(function(e) {\n      const { target } = e\n      if (\n        Math.floor(target.scrollTop) + target.clientHeight >\n        target.scrollHeight - 20\n      ) {\n        if (this.hasNext) {\n          this.page.current_page++\n          this.onMemberSearch(this.memberSearchText)\n        }\n      }\n    }, 200)\n  }\n}\n</script>\n"],"sourceRoot":"src/views/pages/shop/reception"}]}