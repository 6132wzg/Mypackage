{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/brand/app/pos/wait-pay-result.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/brand/app/pos/wait-pay-result.vue","mtime":1600926555825},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { WaitPayResultService } from \"./wait-pay-result.service\";\nimport { WsNotifyService } from '@/views/layouts/default#/ws-notify.service';\nimport { MessageService } from '@/services/message.service';\nexport default {\n  name: 'waitPayResult',\n  bem: {\n    b: 'brand-app-pos-wait-pay'\n  },\n  modals: {},\n  components: {},\n  serviceInject: function serviceInject() {\n    return {\n      waitPayResultService: WaitPayResultService,\n      notifyService: WsNotifyService,\n      messageService: MessageService\n    };\n  },\n  rxState: function rxState() {\n    return {\n      loading: this.waitPayResultService.loading$,\n      message: this.notifyService.message$\n    };\n  },\n  props: {\n    payInfo: {\n      type: Object,\n      default: function _default() {}\n    },\n    posInfo: {\n      type: Object,\n      default: function _default() {}\n    }\n  },\n  data: function data() {\n    return {\n      show: false,\n      timer: null,\n      time: 0,\n      timeStr: '',\n      currentMsgId: ''\n    };\n  },\n  watch: {\n    message: function message(newV) {\n      this.handlePaySuccess(newV);\n    }\n  },\n  mounted: function mounted() {\n    this.handleSendPosMessage();\n    this.handleStartCountDown();\n  },\n  methods: {\n    // 开启倒计时\n    handleStartCountDown: function handleStartCountDown() {\n      this.time = this.posInfo.expire_time || 0;\n\n      if (this.time) {\n        this.timeStr = moment(this.time).format('mm:ss');\n        this.setTimer();\n      }\n    },\n    // 向后端发送pos机信息\n    handleSendPosMessage: function handleSendPosMessage() {\n      var msg_id = this.notifyService.creatMsgId();\n      this.currentMsgId = msg_id;\n      this.notifyService.send({\n        msg_id: msg_id,\n        msg_type: 5,\n        payload: {\n          order_id: this.payInfo.order_id,\n          serial_no: this.posInfo.pos_serial_no\n        }\n      });\n    },\n    // 收款成功\n    handlePaySuccess: function handlePaySuccess(data) {\n      var _this = this;\n\n      if (data.msg_type !== 5) return false; // 判断当前荷载中order_id是否一致\n\n      if (data.payload.order_id !== this.payInfo.order_id) return false; // 判断消息id是否一致\n\n      if (data.payload.msg_id !== this.currentMsgId) return false; // 此处需要加入定时器,存在弹窗显隐问题,确保弹窗dom生成后,在将弹窗show设置为false\n\n      if (data.payload.status !== 1) return false;\n\n      if (data.payload.status === 3) {\n        this.messageService.error({\n          content: '支付失败'\n        });\n      } else if (data.payload.status === 1) {\n        setTimeout(function () {\n          // 支付成功回调\n          _this.$emit('success', {\n            type: 'pay'\n          });\n\n          _this.show = false;\n        }, 300);\n      }\n    },\n    // 确认支付\n    handlePay: function handlePay() {\n      var _this2 = this;\n\n      if (this.loading.payTransaction) return false;\n      var params = Object.assign(this.payInfo, {\n        pos_confirm: 1,\n        serial_no: this.posInfo.pos_serial_no\n      });\n      this.waitPayResultService.payTransaction(params).subscribe(function (res) {\n        // 支付成功回调\n        _this2.$emit('success', {\n          type: 'pay'\n        });\n\n        _this2.show = false;\n      });\n    },\n    setTimer: function setTimer() {\n      var _this3 = this;\n\n      clearInterval(this.timer);\n      this.timer = setInterval(function () {\n        if (_this3.time <= 1000) {\n          clearInterval(_this3.timer);\n          _this3.show = false;\n        }\n\n        _this3.time = _this3.time - 1000;\n        _this3.timeStr = moment(_this3.time).format('mm:ss');\n      }, 1000);\n    }\n  },\n  destroyed: function destroyed() {\n    clearInterval(this.timer);\n  }\n};",{"version":3,"sources":["wait-pay-result.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <st-modal title=\"\" v-model=\"show\" width=\"500px\" :class=\"b()\">\n    <div :class=\"b('countdown')\">{{ timeStr }}</div>\n    <div :class=\"b('desc')\">已将订单发送至“{{ posInfo.pos_name }}”</div>\n    <div :class=\"b('status')\">等待会员付款…</div>\n    <template slot=\"footer\">\n      <div :class=\"b('tip')\">\n        <div>\n          会员已支付，弹窗无响应？点击这里手动\n          <span @click=\"handlePay\">确认支付</span>\n        </div>\n        <div>关闭弹窗不影响POS机订单收款</div>\n      </div>\n    </template>\n  </st-modal>\n</template>\n<script>\nimport { WaitPayResultService } from './wait-pay-result.service'\nimport { WsNotifyService } from '@/views/layouts/default#/ws-notify.service'\nimport { MessageService } from '@/services/message.service'\nexport default {\n  name: 'waitPayResult',\n  bem: {\n    b: 'brand-app-pos-wait-pay'\n  },\n  modals: {},\n  components: {},\n  serviceInject() {\n    return {\n      waitPayResultService: WaitPayResultService,\n      notifyService: WsNotifyService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.waitPayResultService.loading$,\n      message: this.notifyService.message$\n    }\n  },\n  props: {\n    payInfo: {\n      type: Object,\n      default: () => {}\n    },\n    posInfo: {\n      type: Object,\n      default: () => {}\n    }\n  },\n  data() {\n    return {\n      show: false,\n      timer: null,\n      time: 0,\n      timeStr: '',\n      currentMsgId: ''\n    }\n  },\n  watch: {\n    message(newV) {\n      this.handlePaySuccess(newV)\n    }\n  },\n  mounted() {\n    this.handleSendPosMessage()\n    this.handleStartCountDown()\n  },\n  methods: {\n    // 开启倒计时\n    handleStartCountDown() {\n      this.time = this.posInfo.expire_time || 0\n      if (this.time) {\n        this.timeStr = moment(this.time).format('mm:ss')\n        this.setTimer()\n      }\n    },\n    // 向后端发送pos机信息\n    handleSendPosMessage() {\n      let msg_id = this.notifyService.creatMsgId()\n      this.currentMsgId = msg_id\n      this.notifyService.send({\n        msg_id,\n        msg_type: 5,\n        payload: {\n          order_id: this.payInfo.order_id,\n          serial_no: this.posInfo.pos_serial_no\n        }\n      })\n    },\n    // 收款成功\n    handlePaySuccess(data) {\n      if (data.msg_type !== 5) return false\n      // 判断当前荷载中order_id是否一致\n      if (data.payload.order_id !== this.payInfo.order_id) return false\n      // 判断消息id是否一致\n      if (data.payload.msg_id !== this.currentMsgId) return false\n      // 此处需要加入定时器,存在弹窗显隐问题,确保弹窗dom生成后,在将弹窗show设置为false\n      if (data.payload.status !== 1) return false\n      if (data.payload.status === 3) {\n        this.messageService.error({ content: '支付失败' })\n      } else if (data.payload.status === 1) {\n        setTimeout(() => {\n          // 支付成功回调\n          this.$emit('success', {\n            type: 'pay'\n          })\n          this.show = false\n        }, 300)\n      }\n    },\n    // 确认支付\n    handlePay() {\n      if (this.loading.payTransaction) return false\n      let params = Object.assign(this.payInfo, {\n        pos_confirm: 1,\n        serial_no: this.posInfo.pos_serial_no\n      })\n      this.waitPayResultService.payTransaction(params).subscribe(res => {\n        // 支付成功回调\n        this.$emit('success', {\n          type: 'pay'\n        })\n        this.show = false\n      })\n    },\n    setTimer() {\n      clearInterval(this.timer)\n      this.timer = setInterval(() => {\n        if (this.time <= 1000) {\n          clearInterval(this.timer)\n          this.show = false\n        }\n        this.time = this.time - 1000\n        this.timeStr = moment(this.time).format('mm:ss')\n      }, 1000)\n    }\n  },\n  destroyed() {\n    clearInterval(this.timer)\n  }\n}\n</script>\n"],"sourceRoot":"src/views/biz-modals/brand/app/pos"}]}