{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/product/package/component#/form.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/pages/brand/product/package/component#/form.vue","mtime":1597396799966},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { PatternService } from '@/services/pattern.service'\nimport ReserveIsLimit from './reserveIsLimit'\nimport { ruleOptions } from './form.config'\nimport StEditor from '@/views/biz-components/st/editor/editor.vue'\nimport SelectShop from '@/views/fragments/shop/select-shop'\nimport StImageUpload from '@/views/biz-components/st/image-upload/image-upload.vue'\nimport { FormService } from './form.service'\nimport moment from 'moment'\nimport { SHOP_RANGE, SHELF_STATUS } from '@/constants/course/package.ts'\nimport { cloneDeep, intersection } from 'lodash-es'\nexport default {\n  name: 'BrandPackageAdd',\n  bem: {\n    b: 'brand-package-add'\n  },\n  components: {\n    SelectShop,\n    StEditor,\n    ReserveIsLimit,\n    StImageUpload\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      formService: FormService\n    }\n  },\n  rxState() {\n    const {\n      supportSales$,\n      unitList$,\n      auth$,\n      transferUnitList$,\n      sellTypeList$\n    } = this.formService\n    return { supportSales$, unitList$, auth$, transferUnitList$, sellTypeList$ }\n  },\n  props: {\n    initInfo: {\n      type: Object,\n      default: () => {\n        return {}\n      }\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    }\n  },\n  watch: {\n    content(newValue) {\n      if (newValue && newValue.length > 10000) {\n        this.validateIntro = '输入字数不能超过10000， 请减少输入'\n      } else {\n        this.validateIntro = ''\n      }\n    },\n    fileList: {\n      handler: function(newValue, oldValue) {\n        if (!newValue.length) {\n          this.validateImage = '请上传封面'\n        } else {\n          this.validateImage = ''\n        }\n      },\n      deep: true\n    },\n    userShopList: {\n      handler: function(newValue, oldValue) {\n        if (intersection(newValue, oldValue).length !== oldValue.length) {\n          this.$emit('rest-use-shop')\n        }\n        this.$emit('use-shop', {\n          use_range: this.userRange,\n          use_shop_list: this.useShopIds\n        })\n      },\n      deep: true\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      SHOP_RANGE,\n      SHELF_STATUS,\n      moment,\n      validateIntro: '',\n      validateUseShop: '',\n      validateSaleShop: '',\n      form,\n      decorators,\n      isTransfer: false,\n      validateImage: '',\n      transfer: {\n        transfer_unit: 1,\n        is_allow_transfer: 0\n      },\n      packageData: {\n        transfer_unit: 1,\n        is_allow_transfer: 0,\n        sale_mode: [1]\n      },\n      reserveIsLimitOptions: [\n        { label: '不限制', value: 0 },\n        { label: '限制', value: 1 }\n      ],\n      useShopIds: [],\n      saleShopIds: [],\n      image: {},\n      content: '',\n      imageErrorText: '',\n      fileList: [],\n      saleDate: [null, null],\n      cropperModal: {},\n      reserveIsLimitInfo: {},\n      userRange: 3,\n      saleRange: 3,\n      // 支持使用门店\n      userShopList: [],\n      // 支持售卖门店\n      saleShopList: [],\n      // 备注\n      remarks: ''\n    }\n  },\n  methods: {\n    getFormdata(values) {\n      const obj = cloneDeep(values) || {}\n      console.log('this.image', this.image)\n      // 处理售卖时间\n      if (obj.saleDate && obj.saleDate.length) {\n        obj.start_time =\n          typeof obj.saleDate[0] === 'string'\n            ? obj.saleDate[0]\n            : obj.saleDate[0].format('YYYY-MM-DD')\n        obj.end_time =\n          typeof obj.saleDate[1] === 'string'\n            ? obj.saleDate[1]\n            : obj.saleDate[1].format('YYYY-MM-DD')\n        delete obj.saleDate\n      }\n\n      // 门店返回时，是对象。新增的时候是数组\n      const form = {\n        ...obj,\n        is_allow_transfer: +this.isTransfer,\n        remarks: this.remarks,\n        intro: this.content,\n        image: this.image,\n        sale_shop_list: this.saleShopList.map(item =>\n          typeof item === 'object' ? item.shop_id : item\n        ),\n        use_shop_list: this.userShopList.map(item =>\n          typeof item === 'object' ? item.shop_id : item\n        )\n      }\n      return form\n    },\n    validate() {\n      if (\n        this.useRange === SHOP_RANGE.SPECIFIED_STORE &&\n        !this.userShopList.length\n      ) {\n        this.validateUseShop = '请选择使用门店'\n      }\n      if (\n        this.saleRange === SHOP_RANGE.SPECIFIED_STORE &&\n        !this.saleShopList.length\n      ) {\n        this.validateUseShop = '请选择售卖门店'\n      }\n      if (!this.fileList.length) {\n        this.imageErrorText = '请上传封面'\n      } else {\n        this.imageErrorText = ''\n      }\n      return this.validateIntro || this.validateUseShop || this.validateSaleShop\n    },\n    onSave() {\n      if (this.validate()) return\n      this.form.validate().then(values => {\n        this.$emit('submit-form', this.getFormdata(values))\n      })\n    },\n    onSaveAndOnShelf() {\n      if (this.validate()) return\n      this.form.validate().then(values => {\n        this.$emit('up', this.getFormdata(values))\n      })\n    },\n    onUserShopChange(event) {\n      this.$emit('rest-use-shop')\n      this.userRange = event.target.value\n    },\n    onSaleShopChange(event) {\n      this.saleRange = event.target.value\n    },\n    getUserShopFormItem(userShopList) {\n      this.userShopList = userShopList\n      this.useShopIds = userShopList\n    },\n    getSaleShopFormItem(saleShopList) {\n      this.saleShopList = saleShopList\n    },\n    onSaleDate() {},\n    transferUnitChange(unit) {\n      this.transfer.transfer_unit = unit\n    },\n    onTransferChange(event) {\n      // console.log(event)\n    },\n    onChangeEditor() {\n      console.log('富文本编辑')\n    },\n    fileChange(data) {\n      if (data.length) {\n        // 上传\n        this.image.image_id = data[0].image_id\n        this.image.image_key = data[0].image_key\n        this.imageIsNone = false\n        this.imageErrorText = ''\n      } else {\n        // 删除\n        this.image.image_id = null\n        this.image.image_key = ''\n        this.imageIsNone = true\n        this.imageErrorText = '请上传封面'\n      }\n    }\n  },\n  created() {\n    this.fileList = this.initInfo.image ? [this.initInfo.image] : []\n    this.content = this.initInfo.intro\n    this.remarks = this.initInfo.remarks\n    this.isTransfer = !!this.initInfo.is_allow_transfer\n    this.transfer.transfer_unit = this.initInfo.transfer_unit\n    this.saleRange = this.initInfo.sale_range\n    this.userRange = this.initInfo.use_range\n    if (this.initInfo.sale_shop_list && this.initInfo.sale_shop_list.length) {\n      this.saleShopIds = this.initInfo.sale_shop_list.map(item => item.shop_id)\n      // 支持售卖门店\n      this.saleShopList = this.initInfo.sale_shop_list\n    }\n    if (this.initInfo.use_shop_list && this.initInfo.use_shop_list.length) {\n      this.userShopList = this.initInfo.use_shop_list\n      this.useShopIds = this.initInfo.use_shop_list.map(item => item.shop_id)\n    }\n  }\n}\n",null]}