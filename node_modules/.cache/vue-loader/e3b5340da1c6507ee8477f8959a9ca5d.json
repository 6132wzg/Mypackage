{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/package/form/form.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/package/form/form.vue","mtime":1600926555706},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { FormService } from './form.service'\nimport { ruleOptions } from './form.config'\nimport TransferSettingFormItem from './form-item#/transfer-setting-form-item.vue'\nimport ReserveCourse from './form-item#/reserve-course.vue'\nimport ReserveIsLimitFormItem from './form-item#/reserve-is-limit-form-item.vue'\nimport ReserveCourseSpeciesFormItem from './form-item#/reserve-course-species-form-item.vue'\nimport FreezeSettingFormItem from './form-item#/freeze-setting-form-item.vue'\nimport SlodPriceSettingFormItem from './form-item#/slod-price-setting-form-item'\nimport BuyTimeFormItem from '@/views/biz-components/sold/sold-time-form-item/sold-time-form-item.vue'\nimport BizAssignShop from '@/views/biz-components/shop/assign-shop/assign-shop.vue'\nimport BizCardBgRadio from '@/views/biz-components/card-bg-radio/card-bg-radio.vue'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport { PatternService } from '@/services/pattern.service'\nimport { cloneDeep, intersection, intersectionWith } from 'lodash'\nexport default {\n  name: 'BizPackageForm',\n  bem: {\n    b: 'biz-package-form'\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      service: FormService\n    }\n  },\n  rxState() {\n    const {\n      packageTypeOptions$,\n      packageAttrOptions$,\n      freezeUnitOptions$,\n      shop$,\n      isShop$,\n      coachList$,\n      cardBgList$,\n      sellTypeOptions$\n    } = this.service\n    return {\n      cardBgList$,\n      packageTypeOptions$,\n      packageAttrOptions$,\n      freezeUnitOptions$,\n      coachList$,\n      shop$,\n      isShop$,\n      sellTypeOptions$\n    }\n  },\n  provide() {\n    return {\n      form: this\n    }\n  },\n  props: {\n    initInfo: {\n      type: Object,\n      default: () => {\n        return {}\n      }\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    return {\n      courses: ['', '团体课', '私教课', '团体课和私教课'],\n      form,\n      isFreeze: false,\n      FORMAT_DATE: 'YYYY-MM-DD',\n      isTransfer: false,\n      courseSetting: {},\n      useRange: 3,\n      isReset: true,\n      resetPrice: true,\n      cardBgValidatorText: '',\n      courseValidatorText: '',\n      useShopIds: [],\n      validTime: {\n        min: 0,\n        max: 999\n      },\n      image: {\n        image_id: 0,\n        image_key: this.cardBgList$[0].image_key,\n        image_url: '',\n        index: 1\n      },\n      personalCourse: [],\n      teamCourse: [],\n      saleRange: 3,\n      saleShopIds: [],\n      autosize: { minRows: 4, maxRow: 20 },\n      unLimited: false,\n      courseName: '我是课程包',\n      packageAttr: 1\n    }\n  },\n  components: {\n    BizCardBgRadio,\n    BuyTimeFormItem,\n    TransferSettingFormItem,\n    ReserveIsLimitFormItem,\n    ReserveCourseSpeciesFormItem,\n    FreezeSettingFormItem,\n    SlodPriceSettingFormItem,\n    BizAssignShop,\n    StEditor,\n    ReserveCourse\n  },\n  methods: {\n    resetCourse() {\n      let useShopList = this.form.getFieldValue('use_shop_list')\n      if (\n        intersection(this.useShopIds, useShopList).length ===\n        this.useShopIds.length\n      )\n        return\n      if (!this.personalCourse.length && !this.teamCourse.length) return\n\n      this.isReset = false\n      let timer = setTimeout(() => {\n        this.teamCourse = []\n        this.personalCourse = []\n        this.isReset = !this.isReset\n      }, 16)\n    },\n    onChangeValidTimeUnit(value) {\n      if (value === 3) {\n        this.validTime = {\n          min: 1,\n          max: 50\n        }\n      }\n    },\n    onChangePersonalCourse(course) {\n      this.courseValidatorText = ''\n      this.personalCourse = course\n    },\n    onChangeTeamCourse(course) {\n      this.courseValidatorText = ''\n      this.teamCourse = course\n    },\n    onChangeUseRange(value, shopIds) {\n      this.resetCourse()\n      this.useRange = value\n      this.useShopIds = shopIds\n    },\n    onChangeSaleRange(value) {\n      this.saleRange = value\n    },\n    onCardBgChange() {\n      this.cardBgValidatorText = ''\n    },\n    // 卡背景校验\n    cardBgValidator() {\n      let validata = this.image.image_key !== ''\n      this.cardBgValidatorText = validata ? '' : '请上传卡背景'\n    },\n    // 课程自定义校验\n    courseValidator() {\n      let validata = true\n      let course = [...this.personalCourse, ...this.teamCourse]\n      course.forEach(item => {\n        validata =\n          (item.course_times && item.course_unit_price) || item.reduce_times\n      })\n      if (this.packageAttr === 2 && this.unLimited) {\n        validata = this.unLimited\n      }\n\n      this.courseValidatorText = validata ? '' : '请填写上课次数或者额度'\n    },\n    getShopIds(type) {\n      return (\n        (this.initInfo[`${type}_shop_list`] &&\n          this.initInfo[`${type}_shop_list`].map(item => item.shop_id)) ||\n        []\n      )\n    },\n    // 获取可约课程种类数据\n    onChangeReserveSpec(courseSetting) {\n      this.courseSetting = courseSetting\n    },\n    // 选择课程包类型，当选择不限次约课只能选择范围课程\n    onChangePackageType(event) {\n      this.unLimited = event.target.value === 0\n      // 当为不限次课程式，只允许是范围内课程 设置级联值和表单值\n      this.packageAttr = this.unLimited ? 2 : 1\n      this.form.setFieldsValue({ course_range: this.unLimited ? 2 : 1 })\n    },\n    /**\n     *  选择任意课程： 可约课程不可选。显示一行文本\n     */\n\n    onChangePackageAttr(event) {\n      this.packageAttr = event.target.value\n    },\n    formDataFormat(saveType) {\n      let {\n        useRange,\n        saleRange,\n        image,\n        courseSetting,\n        personalCourse,\n        teamCourse,\n        FORMAT_DATE\n      } = this\n      let form = {\n        image,\n        use_range: useRange,\n        sale_range: saleRange,\n        course_setting: courseSetting\n      }\n      if (personalCourse.length) {\n        let p = cloneDeep(personalCourse)\n        form.support_course_personal_range = p.map(item => {\n          item.coach_level_ids = item.coach_level_ids.map(ele =>\n            typeof ele === 'object' ? ele.id : ele\n          )\n          return item\n        })\n      }\n      if (teamCourse.length) {\n        form.support_course_team_range = teamCourse\n      }\n      this.form.getFieldValue('use_shop_list')\n      this.form.getFieldValue('sale_shop_list')\n      this.cardBgValidator()\n      this.courseValidator()\n      this.form.validate().then(values => {\n        if (!this.cardBgIsOk || !this.courseIsOk) return\n        let v = cloneDeep(values)\n        let { team_total_price = 0, personal_total_price = 0 } = v\n        v.price = v.price ? v.price : +team_total_price + +personal_total_price\n        v.reserve_is_limit = v.reserve_is_limit[0] || 0\n        v.is_allow_transfer = v.is_allow_transfer[0] || 0\n        v.is_allow_frozen = v.is_allow_frozen[0] || 0\n        if (v.sale_time && v.sale_time.length) {\n          v.start_time = moment(v.sale_time[0])\n            .format(FORMAT_DATE)\n            .valueOf()\n          v.end_time = moment(v.sale_time[1])\n            .format(FORMAT_DATE)\n            .valueOf()\n          delete v.sale_time\n        }\n        form = {\n          ...v,\n          ...form\n        }\n        this.$emit(saveType, form)\n      })\n    },\n    onSave() {\n      this.formDataFormat('save')\n    },\n    onSaveAndOnShelf() {\n      this.formDataFormat('shelf')\n    }\n  },\n  watch: {\n    courseSpec() {\n      this.resetPrice = false\n      let timer = setTimeout(() => {\n        this.resetPrice = true\n        clearTimeout(timer)\n      })\n    }\n  },\n  computed: {\n    ruleOptions() {\n      return ruleOptions\n    },\n    decorators() {\n      return this.form.decorators(this.ruleOptions)\n    },\n    // 约课种类\n    courseSpec() {\n      return this.courseSetting.spec\n    },\n    teamCourseList() {\n      return this.initInfo.support_course_team_range || []\n    },\n    personalCourseList() {\n      let courseList =\n        cloneDeep(this.initInfo.support_course_personal_range) || []\n      return courseList.map(item => {\n        item.coach_level_ids = item.coach_level_ids.map(ele => ele.id)\n        return item\n      })\n    },\n    coachList() {\n      return this.coachList$\n    },\n    // 卡背景是否校验通过\n    cardBgIsOk() {\n      return this.cardBgValidatorText === ''\n    },\n    courseIsOk() {\n      return this.courseValidatorText === ''\n    },\n    packageAttrOptions() {\n      return this.packageAttrOptions$.map(item => {\n        this.$set(item, 'disabled', this.unLimited && item.value !== 2)\n        return item\n      })\n    }\n  },\n  created() {\n    this.service.getCoachList().subscribe()\n  },\n  mounted() {\n    if (!this.isEdit) return\n    let {\n      course_range = 1,\n      use_range = 3,\n      sale_range = 3,\n      is_limit,\n      image\n    } = this.initInfo\n    // 编辑时，判断课程包是否限次\n    this.unLimited = is_limit === 0\n    // 编辑时判断是 范围 不限次 固定\n    this.packageAttr = course_range\n    this.saleRange = sale_range\n    this.useRange = use_range\n    this.useShopIds = this.getShopIds('use')\n    this.saleShopIds = this.getShopIds('sale')\n    this.image = image\n  }\n}\n",{"version":3,"sources":["form.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"form.vue","sourceRoot":"src/views/biz-components/package/form","sourcesContent":["<template>\n  <st-panel app initial :class=\"b()\">\n    <st-form :form=\"form\" class=\"pd-y12\">\n      <!-- 基本信息 start -->\n      <div :class=\"b('base-info')\">\n        <block-title title-name=\"基本信息\" class=\"mg-b32\"></block-title>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <st-form-item label=\"课程名称\" labelWidth=\"148px\" required>\n              <st-input\n                :disabled=\"isEdit\"\n                :maxLength=\"30\"\n                style=\"width: 320px\"\n                v-decorator=\"decorators.course_name\"\n                placeholder=\"请输入课程包名称\"\n                allowClear\n              ></st-input>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <st-form-item label=\"课程包类型\" labelWidth=\"148px\">\n              <a-radio-group\n                @change=\"onChangePackageType\"\n                :disabled=\"isEdit\"\n                v-decorator=\"decorators.is_limit\"\n                :options=\"packageTypeOptions$\"\n              />\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"14\">\n            <st-form-item label=\"课程包属性\" labelWidth=\"148px\">\n              <a-radio-group\n                :disabled=\"isEdit\"\n                v-decorator=\"decorators.course_range\"\n                @change=\"onChangePackageAttr\"\n              >\n                <a-radio\n                  v-for=\"item in packageAttrOptions\"\n                  :key=\"item.value\"\n                  :disabled=\"item.disabled\"\n                  :value=\"item.value\"\n                >\n                  <span>{{ item.label }}</span>\n                  <st-help-tooltip class=\"mg-l4\" :id=\"item.tooltip\" />\n                </a-radio>\n              </a-radio-group>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <st-form-item\n              v-if=\"isShop$\"\n              label=\"支持上课门店\"\n              labelWidth=\"148px\"\n              required\n            >\n              <a-input\n                style=\"width: 320px\"\n                disabled\n                :value=\"shop$.name\"\n              ></a-input>\n            </st-form-item>\n\n            <biz-assign-shop\n              v-else\n              label=\"支持上课门店\"\n              labelWidth=\"148px\"\n              formItemKey=\"use_shop_list\"\n              :form=\"form\"\n              :shopIds=\"useShopIds\"\n              :type=\"useRange\"\n              @change=\"onChangeUseRange\"\n              required\n            ></biz-assign-shop>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\" v-if=\"packageAttr !== 3\">\n          <a-col :lg=\"12\" :xs=\"16\">\n            <!-- 可约课程种类固定课程没有此选项 -->\n            <reserve-course-species-form-item @change=\"onChangeReserveSpec\" />\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"22\">\n            <st-form-item\n              label=\"可约课程\"\n              :validateStatus=\"courseValidatorText ? 'error' : ''\"\n              :help=\"courseValidatorText\"\n              labelWidth=\"148px\"\n              required\n            >\n              <span v-if=\"packageAttr === 1\">\n                <span>支持上课门店的全部{{ courses[courseSpec] }}</span>\n              </span>\n              <div v-else-if=\"packageAttr === 2\">\n                <reserve-course\n                  v-if=\"isReset && [1, 3, 4].includes(courseSpec)\"\n                  key=\"team\"\n                  :initDataSource=\"teamCourseList\"\n                  @change=\"onChangeTeamCourse\"\n                  courseType=\"team\"\n                ></reserve-course>\n                <reserve-course\n                  v-if=\"isReset && [2, 3, 4].includes(courseSpec)\"\n                  courseType=\"personal\"\n                  @change=\"onChangePersonalCourse\"\n                  key=\"personal\"\n                  :initDataSource=\"personalCourseList\"\n                  class=\"mg-t16\"\n                ></reserve-course>\n              </div>\n              <div v-else-if=\"packageAttr === 3\">\n                <reserve-course\n                  v-if=\"isReset\"\n                  key=\"team\"\n                  @change=\"onChangeTeamCourse\"\n                  :initDataSource=\"teamCourseList\"\n                  courseType=\"team\"\n                ></reserve-course>\n                <reserve-course\n                  v-if=\"isReset\"\n                  courseType=\"personal\"\n                  :initDataSource=\"personalCourseList\"\n                  @change=\"onChangePersonalCourse\"\n                  key=\"personal\"\n                  class=\"mg-t16\"\n                ></reserve-course>\n              </div>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <reserve-is-limit-form-item></reserve-is-limit-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <st-form-item labelWidth=\"148px\" required>\n              <template slot=\"label\">\n                支持使用人数\n                <st-help-tooltip id=\"TBMCDC003\" />\n              </template>\n              <st-input-number\n                v-decorator=\"decorators.support_num\"\n                style=\"width: 121px\"\n                :min=\"1\"\n                :max=\"20\"\n              >\n                <template slot=\"addonAfter\">人</template>\n              </st-input-number>\n              <span class=\"mg-l20 tip\">上限20人</span>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"8\" :xs=\"11\">\n            <st-form-item labelWidth=\"148px\" label=\"有效期\" required>\n              <st-input-number\n                v-decorator=\"decorators.valid_time\"\n                :max=\"validTime.max\"\n                :min=\"validTime.min\"\n                style=\"width: 141px\"\n              >\n                <a-select\n                  slot=\"addonAfter\"\n                  v-decorator=\"decorators.valid_time_unit\"\n                  @change=\"onChangeValidTimeUnit\"\n                  :options=\"freezeUnitOptions$\"\n                ></a-select>\n              </st-input-number>\n            </st-form-item>\n          </a-col>\n        </a-row>\n      </div>\n      <!-- 基本信息 end -->\n\n      <!-- 售卖信息 start -->\n      <div :class=\"b('buy-info')\">\n        <block-title title-name=\"售卖信息\" class=\"mg-b32\"></block-title>\n        <slod-price-setting-form-item\n          v-if=\"resetPrice\"\n        ></slod-price-setting-form-item>\n        <!-- 支持售卖时间 start-->\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <buy-time-form-item :decorators=\"decorators\" />\n          </a-col>\n        </a-row>\n        <!-- 支持售卖时间 end-->\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\" :xs=\"11\">\n            <st-form-item\n              v-if=\"isShop$\"\n              label=\"支持售卖门店\"\n              labelWidth=\"148px\"\n              required\n            >\n              <a-input\n                disabled\n                style=\"width: 320px\"\n                :value=\"shop$.name\"\n              ></a-input>\n            </st-form-item>\n            <biz-assign-shop\n              v-else\n              label=\"支持售卖门店\"\n              labelWidth=\"148px\"\n              formItemKey=\"sale_shop_list\"\n              :form=\"form\"\n              :shopIds=\"saleShopIds\"\n              @change=\"onChangeSaleRange\"\n              :type=\"saleRange\"\n              required\n            ></biz-assign-shop>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <st-form-item label=\"售卖方式\" labelWidth=\"148px\" required>\n              <a-checkbox-group v-decorator=\"decorators.sale_mode\">\n                <a-checkbox\n                  v-for=\"item in sellTypeOptions$\"\n                  :key=\"item.value\"\n                  class=\"mg-r40\"\n                  :value=\"item.value\"\n                >\n                  <span>{{ item.label }}</span>\n                </a-checkbox>\n              </a-checkbox-group>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <!-- 转让设置 start -->\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"12\" :xs=\"16\">\n            <transfer-setting-form-item></transfer-setting-form-item>\n          </a-col>\n        </a-row>\n        <!-- 转让设置 end -->\n        <!-- 冻结设置 start -->\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"24\">\n            <freeze-setting-form-item></freeze-setting-form-item>\n          </a-col>\n        </a-row>\n        <!-- 冻结设置 end -->\n      </div>\n      <!-- 售卖信息 end -->\n\n      <!-- 其他信息 start -->\n      <div :class=\"b('other-info')\">\n        <block-title title-name=\"其他信息\" class=\"mg-b32\"></block-title>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"11\" :xs=\"11\">\n            <st-form-item\n              label=\"封面\"\n              labelWidth=\"148px\"\n              validateStatus=\"error\"\n              :help=\"cardBgValidatorText\"\n              required\n            >\n              <biz-card-bg-radio\n                v-model=\"image\"\n                @change=\"onCardBgChange\"\n                isPackage\n              ></biz-card-bg-radio>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"22\" :xs=\"24\">\n            <st-form-item label=\"课程包介绍\" labelWidth=\"148px\">\n              <st-editor v-decorator=\"decorators.intro\"></st-editor>\n            </st-form-item>\n          </a-col>\n        </a-row>\n        <a-row :gutter=\"2\">\n          <a-col :lg=\"22\" :xs=\"24\">\n            <st-form-item label=\"内部备注\" labelWidth=\"148px\">\n              <st-textarea\n                allow-clear\n                placeholder=\"备注内容仅商家可见\"\n                v-decorator=\"decorators.remarks\"\n                :autosize=\"autosize\"\n              ></st-textarea>\n            </st-form-item>\n          </a-col>\n        </a-row>\n      </div>\n      <!-- 其他信息 end -->\n      <a-row :gutter=\"2\">\n        <a-col :lg=\"11\" :xs=\"11\">\n          <st-form-item labelFix labelWidth=\"148px\">\n            <st-button type=\"primary\" @click=\"onSave\">保存</st-button>\n            <st-button v-if=\"!isEdit\" class=\"mg-l16\" @click=\"onSaveAndOnShelf\">\n              保存并上架\n            </st-button>\n          </st-form-item>\n        </a-col>\n      </a-row>\n    </st-form>\n  </st-panel>\n</template>\n\n<script>\nimport { FormService } from './form.service'\nimport { ruleOptions } from './form.config'\nimport TransferSettingFormItem from './form-item#/transfer-setting-form-item.vue'\nimport ReserveCourse from './form-item#/reserve-course.vue'\nimport ReserveIsLimitFormItem from './form-item#/reserve-is-limit-form-item.vue'\nimport ReserveCourseSpeciesFormItem from './form-item#/reserve-course-species-form-item.vue'\nimport FreezeSettingFormItem from './form-item#/freeze-setting-form-item.vue'\nimport SlodPriceSettingFormItem from './form-item#/slod-price-setting-form-item'\nimport BuyTimeFormItem from '@/views/biz-components/sold/sold-time-form-item/sold-time-form-item.vue'\nimport BizAssignShop from '@/views/biz-components/shop/assign-shop/assign-shop.vue'\nimport BizCardBgRadio from '@/views/biz-components/card-bg-radio/card-bg-radio.vue'\nimport StEditor from '@/views/components/editor#/editor.vue'\nimport { PatternService } from '@/services/pattern.service'\nimport { cloneDeep, intersection, intersectionWith } from 'lodash'\nexport default {\n  name: 'BizPackageForm',\n  bem: {\n    b: 'biz-package-form'\n  },\n  serviceInject() {\n    return {\n      pattern: PatternService,\n      service: FormService\n    }\n  },\n  rxState() {\n    const {\n      packageTypeOptions$,\n      packageAttrOptions$,\n      freezeUnitOptions$,\n      shop$,\n      isShop$,\n      coachList$,\n      cardBgList$,\n      sellTypeOptions$\n    } = this.service\n    return {\n      cardBgList$,\n      packageTypeOptions$,\n      packageAttrOptions$,\n      freezeUnitOptions$,\n      coachList$,\n      shop$,\n      isShop$,\n      sellTypeOptions$\n    }\n  },\n  provide() {\n    return {\n      form: this\n    }\n  },\n  props: {\n    initInfo: {\n      type: Object,\n      default: () => {\n        return {}\n      }\n    },\n    isEdit: {\n      type: Boolean,\n      default: false\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    return {\n      courses: ['', '团体课', '私教课', '团体课和私教课'],\n      form,\n      isFreeze: false,\n      FORMAT_DATE: 'YYYY-MM-DD',\n      isTransfer: false,\n      courseSetting: {},\n      useRange: 3,\n      isReset: true,\n      resetPrice: true,\n      cardBgValidatorText: '',\n      courseValidatorText: '',\n      useShopIds: [],\n      validTime: {\n        min: 0,\n        max: 999\n      },\n      image: {\n        image_id: 0,\n        image_key: this.cardBgList$[0].image_key,\n        image_url: '',\n        index: 1\n      },\n      personalCourse: [],\n      teamCourse: [],\n      saleRange: 3,\n      saleShopIds: [],\n      autosize: { minRows: 4, maxRow: 20 },\n      unLimited: false,\n      courseName: '我是课程包',\n      packageAttr: 1\n    }\n  },\n  components: {\n    BizCardBgRadio,\n    BuyTimeFormItem,\n    TransferSettingFormItem,\n    ReserveIsLimitFormItem,\n    ReserveCourseSpeciesFormItem,\n    FreezeSettingFormItem,\n    SlodPriceSettingFormItem,\n    BizAssignShop,\n    StEditor,\n    ReserveCourse\n  },\n  methods: {\n    resetCourse() {\n      let useShopList = this.form.getFieldValue('use_shop_list')\n      if (\n        intersection(this.useShopIds, useShopList).length ===\n        this.useShopIds.length\n      )\n        return\n      if (!this.personalCourse.length && !this.teamCourse.length) return\n\n      this.isReset = false\n      let timer = setTimeout(() => {\n        this.teamCourse = []\n        this.personalCourse = []\n        this.isReset = !this.isReset\n      }, 16)\n    },\n    onChangeValidTimeUnit(value) {\n      if (value === 3) {\n        this.validTime = {\n          min: 1,\n          max: 50\n        }\n      }\n    },\n    onChangePersonalCourse(course) {\n      this.courseValidatorText = ''\n      this.personalCourse = course\n    },\n    onChangeTeamCourse(course) {\n      this.courseValidatorText = ''\n      this.teamCourse = course\n    },\n    onChangeUseRange(value, shopIds) {\n      this.resetCourse()\n      this.useRange = value\n      this.useShopIds = shopIds\n    },\n    onChangeSaleRange(value) {\n      this.saleRange = value\n    },\n    onCardBgChange() {\n      this.cardBgValidatorText = ''\n    },\n    // 卡背景校验\n    cardBgValidator() {\n      let validata = this.image.image_key !== ''\n      this.cardBgValidatorText = validata ? '' : '请上传卡背景'\n    },\n    // 课程自定义校验\n    courseValidator() {\n      let validata = true\n      let course = [...this.personalCourse, ...this.teamCourse]\n      course.forEach(item => {\n        validata =\n          (item.course_times && item.course_unit_price) || item.reduce_times\n      })\n      if (this.packageAttr === 2 && this.unLimited) {\n        validata = this.unLimited\n      }\n\n      this.courseValidatorText = validata ? '' : '请填写上课次数或者额度'\n    },\n    getShopIds(type) {\n      return (\n        (this.initInfo[`${type}_shop_list`] &&\n          this.initInfo[`${type}_shop_list`].map(item => item.shop_id)) ||\n        []\n      )\n    },\n    // 获取可约课程种类数据\n    onChangeReserveSpec(courseSetting) {\n      this.courseSetting = courseSetting\n    },\n    // 选择课程包类型，当选择不限次约课只能选择范围课程\n    onChangePackageType(event) {\n      this.unLimited = event.target.value === 0\n      // 当为不限次课程式，只允许是范围内课程 设置级联值和表单值\n      this.packageAttr = this.unLimited ? 2 : 1\n      this.form.setFieldsValue({ course_range: this.unLimited ? 2 : 1 })\n    },\n    /**\n     *  选择任意课程： 可约课程不可选。显示一行文本\n     */\n\n    onChangePackageAttr(event) {\n      this.packageAttr = event.target.value\n    },\n    formDataFormat(saveType) {\n      let {\n        useRange,\n        saleRange,\n        image,\n        courseSetting,\n        personalCourse,\n        teamCourse,\n        FORMAT_DATE\n      } = this\n      let form = {\n        image,\n        use_range: useRange,\n        sale_range: saleRange,\n        course_setting: courseSetting\n      }\n      if (personalCourse.length) {\n        let p = cloneDeep(personalCourse)\n        form.support_course_personal_range = p.map(item => {\n          item.coach_level_ids = item.coach_level_ids.map(ele =>\n            typeof ele === 'object' ? ele.id : ele\n          )\n          return item\n        })\n      }\n      if (teamCourse.length) {\n        form.support_course_team_range = teamCourse\n      }\n      this.form.getFieldValue('use_shop_list')\n      this.form.getFieldValue('sale_shop_list')\n      this.cardBgValidator()\n      this.courseValidator()\n      this.form.validate().then(values => {\n        if (!this.cardBgIsOk || !this.courseIsOk) return\n        let v = cloneDeep(values)\n        let { team_total_price = 0, personal_total_price = 0 } = v\n        v.price = v.price ? v.price : +team_total_price + +personal_total_price\n        v.reserve_is_limit = v.reserve_is_limit[0] || 0\n        v.is_allow_transfer = v.is_allow_transfer[0] || 0\n        v.is_allow_frozen = v.is_allow_frozen[0] || 0\n        if (v.sale_time && v.sale_time.length) {\n          v.start_time = moment(v.sale_time[0])\n            .format(FORMAT_DATE)\n            .valueOf()\n          v.end_time = moment(v.sale_time[1])\n            .format(FORMAT_DATE)\n            .valueOf()\n          delete v.sale_time\n        }\n        form = {\n          ...v,\n          ...form\n        }\n        this.$emit(saveType, form)\n      })\n    },\n    onSave() {\n      this.formDataFormat('save')\n    },\n    onSaveAndOnShelf() {\n      this.formDataFormat('shelf')\n    }\n  },\n  watch: {\n    courseSpec() {\n      this.resetPrice = false\n      let timer = setTimeout(() => {\n        this.resetPrice = true\n        clearTimeout(timer)\n      })\n    }\n  },\n  computed: {\n    ruleOptions() {\n      return ruleOptions\n    },\n    decorators() {\n      return this.form.decorators(this.ruleOptions)\n    },\n    // 约课种类\n    courseSpec() {\n      return this.courseSetting.spec\n    },\n    teamCourseList() {\n      return this.initInfo.support_course_team_range || []\n    },\n    personalCourseList() {\n      let courseList =\n        cloneDeep(this.initInfo.support_course_personal_range) || []\n      return courseList.map(item => {\n        item.coach_level_ids = item.coach_level_ids.map(ele => ele.id)\n        return item\n      })\n    },\n    coachList() {\n      return this.coachList$\n    },\n    // 卡背景是否校验通过\n    cardBgIsOk() {\n      return this.cardBgValidatorText === ''\n    },\n    courseIsOk() {\n      return this.courseValidatorText === ''\n    },\n    packageAttrOptions() {\n      return this.packageAttrOptions$.map(item => {\n        this.$set(item, 'disabled', this.unLimited && item.value !== 2)\n        return item\n      })\n    }\n  },\n  created() {\n    this.service.getCoachList().subscribe()\n  },\n  mounted() {\n    if (!this.isEdit) return\n    let {\n      course_range = 1,\n      use_range = 3,\n      sale_range = 3,\n      is_limit,\n      image\n    } = this.initInfo\n    // 编辑时，判断课程包是否限次\n    this.unLimited = is_limit === 0\n    // 编辑时判断是 范围 不限次 固定\n    this.packageAttr = course_range\n    this.saleRange = sale_range\n    this.useRange = use_range\n    this.useShopIds = this.getShopIds('use')\n    this.saleShopIds = this.getShopIds('sale')\n    this.image = image\n  }\n}\n</script>\n"]}]}