{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/reserve-info.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/schedule/team/reserve-info.vue","mtime":1597396799939},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { switchMap } from 'rxjs/operators'\nimport { MessageService } from '@/services/message.service'\nimport { TeamScheduleCommonService } from '@/views/pages/shop/product/course/schedule/team/service#/common.service'\nimport { TeamScheduleReserveService } from '@/views/pages/shop/product/course/schedule/team/service#/reserve.service'\nimport ScheduleTeamCancelCourse from '@/views/biz-modals/schedule/team/cancel-course'\nimport ScheduleTeamEditCourse from '@/views/biz-modals/schedule/team/edit-course'\n\nexport default {\n  name: 'ReserveInfo',\n  modals: {\n    ScheduleTeamCancelCourse,\n    ScheduleTeamEditCourse\n  },\n  serviceInject() {\n    return {\n      teamScheduleCommonService: TeamScheduleCommonService,\n      teamScheduleReserveService: TeamScheduleReserveService,\n      messageService: MessageService\n    }\n  },\n  rxState() {\n    const common = this.teamScheduleCommonService\n    return {\n      infoAuth: this.teamScheduleReserveService.infoAuth$,\n      memberOptions: common.memberOptions$,\n      consumeOptions: common.consumeOptions$,\n      unUsedSeatOptions: common.unUsedSeatOptions$\n    }\n  },\n  props: {\n    id: Number\n  },\n  filters: {\n    siteNumListFilter(val) {\n      return val\n        .split(',')\n        .map(item => {\n          if (item === '0') {\n            return '无座位'\n          }\n          return item\n        })\n        .join(',')\n    }\n  },\n  data() {\n    return {\n      isAdd: true,\n      showConsumeType: '',\n      memberId: '',\n      showSite: [],\n      consumeType: '',\n      keyword: '',\n      effectiveState: 1,\n      consumeName: '',\n      consumeId: '',\n      consumeTypeId: '',\n      siteNumIds: [],\n      currentReservationNum: 0,\n      columns: [\n        {\n          title: '会员姓名',\n          dataIndex: 'member',\n          width: 10,\n          scopedSlots: { customRender: 'member' }\n        },\n        {\n          title: '消费方式',\n          dataIndex: 'consume_type',\n          scopedSlots: { customRender: 'consume_type' }\n        },\n        {\n          title: '座位号',\n          dataIndex: 'site_num_list',\n          scopedSlots: { customRender: 'site_num_list' }\n        },\n        {\n          title: '预约人数',\n          dataIndex: 'current_reservation_num',\n          scopedSlots: { customRender: 'current_reservation_num' }\n        },\n        {\n          title: '预约状态',\n          dataIndex: 'reserve_status',\n          scopedSlots: { customRender: 'reserve_status' }\n        },\n        {\n          title: '签到状态',\n          dataIndex: 'is_checkin'\n        },\n        {\n          title: '操作',\n          dataIndex: 'action',\n          scopedSlots: { customRender: 'action' }\n        }\n      ],\n      dataSource: [],\n      show: false,\n      info: {},\n      list: []\n    }\n  },\n  computed: {\n    courseId() {\n      return this.info.course_id\n    },\n    scheduleId() {\n      return this.info.id\n    },\n    courtSiteId() {\n      return this.info.court_site_id\n    },\n    brandLimitNum() {\n      return this.info.brand_limit_num\n    }\n  },\n  methods: {\n    keywordFilter(item) {\n      let str\n      if (item.is_minors === 1) {\n        str = `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`.replace(\n          new RegExp(this.keyword),\n          `<span class=\"color-primary\">${this.keyword}</span>`\n        )\n      } else {\n        str = `${item.member_name} ${item.mobile}`.replace(\n          new RegExp(this.keyword),\n          `<span class=\"color-primary\">${this.keyword}</span>`\n        )\n      }\n      return str\n    },\n    onClickCancelCourse() {\n      this.$modalRouter.push({\n        name: 'schedule-team-cancel-course',\n        props: { id: this.info.id }\n      })\n      this.show = false\n    },\n    onClickEditCourse() {\n      this.$modalRouter.push({\n        name: 'schedule-team-edit-course',\n        props: { id: this.info.id },\n        on: {\n          ok: () => {\n            this.$router.reload()\n          }\n        }\n      })\n      this.show = false\n    },\n    onSearch(value) {\n      this.keyword = value\n      this.teamScheduleCommonService\n        .getMemberList({ member: value })\n        .subscribe()\n    },\n    onClickCancel(id) {\n      this.teamScheduleReserveService.del(id).subscribe(() => {\n        this.getReserve()\n      })\n    },\n    onClickCheckIn(id) {\n      this.teamScheduleReserveService\n        .check({ id, checkin_method: 2 })\n        .subscribe(() => {\n          this.getReserve()\n        })\n    },\n    getMemberName(id) {\n      let memberName = ''\n      this.memberOptions.forEach(item => {\n        if (item.id === id) {\n          memberName = item.member_name\n        }\n      })\n      return memberName\n    },\n    onChange(value) {\n      this.memberId = value\n      this.showConsumeType = ''\n      this.memberName = this.getMemberName(value)\n      this.teamScheduleCommonService\n        .getConsumeList({\n          schedule_id: this.scheduleId,\n          course_id: this.courseId,\n          member_id: value\n        })\n        .subscribe()\n    },\n    onChangeConsumeType(val) {\n      const obj = JSON.parse(val)\n      this.consumeType = obj.consume_type\n      //  因为会员卡，私教课，储值卡，课程包只有课程包有这个字段 没这个字段也是生效 undefined也为1\n      this.effectiveState = obj.effective_state === 0 ? 0 : 1\n      this.consumeName = obj.name\n      this.consumeId = obj.id\n    },\n    onChangeSiteNumList(val) {\n      let tempArr = []\n      if (val.length > this.brandLimitNum) {\n        this.messageService.error({\n          content: `最多预约${this.brandLimitNum}个座位`\n        })\n        let len = this.showSite.length\n        this.showSite = this.showSite.slice(0, len - 1)\n        return\n      }\n      const unSeatArr = this.unUsedSeatOptions\n        .map(item => (item.name === '无座位' ? item.id : -1))\n        .filter(item => item !== -1)\n      this.siteNumIds = val.map(item => {\n        let value\n        this.unUsedSeatOptions.forEach(ele => {\n          if (item === ele.id && ele.name !== '无座位') {\n            value = ele.name\n          }\n        })\n        return unSeatArr.includes(item) ? -1 : value\n      })\n      this.currentReservationNum = this.showSite.length\n    },\n    add() {\n      const form = {\n        schedule_id: this.id,\n        member_id: this.memberId,\n        seat: this.siteNumIds,\n        consume_type: this.consumeType,\n        consume_id: this.consumeId\n      }\n      this.currentReservationNum = 0\n      this.isAdd = false\n      this.teamScheduleReserveService.add(form).subscribe(\n        () => {\n          this.isAdd = true\n          this.showSite = []\n          this.siteNumIds = []\n          this.consumeType = ''\n          this.showConsumeType = ''\n          this.memberId = ''\n          this.getReserve()\n        },\n        err => {\n          console.log(err)\n          this.isAdd = true\n          this.showSite = []\n          this.siteNumIds = []\n          this.consumeType = ''\n          this.showConsumeType = ''\n          this.memberId = ''\n        }\n      )\n    },\n    onClickReserve() {\n      if (this.effectiveState) {\n        this.add()\n        return\n      }\n      this.$confirm({\n        title: '',\n        content: `新增预约后, ${this.memberName}的课程包${\n          this.consumeName.split('(')[0]\n        }会立即生效，确认新增?`,\n        onOk: () => {\n          this.add()\n          this.effectiveState = 1\n        },\n        onCancel() {\n          console.log('Cancel')\n        },\n        class: 'test'\n      })\n    },\n    edit(key) {\n      const newData = [...this.data]\n      const target = newData.filter(item => key === item.key)[0]\n      if (target) {\n        target.editable = true\n        this.data = newData\n      }\n      target.editable = true\n      this.data = newData\n    },\n    save(key) {\n      const newData = [...this.data]\n      const target = newData.filter(item => key === item.key)[0]\n      if (target) {\n        delete target.editable\n        this.data = newData\n        this.cacheData = newData.map(item => ({ ...item }))\n      }\n    },\n    getReserve() {\n      const ss = this.teamScheduleReserveService\n      ss.getInfo(this.id)\n        .pipe(\n          switchMap(state => {\n            this.info = state.info\n            this.list = state.list\n            return this.teamScheduleCommonService.getUnusedSeatList({\n              schedule_id: state.info.id,\n              court_site_id: state.info.court_site_id\n            })\n          })\n        )\n        .subscribe()\n    }\n  },\n  mounted() {\n    this.getReserve()\n  }\n}\n",null]}