{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js!/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/member/add-card-member/add-card-member.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-components/member/add-card-member/add-card-member.vue","mtime":1600926555687},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.number.constructor\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { cloneDeep } from 'lodash-es';\nimport { AddCardMemberService } from \"./add-card-member.service\";\nimport { MessageService } from '@/services/message.service';\nimport { PatternService } from '@/services/pattern.service';\nexport default {\n  name: 'AddCardMember',\n  bem: {\n    b: 'page-add-card-member'\n  },\n  serviceProviders: function serviceProviders() {\n    return [AddCardMemberService];\n  },\n  serviceInject: function serviceInject() {\n    return {\n      addCardMemberService: AddCardMemberService,\n      messageService: MessageService,\n      patternService: PatternService\n    };\n  },\n  rxState: function rxState() {\n    var _this$addCardMemberSe = this.addCardMemberService,\n        parentTypeOptions$ = _this$addCardMemberSe.parentTypeOptions$,\n        minorsTypeOptions$ = _this$addCardMemberSe.minorsTypeOptions$;\n    return {\n      memberList: this.addCardMemberService.memberList$,\n      parentTypeOptions$: parentTypeOptions$,\n      minorsTypeOptions$: minorsTypeOptions$\n    };\n  },\n  model: {\n    prop: 'list',\n    event: 'change'\n  },\n  props: {\n    addText: {\n      type: String,\n      default: '新增卡成员'\n    },\n    type: {\n      type: Number,\n      default: 1\n    },\n    productType: {\n      type: String\n    },\n    max: {\n      type: Number,\n      default: 10\n    },\n    list: {\n      type: Array,\n      default: function _default() {\n        return [];\n      }\n    }\n  },\n  data: function data() {\n    return {\n      visible: false,\n      memberSearchText: '',\n      searchMemberIsShow: true,\n      memberId: '',\n      searchFlag: false,\n      searchWidth: ''\n    };\n  },\n  mounted: function mounted() {\n    this.$nextTick(function () {\n      this.searchWidth = this.$refs.addMemberCardButton.$el.offsetWidth - 32 + 'px';\n    });\n  },\n  methods: {\n    parentUserRoleStr: function parentUserRoleStr(value) {\n      var label = value;\n\n      if (typeof value === 'number') {\n        this.parentTypeOptions$.forEach(function (element) {\n          if (element.value === value) {\n            label = element.label;\n          }\n        });\n      }\n\n      return label;\n    },\n    selectItemLabel: function selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return \"\".concat(item.member_name, \"(\\u672A\\u6210\\u5E74) \").concat(item.parent_mobile, \"(\").concat(item.parent_user_role, \")\");\n      }\n\n      return \"\".concat(item.member_name, \" \").concat(item.mobile);\n    },\n    onConfirmItem: function onConfirmItem(data, index) {\n      if (!data.name) {\n        this.messageService.error({\n          content: '请填写正确成员姓名'\n        });\n        return;\n      }\n\n      if (!data.mobile || !this.patternService.MOBILE.test(data.mobile)) {\n        this.messageService.error({\n          content: '请填写正确手机号'\n        });\n        return;\n      }\n\n      var isExist = this.list.filter(function (item) {\n        return item.mobile === data.mobile && !item.isEdit;\n      });\n\n      if (data.is_minors) {\n        data.parent_mobile = data.mobile;\n      } // 未成年人不校验手机重复 20200720\n\n\n      if (!data.is_minors && isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        });\n        return;\n      }\n\n      data.isEdit = false;\n      this.$emit('change', this.list);\n    },\n    onCancelItem: function onCancelItem(item, index) {\n      this.list.shift();\n      this.$emit('change', this.list);\n    },\n    onDeleteItem: function onDeleteItem(item, index) {\n      this.list.splice(index, 1);\n      this.$emit('change', this.list);\n    },\n    onChangeMinors: function onChangeMinors($event, item) {\n      console.log($event, item); // 未成年需要关系字段\n\n      if ($event === 1) {\n        item.parent_mobile = item.mobile;\n        this.$set(item, 'parent_user_role', 1);\n      }\n    },\n    onAddMember: function onAddMember() {\n      this.memberSearchText = '';\n      var isExistEdit = this.list.filter(function (item) {\n        return item.isEdit;\n      });\n\n      if (isExistEdit && isExistEdit.length > 0) {\n        this.messageService.error({\n          content: '还有没有新增完成的成员'\n        });\n        return;\n      }\n\n      this.visible = false;\n      this.list.unshift({\n        name: '',\n        mobile: '',\n        is_minors: 0,\n        isEdit: true\n      });\n    },\n    onMemberSearch: function onMemberSearch(data) {\n      this.memberSearchText = data.target.value;\n\n      if (data) {\n        this.addCardMemberService.memberListAction$.dispatch(data.target.value, this.type);\n      }\n    },\n    onMemberChange: function onMemberChange(data) {\n      if (this.list.length >= this.max) return;\n      var isExist = this.list.filter(function (item) {\n        return item.mobile === data.mobile && !item.isEdit;\n      });\n\n      if (isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        });\n        return;\n      }\n\n      var isExistEdit = this.list.filter(function (item) {\n        return item.isEdit;\n      });\n      var insertIndex = 0;\n\n      if (isExistEdit && isExistEdit.length > 0) {\n        insertIndex = 1;\n      }\n\n      this.list.splice(insertIndex, 0, {\n        id: data.id,\n        name: data.member_name,\n        mobile: data.mobile,\n        is_minors: data.is_minors,\n        parent_mobile: data.parent_mobile,\n        parent_name: data.parent_name,\n        parent_user_role: data.parent_user_role\n      });\n      this.visible = false;\n      this.resetSearchCondition();\n      this.$emit('change', this.list);\n    },\n    resetSearchCondition: function resetSearchCondition() {\n      this.memberSearchText = '';\n      this.memberList = [];\n    }\n  }\n};",{"version":3,"sources":["add-card-member.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <st-container>\n    <st-form-table :class=\"b()\">\n      <colgroup>\n        <col style=\"width:40%;\" />\n        <col style=\"width:40%;\" />\n        <col style=\"width:20%;\" />\n      </colgroup>\n      <thead>\n        <tr>\n          <th>成员姓名</th>\n          <th>手机号</th>\n          <th>操作</th>\n        </tr>\n      </thead>\n      <tbody>\n        <tr>\n          <td colspan=\"3\" :class=\"b('search-wrapper')\">\n            <a-popover\n              trigger=\"click\"\n              v-model=\"visible\"\n              placement=\"bottom\"\n              :arrowPointAtCenter=\"true\"\n              overlayClassName=\"change-member-popover\"\n            >\n              <div\n                slot=\"content\"\n                :class=\"b('search-section')\"\n                id=\"search-section\"\n                ref=\"searchSection\"\n              >\n                <a-input-search\n                  placeholder=\"请输入手机号码或者会员姓名\"\n                  v-model=\"memberSearchText\"\n                  @change=\"onMemberSearch\"\n                  :style=\"{\n                    width: searchWidth\n                  }\"\n                  class=\"test-input\"\n                />\n                <ul :class=\"b('search-list')\">\n                  <li\n                    :class=\"b('search-text')\"\n                    v-for=\"(item, index) in memberList\"\n                    :value=\"item.id\"\n                    :key=\"index\"\n                    @click.stop=\"onMemberChange(item)\"\n                  >\n                    <span\n                      v-html=\"\n                        `${selectItemLabel(item)}`.replace(\n                          new RegExp(memberSearchText, 'g'),\n                          `\\<span class='global-highlight-color'\\>${memberSearchText}\\<\\/span\\>`\n                        )\n                      \"\n                    >\n                      {{ selectItemLabel(item) }}\n                    </span>\n                  </li>\n                  <li\n                    v-if=\"type !== 2\"\n                    :class=\"[b('search-text'), b('search-tip')]\"\n                  >\n                    查无此会员，\n                    <a @click=\"onAddMember\">新增新会员？</a>\n                  </li>\n                </ul>\n              </div>\n              <st-button\n                :disabled=\"list.length >= max\"\n                type=\"dashed\"\n                icon=\"add\"\n                block\n                ref=\"addMemberCardButton\"\n              >\n                {{ addText }}\n              </st-button>\n            </a-popover>\n          </td>\n        </tr>\n        <tr v-for=\"(item, index) in list\" :key=\"index\">\n          <td>\n            <template v-if=\"item.isEdit\">\n              <a-input placeholder=\"输入姓名\" v-model=\"item.name\">\n                <a-select\n                  slot=\"addonAfter\"\n                  default-value=\"1\"\n                  style=\"width: 100px\"\n                  v-if=\"productType === 'package'\"\n                  @change=\"onChangeMinors($event, item)\"\n                  v-model=\"item.is_minors\"\n                  :options=\"minorsTypeOptions$\"\n                ></a-select>\n              </a-input>\n            </template>\n            <template v-else>\n              {{ item.name }}\n              <st-icon\n                v-if=\"item.is_minors\"\n                type=\"user-type\"\n                color=\"#3F66F6\"\n              ></st-icon>\n            </template>\n          </td>\n          <td>\n            <template v-if=\"item.isEdit\">\n              <a-input placeholder=\"输入手机号\" v-model=\"item.mobile\">\n                <a-select\n                  slot=\"addonAfter\"\n                  :default-value=\"1\"\n                  v-model=\"item.parent_user_role\"\n                  style=\"width: 80px\"\n                  v-if=\"productType === 'package' && item.is_minors\"\n                  :options=\"parentTypeOptions$\"\n                ></a-select>\n              </a-input>\n            </template>\n            <template v-else-if=\"item.is_minors\">\n              {{ item.parent_mobile }}({{\n                parentUserRoleStr(item.parent_user_role)\n              }})\n            </template>\n            <template v-else>\n              {{ item.mobile }}\n            </template>\n          </td>\n          <td>\n            <a\n              v-if=\"item.isEdit\"\n              class=\"mg-r8\"\n              @click=\"onConfirmItem(item, index)\"\n            >\n              确认\n            </a>\n            <a v-if=\"item.isEdit\" @click=\"onCancelItem(item, index)\">取消</a>\n            <a v-if=\"!item.isEdit\" @click=\"onDeleteItem(item, index)\">删除</a>\n          </td>\n        </tr>\n        <tr v-if=\"list.length <= 0\">\n          <td colspan=\"3\">\n            <st-no-data />\n          </td>\n        </tr>\n      </tbody>\n    </st-form-table>\n  </st-container>\n</template>\n<script>\nimport { cloneDeep } from 'lodash-es'\nimport { AddCardMemberService } from './add-card-member.service'\nimport { MessageService } from '@/services/message.service'\nimport { PatternService } from '@/services/pattern.service'\nexport default {\n  name: 'AddCardMember',\n  bem: {\n    b: 'page-add-card-member'\n  },\n  serviceProviders() {\n    return [AddCardMemberService]\n  },\n  serviceInject() {\n    return {\n      addCardMemberService: AddCardMemberService,\n      messageService: MessageService,\n      patternService: PatternService\n    }\n  },\n  rxState() {\n    let { parentTypeOptions$, minorsTypeOptions$ } = this.addCardMemberService\n    return {\n      memberList: this.addCardMemberService.memberList$,\n      parentTypeOptions$,\n      minorsTypeOptions$\n    }\n  },\n  model: {\n    prop: 'list',\n    event: 'change'\n  },\n  props: {\n    addText: {\n      type: String,\n      default: '新增卡成员'\n    },\n    type: {\n      type: Number,\n      default: 1\n    },\n    productType: {\n      type: String\n    },\n    max: {\n      type: Number,\n      default: 10\n    },\n    list: {\n      type: Array,\n      default: () => []\n    }\n  },\n  data() {\n    return {\n      visible: false,\n      memberSearchText: '',\n      searchMemberIsShow: true,\n      memberId: '',\n      searchFlag: false,\n      searchWidth: ''\n    }\n  },\n  mounted() {\n    this.$nextTick(function() {\n      this.searchWidth =\n        this.$refs.addMemberCardButton.$el.offsetWidth - 32 + 'px'\n    })\n  },\n  methods: {\n    parentUserRoleStr(value) {\n      let label = value\n      if (typeof value === 'number') {\n        this.parentTypeOptions$.forEach(element => {\n          if (element.value === value) {\n            label = element.label\n          }\n        })\n      }\n      return label\n    },\n    selectItemLabel(item) {\n      if (item.is_minors === 1) {\n        return `${item.member_name}(未成年) ${item.parent_mobile}(${item.parent_user_role})`\n      }\n      return `${item.member_name} ${item.mobile}`\n    },\n    onConfirmItem(data, index) {\n      if (!data.name) {\n        this.messageService.error({\n          content: '请填写正确成员姓名'\n        })\n        return\n      }\n      if (!data.mobile || !this.patternService.MOBILE.test(data.mobile)) {\n        this.messageService.error({\n          content: '请填写正确手机号'\n        })\n        return\n      }\n\n      const isExist = this.list.filter(\n        item => item.mobile === data.mobile && !item.isEdit\n      )\n      if (data.is_minors) {\n        data.parent_mobile = data.mobile\n      }\n      // 未成年人不校验手机重复 20200720\n      if (!data.is_minors && isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        })\n        return\n      }\n      data.isEdit = false\n      this.$emit('change', this.list)\n    },\n    onCancelItem(item, index) {\n      this.list.shift()\n      this.$emit('change', this.list)\n    },\n    onDeleteItem(item, index) {\n      this.list.splice(index, 1)\n      this.$emit('change', this.list)\n    },\n    onChangeMinors($event, item) {\n      console.log($event, item)\n      // 未成年需要关系字段\n      if ($event === 1) {\n        item.parent_mobile = item.mobile\n        this.$set(item, 'parent_user_role', 1)\n      }\n    },\n    onAddMember() {\n      this.memberSearchText = ''\n      const isExistEdit = this.list.filter(item => item.isEdit)\n      if (isExistEdit && isExistEdit.length > 0) {\n        this.messageService.error({\n          content: '还有没有新增完成的成员'\n        })\n        return\n      }\n      this.visible = false\n      this.list.unshift({\n        name: '',\n        mobile: '',\n        is_minors: 0,\n        isEdit: true\n      })\n    },\n    onMemberSearch(data) {\n      this.memberSearchText = data.target.value\n      if (data) {\n        this.addCardMemberService.memberListAction$.dispatch(\n          data.target.value,\n          this.type\n        )\n      }\n    },\n    onMemberChange(data) {\n      if (this.list.length >= this.max) return\n      const isExist = this.list.filter(\n        item => item.mobile === data.mobile && !item.isEdit\n      )\n      if (isExist && isExist.length > 0) {\n        this.messageService.error({\n          content: '该手机号已经存在'\n        })\n        return\n      }\n      const isExistEdit = this.list.filter(item => item.isEdit)\n      let insertIndex = 0\n      if (isExistEdit && isExistEdit.length > 0) {\n        insertIndex = 1\n      }\n      this.list.splice(insertIndex, 0, {\n        id: data.id,\n        name: data.member_name,\n        mobile: data.mobile,\n        is_minors: data.is_minors,\n        parent_mobile: data.parent_mobile,\n        parent_name: data.parent_name,\n        parent_user_role: data.parent_user_role\n      })\n      this.visible = false\n      this.resetSearchCondition()\n      this.$emit('change', this.list)\n    },\n    resetSearchCondition() {\n      this.memberSearchText = ''\n      this.memberList = []\n    }\n  }\n}\n</script>\n"],"sourceRoot":"src/views/biz-components/member/add-card-member"}]}