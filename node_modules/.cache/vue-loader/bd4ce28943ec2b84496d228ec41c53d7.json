{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/brand/app/plugin/send-coupon/batch-send.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/brand/app/plugin/send-coupon/batch-send.vue","mtime":1600926555821},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { ruleOptions } from './batch-send.config'\nimport { BatchSendService } from './batch-send.service'\nimport { USER_TYPES } from '@/constants/plugin/send-coupon'\nimport { MessageService } from '@/services/message.service'\nimport { PatternService } from '@/services/pattern.service'\nimport AllMemberSelect from '@/views/biz-components/member/all-member-select/all-member-select.vue'\nimport CouponSelect from '@/views/biz-components/plugin/coupon-select/index.vue'\nexport default {\n  name: 'BrandAppPluginSendCouponBatchSend',\n  bem: {\n    bModal: 'brand-app-plugin-send-coupon-batch-send'\n  },\n  serviceInject() {\n    return {\n      batchSendService: BatchSendService,\n      messageService: MessageService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.batchSendService.loading$,\n      userType: this.batchSendService.userType$,\n      crowdList: this.batchSendService.crowdList$\n    }\n  },\n  components: {\n    AllMemberSelect,\n    CouponSelect\n  },\n  props: {\n    couponId: {\n      type: Number\n    },\n    crowdId: {\n      type: Number\n    },\n    title: {\n      type: String,\n      default: '定向发券'\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      USER_TYPES,\n      show: false,\n      curUser: USER_TYPES.USER,\n      tel: '',\n      selectCouponId: '',\n      selectMemberId: ''\n    }\n  },\n  mounted() {\n    if (this.couponId) {\n      this.selectCouponId = this.couponId\n    }\n    if (this.crowdId) {\n      this.curUser = USER_TYPES.CROWD\n      this.form.setFieldsValue({\n        type: USER_TYPES.CROWD,\n        send_value: this.crowdId\n      })\n    }\n    this.getCrowdList()\n  },\n  methods: {\n    // 获取人群列表\n    getCrowdList() {\n      return this.batchSendService.getCrowdList().subscribe()\n    },\n    getCurPrizUserType(e) {\n      this.curUser = e.target.value\n    },\n    // 跳转到新增人群\n    goCrowd() {\n      this.$router.push('/brand/marketing/plugin/crowd/index')\n      this.show = false\n    },\n    onMemberSelect(id) {\n      this.selectMemberId = id\n    },\n    onCouponSelectChange(val) {\n      this.selectCouponId = val\n    },\n    save() {\n      this.form.validate((error, values) => {\n        let errMsg = ''\n        const types = {\n          [USER_TYPES.USER]: () => {\n            if (!this.selectMemberId) {\n              errMsg = '请选择会员'\n              return\n            }\n            values.send_users = [this.selectMemberId]\n          },\n          [USER_TYPES.MOBILE]: () => {\n            if (!this.tel) {\n              errMsg = '请输入手机号'\n              return\n            }\n            let telArr = this.tel.split(/[\\n]/)\n            for (let i = 0; i < telArr.length; i++) {\n              if (!this.pattern.MOBILE.test(telArr[i].trim())) {\n                errMsg = '请输入正确格式手机号'\n                return\n              }\n            }\n            values.send_users = this.tel.split(/[\\n]/)\n          },\n          [USER_TYPES.CROWD]: () => {\n            if (!values.send_value) {\n              errMsg = '请选择人群'\n              return\n            }\n            values.send_users = [values.send_value]\n          },\n          [USER_TYPES.ALL]: () => {}\n        }\n        // 校验输入\n        types[values.type]()\n        if (errMsg) {\n          this.messageService.warn({ content: errMsg })\n          return\n        }\n\n        if (!this.selectCouponId) {\n          this.messageService.warn({\n            content: '请选择优惠券'\n          })\n          return\n        }\n        values.coupon_id = this.selectCouponId\n        return this.batchSendService\n          .sendCoupon({ ...values })\n          .subscribe(res => {\n            this.$confirm({\n              title: '发券成功',\n              content: '您可以推送短信，告知客户有新的优惠券到账哦~',\n              okText: '短信推送',\n              icon: () => (\n                <st-icon\n                  type=\"anticon:check-circle\"\n                  size=\"22px\"\n                  color=\"#52c41a\"\n                ></st-icon>\n              ),\n              onOk: () => {\n                this.$router.push({\n                  name: 'brand-setting-sms-group'\n                })\n              }\n            })\n            this.$emit('success')\n            this.show = false\n          })\n      })\n    }\n  }\n}\n",{"version":3,"sources":["batch-send.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"batch-send.vue","sourceRoot":"src/views/biz-modals/brand/app/plugin/send-coupon","sourcesContent":["<template>\n  <st-modal\n    :class=\"bModal()\"\n    :title=\"title\"\n    v-model=\"show\"\n    @ok=\"save\"\n    :confirmLoading=\"loading.sendCoupon\"\n  >\n    <st-form :form=\"form\">\n      <st-form-item\n        label=\"接受对象\"\n        :class=\"bModal('form')\"\n        :help=\"curUser === USER_TYPES.MOBILE ? '必须为系统内会员的手机号' : ''\"\n      >\n        <a-radio-group\n          v-decorator=\"decorators.type\"\n          @change=\"getCurPrizUserType\"\n        >\n          <a-radio\n            v-for=\"(item, index) in userType\"\n            :key=\"index\"\n            :value=\"item.value\"\n          >\n            {{ item.label }}\n          </a-radio>\n        </a-radio-group>\n\n        <all-member-select\n          style=\"width: 290px; margin-top: 12px\"\n          v-if=\"curUser === USER_TYPES.USER\"\n          type=\"brand\"\n          placeholder=\"输入手机号或会员名搜索\"\n          isNormalStyle\n          useBodyContainer\n          @change=\"onMemberSelect\"\n        ></all-member-select>\n\n        <st-textarea\n          class=\"mg-t8\"\n          v-if=\"curUser === USER_TYPES.MOBILE\"\n          v-model=\"tel\"\n          :max-rows=\"1000\"\n          :autosize=\"{ minRows: 2, maxRows: 4 }\"\n          placeholder=\"输入手机号,每行一个\"\n        ></st-textarea>\n\n        <a-radio-group\n          :class=\"bModal('scroll')\"\n          v-decorator=\"decorators.send_value\"\n          v-show=\"curUser === USER_TYPES.CROWD\"\n        >\n          <a-radio-button\n            :class=\"bModal('scroll-btn')\"\n            class=\"mg-r8\"\n            v-for=\"(item, index) in crowdList\"\n            :key=\"index\"\n            :value=\"item.crowd_id\"\n          >\n            {{ item.crowd_name }}\n          </a-radio-button>\n        </a-radio-group>\n        <span :class=\"bModal('scroll-add')\" v-if=\"curUser === USER_TYPES.CROWD\">\n          <span :class=\"bModal('scroll-not')\">不满足？</span>\n          <a @click=\"goCrowd\" class=\"cursor-pointer\">去新增人群</a>\n        </span>\n      </st-form-item>\n      <st-form-item\n        label=\"选择优惠券\"\n        help=\"定向发券不扣除优惠券剩余数量\"\n        required\n      >\n        <coupon-select\n          isInit\n          :isSelectFirst=\"!!couponId\"\n          :value=\"couponId\"\n          style=\"width: 290px\"\n          useBodyContainer\n          placeholder=\"搜索选择优惠券\"\n          @change=\"onCouponSelectChange\"\n        ></coupon-select>\n      </st-form-item>\n    </st-form>\n  </st-modal>\n</template>\n<script>\nimport { ruleOptions } from './batch-send.config'\nimport { BatchSendService } from './batch-send.service'\nimport { USER_TYPES } from '@/constants/plugin/send-coupon'\nimport { MessageService } from '@/services/message.service'\nimport { PatternService } from '@/services/pattern.service'\nimport AllMemberSelect from '@/views/biz-components/member/all-member-select/all-member-select.vue'\nimport CouponSelect from '@/views/biz-components/plugin/coupon-select/index.vue'\nexport default {\n  name: 'BrandAppPluginSendCouponBatchSend',\n  bem: {\n    bModal: 'brand-app-plugin-send-coupon-batch-send'\n  },\n  serviceInject() {\n    return {\n      batchSendService: BatchSendService,\n      messageService: MessageService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.batchSendService.loading$,\n      userType: this.batchSendService.userType$,\n      crowdList: this.batchSendService.crowdList$\n    }\n  },\n  components: {\n    AllMemberSelect,\n    CouponSelect\n  },\n  props: {\n    couponId: {\n      type: Number\n    },\n    crowdId: {\n      type: Number\n    },\n    title: {\n      type: String,\n      default: '定向发券'\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      USER_TYPES,\n      show: false,\n      curUser: USER_TYPES.USER,\n      tel: '',\n      selectCouponId: '',\n      selectMemberId: ''\n    }\n  },\n  mounted() {\n    if (this.couponId) {\n      this.selectCouponId = this.couponId\n    }\n    if (this.crowdId) {\n      this.curUser = USER_TYPES.CROWD\n      this.form.setFieldsValue({\n        type: USER_TYPES.CROWD,\n        send_value: this.crowdId\n      })\n    }\n    this.getCrowdList()\n  },\n  methods: {\n    // 获取人群列表\n    getCrowdList() {\n      return this.batchSendService.getCrowdList().subscribe()\n    },\n    getCurPrizUserType(e) {\n      this.curUser = e.target.value\n    },\n    // 跳转到新增人群\n    goCrowd() {\n      this.$router.push('/brand/marketing/plugin/crowd/index')\n      this.show = false\n    },\n    onMemberSelect(id) {\n      this.selectMemberId = id\n    },\n    onCouponSelectChange(val) {\n      this.selectCouponId = val\n    },\n    save() {\n      this.form.validate((error, values) => {\n        let errMsg = ''\n        const types = {\n          [USER_TYPES.USER]: () => {\n            if (!this.selectMemberId) {\n              errMsg = '请选择会员'\n              return\n            }\n            values.send_users = [this.selectMemberId]\n          },\n          [USER_TYPES.MOBILE]: () => {\n            if (!this.tel) {\n              errMsg = '请输入手机号'\n              return\n            }\n            let telArr = this.tel.split(/[\\n]/)\n            for (let i = 0; i < telArr.length; i++) {\n              if (!this.pattern.MOBILE.test(telArr[i].trim())) {\n                errMsg = '请输入正确格式手机号'\n                return\n              }\n            }\n            values.send_users = this.tel.split(/[\\n]/)\n          },\n          [USER_TYPES.CROWD]: () => {\n            if (!values.send_value) {\n              errMsg = '请选择人群'\n              return\n            }\n            values.send_users = [values.send_value]\n          },\n          [USER_TYPES.ALL]: () => {}\n        }\n        // 校验输入\n        types[values.type]()\n        if (errMsg) {\n          this.messageService.warn({ content: errMsg })\n          return\n        }\n\n        if (!this.selectCouponId) {\n          this.messageService.warn({\n            content: '请选择优惠券'\n          })\n          return\n        }\n        values.coupon_id = this.selectCouponId\n        return this.batchSendService\n          .sendCoupon({ ...values })\n          .subscribe(res => {\n            this.$confirm({\n              title: '发券成功',\n              content: '您可以推送短信，告知客户有新的优惠券到账哦~',\n              okText: '短信推送',\n              icon: () => (\n                <st-icon\n                  type=\"anticon:check-circle\"\n                  size=\"22px\"\n                  color=\"#52c41a\"\n                ></st-icon>\n              ),\n              onOk: () => {\n                this.$router.push({\n                  name: 'brand-setting-sms-group'\n                })\n              }\n            })\n            this.$emit('success')\n            this.show = false\n          })\n      })\n    }\n  }\n}\n</script>\n"]}]}