{"remainingRequest":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-cabinet.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/wangzhigang/Desktop/styd/web/src/views/biz-modals/sold/deal/sale-cabinet.vue","mtime":1600926555971},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/babel-loader/lib/index.js","mtime":1591062567418},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/cache-loader/dist/cjs.js","mtime":1591062571898},{"path":"/Users/wangzhigang/Desktop/styd/web/node_modules/vue-loader/lib/index.js","mtime":1591062572376}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { SaleCabinetService } from './sale-cabinet.service'\nimport { cloneDeep, get } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { PatternService } from '@/services/pattern.service'\nimport { ruleOptions } from './sale-cabinet.config'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nimport MemberSearch from '@/views/biz-components/member/member-search/member-search'\nexport default {\n  name: 'ModalSoldDealSaleCabinet',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber,\n    MemberSearch\n  },\n  serviceProviders() {\n    return [SaleCabinetService]\n  },\n  serviceInject() {\n    return {\n      saleCabinetService: SaleCabinetService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.saleCabinetService.loading$,\n      saleList: this.saleCabinetService.saleList$,\n      cabinetList: this.saleCabinetService.cabinetList$,\n      info: this.saleCabinetService.info$,\n      currentPrice: this.saleCabinetService.currentPrice$,\n      orderAmountPrice: this.saleCabinetService.orderAmountPrice$\n    }\n  },\n  props: {\n    id: {\n      type: String\n    },\n    areaId: {\n      type: [String, Number],\n      default: 0\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      // 租赁柜\n      cabinetFieldNames: {\n        label: 'name',\n        value: 'id',\n        children: 'cabinets'\n      },\n      cabinetId: '',\n      // 租赁天数\n      disabledCalendar: true,\n      startTime: moment(),\n      days: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      isFollowSalesman: 0\n    }\n  },\n  computed: {\n    // 租赁费用\n    leaseFee() {\n      if (!this.cabinetId || !this.days > 0) {\n        return '无'\n      } else {\n        return `${this.info.price_num * this.days}元`\n      }\n    },\n    // 小计\n    orderAmount() {\n      if (!this.cabinetId || !this.days > 0) {\n        return '无'\n      } else {\n        return `${this.info.price_num * this.days -\n          +this.reduceAmount -\n          +this.advanceAmount}元`\n      }\n    },\n    orderAmountText() {\n      return this.orderAmount.split('元')[0] < 0 ? '小计不能为负' : ''\n    },\n    saleRangeType() {\n      return get(this.info.sale_range, 'type', 1)\n    },\n    hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}'\n    }\n  },\n  watch: {\n    days(newVal, oldVal) {\n      this.getOrderPrice()\n      this.getPrice(this.selectAdvance, +this.reduceAmount)\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(newVal, +this.reduceAmount)\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectAdvance, +newVal)\n    }\n  },\n  created() {\n    this.saleCabinetService.orderAmountPrice$.commit(() => 0)\n    this.saleCabinetService.currentPrice$.commit(() => 0)\n    this.saleCabinetService.init().subscribe(res => {\n      if (this.id) {\n        this.saleCabinetService.getInfo(this.id).subscribe(res => {\n          setTimeout(() => {\n            this.startTime = cloneDeep(moment(res.info.start_time))\n          })\n        })\n      }\n      this.saleCabinetService.getCabinetList(this.areaId).subscribe()\n    })\n  },\n  methods: {\n    onMemberChange(data) {\n      this.resetAdvance()\n      if (data) {\n        this.saleCabinetService.getAdvanceList(data).subscribe(res => {\n          this.advanceList = cloneDeep(res.list)\n        })\n      }\n    },\n    // 重置定金选择\n    resetAdvance() {\n      this.advanceList = []\n      this.advanceText = '未选择定金'\n      this.advanceAmount = ''\n      this.selectAdvance = ''\n    },\n    onCabinetChange(data) {\n      this.cabinetId = data[1]\n      this.saleCabinetService.getInfo(data[1]).subscribe()\n    },\n    // 租赁时间\n    disabledEndDate(endValue) {\n      return (\n        endValue.valueOf() < this.startTime.valueOf() ||\n        endValue.valueOf() >\n          moment()\n            .add(999, 'd')\n            .valueOf()\n      )\n    },\n    // 租赁时间-end\n    endTimeChange(data) {\n      this.form.setFieldsValue({\n        endTimeInput: Math.ceil(\n          data.diff(this.startTime, 'minutes') / (24 * 60)\n        )\n      })\n      this.days = Math.ceil(data.diff(this.startTime, 'minutes') / (24 * 60))\n    },\n    onEndTimeInputChange(data) {\n      this.days = data\n      let start = cloneDeep(this.startTime)\n      if (data > 0) {\n        // 有效天数\n        this.form.setFieldsValue({\n          endTimePicker: start.add(data, 'd')\n        })\n      } else {\n        // 无效天数\n        this.form.resetFields(['endTimePicker'])\n      }\n    },\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    onCancel() {\n      this.resetAdvance()\n    },\n    onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0\n        this.advanceText = `未选择定金`\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    // 获取当前价钱\n    getPrice(advance, reduce) {\n      const memberId = this.form.getFieldValue('member_id')\n      this.saleCabinetService.currentPriceAction$.dispatch({\n        product_id: this.cabinetId,\n        product_type: this.info.contract_type,\n        product_num: this.days,\n        advance_id: advance || undefined,\n        member_id: memberId || undefined,\n        reduce_amount: reduce || undefined\n      })\n    },\n    // 获取订单总额\n    getOrderPrice() {\n      this.saleCabinetService.orderAmountPriceAction$.dispatch({\n        product_id: this.cabinetId,\n        product_type: this.info.contract_type,\n        product_num: this.days\n      })\n    },\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : 0\n        this.saleCabinetService\n          .setTransaction({\n            cabinet_id: +this.cabinetId,\n            start_time: `${this.startTime.format('YYYY-MM-DD HH:mm')}`,\n            end_time: `${values.endTimePicker.format('YYYY-MM-DD HH:mm')}`,\n            lease_days: +this.days,\n            contract_number: this.info.contract_number,\n            advance_id:\n              this.selectAdvance === -1 ? undefined : this.selectAdvance,\n            reduce_amount,\n            order_amount: this.currentPrice,\n            member_id: +values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            sale_id: +values.saleName,\n            description: this.description,\n            sale_range: +this.info.sale_range.type,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'create',\n              orderId: res.info.order_id\n            })\n          })\n      })\n    },\n    onPay() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : 0\n        this.saleCabinetService\n          .setTransactionPay({\n            cabinet_id: +this.cabinetId,\n            start_time: `${this.startTime.format('YYYY-MM-DD HH:mm')}`,\n            end_time: `${values.endTimePicker.format('YYYY-MM-DD HH:mm')}`,\n            lease_days: +this.days,\n            contract_number: this.info.contract_number,\n            advance_id:\n              this.selectAdvance === -1 ? undefined : this.selectAdvance,\n            reduce_amount,\n            order_amount: this.currentPrice,\n            member_id: +values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            sale_id: +values.saleName,\n            description: this.description,\n            sale_range: +this.info.sale_range.type,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: res.info.order_id\n            })\n          })\n      })\n    }\n  }\n}\n",{"version":3,"sources":["sale-cabinet.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"sale-cabinet.vue","sourceRoot":"src/views/biz-modals/sold/deal","sourcesContent":["<template>\n  <st-modal\n    title=\"租赁柜签单\"\n    v-model=\"show\"\n    @cancel=\"onCancel\"\n    wrapClassName=\"modal-sold-deal-sale\"\n  >\n    <div :class=\"sale('content')\">\n      <st-form :form=\"form\" labelWidth=\"88px\">\n        <member-search\n          :class=\"sale('member')\"\n          :form=\"form\"\n          :memberInfo=\"memberInfo\"\n          :saleRangeType=\"saleRangeType\"\n          isSoldDeal\n          @change=\"onMemberChange\"\n        ></member-search>\n        <div :class=\"sale('sale')\">\n          <st-form-item v-if=\"cabinetList\" label=\"租赁柜号\" required>\n            <a-cascader\n              v-decorator=\"decorators.cabinet\"\n              @change=\"onCabinetChange\"\n              :allowClear=\"false\"\n              :fieldNames=\"cabinetFieldNames\"\n              :options=\"cabinetList\"\n              placeholder=\"请选择租赁柜号\"\n            />\n            <a-row\n              :class=\"sale('info')\"\n              v-if=\"hasProductInfo\"\n              type=\"flex\"\n              justify=\"space-between\"\n            >\n              <a-col :span=\"12\">\n                <st-info>\n                  <st-info-item label=\"商品名称\">\n                    {{ info.product_name }}\n                  </st-info-item>\n                  <st-info-item label=\"商品类型\">\n                    {{ info.product_type }}\n                  </st-info-item>\n                  <st-info-item class=\"mg-b24\" label=\"租赁计费\">\n                    {{ info.price }}\n                  </st-info-item>\n                </st-info>\n              </a-col>\n              <a-col :span=\"11\">\n                <st-info>\n                  <st-info-item label=\"售卖群体\" v-if=\"info.sale_range\">\n                    {{ info.sale_range.name }}\n                  </st-info-item>\n                  <st-info-item label=\"允许转让\">\n                    {{ info.is_transfer }}\n                  </st-info-item>\n                  <st-info-item class=\"mg-b24\" label=\"转让手续费\">\n                    {{ info.transfer }}\n                  </st-info-item>\n                </st-info>\n              </a-col>\n            </a-row>\n          </st-form-item>\n          <st-form-item required class=\"mg-b0\" label=\"租赁时间\">\n            <div :class=\"sale('time')\">\n              <a-form-item class=\"page-a-form\">\n                <a-date-picker\n                  style=\"width: 100%;\"\n                  v-model=\"startTime\"\n                  disabled\n                  format=\"YYYY-MM-DD HH:mm\"\n                  placeholder=\"开始时间\"\n                  :showToday=\"false\"\n                />\n              </a-form-item>\n              <span>~</span>\n              <a-form-item class=\"page-a-form\">\n                <a-date-picker\n                  :allowClear=\"false\"\n                  :disabled=\"disabledCalendar\"\n                  v-decorator=\"decorators.endTimePicker\"\n                  @change=\"endTimeChange\"\n                  style=\"width: 100%;\"\n                  :showTime=\"{ defaultValue: startTime, format: 'HH:mm' }\"\n                  format=\"YYYY-MM-DD HH:mm\"\n                  placeholder=\"结束时间\"\n                  :showToday=\"false\"\n                />\n              </a-form-item>\n            </div>\n          </st-form-item>\n          <st-form-item required label=\"租赁天数\">\n            <st-input-number\n              :disabledDate=\"disabledCalendar\"\n              @change=\"onEndTimeInputChange\"\n              v-decorator=\"decorators.endTimeInput\"\n              :max=\"999999\"\n            >\n              <template slot=\"addonAfter\">\n                天\n              </template>\n            </st-input-number>\n          </st-form-item>\n          <editable-contract-number\n            v-model=\"info.contract_number\"\n            :form=\"form\"\n          />\n          <st-form-item class=\"mg-b12\" label=\"租赁费用\">\n            {{ orderAmountPrice }}\n          </st-form-item>\n          <st-form-item :class=\"sale('discounts')\" label=\"定金抵扣\">\n            <div>\n              <div :class=\"sale('discounts-total')\">\n                <span>{{ advanceText }}</span>\n                <a-dropdown\n                  v-model=\"advanceDropdownVisible\"\n                  :disabled=\"advanceList.length === 0\"\n                  :class=\"sale({ disabled: advanceList.length === 0 })\"\n                  placement=\"bottomRight\"\n                  :getPopupContainer=\"trigger => trigger.parentNode\"\n                  :trigger=\"['click']\"\n                >\n                  <div :class=\"sale('discounts-promotion')\">\n                    <span>\n                      {{ advanceList.length === 0 ? '无定金' : '定金选择' }}\n                    </span>\n                    <a-icon type=\"right\" />\n                  </div>\n                  <a-radio-group\n                    v-model=\"selectAdvance\"\n                    @change=\"onSelectAdvanceChange\"\n                    :class=\"sale('dropdown')\"\n                    slot=\"overlay\"\n                  >\n                    <a-menu>\n                      <a-menu-item @click=\"onSelectAdvance\">\n                        <a-radio :value=\"undefined\">不使用</a-radio>\n                      </a-menu-item>\n                      <a-menu-item\n                        @click=\"onSelectAdvance\"\n                        :key=\"index\"\n                        v-for=\"(item, index) in advanceList\"\n                      >\n                        <a-radio :value=\"item.id\">\n                          定金 {{ item.price }}\n                        </a-radio>\n                      </a-menu-item>\n                    </a-menu>\n                  </a-radio-group>\n                </a-dropdown>\n              </div>\n            </div>\n          </st-form-item>\n          <st-form-item label=\"减免金额\">\n            <st-input-number\n              v-model=\"reduceAmount\"\n              :float=\"true\"\n              placeholder=\"请输入\"\n            >\n              <span slot=\"addonAfter\">元</span>\n            </st-input-number>\n          </st-form-item>\n          <st-form-item\n            validateStatus=\"error\"\n            :help=\"orderAmountText\"\n            class=\"mg-b0\"\n            label=\"小计\"\n          >\n            <span class=\"total\">{{ currentPrice }}</span>\n          </st-form-item>\n        </div>\n        <div :class=\"sale('remarks')\">\n          <st-form-item label=\"销售人员\" required>\n            <a-select\n              v-decorator=\"decorators.saleName\"\n              placeholder=\"选择签单的工作人员\"\n            >\n              <a-select-option\n                v-for=\"(item, index) in saleList\"\n                :key=\"index\"\n                :value=\"item.id\"\n              >\n                {{ item.staff_name }}\n              </a-select-option>\n            </a-select>\n            <div>\n              <st-checkbox v-model=\"isFollowSalesman\">\n                作为用户跟进销售\n              </st-checkbox>\n            </div>\n          </st-form-item>\n          <st-form-item label=\"备注\" class=\"mg-b0\">\n            <st-textarea\n              v-model=\"description\"\n              :autosize=\"{ minRows: 4, maxRows: 6 }\"\n              :maxlength=\"200\"\n            />\n          </st-form-item>\n        </div>\n      </st-form>\n    </div>\n    <template slot=\"footer\">\n      <div :class=\"sale('footer')\">\n        <div class=\"price\">\n          <span>{{ currentPrice }}</span>\n          <span>订单总额：{{ orderAmountPrice }}</span>\n        </div>\n        <div class=\"button\">\n          <st-button @click=\"onCreateOrder\" :loading=\"loading.setTransaction\">\n            创建订单\n          </st-button>\n          <st-button\n            @click=\"onPay\"\n            :loading=\"loading.setTransactionPay\"\n            type=\"primary\"\n          >\n            立即支付\n          </st-button>\n        </div>\n      </div>\n    </template>\n  </st-modal>\n</template>\n\n<script>\nimport { SaleCabinetService } from './sale-cabinet.service'\nimport { cloneDeep, get } from 'lodash-es'\nimport { timer } from 'rxjs'\nimport { PatternService } from '@/services/pattern.service'\nimport { ruleOptions } from './sale-cabinet.config'\nimport EditableContractNumber from '@/views/biz-components/contract/editable-contract-number.vue'\nimport MemberSearch from '@/views/biz-components/member/member-search/member-search'\nexport default {\n  name: 'ModalSoldDealSaleCabinet',\n  bem: {\n    sale: 'modal-sold-deal-sale'\n  },\n  components: {\n    EditableContractNumber,\n    MemberSearch\n  },\n  serviceProviders() {\n    return [SaleCabinetService]\n  },\n  serviceInject() {\n    return {\n      saleCabinetService: SaleCabinetService,\n      pattern: PatternService\n    }\n  },\n  rxState() {\n    return {\n      loading: this.saleCabinetService.loading$,\n      saleList: this.saleCabinetService.saleList$,\n      cabinetList: this.saleCabinetService.cabinetList$,\n      info: this.saleCabinetService.info$,\n      currentPrice: this.saleCabinetService.currentPrice$,\n      orderAmountPrice: this.saleCabinetService.orderAmountPrice$\n    }\n  },\n  props: {\n    id: {\n      type: String\n    },\n    areaId: {\n      type: [String, Number],\n      default: 0\n    },\n    memberInfo: {\n      type: Object\n    }\n  },\n  data() {\n    const form = this.$stForm.create()\n    const decorators = form.decorators(ruleOptions)\n    return {\n      form,\n      decorators,\n      show: false,\n      // 租赁柜\n      cabinetFieldNames: {\n        label: 'name',\n        value: 'id',\n        children: 'cabinets'\n      },\n      cabinetId: '',\n      // 租赁天数\n      disabledCalendar: true,\n      startTime: moment(),\n      days: '',\n      // 定金\n      advanceDropdownVisible: false,\n      advanceList: [],\n      advanceText: '未选择定金',\n      advanceAmount: '',\n      selectAdvance: '',\n      reduceAmount: null,\n      description: '',\n      isFollowSalesman: 0\n    }\n  },\n  computed: {\n    // 租赁费用\n    leaseFee() {\n      if (!this.cabinetId || !this.days > 0) {\n        return '无'\n      } else {\n        return `${this.info.price_num * this.days}元`\n      }\n    },\n    // 小计\n    orderAmount() {\n      if (!this.cabinetId || !this.days > 0) {\n        return '无'\n      } else {\n        return `${this.info.price_num * this.days -\n          +this.reduceAmount -\n          +this.advanceAmount}元`\n      }\n    },\n    orderAmountText() {\n      return this.orderAmount.split('元')[0] < 0 ? '小计不能为负' : ''\n    },\n    saleRangeType() {\n      return get(this.info.sale_range, 'type', 1)\n    },\n    hasProductInfo() {\n      return JSON.stringify(this.info) !== '{}'\n    }\n  },\n  watch: {\n    days(newVal, oldVal) {\n      this.getOrderPrice()\n      this.getPrice(this.selectAdvance, +this.reduceAmount)\n    },\n    selectAdvance: {\n      deep: true,\n      handler(newVal, oldVal) {\n        this.getPrice(newVal, +this.reduceAmount)\n      }\n    },\n    reduceAmount(newVal, oldVal) {\n      this.getPrice(this.selectAdvance, +newVal)\n    }\n  },\n  created() {\n    this.saleCabinetService.orderAmountPrice$.commit(() => 0)\n    this.saleCabinetService.currentPrice$.commit(() => 0)\n    this.saleCabinetService.init().subscribe(res => {\n      if (this.id) {\n        this.saleCabinetService.getInfo(this.id).subscribe(res => {\n          setTimeout(() => {\n            this.startTime = cloneDeep(moment(res.info.start_time))\n          })\n        })\n      }\n      this.saleCabinetService.getCabinetList(this.areaId).subscribe()\n    })\n  },\n  methods: {\n    onMemberChange(data) {\n      this.resetAdvance()\n      if (data) {\n        this.saleCabinetService.getAdvanceList(data).subscribe(res => {\n          this.advanceList = cloneDeep(res.list)\n        })\n      }\n    },\n    // 重置定金选择\n    resetAdvance() {\n      this.advanceList = []\n      this.advanceText = '未选择定金'\n      this.advanceAmount = ''\n      this.selectAdvance = ''\n    },\n    onCabinetChange(data) {\n      this.cabinetId = data[1]\n      this.saleCabinetService.getInfo(data[1]).subscribe()\n    },\n    // 租赁时间\n    disabledEndDate(endValue) {\n      return (\n        endValue.valueOf() < this.startTime.valueOf() ||\n        endValue.valueOf() >\n          moment()\n            .add(999, 'd')\n            .valueOf()\n      )\n    },\n    // 租赁时间-end\n    endTimeChange(data) {\n      this.form.setFieldsValue({\n        endTimeInput: Math.ceil(\n          data.diff(this.startTime, 'minutes') / (24 * 60)\n        )\n      })\n      this.days = Math.ceil(data.diff(this.startTime, 'minutes') / (24 * 60))\n    },\n    onEndTimeInputChange(data) {\n      this.days = data\n      let start = cloneDeep(this.startTime)\n      if (data > 0) {\n        // 有效天数\n        this.form.setFieldsValue({\n          endTimePicker: start.add(data, 'd')\n        })\n      } else {\n        // 无效天数\n        this.form.resetFields(['endTimePicker'])\n      }\n    },\n    onSelectAdvance() {\n      timer(200).subscribe(() => {\n        this.advanceDropdownVisible = false\n      })\n    },\n    onCancel() {\n      this.resetAdvance()\n    },\n    onSelectAdvanceChange(data) {\n      if (!data.target.value) {\n        this.advanceAmount = 0\n        this.advanceText = `未选择定金`\n        return\n      }\n      let price = this.advanceList.filter(o => o.id === data.target.value)[0]\n        .price\n      this.advanceAmount = price\n      this.advanceText = `${price}元`\n    },\n    // 获取当前价钱\n    getPrice(advance, reduce) {\n      const memberId = this.form.getFieldValue('member_id')\n      this.saleCabinetService.currentPriceAction$.dispatch({\n        product_id: this.cabinetId,\n        product_type: this.info.contract_type,\n        product_num: this.days,\n        advance_id: advance || undefined,\n        member_id: memberId || undefined,\n        reduce_amount: reduce || undefined\n      })\n    },\n    // 获取订单总额\n    getOrderPrice() {\n      this.saleCabinetService.orderAmountPriceAction$.dispatch({\n        product_id: this.cabinetId,\n        product_type: this.info.contract_type,\n        product_num: this.days\n      })\n    },\n    onCreateOrder() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : 0\n        this.saleCabinetService\n          .setTransaction({\n            cabinet_id: +this.cabinetId,\n            start_time: `${this.startTime.format('YYYY-MM-DD HH:mm')}`,\n            end_time: `${values.endTimePicker.format('YYYY-MM-DD HH:mm')}`,\n            lease_days: +this.days,\n            contract_number: this.info.contract_number,\n            advance_id:\n              this.selectAdvance === -1 ? undefined : this.selectAdvance,\n            reduce_amount,\n            order_amount: this.currentPrice,\n            member_id: +values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            sale_id: +values.saleName,\n            description: this.description,\n            sale_range: +this.info.sale_range.type,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'create',\n              orderId: res.info.order_id\n            })\n          })\n      })\n    },\n    onPay() {\n      this.form.validate().then(values => {\n        let reduce_amount = this.reduceAmount ? +this.reduceAmount : 0\n        this.saleCabinetService\n          .setTransactionPay({\n            cabinet_id: +this.cabinetId,\n            start_time: `${this.startTime.format('YYYY-MM-DD HH:mm')}`,\n            end_time: `${values.endTimePicker.format('YYYY-MM-DD HH:mm')}`,\n            lease_days: +this.days,\n            contract_number: this.info.contract_number,\n            advance_id:\n              this.selectAdvance === -1 ? undefined : this.selectAdvance,\n            reduce_amount,\n            order_amount: this.currentPrice,\n            member_id: +values.member_id,\n            member_name: values.member_name,\n            mobile: values.mobile ? values.mobile.phone : undefined,\n            sale_id: +values.saleName,\n            description: this.description,\n            sale_range: +this.info.sale_range.type,\n            is_minors: values.is_minors,\n            parent_name: values.parent_name,\n            parent_mobile: values.parent_mobile\n              ? values.parent_mobile.phone\n              : undefined,\n            parent_country_prefix: values.parent_mobile\n              ? values.parent_mobile.code_id\n              : undefined,\n            parent_user_role: values.parent_user_role,\n            physical_id: values.physical_id,\n            card_num: values.card_num,\n            id_card: values.id_card,\n            id_card_type: values.id_card_type,\n            is_follow_salesman: this.isFollowSalesman\n          })\n          .subscribe(res => {\n            this.show = false\n            this.$emit('success', {\n              type: 'createPay',\n              orderId: res.info.order_id\n            })\n          })\n      })\n    }\n  }\n}\n</script>\n"]}]}